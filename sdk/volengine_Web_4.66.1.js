/**
 * Copyright (c) 2025 The VolcEngineRTC project authors. All Rights Reserved.
 * @brief VolcEngine Advance API
 * version: 4.66.1
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).VERTC=t()}(this,(function(){"use strict";function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var o=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,o.get?o:{enumerable:!0,get:function(){return t[i]}})}}))})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var o=function(e){return e&&e.Math===Math&&e},s=o("object"==typeof globalThis&&globalThis)||o("object"==typeof window&&window)||o("object"==typeof self&&self)||o("object"==typeof t&&t)||o("object"==typeof t&&t)||function(){return this}()||Function("return this")(),r=function(e){try{return!!e()}catch(t){return!0}},n=!r((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),a=n,d=Function.prototype,c=d.apply,l=d.call,u="object"==typeof Reflect&&Reflect.apply||(a?l.bind(c):function(){return l.apply(c,arguments)}),h=n,m=Function.prototype,p=m.call,_=h&&m.bind.bind(p,p),b=h?_:function(e){return function(){return p.apply(e,arguments)}},v=b,S=v({}.toString),y=v("".slice),f=function(e){return y(S(e),8,-1)},g=f,T=b,I=function(e){if("Function"===g(e))return T(e)},R="object"==typeof document&&document.all,E=void 0===R&&void 0!==R?function(e){return"function"==typeof e||e===R}:function(e){return"function"==typeof e},C={},Z=!r((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]})),L=n,P=Function.prototype.call,k=L?P.bind(P):function(){return P.apply(P,arguments)},N={},X={}.propertyIsEnumerable,V=Object.getOwnPropertyDescriptor,w=V&&!X.call({1:2},1);N.f=w?function(e){var t=V(this,e);return!!t&&t.enumerable}:X;var x,G,W=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},M=r,A=f,O=Object,D=b("".split),Y=M((function(){return!O("z").propertyIsEnumerable(0)}))?function(e){return"String"===A(e)?D(e,""):O(e)}:O,K=function(e){return null==e},U=K,F=TypeError,H=function(e){if(U(e))throw new F("Can't call method on "+e);return e},J=Y,z=H,j=function(e){return J(z(e))},Q=E,B=function(e){return"object"==typeof e?null!==e:Q(e)},q={},$=q,ee=s,te=E,ie=function(e){return te(e)?e:void 0},oe=function(e,t){return arguments.length<2?ie($[e])||ie(ee[e]):$[e]&&$[e][t]||ee[e]&&ee[e][t]},se=b({}.isPrototypeOf),re=s.navigator,ne=re&&re.userAgent,ae=ne?String(ne):"",de=s,ce=ae,le=de.process,ue=de.Deno,he=le&&le.versions||ue&&ue.version,me=he&&he.v8;me&&(G=(x=me.split("."))[0]>0&&x[0]<4?1:+(x[0]+x[1])),!G&&ce&&(!(x=ce.match(/Edge\/(\d+)/))||x[1]>=74)&&(x=ce.match(/Chrome\/(\d+)/))&&(G=+x[1]);var pe=G,_e=pe,be=r,ve=s.String,Se=!!Object.getOwnPropertySymbols&&!be((function(){var e=Symbol("symbol detection");return!ve(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&_e&&_e<41})),ye=Se&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,fe=oe,ge=E,Te=se,Ie=Object,Re=ye?function(e){return"symbol"==typeof e}:function(e){var t=fe("Symbol");return ge(t)&&Te(t.prototype,Ie(e))},Ee=String,Ce=function(e){try{return Ee(e)}catch(t){return"Object"}},Ze=E,Le=Ce,Pe=TypeError,ke=function(e){if(Ze(e))return e;throw new Pe(Le(e)+" is not a function")},Ne=ke,Xe=K,Ve=function(e,t){var i=e[t];return Xe(i)?void 0:Ne(i)},we=k,xe=E,Ge=B,We=TypeError,Me={exports:{}},Ae=!0,Oe=s,De=Object.defineProperty,Ye=s,Ke=function(e,t){try{De(Oe,e,{value:t,configurable:!0,writable:!0})}catch(i){Oe[e]=t}return t},Ue="__core-js_shared__",Fe=Me.exports=Ye[Ue]||Ke(Ue,{});(Fe.versions||(Fe.versions=[])).push({version:"3.39.0",mode:"pure",copyright:"Â© 2014-2024 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.39.0/LICENSE",source:"https://github.com/zloirock/core-js"});var He=Me.exports,Je=He,ze=function(e,t){return Je[e]||(Je[e]=t||{})},je=H,Qe=Object,Be=function(e){return Qe(je(e))},qe=Be,$e=b({}.hasOwnProperty),et=Object.hasOwn||function(e,t){return $e(qe(e),t)},tt=b,it=0,ot=Math.random(),st=tt(1..toString),rt=function(e){return"Symbol("+(void 0===e?"":e)+")_"+st(++it+ot,36)},nt=ze,at=et,dt=rt,ct=Se,lt=ye,ut=s.Symbol,ht=nt("wks"),mt=lt?ut.for||ut:ut&&ut.withoutSetter||dt,pt=function(e){return at(ht,e)||(ht[e]=ct&&at(ut,e)?ut[e]:mt("Symbol."+e)),ht[e]},_t=k,bt=B,vt=Re,St=Ve,yt=function(e,t){var i,o;if("string"===t&&xe(i=e.toString)&&!Ge(o=we(i,e)))return o;if(xe(i=e.valueOf)&&!Ge(o=we(i,e)))return o;if("string"!==t&&xe(i=e.toString)&&!Ge(o=we(i,e)))return o;throw new We("Can't convert object to primitive value")},ft=TypeError,gt=pt("toPrimitive"),Tt=function(e,t){if(!bt(e)||vt(e))return e;var i,o=St(e,gt);if(o){if(void 0===t&&(t="default"),i=_t(o,e,t),!bt(i)||vt(i))return i;throw new ft("Can't convert object to primitive value")}return void 0===t&&(t="number"),yt(e,t)},It=Re,Rt=function(e){var t=Tt(e,"string");return It(t)?t:t+""},Et=B,Ct=s.document,Zt=Et(Ct)&&Et(Ct.createElement),Lt=function(e){return Zt?Ct.createElement(e):{}},Pt=Lt,kt=!Z&&!r((function(){return 7!==Object.defineProperty(Pt("div"),"a",{get:function(){return 7}}).a})),Nt=Z,Xt=k,Vt=N,wt=W,xt=j,Gt=Rt,Wt=et,Mt=kt,At=Object.getOwnPropertyDescriptor;C.f=Nt?At:function(e,t){if(e=xt(e),t=Gt(t),Mt)try{return At(e,t)}catch(i){}if(Wt(e,t))return wt(!Xt(Vt.f,e,t),e[t])};var Ot=r,Dt=E,Yt=/#|\.prototype\./,Kt=function(e,t){var i=Ft[Ut(e)];return i===Jt||i!==Ht&&(Dt(t)?Ot(t):!!t)},Ut=Kt.normalize=function(e){return String(e).replace(Yt,".").toLowerCase()},Ft=Kt.data={},Ht=Kt.NATIVE="N",Jt=Kt.POLYFILL="P",zt=Kt,jt=ke,Qt=n,Bt=I(I.bind),qt=function(e,t){return jt(e),void 0===t?e:Qt?Bt(e,t):function(){return e.apply(t,arguments)}},$t={},ei=Z&&r((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),ti=B,ii=String,oi=TypeError,si=function(e){if(ti(e))return e;throw new oi(ii(e)+" is not an object")},ri=Z,ni=kt,ai=ei,di=si,ci=Rt,li=TypeError,ui=Object.defineProperty,hi=Object.getOwnPropertyDescriptor,mi="enumerable",pi="configurable",_i="writable";$t.f=ri?ai?function(e,t,i){if(di(e),t=ci(t),di(i),"function"==typeof e&&"prototype"===t&&"value"in i&&_i in i&&!i[_i]){var o=hi(e,t);o&&o[_i]&&(e[t]=i.value,i={configurable:pi in i?i[pi]:o[pi],enumerable:mi in i?i[mi]:o[mi],writable:!1})}return ui(e,t,i)}:ui:function(e,t,i){if(di(e),t=ci(t),di(i),ni)try{return ui(e,t,i)}catch(o){}if("get"in i||"set"in i)throw new li("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var bi=$t,vi=W,Si=Z?function(e,t,i){return bi.f(e,t,vi(1,i))}:function(e,t,i){return e[t]=i,e},yi=s,fi=u,gi=I,Ti=E,Ii=C.f,Ri=zt,Ei=q,Ci=qt,Zi=Si,Li=et,Pi=function(e){var t=function(i,o,s){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,o)}return new e(i,o,s)}return fi(e,this,arguments)};return t.prototype=e.prototype,t},ki=function(e,t){var i,o,s,r,n,a,d,c,l,u=e.target,h=e.global,m=e.stat,p=e.proto,_=h?yi:m?yi[u]:yi[u]&&yi[u].prototype,b=h?Ei:Ei[u]||Zi(Ei,u,{})[u],v=b.prototype;for(r in t)o=!(i=Ri(h?r:u+(m?".":"#")+r,e.forced))&&_&&Li(_,r),a=b[r],o&&(d=e.dontCallGetSet?(l=Ii(_,r))&&l.value:_[r]),n=o&&d?d:t[r],(i||p||typeof a!=typeof n)&&(c=e.bind&&o?Ci(n,yi):e.wrap&&o?Pi(n):p&&Ti(n)?gi(n):n,(e.sham||n&&n.sham||a&&a.sham)&&Zi(c,"sham",!0),Zi(b,r,c),p&&(Li(Ei,s=u+"Prototype")||Zi(Ei,s,{}),Zi(Ei[s],r,n),e.real&&v&&(i||!v[r])&&Zi(v,r,n)))},Ni=Math.ceil,Xi=Math.floor,Vi=Math.trunc||function(e){var t=+e;return(t>0?Xi:Ni)(t)},wi=function(e){var t=+e;return t!=t||0===t?0:Vi(t)},xi=wi,Gi=Math.max,Wi=Math.min,Mi=function(e,t){var i=xi(e);return i<0?Gi(i+t,0):Wi(i,t)},Ai=wi,Oi=Math.min,Di=function(e){var t=Ai(e);return t>0?Oi(t,9007199254740991):0},Yi=function(e){return Di(e.length)},Ki=j,Ui=Mi,Fi=Yi,Hi=function(e){return function(t,i,o){var s=Ki(t),r=Fi(s);if(0===r)return!e&&-1;var n,a=Ui(o,r);if(e&&i!=i){for(;r>a;)if((n=s[a++])!=n)return!0}else for(;r>a;a++)if((e||a in s)&&s[a]===i)return e||a||0;return!e&&-1}},Ji={includes:Hi(!0),indexOf:Hi(!1)},zi={},ji=et,Qi=j,Bi=Ji.indexOf,qi=zi,$i=b([].push),eo=function(e,t){var i,o=Qi(e),s=0,r=[];for(i in o)!ji(qi,i)&&ji(o,i)&&$i(r,i);for(;t.length>s;)ji(o,i=t[s++])&&(~Bi(r,i)||$i(r,i));return r},to=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],io=eo,oo=to,so=Object.keys||function(e){return io(e,oo)},ro=Be,no=so;ki({target:"Object",stat:!0,forced:r((function(){no(1)}))},{keys:function(e){return no(ro(e))}});var ao=i(q.Object.keys),co={};co[pt("toStringTag")]="z";var lo="[object z]"===String(co),uo=lo,ho=E,mo=f,po=pt("toStringTag"),_o=Object,bo="Arguments"===mo(function(){return arguments}()),vo=uo?mo:function(e){var t,i,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(i){}}(t=_o(e),po))?i:bo?mo(t):"Object"===(o=mo(t))&&ho(t.callee)?"Arguments":o},So=vo,yo=String,fo=function(e){if("Symbol"===So(e))throw new TypeError("Cannot convert a Symbol value to a string");return yo(e)},go={},To=Z,Io=ei,Ro=$t,Eo=si,Co=j,Zo=so;go.f=To&&!Io?Object.defineProperties:function(e,t){Eo(e);for(var i,o=Co(t),s=Zo(t),r=s.length,n=0;r>n;)Ro.f(e,i=s[n++],o[i]);return e};var Lo,Po=oe("document","documentElement"),ko=rt,No=ze("keys"),Xo=function(e){return No[e]||(No[e]=ko(e))},Vo=si,wo=go,xo=to,Go=zi,Wo=Po,Mo=Lt,Ao="prototype",Oo="script",Do=Xo("IE_PROTO"),Yo=function(){},Ko=function(e){return"<"+Oo+">"+e+"</"+Oo+">"},Uo=function(e){e.write(Ko("")),e.close();var t=e.parentWindow.Object;return e=null,t},Fo=function(){try{Lo=new ActiveXObject("htmlfile")}catch(s){}var e,t,i;Fo="undefined"!=typeof document?document.domain&&Lo?Uo(Lo):(t=Mo("iframe"),i="java"+Oo+":",t.style.display="none",Wo.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(Ko("document.F=Object")),e.close(),e.F):Uo(Lo);for(var o=xo.length;o--;)delete Fo[Ao][xo[o]];return Fo()};Go[Do]=!0;var Ho=Object.create||function(e,t){var i;return null!==e?(Yo[Ao]=Vo(e),i=new Yo,Yo[Ao]=null,i[Do]=e):i=Fo(),void 0===t?i:wo.f(i,t)},Jo={},zo=eo,jo=to.concat("length","prototype");Jo.f=Object.getOwnPropertyNames||function(e){return zo(e,jo)};var Qo={},Bo=b([].slice),qo=f,$o=j,es=Jo.f,ts=Bo,is="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Qo.f=function(e){return is&&"Window"===qo(e)?function(e){try{return es(e)}catch(t){return ts(is)}}(e):es($o(e))};var os={};os.f=Object.getOwnPropertySymbols;var ss=Si,rs=function(e,t,i,o){return o&&o.enumerable?e[t]=i:ss(e,t,i),e},ns=$t,as=function(e,t,i){return ns.f(e,t,i)},ds={},cs=pt;ds.f=cs;var ls,us,hs,ms=q,ps=et,_s=ds,bs=$t.f,vs=function(e){var t=ms.Symbol||(ms.Symbol={});ps(t,e)||bs(t,e,{value:_s.f(e)})},Ss=k,ys=oe,fs=pt,gs=rs,Ts=function(){var e=ys("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,o=fs("toPrimitive");t&&!t[o]&&gs(t,o,(function(e){return Ss(i,this)}),{arity:1})},Is=vo,Rs=lo?{}.toString:function(){return"[object "+Is(this)+"]"},Es=lo,Cs=$t.f,Zs=Si,Ls=et,Ps=Rs,ks=pt("toStringTag"),Ns=function(e,t,i,o){var s=i?e:e&&e.prototype;s&&(Ls(s,ks)||Cs(s,ks,{configurable:!0,value:t}),o&&!Es&&Zs(s,"toString",Ps))},Xs=E,Vs=s.WeakMap,ws=Xs(Vs)&&/native code/.test(String(Vs)),xs=s,Gs=B,Ws=Si,Ms=et,As=He,Os=Xo,Ds=zi,Ys="Object already initialized",Ks=xs.TypeError,Us=xs.WeakMap;if(ws||As.state){var Fs=As.state||(As.state=new Us);Fs.get=Fs.get,Fs.has=Fs.has,Fs.set=Fs.set,ls=function(e,t){if(Fs.has(e))throw new Ks(Ys);return t.facade=e,Fs.set(e,t),t},us=function(e){return Fs.get(e)||{}},hs=function(e){return Fs.has(e)}}else{var Hs=Os("state");Ds[Hs]=!0,ls=function(e,t){if(Ms(e,Hs))throw new Ks(Ys);return t.facade=e,Ws(e,Hs,t),t},us=function(e){return Ms(e,Hs)?e[Hs]:{}},hs=function(e){return Ms(e,Hs)}}var Js={set:ls,get:us,has:hs,enforce:function(e){return hs(e)?us(e):ls(e,{})},getterFor:function(e){return function(t){var i;if(!Gs(t)||(i=us(t)).type!==e)throw new Ks("Incompatible receiver, "+e+" required");return i}}},zs=f,js=Array.isArray||function(e){return"Array"===zs(e)},Qs=E,Bs=He,qs=b(Function.toString);Qs(Bs.inspectSource)||(Bs.inspectSource=function(e){return qs(e)});var $s=Bs.inspectSource,er=b,tr=r,ir=E,or=vo,sr=$s,rr=function(){},nr=oe("Reflect","construct"),ar=/^\s*(?:class|function)\b/,dr=er(ar.exec),cr=!ar.test(rr),lr=function(e){if(!ir(e))return!1;try{return nr(rr,[],e),!0}catch(t){return!1}},ur=function(e){if(!ir(e))return!1;switch(or(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return cr||!!dr(ar,sr(e))}catch(t){return!0}};ur.sham=!0;var hr=!nr||tr((function(){var e;return lr(lr.call)||!lr(Object)||!lr((function(){e=!0}))||e}))?ur:lr,mr=js,pr=hr,_r=B,br=pt("species"),vr=Array,Sr=function(e){var t;return mr(e)&&(t=e.constructor,(pr(t)&&(t===vr||mr(t.prototype))||_r(t)&&null===(t=t[br]))&&(t=void 0)),void 0===t?vr:t},yr=function(e,t){return new(Sr(e))(0===t?0:t)},fr=qt,gr=Y,Tr=Be,Ir=Yi,Rr=yr,Er=b([].push),Cr=function(e){var t=1===e,i=2===e,o=3===e,s=4===e,r=6===e,n=7===e,a=5===e||r;return function(d,c,l,u){for(var h,m,p=Tr(d),_=gr(p),b=Ir(_),v=fr(c,l),S=0,y=u||Rr,f=t?y(d,b):i||n?y(d,0):void 0;b>S;S++)if((a||S in _)&&(m=v(h=_[S],S,p),e))if(t)f[S]=m;else if(m)switch(e){case 3:return!0;case 5:return h;case 6:return S;case 2:Er(f,h)}else switch(e){case 4:return!1;case 7:Er(f,h)}return r?-1:o||s?s:f}},Zr={forEach:Cr(0),map:Cr(1),filter:Cr(2),some:Cr(3),every:Cr(4),find:Cr(5),findIndex:Cr(6),filterReject:Cr(7)},Lr=ki,Pr=s,kr=k,Nr=b,Xr=Z,Vr=Se,wr=r,xr=et,Gr=se,Wr=si,Mr=j,Ar=Rt,Or=fo,Dr=W,Yr=Ho,Kr=so,Ur=Jo,Fr=Qo,Hr=os,Jr=C,zr=$t,jr=go,Qr=N,Br=rs,qr=as,$r=ze,en=zi,tn=rt,on=pt,sn=ds,rn=vs,nn=Ts,an=Ns,dn=Js,cn=Zr.forEach,ln=Xo("hidden"),un="Symbol",hn="prototype",mn=dn.set,pn=dn.getterFor(un),_n=Object[hn],bn=Pr.Symbol,vn=bn&&bn[hn],Sn=Pr.RangeError,yn=Pr.TypeError,fn=Pr.QObject,gn=Jr.f,Tn=zr.f,In=Fr.f,Rn=Qr.f,En=Nr([].push),Cn=$r("symbols"),Zn=$r("op-symbols"),Ln=$r("wks"),Pn=!fn||!fn[hn]||!fn[hn].findChild,kn=function(e,t,i){var o=gn(_n,t);o&&delete _n[t],Tn(e,t,i),o&&e!==_n&&Tn(_n,t,o)},Nn=Xr&&wr((function(){return 7!==Yr(Tn({},"a",{get:function(){return Tn(this,"a",{value:7}).a}})).a}))?kn:Tn,Xn=function(e,t){var i=Cn[e]=Yr(vn);return mn(i,{type:un,tag:e,description:t}),Xr||(i.description=t),i},Vn=function(e,t,i){e===_n&&Vn(Zn,t,i),Wr(e);var o=Ar(t);return Wr(i),xr(Cn,o)?(i.enumerable?(xr(e,ln)&&e[ln][o]&&(e[ln][o]=!1),i=Yr(i,{enumerable:Dr(0,!1)})):(xr(e,ln)||Tn(e,ln,Dr(1,Yr(null))),e[ln][o]=!0),Nn(e,o,i)):Tn(e,o,i)},wn=function(e,t){Wr(e);var i=Mr(t),o=Kr(i).concat(Mn(i));return cn(o,(function(t){Xr&&!kr(xn,i,t)||Vn(e,t,i[t])})),e},xn=function(e){var t=Ar(e),i=kr(Rn,this,t);return!(this===_n&&xr(Cn,t)&&!xr(Zn,t))&&(!(i||!xr(this,t)||!xr(Cn,t)||xr(this,ln)&&this[ln][t])||i)},Gn=function(e,t){var i=Mr(e),o=Ar(t);if(i!==_n||!xr(Cn,o)||xr(Zn,o)){var s=gn(i,o);return!s||!xr(Cn,o)||xr(i,ln)&&i[ln][o]||(s.enumerable=!0),s}},Wn=function(e){var t=In(Mr(e)),i=[];return cn(t,(function(e){xr(Cn,e)||xr(en,e)||En(i,e)})),i},Mn=function(e){var t=e===_n,i=In(t?Zn:Mr(e)),o=[];return cn(i,(function(e){!xr(Cn,e)||t&&!xr(_n,e)||En(o,Cn[e])})),o};Vr||(bn=function(){if(Gr(vn,this))throw new yn("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?Or(arguments[0]):void 0,t=tn(e),i=function(e){var o=void 0===this?Pr:this;o===_n&&kr(i,Zn,e),xr(o,ln)&&xr(o[ln],t)&&(o[ln][t]=!1);var s=Dr(1,e);try{Nn(o,t,s)}catch(r){if(!(r instanceof Sn))throw r;kn(o,t,s)}};return Xr&&Pn&&Nn(_n,t,{configurable:!0,set:i}),Xn(t,e)},Br(vn=bn[hn],"toString",(function(){return pn(this).tag})),Br(bn,"withoutSetter",(function(e){return Xn(tn(e),e)})),Qr.f=xn,zr.f=Vn,jr.f=wn,Jr.f=Gn,Ur.f=Fr.f=Wn,Hr.f=Mn,sn.f=function(e){return Xn(on(e),e)},Xr&&qr(vn,"description",{configurable:!0,get:function(){return pn(this).description}})),Lr({global:!0,constructor:!0,wrap:!0,forced:!Vr,sham:!Vr},{Symbol:bn}),cn(Kr(Ln),(function(e){rn(e)})),Lr({target:un,stat:!0,forced:!Vr},{useSetter:function(){Pn=!0},useSimple:function(){Pn=!1}}),Lr({target:"Object",stat:!0,forced:!Vr,sham:!Xr},{create:function(e,t){return void 0===t?Yr(e):wn(Yr(e),t)},defineProperty:Vn,defineProperties:wn,getOwnPropertyDescriptor:Gn}),Lr({target:"Object",stat:!0,forced:!Vr},{getOwnPropertyNames:Wn}),nn(),an(bn,un),en[ln]=!0;var An=Se&&!!Symbol.for&&!!Symbol.keyFor,On=ki,Dn=oe,Yn=et,Kn=fo,Un=ze,Fn=An,Hn=Un("string-to-symbol-registry"),Jn=Un("symbol-to-string-registry");On({target:"Symbol",stat:!0,forced:!Fn},{for:function(e){var t=Kn(e);if(Yn(Hn,t))return Hn[t];var i=Dn("Symbol")(t);return Hn[t]=i,Jn[i]=t,i}});var zn=ki,jn=et,Qn=Re,Bn=Ce,qn=An,$n=ze("symbol-to-string-registry");zn({target:"Symbol",stat:!0,forced:!qn},{keyFor:function(e){if(!Qn(e))throw new TypeError(Bn(e)+" is not a symbol");if(jn($n,e))return $n[e]}});var ea=js,ta=E,ia=f,oa=fo,sa=b([].push),ra=ki,na=oe,aa=u,da=k,ca=b,la=r,ua=E,ha=Re,ma=Bo,pa=function(e){if(ta(e))return e;if(ea(e)){for(var t=e.length,i=[],o=0;o<t;o++){var s=e[o];"string"==typeof s?sa(i,s):"number"!=typeof s&&"Number"!==ia(s)&&"String"!==ia(s)||sa(i,oa(s))}var r=i.length,n=!0;return function(e,t){if(n)return n=!1,t;if(ea(this))return t;for(var o=0;o<r;o++)if(i[o]===e)return t}}},_a=Se,ba=String,va=na("JSON","stringify"),Sa=ca(/./.exec),ya=ca("".charAt),fa=ca("".charCodeAt),ga=ca("".replace),Ta=ca(1..toString),Ia=/[\uD800-\uDFFF]/g,Ra=/^[\uD800-\uDBFF]$/,Ea=/^[\uDC00-\uDFFF]$/,Ca=!_a||la((function(){var e=na("Symbol")("stringify detection");return"[null]"!==va([e])||"{}"!==va({a:e})||"{}"!==va(Object(e))})),Za=la((function(){return'"\\udf06\\ud834"'!==va("\udf06\ud834")||'"\\udead"'!==va("\udead")})),La=function(e,t){var i=ma(arguments),o=pa(t);if(ua(o)||void 0!==e&&!ha(e))return i[1]=function(e,t){if(ua(o)&&(t=da(o,this,ba(e),t)),!ha(t))return t},aa(va,null,i)},Pa=function(e,t,i){var o=ya(i,t-1),s=ya(i,t+1);return Sa(Ra,e)&&!Sa(Ea,s)||Sa(Ea,e)&&!Sa(Ra,o)?"\\u"+Ta(fa(e,0),16):e};va&&ra({target:"JSON",stat:!0,arity:3,forced:Ca||Za},{stringify:function(e,t,i){var o=ma(arguments),s=aa(Ca?La:va,null,o);return Za&&"string"==typeof s?ga(s,Ia,Pa):s}});var ka=os,Na=Be;ki({target:"Object",stat:!0,forced:!Se||r((function(){ka.f(1)}))},{getOwnPropertySymbols:function(e){var t=ka.f;return t?t(Na(e)):[]}});var Xa=i(q.Object.getOwnPropertySymbols),Va=r,wa=pe,xa=pt("species"),Ga=function(e){return wa>=51||!Va((function(){var t=[];return(t.constructor={})[xa]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Wa=Zr.filter;ki({target:"Array",proto:!0,forced:!Ga("filter")},{filter:function(e){return Wa(this,e,arguments.length>1?arguments[1]:void 0)}});var Ma=s,Aa=q,Oa=function(e,t){var i=Aa[e+"Prototype"],o=i&&i[t];if(o)return o;var s=Ma[e],r=s&&s.prototype;return r&&r[t]},Da=Oa("Array","filter"),Ya=se,Ka=Da,Ua=Array.prototype,Fa=i((function(e){var t=e.filter;return e===Ua||Ya(Ua,e)&&t===Ua.filter?Ka:t})),Ha={exports:{}},Ja=ki,za=r,ja=j,Qa=C.f,Ba=Z;Ja({target:"Object",stat:!0,forced:!Ba||za((function(){Qa(1)})),sham:!Ba},{getOwnPropertyDescriptor:function(e,t){return Qa(ja(e),t)}});var qa=q.Object,$a=Ha.exports=function(e,t){return qa.getOwnPropertyDescriptor(e,t)};qa.getOwnPropertyDescriptor.sham&&($a.sham=!0);var ed=i(Ha.exports),td=Z,id=js,od=TypeError,sd=Object.getOwnPropertyDescriptor,rd=td&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(e){return e instanceof TypeError}}(),nd=TypeError,ad=function(e){if(e>9007199254740991)throw nd("Maximum allowed index exceeded");return e},dd=Be,cd=Yi,ld=rd?function(e,t){if(id(e)&&!sd(e,"length").writable)throw new od("Cannot set read only .length");return e.length=t}:function(e,t){return e.length=t},ud=ad;ki({target:"Array",proto:!0,arity:1,forced:r((function(){return 4294967297!==[].push.call({length:4294967296},1)}))||!function(){try{Object.defineProperty([],"length",{writable:!1}).push()}catch(e){return e instanceof TypeError}}()},{push:function(e){var t=dd(this),i=cd(t),o=arguments.length;ud(i+o);for(var s=0;s<o;s++)t[i]=arguments[s],i++;return ld(t,i),i}});var hd=Oa("Array","push"),md=se,pd=hd,_d=Array.prototype,bd=i((function(e){var t=e.push;return e===_d||md(_d,e)&&t===_d.push?pd:t})),vd=r,Sd=function(e,t){var i=[][e];return!!i&&vd((function(){i.call(null,t||function(){return 1},1)}))},yd=Zr.forEach,fd=Sd("forEach")?[].forEach:function(e){return yd(this,e,arguments.length>1?arguments[1]:void 0)};ki({target:"Array",proto:!0,forced:[].forEach!==fd},{forEach:fd});var gd=Oa("Array","forEach"),Td=vo,Id=et,Rd=se,Ed=gd,Cd=Array.prototype,Zd={DOMTokenList:!0,NodeList:!0},Ld=i((function(e){var t=e.forEach;return e===Cd||Rd(Cd,e)&&t===Cd.forEach||Id(Zd,Td(e))?Ed:t})),Pd=oe,kd=Jo,Nd=os,Xd=si,Vd=b([].concat),wd=Pd("Reflect","ownKeys")||function(e){var t=kd.f(Xd(e)),i=Nd.f;return i?Vd(t,i(e)):t},xd=Z,Gd=$t,Wd=W,Md=function(e,t,i){xd?Gd.f(e,t,Wd(0,i)):e[t]=i},Ad=wd,Od=j,Dd=C,Yd=Md;ki({target:"Object",stat:!0,sham:!Z},{getOwnPropertyDescriptors:function(e){for(var t,i,o=Od(e),s=Dd.f,r=Ad(o),n={},a=0;r.length>a;)void 0!==(i=s(o,t=r[a++]))&&Yd(n,t,i);return n}});var Kd=i(q.Object.getOwnPropertyDescriptors),Ud={exports:{}},Fd=ki,Hd=Z,Jd=go.f;Fd({target:"Object",stat:!0,forced:Object.defineProperties!==Jd,sham:!Hd},{defineProperties:Jd});var zd=q.Object,jd=Ud.exports=function(e,t){return zd.defineProperties(e,t)};zd.defineProperties.sham&&(jd.sham=!0);var Qd=i(Ud.exports),Bd={exports:{}},qd=ki,$d=Z,ec=$t.f;qd({target:"Object",stat:!0,forced:Object.defineProperty!==ec,sham:!$d},{defineProperty:ec});var tc=q.Object,ic=Bd.exports=function(e,t,i){return tc.defineProperty(e,t,i)};tc.defineProperty.sham&&(ic.sham=!0);var oc=i(Bd.exports),sc=ki,rc=r,nc=js,ac=B,dc=Be,cc=Yi,lc=ad,uc=Md,hc=yr,mc=Ga,pc=pe,_c=pt("isConcatSpreadable"),bc=pc>=51||!rc((function(){var e=[];return e[_c]=!1,e.concat()[0]!==e})),vc=function(e){if(!ac(e))return!1;var t=e[_c];return void 0!==t?!!t:nc(e)};sc({target:"Array",proto:!0,arity:1,forced:!bc||!mc("concat")},{concat:function(e){var t,i,o,s,r,n=dc(this),a=hc(n,0),d=0;for(t=-1,o=arguments.length;t<o;t++)if(vc(r=-1===t?n:arguments[t]))for(s=cc(r),lc(d+s),i=0;i<s;i++,d++)i in r&&uc(a,d,r[i]);else lc(d+1),uc(a,d++,r);return a.length=d,a}}),vs("asyncIterator"),vs("hasInstance"),vs("isConcatSpreadable"),vs("iterator"),vs("match"),vs("matchAll"),vs("replace"),vs("search"),vs("species"),vs("split");var Sc=Ts;vs("toPrimitive"),Sc();var yc=oe,fc=Ns;vs("toStringTag"),fc(yc("Symbol"),"Symbol"),vs("unscopables"),Ns(s.JSON,"JSON",!0);var gc,Tc,Ic,Rc=q.Symbol,Ec={},Cc=Z,Zc=et,Lc=Function.prototype,Pc=Cc&&Object.getOwnPropertyDescriptor,kc=Zc(Lc,"name"),Nc={EXISTS:kc,PROPER:kc&&"something"===function(){}.name,CONFIGURABLE:kc&&(!Cc||Cc&&Pc(Lc,"name").configurable)},Xc=!r((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Vc=et,wc=E,xc=Be,Gc=Xc,Wc=Xo("IE_PROTO"),Mc=Object,Ac=Mc.prototype,Oc=Gc?Mc.getPrototypeOf:function(e){var t=xc(e);if(Vc(t,Wc))return t[Wc];var i=t.constructor;return wc(i)&&t instanceof i?i.prototype:t instanceof Mc?Ac:null},Dc=r,Yc=E,Kc=B,Uc=Ho,Fc=Oc,Hc=rs,Jc=pt("iterator"),zc=!1;[].keys&&("next"in(Ic=[].keys())?(Tc=Fc(Fc(Ic)))!==Object.prototype&&(gc=Tc):zc=!0);var jc=!Kc(gc)||Dc((function(){var e={};return gc[Jc].call(e)!==e}));Yc((gc=jc?{}:Uc(gc))[Jc])||Hc(gc,Jc,(function(){return this}));var Qc={IteratorPrototype:gc,BUGGY_SAFARI_ITERATORS:zc},Bc=Qc.IteratorPrototype,qc=Ho,$c=W,el=Ns,tl=Ec,il=function(){return this},ol=function(e,t,i,o){var s=t+" Iterator";return e.prototype=qc(Bc,{next:$c(+!o,i)}),el(e,s,!1,!0),tl[s]=il,e},sl=b,rl=ke,nl=B,al=function(e){return nl(e)||null===e},dl=String,cl=TypeError,ll=function(e,t,i){try{return sl(rl(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(o){}},ul=B,hl=H,ml=function(e){if(al(e))return e;throw new cl("Can't set "+dl(e)+" as a prototype")},pl=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=ll(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch(o){}return function(i,o){return hl(i),ml(o),ul(i)?(t?e(i,o):i.__proto__=o,i):i}}():void 0),_l=ki,bl=k,vl=Nc,Sl=ol,yl=Oc,fl=Ns,gl=rs,Tl=Ec,Il=Qc,Rl=vl.PROPER,El=Il.BUGGY_SAFARI_ITERATORS,Cl=pt("iterator"),Zl="keys",Ll="values",Pl="entries",kl=function(){return this},Nl=function(e,t,i,o,s,r,n){Sl(i,t,o);var a,d,c,l=function(e){if(e===s&&_)return _;if(!El&&e&&e in m)return m[e];switch(e){case Zl:case Ll:case Pl:return function(){return new i(this,e)}}return function(){return new i(this)}},u=t+" Iterator",h=!1,m=e.prototype,p=m[Cl]||m["@@iterator"]||s&&m[s],_=!El&&p||l(s),b="Array"===t&&m.entries||p;if(b&&(a=yl(b.call(new e)))!==Object.prototype&&a.next&&(fl(a,u,!0,!0),Tl[u]=kl),Rl&&s===Ll&&p&&p.name!==Ll&&(h=!0,_=function(){return bl(p,this)}),s)if(d={values:l(Ll),keys:r?_:l(Zl),entries:l(Pl)},n)for(c in d)(El||h||!(c in m))&&gl(m,c,d[c]);else _l({target:t,proto:!0,forced:El||h},d);return n&&m[Cl]!==_&&gl(m,Cl,_,{name:s}),Tl[t]=_,d},Xl=function(e,t){return{value:e,done:t}},Vl=j,wl=Ec,xl=Js;$t.f;var Gl=Nl,Wl=Xl,Ml="Array Iterator",Al=xl.set,Ol=xl.getterFor(Ml);Gl(Array,"Array",(function(e,t){Al(this,{type:Ml,target:Vl(e),index:0,kind:t})}),(function(){var e=Ol(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,Wl(void 0,!0);switch(e.kind){case"keys":return Wl(i,!1);case"values":return Wl(t[i],!1)}return Wl([i,t[i]],!1)}),"values"),wl.Arguments=wl.Array;var Dl={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Yl=s,Kl=Ns,Ul=Ec;for(var Fl in Dl)Kl(Yl[Fl],Fl),Ul[Fl]=Ul.Array;var Hl=Rc,Jl=pt,zl=$t.f,jl=Jl("metadata"),Ql=Function.prototype;void 0===Ql[jl]&&zl(Ql,jl,{value:null}),vs("asyncDispose"),vs("dispose"),vs("metadata");var Bl=Hl,ql=b,$l=oe("Symbol"),eu=$l.keyFor,tu=ql($l.prototype.valueOf),iu=$l.isRegisteredSymbol||function(e){try{return void 0!==eu(tu(e))}catch(t){return!1}};ki({target:"Symbol",stat:!0},{isRegisteredSymbol:iu});for(var ou=ze,su=oe,ru=b,nu=Re,au=pt,du=su("Symbol"),cu=du.isWellKnownSymbol,lu=su("Object","getOwnPropertyNames"),uu=ru(du.prototype.valueOf),hu=ou("wks"),mu=0,pu=lu(du),_u=pu.length;mu<_u;mu++)try{var bu=pu[mu];nu(du[bu])&&au(bu)}catch(BW){}var vu=function(e){if(cu&&cu(e))return!0;try{for(var t=uu(e),i=0,o=lu(hu),s=o.length;i<s;i++)if(hu[o[i]]==t)return!0}catch(BW){}return!1};ki({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:vu}),vs("customMatcher"),vs("observable"),ki({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:iu}),ki({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:vu}),vs("matcher"),vs("metadataKey"),vs("patternMatch"),vs("replaceAll");var Su=i(Bl),yu=b,fu=wi,gu=fo,Tu=H,Iu=yu("".charAt),Ru=yu("".charCodeAt),Eu=yu("".slice),Cu=function(e){return function(t,i){var o,s,r=gu(Tu(t)),n=fu(i),a=r.length;return n<0||n>=a?e?"":void 0:(o=Ru(r,n))<55296||o>56319||n+1===a||(s=Ru(r,n+1))<56320||s>57343?e?Iu(r,n):o:e?Eu(r,n,n+2):s-56320+(o-55296<<10)+65536}},Zu={codeAt:Cu(!1),charAt:Cu(!0)},Lu=Zu.charAt,Pu=fo,ku=Js,Nu=Nl,Xu=Xl,Vu="String Iterator",wu=ku.set,xu=ku.getterFor(Vu);Nu(String,"String",(function(e){wu(this,{type:Vu,string:Pu(e),index:0})}),(function(){var e,t=xu(this),i=t.string,o=t.index;return o>=i.length?Xu(void 0,!0):(e=Lu(i,o),t.index+=e.length,Xu(e,!1))}));var Gu=i(ds.f("iterator"));function Wu(e){return(Wu="function"==typeof Su&&"symbol"==typeof Gu?function(e){return typeof e}:function(e){return e&&"function"==typeof Su&&e.constructor===Su&&e!==Su.prototype?"symbol":typeof e})(e)}var Mu=i(ds.f("toPrimitive"));function Au(e){var t=function(e,t){if("object"!=Wu(e)||!e)return e;var i=e[Mu];if(void 0!==i){var o=i.call(e,t||"default");if("object"!=Wu(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Wu(t)?t:t+""}function Ou(e,t,i){return(t=Au(t))in e?oc(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Du(e,t){var i=ao(e);if(Xa){var o=Xa(e);t&&(o=Fa(o).call(o,(function(t){return ed(e,t).enumerable}))),bd(i).apply(i,o)}return i}function Yu(e){for(var t=1;t<arguments.length;t++){var i,o,s=null!=arguments[t]?arguments[t]:{};t%2?Ld(i=Du(Object(s),!0)).call(i,(function(t){Ou(e,t,s[t])})):Kd?Qd(e,Kd(s)):Ld(o=Du(Object(s))).call(o,(function(t){oc(e,t,ed(s,t))}))}return e}var Ku=(e=>(e[e.VIDEO_SOURCE_TYPE_EXTERNAL=0]="VIDEO_SOURCE_TYPE_EXTERNAL",e[e.VIDEO_SOURCE_TYPE_INTERNAL=1]="VIDEO_SOURCE_TYPE_INTERNAL",e))(Ku||{}),Uu=(e=>(e[e.AUDIO_SOURCE_TYPE_EXTERNAL=0]="AUDIO_SOURCE_TYPE_EXTERNAL",e[e.AUDIO_SOURCE_TYPE_INTERNAL=1]="AUDIO_SOURCE_TYPE_INTERNAL",e))(Uu||{}),Fu=(e=>(e[e.QUIT=0]="QUIT",e[e.DROPPED=1]="DROPPED",e[e.SWITCH_TO_INVISIBLE=2]="SWITCH_TO_INVISIBLE",e[e.KICKED_BY_ADMIN=3]="KICKED_BY_ADMIN",e))(Fu||{}),Hu=(e=>(e[e.CHANNEL_PROFILE_COMMUNICATION=0]="CHANNEL_PROFILE_COMMUNICATION",e[e.CHANNEL_PROFILE_LIVE_BROADCASTING=1]="CHANNEL_PROFILE_LIVE_BROADCASTING",e))(Hu||{}),Ju=(e=>(e[e.AUTO_SUBSCRIBE_MODE=0]="AUTO_SUBSCRIBE_MODE",e[e.MANUAL_SUBSCRIBE_MODE=1]="MANUAL_SUBSCRIBE_MODE",e))(Ju||{}),zu=(e=>(e[e.SUBSCRIBE_SUCC=0]="SUBSCRIBE_SUCC",e[e.SUBSCRIBE_FAIL=1]="SUBSCRIBE_FAIL",e))(zu||{}),ju=(e=>(e[e.PUBLISH_SUCC=0]="PUBLISH_SUCC",e[e.PUBLISH_FAIL=1]="PUBLISH_FAIL",e))(ju||{}),Qu=(e=>(e[e.MIRROR_MODE_OFF=0]="MIRROR_MODE_OFF",e[e.MIRROR_MODE_ON=1]="MIRROR_MODE_ON",e))(Qu||{}),Bu=(e=>(e[e.RENDER_MODE_HIDDEN=0]="RENDER_MODE_HIDDEN",e[e.RENDER_MODE_FIT=1]="RENDER_MODE_FIT",e[e.RENDER_MODE_FILL=2]="RENDER_MODE_FILL",e))(Bu||{}),qu=(e=>(e[e.STREAM_INDEX_MAIN=0]="STREAM_INDEX_MAIN",e[e.STREAM_INDEX_SCREEN=1]="STREAM_INDEX_SCREEN",e))(qu||{}),$u=(e=>(e[e.AUDIO=1]="AUDIO",e[e.VIDEO=2]="VIDEO",e[e.AUDIO_AND_VIDEO=3]="AUDIO_AND_VIDEO",e))($u||{}),eh=(e=>(e[e.STREAM_REMOVE_REASON_UNPUBLISH=0]="STREAM_REMOVE_REASON_UNPUBLISH",e[e.STREAM_REMOVE_REASON_PUBLISH_FAILED=1]="STREAM_REMOVE_REASON_PUBLISH_FAILED",e[e.STREAM_REMOVE_REASON_KEEP_LIVE_FAILED=2]="STREAM_REMOVE_REASON_KEEP_LIVE_FAILED",e[e.STREAM_REMOVE_REASON_CLIENT_DISCONNECTED=3]="STREAM_REMOVE_REASON_CLIENT_DISCONNECTED",e[e.STREAM_REMOVE_REASON_REPUBLISH=4]="STREAM_REMOVE_REASON_REPUBLISH",e[e.STREAM_REMOVE_REASON_OTHER=5]="STREAM_REMOVE_REASON_OTHER",e[e.STREAM_REMOVE_REASON_TOKEN_PRIVILEGE_EXPIRED=6]="STREAM_REMOVE_REASON_TOKEN_PRIVILEGE_EXPIRED",e))(eh||{}),th=(e=>(e[e.CONNECTION_START=0]="CONNECTION_START",e[e.CONNECTION_STATE_DISCONNECTED=1]="CONNECTION_STATE_DISCONNECTED",e[e.CONNECTION_STATE_CONNECTING=2]="CONNECTION_STATE_CONNECTING",e[e.CONNECTION_STATE_CONNECTED=3]="CONNECTION_STATE_CONNECTED",e[e.CONNECTION_STATE_RECONNECTING=4]="CONNECTION_STATE_RECONNECTING",e[e.CONNECTION_STATE_RECONNECTED=5]="CONNECTION_STATE_RECONNECTED",e[e.CONNECTION_STATE_LOST=6]="CONNECTION_STATE_LOST",e))(th||{}),ih=(e=>(e.ICE_FAILED="iceFailed",e.NODE_CHANGE="nodeChange",e.JOIN_TIMEOUT="joinTimeout",e.NOTIFY_RECONNECT="notifyReconnect",e))(ih||{}),oh=(e=>(e.AUTO="auto",e.H264="h264",e.VP8="vp8",e.ByteVC1="ByteVC1",e))(oh||{}),sh=(e=>(e[e.MIRROR_TYPE_NONE=0]="MIRROR_TYPE_NONE",e[e.MIRROR_TYPE_RENDER=1]="MIRROR_TYPE_RENDER",e))(sh||{}),rh=(e=>(e[e.NORMAL=0]="NORMAL",e[e.DISCONNECT=1]="DISCONNECT",e[e.RESET=2]="RESET",e))(rh||{}),nh=(e=>(e[e.MICROPHONE=0]="MICROPHONE",e[e.AUDIOMIXING=1]="AUDIOMIXING",e))(nh||{}),ah=(e=>(e[e.domestic=0]="domestic",e[e.overseas=1]="overseas",e))(ah||{}),dh=(e=>(e[e.OFFLINE=0]="OFFLINE",e[e.ONLINE=1]="ONLINE",e[e.UNREACHABLE=2]="UNREACHABLE",e))(dh||{}),ch=(e=>(e[e.AUDIO_AND_VIDEO=0]="AUDIO_AND_VIDEO",e[e.AUDIO_ONLY=1]="AUDIO_ONLY",e[e.VIDEO_ONLY=2]="VIDEO_ONLY",e))(ch||{}),lh=(e=>(e[e.PREV_FRAME=0]="PREV_FRAME",e[e.OTHER_FRAME=1]="OTHER_FRAME",e))(lh||{}),uh=(e=>(e[e.DISABLE=0]="DISABLE",e[e.VIDEO_STREAM_LOW=1]="VIDEO_STREAM_LOW",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e))(uh||{}),hh=(e=>(e[e.LOW=0]="LOW",e[e.MEDIUM=100]="MEDIUM",e[e.HIGH=200]="HIGH",e))(hh||{}),mh=(e=>(e[e.UNKNOWN=0]="UNKNOWN",e[e.EXCELLENT=1]="EXCELLENT",e[e.GOOD=2]="GOOD",e[e.POOR=3]="POOR",e[e.BAD=4]="BAD",e[e.VBAD=5]="VBAD",e[e.DOWN=6]="DOWN",e))(mh||{}),ph=(e=>(e[e.Unknown=-1]="Unknown",e[e.SubscribeFallbackByBandwidth=0]="SubscribeFallbackByBandwidth",e[e.SubscribeRecoverByBandwidth=2]="SubscribeRecoverByBandwidth",e))(ph||{}),_h=(e=>(e[e.communication=0]="communication",e[e.chat=5]="chat",e[e.chatRoom=6]="chatRoom",e[e.coHost=9]="coHost",e[e.meeting=16]="meeting",e[e.classRoom=18]="classRoom",e))(_h||{}),bh=(e=>(e[e.default=0]="default",e[e.fluent=1]="fluent",e[e.standard=2]="standard",e[e.hd=3]="hd",e[e.standardStereo=4]="standardStereo",e[e.hdMono=5]="hdMono",e))(bh||{}),vh=(e=>(e[e.AUTO_PLAY=0]="AUTO_PLAY",e[e.VIDEO_ONLY=1]="VIDEO_ONLY",e[e.PLAY_MANUALLY=2]="PLAY_MANUALLY",e))(vh||{}),Sh=(e=>(e.LC="LC",e.HEv1="HEv1",e.HEv2="HEv2",e))(Sh||{}),yh=(e=>(e.H264="H264",e.H265="H265",e))(yh||{}),fh=(e=>(e[e.ASR_ONLY=0]="ASR_ONLY",e[e.ASR_AND_TRANSLATION=1]="ASR_AND_TRANSLATION",e))(fh||{}),gh=(e=>(e[e.STARTED=0]="STARTED",e[e.STOPPED=1]="STOPPED",e[e.ERROR=2]="ERROR",e[e.UPDATED=3]="UPDATED",e))(gh||{}),Th=(e=>(e[e.FORWARD_STREAM_STATE_SUCCESS=0]="FORWARD_STREAM_STATE_SUCCESS",e[e.FORWARD_STREAM_STATE_FAILURE=1]="FORWARD_STREAM_STATE_FAILURE",e))(Th||{}),Ih=(e=>(e[e.FORWARD_STREAM_ERROR_OK=0]="FORWARD_STREAM_ERROR_OK",e[e.FORWARD_STREAM_ERROR_INVALID_TOKEN=1202]="FORWARD_STREAM_ERROR_INVALID_TOKEN",e[e.FORWARD_STREAM_ERROR_RESPONSE=1203]="FORWARD_STREAM_ERROR_RESPONSE",e[e.FORWARD_STREAM_ERROR_REMOTE_KICKED=1204]="FORWARD_STREAM_ERROR_REMOTE_KICKED",e[e.FORWARD_STREAM_ERROR_NOT_SUPPORT=1205]="FORWARD_STREAM_ERROR_NOT_SUPPORT",e))(Ih||{}),Rh=(e=>(e[e.DEFAULT=0]="DEFAULT",e[e.HIGH=1]="HIGH",e))(Rh||{}),Eh=(e=>(e[e.VIDEO_ONLY_ONE=0]="VIDEO_ONLY_ONE",e[e.VIDEO_ON_DEMAND=1]="VIDEO_ON_DEMAND",e[e.VIDEO_ALWAYS_SIMULCAST=2]="VIDEO_ALWAYS_SIMULCAST",e))(Eh||{}),Ch=(e=>(e.VIDEO_STREAM_HIGH="high",e.VIDEO_STREAM_MID="mid",e.VIDEO_STREAM_LOW="low",e))(Ch||{}),Zh=(e=>(e[e.NONE=0]="NONE",e[e.AFTER_CAPTURE=1]="AFTER_CAPTURE",e[e.AFTER_PROCESS=2]="AFTER_PROCESS",e))(Zh||{}),Lh=(e=>(e[e.ROOM_MODE_RTC=0]="ROOM_MODE_RTC",e[e.ROOM_MODE_RTS_ONLY=1]="ROOM_MODE_RTS_ONLY",e))(Lh||{}),Ph=Object.freeze({__proto__:null,AAC_PROFILE:Sh,AudioProfileType:bh,AudioReportMode:nh,AudioSelectionPriority:Rh,AudioSourceType:Uu,ChannelProfile:Hu,ConnectionState:th,EarMonitorPosition:Zh,FallbackOrRecoverReason:ph,ForwardStreamError:Ih,ForwardStreamState:Th,LocalMainReportMode:rh,LogChannel:ah,MediaType:$u,MirrorMode:Qu,MirrorType:sh,NetworkQuality:mh,PublicInterpolationMode:lh,PublicStreamType:ch,PublishState:ju,RTCAutoPlayPolicy:vh,ReconnectReason:ih,RemoteUserPriority:hh,RoomMode:Lh,RoomProfileType:_h,SUBTITLE_MODE:fh,SimulcastStreamType:Ch,StreamIndex:qu,StreamRemoveReason:eh,SubscribeFallbackOption:uh,SubscribeMode:Ju,SubscribeState:zu,SubtitleEventType:gh,TRANSCODING_VIDEO_CODEC:yh,USER_ONLINE_STATUS:dh,UserOfflineReason:Fu,VideoCodecType:oh,VideoRenderMode:Bu,VideoSimulcastMode:Eh,VideoSourceType:Ku}),kh=(e=>(e[e.AUTO=0]="AUTO",e[e.MODE_L=1]="MODE_L",e[e.MODE_R=2]="MODE_R",e[e.MODE_MIX=3]="MODE_MIX",e))(kh||{}),Nh=(e=>(e[e.PLAYOUT=0]="PLAYOUT",e[e.PUBLISH=1]="PUBLISH",e[e.PLAYOUT_AND_PUBLISH=2]="PLAYOUT_AND_PUBLISH",e))(Nh||{}),Xh=(e=>(e[e.AUDIO_MIXING_STATE_PRELOADED=0]="AUDIO_MIXING_STATE_PRELOADED",e[e.AUDIO_MIXING_STATE_PLAYING=1]="AUDIO_MIXING_STATE_PLAYING",e[e.AUDIO_MIXING_STATE_PAUSED=2]="AUDIO_MIXING_STATE_PAUSED",e[e.AUDIO_MIXING_STATE_STOPPED=3]="AUDIO_MIXING_STATE_STOPPED",e[e.AUDIO_MIXING_STATE_FAILED=4]="AUDIO_MIXING_STATE_FAILED",e[e.AUDIO_MIXING_STATE_FINISHED=5]="AUDIO_MIXING_STATE_FINISHED",e[e.AUDIO_MIXING_STATE_PCM_ENABLED=6]="AUDIO_MIXING_STATE_PCM_ENABLED",e[e.AUDIO_MIXING_STATE_PCM_DISABLED=7]="AUDIO_MIXING_STATE_PCM_DISABLED",e))(Xh||{}),Vh=Object.freeze({__proto__:null,AudioMixingDualMonoMode:kh,AudioMixingState:Xh,AudioMixingType:Nh}),wh=(e=>(e.onTrackEnded="onTrackEnded",e.onTrackMute="onTrackMute",e.onTrackUnmute="onTrackUnmute",e.onPlayerEvent="onPlayerEvent",e.onAutoplayFailed="onAutoplayFailed",e.onUserJoined="onUserJoined",e.onUserLeave="onUserLeave",e.onConnectionStateChanged="onConnectionStateChanged",e.onUserPublishStream="onUserPublishStream",e.onUserUnpublishStream="onUserUnpublishStream",e.onUserPublishScreen="onUserPublishScreen",e.onUserUnpublishScreen="onUserUnpublishScreen",e.onRoomMessageReceived="onRoomMessageReceived",e.onRoomBinaryMessageReceived="onRoomBinaryMessageReceived",e.onUserMessageReceived="onUserMessageReceived",e.onUserBinaryMessageReceived="onUserBinaryMessageReceived",e.onVideoFirstFrameRendered="onVideoFirstFrameRendered",e.onVideoFirstFrameDecoded="onVideoFirstFrameDecoded",e.onRemoteVideoFirstFrame="onRemoteVideoFirstFrame",e.onAudioFirstFrameDecoded="onAudioFirstFrameDecoded",e.onRemoteAudioFirstFrame="onRemoteAudioFirstFrame",e.onFirstPublicStreamVideoFrameRendered="onFirstPublicStreamVideoFrameRendered",e.onFirstPublicStreamVideoFrameDecoded="onFirstPublicStreamVideoFrameDecoded",e.onFirstPublicStreamAudioFrameDecoded="onFirstPublicStreamAudioFrameDecoded",e.onVideoDeviceStateChanged="onVideoDeviceStateChanged",e.onAudioDeviceStateChanged="onAudioDeviceStateChanged",e.onRemoteStreamStats="onRemoteStreamStats",e.onPublicStreamStats="onPublicStreamStats",e.onLocalStreamStats="onLocalStreamStats",e.onAudioVolumeIndication="onAudioVolumeIndication",e.onLocalAudioPropertiesReport="onLocalAudioPropertiesReport",e.onRemoteAudioPropertiesReport="onRemoteAudioPropertiesReport",e.onActiveSpeaker="onActiveSpeaker",e.onAudioPlaybackDeviceChanged="onAudioPlaybackDeviceChanged",e.onUserStartVideoCapture="onUserStartVideoCapture",e.onUserStopVideoCapture="onUserStopVideoCapture",e.onUserStartAudioCapture="onUserStartAudioCapture",e.onUserStopAudioCapture="onUserStopAudioCapture",e.onAutoPublishResult="onAutoPublishResult",e.onAutoSubscribeResult="onAutoSubscribeResult",e.onLiveTranscodingResult="onLiveTranscodingResult",e.onStreamMixingEvent="onStreamMixingEvent",e.onAudioPlaybackDeviceTestVolume="onAudioPlaybackDeviceTestVolume",e.onSEIMessageReceived="onSEIMessageReceived",e.onError="onError",e.onAudioMixingStateChanged="onAudioMixingStateChanged",e.onUserMessageReceivedOutsideRoom="onUserMessageReceivedOutsideRoom",e.onUserBinaryMessageReceivedOutsideRoom="onUserBinaryMessageReceivedOutsideRoom",e.onTokenWillExpire="onTokenWillExpire",e.onTokenPublishPrivilegeWillExpire="onTokenPublishPrivilegeWillExpire",e.onTokenPublishPrivilegeDidExpired="onTokenPublishPrivilegeDidExpired",e.onTokenSubscribePrivilegeWillExpire="onTokenSubscribePrivilegeWillExpire",e.onTokenSubscribePrivilegeDidExpired="onTokenSubscribePrivilegeDidExpired",e.onCloudProxyConnected="onCloudProxyConnected",e.onPushPublicStreamResult="onPushPublicStreamResult",e.onPublicStreamSEIMessageReceived="onPublicStreamSEIMessageReceived",e.onNetworkQuality="onNetworkQuality",e.onSimulcastSubscribeFallback="onSimulcastSubscribeFallback",e.onRemoteVideoSizeChanged="onRemoteVideoSizeChanged",e.onVideoStreamBanned="onVideoStreamBanned",e.onAudioStreamBanned="onAudioStreamBanned",e.onLocalVideoSizeChanged="onLocalVideoSizeChanged",e.onSubtitleStateChanged="onSubtitleStateChanged",e.onSubtitleMessageReceived="onSubtitleMessageReceived",e.onServerParamsSetResult="onServerParamsSetResult",e.onLocalStreamTrackChangedByExtension="onLocalStreamTrackChangedByExtension",e.onVendorConnectionStateChanged="onVendorConnectionStateChanged",e.onForwardStreamError="onForwardStreamError",e.onRejoinWithTcp="onRejoinWithTcp",e.onIceConnectWithTcp="onIceConnectWithTcp",e.onPublishRetry="onPublishRetry",e.onSubscribeRetry="onSubscribeRetry",e.onPublishResult="onPublishResult",e.onSubscribeResult="onSubscribeResult",e.onSEIStreamUpdate="onSEIStreamUpdate",e))(wh||{}),xh=ki,Gh=js,Wh=b([].reverse),Mh=[1,2];xh({target:"Array",proto:!0,forced:String(Mh)===String(Mh.reverse())},{reverse:function(){return Gh(this)&&(this.length=this.length),Wh(this)}});var Ah=Oa("Array","reverse"),Oh=se,Dh=Ah,Yh=Array.prototype,Kh=i((function(e){var t=e.reverse;return e===Yh||Oh(Yh,e)&&t===Yh.reverse?Dh:t})),Uh="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",Fh=H,Hh=fo,Jh=Uh,zh=b("".replace),jh=RegExp("^["+Jh+"]+"),Qh=RegExp("(^|[^"+Jh+"])["+Jh+"]+$"),Bh=function(e){return function(t){var i=Hh(Fh(t));return 1&e&&(i=zh(i,jh,"")),2&e&&(i=zh(i,Qh,"$1")),i}},qh={start:Bh(1),end:Bh(2),trim:Bh(3)},$h=Nc.PROPER,em=r,tm=Uh,im=qh.trim;ki({target:"String",proto:!0,forced:function(e){return em((function(){return!!tm[e]()||"âÂá "!=="âÂá "[e]()||$h&&tm[e].name!==e}))}("trim")},{trim:function(){return im(this)}});var om,sm=Oa("String","trim"),rm=se,nm=sm,am=String.prototype,dm=i((function(e){var t=e.trim;return"string"==typeof e||e===am||rm(am,e)&&t===am.trim?nm:t})),cm=new Uint8Array(16);function lm(){if(!om&&!(om="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return om(cm)}var um=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var hm=[],mm=0;mm<256;++mm)hm.push((mm+256).toString(16).substr(1));function pm(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(hm[e[t+0]]+hm[e[t+1]]+hm[e[t+2]]+hm[e[t+3]]+"-"+hm[e[t+4]]+hm[e[t+5]]+"-"+hm[e[t+6]]+hm[e[t+7]]+"-"+hm[e[t+8]]+hm[e[t+9]]+"-"+hm[e[t+10]]+hm[e[t+11]]+hm[e[t+12]]+hm[e[t+13]]+hm[e[t+14]]+hm[e[t+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&um.test(e)}(i))throw TypeError("Stringified UUID is invalid");return i}function _m(e,t,i){var o=(e=e||{}).random||(e.rng||lm)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){i=i||0;for(var s=0;s<16;++s)t[i+s]=o[s];return t}return pm(o)}const bm=()=>"undefined"==typeof window,vm=()=>_m(),Sm=e=>"number"==typeof e;function ym(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({contentHint:e.contentHint,enabled:e.enabled,id:e.id,kind:e.kind,label:e.label,muted:e.muted,readyState:e.readyState})}function fm(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({id:e.id,active:e.active})}function gm(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({track:ym(e.track)})}function Tm(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({track:ym(e.track)})}function Im(e){return null==e?"undefined | null":"string"==typeof e?e:JSON.stringify({currentDirection:e.currentDirection,direction:e.direction,mid:e.mid,stopped:e.stopped,receiver:Tm(e.receiver),sender:gm(e.sender)})}const Rm="@byted/ve-rtc",Em="@byted/ve-rtc-cache-size";var Cm=new class{constructor(){Ou(this,"storeKey",void 0),Ou(this,"logLevel",void 0),Ou(this,"LogfileSize",void 0),Ou(this,"db",void 0),Ou(this,"logId",void 0),Ou(this,"cacheLog",void 0),Ou(this,"cachedSize",void 0),Ou(this,"preCacheTime",void 0),Ou(this,"timer",void 0),Ou(this,"_getSize",(e=>new Blob(e).size/1048576)),this.storeKey="",this.logId=1,this.cacheLog="",this.logLevel="none",this.LogfileSize=100,this._createStore()}_createStore(){if(bm()||!window.indexedDB)return;const e=indexedDB.open("@byted/ve-rtc");e.onupgradeneeded=()=>{e.result.createObjectStore(Rm);try{localStorage.removeItem(Em)}catch(BW){}},e.onerror=e=>{},e.onsuccess=()=>{this.db=e.result,this._getCachedSize()}}_getCachedSize(){try{const e=localStorage.getItem(Em);e?this.cachedSize=Number(e):this.values().then((e=>{this.cachedSize=this._getSize(e),this._setCachedSize()}))}catch(BW){}}_setCachedSize(){try{localStorage.setItem(Em,"".concat(this.cachedSize))}catch(BW){}}_getStore(e){if(this.db)return this.db.transaction(Rm,e).objectStore(Rm)}set(e){return new Promise(((t,i)=>{if("none"===this.logLevel)return t();if(e&&this.preCacheTime&&this.preCacheTime-Date.now()<1e3)return this.cacheLog+="\n\n".concat(this.logId,": ").concat(e),this.logId++,this.timer||(this.timer=setTimeout((()=>{this.set("")}),1e3-(this.preCacheTime-Date.now()))),t();clearTimeout(this.timer),this.timer=null;const o=this._getStore("readwrite");if(!o)return i("get store fail");this.cachedSize&&this.cachedSize>this.LogfileSize&&this.keyEarliest().then((e=>{this.get(e).then((t=>{this.del(e).then((()=>{this.cachedSize=this.cachedSize-this._getSize(["".concat(t)]),this._setCachedSize()}))}))}));const s=o.get(this.storeKey);s.onsuccess=()=>{try{const i="".concat(s.result||"").concat(this.cacheLog),r=e?"".concat(i?"\n\n":"").concat(this.logId,": ").concat(e):"";o.put("".concat(i).concat(r),this.storeKey),e&&this.logId++,this.cacheLog="",this.cachedSize=(this.cachedSize||0)+this._getSize(["".concat(this.cacheLog).concat(r)]),this._setCachedSize(),this.preCacheTime=Date.now(),t()}catch(r){if(!e)return i(r);this.cacheLog+="\n\n".concat(this.logId,": ").concat(e),this.logId++,i(r)}},s.onerror=t=>{if(!e)return i(t);this.cacheLog+="\n\n".concat(this.logId,": ").concat(e),this.logId++,i(t)}}))}get(e){return new Promise(((t,i)=>{const o=this._getStore("readonly");if(!o)return i();const s=o.get(e);s.onsuccess=()=>{t(s.result)},s.onerror=e=>{i(e)}}))}del(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.storeKey;return new Promise(((t,i)=>{const o=this._getStore("readwrite");if(!o)return i();const s=o.delete(e);s.onsuccess=()=>t(s.result),s.onerror=e=>i(e)}))}keyEarliest(){return this.keys().then((e=>{let t,i=Date.now();return e.forEach((e=>{if(!e||!e.length)return;const o=e.split("-")[0];Number(o)<i&&(i=Number(o),t=e)})),t}))}keys(){return new Promise(((e,t)=>{const i=this._getStore("readonly");if(!i)return t();if(i.getAllKeys){const o=i.getAllKeys();return o.onsuccess=()=>{e(o.result)},void(o.onerror=()=>{t()})}const o=[];i.openCursor().onsuccess=function(){this.result&&(o.push(this.result.key),this.result.continue())},i.transaction.oncomplete=()=>e(o)}))}values(){return new Promise(((e,t)=>{const i=this._getStore("readonly");if(!i)return t();if(i.getAll){const o=i.getAll();return o.onsuccess=()=>{e(o.result)},void(o.onerror=()=>{t()})}const o=[];i.openCursor().onsuccess=function(){this.result&&(o.push(this.result.value),this.result.continue())},i.transaction.oncomplete=()=>e(o)}))}download(e){e=e||this.storeKey,this.get(e).then((t=>{const i=document.createElement("a");i.download="".concat(e,".txt"),i.href="data:text/paint;utf-8,".concat(t||""),i.click()}))}};let Zm=class{constructor(){Ou(this,"_all",{})}on(e,t){const i=this._all[e];i?i.push(t):this._all[e]=[t]}once(e,t){var i=this;const o=function(){t(...arguments),i.off(e,o)};this.on(e,o)}off(e,t){const i=this._all[e];null==i||i.splice(i.indexOf(t)>>>0,1)}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];const s=this._all[e];null==s||s.slice().forEach((e=>e(...i)))}safeEmit(e){try{for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];return this.emit(e,...i)}catch(BW){console.error(BW)}}destroy(){this._all={}}};const Lm=["UPLOAD_CONSOLE_LENGTH_CUT","UPLOAD_REPORT_LIMIT"];const Pm=new class extends Zm{constructor(){super(...arguments),Ou(this,"config",{UPLOAD_CONSOLE_ON:!1,UPLOAD_CONSOLE_LENGTH_CUT:200,UPLOAD_REPORT_LIMIT:45e4,ENABLE_REPORT_IDB_BUFFER:!1})}setParameter(e,t){if(function(e){return Lm.includes(e)}(e))try{const i=Number(t);if(Number.isNaN(i))return;this.config[e]=i}catch(i){return void console.warn("Cannot convert core lib parameter ".concat(e,":").concat(t," into number"))}else this.config[e]=t;this.emit(e,this.config[e])}getParameter(e){return this.config[e]}getKeys(){return Object.keys(this.config)}};var km=js,Nm=Yi,Xm=ad,Vm=qt,wm=function(e,t,i,o,s,r,n,a){for(var d,c,l=s,u=0,h=!!n&&Vm(n,a);u<o;)u in i&&(d=h?h(i[u],u,t):i[u],r>0&&km(d)?(c=Nm(d),l=wm(e,t,d,c,l,r-1)-1):(Xm(l+1),e[l]=d),l++),u++;return l},xm=wm,Gm=Be,Wm=Yi,Mm=wi,Am=yr;ki({target:"Array",proto:!0},{flat:function(){var e=arguments.length?arguments[0]:void 0,t=Gm(this),i=Wm(t),o=Am(t,0);return o.length=xm(o,t,t,i,0,void 0===e?1:Mm(e)),o}});var Om=Oa("Array","flat"),Dm=se,Ym=Om,Km=Array.prototype,Um=i((function(e){var t=e.flat;return e===Km||Dm(Km,e)&&t===Km.flat?Ym:t})),Fm={};!function(e){var t="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var o=t.shift();if(o){if("object"!=typeof o)throw new TypeError(o+"must be non-object");for(var s in o)i(o,s)&&(e[s]=o[s])}}return e},e.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var o={arraySet:function(e,t,i,o,s){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+o),s);else for(var r=0;r<o;r++)e[s+r]=t[i+r]},flattenChunks:function(e){var t,i,o,s,r,n;for(o=0,t=0,i=e.length;t<i;t++)o+=e[t].length;for(n=new Uint8Array(o),s=0,t=0,i=e.length;t<i;t++)r=e[t],n.set(r,s),s+=r.length;return n}},s={arraySet:function(e,t,i,o,s){for(var r=0;r<o;r++)e[s+r]=t[i+r]},flattenChunks:function(e){return[].concat.apply([],e)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,o)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,s))},e.setTyped(t)}(Fm);var Hm={},Jm={},zm={},jm=Fm;function Qm(e){for(var t=e.length;--t>=0;)e[t]=0}var Bm=256,qm=286,$m=30,ep=15,tp=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ip=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],op=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],sp=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],rp=new Array(576);Qm(rp);var np=new Array(60);Qm(np);var ap=new Array(512);Qm(ap);var dp=new Array(256);Qm(dp);var cp=new Array(29);Qm(cp);var lp,up,hp,mp=new Array($m);function pp(e,t,i,o,s){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=o,this.max_length=s,this.has_stree=e&&e.length}function _p(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function bp(e){return e<256?ap[e]:ap[256+(e>>>7)]}function vp(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function Sp(e,t,i){e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,vp(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function yp(e,t,i){Sp(e,i[2*t],i[2*t+1])}function fp(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function gp(e,t,i){var o,s,r=new Array(16),n=0;for(o=1;o<=ep;o++)r[o]=n=n+i[o-1]<<1;for(s=0;s<=t;s++){var a=e[2*s+1];0!==a&&(e[2*s]=fp(r[a]++,a))}}function Tp(e){var t;for(t=0;t<qm;t++)e.dyn_ltree[2*t]=0;for(t=0;t<$m;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function Ip(e){e.bi_valid>8?vp(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function Rp(e,t,i,o){var s=2*t,r=2*i;return e[s]<e[r]||e[s]===e[r]&&o[t]<=o[i]}function Ep(e,t,i){for(var o=e.heap[i],s=i<<1;s<=e.heap_len&&(s<e.heap_len&&Rp(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!Rp(t,o,e.heap[s],e.depth));)e.heap[i]=e.heap[s],i=s,s<<=1;e.heap[i]=o}function Cp(e,t,i){var o,s,r,n,a=0;if(0!==e.last_lit)do{o=e.pending_buf[e.d_buf+2*a]<<8|e.pending_buf[e.d_buf+2*a+1],s=e.pending_buf[e.l_buf+a],a++,0===o?yp(e,s,t):(yp(e,(r=dp[s])+Bm+1,t),0!==(n=tp[r])&&Sp(e,s-=cp[r],n),yp(e,r=bp(--o),i),0!==(n=ip[r])&&Sp(e,o-=mp[r],n))}while(a<e.last_lit);yp(e,256,t)}function Zp(e,t){var i,o,s,r=t.dyn_tree,n=t.stat_desc.static_tree,a=t.stat_desc.has_stree,d=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=573,i=0;i<d;i++)0!==r[2*i]?(e.heap[++e.heap_len]=c=i,e.depth[i]=0):r[2*i+1]=0;for(;e.heap_len<2;)r[2*(s=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[s]=0,e.opt_len--,a&&(e.static_len-=n[2*s+1]);for(t.max_code=c,i=e.heap_len>>1;i>=1;i--)Ep(e,r,i);s=d;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Ep(e,r,1),o=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=o,r[2*s]=r[2*i]+r[2*o],e.depth[s]=(e.depth[i]>=e.depth[o]?e.depth[i]:e.depth[o])+1,r[2*i+1]=r[2*o+1]=s,e.heap[1]=s++,Ep(e,r,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,o,s,r,n,a,d=t.dyn_tree,c=t.max_code,l=t.stat_desc.static_tree,u=t.stat_desc.has_stree,h=t.stat_desc.extra_bits,m=t.stat_desc.extra_base,p=t.stat_desc.max_length,_=0;for(r=0;r<=ep;r++)e.bl_count[r]=0;for(d[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<573;i++)(r=d[2*d[2*(o=e.heap[i])+1]+1]+1)>p&&(r=p,_++),d[2*o+1]=r,o>c||(e.bl_count[r]++,n=0,o>=m&&(n=h[o-m]),a=d[2*o],e.opt_len+=a*(r+n),u&&(e.static_len+=a*(l[2*o+1]+n)));if(0!==_){do{for(r=p-1;0===e.bl_count[r];)r--;e.bl_count[r]--,e.bl_count[r+1]+=2,e.bl_count[p]--,_-=2}while(_>0);for(r=p;0!==r;r--)for(o=e.bl_count[r];0!==o;)(s=e.heap[--i])>c||(d[2*s+1]!==r&&(e.opt_len+=(r-d[2*s+1])*d[2*s],d[2*s+1]=r),o--)}}(e,t),gp(r,c,e.bl_count)}function Lp(e,t,i){var o,s,r=-1,n=t[1],a=0,d=7,c=4;for(0===n&&(d=138,c=3),t[2*(i+1)+1]=65535,o=0;o<=i;o++)s=n,n=t[2*(o+1)+1],++a<d&&s===n||(a<c?e.bl_tree[2*s]+=a:0!==s?(s!==r&&e.bl_tree[2*s]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,r=s,0===n?(d=138,c=3):s===n?(d=6,c=3):(d=7,c=4))}function Pp(e,t,i){var o,s,r=-1,n=t[1],a=0,d=7,c=4;for(0===n&&(d=138,c=3),o=0;o<=i;o++)if(s=n,n=t[2*(o+1)+1],!(++a<d&&s===n)){if(a<c)do{yp(e,s,e.bl_tree)}while(0!=--a);else 0!==s?(s!==r&&(yp(e,s,e.bl_tree),a--),yp(e,16,e.bl_tree),Sp(e,a-3,2)):a<=10?(yp(e,17,e.bl_tree),Sp(e,a-3,3)):(yp(e,18,e.bl_tree),Sp(e,a-11,7));a=0,r=s,0===n?(d=138,c=3):s===n?(d=6,c=3):(d=7,c=4)}}Qm(mp);var kp=!1;function Np(e,t,i,o){Sp(e,0+(o?1:0),3),function(e,t,i,o){Ip(e),o&&(vp(e,i),vp(e,~i)),jm.arraySet(e.pending_buf,e.window,t,i,e.pending),e.pending+=i}(e,t,i,!0)}zm._tr_init=function(e){kp||(!function(){var e,t,i,o,s,r=new Array(16);for(i=0,o=0;o<28;o++)for(cp[o]=i,e=0;e<1<<tp[o];e++)dp[i++]=o;for(dp[i-1]=o,s=0,o=0;o<16;o++)for(mp[o]=s,e=0;e<1<<ip[o];e++)ap[s++]=o;for(s>>=7;o<$m;o++)for(mp[o]=s<<7,e=0;e<1<<ip[o]-7;e++)ap[256+s++]=o;for(t=0;t<=ep;t++)r[t]=0;for(e=0;e<=143;)rp[2*e+1]=8,e++,r[8]++;for(;e<=255;)rp[2*e+1]=9,e++,r[9]++;for(;e<=279;)rp[2*e+1]=7,e++,r[7]++;for(;e<=287;)rp[2*e+1]=8,e++,r[8]++;for(gp(rp,287,r),e=0;e<$m;e++)np[2*e+1]=5,np[2*e]=fp(e,5);lp=new pp(rp,tp,257,qm,ep),up=new pp(np,ip,0,$m,ep),hp=new pp(new Array(0),op,0,19,7)}(),kp=!0),e.l_desc=new _p(e.dyn_ltree,lp),e.d_desc=new _p(e.dyn_dtree,up),e.bl_desc=new _p(e.bl_tree,hp),e.bi_buf=0,e.bi_valid=0,Tp(e)},zm._tr_stored_block=Np,zm._tr_flush_block=function(e,t,i,o){var s,r,n=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<Bm;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),Zp(e,e.l_desc),Zp(e,e.d_desc),n=function(e){var t;for(Lp(e,e.dyn_ltree,e.l_desc.max_code),Lp(e,e.dyn_dtree,e.d_desc.max_code),Zp(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*sp[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),s=e.opt_len+3+7>>>3,(r=e.static_len+3+7>>>3)<=s&&(s=r)):s=r=i+5,i+4<=s&&-1!==t?Np(e,t,i,o):4===e.strategy||r===s?(Sp(e,2+(o?1:0),3),Cp(e,rp,np)):(Sp(e,4+(o?1:0),3),function(e,t,i,o){var s;for(Sp(e,t-257,5),Sp(e,i-1,5),Sp(e,o-4,4),s=0;s<o;s++)Sp(e,e.bl_tree[2*sp[s]+1],3);Pp(e,e.dyn_ltree,t-1),Pp(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,n+1),Cp(e,e.dyn_ltree,e.dyn_dtree)),Tp(e),o&&Ip(e)},zm._tr_tally=function(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(dp[i]+Bm+1)]++,e.dyn_dtree[2*bp(t)]++),e.last_lit===e.lit_bufsize-1},zm._tr_align=function(e){Sp(e,2,3),yp(e,256,rp),function(e){16===e.bi_valid?(vp(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)};var Xp=function(e,t,i,o){for(var s=65535&e,r=e>>>16&65535,n=0;0!==i;){i-=n=i>2e3?2e3:i;do{r=r+(s=s+t[o++]|0)|0}while(--n);s%=65521,r%=65521}return s|r<<16};var Vp=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var o=0;o<8;o++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();var wp,xp=function(e,t,i,o){var s=Vp,r=o+i;e^=-1;for(var n=o;n<r;n++)e=e>>>8^s[255&(e^t[n])];return~e},Gp={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Wp=Fm,Mp=zm,Ap=Xp,Op=xp,Dp=Gp,Yp=-2,Kp=258,Up=262,Fp=103,Hp=113,Jp=666;function zp(e,t){return e.msg=Dp[t],t}function jp(e){return(e<<1)-(e>4?9:0)}function Qp(e){for(var t=e.length;--t>=0;)e[t]=0}function Bp(e){var t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(Wp.arraySet(e.output,t.pending_buf,t.pending_out,i,e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))}function qp(e,t){Mp._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Bp(e.strm)}function $p(e,t){e.pending_buf[e.pending++]=t}function e_(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function t_(e,t){var i,o,s=e.max_chain_length,r=e.strstart,n=e.prev_length,a=e.nice_match,d=e.strstart>e.w_size-Up?e.strstart-(e.w_size-Up):0,c=e.window,l=e.w_mask,u=e.prev,h=e.strstart+Kp,m=c[r+n-1],p=c[r+n];e.prev_length>=e.good_match&&(s>>=2),a>e.lookahead&&(a=e.lookahead);do{if(c[(i=t)+n]===p&&c[i+n-1]===m&&c[i]===c[r]&&c[++i]===c[r+1]){r+=2,i++;do{}while(c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&c[++r]===c[++i]&&r<h);if(o=Kp-(h-r),r=h-Kp,o>n){if(e.match_start=t,n=o,o>=a)break;m=c[r+n-1],p=c[r+n]}}}while((t=u[t&l])>d&&0!=--s);return n<=e.lookahead?n:e.lookahead}function i_(e){var t,i,o,s,r,n,a,d,c,l,u=e.w_size;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=u+(u-Up)){Wp.arraySet(e.window,e.window,u,u,0),e.match_start-=u,e.strstart-=u,e.block_start-=u,t=i=e.hash_size;do{o=e.head[--t],e.head[t]=o>=u?o-u:0}while(--i);t=i=u;do{o=e.prev[--t],e.prev[t]=o>=u?o-u:0}while(--i);s+=u}if(0===e.strm.avail_in)break;if(n=e.strm,a=e.window,d=e.strstart+e.lookahead,c=s,l=void 0,(l=n.avail_in)>c&&(l=c),i=0===l?0:(n.avail_in-=l,Wp.arraySet(a,n.input,n.next_in,l,d),1===n.state.wrap?n.adler=Ap(n.adler,a,l,d):2===n.state.wrap&&(n.adler=Op(n.adler,a,l,d)),n.next_in+=l,n.total_in+=l,l),e.lookahead+=i,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=(e.ins_h<<e.hash_shift^e.window[r+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[r+3-1])&e.hash_mask,e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Up&&0!==e.strm.avail_in)}function o_(e,t){for(var i,o;;){if(e.lookahead<Up){if(i_(e),e.lookahead<Up&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-Up&&(e.match_length=t_(e,i)),e.match_length>=3)if(o=Mp._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else o=Mp._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(o&&(qp(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(qp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(qp(e,!1),0===e.strm.avail_out)?1:2}function s_(e,t){for(var i,o,s;;){if(e.lookahead<Up){if(i_(e),e.lookahead<Up&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-Up&&(e.match_length=t_(e,i),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,o=Mp._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,o&&(qp(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((o=Mp._tr_tally(e,0,e.window[e.strstart-1]))&&qp(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(o=Mp._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(qp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(qp(e,!1),0===e.strm.avail_out)?1:2}function r_(e,t,i,o,s){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=o,this.func=s}function n_(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Wp.Buf16(1146),this.dyn_dtree=new Wp.Buf16(122),this.bl_tree=new Wp.Buf16(78),Qp(this.dyn_ltree),Qp(this.dyn_dtree),Qp(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Wp.Buf16(16),this.heap=new Wp.Buf16(573),Qp(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Wp.Buf16(573),Qp(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function a_(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:Hp,e.adler=2===t.wrap?0:1,t.last_flush=0,Mp._tr_init(t),0):zp(e,Yp)}function d_(e){var t,i=a_(e);return 0===i&&((t=e.state).window_size=2*t.w_size,Qp(t.head),t.max_lazy_match=wp[t.level].max_lazy,t.good_match=wp[t.level].good_length,t.nice_match=wp[t.level].nice_length,t.max_chain_length=wp[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),i}function c_(e,t,i,o,s,r){if(!e)return Yp;var n=1;if(-1===t&&(t=6),o<0?(n=0,o=-o):o>15&&(n=2,o-=16),s<1||s>9||8!==i||o<8||o>15||t<0||t>9||r<0||r>4)return zp(e,Yp);8===o&&(o=9);var a=new n_;return e.state=a,a.strm=e,a.wrap=n,a.gzhead=null,a.w_bits=o,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Wp.Buf8(2*a.w_size),a.head=new Wp.Buf16(a.hash_size),a.prev=new Wp.Buf16(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Wp.Buf8(a.pending_buf_size),a.d_buf=1*a.lit_bufsize,a.l_buf=3*a.lit_bufsize,a.level=t,a.strategy=r,a.method=i,d_(e)}wp=[new r_(0,0,0,0,(function(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(i_(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var o=e.block_start+i;if((0===e.strstart||e.strstart>=o)&&(e.lookahead=e.strstart-o,e.strstart=o,qp(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-Up&&(qp(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(qp(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(qp(e,!1),e.strm.avail_out),1)})),new r_(4,4,8,4,o_),new r_(4,5,16,8,o_),new r_(4,6,32,32,o_),new r_(4,4,16,16,s_),new r_(8,16,32,32,s_),new r_(8,16,128,128,s_),new r_(8,32,128,256,s_),new r_(32,128,258,1024,s_),new r_(32,258,258,4096,s_)],Jm.deflateInit=function(e,t){return c_(e,t,8,15,8,0)},Jm.deflateInit2=c_,Jm.deflateReset=d_,Jm.deflateResetKeep=a_,Jm.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?Yp:(e.state.gzhead=t,0):Yp},Jm.deflate=function(e,t){var i,o,s,r;if(!e||!e.state||t>5||t<0)return e?zp(e,Yp):Yp;if(o=e.state,!e.output||!e.input&&0!==e.avail_in||o.status===Jp&&4!==t)return zp(e,0===e.avail_out?-5:Yp);if(o.strm=e,i=o.last_flush,o.last_flush=t,42===o.status)if(2===o.wrap)e.adler=0,$p(o,31),$p(o,139),$p(o,8),o.gzhead?($p(o,(o.gzhead.text?1:0)+(o.gzhead.hcrc?2:0)+(o.gzhead.extra?4:0)+(o.gzhead.name?8:0)+(o.gzhead.comment?16:0)),$p(o,255&o.gzhead.time),$p(o,o.gzhead.time>>8&255),$p(o,o.gzhead.time>>16&255),$p(o,o.gzhead.time>>24&255),$p(o,9===o.level?2:o.strategy>=2||o.level<2?4:0),$p(o,255&o.gzhead.os),o.gzhead.extra&&o.gzhead.extra.length&&($p(o,255&o.gzhead.extra.length),$p(o,o.gzhead.extra.length>>8&255)),o.gzhead.hcrc&&(e.adler=Op(e.adler,o.pending_buf,o.pending,0)),o.gzindex=0,o.status=69):($p(o,0),$p(o,0),$p(o,0),$p(o,0),$p(o,0),$p(o,9===o.level?2:o.strategy>=2||o.level<2?4:0),$p(o,3),o.status=Hp);else{var n=8+(o.w_bits-8<<4)<<8;n|=(o.strategy>=2||o.level<2?0:o.level<6?1:6===o.level?2:3)<<6,0!==o.strstart&&(n|=32),n+=31-n%31,o.status=Hp,e_(o,n),0!==o.strstart&&(e_(o,e.adler>>>16),e_(o,65535&e.adler)),e.adler=1}if(69===o.status)if(o.gzhead.extra){for(s=o.pending;o.gzindex<(65535&o.gzhead.extra.length)&&(o.pending!==o.pending_buf_size||(o.gzhead.hcrc&&o.pending>s&&(e.adler=Op(e.adler,o.pending_buf,o.pending-s,s)),Bp(e),s=o.pending,o.pending!==o.pending_buf_size));)$p(o,255&o.gzhead.extra[o.gzindex]),o.gzindex++;o.gzhead.hcrc&&o.pending>s&&(e.adler=Op(e.adler,o.pending_buf,o.pending-s,s)),o.gzindex===o.gzhead.extra.length&&(o.gzindex=0,o.status=73)}else o.status=73;if(73===o.status)if(o.gzhead.name){s=o.pending;do{if(o.pending===o.pending_buf_size&&(o.gzhead.hcrc&&o.pending>s&&(e.adler=Op(e.adler,o.pending_buf,o.pending-s,s)),Bp(e),s=o.pending,o.pending===o.pending_buf_size)){r=1;break}r=o.gzindex<o.gzhead.name.length?255&o.gzhead.name.charCodeAt(o.gzindex++):0,$p(o,r)}while(0!==r);o.gzhead.hcrc&&o.pending>s&&(e.adler=Op(e.adler,o.pending_buf,o.pending-s,s)),0===r&&(o.gzindex=0,o.status=91)}else o.status=91;if(91===o.status)if(o.gzhead.comment){s=o.pending;do{if(o.pending===o.pending_buf_size&&(o.gzhead.hcrc&&o.pending>s&&(e.adler=Op(e.adler,o.pending_buf,o.pending-s,s)),Bp(e),s=o.pending,o.pending===o.pending_buf_size)){r=1;break}r=o.gzindex<o.gzhead.comment.length?255&o.gzhead.comment.charCodeAt(o.gzindex++):0,$p(o,r)}while(0!==r);o.gzhead.hcrc&&o.pending>s&&(e.adler=Op(e.adler,o.pending_buf,o.pending-s,s)),0===r&&(o.status=Fp)}else o.status=Fp;if(o.status===Fp&&(o.gzhead.hcrc?(o.pending+2>o.pending_buf_size&&Bp(e),o.pending+2<=o.pending_buf_size&&($p(o,255&e.adler),$p(o,e.adler>>8&255),e.adler=0,o.status=Hp)):o.status=Hp),0!==o.pending){if(Bp(e),0===e.avail_out)return o.last_flush=-1,0}else if(0===e.avail_in&&jp(t)<=jp(i)&&4!==t)return zp(e,-5);if(o.status===Jp&&0!==e.avail_in)return zp(e,-5);if(0!==e.avail_in||0!==o.lookahead||0!==t&&o.status!==Jp){var a=2===o.strategy?function(e,t){for(var i;;){if(0===e.lookahead&&(i_(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,i=Mp._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(qp(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(qp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(qp(e,!1),0===e.strm.avail_out)?1:2}(o,t):3===o.strategy?function(e,t){for(var i,o,s,r,n=e.window;;){if(e.lookahead<=Kp){if(i_(e),e.lookahead<=Kp&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(o=n[s=e.strstart-1])===n[++s]&&o===n[++s]&&o===n[++s]){r=e.strstart+Kp;do{}while(o===n[++s]&&o===n[++s]&&o===n[++s]&&o===n[++s]&&o===n[++s]&&o===n[++s]&&o===n[++s]&&o===n[++s]&&s<r);e.match_length=Kp-(r-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=Mp._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=Mp._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(qp(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(qp(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(qp(e,!1),0===e.strm.avail_out)?1:2}(o,t):wp[o.level].func(o,t);if(3!==a&&4!==a||(o.status=Jp),1===a||3===a)return 0===e.avail_out&&(o.last_flush=-1),0;if(2===a&&(1===t?Mp._tr_align(o):5!==t&&(Mp._tr_stored_block(o,0,0,!1),3===t&&(Qp(o.head),0===o.lookahead&&(o.strstart=0,o.block_start=0,o.insert=0))),Bp(e),0===e.avail_out))return o.last_flush=-1,0}return 4!==t?0:o.wrap<=0?1:(2===o.wrap?($p(o,255&e.adler),$p(o,e.adler>>8&255),$p(o,e.adler>>16&255),$p(o,e.adler>>24&255),$p(o,255&e.total_in),$p(o,e.total_in>>8&255),$p(o,e.total_in>>16&255),$p(o,e.total_in>>24&255)):(e_(o,e.adler>>>16),e_(o,65535&e.adler)),Bp(e),o.wrap>0&&(o.wrap=-o.wrap),0!==o.pending?0:1)},Jm.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==Fp&&t!==Hp&&t!==Jp?zp(e,Yp):(e.state=null,t===Hp?zp(e,-3):0):Yp},Jm.deflateSetDictionary=function(e,t){var i,o,s,r,n,a,d,c,l=t.length;if(!e||!e.state)return Yp;if(2===(r=(i=e.state).wrap)||1===r&&42!==i.status||i.lookahead)return Yp;for(1===r&&(e.adler=Ap(e.adler,t,l,0)),i.wrap=0,l>=i.w_size&&(0===r&&(Qp(i.head),i.strstart=0,i.block_start=0,i.insert=0),c=new Wp.Buf8(i.w_size),Wp.arraySet(c,t,l-i.w_size,i.w_size,0),t=c,l=i.w_size),n=e.avail_in,a=e.next_in,d=e.input,e.avail_in=l,e.next_in=0,e.input=t,i_(i);i.lookahead>=3;){o=i.strstart,s=i.lookahead-2;do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[o+3-1])&i.hash_mask,i.prev[o&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=o,o++}while(--s);i.strstart=o,i.lookahead=2,i_(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=a,e.input=d,e.avail_in=n,i.wrap=r,0},Jm.deflateInfo="pako deflate (from Nodeca project)";var l_={},u_=Fm,h_=!0,m_=!0;try{String.fromCharCode.apply(null,[0])}catch(qW){h_=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(qW){m_=!1}for(var p_=new u_.Buf8(256),__=0;__<256;__++)p_[__]=__>=252?6:__>=248?5:__>=240?4:__>=224?3:__>=192?2:1;function b_(e,t){if(t<65534&&(e.subarray&&m_||!e.subarray&&h_))return String.fromCharCode.apply(null,u_.shrinkBuf(e,t));for(var i="",o=0;o<t;o++)i+=String.fromCharCode(e[o]);return i}p_[254]=p_[254]=1,l_.string2buf=function(e){var t,i,o,s,r,n=e.length,a=0;for(s=0;s<n;s++)55296==(64512&(i=e.charCodeAt(s)))&&s+1<n&&56320==(64512&(o=e.charCodeAt(s+1)))&&(i=65536+(i-55296<<10)+(o-56320),s++),a+=i<128?1:i<2048?2:i<65536?3:4;for(t=new u_.Buf8(a),r=0,s=0;r<a;s++)55296==(64512&(i=e.charCodeAt(s)))&&s+1<n&&56320==(64512&(o=e.charCodeAt(s+1)))&&(i=65536+(i-55296<<10)+(o-56320),s++),i<128?t[r++]=i:i<2048?(t[r++]=192|i>>>6,t[r++]=128|63&i):i<65536?(t[r++]=224|i>>>12,t[r++]=128|i>>>6&63,t[r++]=128|63&i):(t[r++]=240|i>>>18,t[r++]=128|i>>>12&63,t[r++]=128|i>>>6&63,t[r++]=128|63&i);return t},l_.buf2binstring=function(e){return b_(e,e.length)},l_.binstring2buf=function(e){for(var t=new u_.Buf8(e.length),i=0,o=t.length;i<o;i++)t[i]=e.charCodeAt(i);return t},l_.buf2string=function(e,t){var i,o,s,r,n=t||e.length,a=new Array(2*n);for(o=0,i=0;i<n;)if((s=e[i++])<128)a[o++]=s;else if((r=p_[s])>4)a[o++]=65533,i+=r-1;else{for(s&=2===r?31:3===r?15:7;r>1&&i<n;)s=s<<6|63&e[i++],r--;r>1?a[o++]=65533:s<65536?a[o++]=s:(s-=65536,a[o++]=55296|s>>10&1023,a[o++]=56320|1023&s)}return b_(a,o)},l_.utf8border=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+p_[e[i]]>t?i:t};var v_=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0},S_=Jm,y_=Fm,f_=l_,g_=Gp,T_=v_,I_=Object.prototype.toString;function R_(e){if(!(this instanceof R_))return new R_(e);this.options=y_.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new T_,this.strm.avail_out=0;var i=S_.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(0!==i)throw new Error(g_[i]);if(t.header&&S_.deflateSetHeader(this.strm,t.header),t.dictionary){var o;if(o="string"==typeof t.dictionary?f_.string2buf(t.dictionary):"[object ArrayBuffer]"===I_.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,0!==(i=S_.deflateSetDictionary(this.strm,o)))throw new Error(g_[i]);this._dict_set=!0}}function E_(e,t){var i=new R_(t);if(i.push(e,!0),i.err)throw i.msg||g_[i.err];return i.result}R_.prototype.push=function(e,t){var i,o,s=this.strm,r=this.options.chunkSize;if(this.ended)return!1;o=t===~~t?t:!0===t?4:0,"string"==typeof e?s.input=f_.string2buf(e):"[object ArrayBuffer]"===I_.call(e)?s.input=new Uint8Array(e):s.input=e,s.next_in=0,s.avail_in=s.input.length;do{if(0===s.avail_out&&(s.output=new y_.Buf8(r),s.next_out=0,s.avail_out=r),1!==(i=S_.deflate(s,o))&&0!==i)return this.onEnd(i),this.ended=!0,!1;0!==s.avail_out&&(0!==s.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(f_.buf2binstring(y_.shrinkBuf(s.output,s.next_out))):this.onData(y_.shrinkBuf(s.output,s.next_out)))}while((s.avail_in>0||0===s.avail_out)&&1!==i);return 4===o?(i=S_.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,0===i):2!==o||(this.onEnd(0),s.avail_out=0,!0)},R_.prototype.onData=function(e){this.chunks.push(e)},R_.prototype.onEnd=function(e){0===e&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=y_.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},Hm.Deflate=R_,Hm.deflate=E_,Hm.deflateRaw=function(e,t){return(t=t||{}).raw=!0,E_(e,t)},Hm.gzip=function(e,t){return(t=t||{}).gzip=!0,E_(e,t)};var C_={},Z_=si,L_=k,P_=et,k_=se,N_=function(){var e=Z_(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},X_=RegExp.prototype,V_=se,w_=function(e){var t=e.flags;return void 0!==t||"flags"in X_||P_(e,"flags")||!k_(X_,e)?t:L_(N_,e)},x_=RegExp.prototype,G_=i((function(e){return e===x_||V_(x_,e)?w_(e):e.flags})),W_={},M_=Fm,A_=15,O_=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],D_=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Y_=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],K_=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],U_=Fm,F_=Xp,H_=xp,J_=function(e,t){var i,o,s,r,n,a,d,c,l,u,h,m,p,_,b,v,S,y,f,g,T,I,R,E,C;i=e.state,o=e.next_in,E=e.input,s=o+(e.avail_in-5),r=e.next_out,C=e.output,n=r-(t-e.avail_out),a=r+(e.avail_out-257),d=i.dmax,c=i.wsize,l=i.whave,u=i.wnext,h=i.window,m=i.hold,p=i.bits,_=i.lencode,b=i.distcode,v=(1<<i.lenbits)-1,S=(1<<i.distbits)-1;e:do{p<15&&(m+=E[o++]<<p,p+=8,m+=E[o++]<<p,p+=8),y=_[m&v];t:for(;;){if(m>>>=f=y>>>24,p-=f,0===(f=y>>>16&255))C[r++]=65535&y;else{if(!(16&f)){if(64&f){if(32&f){i.mode=12;break e}e.msg="invalid literal/length code",i.mode=30;break e}y=_[(65535&y)+(m&(1<<f)-1)];continue t}for(g=65535&y,(f&=15)&&(p<f&&(m+=E[o++]<<p,p+=8),g+=m&(1<<f)-1,m>>>=f,p-=f),p<15&&(m+=E[o++]<<p,p+=8,m+=E[o++]<<p,p+=8),y=b[m&S];;){if(m>>>=f=y>>>24,p-=f,16&(f=y>>>16&255)){if(T=65535&y,p<(f&=15)&&(m+=E[o++]<<p,(p+=8)<f&&(m+=E[o++]<<p,p+=8)),(T+=m&(1<<f)-1)>d){e.msg="invalid distance too far back",i.mode=30;break e}if(m>>>=f,p-=f,T>(f=r-n)){if((f=T-f)>l&&i.sane){e.msg="invalid distance too far back",i.mode=30;break e}if(I=0,R=h,0===u){if(I+=c-f,f<g){g-=f;do{C[r++]=h[I++]}while(--f);I=r-T,R=C}}else if(u<f){if(I+=c+u-f,(f-=u)<g){g-=f;do{C[r++]=h[I++]}while(--f);if(I=0,u<g){g-=f=u;do{C[r++]=h[I++]}while(--f);I=r-T,R=C}}}else if(I+=u-f,f<g){g-=f;do{C[r++]=h[I++]}while(--f);I=r-T,R=C}for(;g>2;)C[r++]=R[I++],C[r++]=R[I++],C[r++]=R[I++],g-=3;g&&(C[r++]=R[I++],g>1&&(C[r++]=R[I++]))}else{I=r-T;do{C[r++]=C[I++],C[r++]=C[I++],C[r++]=C[I++],g-=3}while(g>2);g&&(C[r++]=C[I++],g>1&&(C[r++]=C[I++]))}break}if(64&f){e.msg="invalid distance code",i.mode=30;break e}y=b[(65535&y)+(m&(1<<f)-1)]}}break}}while(o<s&&r<a);o-=g=p>>3,m&=(1<<(p-=g<<3))-1,e.next_in=o,e.next_out=r,e.avail_in=o<s?s-o+5:5-(o-s),e.avail_out=r<a?a-r+257:257-(r-a),i.hold=m,i.bits=p},z_=function(e,t,i,o,s,r,n,a){var d,c,l,u,h,m,p,_,b,v=a.bits,S=0,y=0,f=0,g=0,T=0,I=0,R=0,E=0,C=0,Z=0,L=null,P=0,k=new M_.Buf16(16),N=new M_.Buf16(16),X=null,V=0;for(S=0;S<=A_;S++)k[S]=0;for(y=0;y<o;y++)k[t[i+y]]++;for(T=v,g=A_;g>=1&&0===k[g];g--);if(T>g&&(T=g),0===g)return s[r++]=20971520,s[r++]=20971520,a.bits=1,0;for(f=1;f<g&&0===k[f];f++);for(T<f&&(T=f),E=1,S=1;S<=A_;S++)if(E<<=1,(E-=k[S])<0)return-1;if(E>0&&(0===e||1!==g))return-1;for(N[1]=0,S=1;S<A_;S++)N[S+1]=N[S]+k[S];for(y=0;y<o;y++)0!==t[i+y]&&(n[N[t[i+y]]++]=y);if(0===e?(L=X=n,m=19):1===e?(L=O_,P-=257,X=D_,V-=257,m=256):(L=Y_,X=K_,m=-1),Z=0,y=0,S=f,h=r,I=T,R=0,l=-1,u=(C=1<<T)-1,1===e&&C>852||2===e&&C>592)return 1;for(;;){p=S-R,n[y]<m?(_=0,b=n[y]):n[y]>m?(_=X[V+n[y]],b=L[P+n[y]]):(_=96,b=0),d=1<<S-R,f=c=1<<I;do{s[h+(Z>>R)+(c-=d)]=p<<24|_<<16|b}while(0!==c);for(d=1<<S-1;Z&d;)d>>=1;if(0!==d?(Z&=d-1,Z+=d):Z=0,y++,0==--k[S]){if(S===g)break;S=t[i+n[y]]}if(S>T&&(Z&u)!==l){for(0===R&&(R=T),h+=f,E=1<<(I=S-R);I+R<g&&!((E-=k[I+R])<=0);)I++,E<<=1;if(C+=1<<I,1===e&&C>852||2===e&&C>592)return 1;s[l=Z&u]=T<<24|I<<16|h-r}}return 0!==Z&&(s[h+Z]=S-R<<24|64<<16),a.bits=T,0},j_=-2,Q_=12,B_=30;function q_(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function $_(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new U_.Buf16(320),this.work=new U_.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function eb(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new U_.Buf32(852),t.distcode=t.distdyn=new U_.Buf32(592),t.sane=1,t.back=-1,0):j_}function tb(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,eb(e)):j_}function ib(e,t){var i,o;return e&&e.state?(o=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?j_:(null!==o.window&&o.wbits!==t&&(o.window=null),o.wrap=i,o.wbits=t,tb(e))):j_}function ob(e,t){var i,o;return e?(o=new $_,e.state=o,o.window=null,0!==(i=ib(e,t))&&(e.state=null),i):j_}var sb,rb,nb=!0;function ab(e){if(nb){var t;for(sb=new U_.Buf32(512),rb=new U_.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(z_(1,e.lens,0,288,sb,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;z_(2,e.lens,0,32,rb,0,e.work,{bits:5}),nb=!1}e.lencode=sb,e.lenbits=9,e.distcode=rb,e.distbits=5}function db(e,t,i,o){var s,r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new U_.Buf8(r.wsize)),o>=r.wsize?(U_.arraySet(r.window,t,i-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):((s=r.wsize-r.wnext)>o&&(s=o),U_.arraySet(r.window,t,i-o,s,r.wnext),(o-=s)?(U_.arraySet(r.window,t,i-o,o,0),r.wnext=o,r.whave=r.wsize):(r.wnext+=s,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=s))),0}W_.inflateReset=tb,W_.inflateReset2=ib,W_.inflateResetKeep=eb,W_.inflateInit=function(e){return ob(e,15)},W_.inflateInit2=ob,W_.inflate=function(e,t){var i,o,s,r,n,a,d,c,l,u,h,m,p,_,b,v,S,y,f,g,T,I,R,E,C=0,Z=new U_.Buf8(4),L=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return j_;(i=e.state).mode===Q_&&(i.mode=13),n=e.next_out,s=e.output,d=e.avail_out,r=e.next_in,o=e.input,a=e.avail_in,c=i.hold,l=i.bits,u=a,h=d,I=0;e:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;l<16;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(2&i.wrap&&35615===c){i.check=0,Z[0]=255&c,Z[1]=c>>>8&255,i.check=H_(i.check,Z,2,0),c=0,l=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&c)<<8)+(c>>8))%31){e.msg="incorrect header check",i.mode=B_;break}if(8!=(15&c)){e.msg="unknown compression method",i.mode=B_;break}if(l-=4,T=8+(15&(c>>>=4)),0===i.wbits)i.wbits=T;else if(T>i.wbits){e.msg="invalid window size",i.mode=B_;break}i.dmax=1<<T,e.adler=i.check=1,i.mode=512&c?10:Q_,c=0,l=0;break;case 2:for(;l<16;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(i.flags=c,8!=(255&G_(i))){e.msg="unknown compression method",i.mode=B_;break}if(57344&G_(i)){e.msg="unknown header flags set",i.mode=B_;break}i.head&&(i.head.text=c>>8&1),512&G_(i)&&(Z[0]=255&c,Z[1]=c>>>8&255,i.check=H_(i.check,Z,2,0)),c=0,l=0,i.mode=3;case 3:for(;l<32;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}i.head&&(i.head.time=c),512&G_(i)&&(Z[0]=255&c,Z[1]=c>>>8&255,Z[2]=c>>>16&255,Z[3]=c>>>24&255,i.check=H_(i.check,Z,4,0)),c=0,l=0,i.mode=4;case 4:for(;l<16;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}i.head&&(i.head.xflags=255&c,i.head.os=c>>8),512&G_(i)&&(Z[0]=255&c,Z[1]=c>>>8&255,i.check=H_(i.check,Z,2,0)),c=0,l=0,i.mode=5;case 5:if(1024&G_(i)){for(;l<16;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}i.length=c,i.head&&(i.head.extra_len=c),512&G_(i)&&(Z[0]=255&c,Z[1]=c>>>8&255,i.check=H_(i.check,Z,2,0)),c=0,l=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&G_(i)&&((m=i.length)>a&&(m=a),m&&(i.head&&(T=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),U_.arraySet(i.head.extra,o,r,m,T)),512&G_(i)&&(i.check=H_(i.check,o,m,r)),a-=m,r+=m,i.length-=m),i.length))break e;i.length=0,i.mode=7;case 7:if(2048&G_(i)){if(0===a)break e;m=0;do{T=o[r+m++],i.head&&T&&i.length<65536&&(i.head.name+=String.fromCharCode(T))}while(T&&m<a);if(512&G_(i)&&(i.check=H_(i.check,o,m,r)),a-=m,r+=m,T)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&G_(i)){if(0===a)break e;m=0;do{T=o[r+m++],i.head&&T&&i.length<65536&&(i.head.comment+=String.fromCharCode(T))}while(T&&m<a);if(512&G_(i)&&(i.check=H_(i.check,o,m,r)),a-=m,r+=m,T)break e}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&G_(i)){for(;l<16;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(c!==(65535&i.check)){e.msg="header crc mismatch",i.mode=B_;break}c=0,l=0}i.head&&(i.head.hcrc=G_(i)>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=Q_;break;case 10:for(;l<32;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}e.adler=i.check=q_(c),c=0,l=0,i.mode=11;case 11:if(0===i.havedict)return e.next_out=n,e.avail_out=d,e.next_in=r,e.avail_in=a,i.hold=c,i.bits=l,2;e.adler=i.check=1,i.mode=Q_;case Q_:if(5===t||6===t)break e;case 13:if(i.last){c>>>=7&l,l-=7&l,i.mode=27;break}for(;l<3;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}switch(i.last=1&c,l-=1,3&(c>>>=1)){case 0:i.mode=14;break;case 1:if(ab(i),i.mode=20,6===t){c>>>=2,l-=2;break e}break;case 2:i.mode=17;break;case 3:e.msg="invalid block type",i.mode=B_}c>>>=2,l-=2;break;case 14:for(c>>>=7&l,l-=7&l;l<32;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if((65535&c)!=(c>>>16^65535)){e.msg="invalid stored block lengths",i.mode=B_;break}if(i.length=65535&c,c=0,l=0,i.mode=15,6===t)break e;case 15:i.mode=16;case 16:if(m=i.length){if(m>a&&(m=a),m>d&&(m=d),0===m)break e;U_.arraySet(s,o,r,m,n),a-=m,r+=m,d-=m,n+=m,i.length-=m;break}i.mode=Q_;break;case 17:for(;l<14;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(i.nlen=257+(31&c),c>>>=5,l-=5,i.ndist=1+(31&c),c>>>=5,l-=5,i.ncode=4+(15&c),c>>>=4,l-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=B_;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;l<3;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}i.lens[L[i.have++]]=7&c,c>>>=3,l-=3}for(;i.have<19;)i.lens[L[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,R={bits:i.lenbits},I=z_(0,i.lens,0,19,i.lencode,0,i.work,R),i.lenbits=R.bits,I){e.msg="invalid code lengths set",i.mode=B_;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;v=(C=i.lencode[c&(1<<i.lenbits)-1])>>>16&255,S=65535&C,!((b=C>>>24)<=l);){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(S<16)c>>>=b,l-=b,i.lens[i.have++]=S;else{if(16===S){for(E=b+2;l<E;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(c>>>=b,l-=b,0===i.have){e.msg="invalid bit length repeat",i.mode=B_;break}T=i.lens[i.have-1],m=3+(3&c),c>>>=2,l-=2}else if(17===S){for(E=b+3;l<E;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}l-=b,T=0,m=3+(7&(c>>>=b)),c>>>=3,l-=3}else{for(E=b+7;l<E;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}l-=b,T=0,m=11+(127&(c>>>=b)),c>>>=7,l-=7}if(i.have+m>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=B_;break}for(;m--;)i.lens[i.have++]=T}}if(i.mode===B_)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=B_;break}if(i.lenbits=9,R={bits:i.lenbits},I=z_(1,i.lens,0,i.nlen,i.lencode,0,i.work,R),i.lenbits=R.bits,I){e.msg="invalid literal/lengths set",i.mode=B_;break}if(i.distbits=6,i.distcode=i.distdyn,R={bits:i.distbits},I=z_(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,R),i.distbits=R.bits,I){e.msg="invalid distances set",i.mode=B_;break}if(i.mode=20,6===t)break e;case 20:i.mode=21;case 21:if(a>=6&&d>=258){e.next_out=n,e.avail_out=d,e.next_in=r,e.avail_in=a,i.hold=c,i.bits=l,J_(e,h),n=e.next_out,s=e.output,d=e.avail_out,r=e.next_in,o=e.input,a=e.avail_in,c=i.hold,l=i.bits,i.mode===Q_&&(i.back=-1);break}for(i.back=0;v=(C=i.lencode[c&(1<<i.lenbits)-1])>>>16&255,S=65535&C,!((b=C>>>24)<=l);){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(v&&!(240&v)){for(y=b,f=v,g=S;v=(C=i.lencode[g+((c&(1<<y+f)-1)>>y)])>>>16&255,S=65535&C,!(y+(b=C>>>24)<=l);){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}c>>>=y,l-=y,i.back+=y}if(c>>>=b,l-=b,i.back+=b,i.length=S,0===v){i.mode=26;break}if(32&v){i.back=-1,i.mode=Q_;break}if(64&v){e.msg="invalid literal/length code",i.mode=B_;break}i.extra=15&v,i.mode=22;case 22:if(i.extra){for(E=i.extra;l<E;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}i.length+=c&(1<<i.extra)-1,c>>>=i.extra,l-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;v=(C=i.distcode[c&(1<<i.distbits)-1])>>>16&255,S=65535&C,!((b=C>>>24)<=l);){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(!(240&v)){for(y=b,f=v,g=S;v=(C=i.distcode[g+((c&(1<<y+f)-1)>>y)])>>>16&255,S=65535&C,!(y+(b=C>>>24)<=l);){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}c>>>=y,l-=y,i.back+=y}if(c>>>=b,l-=b,i.back+=b,64&v){e.msg="invalid distance code",i.mode=B_;break}i.offset=S,i.extra=15&v,i.mode=24;case 24:if(i.extra){for(E=i.extra;l<E;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}i.offset+=c&(1<<i.extra)-1,c>>>=i.extra,l-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=B_;break}i.mode=25;case 25:if(0===d)break e;if(m=h-d,i.offset>m){if((m=i.offset-m)>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=B_;break}m>i.wnext?(m-=i.wnext,p=i.wsize-m):p=i.wnext-m,m>i.length&&(m=i.length),_=i.window}else _=s,p=n-i.offset,m=i.length;m>d&&(m=d),d-=m,i.length-=m;do{s[n++]=_[p++]}while(--m);0===i.length&&(i.mode=21);break;case 26:if(0===d)break e;s[n++]=i.length,d--,i.mode=21;break;case 27:if(i.wrap){for(;l<32;){if(0===a)break e;a--,c|=o[r++]<<l,l+=8}if(h-=d,e.total_out+=h,i.total+=h,h&&(e.adler=i.check=G_(i)?H_(i.check,s,h,n-h):F_(i.check,s,h,n-h)),h=d,(G_(i)?c:q_(c))!==i.check){e.msg="incorrect data check",i.mode=B_;break}c=0,l=0}i.mode=28;case 28:if(i.wrap&&G_(i)){for(;l<32;){if(0===a)break e;a--,c+=o[r++]<<l,l+=8}if(c!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=B_;break}c=0,l=0}i.mode=29;case 29:I=1;break e;case B_:I=-3;break e;case 31:return-4;default:return j_}return e.next_out=n,e.avail_out=d,e.next_in=r,e.avail_in=a,i.hold=c,i.bits=l,(i.wsize||h!==e.avail_out&&i.mode<B_&&(i.mode<27||4!==t))&&db(e,e.output,e.next_out,h-e.avail_out),u-=e.avail_in,h-=e.avail_out,e.total_in+=u,e.total_out+=h,i.total+=h,i.wrap&&h&&(e.adler=i.check=G_(i)?H_(i.check,s,h,e.next_out-h):F_(i.check,s,h,e.next_out-h)),e.data_type=i.bits+(i.last?64:0)+(i.mode===Q_?128:0)+(20===i.mode||15===i.mode?256:0),(0===u&&0===h||4===t)&&0===I&&(I=-5),I},W_.inflateEnd=function(e){if(!e||!e.state)return j_;var t=e.state;return t.window&&(t.window=null),e.state=null,0},W_.inflateGetHeader=function(e,t){var i;return e&&e.state&&2&(i=e.state).wrap?(i.head=t,t.done=!1,0):j_},W_.inflateSetDictionary=function(e,t){var i,o=t.length;return e&&e.state?0!==(i=e.state).wrap&&11!==i.mode?j_:11===i.mode&&F_(1,t,o,0)!==i.check?-3:db(e,t,o,o)?(i.mode=31,-4):(i.havedict=1,0):j_},W_.inflateInfo="pako inflate (from Nodeca project)";var cb={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};var lb=W_,ub=Fm,hb=l_,mb=cb,pb=Gp,_b=v_,bb=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1},vb=Object.prototype.toString;function Sb(e){if(!(this instanceof Sb))return new Sb(e);this.options=ub.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(15&t.windowBits||(t.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new _b,this.strm.avail_out=0;var i=lb.inflateInit2(this.strm,t.windowBits);if(i!==mb.Z_OK)throw new Error(pb[i]);if(this.header=new bb,lb.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=hb.string2buf(t.dictionary):"[object ArrayBuffer]"===vb.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=lb.inflateSetDictionary(this.strm,t.dictionary))!==mb.Z_OK))throw new Error(pb[i])}function yb(e,t){var i=new Sb(t);if(i.push(e,!0),i.err)throw i.msg||pb[i.err];return i.result}Sb.prototype.push=function(e,t){var i,o,s,r,n,a=this.strm,d=this.options.chunkSize,c=this.options.dictionary,l=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?mb.Z_FINISH:mb.Z_NO_FLUSH,"string"==typeof e?a.input=hb.binstring2buf(e):"[object ArrayBuffer]"===vb.call(e)?a.input=new Uint8Array(e):a.input=e,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new ub.Buf8(d),a.next_out=0,a.avail_out=d),(i=lb.inflate(a,mb.Z_NO_FLUSH))===mb.Z_NEED_DICT&&c&&(i=lb.inflateSetDictionary(this.strm,c)),i===mb.Z_BUF_ERROR&&!0===l&&(i=mb.Z_OK,l=!1),i!==mb.Z_STREAM_END&&i!==mb.Z_OK)return this.onEnd(i),this.ended=!0,!1;a.next_out&&(0!==a.avail_out&&i!==mb.Z_STREAM_END&&(0!==a.avail_in||o!==mb.Z_FINISH&&o!==mb.Z_SYNC_FLUSH)||("string"===this.options.to?(s=hb.utf8border(a.output,a.next_out),r=a.next_out-s,n=hb.buf2string(a.output,s),a.next_out=r,a.avail_out=d-r,r&&ub.arraySet(a.output,a.output,s,r,0),this.onData(n)):this.onData(ub.shrinkBuf(a.output,a.next_out)))),0===a.avail_in&&0===a.avail_out&&(l=!0)}while((a.avail_in>0||0===a.avail_out)&&i!==mb.Z_STREAM_END);return i===mb.Z_STREAM_END&&(o=mb.Z_FINISH),o===mb.Z_FINISH?(i=lb.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===mb.Z_OK):o!==mb.Z_SYNC_FLUSH||(this.onEnd(mb.Z_OK),a.avail_out=0,!0)},Sb.prototype.onData=function(e){this.chunks.push(e)},Sb.prototype.onEnd=function(e){e===mb.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=ub.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},C_.Inflate=Sb,C_.inflate=yb,C_.inflateRaw=function(e,t){return(t=t||{}).raw=!0,yb(e,t)},C_.ungzip=yb;var fb={};(0,Fm.assign)(fb,Hm,C_,cb);var gb=i(fb);let Tb=1;const Ib="VERTC",Rb=()=>window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;class Eb{constructor(e){Ou(this,"storeName",void 0),Ou(this,"pendingList",[]),this.storeName=e,!bm()&&Rb()&&this._checkAndCreateStore(e)}async _checkAndCreateStore(e,t){const i=await Eb._promiseLock.lock();if(Rb().databases){let e;await new Promise((t=>{const i=()=>Rb().databases().finally(t);e=setInterval(i,100),i()})).finally((()=>clearInterval(e)))}return new Promise((o=>{Eb.db&&(Eb.db.close(),delete Eb.db);const s=t?Rb().open(Ib,t):Rb().open(Ib);s.onupgradeneeded=()=>{s.result.createObjectStore(e)},s.onerror=()=>{console.error("IndexedDBInterface error",s.error)},s.onsuccess=()=>{const t=s.result;Eb.db=t;try{Eb.db.transaction(this.storeName,"readonly"),this.pendingList.forEach((async e=>{let{txMode:t,pendResolve:i,pendReject:o}=e;try{i(await this._getStore(t))}catch(s){o()}})),o()}catch(r){o(this._checkAndCreateStore(e,t.version+1))}finally{i()}}}))}async _getStore(e){const t=await Eb._promiseLock.lock();return new Promise(((i,o)=>{if(!Eb.db)return this.pendingList.push({txMode:e,pendResolve:i,pendReject:o}),void t();try{i(Eb.db.transaction(this.storeName,e).objectStore(this.storeName))}catch(s){return void this.pendingList.push({txMode:e,pendResolve:i,pendReject:o})}finally{t()}}))}async put2String(e,t){let i;try{i=JSON.stringify(e)}catch(o){i=e}return await this.put(i,t)}async get4String(e){const t=await this.get(e);let i;try{i=JSON.parse(t)}catch(o){i=t}return i}async put(e,t){const i=await this._getStore("readwrite");return new Promise(((o,s)=>{const r=i.put(e,t);r.onsuccess=()=>{o()},r.onerror=e=>{s(e)}}))}async get(e){const t=await this._getStore("readonly");return new Promise(((i,o)=>{const s=t.get(e);s.onsuccess=()=>{i(s.result)},s.onerror=e=>{o(e)}}))}async del(e){const t=await this._getStore("readwrite");return new Promise(((i,o)=>{const s=t.delete(e);s.onsuccess=()=>{i()},s.onerror=e=>{o(e)}}))}}Ou(Eb,"db",void 0),Ou(Eb,"state","init"),Ou(Eb,"_promiseLock",new class{constructor(e){Ou(this,"lockingPromise",Promise.resolve()),Ou(this,"locks",0),Ou(this,"name",""),Ou(this,"lockId",void 0),this.lockId=Tb++,e&&(this.name=e)}get isLocked(){return this.locks>0}lock(){let e;this.locks+=1;const t=new Promise((t=>{e=()=>{this.locks-=1,t()}})),i=this.lockingPromise.then((()=>e));return this.lockingPromise=this.lockingPromise.then((()=>t)),i}}("iDB"));var Cb=Ji.includes;ki({target:"Array",proto:!0,forced:r((function(){return!Array(1).includes()}))},{includes:function(e){return Cb(this,e,arguments.length>1?arguments[1]:void 0)}});var Zb=Oa("Array","includes"),Lb=B,Pb=f,kb=pt("match"),Nb=function(e){var t;return Lb(e)&&(void 0!==(t=e[kb])?!!t:"RegExp"===Pb(e))},Xb=TypeError,Vb=pt("match"),wb=ki,xb=function(e){if(Nb(e))throw new Xb("The method doesn't accept regular expressions");return e},Gb=H,Wb=fo,Mb=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[Vb]=!1,"/./"[e](t)}catch(o){}}return!1},Ab=b("".indexOf);wb({target:"String",proto:!0,forced:!Mb("includes")},{includes:function(e){return!!~Ab(Wb(Gb(this)),Wb(xb(e)),arguments.length>1?arguments[1]:void 0)}});var Ob=Oa("String","includes"),Db=se,Yb=Zb,Kb=Ob,Ub=Array.prototype,Fb=String.prototype,Hb=i((function(e){var t=e.includes;return e===Ub||Db(Ub,e)&&t===Ub.includes?Yb:"string"==typeof e||e===Fb||Db(Fb,e)&&t===Fb.includes?Kb:t}));function Jb(e,t){if(null==e)return{};var i,o,s=function(e,t){if(null==e)return{};var i={};for(var o in e)if({}.hasOwnProperty.call(e,o)){if(Hb(t).call(t,o))continue;i[o]=e[o]}return i}(e,t);if(Xa){var r=Xa(e);for(o=0;o<r.length;o++)i=r[o],Hb(t).call(t,i)||{}.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}const zb=["message"];var jb,Qb,Bb=new class{constructor(){Ou(this,"name","LongStringReportor"),Ou(this,"inBuffer",[]),Ou(this,"outBuffer",[])}push(e){e.message&&this.inBuffer.push(Yu(Yu({},e),{},{message:{id:vm().slice(0,3),index:0,end:!0,msg:e.message}}))}splice(e){const t=[];let i=0;for(;this.outBuffer.length;){const o=JSON.stringify(this.outBuffer[0]).length;if(!(o<e))break;e-=o,i+=o,t.push(this.outBuffer.shift())}for(;this.inBuffer[0]&&e>0;){const o=this.inBuffer[0],{message:s}=o,r=Yu(Yu({},Jb(o,zb)),{},{message:Yu(Yu({},s),{},{msg:""})}),n=JSON.stringify(r).length,a=e-n,d=Yu({},r);if(a>s.msg.length)d.message.msg=s.msg,this.inBuffer.shift();else{if(!(a>=10))break;{const e=s.msg.slice(0,a);d.message.msg=e,d.message.end=!1,this.inBuffer[0].message.msg=s.msg.slice(a),this.inBuffer[0].message.index++}}const c=JSON.stringify(d.message),l=c.length;e-=l+n,i+=l+n,t.push(Yu(Yu({},d),{},{message:c}))}return{payload:t,payloadSize:i}}unshift(e){this.outBuffer=e.concat(this.outBuffer)}get(){return[...this.outBuffer,...this.inBuffer.map((e=>Yu(Yu({},e),{},{message:JSON.stringify(e.message)})))]}set(e){e.forEach((e=>{!function(e){return void 0!==e.report_id}(e)?(e.message||(e.message=""),this.inBuffer.push(Yu(Yu({},e),{},{message:JSON.parse(e.message)}))):this.outBuffer.push(e)})),this.outBuffer=[].concat(this.outBuffer),this.inBuffer=[].concat(this.inBuffer)}isEmpty(){return 0===this.inBuffer.length&&0===this.outBuffer.length}};const qb=5e5,$b={product_line:"rtc",report_version:"5",os:"web",user_agent:bm()?"":null===(jb=navigator)||void 0===jb?void 0:jb.userAgent,platform:"web",product:"webrtc",app_state:"active"},ev="LogReportor",tv="undefined"!=typeof window&&(window.location.search.includes("_rtc_debug_")||(null===(Qb=window.localStorage)||void 0===Qb?void 0:Qb.getItem("_rtc_debug_")));class iv{constructor(e){Ou(this,"_buffer",void 0),this._buffer=new Eb(e)}async set(e,t){await this._buffer.put2String(e,t)}async get(e){var t;let i=[];try{i=await this._buffer.get4String(e)}catch(o){}return null!==(t=i)&&void 0!==t?t:[]}}var ov=new class{constructor(){Ou(this,"reportCommon",$b),Ou(this,"reportIds",new Map),Ou(this,"dataBuffer",[]),Ou(this,"reportorList",[]),Ou(this,"dbBuffer",void 0),Ou(this,"posting",!1),Ou(this,"sucSendTimer",void 0),Ou(this,"preSucTime",0),Ou(this,"errSendTimer",void 0),Ou(this,"errSendDelay",100),Ou(this,"_logServerUrl",void 0),Ou(this,"_retryCount",0),Ou(this,"_reportLimit",qb),Ou(this,"_disableTimeout",!1),bm()||(window.addEventListener("beforeunload",(()=>{clearTimeout(this.errSendTimer),clearTimeout(this.sucSendTimer),this.send(void 0,!0)})),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?this.setCommonStats({app_state:"active"}):"hidden"===document.visibilityState&&this.setCommonStats({app_state:"background"})})),tv&&(window.__rtc_debug_reportor__=this)),Pm.on("UPLOAD_REPORT_LIMIT",(e=>{this.setReportLimit(e)})),Pm.on("ENABLE_REPORT_IDB_BUFFER",(e=>{e&&this.enableIndexedDBBuffer()})),setTimeout((()=>{this.reportorList.push(Kv),this.reportorList.push(Bb)}))}setUrl(e){this._logServerUrl=e}setCommonStats(e){this.reportCommon=Object.assign(this.reportCommon,e)}getCommonStats(){return this.reportCommon}setReportLimit(e){this._reportLimit=Math.max(e,5e4),this._reportLimit=Math.min(e,5e5)}getReportId(e){var t;e=null!==(t=e)&&void 0!==t?t:"__global__",this.reportIds.has(e)||this.reportIds.set(e,0);let i=this.reportIds.get(e);return void 0===i&&(Lv("no reportId in reportId map with engine-session-id ".concat(e),0,{}),i=0),this.reportIds.set(e,i+1),i}push(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1])this.send(e);else{var t;const i=null!==(t=e.engine_session_id)&&void 0!==t?t:"__global__";this.reportIds.has(i)||this.reportIds.set(i,0),this.dataBuffer.push(e),!this.posting&&!this.errSendTimer&&Date.now()-this.preSucTime>2e3&&(clearTimeout(this.sucSendTimer),this.send())}}enableIndexedDBBuffer(){this.dbBuffer||(this.dbBuffer=new iv("ReportorDBBuffer"),this.dbBuffer.get(ev).then((e=>{e.forEach((e=>{this.push(e)}))})),this.reportorList.forEach((e=>{var t;null===(t=this.dbBuffer)||void 0===t||t.get(e.name).then((t=>{e.set(t)}))})))}backup(){try{var e;null===(e=this.dbBuffer)||void 0===e||e.set([...this.dataBuffer],ev),this.reportorList.forEach((e=>{var t;null===(t=this.dbBuffer)||void 0===t||t.set([...e.get()],e.name)}))}catch(t){Lv("Error when save log into IDB",-1,t)}}unshift(e){this.dataBuffer=e[0].concat(this.dataBuffer),this.reportorList.forEach(((t,i)=>{var o;t.unshift(null!==(o=e[i+1])&&void 0!==o?o:[])}))}_splice(){let e=function(e,t){let i=0;for(let o=0;o<e.length;o++)if(i+=JSON.stringify(e[o]).length,i>t)return o;return e.length}(this.dataBuffer,this._reportLimit);0===e&&this.dataBuffer.length>0&&(this._reportLimit=JSON.stringify(this.dataBuffer[0]).length+10,e=1,Lv("update report limit to ".concat(this._reportLimit),0,null));const t=this.dataBuffer.splice(0,e),i=JSON.stringify(t).length,o=[t];let s=this._reportLimit-i;return this.reportorList.forEach((e=>{const{payload:t,payloadSize:i}=e.splice(s);t.forEach((e=>{var t,i,o;void 0===e.report_id&&(e.report_id=this.getReportId(e.engine_session_id),!bm()&&window.__onRTCReport&&(null===(t=(i=window).__onRTCReport)||void 0===t||t.call(i,null!==(o=e.engine_session_id)&&void 0!==o?o:"global",e,this.getCommonStats())))})),o.push(t),s-=i})),o}async send(e,t){this.backup();const i=this.reportorList.reduce(((e,t)=>e&&t.isEmpty()),!0);if(!e&&!this.dataBuffer.length&&i||!this._logServerUrl)return;e||(this.posting=!0);let o=[];e||(o=this._splice());const s=tv,r={data:e||Um(o).call(o),header:Yu(Yu({},this.reportCommon),{},{http_retry_count:this._retryCount}),from:"web",os:"web",version:"1"},n={method:"POST",body:s?JSON.stringify(r):gb.gzip(JSON.stringify(r))};if(!this._disableTimeout)try{const e=new AbortController;n.signal=e.signal,setTimeout((()=>{e.abort()}),1e4)}catch(l){console.warn("AbortController is not supported"),this._disableTimeout=!0}s||(n.headers={"Content-Encoding":"gzip","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"});let a,d,c=null;try{a=await fetch(this._logServerUrl,n),200!==a.status&&304!==a.status||(c=JSON.parse(await a.text()))}catch(u){d=u}e||(this.posting=!1),c&&0===c.StatusCode?e||t||this.sucSend():(setTimeout((()=>{var e,t,i;Lv("reportor post error, resJSON:".concat(null===(e=c)||void 0===e?void 0:e.toString()," err:").concat(d),null!==(t=null===(i=a)||void 0===i?void 0:i.status)&&void 0!==t?t:-1,d)}),0),e?this.send(e):(this.unshift(o),t?this.send():this.errSend()))}_getDataBufferTotalSize(){return this.dataBuffer.reduce(((e,t)=>e+JSON.stringify(t).length),0)}sucSend(){this.errSendDelay=100,this._retryCount=0,this.preSucTime=Date.now();const e=this._getDataBufferTotalSize()>1e6?1e3:2e3;this.sucSendTimer=setTimeout((()=>this.send()),e)}errSend(){this.errSendTimer=setTimeout((()=>{this.send(),delete this.errSendTimer}),this.errSendDelay),this.errSendDelay*=2,this._retryCount++}};class sv{constructor(e){Ou(this,"modifyIds",{pre_connection:!1}),this.id=e}report(e,t,i){const o=Yu(Yu(Yu({event_key:e,rtc_timestamp:Date.now()},this.modifyIds),t),{},{report_id:ov.getReportId(this.modifyIds.engine_session_id)});var s,r;("object"==typeof i&&Object.keys(i).length>0&&(o.common_extra_info=JSON.stringify(i)),Object.keys(o).forEach((e=>{void 0!==o[e]&&""!==o[e]||delete o[e]})),!bm()&&window.__onRTCReport)&&(null===(s=(r=window).__onRTCReport)||void 0===s||s.call(r,this.modifyIds.engine_session_id,o,ov.getCommonStats()));"UT"!=={}.VITE_TEST&&ov.push(o)}reportLog(e){const t=Yu(Yu({event_key:"rtc_invoke_status",sdk_api_name:"console_log",rtc_timestamp:Date.now()},this.modifyIds),{},{message:e});Kv.push(t)}reportLongString(e,t){const i=Yu(Yu({event_key:"rtc_invoke_status",sdk_api_name:"sdk_long_string_".concat(e),rtc_timestamp:Date.now()},this.modifyIds),{},{message:t});Bb.push(i)}set(e){this.modifyIds=Object.assign(this.modifyIds,e)}destroy(){}}class rv{constructor(e){Ou(this,"_preTime",Date.now()),Ou(this,"_one2oneNum",0),Ou(this,"_one2manyNum",0),Ou(this,"_one2oneMsgCache",new Map),Ou(this,"_one2manyMsgCache",new Map),Ou(this,"roomId",""),Ou(this,"userId",""),Ou(this,"rtsSessionId",""),Ou(this,"logger",void 0),Ou(this,"serverUrl","server"),this.id=e,this.logger=new eS("MessageReportor",1)}needReport(e){return!!rv.config&&(Date.now()-this._preTime>=36e5&&(this._preTime=Date.now(),this._one2oneNum=0,this._one2manyNum=0),"one2one"===e&&this._one2oneNum<rv.config.max_one2one_fpt_per_hour&&Math.random()<=rv.config.one2one_fpt_ratio/100||"one2many"===e&&this._one2manyNum<rv.config.max_one2many_fpt_per_hour&&Math.random()<=rv.config.one2many_fpt_ratio/100)}cacheP2PMsg(e){var t;this._one2oneMsgCache.set(e.msg_id,Yu({config_version:(null===(t=rv.config)||void 0===t?void 0:t.version)||""},e))}updateP2PMsg(e,t){const i=this._one2oneMsgCache.get(e);i&&this._one2oneMsgCache.set(e,Yu(Yu({},i),t))}cacheCustomMsg(e){var t;this._one2manyMsgCache.set(e.msg_id,Yu({config_version:(null===(t=rv.config)||void 0===t?void 0:t.version)||""},e))}updateOne2ManyMsg(e,t){const i=this._one2manyMsgCache.get(e);i&&this._one2manyMsgCache.set(e,Yu(Yu({},i),t))}reportP2PMsg(e){const t=this._one2oneMsgCache.get(e);var i;t&&(this.logger.info("reportP2PMsg",t.type,JSON.stringify(t)),null===(i=Nv(this.id))||void 0===i||i.report("rts_message",t))}reportOne2ManyMsg(e){const t=this._one2manyMsgCache.get(e);var i;t&&(this.logger.info("reportOne2ManyMsg",t.type,JSON.stringify(t)),null===(i=Nv(this.id))||void 0===i||i.report("rts_message",t))}reportMsgRecv(e){var t,i;e.config_version=(null===(t=rv.config)||void 0===t?void 0:t.version)||"",this.logger.info("reportMsgRecv",e.type,JSON.stringify(e)),null===(i=Nv(this.id))||void 0===i||i.report("rts_message",e)}destroy(){this._one2manyNum=0,this._one2oneNum=0,this._one2manyMsgCache.clear(),this._one2oneMsgCache.clear(),this._preTime=Date.now(),this.roomId="",this.userId="",this.rtsSessionId=""}}Ou(rv,"config",void 0);const nv=new Map,av=(e,t)=>{const i=nv.get(e);i&&(i.serverUrl=t)},dv=e=>{new eS("MessageReportor",1).info("setConfig","get config: ".concat(JSON.stringify(e))),rv.config=e},cv=(e,t)=>{const i=nv.get(e);i&&(i.rtsSessionId=t)},lv=e=>{const t=nv.get(e)||new rv(e);return nv.set(e,t),t},uv=e=>{const t=nv.get(e);t&&(t.destroy(),nv.delete(e))},hv=(e,t)=>{const i=nv.get(e);i&&(i.roomId=t||"")},mv=(e,t)=>{const i=nv.get(e);i&&(i.userId=t||"")},pv=(e,t)=>{const i=nv.get(e);if(null!=i&&i.needReport("one2one")){const e=t.to?"one2one":"one2server";t.enable_report=!0,t.report_msg_id=t.id,i.cacheP2PMsg({rts_session_id:i.rtsSessionId,msg_id:"".concat(t.id),node_role:"src_sdk",from:t.from,to:t.to||i.serverUrl,msg_type:e,type:e,rts_room_id:t.room,req_ts:Date.now(),send_ts:Date.now(),ack_ts:Date.now(),msg_size:0,error_code:0,recv_msg_ts:0,fwd_msg_ts:0,reply_ack_ts:0,cur_dst_uid:""})}return t},_v=(e,t,i)=>{var o;t.enable_report&&Sm(t.report_msg_id)&&(null===(o=nv.get(e))||void 0===o||o.updateP2PMsg("".concat(t.report_msg_id),{send_ts:Date.now(),msg_size:i}))},bv=(e,t,i)=>{if(t.enable_report&&Sm(t.report_msg_id)){const o=nv.get(e);null==o||o.updateP2PMsg("".concat(t.report_msg_id),{ack_ts:Date.now(),error_code:i}),null==o||o.reportP2PMsg("".concat(t.report_msg_id))}},vv=(e,t,i)=>{const o=nv.get(e);return null!=o&&o.needReport("one2many")&&(i.enable_report=!0,i.report_msg_id=t,o.cacheCustomMsg({rts_session_id:o.rtsSessionId,msg_id:"".concat(t),node_role:"src_sdk",from:i.clientId,to:o.roomId||i.roomId,msg_type:"one2many",type:"one2many",rts_room_id:o.roomId,req_ts:Date.now(),send_ts:Date.now(),ack_ts:Date.now(),msg_size:0,error_code:0,recv_msg_ts:0,fwd_msg_ts:0,reply_ack_ts:0,cur_dst_uid:""})),i},Sv=(e,t,i)=>{if(t.enable_report&&Sm(t.report_msg_id)){const o=nv.get(e),s=t.to?"one2one":"one2many";null==o||o.reportMsgRecv({rts_session_id:o.rtsSessionId,msg_id:"".concat(t.report_msg_id),msg_size:i.msg_size,node_role:"dst_sdk",msg_type:s,type:s,rts_room_id:t.room,from:t.from,to:t.to||t.room,error_code:0,recv_msg_ts:i.recv_msg_ts,fwd_msg_ts:i.fwd_msg_ts,reply_ack_ts:Date.now(),cur_dst_uid:t.to?"":o.userId,config_version:"",req_ts:0,send_ts:0,ack_ts:0})}},yv=(e,t,i)=>{if(t.enable_report&&Sm(t.report_msg_id)){const o=nv.get(e);o&&(null==o||o.updateOne2ManyMsg("".concat(t.report_msg_id),{ack_ts:Date.now(),error_code:i}),null==o||o.reportOne2ManyMsg("".concat(t.report_msg_id)))}},fv=(e,t,i)=>{if(t.enable_report&&Sm(t.report_msg_id)){const o=nv.get(e);o&&o.updateOne2ManyMsg("".concat(t.report_msg_id),{send_ts:Date.now(),msg_size:i})}},gv=(e,t,i)=>{if(t.enable_report&&Sm(t.report_msg_id)){const o=nv.get(e);null==o||o.reportMsgRecv({rts_session_id:o.rtsSessionId,msg_id:"".concat(t.report_msg_id),msg_size:i.msg_size,node_role:"dst_sdk",msg_type:"one2many",type:"one2many",rts_room_id:t.roomId,from:t.clientId,to:t.roomId,error_code:0,recv_msg_ts:i.recv_msg_ts,fwd_msg_ts:i.fwd_msg_ts,reply_ack_ts:Date.now(),cur_dst_uid:o.userId,config_version:"",req_ts:0,send_ts:0,ack_ts:0})}};class Tv{constructor(e){Ou(this,"_timer",void 0),Ou(this,"userMessage",{}),Ou(this,"roomMessage",{}),this.id=e,this._setTimer()}_setTimer(){const e=()=>{this._reportAndgReset(),clearTimeout(this._timer),this._timer=setTimeout(e,1e4)};e()}_reportAndgReset(){(Object.keys(this.userMessage).length||Object.keys(this.roomMessage).length)&&(this._report(),this._reset())}_report(){var e;null===(e=Nv(this.id))||void 0===e||e.report("rtc_message_statistics",{dc_user_message:Object.keys(this.userMessage).map((e=>this.userMessage[e])),dc_room_message:Object.keys(this.roomMessage).map((e=>this.roomMessage[e])),media_server_ip:""})}_reset(){this.userMessage={},this.roomMessage={}}_checkInitUserMessage(e,t){this.userMessage["".concat(t,"-").concat(e)]||(this.userMessage["".concat(t,"-").concat(e)]={dc_peer_user_id:e,dc_send_total:0,dc_recv_total:0,dc_send_ack:0,dc_send_fail:0,dc_fail_timeout:0,dc_fail_no_receiver:0,dc_fail_no_relay_path:0,dc_cost_time:0,dc_cost_e2s:0,dc_cost_s2s:0,dc_least_time:Number(1/0),dc_most_time:0,dc_cost_peer_s2e:0,dc_send_ack_100:0,dc_send_ack_200:0,dc_send_ack_400:0,dc_send_ack_1s:0,dc_message_type:t,dc_send_binary:0})}_sendUserMessage(e,t,i){this._checkInitUserMessage(e,t),this.userMessage["".concat(t,"-").concat(e)].dc_send_total++,i&&this.userMessage["".concat(t,"-").concat(e)].dc_send_binary++}_recvUserMessage(e,t){this._checkInitUserMessage(e,t),this.userMessage["".concat(t,"-").concat(e)].dc_recv_total++}_sendUserFail(e,t,i){const o=this.userMessage["".concat(t,"-").concat(e)];o&&(o.dc_send_fail++,this._handleUserFail(o,i))}_handleUserFail(e,t){t&&(t.code||t.err)&&(["TIME_OUT","USER_MESSAGE_TIMEOUT"].includes(t.code)?e.dc_fail_timeout++:3===t.err?e.dc_fail_no_receiver++:4===t.err?e.dc_fail_no_relay_path++:1===t.err&&e.dc_fail_timeout++)}_sendUserAck(e,t,i,o,s){const r=this.userMessage["".concat(t,"-").concat(e)];r&&(r.dc_send_ack++,r.dc_cost_time+=i,r.dc_cost_s2s+=o||0,r.dc_cost_peer_s2e+=s,r.dc_cost_e2s+=i-(o||0)-s,i/2<=100?(r.dc_send_ack_100++,r.dc_send_ack_200++,r.dc_send_ack_400++,r.dc_send_ack_1s++):i/2<=200?(r.dc_send_ack_200++,r.dc_send_ack_400++,r.dc_send_ack_1s++):i/2<=400?(r.dc_send_ack_400++,r.dc_send_ack_1s++):i/2<=1e3&&r.dc_send_ack_1s++,i<r.dc_least_time&&(r.dc_least_time=i),i>r.dc_most_time&&(r.dc_most_time=i))}sendRoomMessage(e,t){this.roomMessage[e]||(this.roomMessage[e]={dc_room_id:e,dc_send_total:0,dc_send_ack:0,dc_cost_time:0,dc_least_time:Number(1/0),dc_most_time:0,dc_send_fail:0,dc_send_ack_100:0,dc_send_ack_200:0,dc_send_ack_400:0,dc_send_ack_1s:0,dc_send_binary:0}),this.roomMessage[e].dc_send_total++,t&&this.roomMessage[e].dc_send_binary++}sendRoomFail(e){const t=this.roomMessage[e];t&&t.dc_send_fail++}sendRoomAck(e,t){const i=this.roomMessage[e];i&&(i.dc_send_ack++,i.dc_cost_time+=t,t<i.dc_least_time&&(i.dc_least_time=t),t>i.dc_most_time&&(i.dc_most_time=t),t/2<=100?(i.dc_send_ack_100++,i.dc_send_ack_200++,i.dc_send_ack_400++,i.dc_send_ack_1s++):t/2<=200?(i.dc_send_ack_200++,i.dc_send_ack_400++,i.dc_send_ack_1s++):t/2<=400?(i.dc_send_ack_400++,i.dc_send_ack_1s++):t/2<=1e3&&i.dc_send_ack_1s++)}sendP2PMessage(e,t){this._sendUserMessage(e,"p2p",t)}recvP2PMessage(e){this._recvUserMessage(e,"p2p")}sendP2PFail(e,t){this._sendUserFail(e,"p2p",t)}sendP2PAck(e,t,i,o){this._sendUserAck(e,"p2p",t,i,o)}sendP2POutRoomMessage(e,t){this._sendUserMessage(e,"p2p_outside_room",t)}recvP2POutRoomMessage(e){this._recvUserMessage(e,"p2p_outside_room")}sendP2POutRoomFail(e,t){this._sendUserFail(e,"p2p_outside_room",t)}sendP2POutRoomAck(e,t,i,o){this._sendUserAck(e,"p2p_outside_room",t,i,o)}sendP2serverMessage(e){this._sendUserMessage("","p2server",e)}sendP2serverFail(e){this._sendUserFail("","p2server",e)}sendP2serveAck(e,t,i){this._sendUserAck("","p2server",e,t,i)}countP2PMessage(e,t,i,o,s){this.sendP2PMessage(t,i),e?this.sendP2PAck(t,Date.now()-o,s.s2s_time||0,s.s2e_time||0):this.sendP2PFail(t,s)}countRoomMessage(e,t,i,o){this.sendRoomMessage(t,i),e?this.sendRoomAck(t,Date.now()-o):this.sendRoomFail(t)}countUserMessageOutsideRoom(e,t,i,o,s){this.sendP2POutRoomMessage(t,i),e?this.sendP2POutRoomAck(t,Date.now()-o,s.s2s_time,s.s2e_time):this.sendP2POutRoomFail(t,s)}countServerMessage(e,t,i,o){this.sendP2serverMessage(t),e?(o=o||{},this.sendP2serveAck(Date.now()-i,o.s2s_time||0,o.s2e_time||0)):this.sendP2serverFail(o)}destroy(){this._reset(),clearTimeout(this._timer)}}const Iv=e=>{ov.setCommonStats(e)},Rv=e=>{ov.setUrl(e)},Ev=new sv("global"),Cv=(e,t,i)=>{Ev.report("rtc_sdk_api_call",{sdk_api_name:e,error_code:t,message:i})},Zv=(e,t,i)=>{Ev.report("rtc_sdk_callback",{sdk_callback_name:e,error_code:t,message:i})},Lv=(e,t,i)=>{Ev.report("rtc_error",{message:e,error_code:t},i)},Pv=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",s=arguments.length>4?arguments[4]:void 0;Ev.report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:i,stream_id:o,elapse:0},s)};const kv=new Map,Nv=e=>kv.get(e),Xv=(e,t)=>{const i=new sv(e);return i.set(Yu(Yu({},t),{},{engine_session_id:vm()})),i.report("sdk_init_engine",{start:Date.now(),type:"begin"}),kv.set(e,i),i},Vv=new Map;function wv(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=Object.assign({debounce:0},t);const{debounce:i,debounceTag:o}=t;function s(e,t,o,s){if(!i)return t(...o);{const r="".concat(s,"_").concat(e),n=Vv.get(r);clearTimeout(n);const a=setTimeout((()=>{t(...o)}),i);Vv.set(r,a)}}return function(t,i,r){if("function"==typeof r.value){const t=r.value;r.value=function(){for(var r,n,a=arguments.length,d=new Array(a),c=0;c<a;c++)d[c]=arguments[c];const l=this.engineId||this.id,u=vm(),h={};var m,p;(e.forEach(((e,t)=>{h[e]=d[t]})),"joinRoom"===i)&&(null===(m=Nv(l))||void 0===m||m.set({room_id:d[1],user_id:null===(p=d[2])||void 0===p?void 0:p.userId}));let _,b="";if(o)try{b=o(...d)}catch(v){}s(i,xv,[l,i,d,h,{event_session_id:u}],"start_".concat(b));try{_=t.apply(this,d)}catch(S){throw s(i,Gv,[l,i,S.message,S.code||-1,{event_session_id:u}],"end_".concat(b)),S}return"function"==typeof(null===(r=_)||void 0===r?void 0:r.then)?_.then((e=>(s(i,Gv,[l,i,[null!=e?e:{}],0,{event_session_id:u}],"end_".concat(b)),e))).catch((e=>{throw s(i,Gv,[l,i,e.message,e.code,{event_session_id:u}],"end_".concat(b)),e})):(s(i,Gv,[l,i,[null!==(n=_)&&void 0!==n?n:{}],0,{event_session_id:u}],"end_".concat(b)),_)}}}}const xv=function(e,t,i,o){var s;let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const n=Yu({sdk_api_name:t,message:JSON.stringify(Av(i)),error_code:0},r);null===(s=Nv(e))||void 0===s||s.report("rtc_sdk_api_call",n,o)},Gv=function(e,t,i){var o;let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const r=Yu({sdk_callback_name:t,error_code:arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,message:JSON.stringify(Array.isArray(i)?Av(i):i)},s);null===(o=Nv(e))||void 0===o||o.report("rtc_sdk_callback",r)},Wv=function(e,t,i){var o;let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",n=arguments.length>5?arguments[5]:void 0;null===(o=Nv(e))||void 0===o||o.report("rtc_invoke_status",{sdk_api_name:t,message:i,error_code:s,stream_id:r,elapse:0},n)},Mv=10;function Av(e){const t=e=>{if(null!=e&&e._reportName)return e._reportName;if(e instanceof HTMLElement)return e.toString();if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){const t=ArrayBuffer.isView(e)?e.buffer:e,o=t.byteLength;let s=[];if(o>Mv){var i;const e=new DataView(t);s=[...Array.from({length:Mv/2}).map(((t,i)=>e.getUint8(i))),"...",...Kh(i=Array.from({length:Mv/2}).map(((e,t)=>o-1-t))).call(i).map((t=>e.getUint8(t)))]}else s=Array.from(new Uint8Array(t));return"".concat(e.constructor.name,"(").concat(o,") [").concat(s.join(", "),"]")}if(e instanceof ImageData)return"ImageData";if(Array.isArray(e))return e.map(t);if(["[object Object]","[object MediaStreamTrack]"].includes(Object.prototype.toString.call(e))){const i={};for(const o in e)i[o]=t(e[o]);return i}return e instanceof Function?"[User Function]":e};return e.map(t)}const Ov="undefined"!=typeof window&&window.location.search.includes("_rtc_upload_console_");function Dv(e,t){return e.map((e=>{let i="";try{if("string"==typeof e)return e;if(void 0===e)return"undefined";if(null===e)return"null";if(e instanceof MediaStreamTrack)return ym(e);if(e instanceof MediaStream)return fm(e);if(e instanceof RTCRtpSender)return gm(e);if(e instanceof RTCRtpReceiver)return Tm(e);if(e instanceof RTCRtpTransceiver)return Im(e);i=JSON.stringify(e)}catch(o){i=e.toString()}return i&&i.length>=t&&(i=i.slice(0,t)),i})).join(", ")}var Yv,Kv=new class{constructor(){Ou(this,"name","ConsoleReportor"),Ou(this,"_uuid","".concat(Math.floor(899*Math.random())+100)),Ou(this,"_consoleReportId",0),Ou(this,"_engineReportIdMap",new Map),Ou(this,"_enabled","NULL"),Ou(this,"_consoleCutLength",Pm.getParameter("UPLOAD_CONSOLE_LENGTH_CUT")),Ou(this,"buffer",[]),Ov&&setTimeout((()=>{this.switchOn()}),0),Pm.on("UPLOAD_CONSOLE_ON",(e=>{e?this.switchOn():this.turnOff()})),Pm.on("UPLOAD_CONSOLE_LENGTH_CUT",(e=>{this._consoleCutLength=e}))}get enabled(){return"OFF"!==this._enabled}switchOn(){"NULL"===this._enabled&&(console.log("[LoggerReportor.constructor] console upload switch ON"),this._enabled="ON")}turnOff(){"NULL"===this._enabled&&(console.log("[LoggerReportor.constructor] console upload switch OFF"),this._enabled="OFF",this.buffer=[])}getEngineConsoleId(e){var t;const i=null!==(t=this._engineReportIdMap.get(e))&&void 0!==t?t:0;return this._engineReportIdMap.set(e,i+1),i}report(e,t,i,o,s,r,n,a,d){if("OFF"===this._enabled)return;const c=Nv(t),l=this._consoleReportId++,u=this.getEngineConsoleId(t),h=Dv(d,this._consoleCutLength),m=[...d],p="".concat(a).replace(/%o|%s/gi,(()=>Dv([m.shift()],this._consoleCutLength))),_="[".concat(this._uuid,"-").concat(l,"][").concat(t,"-").concat(u,"]-").concat(i,"-").concat(e,"[").concat(o,"]").concat(s,"[").concat(r,".").concat(n,"] ").concat(p," ").concat(h);var b;c?c.reportLog(_):(b=_,Ev.reportLog(b))}push(e){"OFF"!==this._enabled&&this.buffer.push(e)}splice(e){if("ON"!==this._enabled)return{payload:[],payloadSize:0};const{index:t,size:i}=function(e,t){let i=0;for(let o=0;o<e.length;o++){const s=JSON.stringify(e[o]).length;if(i+=s,i>t)return{index:o,size:i-s}}return{index:e.length,size:i}}(this.buffer,e);return{payload:this.buffer.splice(0,t),payloadSize:i}}unshift(e){this.buffer=e.concat(this.buffer)}get(){return this.buffer}set(e){this.buffer=e.concat(this.buffer)}isEmpty(){return"OFF"===this._enabled||0===this.buffer.length}};const Uv="[VERTC]",Fv="#0050b3",Hv={DEBUG:"rgba(0, 0, 0, 0)"," INFO":"rgba(93, 173, 226, 0)"," WARN":"rgba(255, 119, 0, 0.3)",ERROR:"rgba(255, 0, 0, 0.3)"," SUCC":"rgba(0, 119, 0, 0.3)"},Jv="undefined"!=typeof window&&(window.location.search.includes("_rtc_debug_")||(null===(Yv=window.localStorage)||void 0===Yv?void 0:Yv.getItem("_rtc_debug_")));const zv=()=>{const e=new Date;return"".concat(e.toTimeString().split(" ")[0],":").concat(e.getMilliseconds().toString().padStart(3,"0"))};var jv,Qv,Bv,qv,$v,eS=class{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"global";Ou(this,"indent",void 0),Ou(this,"module",void 0),Ou(this,"_engineId",void 0),this.module=e,this.indent=t,this._engineId=i}_print(e,t){for(var i=arguments.length,o=new Array(i>2?i-2:0),s=2;s<i;s++)o[s-2]=arguments[s];const r=o.shift();try{const e=[...o],i="".concat(r).replace(/%o/gi,(()=>{const t=e.shift();return JSON.stringify(t)}));Cm.set("".concat(Uv,"[").concat(this.module,".").concat(t,"] ").concat(i," ").concat(e.map((e=>JSON.stringify(e))).join(", ")))}catch(BW){}let n="";for(let d=0;d<this.indent;d++)n+="    ";const a=zv();Kv.report(Uv,this._engineId,a,e,n,this.module,t,r,o),Jv&&console.log("%c".concat(a,"-").concat(Uv,"%c[").concat(e,"]%c").concat(n,"[").concat(this.module,".").concat(t,"] ").concat(r),"color:".concat(Fv,";"),"background-color:".concat(Hv[e],";"),"color:".concat(Fv,";"),...o)}print(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" INFO",e,...i)}debug(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print("DEBUG",e,...i)}info(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" INFO",e,...i)}warn(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" WARN",e,...i)}error(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print("ERROR",e,...i)}success(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._print(" SUCC",e,...i)}};const tS=()=>"undefined"==typeof window,iS=tS()?"":window.navigator.userAgent;function oS(){let e="none";return tS()||(null!==iS.match("Firefox")?e="mozilla":null!==iS.match("Chrome")?(e="chrome-stable",null!==iS.match("Electron")&&(e="electron")):(null!==iS.match("Safari")||null!==iS.match("AppleWebKit"))&&(e="safari")),e}const sS="mozilla"===oS(),rS="safari"===oS(),nS="chrome-stable"===oS(),aS=!tS()&&/CriOS/i.test(iS),dS=!tS()&&/Edg\//i.test(iS),cS=!tS()&&/EdgA/i.test(iS),lS=!tS()&&/EdgiOS/i.test(iS),uS=dS||cS||lS,hS=!tS()&&/DingTalk/i.test(navigator.userAgent),mS=!tS()&&/OPR\//.test(navigator.userAgent),pS=!tS()&&(!!/(iPad)/i.exec(iS)||/Macintosh/i.test(iS)&&"ontouchend"in document),_S=!tS()&&/Macintosh/i.test(iS),bS=!tS()&&/MicroMessenger/i.test(iS),vS=!tS()&&iS.toLowerCase().includes("mobile"),SS=!tS()&&!!/(iPhone|iPad|iPod)/i.exec(iS),yS=!tS()&&/Android/i.test(iS),fS=!tS()&&/Windows/i.test(iS),gS=!tS()&&/OpenHarmony/i.test(iS);let TS=0,IS="0";const RS=!tS()&&(null===(jv=iS.match(/version\/(\d+)/i))||void 0===jv?void 0:jv[1]);var ES;rS&&RS&&(TS=Number(RS),IS=null===(ES=navigator.userAgent.match(/version\/(\d+\.\d+)/i))||void 0===ES?void 0:ES[1]);const CS=!tS()&&(null===(Qv=iS.match(/Firefox\/(\d+)/i))||void 0===Qv?void 0:Qv[1]);sS&&CS&&(TS=Number(CS));const ZS=TS,LS=TS,PS=IS,kS=null!==(Bv=!tS()&&(null===(qv=iS.match(/ ([\d_]+) like Mac OS X/i))||void 0===qv||null===(qv=qv[1])||void 0===qv?void 0:qv.split("_").map((e=>parseInt(e)))))&&void 0!==Bv?Bv:[];let NS=0;const XS=!tS()&&(null===($v=iS.match(/Chrome\/(\d+)/i))||void 0===$v?void 0:$v[1]);XS&&(NS=Number(XS));const VS=NS,wS="VolcEngine",xS="RTC_DEVICE_ID",GS="RTC_ACCESS_NODE",WS="RTC_ACCESS_URLS",MS="ENGINE_WEB_CONFIG",AS="SERVER_CONFIG";class OS{get(e){const t=localStorage.getItem(e);if(!t)return null;try{const i=JSON.parse(t);return i.ttl>0&&Date.now()-i.saveTime>i.ttl?(this.delete(e),null):i.message}catch(i){return null}}set(e,t){const i={ttl:arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,saveTime:Date.now(),message:t};try{return localStorage.setItem(e,JSON.stringify(i)),!0}catch(o){return!1}}getTtl(e){const t=localStorage.getItem(e);if(!t)return null;try{return JSON.parse(t).ttl}catch(i){return null}}delete(e){try{return localStorage.removeItem(e),!0}catch(t){return!1}}}var DS=new class extends OS{getDeviceId(){if(tS())return"";let e=this.get(xS);return e&&!/^[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}$/.test(e)||(e=function(e){let t="";for(let i=0;i<e;i++)t+=Math.floor(10*Math.random());return t}(16)),this.setDeviceId(e),e}setDeviceId(e){return Iv({device_id:e}),this.set(xS,e),e}getAccessNode(e){return this.get("".concat(GS,"_").concat(e,"-").concat(wS))}setAccessNode(e,t,i){return this.set("".concat(GS,"_").concat(e,"-").concat(wS),t,1e3*i)}deleteAccessNode(e,t){let i=this.getAccessNode(e);const o=this.getTtl("".concat(GS,"_").concat(e,"-").concat(wS));Array.isArray(i)&&i.length>0&&(i=i.filter((e=>e.mediaID!==t.mediaID&&e.msgKey!==t.msgKey)),i.length>0?this.setAccessNode(e,i,o||0):this.clearAccessNode(e))}clearAccessNode(e){if(e)this.delete("".concat(GS,"_").concat(e,"-").concat(wS));else for(const t in localStorage)t.startsWith(GS)&&localStorage.removeItem(t)}getAccessUrls(){return this.get("".concat(WS,"-").concat(wS))}setAccessUrls(e){const t=e.map((e=>{let{host:t,path:i}=e;return"https://".concat(t).concat(i)}));return this.set("".concat(WS,"-").concat(wS),t)}clearAccessUrls(){this.delete("".concat(WS,"-").concat(wS))}getEngineWebConfig(e,t){var i;const o="".concat(e,"_").concat(t,"_").concat(this.getDeviceId()),s=this.get(MS);return(null==s||null===(i=s.find((e=>e.key===o)))||void 0===i?void 0:i.config)||{}}setEngineWebConfig(e,t,i){if(!i)return;const o="".concat(e,"_").concat(t,"_").concat(this.getDeviceId());let s=this.get(MS)||[];return s=s.filter((e=>e.key!==o)),s.push({key:o,config:i}),this.set(MS,s.slice(-5))}getServerConfig(e){var t;const i="".concat(e),o=this.get(AS);return(null==o||null===(t=o.find((e=>e.key===i)))||void 0===t?void 0:t.config)||{}}setServerConfig(e,t){if(!t)return;const i="".concat(e);let o=this.get(AS)||[];return o=o.filter((e=>e.key!==i)),o.push({key:i,config:t}),this.set(AS,o.slice(-5))}};const YS=new eS("JoinRoomConfig",0);class KS{constructor(e){Ou(this,"_useTcpAfterJoinTimeout",KS.DEFAULT_CONF.useTcpAfterJoinTimeout),Ou(this,"_joinWithTcpOnly",KS.DEFAULT_CONF.joinWithTcpOnly),Ou(this,"_joinWithTcpOnlyDelay",KS.DEFAULT_CONF.joinWithTcpOnlyDelay),Ou(this,"_blackBrowserRegexList",[]),this._engineId=e,location.search.indexOf("__rtc_tcp_only__")>-1&&(this._joinWithTcpOnly=!0,this._joinWithTcpOnlyDelay=0),this._report()}static setDefaulConf(e){let{useTcpAfterJoinTimeout:t,joinWithTcpOnly:i,joinWithTcpOnlyDelay:o}=e;return"boolean"==typeof t&&(KS.DEFAULT_CONF.useTcpAfterJoinTimeout=t),"boolean"==typeof i&&(KS.DEFAULT_CONF.joinWithTcpOnly=i),"number"==typeof o&&(KS.DEFAULT_CONF.joinWithTcpOnlyDelay=Math.max(0,o)),KS.DEFAULT_CONF}get useTcpAfterJoinTimeout(){return this._useTcpAfterJoinTimeout}get useTcpJoin(){return this._joinWithTcpOnly}get useTcpJoinDelay(){return this._joinWithTcpOnlyDelay}isBlackBrower(){return this._blackBrowserRegexList.find((e=>new RegExp(e).test(navigator.userAgent)))}setServerConfig(e){var t,i,o;let s=!1;"boolean"==typeof(null==e||null===(t=e.use_tcp_after_join_timeout)||void 0===t?void 0:t.enable)&&(this._useTcpAfterJoinTimeout=e.use_tcp_after_join_timeout.enable,s=!0),"boolean"==typeof(null==e||null===(i=e.join_with_tcp_only)||void 0===i?void 0:i.enable)&&(this._joinWithTcpOnly=e.join_with_tcp_only.enable,s=!0),"number"==typeof(null==e||null===(o=e.join_with_tcp_only)||void 0===o?void 0:o.delay_ms)&&(this._joinWithTcpOnlyDelay=e.join_with_tcp_only.delay_ms,s=!0),e&&Array.isArray(e.black_browser_regex_list)&&(this._blackBrowserRegexList=e.black_browser_regex_list,s=!0),s&&this._report()}toString(){return JSON.stringify({use_tcp_after_join_timeout:this._useTcpAfterJoinTimeout,join_with_tcp_only:this._joinWithTcpOnly,join_with_tcp_only_delay:this._joinWithTcpOnlyDelay,black_browser_regex_list:this._blackBrowserRegexList})}_report(){YS.print("_report",this.toString()),Wv(this._engineId,"web_join_room_config",this.toString())}}Ou(KS,"DEFAULT_CONF",{useTcpAfterJoinTimeout:!0,joinWithTcpOnly:!1,joinWithTcpOnlyDelay:5e3});var US=(e=>(e.INVALID_ENGINE="INVALID_ENGINE",e.INVALID_PARAMS="INVALID_PARAMS",e.INVOKED_BEFORE_JOIN_ROOM="INVOKED_BEFORE_JOIN_ROOM",e.INVALID_TOKEN="INVALID_TOKEN",e.JOIN_ROOM_FAILED="JOIN_ROOM_FAILED",e.UPDATE_TOKEN_WITH_INVALID_TOKEN="UPDATE_TOKEN_WITH_INVALID_TOKEN",e.UPDATE_TOKEN_BEFORE_JOIN="UPDATE_TOKEN_BEFORE_JOIN",e.REPEAT_JOIN="REPEAT_JOIN",e.REPEAT_PUBLISH="REPEAT_PUBLISH",e.REPEAT_PUSH="REPEAT_PUSH",e.REPEAT_PLAY="REPEAT_PLAY",e.PUBLISH_BEFORE_JOIN="PUBLISH_BEFORE_JOIN",e.UNPUBLISH_BEFORE_JOIN="UNPUBLISH_BEFORE_JOIN",e.SUBSCRIBE_BEFORE_JOIN="SUBSCRIBE_BEFORE_JOIN",e.UNSUBSCRIBE_BEFORE_JOIN="UNSUBSCRIBE_BEFORE_JOIN",e.NO_PUBLISH_PERMISSION="NO_PUBLISH_PERMISSION",e.STREAM_NOT_EXIST="STREAM_NOT_EXIST",e.EMPTY_STREAM="EMPTY_STREAM",e.NOT_CONNECTED_YET="NOT_CONNECTED_YET",e.IM_BEFORE_JOIN="IM_BEFORE_JOIN",e.USER_NOT_EXIST="USER_NOT_EXIST",e.ALREADY_IN_ROOM="ALREADY_IN_ROOM",e.KICKED_OUT="KICKED_OUT",e.ROOM_DISMISS="ROOM_DISMISS",e.TOKEN_EXPIRED="TOKEN_EXPIRED",e.TOKEN_NO_PUBLISH_PERMISSION="TOKEN_NO_PUBLISH_PERMISSION",e.TOKEN_NO_SUBSCRIBE_PERMISSION="TOKEN_NO_SUBSCRIBE_PERMISSION",e.DUPLICATE_LOGIN="DUPLICATE_LOGIN",e.INVOKED_BEFORE_CAPTURE="INVOKED_BEFORE_CAPTURE",e.REPEAT_CAPTURE="REPEAT_CAPTURE",e.GET_VIDEO_TRACK_FAILED="GET_VIDEO_TRACK_FAILED",e.GET_AUDIO_TRACK_FAILED="GET_AUDIO_TRACK_FAILED",e.GET_SCREEN_TRACK_FAILED="GET_SCREEN_TRACK_FAILED",e.STREAM_TYPE_NOT_MATCH="STREAM_TYPE_NOT_MATCH",e.CANT_FIND_DOM="CANT_FIND_DOM",e.INVALID_DEVICE_ID="INVALID_DEVICE_ID",e.NO_PERMISSION="NO_PERMISSION",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INTERRUPT="INTERRUPT",e.ICE_SERVER_WRONG="ICE_SERVER_WRONG",e.ESTABLISH_DATACHANNEL_FAILED="ESTABLISH_DATACHANNEL_FAILED",e.LOAD_RESOURCES_FAILED="LOAD_RESOURCES_FAILED",e.SIGNALING_CHANNEL_NOT_OPEN="SIGNALING_CHANNEL_NOT_OPEN",e.TIME_OUT="TIME_OUT",e.REFUSE_OPERATION_IN_DISCONNECT="REFUSE_OPERATION_IN_DISCONNECT",e.ADD_TRANSCEIVER_FAILED="ADD_TRANSCEIVER_FAILED",e.UPDATE_TRACK_FAILED="UPDATE_TRACK_FAILED",e.PUBLISH_FAILED="PUBLISH_FAILED",e.UNPUBLISH_FAILED="UNPUBLISH_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.OPERATION_CANCEL="OPERATION_CANCEL",e.START_CLOUD_PROXY_AFTER_JOIN="START_CLOUD_PROXY_AFTER_JOIN",e.STOP_CLOUD_PROXY_BEFORE_LEAVE="STOP_CLOUD_PROXY_BEFORE_LEAVE",e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.REPEAT_DEVICE_TEST="REPEAT_DEVICE_TEST",e.AUDIO_DEVICE_TEST_FAILED="AUDIO_DEVICE_RECORD_FAILED",e.ALREADY_LOGIN="ALREADY_LOGIN",e.LOGIN_FAILED="LOGIN_FAILED",e.NOT_LOGIN="NOT_LOGIN",e.RTM_DUPLICATE_LOGIN="RTM_DUPLICATE_LOGIN",e.RTM_TOKEN_ERROR="RTM_TOKEN_ERROR",e.USER_MESSAGE_TIMEOUT="USER_MESSAGE_TIMEOUT",e.USER_MESSAGE_BROKEN="USER_MESSAGE_BROKEN",e.USER_MESSAGE_NO_RECEIVER="USER_MESSAGE_NO_RECEIVER",e.USER_MESSAGE_NO_RELAYPATH="USER_MESSAGE_NO_RELAYPATH",e.USER_MESSAGE_EXCEED_QPS="USER_MESSAGE_EXCEED_QPS",e.USER_MESSAGE_SEND_TO_SERVER_ERROR="USER_MESSAGE_SEND_TO_SERVER_ERROR",e.USER_MESSAGE_SERVER_RESPONSE_ERROR="USER_MESSAGE_SERVER_RESPONSE_ERROR",e.USER_MESSAGE_NOT_JOIN="USER_MESSAGE_NOT_JOIN",e.USER_MESSAGE_INIT="USER_MESSAGE_INIT",e.USER_MESSAGE_NO_CONNECTION="USER_MESSAGE_NO_CONNECTION",e.USER_MESSAGE_NOT_LOGIN="USER_MESSAGE_NOT_LOGIN",e.USER_MESSAGE_SERVER_PARAMS_NOTSET="USER_MESSAGE_SERVER_PARAMS_NOTSET",e.USER_MESSAGE_UNKNOWN="USER_MESSAGE_UNKNOWN",e.START_PUBLIC_STREAM_BEFORE_JOIN="START_PUBLIC_STREAM_BEFORE_JOIN",e.RECONNECT_FAILED="RECONNECT_FAILED",e.SUBTITLE_ALREADY_ON="SUBTITLE_ALREADY_ON",e.SUBTITLE_NOT_TURNED_ON="SUBTITLE_NOT_TURNED_ON",e.SUBTITLE_ERR_POSTPROCESS="SUBTITLE_ERR_POSTPROCESS",e.SUBTITLE_ERR_CONNECTION_ERROR="SUBTITLE_ERR_CONNECTION_ERROR",e.SUBTITLE_ERR_PROCESS_ERROR="SUBTITLE_ERR_PROCESS_ERROR",e.SUBTITLE_ERR_UNKNOWN="SUBTITLE_ERR_UNKNOWN",e.UNEXPECTED_INVOKE_FORWARD_STREAM="UNEXPECTED_INVOKE_FORWARD_STREAM",e.ROOM_FORBIDDEN="ROOM_FORBIDDEN",e.USER_FORBIDDEN="USER_FORBIDDEN",e.ERR_ELECTRON_IS_NULL="ERR_ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.SET_SIMULCAST_FAILED="SET_SIMULCAST_FAILED",e.MIXING_OLD_AND_NEW_APIS="MIXING_OLD_AND_NEW_APIS",e.WTN_PUSH_FAILED="WTN_PUSH_FAILED",e.WTN_PLAY_FAILED="WTN_PLAY_FAILED",e.NOT_ALLOWED_IN_RTS_ROOM="NOT_ALLOWED_IN_RTS_ROOM",e.NOT_ALLOWED_IN_RESTRICTED_MODE="NOT_ALLOWED_IN_RESTRICTED_MODE",e))(US||{}),FS=(e=>(e[e.AUDIO_MIXING_ERROR_OK=0]="AUDIO_MIXING_ERROR_OK",e[e.AUDIO_MIXING_ERROR_PRELOAD_FAILED=1]="AUDIO_MIXING_ERROR_PRELOAD_FAILED",e[e.AUDIO_MIXING_ERROR_START_FAILED=2]="AUDIO_MIXING_ERROR_START_FAILED",e[e.AUDIO_MIXING_ERROR_ID_NOT_FOUND=3]="AUDIO_MIXING_ERROR_ID_NOT_FOUND",e[e.AUDIO_MIXING_ERROR_SET_POSITION_FAILED=4]="AUDIO_MIXING_ERROR_SET_POSITION_FAILED",e[e.AUDIO_MIXING_ERROR_INVALID_VOLUME=5]="AUDIO_MIXING_ERROR_INVALID_VOLUME",e[e.AUDIO_MIXING_ERROR_LOAD_CONFLICT=6]="AUDIO_MIXING_ERROR_LOAD_CONFLICT",e[e.AUDIO_MIXING_ERROR_ID_TYPE_NOT_MATCH=7]="AUDIO_MIXING_ERROR_ID_TYPE_NOT_MATCH",e[e.AUDIO_MIXING_ERROR_ID_TYPE_INVALID_PITCH=8]="AUDIO_MIXING_ERROR_ID_TYPE_INVALID_PITCH",e[e.AUDIO_MIXING_ERROR_INVALID_AUDIO_TRACK=9]="AUDIO_MIXING_ERROR_INVALID_AUDIO_TRACK",e))(FS||{});class HS extends Error{constructor(e,t,i){super(t),Ou(this,"code",void 0),Ou(this,"message",void 0),Ou(this,"error",void 0),this.code=e,this.message=t,this.error=i,Object.setPrototypeOf(this,HS.prototype)}toString(){return"SDKError: ".concat(this.code," ").concat(this.message)}}function JS(e,t){if("boolean"!=typeof e)throw new HS(US.INVALID_PARAMS,"Invalid ".concat(t,": The value should be boolean type."))}const zS=()=>!bm()&&"function"==typeof HTMLVideoElement.prototype.requestVideoFrameCallback;function jS(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.POSITIVE_INFINITY;if(e<i||e>o||"number"!=typeof e){throw new HS(US.INVALID_PARAMS,"Invalid ".concat(t,": the value range is [").concat(i,", ").concat(o,"]. integer only"))}}function QS(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.POSITIVE_INFINITY;if(null==e)throw new HS(US.INVALID_PARAMS,"".concat(t," cannot be empty"));if(!function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.POSITIVE_INFINITY;return"string"==typeof e&&e.length<=i&&e.length>=t}(e,i,o))throw new HS(US.INVALID_PARAMS,"Invalid ".concat(t,": The value should be string type. Length of the string: [").concat(i,",").concat(o,"]"))}function BS(e,t,i){if(!i.includes(e))throw new HS(US.INVALID_PARAMS,"Invalid ".concat(t,": The value can only be set as ").concat(JSON.stringify(i)))}function qS(e){if(!(e instanceof MediaStreamTrack))throw new HS(US.INVALID_PARAMS,"Invalid track, The value should be MediaStreamTrack type.")}function $S(e,t){if(iy(e))throw new HS(US.INVALID_PARAMS,"Invalid ".concat(t,", should not be empty"))}function ey(e,t){if(!(e instanceof ArrayBuffer))throw new HS(US.INVALID_PARAMS,"Invalid ".concat(t,", should be ArrayBuffer"))}function ty(e){try{const t=navigator.mediaDevices.getSupportedConstraints();for(const i of Object.keys(e))t[i]||delete e[i]}catch(t){}}function iy(e){return null==e}function oy(e){if("string"!=typeof e||!/^[a-zA-Z0-9@._-]{1,128}$/.test(e))throw new HS(US.INVALID_PARAMS,"The RoomId must be within 128 bytes. The supported characters: a-z,A-Z,0-9,@,-,_,.")}function sy(e){if("string"!=typeof e||!/^[a-zA-Z0-9@._-]{1,128}$/.test(e))throw new HS(US.INVALID_PARAMS,"The userId must be within 128 bytes. The supported characters: a-z,A-Z,0-9,@,-,_,.")}function ry(e){if("string"!=typeof e||!/^[a-zA-Z0-9@._-]{1,128}$/.test(e))throw new HS(US.INVALID_PARAMS,"The publicStreamId must be within 128 bytes. The supported characters: a-z,A-Z,0-9,@,-,_,.")}function ny(e){$S(e,"videoPlayerOption")}function ay(e,t){if("number"==typeof e&&!Number.isNaN(e)&&e>=1)return;const i=e;if(!(null!=i&&i.min||null!=i&&i.max||null!=i&&i.exact||null!=i&&i.ideal))throw new HS(US.INVALID_PARAMS,"".concat(t," is not a valid ConstrainULong"))}function dy(e){!function(e,t){if(!Array.isArray(e))throw new HS(US.INVALID_PARAMS,"Invalid ".concat(t,", should be array"))}(e,"videoEncoderConfig");for(const t of e)$S(t,"videoEncoderConfigItem"),jS(null==t?void 0:t.maxKbps,"maxKbps"),ay(null==t?void 0:t.width,"width"),ay(null==t?void 0:t.height,"height"),ay(null==t?void 0:t.frameRate,"frameRate")}function cy(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.NEGATIVE_INFINITY,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.POSITIVE_INFINITY;return jS(e,t,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),e=(e=e>i?e:i)<o?e:o}var ly=(e=>(e[e.NONE=0]="NONE",e))(ly||{});const uy="rtc-access-ag.bytedance.com,rtc-access.bytedance.com,rtc-access2-hl.bytedance.com,rtcg-access.bytevcloud.com".split(",");function hy(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e?(/^https?:\/\/.+/.test(e)||(e="https://".concat(e)),"".concat(e,"/dispatch/v1/AccessInfo?Action=GetAccessInfo")):""}const my="https://web-log-report.rtc.volcvideo.com/video/v1/webrtc_log/",py="common.rtc.volcvideo.com,rtcg.volcvideos.com".split(","),_y={VERSION:"4.66.1",ICE_CONFIG_REQUEST_URLS_INTERNAL:uy.map(hy),ICE_CONFIG_REQUEST_URLS:[],EXPECTED_ADDR:"",LOG_SERVER_URL:my,CONFIG_REQUEST_DOMAINS:py,DEVICE_ID:"",OVERSEA:!1,PLATFORM:"",PRODUCT:"",FORCE_ENABLED_REPORT_CALLBACKS:[],SKIP_WEB_AUDIO_IN_TRACK:!1,AUDIO_STALL:!0,VIDEO_STALL:!0,VIDEO_STALL_100MS:!1,STATS_SCALLBACK_SUPPORT:!0,JOIN_ROOM_CONFIG:KS.DEFAULT_CONF,SIGNAL_COMPRESSION:!0,SIGNAL_CROP_JOINROOM:!0,VIDEO_STALL_DATA:500,AUDIO_STALL_DATA:200,IOS_SAFARI_ORIENTATION:!1,BLACK_FRAME_LIFETIME:6e4,FALLBACK_ENCODE_CODEC:"",SEI_TIME_OUT:2e3,SEI_COUNT_FPS:1,PRE_ICE:!1,STATS_LOOP_INTERVAL:1e3,HIDDEN_STATS:!1,UPLOAD_REMOTE_STATS:ly.NONE,SDK_CODEC_NEGOTIATION:!0,AUDIO_CODEC:"OPUS",DISABLE_ENCODED_TRANSFORM:!1,SKIP_SEI_FILTER:!1,AREA_CODE:"",DISABLE_COMPUTE_PRESSURE:!1};function by(e,t){if(Cv("setParameter",0,"key: ".concat(e,", value: ").concat(t)),"VERSION"===e)return;if("JOIN_ROOM_CONFIG"===e)return KS.setDefaulConf(t);if("ICE_CONFIG_REQUEST_URLS"===e){const e="string"==typeof t?[t]:t;return _y.ICE_CONFIG_REQUEST_URLS=e.map(hy),DS.clearAccessUrls(),void DS.clearAccessNode()}if("VIDEO_STALL_DATA"===e)return void(_y.VIDEO_STALL_DATA=Math.max(500,Number(t)));if("AUDIO_STALL_DATA"===e)return void(_y.AUDIO_STALL_DATA=Math.max(200,Number(t)));if("VIDEO_STALL_100MS"===e)return void(_y.VIDEO_STALL_100MS=zS()&&!!t);if("PLATFORM"===e&&"string"==typeof t)return void Iv({platform:t});if("PRODUCT"===e&&"string"==typeof t)return void Iv({product:t});if("FORCE_ENABLED_REPORT_CALLBACKS"===e){const e="string"==typeof t?[t]:t;return void(_y.FORCE_ENABLED_REPORT_CALLBACKS=e)}if("LOG_SERVER_URL"===e){const e=t===ah.overseas?"https://web-log-report.volcvideos.com/video/v1/webrtc_log/":t===ah.domestic?my:"string"==typeof t?t:void 0;e&&(_y.LOG_SERVER_URL=e,Rv(e))}else if("OVERSEA"===e)return Iv({extra_is_oversea:t?"1":"0"}),void(_y.OVERSEA=t);if("CONFIG_REQUEST_DOMAINS"===e&&Array.isArray(t)&&t.length>0)return void(_y.CONFIG_REQUEST_DOMAINS=t);if("SEI_TIME_OUT"===e&&"number"!=typeof t)return;if("SEI_COUNT_FPS"===e&&"number"!=typeof t)return;if("UPLOAD_REMOTE_STATS"===e&&"string"==typeof t){const e=t.split(",").map((e=>dm(e).call(e))).reduce(((e,t)=>"video"===t?e|$u.VIDEO:"audio"===t?e|$u.AUDIO:e),ly.NONE);return void(_y.UPLOAD_REMOTE_STATS=e)}if("AINR_URLS"===e&&"string"==typeof t)try{const{gulpUrl:e,wasmUrl:i,type5ModelUrl:o,type6ModelUrl:s}=JSON.parse(t);return void(_y.AINR_URLS={gulpUrl:e,wasmUrl:i,type5ModelUrl:o,type6ModelUrl:s})}catch(BW){console.error(BW)}"DEVICE_ID"===e&&DS.setDeviceId(t);Pm.getKeys().includes(e)?Pm.setParameter(e,t):Reflect.set(_y,e,t)}function vy(e){return"DEVICE_ID"===e?DS.getDeviceId():_y[e]}function Sy(e,t,i){var o,s,r,n,a,d,c,l;return{type:"publicstream",action:t,publicStreamID:e,publicStreamMeta:{audio:{},video:{fps:(null===(o=i.video)||void 0===o?void 0:o.fps)||15,bitrate:1e3*((null===(s=i.video)||void 0===s?void 0:s.kBitRate)||40),width:(null===(r=i.video)||void 0===r?void 0:r.width)||640,height:(null===(n=i.video)||void 0===n?void 0:n.height)||360},layout:{layoutMode:2,interpolationMode:(null===(a=i.layout)||void 0===a?void 0:a.interpolationMode)||lh.PREV_FRAME,canvas:{bgColor:(null===(d=i.layout)||void 0===d?void 0:d.backgroundColor)||"#000000",bgImage:(null===(c=i.layout)||void 0===c?void 0:c.backgroundImage)||""},regions:(null===(l=i.layout)||void 0===l||null===(l=l.regions)||void 0===l?void 0:l.map((e=>({roomId:e.roomId,userId:e.userId,alterImage:e.alertImage||"",alpha:!e.alpha||Number(e.alpha)>1||Number(e.alpha)<=0?1:Number(e.alpha),x:!e.x||Number(e.x)>=1||Number(e.x)<0?0:Number(e.x),y:!e.y||Number(e.y)>=1||Number(e.y)<0?0:Number(e.y),w:!e.w||Number(e.w)>1||Number(e.w)<=0?1:Number(e.w),h:!e.h||Number(e.h)>1||Number(e.h)<=0?1:Number(e.h),zorder:!e.zorder||Number(e.zorder)<0||Number(e.zorder)>100?0:Number(e.zorder),renderMode:void 0===e.renderMode?1:e.renderMode,streamType:e.isScreenStream?1:0,mediaType:e.mediaType||0,sourceCrop:e.sourceCrop}))))||[]}}}}let yy=[];function fy(e){yy=e}const gy=(e,t)=>{const i=yy;if(!i.length)return;const o=e[0],s=t.width||jy(o.width),r=t.height||jy(o.height),n=s*r;if(jy(o.width)*jy(o.height)<=n)return;let a,d,c=i[0];i.forEach((e=>{const t=jy(e.width)*jy(e.height);a||(n<t?a=e:c=e)})),d=a&&jy(a.width)*jy(a.height)-n<n-jy(c.width)*jy(c.height)?Object.assign({},a):Object.assign({},c);const l=e.filter((e=>!(d&&jy(e.width)*jy(e.height)>=n)||(d.maxKbps=Math.min(e.maxKbps,d.maxKbps),!1)));return l.unshift({width:s,height:r,frameRate:t.frameRate?Math.round(t.frameRate):l[0].frameRate,maxKbps:d.maxKbps}),l},Ty={width:640,height:480,frameRate:15,maxKbps:600},Iy={width:1920,height:1080,frameRate:15,maxKbps:3e3};let Ry;const Ey=new Uint8Array(16);function Cy(){if(!Ry&&(Ry="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ry))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ry(Ey)}const Zy=[];for(let $W=0;$W<256;++$W)Zy.push(($W+256).toString(16).slice(1));var Ly,Py={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function ky(e,t,i){if(Py.randomUUID&&!t&&!e)return Py.randomUUID();const o=(e=e||{}).random||(e.rng||Cy)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=o[e];return t}return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Zy[e[t+0]]+Zy[e[t+1]]+Zy[e[t+2]]+Zy[e[t+3]]+"-"+Zy[e[t+4]]+Zy[e[t+5]]+"-"+Zy[e[t+6]]+Zy[e[t+7]]+"-"+Zy[e[t+8]]+Zy[e[t+9]]+"-"+Zy[e[t+10]]+Zy[e[t+11]]+Zy[e[t+12]]+Zy[e[t+13]]+Zy[e[t+14]]+Zy[e[t+15]]}(o)}const Ny=new TextDecoder,Xy=new TextEncoder,Vy=()=>ky(),wy=()=>Date.now();function xy(e){let t=0;for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];for(const a of o)t+=a.length;const r=new e(t);let n=0;for(const a of o)r.set(a,n),n+=a.length;return r}class Gy{static token2auth(e,t,i,o){return o?"Bearer ".concat(o):"Basic ".concat(Gy.createUnsafeToken(e,t,i))}static createUnsafeToken(e,t,i){return window.btoa([e,t,i].filter((e=>null!==e)).join(":"))}static merge(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(const[i,o]of Object.entries(e))null!==o&&"object"==typeof o?Gy.merge(e[i],t[i]):void 0!==t[i]&&(e[i]=t[i])}static ab2str(e){return Ny.decode(e)}static ab2obj(e){try{const t=Gy.ab2str(e);return JSON.parse(t)}catch(t){return{}}}static str2ab(e){return Xy.encode(e).buffer}static async ab2b64str(e){return(await new Promise((t=>{const i=new FileReader;i.onload=()=>t(i.result),i.readAsDataURL(new Blob([e]))}))).split(",",2)[1]}static async b64str2ab(e,t){return fetch("data:application/octet;base64,".concat(e)).then((e=>e.arrayBuffer())).catch((i=>{throw t&&t.report("rtc_error",{error_code:2001,message:"".concat(i.message," -> ").concat(e)}),i}))}}function Wy(e){return new Promise((t=>{setTimeout(t,e)}))}function My(){const e=Number("".concat(Math.random()).slice(-7).padEnd(7,"0")).toString(2).padEnd(28,"1").split(""),t=[];for(;e.length;)t.push(e.splice(0,7));return t.map(((e,i)=>{const o=i===t.length-1?"0":"1";return Number.parseInt(o+e.join(""),2)}))}const Ay=()=>Math.floor(65535*Math.random());function Oy(e){return"string"==typeof e&&e.indexOf("__web__rtc__rtt__")>-1}let Dy;function Yy(e){return Number(Math.max(-127,10*Math.log10(Math.pow(e/255,2))).toFixed(2))}function Ky(e){return(e&$u.AUDIO)===$u.AUDIO}function Uy(e){return(e&$u.VIDEO)===$u.VIDEO}function Fy(e){const t={};return Object.keys(e).forEach((i=>{"object"==typeof e[i]?t[i]=Fy(e[i]):i.startsWith("_")&&!vy("HIDDEN_STATS")||(t[i]=e[i])})),t}function Hy(e){return void 0===e}function Jy(e){return function(t,i,o){const s=o.value;o.value=function(){console.warn("[RTC WebSDK]: Api: ".concat(i," has been abandoned from version ").concat(e));for(var t=arguments.length,o=new Array(t),r=0;r<t;r++)o[r]=arguments[r];return s.apply(this,o)}}}function zy(e){console.warn("[RTC WebSDK]: ".concat(e))}function jy(e){return"number"==typeof e?e:"number"==typeof(null==e?void 0:e.exact)?e.exact:"number"==typeof(null==e?void 0:e.ideal)?e.ideal:"number"==typeof(null==e?void 0:e.max)?e.max:"number"==typeof(null==e?void 0:e.min)?e.min:1}class Qy{constructor(){Ou(this,"_id",void 0),this._id=Math.ceil(Math.random()*Number.MAX_SAFE_INTEGER)}getMessageId(){return++this._id>Number.MAX_SAFE_INTEGER&&(this._id=0),this._id}}const By="undefined"!=typeof window&&(window.location.search.includes("_rtc_debug_")||!(null===(Ly=window.localStorage)||void 0===Ly||!Ly.getItem("_rtc_debug_")));var qy,$y,ef,tf,of,sf,rf,nf,af,df,cf,lf;const uf={};function hf(e,t){try{return e[t].toString().includes("[native code]")?"native":"non-native"}catch(i){return"untouchable"}}const mf=("undefined"!=typeof window?[[null===(qy=window.RTCPeerConnection)||void 0===qy?void 0:qy.prototype,"RTCPeerConnection.prototype"],[window.RTCPeerConnection,"RTCPeerConnection"],[null===($y=window.RTCDataChannel)||void 0===$y?void 0:$y.prototype,"RTCDataChannel.prototype"],[window.RTCDataChannel,"RTCDataChannel"],[null===(ef=window.MediaStreamTrack)||void 0===ef?void 0:ef.prototype,"MediaStreamTrack.prototype"],[window.MediaStreamTrack,"MediaStreamTrack"],[null===(tf=window.MediaStream)||void 0===tf?void 0:tf.prototype,"MediaStream.prototype"],[window.MediaStream,"MediaStream"],[null===(of=window.HTMLAudioElement)||void 0===of?void 0:of.prototype,"HTMLAudioElement.prototype"],[null===(sf=window.HTMLVideoElement)||void 0===sf?void 0:sf.prototype,"HTMLVideoElement.prototype"],[null===(rf=window.HTMLMediaElement)||void 0===rf?void 0:rf.prototype,"HTMLMediaElement.prototype"],[null!==(nf=null===(af=window.AudioContext)||void 0===af?void 0:af.prototype)&&void 0!==nf?nf:null===(df=window.webkitAudioContext)||void 0===df?void 0:df.prototype,"AudioContext.prototype"],[null===(cf=window.BaseAudioContext)||void 0===cf?void 0:cf.prototype,"BaseAudioContext.prototype"],[null===(lf=window.AudioNode)||void 0===lf?void 0:lf.prototype,"AudioNode.prototype"],[window.navigator.mediaDevices,"navigator.mediaDevices"],[window.console,"console"]]:[]).reduce(((e,t)=>{let[i,o]=t;return e.concat(function(e,t){return e?Object.getOwnPropertyNames(e).filter((t=>{if("peerIdentity"===t)return!1;try{return"function"==typeof e[t]||void 0===e[t]}catch(i){return!1}})).map((i=>({obj:e,prefix:t,attr:i}))):[]}(i,o))}),[]);"undefined"!=typeof window&&mf.push({obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"getUserMedia"},{obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"getDisplayMedia"},{obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"enumerateDevices"},{obj:window.navigator.mediaDevices,prefix:"navigator.mediaDevices",attr:"getSupportedConstraints"});for(const{obj:$W,prefix:eM,attr:tM}of mf){const e="".concat(eM,".").concat(tM);uf[e]=hf($W,tM)}By&&console.log("RTC_AMBULANCE",uf);const pf=Object.entries(uf).filter((e=>{let[t,i]=e;return"non-native"===i})).map((e=>{let[t,i]=e;return t}));Object.keys(pf).length&&console.warn("RTC_AMBULANCE","have non-native code:\n",pf.join("\n"));let _f=!0,bf=!0;function vf(e,t,i){const o=e.match(t);return o&&o.length>=i&&parseInt(o[i],10)}function Sf(e,t,i){if(!e.RTCPeerConnection)return;const o=e.RTCPeerConnection.prototype,s=o.addEventListener;o.addEventListener=function(e,o){if(e!==t)return s.apply(this,arguments);const r=e=>{const t=i(e);t&&(o.handleEvent?o.handleEvent(t):o(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(o,r),s.apply(this,[e,r])};const r=o.removeEventListener;o.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return r.apply(this,arguments);if(!this._eventMap[t].has(i))return r.apply(this,arguments);const o=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,r.apply(this,[e,o])},Object.defineProperty(o,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function yf(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(_f=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function ff(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(bf=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function gf(){if("object"==typeof window){if(_f)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function Tf(e,t){bf&&console.warn(e+" is deprecated, please use "+t+" instead.")}function If(e){return"[object Object]"===Object.prototype.toString.call(e)}function Rf(e){return If(e)?Object.keys(e).reduce((function(t,i){const o=If(e[i]),s=o?Rf(e[i]):e[i],r=o&&!Object.keys(s).length;return void 0===s||r?t:Object.assign(t,{[i]:s})}),{}):e}function Ef(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((o=>{o.endsWith("Id")?Ef(e,e.get(t[o]),i):o.endsWith("Ids")&&t[o].forEach((t=>{Ef(e,e.get(t),i)}))})))}function Cf(e,t,i){const o=i?"outbound-rtp":"inbound-rtp",s=new Map;if(null===t)return s;const r=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&r.push(e)})),r.forEach((t=>{e.forEach((i=>{i.type===o&&i.trackId===t.id&&Ef(e,i,s)}))})),s}const Zf=gf;function Lf(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const o=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const o="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==o.exact&&"number"==typeof o.exact&&(o.min=o.max=o.exact);const s=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==o.ideal){t.optional=t.optional||[];let e={};"number"==typeof o.ideal?(e[s("min",i)]=o.ideal,t.optional.push(e),e={},e[s("max",i)]=o.ideal,t.optional.push(e)):(e[s("",i)]=o.ideal,t.optional.push(e))}void 0!==o.exact&&"number"!=typeof o.exact?(t.mandatory=t.mandatory||{},t.mandatory[s("",i)]=o.exact):["min","max"].forEach((e=>{void 0!==o[e]&&(t.mandatory=t.mandatory||{},t.mandatory[s(e,i)]=o[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,s){if(t.version>=61)return s(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=o(e.audio)}if(e&&"object"==typeof e.video){let r=e.video.facingMode;r=r&&("object"==typeof r?r:{ideal:r});const n=t.version<66;if(r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||n)){let t;if(delete e.video.facingMode,"environment"===r.exact||"environment"===r.ideal?t=["back","rear"]:"user"!==r.exact&&"user"!==r.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{let n=(i=i.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!n&&i.length&&t.includes("back")&&(n=i[i.length-1]),n&&(e.video.deviceId=r.exact?{exact:n.deviceId}:{ideal:n.deviceId}),e.video=o(e.video),Zf("chrome: "+JSON.stringify(e)),s(e)}))}e.video=o(e.video)}return Zf("chrome: "+JSON.stringify(e)),s(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,o){s(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{o&&o(r(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return s(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(r(e))))))}}}function Pf(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function kf(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let o;o=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=o,s.transceiver={receiver:o},s.streams=[t.stream],this.dispatchEvent(s)})),t.stream.getTracks().forEach((i=>{let o;o=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const s=new Event("track");s.track=i,s.receiver=o,s.transceiver={receiver:o},s.streams=[t.stream],this.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Sf(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function Nf(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,o){let s=i.apply(this,arguments);return s||(s=t(this,e),this._senders.push(s)),s};const o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){o.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],o.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Xf(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,o]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const s=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},r=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const o=function(e){i(r(s(e)))};return t.apply(this,[o,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(r(s(t)))},i])})).then(i,o)}}function Vf(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Cf(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Sf(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Cf(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,o;return this.getSenders().forEach((i=>{i.track===e&&(t?o=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?o=!0:i=t),t.track===e))),o||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function wf(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const o=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(o)&&this._shimmedLocalStreams[i.id].push(o):this._shimmedLocalStreams[i.id]=[i,o],o};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const o=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(o)};const o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],o.apply(this,arguments)};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),s.apply(this,arguments)}}function xf(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return wf(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}o.apply(this,[t])};const s=e.RTCPeerConnection.prototype.removeStream;function r(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const o=e._reverseStreams[t],s=e._streams[o.id];i=i.replace(new RegExp(s.id,"g"),o.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const o=[].slice.call(arguments,1);if(1!==o.length||!o[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const s=this._streams[i.id];if(s)s.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const o=new e.MediaStream([t]);this._streams[i.id]=o,this._reverseStreams[o.id]=i,this.addStream(o)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],o={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=r(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>r(this,e)))}};e.RTCPeerConnection.prototype[t]=o[t]}));const n=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const o=e._reverseStreams[t],s=e._streams[o.id];i=i.replace(new RegExp(o.id,"g"),s.id)})),new RTCSessionDescription({type:t.type,sdp:i})}(this,arguments[0]),n.apply(this,arguments)):n.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:r(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Gf(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],o={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=o[t]}))}function Wf(e,t){Sf(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}var Mf=Object.freeze({__proto__:null,fixNegotiationNeeded:Wf,shimAddTrackRemoveTrack:xf,shimAddTrackRemoveTrackWithNative:wf,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const o=i.video&&i.video.width,s=i.video&&i.video.height,r=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:r||3}},o&&(i.video.mandatory.maxWidth=o),s&&(i.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:Nf,shimGetStats:Xf,shimGetUserMedia:Lf,shimMediaStream:Pf,shimOnTrack:kf,shimPeerConnection:Gf,shimSenderReceiverGetStats:Vf});function Af(e,t){const i=e&&e.navigator,o=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,o){Tf("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,o)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},o&&o.prototype.getSettings){const t=o.prototype.getSettings;o.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(o&&o.prototype.applyConstraints){const t=o.prototype.applyConstraints;o.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function Of(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Df(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],o={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=o[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,s,r]=arguments;return o.apply(this,[e||null]).then((e=>{if(t.version<53&&!s)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(o){if("TypeError"!==o.name)throw o;e.forEach(((t,o)=>{e.set(o,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(s,r)}}function Yf(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Kf(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Sf(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Uf(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){Tf("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function Ff(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Hf(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const o=t.apply(this,arguments);if(i){const{sender:t}=o,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return o})}function Jf(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function zf(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function jf(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var Qf=Object.freeze({__proto__:null,shimAddTransceiver:Hf,shimCreateAnswer:jf,shimCreateOffer:zf,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:Jf,shimGetUserMedia:Af,shimOnTrack:Of,shimPeerConnection:Df,shimRTCDataChannel:Ff,shimReceiverGetStats:Kf,shimRemoveStream:Uf,shimSenderGetStats:Yf});function Bf(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];return o&&o.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function qf(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function $f(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,o=t.createAnswer,s=t.setLocalDescription,r=t.setRemoteDescription,n=t.addIceCandidate;t.createOffer=function(e,t){const o=arguments.length>=2?arguments[2]:arguments[0],s=i.apply(this,[o]);return t?(s.then(e,t),Promise.resolve()):s},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],s=o.apply(this,[i]);return t?(s.then(e,t),Promise.resolve()):s};let a=function(e,t,i){const o=s.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o};t.setLocalDescription=a,a=function(e,t,i){const o=r.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o},t.setRemoteDescription=a,a=function(e,t,i){const o=n.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o},t.addIceCandidate=a}function eg(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(tg(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,o){t.mediaDevices.getUserMedia(e).then(i,o)}.bind(t))}function tg(e){return e&&void 0!==e.video?Object.assign({},e,{video:Rf(e.video)}):e}function ig(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let o=e.iceServers[i];void 0===o.urls&&o.url?(Tf("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,t.push(o)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function og(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function sg(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function rg(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var ng=Object.freeze({__proto__:null,shimAudioContext:rg,shimCallbacksAPI:$f,shimConstraints:tg,shimCreateOfferLegacy:sg,shimGetUserMedia:eg,shimLocalStreamsAPI:Bf,shimRTCIceServerUrls:ig,shimRemoteStreamsAPI:qf,shimTrackEventTransceiver:og}),ag={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return dm(e).call(e).split("\n").map((e=>dm(e).call(e)))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>{var i;return dm(i=t>0?"m="+e:e).call(i)+"\r\n"}))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let o=8;o<t.length;o+=2)switch(t[o]){case"raddr":i.relatedAddress=t[o+1];break;case"rport":i.relatedPort=parseInt(t[o+1],10);break;case"tcptype":i.tcpType=t[o+1];break;case"ufrag":i.ufrag=t[o+1],i.usernameFragment=t[o+1];break;default:void 0===i[t[o]]&&(i[t[o]]=t[o+1])}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const o=e.type;return t.push("typ"),t.push(o),"host"!==o&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let i;const o=e.substring(e.indexOf(" ")+1).split(";");for(let n=0;n<o.length;n++){var s,r;i=dm(s=o[n]).call(s).split("="),t[dm(r=i[0]).call(r)]=i[1]}return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const o=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?o.push(t+"="+e.parameters[t]):o.push(t)})),t+="a=fmtp:"+i+" "+o.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},o=e.indexOf(":",t);return o>-1?(i.attribute=e.substring(t+1,o),i.value=e.substring(o+1)):i.attribute=e.substring(t+1),i},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const o=t.matchPrefix(e+i,"a=ice-ufrag:")[0],s=t.matchPrefix(e+i,"a=ice-pwd:")[0];return o&&s?{usernameFragment:o.substring(12),password:s.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},o=t.splitLines(e)[0].split(" ");i.profile=o[2];for(let r=3;r<o.length;r++){const s=o[r],n=t.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(n){const o=t.parseRtpMap(n),r=t.matchPrefix(e,"a=fmtp:"+s+" ");switch(o.parameters=r.length?t.parseFmtp(r[0]):{},o.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(t.parseRtcpFb),i.codecs.push(o),o.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(o.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))}));const s=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((e=>{s.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),i},t.writeRtpDescription=function(e,i){let o="";o+="m="+e+" ",o+=i.codecs.length>0?"9":"0",o+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",o+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",o+="c=IN IP4 0.0.0.0\r\n",o+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{o+=t.writeRtpMap(e),o+=t.writeFmtp(e),o+=t.writeRtcpFb(e)}));let s=0;return i.codecs.forEach((e=>{e.maxptime>s&&(s=e.maxptime)})),s>0&&(o+="a=maxptime:"+s+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{o+=t.writeExtmap(e)})),o},t.parseRtpEncodingParameters=function(e){const i=[],o=t.parseRtpParameters(e),s=-1!==o.fecMechanisms.indexOf("RED"),r=-1!==o.fecMechanisms.indexOf("ULPFEC"),n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=n.length>0&&n[0].ssrc;let d;const c=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));c.length>0&&c[0].length>1&&c[0][0]===a&&(d=c[0][1]),o.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&d&&(t.rtx={ssrc:d}),i.push(t),s&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:r?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&a&&i.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=l}))),i},t.parseRtcpParameters=function(e){const i={},o=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];o&&(i.cname=o.value,i.ssrc=o.ssrc);const s=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=0===s.length;const r=t.matchPrefix(e,"a=rtcp-mux");return i.mux=r.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const o=t.matchPrefix(e,"a=msid:");if(1===o.length)return i=o[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),o=t.matchPrefix(e,"a=max-message-size:");let s;o.length>0&&(s=parseInt(o[0].substring(19),10)),isNaN(s)&&(s=65536);const r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const n=t.matchPrefix(e,"a=sctpmap:");if(n.length>0){const e=n[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:s}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,i,o){let s;const r=void 0!==i?i:2;s=e||t.generateSessionId();return"v=0\r\no="+(o||"thisisadapterortc")+" "+s+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const o=t.splitLines(e);for(let t=0;t<o.length;t++)switch(o[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return o[t].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const i=t.splitLines(e);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},e.exports=t}(ag);var dg=ag.exports,cg=i(dg),lg=e({__proto__:null,default:cg},[dg]);function ug(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const i=new t(e),o=cg.parseCandidate(e.candidate);for(const e in o)e in i||Object.defineProperty(i,e,{value:o[e]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,Sf(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function hg(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||Sf(e,"icecandidate",(e=>{if(e.candidate){const t=cg.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function mg(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=cg.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=cg.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i}(arguments[0]),i=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i}(e),o=function(e,i){let o=65536;"firefox"===t.browser&&57===t.version&&(o=65535);const s=cg.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?o=parseInt(s[0].substring(19),10):"firefox"===t.browser&&-1!==i&&(o=2147483637),o}(arguments[0],e);let s;s=0===i&&0===o?Number.POSITIVE_INFINITY:0===i||0===o?Math.max(i,o):Math.min(i,o);const r={};Object.defineProperty(r,"maxMessageSize",{get:()=>s}),this._sctp=r}return i.apply(this,arguments)}}function pg(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e),e},Sf(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function _g(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function bg(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==dm(e).call(e))).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function vg(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Sg(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>i.apply(this,[e])))})}var yg=Object.freeze({__proto__:null,removeExtmapAllowMixed:bg,shimAddIceCandidateNullOrEmpty:vg,shimConnectionState:_g,shimMaxMessageSize:mg,shimParameterlessSetLocalDescription:Sg,shimRTCIceCandidate:ug,shimRTCIceCandidateRelayProtocol:hg,shimSendThrowTypeError:pg});if(function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=gf,o=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=vf(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=vf(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=vf(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),s={browserDetails:o,commonShim:yg,extractVersion:vf,disableLog:yf,disableWarnings:ff,sdp:lg};switch(o.browser){case"chrome":if(!Mf||!Gf||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),s;if(null===o.version)return i("Chrome shim can not determine version, not shimming."),s;i("adapter.js shimming chrome."),s.browserShim=Mf,vg(e,o),Sg(e),Lf(e,o),Pf(e),Gf(e,o),kf(e),xf(e,o),Nf(e),Xf(e),Vf(e),Wf(e,o),ug(e),hg(e),_g(e),mg(e,o),pg(e),bg(e,o);break;case"firefox":if(!Qf||!Df||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),s;i("adapter.js shimming firefox."),s.browserShim=Qf,vg(e,o),Sg(e),Af(e,o),Df(e,o),Of(e),Uf(e),Yf(e),Kf(e),Ff(e),Hf(e),Jf(e),zf(e),jf(e),ug(e),_g(e),mg(e,o),pg(e);break;case"safari":if(!ng||!t.shimSafari)return i("Safari shim is not included in this adapter release."),s;i("adapter.js shimming safari."),s.browserShim=ng,vg(e,o),Sg(e),ig(e),sg(e),$f(e),Bf(e),qf(e),og(e),eg(e),rg(e),ug(e),hg(e),mg(e,o),pg(e),bg(e,o);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window}),"undefined"!=typeof MediaStreamTrack){const e=MediaStreamTrack.prototype.getSettings;MediaStreamTrack.prototype.getSettings=function(){const t=e.call(this);return t.width&&(t.width=Math.floor(t.width)),t.height&&(t.height=Math.floor(t.height)),t.frameRate&&(t.frameRate=Math.floor(t.frameRate)),t}}var fg=Ce,gg=TypeError,Tg=Bo,Ig=Math.floor,Rg=function(e,t){var i=e.length;if(i<8)for(var o,s,r=1;r<i;){for(s=r,o=e[r];s&&t(e[s-1],o)>0;)e[s]=e[--s];s!==r++&&(e[s]=o)}else for(var n=Ig(i/2),a=Rg(Tg(e,0,n),t),d=Rg(Tg(e,n),t),c=a.length,l=d.length,u=0,h=0;u<c||h<l;)e[u+h]=u<c&&h<l?t(a[u],d[h])<=0?a[u++]:d[h++]:u<c?a[u++]:d[h++];return e},Eg=Rg,Cg=ae.match(/firefox\/(\d+)/i),Zg=!!Cg&&+Cg[1],Lg=/MSIE|Trident/.test(ae),Pg=ae.match(/AppleWebKit\/(\d+)\./),kg=!!Pg&&+Pg[1],Ng=ki,Xg=b,Vg=ke,wg=Be,xg=Yi,Gg=function(e,t){if(!delete e[t])throw new gg("Cannot delete property "+fg(t)+" of "+fg(e))},Wg=fo,Mg=r,Ag=Eg,Og=Sd,Dg=Zg,Yg=Lg,Kg=pe,Ug=kg,Fg=[],Hg=Xg(Fg.sort),Jg=Xg(Fg.push),zg=Mg((function(){Fg.sort(void 0)})),jg=Mg((function(){Fg.sort(null)})),Qg=Og("sort"),Bg=!Mg((function(){if(Kg)return Kg<70;if(!(Dg&&Dg>3)){if(Yg)return!0;if(Ug)return Ug<603;var e,t,i,o,s="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(o=0;o<47;o++)Fg.push({k:t+o,v:i})}for(Fg.sort((function(e,t){return t.v-e.v})),o=0;o<Fg.length;o++)t=Fg[o].k.charAt(0),s.charAt(s.length-1)!==t&&(s+=t);return"DGBEFHACIJK"!==s}}));Ng({target:"Array",proto:!0,forced:zg||!jg||!Qg||!Bg},{sort:function(e){void 0!==e&&Vg(e);var t=wg(this);if(Bg)return void 0===e?Hg(t):Hg(t,e);var i,o,s=[],r=xg(t);for(o=0;o<r;o++)o in t&&Jg(s,t[o]);for(Ag(s,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:Wg(t)>Wg(i)?1:-1}}(e)),i=xg(s),o=0;o<i;)t[o]=s[o++];for(;o<r;)Gg(t,o++);return t}});var qg=Oa("Array","sort"),$g=se,eT=qg,tT=Array.prototype,iT=i((function(e){var t=e.sort;return e===tT||$g(tT,e)&&t===tT.sort?eT:t})),oT={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function o(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function r(e,t,o,r,n){if("function"!=typeof o)throw new TypeError("The listener must be a function");var a=new s(o,r||e,n),d=i?i+t:t;return e._events[d]?e._events[d].fn?e._events[d]=[e._events[d],a]:e._events[d].push(a):(e._events[d]=a,e._eventsCount++),e}function n(e,t){0==--e._eventsCount?e._events=new o:delete e._events[t]}function a(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,o,s=[];if(0===this._eventsCount)return s;for(o in e=this._events)t.call(e,o)&&s.push(i?o.slice(1):o);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=i?i+e:e,o=this._events[t];if(!o)return[];if(o.fn)return[o.fn];for(var s=0,r=o.length,n=new Array(r);s<r;s++)n[s]=o[s].fn;return n},a.prototype.listenerCount=function(e){var t=i?i+e:e,o=this._events[t];return o?o.fn?1:o.length:0},a.prototype.emit=function(e,t,o,s,r,n){var a=i?i+e:e;if(!this._events[a])return!1;var d,c,l=this._events[a],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,o),!0;case 4:return l.fn.call(l.context,t,o,s),!0;case 5:return l.fn.call(l.context,t,o,s,r),!0;case 6:return l.fn.call(l.context,t,o,s,r,n),!0}for(c=1,d=new Array(u-1);c<u;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d)}else{var h,m=l.length;for(c=0;c<m;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),u){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,o);break;case 4:l[c].fn.call(l[c].context,t,o,s);break;default:if(!d)for(h=1,d=new Array(u-1);h<u;h++)d[h-1]=arguments[h];l[c].fn.apply(l[c].context,d)}}return!0},a.prototype.on=function(e,t,i){return r(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return r(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,o,s){var r=i?i+e:e;if(!this._events[r])return this;if(!t)return n(this,r),this;var a=this._events[r];if(a.fn)a.fn!==t||s&&!a.once||o&&a.context!==o||n(this,r);else{for(var d=0,c=[],l=a.length;d<l;d++)(a[d].fn!==t||s&&!a[d].once||o&&a[d].context!==o)&&c.push(a[d]);c.length?this._events[r]=1===c.length?c[0]:c:n(this,r)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&n(this,t)):(this._events=new o,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a}(oT);var sT=oT.exports,rT=i(sT);const nT=new eS("VERTC",0);class aT extends sT.EventEmitter{safeEmit(e){const t=this.listenerCount(e);try{for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];return super.emit(e,...o)}catch(BW){return nT.error("safeEmit","safeEmit() | event listener threw an error [event:%s]:%o",e,BW),console.error(BW),Boolean(t)}}async asyncEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];await Promise.resolve().then((()=>{try{super.emit(e,...i)}catch(BW){nT.error("safeEmit","safeEmit() | event listener threw an error [event:%s]:%o",e,BW),console.error(BW)}}))}}var dT=(e=>(e[e.BLACK=0]="BLACK",e[e.NORMAL=1]="NORMAL",e))(dT||{}),cT=(e=>(e.streamRemovedBySchedule308="stream removed",e.clientRePublish="client republish",e.publishStreamFaied="publish failed",e.clientUnPublish="client unpublished",e.clientDisconnected="client disconnected",e.videoMuted="video muted",e))(cT||{}),lT=(e=>(e.PushLimitWarn="PushLimitWarn",e.OTHER="OTHER",e))(lT||{}),uT=(e=>(e.CHANGE_CODEC="changeCodec",e))(uT||{}),hT=(e=>(e.ON_ADD_STREAM="onAddStream",e.ON_ADD_STREAM_LIST="onAddStreamList",e.ON_REMOVE_STREAM="onRemoveStream",e.ON_REMOVE_STREAM_LIST="onRemoveStreamList",e.USER_DISCONNECTION="userDisconnection",e.USER_DISCONNECTION_LIST="userDisconnectionList",e.USER_CONNECTION="userConnection",e.USER_CONNECTION_LIST="userConnectionList",e.ON_UPDATE_STREAM_ATTRIBUTES="onUpdateStreamAttributes",e.ON_UPDATE_ROOM_ATTRIBUTES="onUpdateRoomAttributes",e.ON_UPDATE_USER_ATTRIBUTES="onUpdateUserAttributes",e.ON_PUSH_TRACK="onPushTrack",e.ON_REMOVE_TRACK="onRemoveTrack",e.ON_CUSTOM_MESSAGE="onCustomMessage",e.NODE_CHANGE="nodeChange",e.USER_MESSAGE_RECEIVED="userMessageReceived",e.USER_BINARY_MESSAGE_RECEIVED="userBinaryMessageReceived",e.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM="userMessageReceivedOutsideRoom",e.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM="userBinaryMessageReceivedOutsideRoom",e.POST_PROCESSING_MESSAGE="postProcessingMessage",e.ON_USER_TOKEN_WILL_EXPIRE="onUserTokenWillExpire",e.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE="onTokenPublishPrivilegeWillExpire",e.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED="onTokenPublishPrivilegeDidExpired",e.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE="onTokenSubscribePrivilegeWillExpire",e.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED="onTokenSubscribePrivilegeDidExpired",e.STREAM_CONTROL_MESSAGE="streamControlMessage",e.ON_SPEAKER_CHANGE="onSpeakerChange",e.ON_STREAM_FAILED="streamFailed",e.ON_NOTIFY_RECONNECT="notifyReconnect",e.ON_FORWARD_DST_ROOM_USER_KICK="onForwardDstRoomUserKick",e.ENGINE_CONTROL_MESSAGE="engineControlMessage",e.ON_STREAM_PUSHED_BY_OTHER="onStreamPushedByOther",e.ON_STREAM_PULL_STATE_CHANGED="onStreamPullStateChanged",e))(hT||{}),mT=(e=>(e.RSCP="RSCP",e.RTT="RTT",e.SSC="SSC",e))(mT||{}),pT=(e=>(e.ON_CONNECTION_STATE_CHANGE="onConnectionStateChange",e.ON_VENDOR_CONNECTION_STATE_CHANGE="onVendorConnectionStateChange",e.ABNORMAL_DISCONNECTION="normalConnection",e.ON_RECONNECT_FAILED="onReconnectFailed",e.CONNECT_WITH_TCP="onIceConnectWithTcp",e))(pT||{}),_T=(e=>(e.userLeave="userLeave",e.connectionLost="connectionLost",e.userDuplicateLogin="userDuplicateLogin",e.kickedByAdmin="kickedByAdmin",e.roleChanged="roleChanged",e.onUserTokenDidExpire="onUserTokenDidExpire",e))(_T||{}),bT=(e=>(e[e.roomDismissByAdmin=2]="roomDismissByAdmin",e))(bT||{}),vT=(e=>(e[e.LIMIT_MODE=1]="LIMIT_MODE",e[e.NORMAL_MODE=2]="NORMAL_MODE",e))(vT||{}),ST=(e=>(e[e.NORMAL=0]="NORMAL",e[e.BLACK=1]="BLACK",e))(ST||{}),yT=(e=>(e[e.EXTERNAL=0]="EXTERNAL",e[e.INTERNAL=1]="INTERNAL",e))(yT||{}),fT=(e=>(e.AUDIO="audio",e.VIDEO="video",e))(fT||{}),gT=(e=>(e.MAIN="main",e.SCREEN="screen",e.PUBLIC="public",e.VIRTUAL="virtual",e))(gT||{});class TT extends aT{constructor(e,t,i){super(),Ou(this,"trackId",Vy()),Ou(this,"_logger",void 0),Ou(this,"trackInfo",void 0),Ou(this,"_originTrack",void 0),Ou(this,"_channelCount",void 0),this._ctx=e,this._logger=new eS("Track",4,e.id),this.trackInfo=i,this._originTrack=t,this._channelCount=t.getSettings().channelCount}get dummy(){return this.trackInfo.isDummy}get virtual(){return"virtual"===this.trackInfo.streamIndex}get isScreen(){return"screen"===this.trackInfo.streamIndex}get isPublic(){return"public"===this.trackInfo.streamIndex}get sourceType(){return this.trackInfo.sourceType}get mediaType(){return this.trackInfo.mediaType}get captureSessionId(){return this.trackInfo.captureSessionId}get streamIndex(){const{streamIndex:e}=this.trackInfo;return"main"===e?qu.STREAM_INDEX_MAIN:"screen"===e?qu.STREAM_INDEX_SCREEN:void 0}get channelCount(){var e;return null!==(e=this._channelCount)&&void 0!==e?e:0}get originTrack(){return this._originTrack}set originTrack(e){this._originTrack=e,this._channelCount=mediaTrack.getSettings().channelCount}get logger(){return this._logger.module=this.constructor.name,this._logger}destroy(){this._originTrack.stop()}}class IT extends TT{constructor(e,t,i){super(e,t,i),Ou(this,"_mediaTrack",void 0),Ou(this,"_preProcessingTrack",void 0),Ou(this,"isTrackReady",void 0),Ou(this,"handleTrackEnded",(()=>{this.emit("track-ended",this),this.destroy()})),Ou(this,"handleMute",(()=>{this.emit("track-mute",this)})),Ou(this,"handleUnmute",(()=>{this.emit("track-unmute",this)})),this._initListeners(),this.isTrackReady=this.generatePreProcessingTrack()}get mediaTrack(){var e;return null!==(e=this._mediaTrack)&&void 0!==e?e:this._originTrack}set mediaTrack(e){this.mediaTrack.id!==e.id&&(this._mediaTrack=e,this.isTrackReady=this.generatePreProcessingTrack())}get preprocessingTrack(){var e;return null!==(e=this._preProcessingTrack)&&void 0!==e?e:this.mediaTrack}async generatePreProcessingTrack(){var e;const t=null===(e=this._preProcessingTrack)||void 0===e?void 0:e.id;this._preProcessingTrack=void 0;try{const e=await this._ctx.extensionManager.getPreProcessingTrack(this);e instanceof MediaStreamTrack&&(this._preProcessingTrack=e,t!==this._preProcessingTrack.id&&setTimeout((()=>{this.emit("needReplaceTrack")})))}catch(i){console.error(i)}}destroy(){var e,t;this._originTrack.removeEventListener("ended",this.handleTrackEnded),this._originTrack.removeEventListener("mute",this.handleMute),this._originTrack.removeEventListener("unmute",this.handleUnmute),null===(e=this._preProcessingTrack)||void 0===e||e.stop(),null===(t=this._mediaTrack)||void 0===t||t.stop(),super.destroy()}_initListeners(){this._originTrack instanceof MediaStreamTrack&&(this._originTrack.addEventListener("ended",this.handleTrackEnded),this._originTrack.addEventListener("mute",this.handleMute),this._originTrack.addEventListener("unmute",this.handleUnmute))}}class RT extends TT{constructor(e,t,i){super(e,t,i),Ou(this,"_mediaTrack",void 0),this._originTrack=t}get mediaTrack(){var e;return null!==(e=this._mediaTrack)&&void 0!==e?e:this._originTrack}set mediaTrack(e){this.mediaTrack.id!==e.id&&(this._mediaTrack=e)}get preprocessingTrack(){return this.mediaTrack}}var ET=s;ki({global:!0,forced:ET.globalThis!==ET},{globalThis:ET});var CT=i(s),ZT=(e=>(e.H264="H264",e.VP8="VP8",e.ByteVC1="ByteVC1",e))(ZT||{});const LT=async()=>{const e=[];return await AT()&&await MT()&&e.push(ZT.ByteVC1),await xT()&&await wT()&&e.push(ZT.H264),await WT()&&await GT()&&e.push(ZT.VP8),e},PT={};function kT(e){const t=e.split("\n");let i=!1;for(const o of t)if(o.includes("level-asymmetry-allowed=1")&&o.includes("packetization-mode=1")&&o.includes("profile-level-id=42e0")){i=!0;break}if(i){const e=navigator.userAgent.toLowerCase();let t=!1;const i=[/miuibrowser/,/70.*HeyTapBrowser/i];for(const o of i)o.test(e)&&(t=!0);return!t}return!1}const NT=async e=>{const t=new RTCPeerConnection({sdpSemantics:"unified-plan"});t.addTransceiver("video",{direction:e});const i=await t.createOffer();return t.close(),i.sdp.toLowerCase()},XT=async()=>{let e=await NT("sendonly");return navigator.userAgent.includes("VivoBrowser")&&(e=await NT("sendonly")),PT.h264encode=kT(e),PT.vp8encode=e.indexOf("vp8")>-1,PT.h265encode=e.indexOf("h265")>-1,PT},VT=async()=>{let e=await NT("recvonly");return navigator.userAgent.includes("VivoBrowser")&&(e=await NT("recvonly")),PT.h264decode=kT(e),PT.vp8decode=e.indexOf("vp8")>-1,PT.h265decode=e.indexOf("h265")>-1,PT},wT=async()=>{if(void 0===PT.h264encode)try{await XT()}catch(e){return!1}return PT.h264encode||!1},xT=async()=>{if(void 0===PT.h264decode)try{await VT()}catch(e){return!1}return PT.h264decode||!1},GT=async()=>{if(void 0===PT.vp8encode)try{await XT()}catch(e){return!1}return PT.vp8encode||!1},WT=async()=>{if(void 0===PT.vp8decode)try{await VT()}catch(e){return!1}return PT.vp8decode||!1},MT=async()=>{if(void 0===PT.h265encode)try{await XT()}catch(e){return!1}return PT.h265encode||!1},AT=async()=>{if(void 0===PT.h265decode)try{await VT()}catch(e){return!1}return PT.h265decode||!1},OT=()=>"undefined"!=typeof TransformStream&&"undefined"!=typeof RTCRtpSender&&"undefined"!=typeof RTCRtpReceiver&&"undefined"!=typeof RTCRtpScriptTransform&&"transform"in RTCRtpSender.prototype&&"transform"in RTCRtpReceiver.prototype&&zT()&&QT(),DT=()=>"undefined"!=typeof TransformStream&&"undefined"!=typeof RTCRtpSender&&"undefined"!=typeof RTCRtpReceiver&&void 0!==RTCRtpSender.prototype.createEncodedStreams&&void 0!==RTCRtpReceiver.prototype.createEncodedStreams,YT=()=>_S?nS&&VS>=70||sS&&LS>=80||rS&&ZS>=14:fS?nS&&VS>=70||sS&&LS>=80:SS?kS[0]>=14:!(!yS&&!gS)&&(nS&&VS>=86),KT=nS&&VS<=114,UT=!sS||LS>=96,FT=!(rS&&ZS<=14),HT=yS&&nS||SS&&(17===kS[0]||16===kS[0]),JT=void 0!==CT&&"PressureObserver"in CT,zT=()=>"undefined"!=typeof window&&window.Worker,jT=!(rS&&ZS<=14),QT=()=>"undefined"!=typeof MessageChannel;var BT=(e=>(e[e.internal=0]="internal",e[e.external=1]="external",e[e.bypass=2]="bypass",e))(BT||{});const qT=new Uint8Array([109,167,53,190,103,90,72,1,170,89,63,164,194,199,19,85]),$T=new Uint8Array([109,167,53,190,103,90,72,1,170,89,63,164,194,199,19,84]),eI=new Uint8Array([31,239,3,50,242,120,76,85,169,42,161,91,75,186,22]);function tI(e){const t=[];for(;e>=255;)e-=255,t.push(255);return t.push(e),new Uint8Array(t)}function iI(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;for(;255===e[t]&&t<e.byteLength;)t++,i+=255;return t<e.byteLength&&(i+=e[t++]),[i,t]}const oI=new Uint8Array([80,1]);class sI{static generateSEI(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o=new Uint8Array([0,0,0,1]),s=t?oI:new Uint8Array([6]),r=new Uint8Array([5]),n=sI.__uuid||(i?qT:$T),a=tI(e.byteLength+n.byteLength),d=(e=>{const t=[];let i=0;for(const o of e)i>=2&&o<=3&&(t.push(3),i=0),0===o?i++:i=0,t.push(o);return new Uint8Array(t)})(e);return new Uint8Array([...o,...s,...r,...a,...n,...d,128])}static decodeSEIBody(e,t){const i=(e=>{const t=[];for(let i=0;i<e.length;i++)e[i]<=3&&0===e[i-1]&&0===e[i-2]||t.push(e[i]);return new Uint8Array(t)})(e=e.slice(0,e.length-1));if(i.byteLength<2)return;let o=0;const s=t?2:1;if(5!==i[s]&&100!==i[s])return;o+=1+s;const[r,n]=iI(i,o);o=n;let a=2;const d=o+r;i.byteLength>=$T.byteLength&&r>=$T.byteLength&&(i.slice(o,o+$T.byteLength).toString()===$T.toString()||i.slice(o,o+eI.byteLength).toString()===eI.toString())?(o+=$T.byteLength,a=1):i.byteLength>=$T.byteLength&&r>=$T.byteLength&&i.slice(o,o+qT.byteLength).toString()===qT.toString()&&(o+=qT.byteLength,a=0);return{type:a,payload:i.slice(o,d)}}static parseInternalSEI(e){const t=new Map;let i=0;if(0===e.type){for(;e.payload.byteLength-i>=2;){const[o,s]=iI(e.payload,i);i=s;const[r,n]=iI(e.payload,i);if(i=n,t.get(o)||!(r<=e.payload.byteLength-i))break;t.set(o,e.payload.slice(i,i+r)),i+=r}return t}}static makeInternalSei(e){const t=[];for(const[s,r]of e){const e=tI(s),i=tI(r.byteLength);t.push(e,i,r)}const i=t.reduce(((e,t)=>e+t.byteLength),0),o=new Uint8Array(i);return t.reduce(((e,t)=>(o.set(t,e),e+t.byteLength)),0),o}}Ou(sI,"__uuid",void 0);var rI=ki,nI=b,aI=Mi,dI=RangeError,cI=String.fromCharCode,lI=String.fromCodePoint,uI=nI([].join);rI({target:"String",stat:!0,arity:1,forced:!!lI&&1!==lI.length},{fromCodePoint:function(e){for(var t,i=[],o=arguments.length,s=0;o>s;){if(t=+arguments[s++],aI(t,1114111)!==t)throw new dI(t+" is not a valid code point");i[s]=t<65536?cI(t):cI(55296+((t-=65536)>>10),t%1024+56320)}return uI(i,"")}});var hI=s,mI=Z,pI=Object.getOwnPropertyDescriptor,_I=function(e){if(!mI)return hI[e];var t=pI(hI,e);return t&&t.value},bI=r,vI=Ae,SI=pt("iterator"),yI=!bI((function(){var e=new URL("b?a=1&b=2&c=3","https://a"),t=e.searchParams,i=new URLSearchParams("a=1&a=2&b=3"),o="";return e.pathname="c%20d",t.forEach((function(e,i){t.delete("b"),o+=i+e})),i.delete("a",2),i.delete("b",void 0),!e.toJSON||!i.has("a",1)||i.has("a",2)||!i.has("a",void 0)||i.has("b")||!t.size&&vI||!t.sort||"https://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[SI]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("https://ÑÐµÑÑ").host||"#%D0%B1"!==new URL("https://a#Ð±").hash||"a1c3"!==o||"x"!==new URL("https://x",void 0).host})),fI=rs,gI=se,TI=TypeError,II=function(e,t){if(gI(t,e))return e;throw new TI("Incorrect invocation")},RI=vo,EI=Ve,CI=K,ZI=Ec,LI=pt("iterator"),PI=function(e){if(!CI(e))return EI(e,LI)||EI(e,"@@iterator")||ZI[RI(e)]},kI=k,NI=ke,XI=si,VI=Ce,wI=PI,xI=TypeError,GI=function(e,t){var i=arguments.length<2?wI(e):t;if(NI(i))return XI(kI(i,e));throw new xI(VI(e)+" is not iterable")},WI=TypeError,MI=function(e,t){if(e<t)throw new WI("Not enough arguments");return e},AI=ki,OI=s,DI=_I,YI=oe,KI=k,UI=b,FI=Z,HI=yI,JI=rs,zI=as,jI=function(e,t,i){for(var o in t)i&&i.unsafe&&e[o]?e[o]=t[o]:fI(e,o,t[o],i);return e},QI=Ns,BI=ol,qI=Js,$I=II,eR=E,tR=et,iR=qt,oR=vo,sR=si,rR=B,nR=fo,aR=Ho,dR=W,cR=GI,lR=PI,uR=Xl,hR=MI,mR=Eg,pR=pt("iterator"),_R="URLSearchParams",bR=_R+"Iterator",vR=qI.set,SR=qI.getterFor(_R),yR=qI.getterFor(bR),fR=DI("fetch"),gR=DI("Request"),TR=DI("Headers"),IR=gR&&gR.prototype,RR=TR&&TR.prototype,ER=OI.TypeError,CR=OI.encodeURIComponent,ZR=String.fromCharCode,LR=YI("String","fromCodePoint"),PR=parseInt,kR=UI("".charAt),NR=UI([].join),XR=UI([].push),VR=UI("".replace),wR=UI([].shift),xR=UI([].splice),GR=UI("".split),WR=UI("".slice),MR=UI(/./.exec),AR=/\+/g,OR=/^[0-9a-f]+$/i,DR=function(e,t){var i=WR(e,t,t+2);return MR(OR,i)?PR(i,16):NaN},YR=function(e){for(var t=0,i=128;i>0&&e&i;i>>=1)t++;return t},KR=function(e){var t=null;switch(e.length){case 1:t=e[0];break;case 2:t=(31&e[0])<<6|63&e[1];break;case 3:t=(15&e[0])<<12|(63&e[1])<<6|63&e[2];break;case 4:t=(7&e[0])<<18|(63&e[1])<<12|(63&e[2])<<6|63&e[3]}return t>1114111?null:t},UR=function(e){for(var t=(e=VR(e,AR," ")).length,i="",o=0;o<t;){var s=kR(e,o);if("%"===s){if("%"===kR(e,o+1)||o+3>t){i+="%",o++;continue}var r=DR(e,o+1);if(r!=r){i+=s,o++;continue}o+=2;var n=YR(r);if(0===n)s=ZR(r);else{if(1===n||n>4){i+="ï¿½",o++;continue}for(var a=[r],d=1;d<n&&!(++o+3>t||"%"!==kR(e,o));){var c=DR(e,o+1);if(c!=c){o+=3;break}if(c>191||c<128)break;XR(a,c),o+=2,d++}if(a.length!==n){i+="ï¿½";continue}var l=KR(a);null===l?i+="ï¿½":s=LR(l)}}i+=s,o++}return i},FR=/[!'()~]|%20/g,HR={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},JR=function(e){return HR[e]},zR=function(e){return VR(CR(e),FR,JR)},jR=BI((function(e,t){vR(this,{type:bR,target:SR(e).entries,index:0,kind:t})}),_R,(function(){var e=yR(this),t=e.target,i=e.index++;if(!t||i>=t.length)return e.target=null,uR(void 0,!0);var o=t[i];switch(e.kind){case"keys":return uR(o.key,!1);case"values":return uR(o.value,!1)}return uR([o.key,o.value],!1)}),!0),QR=function(e){this.entries=[],this.url=null,void 0!==e&&(rR(e)?this.parseObject(e):this.parseQuery("string"==typeof e?"?"===kR(e,0)?WR(e,1):e:nR(e)))};QR.prototype={type:_R,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,i,o,s,r,n,a,d=this.entries,c=lR(e);if(c)for(i=(t=cR(e,c)).next;!(o=KI(i,t)).done;){if(r=(s=cR(sR(o.value))).next,(n=KI(r,s)).done||(a=KI(r,s)).done||!KI(r,s).done)throw new ER("Expected sequence with length 2");XR(d,{key:nR(n.value),value:nR(a.value)})}else for(var l in e)tR(e,l)&&XR(d,{key:l,value:nR(e[l])})},parseQuery:function(e){if(e)for(var t,i,o=this.entries,s=GR(e,"&"),r=0;r<s.length;)(t=s[r++]).length&&(i=GR(t,"="),XR(o,{key:UR(wR(i)),value:UR(NR(i,"="))}))},serialize:function(){for(var e,t=this.entries,i=[],o=0;o<t.length;)e=t[o++],XR(i,zR(e.key)+"="+zR(e.value));return NR(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var BR=function(){$I(this,qR);var e=vR(this,new QR(arguments.length>0?arguments[0]:void 0));FI||(this.size=e.entries.length)},qR=BR.prototype;if(jI(qR,{append:function(e,t){var i=SR(this);hR(arguments.length,2),XR(i.entries,{key:nR(e),value:nR(t)}),FI||this.length++,i.updateURL()},delete:function(e){for(var t=SR(this),i=hR(arguments.length,1),o=t.entries,s=nR(e),r=i<2?void 0:arguments[1],n=void 0===r?r:nR(r),a=0;a<o.length;){var d=o[a];if(d.key!==s||void 0!==n&&d.value!==n)a++;else if(xR(o,a,1),void 0!==n)break}FI||(this.size=o.length),t.updateURL()},get:function(e){var t=SR(this).entries;hR(arguments.length,1);for(var i=nR(e),o=0;o<t.length;o++)if(t[o].key===i)return t[o].value;return null},getAll:function(e){var t=SR(this).entries;hR(arguments.length,1);for(var i=nR(e),o=[],s=0;s<t.length;s++)t[s].key===i&&XR(o,t[s].value);return o},has:function(e){for(var t=SR(this).entries,i=hR(arguments.length,1),o=nR(e),s=i<2?void 0:arguments[1],r=void 0===s?s:nR(s),n=0;n<t.length;){var a=t[n++];if(a.key===o&&(void 0===r||a.value===r))return!0}return!1},set:function(e,t){var i=SR(this);hR(arguments.length,1);for(var o,s=i.entries,r=!1,n=nR(e),a=nR(t),d=0;d<s.length;d++)(o=s[d]).key===n&&(r?xR(s,d--,1):(r=!0,o.value=a));r||XR(s,{key:n,value:a}),FI||(this.size=s.length),i.updateURL()},sort:function(){var e=SR(this);mR(e.entries,(function(e,t){return e.key>t.key?1:-1})),e.updateURL()},forEach:function(e){for(var t,i=SR(this).entries,o=iR(e,arguments.length>1?arguments[1]:void 0),s=0;s<i.length;)o((t=i[s++]).value,t.key,this)},keys:function(){return new jR(this,"keys")},values:function(){return new jR(this,"values")},entries:function(){return new jR(this,"entries")}},{enumerable:!0}),JI(qR,pR,qR.entries,{name:"entries"}),JI(qR,"toString",(function(){return SR(this).serialize()}),{enumerable:!0}),FI&&zI(qR,"size",{get:function(){return SR(this).entries.length},configurable:!0,enumerable:!0}),QI(BR,_R),AI({global:!0,constructor:!0,forced:!HI},{URLSearchParams:BR}),!HI&&eR(TR)){var $R=UI(RR.has),eE=UI(RR.set),tE=function(e){if(rR(e)){var t,i=e.body;if(oR(i)===_R)return t=e.headers?new TR(e.headers):new TR,$R(t,"content-type")||eE(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),aR(e,{body:dR(0,nR(i)),headers:dR(0,t)})}return e};if(eR(fR)&&AI({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return fR(e,arguments.length>1?tE(arguments[1]):{})}}),eR(gR)){var iE=function(e){return $I(this,IR),new gR(e,arguments.length>1?tE(arguments[1]):{})};IR.constructor=iE,iE.prototype=IR,AI({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:iE})}}var oE,sE={URLSearchParams:BR,getState:SR},rE=Z,nE=b,aE=k,dE=r,cE=so,lE=os,uE=N,hE=Be,mE=Y,pE=Object.assign,_E=Object.defineProperty,bE=nE([].concat),vE=!pE||dE((function(){if(rE&&1!==pE({b:1},pE(_E({},"a",{enumerable:!0,get:function(){_E(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},i=Symbol("assign detection"),o="abcdefghijklmnopqrst";return e[i]=7,o.split("").forEach((function(e){t[e]=e})),7!==pE({},e)[i]||cE(pE({},t)).join("")!==o}))?function(e,t){for(var i=hE(e),o=arguments.length,s=1,r=lE.f,n=uE.f;o>s;)for(var a,d=mE(arguments[s++]),c=r?bE(cE(d),r(d)):cE(d),l=c.length,u=0;l>u;)a=c[u++],rE&&!aE(n,d,a)||(i[a]=d[a]);return i}:pE,SE=k,yE=si,fE=Ve,gE=function(e,t,i){var o,s;yE(e);try{if(!(o=fE(e,"return"))){if("throw"===t)throw i;return i}o=SE(o,e)}catch(BW){s=!0,o=BW}if("throw"===t)throw i;if(s)throw o;return yE(o),i},TE=si,IE=gE,RE=Ec,EE=pt("iterator"),CE=Array.prototype,ZE=function(e){return void 0!==e&&(RE.Array===e||CE[EE]===e)},LE=qt,PE=k,kE=Be,NE=function(e,t,i,o){try{return o?t(TE(i)[0],i[1]):t(i)}catch(BW){IE(e,"throw",BW)}},XE=ZE,VE=hr,wE=Yi,xE=Md,GE=GI,WE=PI,ME=Array,AE=b,OE=2147483647,DE=/[^\0-\u007E]/,YE=/[.\u3002\uFF0E\uFF61]/g,KE="Overflow: input needs wider integers to process",UE=RangeError,FE=AE(YE.exec),HE=Math.floor,JE=String.fromCharCode,zE=AE("".charCodeAt),jE=AE([].join),QE=AE([].push),BE=AE("".replace),qE=AE("".split),$E=AE("".toLowerCase),eC=function(e){return e+22+75*(e<26)},tC=function(e,t,i){var o=0;for(e=i?HE(e/700):e>>1,e+=HE(e/t);e>455;)e=HE(e/35),o+=36;return HE(o+36*e/(e+38))},iC=function(e){var t=[];e=function(e){for(var t=[],i=0,o=e.length;i<o;){var s=zE(e,i++);if(s>=55296&&s<=56319&&i<o){var r=zE(e,i++);56320==(64512&r)?QE(t,((1023&s)<<10)+(1023&r)+65536):(QE(t,s),i--)}else QE(t,s)}return t}(e);var i,o,s=e.length,r=128,n=0,a=72;for(i=0;i<e.length;i++)(o=e[i])<128&&QE(t,JE(o));var d=t.length,c=d;for(d&&QE(t,"-");c<s;){var l=OE;for(i=0;i<e.length;i++)(o=e[i])>=r&&o<l&&(l=o);var u=c+1;if(l-r>HE((OE-n)/u))throw new UE(KE);for(n+=(l-r)*u,r=l,i=0;i<e.length;i++){if((o=e[i])<r&&++n>OE)throw new UE(KE);if(o===r){for(var h=n,m=36;;){var p=m<=a?1:m>=a+26?26:m-a;if(h<p)break;var _=h-p,b=36-p;QE(t,JE(eC(p+_%b))),h=HE(_/b),m+=36}QE(t,JE(eC(h))),a=tC(n,u,c===d),n=0,c++}}n++,r++}return jE(t,"")},oC=ki,sC=Z,rC=yI,nC=s,aC=qt,dC=b,cC=rs,lC=as,uC=II,hC=et,mC=vE,pC=function(e){var t=kE(e),i=VE(this),o=arguments.length,s=o>1?arguments[1]:void 0,r=void 0!==s;r&&(s=LE(s,o>2?arguments[2]:void 0));var n,a,d,c,l,u,h=WE(t),m=0;if(!h||this===ME&&XE(h))for(n=wE(t),a=i?new this(n):ME(n);n>m;m++)u=r?s(t[m],m):t[m],xE(a,m,u);else for(a=i?new this:[],l=(c=GE(t,h)).next;!(d=PE(l,c)).done;m++)u=r?NE(c,s,[d.value,m],!0):d.value,xE(a,m,u);return a.length=m,a},_C=Bo,bC=Zu.codeAt,vC=function(e){var t,i,o=[],s=qE(BE($E(e),YE,"."),".");for(t=0;t<s.length;t++)i=s[t],QE(o,FE(DE,i)?"xn--"+iC(i):i);return jE(o,".")},SC=fo,yC=Ns,fC=MI,gC=sE,TC=Js,IC=TC.set,RC=TC.getterFor("URL"),EC=gC.URLSearchParams,CC=gC.getState,ZC=nC.URL,LC=nC.TypeError,PC=nC.parseInt,kC=Math.floor,NC=Math.pow,XC=dC("".charAt),VC=dC(/./.exec),wC=dC([].join),xC=dC(1..toString),GC=dC([].pop),WC=dC([].push),MC=dC("".replace),AC=dC([].shift),OC=dC("".split),DC=dC("".slice),YC=dC("".toLowerCase),KC=dC([].unshift),UC="Invalid scheme",FC="Invalid host",HC="Invalid port",JC=/[a-z]/i,zC=/[\d+-.a-z]/i,jC=/\d/,QC=/^0x/i,BC=/^[0-7]+$/,qC=/^\d+$/,$C=/^[\da-f]+$/i,eZ=/[\0\t\n\r #%/:<>?@[\\\]^|]/,tZ=/[\0\t\n\r #/:<>?@[\\\]^|]/,iZ=/^[\u0000-\u0020]+/,oZ=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,sZ=/[\t\n\r]/g,rZ=function(e){var t,i,o,s;if("number"==typeof e){for(t=[],i=0;i<4;i++)KC(t,e%256),e=kC(e/256);return wC(t,".")}if("object"==typeof e){for(t="",o=function(e){for(var t=null,i=1,o=null,s=0,r=0;r<8;r++)0!==e[r]?(s>i&&(t=o,i=s),o=null,s=0):(null===o&&(o=r),++s);return s>i?o:t}(e),i=0;i<8;i++)s&&0===e[i]||(s&&(s=!1),o===i?(t+=i?":":"::",s=!0):(t+=xC(e[i],16),i<7&&(t+=":")));return"["+t+"]"}return e},nZ={},aZ=mC({},nZ,{" ":1,'"':1,"<":1,">":1,"`":1}),dZ=mC({},aZ,{"#":1,"?":1,"{":1,"}":1}),cZ=mC({},dZ,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),lZ=function(e,t){var i=bC(e,0);return i>32&&i<127&&!hC(t,e)?e:encodeURIComponent(e)},uZ={ftp:21,file:null,http:80,https:443,ws:80,wss:443},hZ=function(e,t){var i;return 2===e.length&&VC(JC,XC(e,0))&&(":"===(i=XC(e,1))||!t&&"|"===i)},mZ=function(e){var t;return e.length>1&&hZ(DC(e,0,2))&&(2===e.length||"/"===(t=XC(e,2))||"\\"===t||"?"===t||"#"===t)},pZ=function(e){return"."===e||"%2e"===YC(e)},_Z={},bZ={},vZ={},SZ={},yZ={},fZ={},gZ={},TZ={},IZ={},RZ={},EZ={},CZ={},ZZ={},LZ={},PZ={},kZ={},NZ={},XZ={},VZ={},wZ={},xZ={},GZ=function(e,t,i){var o,s,r,n=SC(e);if(t){if(s=this.parse(n))throw new LC(s);this.searchParams=null}else{if(void 0!==i&&(o=new GZ(i,!0)),s=this.parse(n,null,o))throw new LC(s);(r=CC(new EC)).bindURL(this),this.searchParams=r}};GZ.prototype={type:"URL",parse:function(e,t,i){var o,s,r,n,a,d=this,c=t||_Z,l=0,u="",h=!1,m=!1,p=!1;for(e=SC(e),t||(d.scheme="",d.username="",d.password="",d.host=null,d.port=null,d.path=[],d.query=null,d.fragment=null,d.cannotBeABaseURL=!1,e=MC(e,iZ,""),e=MC(e,oZ,"$1")),e=MC(e,sZ,""),o=pC(e);l<=o.length;){switch(s=o[l],c){case _Z:if(!s||!VC(JC,s)){if(t)return UC;c=vZ;continue}u+=YC(s),c=bZ;break;case bZ:if(s&&(VC(zC,s)||"+"===s||"-"===s||"."===s))u+=YC(s);else{if(":"!==s){if(t)return UC;u="",c=vZ,l=0;continue}if(t&&(d.isSpecial()!==hC(uZ,u)||"file"===u&&(d.includesCredentials()||null!==d.port)||"file"===d.scheme&&!d.host))return;if(d.scheme=u,t)return void(d.isSpecial()&&uZ[d.scheme]===d.port&&(d.port=null));u="","file"===d.scheme?c=LZ:d.isSpecial()&&i&&i.scheme===d.scheme?c=SZ:d.isSpecial()?c=TZ:"/"===o[l+1]?(c=yZ,l++):(d.cannotBeABaseURL=!0,WC(d.path,""),c=VZ)}break;case vZ:if(!i||i.cannotBeABaseURL&&"#"!==s)return UC;if(i.cannotBeABaseURL&&"#"===s){d.scheme=i.scheme,d.path=_C(i.path),d.query=i.query,d.fragment="",d.cannotBeABaseURL=!0,c=xZ;break}c="file"===i.scheme?LZ:fZ;continue;case SZ:if("/"!==s||"/"!==o[l+1]){c=fZ;continue}c=IZ,l++;break;case yZ:if("/"===s){c=RZ;break}c=XZ;continue;case fZ:if(d.scheme=i.scheme,s===oE)d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=_C(i.path),d.query=i.query;else if("/"===s||"\\"===s&&d.isSpecial())c=gZ;else if("?"===s)d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=_C(i.path),d.query="",c=wZ;else{if("#"!==s){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=_C(i.path),d.path.length--,c=XZ;continue}d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=_C(i.path),d.query=i.query,d.fragment="",c=xZ}break;case gZ:if(!d.isSpecial()||"/"!==s&&"\\"!==s){if("/"!==s){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,c=XZ;continue}c=RZ}else c=IZ;break;case TZ:if(c=IZ,"/"!==s||"/"!==XC(u,l+1))continue;l++;break;case IZ:if("/"!==s&&"\\"!==s){c=RZ;continue}break;case RZ:if("@"===s){h&&(u="%40"+u),h=!0,r=pC(u);for(var _=0;_<r.length;_++){var b=r[_];if(":"!==b||p){var v=lZ(b,cZ);p?d.password+=v:d.username+=v}else p=!0}u=""}else if(s===oE||"/"===s||"?"===s||"#"===s||"\\"===s&&d.isSpecial()){if(h&&""===u)return"Invalid authority";l-=pC(u).length+1,u="",c=EZ}else u+=s;break;case EZ:case CZ:if(t&&"file"===d.scheme){c=kZ;continue}if(":"!==s||m){if(s===oE||"/"===s||"?"===s||"#"===s||"\\"===s&&d.isSpecial()){if(d.isSpecial()&&""===u)return FC;if(t&&""===u&&(d.includesCredentials()||null!==d.port))return;if(n=d.parseHost(u))return n;if(u="",c=NZ,t)return;continue}"["===s?m=!0:"]"===s&&(m=!1),u+=s}else{if(""===u)return FC;if(n=d.parseHost(u))return n;if(u="",c=ZZ,t===CZ)return}break;case ZZ:if(!VC(jC,s)){if(s===oE||"/"===s||"?"===s||"#"===s||"\\"===s&&d.isSpecial()||t){if(""!==u){var S=PC(u,10);if(S>65535)return HC;d.port=d.isSpecial()&&S===uZ[d.scheme]?null:S,u=""}if(t)return;c=NZ;continue}return HC}u+=s;break;case LZ:if(d.scheme="file","/"===s||"\\"===s)c=PZ;else{if(!i||"file"!==i.scheme){c=XZ;continue}switch(s){case oE:d.host=i.host,d.path=_C(i.path),d.query=i.query;break;case"?":d.host=i.host,d.path=_C(i.path),d.query="",c=wZ;break;case"#":d.host=i.host,d.path=_C(i.path),d.query=i.query,d.fragment="",c=xZ;break;default:mZ(wC(_C(o,l),""))||(d.host=i.host,d.path=_C(i.path),d.shortenPath()),c=XZ;continue}}break;case PZ:if("/"===s||"\\"===s){c=kZ;break}i&&"file"===i.scheme&&!mZ(wC(_C(o,l),""))&&(hZ(i.path[0],!0)?WC(d.path,i.path[0]):d.host=i.host),c=XZ;continue;case kZ:if(s===oE||"/"===s||"\\"===s||"?"===s||"#"===s){if(!t&&hZ(u))c=XZ;else if(""===u){if(d.host="",t)return;c=NZ}else{if(n=d.parseHost(u))return n;if("localhost"===d.host&&(d.host=""),t)return;u="",c=NZ}continue}u+=s;break;case NZ:if(d.isSpecial()){if(c=XZ,"/"!==s&&"\\"!==s)continue}else if(t||"?"!==s)if(t||"#"!==s){if(s!==oE&&(c=XZ,"/"!==s))continue}else d.fragment="",c=xZ;else d.query="",c=wZ;break;case XZ:if(s===oE||"/"===s||"\\"===s&&d.isSpecial()||!t&&("?"===s||"#"===s)){if(".."===(a=YC(a=u))||"%2e."===a||".%2e"===a||"%2e%2e"===a?(d.shortenPath(),"/"===s||"\\"===s&&d.isSpecial()||WC(d.path,"")):pZ(u)?"/"===s||"\\"===s&&d.isSpecial()||WC(d.path,""):("file"===d.scheme&&!d.path.length&&hZ(u)&&(d.host&&(d.host=""),u=XC(u,0)+":"),WC(d.path,u)),u="","file"===d.scheme&&(s===oE||"?"===s||"#"===s))for(;d.path.length>1&&""===d.path[0];)AC(d.path);"?"===s?(d.query="",c=wZ):"#"===s&&(d.fragment="",c=xZ)}else u+=lZ(s,dZ);break;case VZ:"?"===s?(d.query="",c=wZ):"#"===s?(d.fragment="",c=xZ):s!==oE&&(d.path[0]+=lZ(s,nZ));break;case wZ:t||"#"!==s?s!==oE&&("'"===s&&d.isSpecial()?d.query+="%27":d.query+="#"===s?"%23":lZ(s,nZ)):(d.fragment="",c=xZ);break;case xZ:s!==oE&&(d.fragment+=lZ(s,aZ))}l++}},parseHost:function(e){var t,i,o;if("["===XC(e,0)){if("]"!==XC(e,e.length-1))return FC;if(t=function(e){var t,i,o,s,r,n,a,d=[0,0,0,0,0,0,0,0],c=0,l=null,u=0,h=function(){return XC(e,u)};if(":"===h()){if(":"!==XC(e,1))return;u+=2,l=++c}for(;h();){if(8===c)return;if(":"!==h()){for(t=i=0;i<4&&VC($C,h());)t=16*t+PC(h(),16),u++,i++;if("."===h()){if(0===i)return;if(u-=i,c>6)return;for(o=0;h();){if(s=null,o>0){if(!("."===h()&&o<4))return;u++}if(!VC(jC,h()))return;for(;VC(jC,h());){if(r=PC(h(),10),null===s)s=r;else{if(0===s)return;s=10*s+r}if(s>255)return;u++}d[c]=256*d[c]+s,2!=++o&&4!==o||c++}if(4!==o)return;break}if(":"===h()){if(u++,!h())return}else if(h())return;d[c++]=t}else{if(null!==l)return;u++,l=++c}}if(null!==l)for(n=c-l,c=7;0!==c&&n>0;)a=d[c],d[c--]=d[l+n-1],d[l+--n]=a;else if(8!==c)return;return d}(DC(e,1,-1)),!t)return FC;this.host=t}else if(this.isSpecial()){if(e=vC(e),VC(eZ,e))return FC;if(t=function(e){var t,i,o,s,r,n,a,d=OC(e,".");if(d.length&&""===d[d.length-1]&&d.length--,(t=d.length)>4)return e;for(i=[],o=0;o<t;o++){if(""===(s=d[o]))return e;if(r=10,s.length>1&&"0"===XC(s,0)&&(r=VC(QC,s)?16:8,s=DC(s,8===r?1:2)),""===s)n=0;else{if(!VC(10===r?qC:8===r?BC:$C,s))return e;n=PC(s,r)}WC(i,n)}for(o=0;o<t;o++)if(n=i[o],o===t-1){if(n>=NC(256,5-t))return null}else if(n>255)return null;for(a=GC(i),o=0;o<i.length;o++)a+=i[o]*NC(256,3-o);return a}(e),null===t)return FC;this.host=t}else{if(VC(tZ,e))return FC;for(t="",i=pC(e),o=0;o<i.length;o++)t+=lZ(i[o],nZ);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"===this.scheme},includesCredentials:function(){return""!==this.username||""!==this.password},isSpecial:function(){return hC(uZ,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||"file"===this.scheme&&1===t&&hZ(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,i=e.username,o=e.password,s=e.host,r=e.port,n=e.path,a=e.query,d=e.fragment,c=t+":";return null!==s?(c+="//",e.includesCredentials()&&(c+=i+(o?":"+o:"")+"@"),c+=rZ(s),null!==r&&(c+=":"+r)):"file"===t&&(c+="//"),c+=e.cannotBeABaseURL?n[0]:n.length?"/"+wC(n,"/"):"",null!==a&&(c+="?"+a),null!==d&&(c+="#"+d),c},setHref:function(e){var t=this.parse(e);if(t)throw new LC(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if("blob"===e)try{return new WZ(e.path[0]).origin}catch(BW){return"null"}return"file"!==e&&this.isSpecial()?e+"://"+rZ(this.host)+(null!==t?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(SC(e)+":",_Z)},getUsername:function(){return this.username},setUsername:function(e){var t=pC(SC(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<t.length;i++)this.username+=lZ(t[i],cZ)}},getPassword:function(){return this.password},setPassword:function(e){var t=pC(SC(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<t.length;i++)this.password+=lZ(t[i],cZ)}},getHost:function(){var e=this.host,t=this.port;return null===e?"":null===t?rZ(e):rZ(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,EZ)},getHostname:function(){var e=this.host;return null===e?"":rZ(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,CZ)},getPort:function(){var e=this.port;return null===e?"":SC(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||(""===(e=SC(e))?this.port=null:this.parse(e,ZZ))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+wC(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,NZ))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){""===(e=SC(e))?this.query=null:("?"===XC(e,0)&&(e=DC(e,1)),this.query="",this.parse(e,wZ)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){""!==(e=SC(e))?("#"===XC(e,0)&&(e=DC(e,1)),this.fragment="",this.parse(e,xZ)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var WZ=function(e){var t=uC(this,MZ),i=fC(arguments.length,1)>1?arguments[1]:void 0,o=IC(t,new GZ(e,!1,i));sC||(t.href=o.serialize(),t.origin=o.getOrigin(),t.protocol=o.getProtocol(),t.username=o.getUsername(),t.password=o.getPassword(),t.host=o.getHost(),t.hostname=o.getHostname(),t.port=o.getPort(),t.pathname=o.getPathname(),t.search=o.getSearch(),t.searchParams=o.getSearchParams(),t.hash=o.getHash())},MZ=WZ.prototype,AZ=function(e,t){return{get:function(){return RC(this)[e]()},set:t&&function(e){return RC(this)[t](e)},configurable:!0,enumerable:!0}};if(sC&&(lC(MZ,"href",AZ("serialize","setHref")),lC(MZ,"origin",AZ("getOrigin")),lC(MZ,"protocol",AZ("getProtocol","setProtocol")),lC(MZ,"username",AZ("getUsername","setUsername")),lC(MZ,"password",AZ("getPassword","setPassword")),lC(MZ,"host",AZ("getHost","setHost")),lC(MZ,"hostname",AZ("getHostname","setHostname")),lC(MZ,"port",AZ("getPort","setPort")),lC(MZ,"pathname",AZ("getPathname","setPathname")),lC(MZ,"search",AZ("getSearch","setSearch")),lC(MZ,"searchParams",AZ("getSearchParams")),lC(MZ,"hash",AZ("getHash","setHash"))),cC(MZ,"toJSON",(function(){return RC(this).serialize()}),{enumerable:!0}),cC(MZ,"toString",(function(){return RC(this).serialize()}),{enumerable:!0}),ZC){var OZ=ZC.createObjectURL,DZ=ZC.revokeObjectURL;OZ&&cC(WZ,"createObjectURL",aC(OZ,ZC)),DZ&&cC(WZ,"revokeObjectURL",aC(DZ,ZC))}yC(WZ,"URL"),oC({global:!0,constructor:!0,forced:!rC,sham:!sC},{URL:WZ});var YZ=ki,KZ=r,UZ=MI,FZ=fo,HZ=yI,JZ=oe("URL"),zZ=HZ&&KZ((function(){JZ.canParse()})),jZ=KZ((function(){return 1!==JZ.canParse.length}));YZ({target:"URL",stat:!0,forced:!zZ||jZ},{canParse:function(e){var t=UZ(arguments.length,1),i=FZ(e),o=t<2||void 0===arguments[1]?void 0:FZ(arguments[1]);try{return!!new JZ(i,o)}catch(BW){return!1}}});var QZ=ki,BZ=MI,qZ=fo,$Z=yI,eL=oe("URL");QZ({target:"URL",stat:!0,forced:!$Z},{parse:function(e){var t=BZ(arguments.length,1),i=qZ(e),o=t<2||void 0===arguments[1]?void 0:qZ(arguments[1]);try{return new eL(i,o)}catch(BW){return null}}});var tL=i(q.URL);function iL(e){const t=PressureObserver.supportedSources;let i="thermal";i=null!=t&&t.includes("thermal")?"thermal":"cpu";const o=new PressureObserver((t=>{t.forEach((t=>{t.source===i&&e(t.state)}))}));return o.observe(i,{sampleInterval:2e3}),o}var oL=new class{constructor(){Ou(this,"_state",void 0),Ou(this,"_handler",!1)}init(){if((JT||!vy("DISABLE_COMPUTE_PRESSURE"))&&"UT"!=={}.VITE_TEST)try{if(zT()){const e=new Blob(["(".concat(iL.toString(),")(self.postMessage)")],{type:"text/javascript"}),t=new Worker(tL.createObjectURL(e));t.onmessage=e=>{this._state=e.data},this._handler=t}else this._handler=iL((e=>{this._state=e}))}catch(e){}}get state(){return By&&!bm()&&(window.thermal_status=this._state),this._handler||this.init(),this._state}};const sL=["codec","inbound-rtp","outbound-rtp","remote-inbound-rtp","remote-outbound-rtp","media-source","csrc","peer-connection","data-channel","stream","track","transceiver","sender","receiver","transport","sctp-transport","candidate-pair","local-candidate","remote-candidate","certificate","ice-server"],rL=new Map;let nL=!0;const aL=async e=>new Promise((t=>{const i={all:[],getTrackStats:()=>[]},o=vy("STATS_SCALLBACK_SUPPORT");if(nL&&nS&&void 0===window.InstallTrigger&&KT&&o)try{var s,r,n;null===(s=e.getStats((e=>{const i=[];e.result().forEach((e=>{if(sL.includes(e.type))return;const t={};e.names().forEach((function(i){t[i]=e.stat(i)})),i.push(Yu(Yu({},t),{},{id:e.id,type:e.type,timestamp:e.timestamp}))})),t({all:i,getTrackStats:e=>i.filter((t=>"ssrc"!==t.type||t.googTrackId===e))})})))||void 0===s||null===(r=s.then)||void 0===r||null===(r=r.call(s,(()=>{t(i)})))||void 0===r||null===(n=r.catch)||void 0===n||n.call(r,(()=>{nL=!1,t(i)}))}catch(a){nL=!1,t(i)}else t(i)})),dL=async e=>{var t;const i=await e.getStats(),o={all:[]},s=new Map;i.forEach((e=>{const t=s.get(e.type)||new Map;t.set(e.id,e),s.set(e.type,t),o.all.push(e)}));const r=(e,t)=>{e.forEach((e=>{var i,o,r,n;let a,d,{codecId:c,transportId:l,trackId:u,playoutId:h}=e;if(null===(i=s.get("codec"))||void 0===i||i.forEach((e=>{e.id===c&&t.add(e)})),null===(o=s.get("transport"))||void 0===o||o.forEach((e=>{e.id===l&&(a=e,t.add(e))})),null===(r=s.get("track"))||void 0===r||r.forEach((e=>{e.id===u&&t.add(e)})),null===(n=s.get("media-playout"))||void 0===n||n.forEach((e=>{e.id===h&&t.add(e)})),a){var m,p;const{localCertificateId:e,remoteCertificateId:i,selectedCandidatePairId:o}=a;null===(m=s.get("certificate"))||void 0===m||m.forEach((o=>{(o.id===e||o.id===i)&&t.add(o)})),null===(p=s.get("candidate-pair"))||void 0===p||p.forEach((e=>{e.id===o&&(d=e,t.add(e))}))}if(d){var _,b;const{localCandidateId:e,remoteCandidateId:i}=d;null===(_=s.get("local-candidate"))||void 0===_||_.forEach((i=>{i.id===e&&t.add(i)})),null===(b=s.get("remote-candidate"))||void 0===b||b.forEach((e=>{e.id===i&&t.add(e)}))}}))};var n;if(s.get("media-source"))null===(n=s.get("media-source"))||void 0===n||n.forEach((e=>{var t;const i=new Set;i.add(e);const n=[];null===(t=s.get("outbound-rtp"))||void 0===t||t.forEach((t=>{var o;t.mediaSourceId===e.id&&(i.add(t),n.push(t),null===(o=s.get("remote-inbound-rtp"))||void 0===o||o.forEach((e=>{e.localId===t.id&&i.add(e)})))})),r(n,i),o[e.trackIdentifier]=Array.from(i)}));else if(s.get("track")){var a;null===(a=s.get("track"))||void 0===a||a.forEach((e=>{var t;const i=new Set;i.add(e);const n=[];null===(t=s.get("outbound-rtp"))||void 0===t||t.forEach((t=>{var o;t.trackId===e.id&&(i.add(t),n.push(t),null===(o=s.get("remote-inbound-rtp"))||void 0===o||o.forEach((e=>{e.localId===t.id&&i.add(e)})))})),r(n,i),o[e.trackIdentifier]=Array.from(i)}))}return null===(t=s.get("inbound-rtp"))||void 0===t||t.forEach((e=>{var t;const i=new Set;i.add(e),null===(t=s.get("remote-outbound-rtp"))||void 0===t||t.forEach((t=>{t.localId===e.id&&i.add(t)})),r([e],i);let{trackIdentifier:n}=e;var a;n||(null===(a=s.get("track"))||void 0===a||a.forEach((t=>{t.id===e.trackId&&(n=t.trackIdentifier)})));o[n]=Array.from(i)})),o};class cL{constructor(e){Ou(this,"_timer",void 0),Ou(this,"_reportTimer",void 0),Ou(this,"handler",void 0),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),Ou(this,"_destroyed",!1),Ou(this,"_isReportStarted",!1),this._context=e,this._monitor=Nv(e.id),this.logger=new eS("Stats",3,e.id)}setVar(e){this.handler=e}stopReport(e){this._isReportStarted&&(this.logger.info("stopReport","invoke"),this._isReportStarted=!1,clearTimeout(this._reportTimer),delete this._reportTimer,Wv(this._context.id,"del_media_statistics_timer","reason: ".concat(e,", stack: ").concat((new Error).stack),0,this._stream.streamId||""))}filterIllegal(e){const t={};return Object.keys(e).forEach((i=>{null===e[i]||void 0===e[i]||Number.isNaN(e[i])||(t[i]=e[i])})),t}destroy(){this.logger.info("destroy","invoke"),Wv(this._context.id,"media_statistics_destroy","".concat((new Error).stack),0,"".concat(this._stream.streamId)),this.stopReport("destroy"),clearTimeout(this._timer),this._destroyed=!0}}class lL extends cL{constructor(e,t){super(e),Ou(this,"_stats",{audioStats:{},videoStats:{}}),Ou(this,"_preReports",{audio:{},video:{}}),this._stream=t;const i=async()=>{this._stats=await this._getLocalStats(this._stream,this._preReports,!1),this._destroyed||(this._timer=setTimeout(i,vy("STATS_LOOP_INTERVAL")))};i()}setLocalStreamStatsEvtInterval(e,t){if(this._isReportStarted)return;this.logger.info("setLocalStreamStatsEvtInterval","invoke"),this._isReportStarted=!0,this.setVar(t),this._destroyed=!1;const i={audio:{},video:{}},o=async()=>{const t=await this._getLocalStats(this._stream,i,!0);e(t),this._destroyed||(this._reportTimer=setTimeout(o,2e3))};o()}getLocalStats(){return this._stats}async _getLocalStats(e,t,i){var o,s,r,n,a,d,c;const l=void 0!==(null===(o=e.audioTrack)||void 0===o?void 0:o.mixType)&&e.audioTrack.mixType!==Nh.PLAYOUT?null!==(s=null===(r=e.audioTrack)||void 0===r?void 0:r.mixedAudioTrack)&&void 0!==s?s:null===(n=e.audioTrack)||void 0===n?void 0:n.preprocessingTrack:null===(a=e.audioTrack)||void 0===a?void 0:a.preprocessingTrack,u=null===(d=e.videoTrack)||void 0===d?void 0:d.preprocessingTrack;var h;0===Object.keys(t.audio).length&&0===Object.keys(t.video).length&&(await this.getAudioStats(l,t,null===(h=e.audioTrack)||void 0===h?void 0:h.getAudioLevel(),i),await this.getVideoStats(u,t,i),await Wy(150));return{audioStats:await this.getAudioStats(l,t,null===(c=e.audioTrack)||void 0===c?void 0:c.getAudioLevel(),i),videoStats:await this.getVideoStats(u,t,i),isScreen:e.isScreen}}async getAudioStats(e,t,i,o){var s,r,n;const a={},d={timestamp:Date.now()},{streamId:c,audioMid:l,isScreen:u,pubAttributes:h,pubAudio:m,audioTrack:p}=this._stream,_={media_type:"audio",is_screen:!!u,direction:"up",stream_id:c,vid:l,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,capture_state:h.localaudio?"capture_state_on":"capture_state_off",mute_state:m?"mute_state_off":"mute_state_on",thermal_status:oL.state};if(p&&(_.playback_volume=p.getVolume()),!e||!this.handler)return a;const b=await(null===(s=this.handler.peer)||void 0===s?void 0:s.getStatsWithLowFrequency(e,!1,null===(r=this._stream.audioTransceiver)||void 0===r?void 0:r.sender));if(!b.length)return a;if(b.forEach((e=>{let{type:t,packetsSent:i,packetsLost:o,bytesSent:s,clockRate:r,roundTripTime:n,channels:c,audioLevel:l,mimeType:u,availableIncomingBitrate:h,availableOutgoingBitrate:m,bytesReceived:p,nominated:b,id:v,currentRoundTripTime:S,state:y,writable:f,requestsReceived:g,responsesReceived:T,requestsSent:I,consentRequestsSent:R,responsesSent:E,jitter:C,candidateType:Z,ip:L,address:P,networkType:k,port:N,protocol:X,nackCount:V,retransmittedBytesSent:w,retransmittedPacketsSent:x,audioInputLevel:G,ssrc:W,totalAudioEnergy:M,totalSamplesDuration:A,mediaType:O,fractionLost:D}=e;"outbound-rtp"===t?(d.packetsSent=i,d.bytesSent=s,_.bytes=s,_.packetsSent=i,_.nackCount=V,_.ssrc=W,_.retransmitted_bytes_sent=w,_.retransmitted_packets_sent=x,d.retransmittedBytesSent=w,d.retransmittedPacketsSent=x):"remote-inbound-rtp"===t?(d.packetsLost=o,_.packetsLost=o,_.net_jitter=1e3*C,a.rtt=1e3*n,_.rtt=a.rtt,a._fractionLost=D||0):"codec"===t?(a.recordSampleRate=r,a.numChannels=c,_.codecName=u):"media-source"===t&&void 0!==l?(_.audio_level=l?-10*Math.log10(Math.pow(l,2)):l,_.volume=255*l,_.total_audio_energy=M,_.totalInputDuration=A,_.send_level||(_.send_level=l)):"ssrc"===t&&"audio"===O?G&&(_.send_level=G):"candidate-pair"===t?(_.ice_available_incoming_bitrate=h,_.ice_available_outgoing_bitrate=m,_.ice_bytes_received=p,_.ice_bytes_sent=s,_.ice_nominated=Number(b),_.ice_pair_id=v,_.ice_pair_rtt=S,_.ice_pair_state=y,_.ice_pair_writable=f,_.recv_ping_requests=g,_.recv_ping_responses=T,_.sent_ping_requests_before_first_response=I,_.sent_ping_requests_total=I+(R||0),_.sent_ping_responses=E):"local-candidate"===t?(_.local_candidate_type=Z,_.local_ip=L||P,_.local_network_type=k,_.local_port=N,_.protocol=X):"remote-candidate"===t&&(_.remote_candidate_type=Z,_.remote_ip=L||P,_.remote_port=N)})),_.send_level)_.send_level<1?_._sendVolumeLevel=32767*_.send_level:_._sendVolumeLevel=_.send_level;else{const e=(null==p?void 0:p.getAudioLevel())||0;_._sendVolumeLevel=Math.round(e/255*32767)}void 0===_.volume&&void 0!==i&&(_.volume=i,_.audio_level=i?-10*Math.log10(Math.pow(i/255,2)):i);const{audio:v}=t;if(!v.timestamp)return t.audio=d,this.filterIllegal(a);var S;(void 0!==d.packetsLost&&(a.audioLossRate=Math.max(0,d.packetsLost-v.packetsLost)/(d.packetsSent-v.packetsSent),a.audioLossRate=Number.isNaN(a.audioLossRate)?0:a.audioLossRate,_.fraction_lost=a.audioLossRate),a.statsInterval=d.timestamp-v.timestamp,_.stats_interval=a.statsInterval,a.sendKBitrate=(d.bytesSent-v.bytesSent||0)/a.statsInterval*8,_.mediaBitratebps=Math.round(1e3*a.sendKBitrate),_.bandwidth=Math.round(_.mediaBitratebps/1024),void 0!==d.retransmittedBytesSent&&(_.retransmitBitratebps=(d.retransmittedBytesSent-v.retransmittedBytesSent||0)/a.statsInterval),t.audio=d,_.vendor_mode=this._stream.vendorCode||0,_.pc_session_id=null===(n=this.handler)||void 0===n?void 0:n.peerConnectionId,o)&&(null===(S=this._monitor)||void 0===S||S.report("rtc_media_statistics",_));return a._retransmittedRate=(d.retransmittedPacketsSent-v.retransmittedPacketsSent)/(d.packetsSent-v.packetsSent),void 0===a.audioLossRate&&(a.audioLossRate=a._retransmittedRate,_.fraction_lost=a.audioLossRate),a._fractionLost=Math.max(a._fractionLost,a.audioLossRate),a._sendVolumeLevel=_._sendVolumeLevel,this.filterIllegal(a)}async getVideoStats(e,t,i){var o,s,r;const n={},a={timestamp:Date.now(),simulcast:{}},{streamId:d,videoMid:c,isScreen:l,pubAttributes:u,enableSimulcast:h,pubVideo:m}=this._stream,p={media_type:"video",is_screen:!!l,direction:"up",stream_id:d,vid:c,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,capture_state:u.localvideo?"capture_state_on":"capture_state_off",mute_state:m?"mute_state_off":"mute_state_on",thermal_status:oL.state};if(!e||!this.handler)return n;p.cap_frame_width=e.getSettings().width,p.cap_frame_height=e.getSettings().height,p.frameRateSent=e.getSettings().frameRate,n.isScreen=l,p.is_intersecting=JSON.stringify(null===(o=this._stream)||void 0===o||null===(o=o.videoTrack)||void 0===o?void 0:o.intersection());const _=await(null===(s=this.handler.peer)||void 0===s?void 0:s.getStatsWithLowFrequency(e,!1,null===(r=this._stream.videoTransceiver)||void 0===r?void 0:r.sender));if(!_.length)return n;let b=0;_.forEach((e=>{const{type:i,framesEncoded:o,packetsLost:s,bytesSent:r,framesSent:d,retransmittedBytesSent:c,totalPacketSendDelay:l,totalEncodeTime:u,firCount:m,targetBitrate:_,roundTripTime:v,mimeType:S,frameWidth:y,frameHeight:f,packetsSent:g,googActualEncBitrate:T,googAvailableReceiveBandwidth:I,googAvailableSendBandwidth:R,googAvgEncodeMs:E,googBucketDelay:C,googEncodeUsagePercent:Z,googFrameRateInput:L,availableIncomingBitrate:P,availableOutgoingBitrate:k,bytesReceived:N,nominated:X,id:V,currentRoundTripTime:w,state:x,writable:G,candidateType:W,ip:M,address:A,networkType:O,port:D,nackCount:Y,pliCount:K,protocol:U,qpSum:F,requestsReceived:H,responsesReceived:J,googRetransmitBitrate:z,requestsSent:j,consentRequestsSent:Q,responsesSent:B,ssrc:q,googTargetEncBitrate:$,googTransmitBitrate:ee,retransmittedPacketsSent:te,encoderImplementation:ie,jitter:oe,rid:se,fractionLost:re,googAdaptationChanges:ne,qualityLimitationReason:ae,qualityLimitationDurations:de,googFirsReceived:ce,googFrameRateSent:le,keyFramesEncoded:ue,scalabilityMode:he,framesPerSecond:me,frames:pe}=e;"outbound-rtp"===i?(h&&(se?a.simulcast[se]=e:a.simulcast[b]=e,b++),a.framesEncoded=o||a.framesEncoded||0,p.key_frames_encoded=ue||0,a.bytesSent=r||a.bytesSent||0,a.framesSent=d||a.framesSent,p.bytes=r||p.bytes||0,a.packetsSent=g||a.packetsSent||0,p.packetsSent=g||p.packetsSent||0,p.nackCount=Y||p.nackCount||0,p.pli_count=K||p.pli_count||0,p.qp_sum=F||p.qp_sum||0,p.ssrc=q||p.ssrc||0,p.retransmitted_packets_sent=te,a.retransmittedPacketsSent=te,a.retransmittedBytesSent=c,p.encoder_implementation=ie,p.qualityLimitationReason=ae,p.qualityLimitationDurations=de,p.scalabilityMode=he,void 0!==y&&((!n.encodedFrameWidth||y>n.encodedFrameWidth)&&(n.encodedFrameWidth=y),(!n.encodedFrameHeight||f>n.encodedFrameHeight)&&(n.encodedFrameHeight=f),p.frame_size_height=f,p.frame_size_width=y)):"track"===i?(n.encodedFrameWidth=y,n.encodedFrameHeight=f,p.frame_size_height=f,p.frame_size_width=y):"remote-inbound-rtp"===i?(a.packetsLost=s,n.rtt=1e3*v,p.rtt=n.rtt,p.jitter=1e3*oe,p.packetsLost=s,n._fractionLost=re||0):"codec"===i?(n.codecType=S,p.codecName=S):"candidate-pair"===i?(p.ice_available_incoming_bitrate=P,p.ice_available_outgoing_bitrate=k,p.ice_bytes_received=N,p.ice_bytes_sent=r,p.ice_nominated=Number(X),p.ice_pair_id=V,p.ice_pair_rtt=w,p.ice_pair_state=x,p.ice_pair_writable=G,p.recv_ping_requests=H,p.recv_ping_responses=J,p.sent_ping_requests_before_first_response=j,p.sent_ping_requests_total=j+Q,p.sent_ping_responses=B):"local-candidate"===i?(p.local_candidate_type=W,p.local_ip=M||A,p.local_network_type=O,p.local_port=D,p.protocol=U):"remote-candidate"===i?(p.remote_candidate_type=W,p.remote_ip=M||A,p.remote_port=D):"VideoBwe"===i?(p.encBitratebps=T,p.available_receive_bandwidth=I,p.available_send_bandwidth=R,p.bucket_delay=C,p.retransmitBitratebps=z,p.targetEncBitratebps=$,p.transmit_bitrate=ee,n._sendBandWidth=Number(R)):"ssrc"===i&&(p.avg_encode_ms=E,p.encodeUsage=Z,p.frame_rate_input=L,p.orignal_input_Framerate=Number(L),p.ddaptationChanges=ne,p.firsReceived=ce,p.frameRateSent=le);const _e=vy("STATS_SCALLBACK_SUPPORT");if(!KT||!_e){const{video:e}=t,s=a.timestamp-e.timestamp;if("outbound-rtp"===i){const t=r-e.bytesSent,i=c-e.retransmittedBytesSent;p.encBitratebps=Math.round(8e3*(t-i)/s),p.bucket_delay=l/g,p.retransmitBitratebps=Math.round(8e3*i/s),p.targetEncBitratebps=_,p.transmit_bitrate=Math.round(1e3*(r-e.bytesSent)*8/s),p.avg_encode_ms=1e3*u/o,p.firsReceived=m+K}else"candidate-pair"===i?(p.available_send_bandwidth=k,n._sendBandWidth=k):"media-source"===i&&(p.frame_rate_input=me,p.orignal_input_Framerate=Number(me),p.frame_input=pe)}}));const{video:v}=t;if(!v.timestamp)return t.video=a,this.filterIllegal(n);n.statsInterval=a.timestamp-v.timestamp,p.stats_interval=n.statsInterval;const S=Object.keys(a.simulcast);if(h){var y;p.sim_enc_width=[],p.sim_enc_height=[],p.sim_enc_bps=[],p.sim_enc_framerate=[],p.sim_enc_key_frames=[],p.sim_rids=[],p.sim_enc_bandwidth=[],p.sim_sent_framerate=[],p.sim_fraction_lost=[],p.sim_keyencoded=[],p.active_sim_streams=this._context.videoProfile.activeSimStreams||[],p.sim_retransmittedRate=[];let e=!1;var f;if(iT(S).call(S,((e,t)=>Number(e)-Number(t))).forEach((t=>{const{frameWidth:i,frameHeight:o,bytesSent:s,framesEncoded:r,framesSent:d,packetsLost:c,packetsSent:l,qualityLimitationReason:u,qualityLimitationDurations:h,qualityLimitationResolutionChanges:m,retransmittedPacketsSent:_,pliCount:b,keyFramesEncoded:S}=a.simulcast[t];void 0!==u&&(p.sim_qualityLimitationReason||(p.sim_qualityLimitationReason=[],p.sim_qualityLimitationDurations=[],p.sim_qualityLimitationResolutionChanges=[]),p.sim_qualityLimitationReason.push(u),p.sim_qualityLimitationDurations.push(h),p.sim_qualityLimitationResolutionChanges.push(m));const y=v.simulcast[t];if(p.sim_enc_width.push(i||0),p.sim_enc_height.push(o||0),p.sim_enc_key_frames.push(S||0),y){const o=(s-y.bytesSent||0)/n.statsInterval;p.sim_enc_bps.push(Math.round(8e3*o)),p.sim_enc_bandwidth.push(Math.round(8e3*o/1024));const a=1e3*(r-y.framesEncoded)/n.statsInterval;p.sim_enc_framerate.push(Math.round(a)),p.sim_rids.push(t);const u=void 0!==d?d-y.framesSent:r-y.framesEncoded,h=1e3*u/n.statsInterval;p.sim_sent_framerate.push(Math.round(h));let m=(c-y.packetsLost)/(l-y.packetsSent);n._retransmittedRate=(_-y.retransmittedPacketsSent)/(l-y.packetsSent),m=Number.isNaN(m)?0:m,p.sim_fraction_lost.push(m),p.sim_keyencoded.push(b-y.pliCount>0),p.sim_retransmittedRate.push(n._retransmittedRate),i>0&&!e&&(n.rid=t,n.sentKBitrate=8*o,n.encoderOutputFrameRate=a,n.encodedFrameCount=u,n.sentFrameRate=h,n.videoLossRate=m,e=!0)}})),p.vendor_mode=this._stream.vendorCode||0,p.pc_session_id=null===(y=this.handler)||void 0===y?void 0:y.peerConnectionId,i)null===(f=this._monitor)||void 0===f||f.report("rtc_media_statistics",p)}else{var g,T;if(n.encodedFrameCount=void 0!==a.framesSent?a.framesSent-v.framesSent:a.framesEncoded-v.framesEncoded,n.sentKBitrate=(a.bytesSent-v.bytesSent||0)/n.statsInterval*8,p.bitrate=Math.round(1e3*n.sentKBitrate),p.bandwidth=Math.round(p.bitrate/1024),n.encoderOutputFrameRate=1e3*(a.framesEncoded-v.framesEncoded)/n.statsInterval,p.frame_rate_encoded=Math.round(n.encoderOutputFrameRate),n.sentFrameRate=1e3*n.encodedFrameCount/n.statsInterval,p.frame_rate_sent=Math.round(n.sentFrameRate),n.videoLossRate=Math.max(0,a.packetsLost-v.packetsLost)/(a.packetsSent-v.packetsSent),n.videoLossRate=Number.isNaN(n.videoLossRate)?0:n.videoLossRate,p.fraction_lost=n.videoLossRate,n._retransmittedRate=(a.retransmittedPacketsSent-v.retransmittedPacketsSent)/(a.packetsSent-v.packetsSent),p.vendor_mode=this._stream.vendorCode||0,p.pc_session_id=null===(g=this.handler)||void 0===g?void 0:g.peerConnectionId,i)null===(T=this._monitor)||void 0===T||T.report("rtc_media_statistics",p)}return t.video=a,n._fractionLost=Math.max(n._fractionLost,n.videoLossRate),n._captureResolutionWidth=p.cap_frame_width,n._captureResolutionHeight=p.cap_frame_height,this.filterIllegal(n)}}class uL extends cL{constructor(e,t){super(e),Ou(this,"_stats",{audioStats:{},videoStats:{}}),Ou(this,"_preReports",{audio:{},video:{}}),this._stream=t;const i=async()=>{this._stats=await this._getRemoteStreamStats(this._stream,this._preReports,!1),this._destroyed||(this._timer=setTimeout(i,vy("STATS_LOOP_INTERVAL")))};i()}async setRemoteStreamStatsEvtInterval(e,t){if(this._isReportStarted)return;this.logger.info("setRemoteStreamStatsEvtInterval","invoke"),this._isReportStarted=!0,this.setVar(t),this._destroyed=!1;const i={audio:{},video:{}},o=async()=>{const t=await this._getRemoteStreamStats(this._stream,i,!0);e(t),this._destroyed||(this._reportTimer=setTimeout(o,2e3))};this.stopReport("start a new timer."),o()}getRemoteStreamStats(){return this._stats}async _getRemoteStreamStats(e,t,i){var o,s,r;const n=null===(o=e.videoTrack)||void 0===o?void 0:o.originTrack,a=null===(s=e.audioTrack)||void 0===s?void 0:s.originTrack;var d;0===Object.keys(t.audio).length&&0===Object.keys(t.video).length&&(await this.getRemoteAudioStats(a,t,null===(d=this._stream.audioTrack)||void 0===d?void 0:d.getAudioLevel(),i),await this.getRemoteVideoStats(n,t,i),await Wy(150));return{audioStats:await this.getRemoteAudioStats(a,t,null===(r=this._stream.audioTrack)||void 0===r?void 0:r.getAudioLevel(),i),videoStats:await this.getRemoteVideoStats(n,t,i),isScreen:e.isScreen,userId:e.userId,streamId:e.streamId}}unsubscribe(){this.logger.info("unsubscribe","invoke"),super.stopReport("unsubscribe"),this._stream.stopAudioStallObserve()}async getRemoteAudioStats(e,t,i,o){var s,r,n,a;const d={},c={},{streamId:l,userId:u,isScreen:h,audioMid:m,subMediaType:p,_attributes:_,virtual:b,audioTrack:v}=this._stream,S={media_type:"audio",is_screen:!!h,direction:"down",stream_id:l,stream_user_id:u,vid:m,audio_mux:b,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,mute_state:Ky(p)?"mute_state_off":"mute_state_on",remote_user_capture_state:_.localaudio?"capture_state_on":"capture_state_off",remote_user_mute_state:_.localaudio&&_.audiostream?"mute_state_off":"mute_state_on",thermal_status:oL.state};if(v&&(S.playback_volume=v.getVolume()),!e||!this.handler)return d;const y=await(null===(s=this.handler.peer)||void 0===s?void 0:s.getStatsWithLowFrequency(e,!1,null===(r=this._stream.audioTransceiver)||void 0===r?void 0:r.receiver));if(!y.length)return d;y.forEach((e=>{let{type:t,packetsLost:o,packetsReceived:s,bytesReceived:r,jitterBufferDelay:n,jitterBufferEmittedCount:a,clockRate:u,channels:h,totalSamplesReceived:m,concealedSamples:p,silentConcealedSamples:_,concealmentEvents:b,totalRoundTripTime:v,packetsDiscarded:y,state:f,currentRoundTripTime:g,audioLevel:T,totalAudioEnergy:I,totalSamplesDuration:R,mimeType:E,googDecodingNormal:C,googDecodingMuted:Z,availableIncomingBitrate:L,availableOutgoingBitrate:P,bytesSent:k,nominated:N,id:X,writable:V,jitter:w,candidateType:x,ip:G,address:W,networkType:M,port:A,protocol:O,audioOutputLevel:D,requestsReceived:Y,responsesReceived:K,requestsSent:U,consentRequestsSent:F,responsesSent:H,ssrc:J,nackCount:z,lastPacketReceivedTimestamp:j,concealmentevents:Q,fecPacketsReceived:B}=e;if("inbound-rtp"===t)c.packetsLost=o,c.packetsReceived=s,S.packetsLost=o,S.packetsReceived=s,S.packetsDiscarded=y,S.nackCount=z,S.lastPacketReceivedTimestamp=j,S.concealmentevents=Q,c.bytesReceived=r,void 0!==n&&(d.jitterBufferDelay=n/a*1e3,S.average_jitter_buffer_delay_ms=d.jitterBufferDelay),void 0!==m&&(c.totalSamplesReceived=m,d.concealedSamples=p,c.concealedSamples=p,c.silentConcealedSamples=_,S.concealedSamples=p,d.concealmentEvents=b,S.totalSamplesReceived=m),void 0!==B&&(S.fec_packets_received=B,c.fecPacketsReceived=B),S.jitter=1e3*w,S.ssrc=J,void 0!==T&&0!==T?(S.audio_level=T?-10*Math.log10(Math.pow(T,2)):T,S.volume=255*T):(S.volume=null!=i?i:255*T,S.audio_level=i?-10*Math.log10(Math.pow(i/255,2)):i),void 0!==I&&(S.total_audio_energy=I),void 0!==R&&(S.totalAudioDuration=R);else if("codec"===t)d.recordSampleRate=u,h&&(d.numChannels=h),S.codecName=E;else if("candidate-pair"===t){var q;S.ice_available_incoming_bitrate=L,S.ice_available_outgoing_bitrate=P,S.ice_bytes_received=r,S.ice_bytes_sent=k,S.ice_nominated=Number(N),S.ice_pair_id=X,S.ice_pair_rtt=g,S.rtt=1e3*g,S.rtt&&null!==(q=this._context.streamRTT)&&void 0!==q&&null!==(q=q[l])&&void 0!==q&&q.audio&&(S.total_rtt_ms=Math.round(S.rtt+this._context.streamRTT[l].audio)),S.ice_pair_state=f,S.ice_pair_writable=V,S.recv_ping_requests=Y,S.recv_ping_responses=K,S.sent_ping_requests_before_first_response=U,S.sent_ping_requests_total=U+(F||0),S.sent_ping_responses=H,"succeeded"===f&&(d.rtt=1e3*g,d.total_rtt=1e3*v)}else"track"===t&&void 0!==T?(0===T&&0!==i?(S.volume=i,S.audio_level=i?-10*Math.log10(Math.pow(i/255,2)):i):(S.audio_level=T?-10*Math.log10(Math.pow(T,2)):T,S.volume=255*T),S.total_audio_energy=I,S.totalAudioDuration=R):"ssrc"===t?(S.decodingNormal=C,S.recvAudioLevel=D,S.decodingMuted=Z):"local-candidate"===t?(S.local_candidate_type=x,S.local_ip=G||W,S.local_network_type=M,S.local_port=A,S.protocol=O):"remote-candidate"===t&&(S.remote_candidate_type=x,S.remote_ip=G||W,S.remote_port=A)}));const{audio:f}=t;if(!f.timestamp)return c.timestamp=Date.now(),t.audio=c,this.filterIllegal(d);let g;var T;(void 0!==c.concealedSamples&&(S.interval_concealed_samples=c.concealedSamples-f.concealedSamples,S.interval_samples_received=c.totalSamplesReceived-f.totalSamplesReceived,S.interval_silent_concealed_samples=c.silentConcealedSamples-f.silentConcealedSamples,g=await this._stream.updateAudioStallInfo(S,d,c)),c.timestamp=Date.now(),d.audioLossRate=Math.max(0,c.packetsLost-f.packetsLost)/(c.packetsReceived-f.packetsReceived+(c.packetsLost-f.packetsLost)),d.audioLossRate=Number.isNaN(d.audioLossRate)?0:d.audioLossRate,S.fraction_lost=d.audioLossRate,d.statsInterval=c.timestamp-f.timestamp,S.stats_interval=d.statsInterval,d.receivedKBitrate=(c.bytesReceived-f.bytesReceived||0)/d.statsInterval*8,S.bandwidth=Math.round(1e3*d.receivedKBitrate/1024),void 0!==c.concealedSamples&&(d.receivedSampleRate=1e3*S.interval_samples_received/d.statsInterval),void 0!==c.fecPacketsReceived&&(S.fecBitratebps=(c.fecPacketsReceived-f.fecPacketsReceived||0)/d.statsInterval),S.average_jitter_buffer_delay_ms&&S.total_rtt_ms&&(d.e2eDelay=S.average_jitter_buffer_delay_ms+S.total_rtt_ms),null!==(n=this._context.streamRTT)&&void 0!==n&&null!==(n=n[l])&&void 0!==n&&n.audio&&(d.totalRtt=(S.rtt?S.rtt:0)+this._context.streamRTT[l].audio),t.audio=c,S.vendor_mode=this._stream.vendorCode||0,S.pc_session_id=null===(a=this.handler)||void 0===a?void 0:a.peerConnectionId,o)&&(null===(T=this._monitor)||void 0===T||T.report("rtc_media_statistics",S,g));return this.filterIllegal(d)}async getRemoteVideoStats(e,t,i){var o,s,r,n,a;const d={},c={timestamp:Date.now()},{streamId:l,userId:u,isScreen:h,subMediaType:m,_attributes:p}=this._stream,_=Yu({media_type:"video",is_screen:!!h,direction:"down",stream_id:l,stream_user_id:u,vid:this._stream.videoMid,connection_status:navigator.onLine,track_enabled:null==e?void 0:e.enabled,mute_state:Uy(m)?"mute_state_off":"mute_state_on",remote_user_capture_state:p.localvideo?"capture_state_on":"capture_state_off",remote_user_mute_state:p.localvideo&&p.videostream?"mute_state_off":"mute_state_on",is_intersecting:JSON.stringify(null===(o=this._stream.videoTrack)||void 0===o?void 0:o.intersection()),thermal_status:oL.state},this._stream.getVideoRenderInfo());if(!e||!this.handler)return d;d.isScreen=h;const b=await(null===(s=this.handler.peer)||void 0===s?void 0:s.getStatsWithLowFrequency(e,!1,null===(r=this._stream.videoTransceiver)||void 0===r?void 0:r.receiver));if(!b.length)return d;b.forEach((e=>{let{type:t,frameHeight:i,frameWidth:o,packetsLost:s,packetsReceived:r,bytesReceived:n,framesDecoded:a,jitterBufferDelay:u,jitterBufferEmittedCount:h,mimeType:m,firCount:p,availableIncomingBitrate:b,availableOutgoingBitrate:v,bytesSent:S,nominated:y,id:f,currentRoundTripTime:g,state:T,writable:I,candidateType:R,ip:E,address:C,networkType:Z,port:L,nackCount:P,pliCount:k,protocol:N,requestsReceived:X,responsesReceived:V,requestsSent:w,consentRequestsSent:x,responsesSent:G,ssrc:W,jitter:M,framesReceived:A,keyFramesDecoded:O,totalDecodeTime:D,decoderImplementation:Y,lastPacketReceivedTimestamp:K,framesDropped:U}=e;if("inbound-rtp"===t)c.packetsLost=s,_.packetsLost=s,c.packetsReceived=r,_.packetsReceived=r,c.bytesReceived=n,_.bytes=n,c.framesDecoded=a,c.totalDecodeTime=D,void 0!==u&&(c.jitterBufferDelay=u/h*1e3,_.average_jitter_buffer_delay_ms=c.jitterBufferDelay),_.fir_count=p,_.nackCount=P,c.nackCount=P,_.pli_count=k,_.ssrc=W,_.framesDropped=U,_.jitter=1e3*M,_.framesReceived=A,c.framesReceived=A,_.framesDecoded=a,_.key_frames_decoded=O,_.decoder_name=Y,_.last_packet_received_timestamp=K,void 0!==o&&(d.width=o,_.frame_size_width=o,d.height=i,_.frame_size_height=i);else if("track"===t&&void 0!==o)d.width=o,_.frame_size_width=o,d.height=i,_.frame_size_height=i,void 0!==A&&(_.framesReceived=A,c.framesReceived=A);else if("codec"===t)_.codecName=m,d.codecType=m;else if("candidate-pair"===t){var F;_.ice_available_incoming_bitrate=b,_.ice_available_outgoing_bitrate=v,_.ice_bytes_received=n,_.ice_bytes_sent=S,_.ice_nominated=Number(y),_.ice_pair_id=f,_.ice_pair_rtt=g,_.rtt=1e3*g,_.rtt&&null!==(F=this._context.streamRTT)&&void 0!==F&&null!==(F=F[l])&&void 0!==F&&F.video&&(_.total_rtt_ms=Math.round(_.rtt+(this._context.streamRTT[l].video||0))),d.rtt=_.rtt,_.ice_pair_state=T,_.ice_pair_writable=I,_.recv_ping_requests=X,_.recv_ping_responses=V,_.sent_ping_requests_before_first_response=w,_.sent_ping_requests_total=w+(x||0),_.sent_ping_responses=G}else"local-candidate"===t?(_.local_candidate_type=R,_.local_ip=E||C,_.local_network_type=Z,_.local_port=L,_.protocol=N):"remote-candidate"===t&&(_.remote_candidate_type=R,_.remote_ip=E||C,_.remote_port=L)}));const{video:v}=t;if(!v.timestamp)return t.video=c,this.filterIllegal(d);const S=Math.max(0,c.packetsLost-v.packetsLost),y=c.packetsReceived-v.packetsReceived;if(d.videoLossRate=S/(y+S),d._receivePackets=c.packetsReceived,d._receivePacketsLost=c.packetsLost,v.totalDecodeTime&&v.framesDecoded&&c.framesDecoded!==v.framesDecoded){const e=c.totalDecodeTime-v.totalDecodeTime,t=c.framesDecoded-v.framesDecoded;_.decode_elapse_per_frame=Number((e/t*1e3).toFixed(2))}var f;(d._retransmittedRate=(c.nackCount-v.nackCount)/(y+S),d.videoLossRate=Number.isNaN(d.videoLossRate)?0:d.videoLossRate,_.fraction_lost=d.videoLossRate,d.statsInterval=c.timestamp-v.timestamp,_.stats_interval=d.statsInterval,d.receivedKBitrate=(c.bytesReceived-v.bytesReceived||0)/d.statsInterval*8,_.bitrate=Math.round(1e3*d.receivedKBitrate),_.bandwidth=Math.round(_.bitrate/1024),d.decoderOutputFrameRate=1e3*(c.framesDecoded-v.framesDecoded)/d.statsInterval,d.receivedFrameRate=1e3*(c.framesReceived-v.framesReceived)/d.statsInterval,_.frame_rate_decoded=Math.round(d.decoderOutputFrameRate),_.frame_rate_received=Math.round(d.receivedFrameRate),_.average_jitter_buffer_delay_ms&&_.total_rtt_ms&&(d.e2eDelay=_.average_jitter_buffer_delay_ms+_.total_rtt_ms),null!==(n=this._context.streamRTT)&&void 0!==n&&null!==(n=n[l])&&void 0!==n&&n.video&&(d.totalRtt=(_.rtt?_.rtt:0)+(this._context.streamRTT[l].video||0)),t.video=c,this._stream.updateVideoStallInfo(_,d,i),_.vendor_mode=this._stream.vendorCode||0,_.pc_session_id=null===(a=this.handler)||void 0===a?void 0:a.peerConnectionId,i)&&(null===(f=this._monitor)||void 0===f||f.report("rtc_media_statistics",_));return this.filterIllegal(d)}destroy(){super.destroy(),super.stopReport("destroy"),this._stream.stopAudioStallObserve()}}class hL{constructor(e,t){Ou(this,"_removeHandler",void 0),Ou(this,"_remotePauseHandler",void 0),Ou(this,"_prePts",void 0),Ou(this,"_stallList",void 0),Ou(this,"_videoInWaiting",!1),Ou(this,"_videoInWaitingCallback",!1),Ou(this,"_videoInWaiting100ms",!1),Ou(this,"_isPaused",void 0),Ou(this,"_pauseStart",0),Ou(this,"_pauseDuration",0),Ou(this,"_requestVideoFrameCallbackTimer",void 0),Ou(this,"_logger",void 0),Ou(this,"_player",void 0),Ou(this,"_recentVideoInfo",void 0),Ou(this,"_stallTimeThreshold",void 0),Ou(this,"_openVideoStall100ms",_y.VIDEO_STALL_100MS);const i=e?1500:rS||sS?550:500;this._stallTimeThreshold={report:i,callback:Math.max(_y.VIDEO_STALL_DATA,i)},this._logger=new eS("VideoStallObserver",1,t)}start(e){if(this._logger.print("start","invoke"),this._player=e,zS())e.domElement&&(this._requestVideoFrameCallbackTimer=e.domElement.requestVideoFrameCallback(this._onVideoRefresh.bind(this)),this._removeHandler=()=>{var t;this._requestVideoFrameCallbackTimer&&(null===(t=e.domElement)||void 0===t||t.cancelVideoFrameCallback(this._requestVideoFrameCallbackTimer))});else{const t=t=>this._onVideoTimeupdate(t,e);e.on("playback_event",t),this._removeHandler=()=>e.off("playback_event",t)}const t=e=>this._onVideoPause(e);e.on("playback_event",t),this._remotePauseHandler=()=>e.off("playback_event",t)}getRecentRenderInfo4Report(){const e={};return this._recentVideoInfo&&Object.keys(this._recentVideoInfo).forEach((t=>{var i;const o=t.replace(/[a-z]{1}[A-Z]{1}/g,(e=>"".concat(e[0],"_").concat(e[1].toLowerCase())));e["video_".concat(o)]=null===(i=this._recentVideoInfo)||void 0===i?void 0:i[t]})),e}stop(){var e,t;this._logger.print("stop","invoke"),delete this._player,null===(e=this._removeHandler)||void 0===e||e.call(this),delete this._removeHandler,null===(t=this._remotePauseHandler)||void 0===t||t.call(this),delete this._remotePauseHandler,delete this._stallList,delete this._prePts,delete this._recentVideoInfo,this._videoInWaiting=!1,this._videoInWaitingCallback=!1,this._videoInWaiting100ms=!1}destroy(){this.stop()}getStallInfo(e){let{interval:t,frameRateReceived:i,frameRateDecoded:o,bitrate:s}=e;const r={pts:0,report:{stallCount:0,stallDuration:0,list:[]},callback:{stallCount:0,stallDuration:0},pauseDuration:this._getPauseDuration()};if(this._stallList){(rS||sS)&&(0===s||(o||1/0)<=1||(i||1/0)<=1)||0===this._stallList.length?(r.report.stallDuration=r.callback.stallDuration=2e3,r.report.stallCount=r.callback.stallCount=this._videoInWaiting?0:1,this._openVideoStall100ms&&(r.stall100ms={count:this._videoInWaiting100ms?0:1,duration:2e3}),this._videoInWaiting=!0,this._videoInWaitingCallback=!0,this._videoInWaiting100ms=!0):this._stallList.forEach(((e,i)=>{let o=e.timeUpdateInterval;0===i&&this._videoInWaiting&&(o=Math.round(e.timeUpdateInterval%t));const s=e.timeUpdateInterval>this._stallTimeThreshold.report;s&&(r.report.list.push(e.timeUpdateInterval),r.report.stallDuration+=o,this._videoInWaiting||r.report.stallCount++),this._videoInWaiting=s,e.timeUpdateInterval>this._stallTimeThreshold.callback?(r.callback.stallDuration+=o,this._videoInWaitingCallback||r.callback.stallCount++,this._videoInWaitingCallback=!0):this._videoInWaitingCallback=!1,this._openVideoStall100ms&&(r.stall100ms||(r.stall100ms={count:0,duration:0}),e.timeUpdateInterval>100?(r.stall100ms.duration+=o,this._videoInWaiting100ms||r.stall100ms.count++,this._videoInWaiting100ms=!0):this._videoInWaiting100ms=!1),r.pts=e.playTime})),this._stallList=[]}return r}_getPauseDuration(){let e=this._pauseDuration;if(this._pauseDuration=0,this._isPaused){const t=wy(),i=t-(this._pauseStart||0);i>500&&(this._pauseStart=t,e+=i)}return e}_onVideoPause(e){if("pause"===e.eventName)this._isPaused=!0,this._pauseStart=wy();else if("play"===e.eventName&&this._isPaused){this._isPaused=!1;const e=wy()-this._pauseStart;e>500&&(this._pauseDuration+=e)}}_onVideoTimeupdate(e,t){if("timeupdate"===e.eventName){const e=t.domElement;if(!e||0===e.currentTime)return;if(void 0===this._prePts)return void(this._prePts=e.currentTime);if(this._stallList||(this._stallList=[]),e.currentTime>this._prePts){const t=e.currentTime-this._prePts;this._stallList.push({playTime:e.currentTime,timeUpdateInterval:Math.round(1e3*t)})}this._prePts=e.currentTime}}_onVideoRefresh(e,t){var i;if(this._stallList||(this._stallList=[]),this._prePts){const e=t.presentationTime-this._prePts;this._stallList.push({playTime:t.presentationTime,timeUpdateInterval:Math.round(e)})}this._recentVideoInfo=t,this._prePts=t.presentationTime,null===(i=this._player)||void 0===i||null===(i=i.domElement)||void 0===i||i.requestVideoFrameCallback(this._onVideoRefresh.bind(this))}}class mL{constructor(e){Ou(this,"_audioStallTimer",void 0),Ou(this,"_preSample",void 0),Ou(this,"_isStallInPreCallbackEnd",!1),Ou(this,"_isStallInPreReportEnd",!1),Ou(this,"_stallList",[]),this._stream=e}static setAudioStallConfig(e){mL.interval=((null==e?void 0:e.audio_stall_interval)||200)/2,mL.ratio=(null==e?void 0:e.audio_stall_ratio)||.6}start(e,t){this.stop(),_y.AUDIO_STALL&&mL.interval>0&&"number"==typeof e&&"number"==typeof t&&(this._preSample={ts:wy(),concealedSamples:e,totalSamplesReceived:t},this._startStallCountInterval())}stop(){this._stallList=[],this._audioStallTimer&&(clearTimeout(this._audioStallTimer),delete this._audioStallTimer)}destroy(){this.stop()}async getAudioStallInfo(){const e={stats_count:this._stallList.filter((e=>!!e.get_stats_cost)).length,stall_list:[...this._stallList]};try{await this._audioStallCount()}catch(s){}const t=pL(this._stallList,2,this._isStallInPreReportEnd);this._isStallInPreReportEnd=t.isStallInEnd;const i=_y.AUDIO_STALL_DATA/mL.interval,o=pL(this._stallList,i,this._isStallInPreCallbackEnd);return this._isStallInPreCallbackEnd=o.isStallInEnd,this.stop(),this._startStallCountInterval(),{report:{stall_count:t.stall_count,stall_duration:t.stall_duration,list:t.list},callback:{stall_count:o.stall_count,stall_duration:o.stall_duration,list:o.list},extra:e}}_startStallCountInterval(){const e=async()=>{clearTimeout(this._audioStallTimer),delete this._audioStallTimer,await this._audioStallCount(),this._audioStallTimer||(this._audioStallTimer=setTimeout(e,mL.interval))};this._audioStallTimer=setTimeout(e,mL.interval)}async _audioStallCount(){if(!this._preSample||wy()-this._preSample.ts<.5*mL.interval)return;const{hasAudio:e,subAudio:t,virtual:i,virtualOccupy:o,removeTrack:s,audioTrack:r}=this._stream;if(s||!r)return clearTimeout(this._audioStallTimer),void delete this._audioStallTimer;const n=e&&t;if(!n||i&&!o)this._preSample.ts=wy(),this._stallList.push({reason:n?"virtual: ".concat(i,", virtualOccupy: ").concat(o):"hasAudio: ".concat(e,", subAudio: ").concat(t)});else{const e=wy();let t,i,o=0;try{var a;const e=await(null===(a=this._stream.audioTransceiver)||void 0===a?void 0:a.receiver.getStats());null==e||e.forEach((e=>{"inbound-rtp"===e.type&&(t=e),o++}))}catch(d){i=d.message||JSON.stringify(d)}const s=wy(),r=wy(),n=r-this._preSample.ts;if(t){const{concealedSamples:i,totalSamplesReceived:o}=t,a=i-this._preSample.concealedSamples,d=o-this._preSample.totalSamplesReceived,c=a>=0&&d>=0&&a>=mL.ratio*d;this._stallList.push({concealed:a,received:d,diff:n,start:this._preSample.ts,end:r,get_stats_cost:s-e,get_stats_start:e,get_stats_end:s,is_stall:c}),this._preSample.concealedSamples=i,this._preSample.totalSamplesReceived=o,this._preSample.ts=r}else this._stallList.push({diff:n,start:this._preSample.ts,end:r,get_stats_cost:s-e,get_stats_start:e,get_stats_end:s,reason:o?i||"no inbound-rtp":"no report"})}}}Ou(mL,"interval",100),Ou(mL,"ratio",.6);const pL=(e,t,i)=>{var o;const s={stall_count:0,stall_duration:0,isStallInEnd:!1,list:[]};let r=0,n=0;for(let a=0;a<e.length;a++){const i=e[a];i.is_stall&&(r++,n+=i.diff||0);const o=a===e.length-1;if(!i.is_stall||o){let i=r>=t;const d=a+t-r-1;if(!i&&r>2){let o=0;e.slice(a+1,d+1).forEach((e=>{e.is_stall&&(o+=e.diff||0)})),i=n+o>mL.interval*t*mL.ratio,i&&(a=d,n+=o)}i&&(s.stall_count++,s.stall_duration+=n,s.list.push(n)),o&&(s.isStallInEnd=i),r=n=0}}return!0===(null===(o=e[0])||void 0===o?void 0:o.is_stall)&&i&&s.stall_count>0&&s.stall_count--,s};var _L=(e=>(e[e.CAPTURE=0]="CAPTURE",e[e.PRE_PROCESSING=1]="PRE_PROCESSING",e[e.ENCODE=2]="ENCODE",e[e.TRANSFER=3]="TRANSFER",e[e.POST_PROCESSING=4]="POST_PROCESSING",e[e.DECODE=5]="DECODE",e[e.RENDERING=6]="RENDERING",e))(_L||{}),bL=(e=>(e[e.STREAM_INDEX_MAIN=0]="STREAM_INDEX_MAIN",e[e.STREAM_INDEX_SCREEN=1]="STREAM_INDEX_SCREEN",e))(bL||{});class vL{constructor(e){Ou(this,"_plugins",new Map),this.id=e}register(e){const t=this._plugins.get(e.type)||[];if(t.findIndex((t=>t.name===e.name))>-1)throw new Error("Failed to register ".concat(e.name,": name is repeated."));t.push(e),this._plugins.set(e.type,t)}getPluginsByType(e){return this._plugins.get(e)||[]}getPluginByName(e,t){return(this._plugins.get(e)||[]).find((e=>e.name===t))}async getPreProcessingTrack(e){const t=this._plugins.get(1)||[];let i=e.mediaTrack;for(const o of t)i=await o.effect(e,i);return i}destroy(){this._plugins.forEach((e=>{e.forEach((e=>e.destroy()))})),this._plugins.clear()}}const SL=new eS("InternalEventBus",1);var yL=(e=>(e.ON_IOS_INTERRUPTION_START="ON_IOS_INTERRUPTION_START",e.ON_IOS_INTERRUPTION_END="ON_IOS_INTERRUPTION_END",e.ON_IOS_LOCAL_TRACK_MUTE="ON_IOS_LOCAL_TRACK_MUTE",e.ON_IOS_LOCAL_TRACK_UNMUTE="ON_IOS_LOCAL_TRACK_UNMUTE",e))(yL||{});class fL extends sT.EventEmitter{emit(e){SL.info(e);for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];return super.emit(e,...i)}}const gL=new fL;var TL="data:application/javascript;base64,Y2xhc3MgRHVtcEF1ZGlvRGF0YSBleHRlbmRzIEF1ZGlvV29ya2xldFByb2Nlc3NvciB7CiAgcHJvY2VzcyhpbnB1dHMpIHsKICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZSh7CiAgICAgIGRhdGE6IGlucHV0c1swXSwKICAgICAgY2hhbm5lbENvdW50OiBpbnB1dHNbMF0ubGVuZ3RoLAogICAgICBzYW1wbGVSYXRlLAogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCnJlZ2lzdGVyUHJvY2Vzc29yKCdkdW1wLWF1ZGlvLWRhdGEnLCBEdW1wQXVkaW9EYXRhKTsK";const IL=new eS("AudioContext",1);class RL{constructor(e){Ou(this,"_ctx",void 0),Ou(this,"_analyserNode",void 0),Ou(this,"_audioSource",void 0),Ou(this,"currentTrackId",void 0),this.currentTrackId=e.id;const t=CL.getAudioContextInstance();if(e instanceof MediaStreamTrack){const i=new MediaStream;i.addTrack(e),this._audioSource=t.createMediaStreamSource(i)}else this._audioSource=t.createMediaElementSource(e),this._audioSource.connect(t.destination);const i=t.createAnalyser();this._audioSource.connect(i),this._analyserNode=i,this._ctx=t}getAudioLevel(){var e;"suspended"===(null===(e=this._ctx)||void 0===e?void 0:e.state)&&this._ctx.resume();const t=new Uint8Array(2048);this._analyserNode.getByteTimeDomainData(t);let i=0;t.forEach((e=>i=Math.max(i,Math.abs(e-128))));const o=i/128*255;return o>2?o:0}async resume(){var e;await(null===(e=this._ctx)||void 0===e?void 0:e.resume())}destroy(){this._audioSource.disconnect(),this._analyserNode.disconnect()}}class EL extends sT.EventEmitter{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:CL.getAudioContextInstance(),o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:CL.isWorkletReady;var s;(super(),Ou(this,"_ctx",void 0),Ou(this,"_worklet",void 0),Ou(this,"_source",void 0),Ou(this,"_buffers",[]),Ou(this,"_bufferLength",0),Ou(this,"_sampleRate",void 0),Ou(this,"_channelCount",void 0),Ou(this,"_frameSize",void 0),e instanceof MediaStreamTrack)?this._channelCount=null!==(s=e.getSettings().channelCount)&&void 0!==s?s:1:this._channelCount=e.channelCount;this._ctx=i,this._frameSize=t,null==o||o.then((()=>{this._worklet=new AudioWorkletNode(this._ctx,"dump-audio-data"),e instanceof MediaStreamTrack?this._source=this._ctx.createMediaStreamSource(new MediaStream([e])):this._source=e,this._source.connect(this._worklet),this._initWorkletEventListener(this._worklet)})).catch()}_initWorkletEventListener(e){e.port.onmessage=this._handleWorkletMessage.bind(this)}_handleWorkletMessage(e){const{data:t,sampleRate:i}=e.data;if(this._bufferLength>=this._frameSize||this._sampleRate!==i){if(this._sampleRate){const e=1===this._channelCount||1===t.length?1:2;this.emit("data",{channels:[...this._buffers],sampleRate:this._sampleRate,channelCount:e})}this._sampleRate=i,this._buffers=new Array(this._channelCount).fill(0).map((()=>new Float32Array(this._frameSize))),this._bufferLength=0}for(let o=0;o<this._channelCount;o++)this._buffers[o].set(t[o],this._bufferLength);this._bufferLength=this._bufferLength+t[0].length}setFrameSize(e){this._frameSize=e}destroy(){var e,t,i;this.removeAllListeners("data"),this._worklet&&(null===(e=this._source)||void 0===e||e.disconnect(this._worklet)),null===(t=this._worklet)||void 0===t||t.disconnect(),null===(i=this._worklet)||void 0===i||i.port.close(),this._buffers=[],delete this._source,delete this._worklet}}const CL=new class{constructor(){Ou(this,"isWorkletReady",void 0),Ou(this,"_audioContextInstance",void 0),Ou(this,"_previousState",""),Ou(this,"_currentState",""),Ou(this,"_contextStuckAt",0);let e=0;tS()||setInterval((()=>{if(this._audioContextInstance){const t=this._audioContextInstance.currentTime;this._contextStuckAt?this._contextStuckAt!==t&&(this._contextStuckAt=0,IL.info("currentTime resume"),Pv("currentTime resume","")):t&&e===t&&(this._contextStuckAt=t,IL.warn("currentTime stuck",this._contextStuckAt),this._audioContextInstance.suspend(),this._audioContextInstance.resume(),Pv("AudioContext currentTime stuck",this._contextStuckAt)),e=t}}),3e3)}getAudioContextInstance(){if(!this._audioContextInstance){const t=window.AudioContext||window.webkitAudioContext;this._audioContextInstance=jT?new t:new t({sampleRate:44100});try{this.isWorkletReady=this._audioContextInstance.audioWorklet.addModule(TL),this.isWorkletReady.catch((e=>{Lv("initial AudioWorklet error in promise",-1,"".concat(e.name,"-").concat(e.message)),IL.error("isWorkletReady",e),this.isWorkletReady=null}))}catch(e){Lv("initial AudioWorklet error in catch",-1,"".concat(e.name,"-").concat(e.message)),IL.error("isWorkletReady",e),this.isWorkletReady=null}this._audioContextInstance.onstatechange=()=>{var e,t,i;IL.warn("state change",null===(e=this._audioContextInstance)||void 0===e?void 0:e.state),this._previousState=this._currentState,this._currentState=(null===(t=this._audioContextInstance)||void 0===t?void 0:t.state)||"","interrupted"===(null===(i=this._audioContextInstance)||void 0===i?void 0:i.state)&&this._audioContextInstance.resume(),(SS||pS)&&("running"===this._previousState&&"interrupted"===this._currentState&&gL.emit(yL.ON_IOS_INTERRUPTION_START),"interrupted"===this._previousState&&"running"===this._currentState&&gL.emit(yL.ON_IOS_INTERRUPTION_END))}}return this._audioContextInstance}},ZL=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=document.createElement(e);return t.id&&(i.id=t.id),t.classList&&t.classList.forEach((e=>{i.classList.add(e)})),t.style&&Object.assign(i.style,t.style),t.attributes&&Object.entries(t.attributes).forEach((e=>{let[t,o]=e;"muted"===t?i.muted=!0:i.setAttribute(t,o)})),i};const LL=new class extends aT{constructor(){var e;super(),Ou(this,"deviceMap",{audioinput:new Map,audiooutput:new Map,videoinput:new Map}),Ou(this,"checkDeviceChangeTimer",null),Ou(this,"isSupportedPermissionsQuery",!1),Ou(this,"isGrantedMicrophonePermission",!1),Ou(this,"isGrantedCameraPermission",!1),this.isSupportedPermissionsQuery=!tS()&&!(null===(e=navigator)||void 0===e||null===(e=e.permissions)||void 0===e||!e.query),this._handleDeviceChange=this._handleDeviceChange.bind(this),!tS()&&this.initListener().then((()=>{this.updateDeviceListInSilent()}))}async refreshDevices(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"audio";if(!navigator.mediaDevices)return;if(sS)try{e="audio"===t?await navigator.mediaDevices.getUserMedia({audio:!0}):await navigator.mediaDevices.getUserMedia({video:!0})}catch(o){}const i=await navigator.mediaDevices.enumerateDevices();e&&e.getTracks().forEach((e=>e.stop())),i.forEach((e=>{var t;e.deviceId&&(null===(t=this.deviceMap[e.kind])||void 0===t||t.set(e.deviceId,e))}))}async initListener(){var e,t;if(void 0!==(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.ondevicechange)&&"function"==typeof(null===(t=navigator.mediaDevices)||void 0===t?void 0:t.addEventListener)?navigator.mediaDevices.addEventListener("devicechange",(()=>{this._handleDeviceChange(),setTimeout((()=>{this._handleDeviceChange()}),300)})):this.checkDeviceChangeTimer=window.setInterval((()=>{this._handleDeviceChange()}),3e3),this.isSupportedPermissionsQuery){try{const e=await navigator.permissions.query({name:"microphone"});this.isGrantedMicrophonePermission="granted"===e.state,e.addEventListener("change",(()=>{this.isGrantedMicrophonePermission="granted"===e.state}))}catch(i){}try{const e=await navigator.permissions.query({name:"camera"});this.isGrantedCameraPermission="granted"===e.state,e.addEventListener("change",(()=>{this.isGrantedCameraPermission="granted"===e.state}))}catch(o){}}}async _handleDeviceChange(){if(!navigator.mediaDevices)return;let e;sS&&(e=await navigator.mediaDevices.getUserMedia({audio:!0}));let t=await navigator.mediaDevices.enumerateDevices();t=t.filter((e=>!!e.deviceId)),e&&e.getTracks().forEach((e=>e.stop()));const i=Array.from([...this.deviceMap.audioinput.values(),...this.deviceMap.videoinput.values(),...this.deviceMap.audiooutput.values()]);(vS||pS)&&!i.length&&t.length&&t.forEach((e=>{var t;null===(t=this.deviceMap[e.kind])||void 0===t||t.set(e.deviceId,e)})),t.forEach((e=>{const t=this.deviceMap[e.kind].get(e.deviceId);this.deviceMap[e.kind].set(e.deviceId,e),t||(e.kind.includes("video")?this.emit(wh.onVideoDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"active"}):e.kind.includes("audio")&&this.emit(wh.onAudioDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"active"}))})),i.forEach((e=>{t.find((t=>t.deviceId===e.deviceId&&t.kind===e.kind))||(this.deviceMap[e.kind].delete(e.deviceId),e.kind.includes("video")?this.emit(wh.onVideoDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"inactive"}):e.kind.includes("audio")&&this.emit(wh.onAudioDeviceStateChanged,{mediaDeviceInfo:e,deviceState:"inactive"}))}))}async getUserMedia(e){const t=await navigator.mediaDevices.getUserMedia(e);return null!=e&&e.audio&&(this.isGrantedMicrophonePermission=!0),null!=e&&e.video&&(this.isGrantedCameraPermission=!0),null!=e&&e.video?this.refreshDevices("video"):this.refreshDevices("audio"),t}async checkPermissionsByDevices(){const e={audio:!1,video:!1};if(!navigator.mediaDevices)return e;const t=await navigator.mediaDevices.enumerateDevices();return e.audio=t.filter((e=>"audioinput"===e.kind&&e.label&&e.deviceId)).length>0,e.video=t.filter((e=>"videoinput"===e.kind&&e.label&&e.deviceId)).length>0,e}async getPermissions(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{audio:i,video:o}=t;const{force:s}=t;i||o||(i=!0,o=!0);const r={audio:!1,video:!1,reason:void 0};if(!s)if(this.isSupportedPermissionsQuery){if(i&&o){if(this.isGrantedMicrophonePermission&&this.isGrantedCameraPermission)return r.audio=!0,r.video=!0,r}else if(i&&this.isGrantedMicrophonePermission||o&&this.isGrantedCameraPermission)return r.audio=this.isGrantedMicrophonePermission,r.video=this.isGrantedCameraPermission,r}else{const e=await this.checkPermissionsByDevices();if(i&&o){if(e.audio&&e.video)return e}else if(i&&e.audio||o&&e.video)return e}if(null!==(e=navigator.mediaDevices)&&void 0!==e&&e.getUserMedia)try{const e=await navigator.mediaDevices.getUserMedia({audio:i,video:o});e&&(e.getTracks().forEach((e=>e.stop())),i&&(r.audio=!0,this.isGrantedMicrophonePermission=!0),o&&(r.video=!0,this.isGrantedCameraPermission=!0))}catch(d){if(r.reason=d,this.isSupportedPermissionsQuery){var n,a;if(i)r.audio="granted"===(null===(n=await navigator.permissions.query({name:"microphone"}).catch((()=>{})))||void 0===n?void 0:n.state);if(o)r.video="granted"===(null===(a=await navigator.permissions.query({name:"camera"}).catch((()=>{})))||void 0===a?void 0:a.state)}}return i?await this.refreshDevices("audio"):await this.refreshDevices("video"),r}async updateDeviceListInSilent(){this.isGrantedCameraPermission&&this.isGrantedMicrophonePermission&&this.refreshDevices("audio")}async enumerateDevices(){return await this.getPermissions(),await this.refreshDevices(),Array.from([...this.deviceMap.audioinput.values(),...this.deviceMap.videoinput.values(),...this.deviceMap.audiooutput.values()])}async enumerateAudioCaptureDevices(){return await this.getPermissions({audio:!0}),await this.refreshDevices(),Array.from(this.deviceMap.audioinput.values())}async enumerateVideoCaptureDevices(){return await this.getPermissions({video:!0}),await this.refreshDevices("video"),Array.from(this.deviceMap.videoinput.values())}async enumerateAudioPlaybackDevices(){return await this.getPermissions({audio:!0}),await this.refreshDevices("audio"),Array.from(this.deviceMap.audiooutput.values())}async getAudioPlaybackDeviceById(e){return(await this.enumerateAudioPlaybackDevices()).find((t=>t.deviceId===e))}};By&&(window.__rtc_dd__=LL);var PL=(e=>(e[e.AUTOPLAY_FAILED=-1e3]="AUTOPLAY_FAILED",e[e.TRACK_ERROR=-1001]="TRACK_ERROR",e[e.Fetch_MODIFY=-1002]="Fetch_MODIFY",e[e.BLACK_BROWSER=-1003]="BLACK_BROWSER",e[e.DC_SEND_ERROR=-1004]="DC_SEND_ERROR",e[e.DUPLICATE_DOM=-1005]="DUPLICATE_DOM",e))(PL||{});const kL=new eS("VideoSnapshot",1),NL=async(e,t)=>{const i=document.createElement("canvas"),o=i.getContext("2d");if(!o)throw new Error("canvas.getContext error");const s=(e,t,s)=>(t=t||e.width,s=s||e.height,i.width=t,i.height=s,o.setTransform(1,0,0,1,0,0),o.drawImage(e,0,0,t,s),o.getImageData(0,0,t,s)),r=Date.now(),n=(e=>{const t=null==e?void 0:e.domElement;if(t&&!t.paused&&4===t.readyState)return t})(t);if(n){kL.info("takeSnapshot","VideoPlayer already set.");const e=await s(n,n.videoWidth,n.videoHeight);return kL.info("takeSnapshot","success, cost ".concat(Date.now()-r,"ms")),e}if(window.ImageCapture){const t=new window.ImageCapture(e);if("live"===t.track.readyState&&t.track.enabled&&!t.track.muted){kL.info("takeSnapshot","use ImageCapture");const e=await s(await t.grabFrame());return kL.info("takeSnapshot","success, cost ".concat(Date.now()-r,"ms")),e}}return kL.info("takeSnapshot","use temp video"),new Promise(((t,i)=>{const o=new MediaStream([e]),n=document.createElement("video");n.setAttribute("playsinline",""),n.muted=!0,document.body.appendChild(n),n.onplaying=()=>{const i=s(n,n.videoWidth,n.videoHeight);kL.info("takeSnapshot","success, cost ".concat(Date.now()-r,"ms")),t(i),o.removeTrack(e),n.srcObject=null,n.load()},n.onerror=i,n.srcObject=o,n.play()}))},XL=Symbol("default");var VL=(e=>(e.START_STALL_OBSERVE="start_stall_observe",e.STOP_STALL_OBSERVE="stop_stall_observe",e))(VL||{});class wL extends IT{constructor(e,t,i){super(e,t,Yu(Yu({},i),{},{mediaType:fT.VIDEO})),Ou(this,"resolution",void 0),Ou(this,"videoPlayers",new Map),this.resolution={width:0,height:0}}intersection(){const e={};return this.videoPlayers.forEach(((t,i)=>{e[i.toString()]=t.isIntersecting})),e}async updateVideoCaptureConfig(e){this.logger.info("updateVideoEncoderConfig","update localVideoTrack: ",e);const t=Yu({},e);delete t.contentHint,sS&&this.trackInfo.streamIndex===gT.MAIN&&(t.frameRate={ideal:30,max:30}),await this.originTrack.applyConstraints(t);const i=this.originTrack.getSettings();(i.width&&i.width!==this.resolution.width||i.height&&i.height!==this.resolution.height)&&(this.resolution={width:i.width,height:i.height},this.emit("resolution-change",this.resolution))}setContentHint(e){"contentHint"in this.originTrack&&["text","motion","detail"].includes(e)&&(this.originTrack.contentHint=e)}setTrack(e,t){this._originTrack=e,this.trackInfo=Yu(Yu({},this.trackInfo),t),this.isTrackReady=this.generatePreProcessingTrack()}setPlayer(e,t,i,o){var s;const r=null!==(s=e.playerId)&&void 0!==s?s:XL;let n=this.videoPlayers.get(r);return e.player!==n&&(n=e.player,this.videoPlayers.set(r,n),o(n,this.isPublic,this.streamIndex)),this.mirror(!!t),this.dummy||i===vh.PLAY_MANUALLY||this.play(r),n.domElement}setUserId(e){this.trackInfo.streamUserId=e,this.videoPlayers.forEach((t=>{t.userId=e}))}snapshot(){let e;for(const t of this.videoPlayers.values())if(t.played){e=t;break}return NL(this.preprocessingTrack,e)}setRenderMode(e,t){var i;return null===(i=this.videoPlayers.get(e))||void 0===i?void 0:i.setRenderMode(t)}mirror(e){this.videoPlayers.forEach((t=>{t.mirror(e)}))}removePlayerTrack(){this.videoPlayers.forEach(((e,t)=>{var i;null===(i=this.videoPlayers.get(t))||void 0===i||i.removeTrack()}))}play(e){const t=this.videoPlayers.get(e);return null!=t&&t.played?t.manuallyPlay():null==t?void 0:t.playVideo(this)}playAll(){this.videoPlayers.forEach(((e,t)=>{this.play(t)}))}manuallyPlay(e){var t;return null===(t=this.videoPlayers.get(e))||void 0===t?void 0:t.manuallyPlay()}pause(e){var t;null===(t=this.videoPlayers.get(e))||void 0===t||t.manuallyPause()}stop(e){var t;return null===(t=this.videoPlayers.get(e))||void 0===t?void 0:t.stop()}stopAll(){return this.videoPlayers.forEach(((e,t)=>{this.stop(t)}))}destroy(){this.videoPlayers.forEach(((e,t)=>{this.stop(t),e.removeAllListeners(),this.videoPlayers.delete(t)})),super.destroy()}}class xL extends RT{constructor(e,t,i,o){super(e,t,Yu(Yu({},o),{},{mediaType:fT.VIDEO})),Ou(this,"videoPlayers",new Map),Ou(this,"_stream",void 0),Ou(this,"_observingPlayer",void 0),this._stream=i}get observingPlayerId(){var e;return null===(e=this._observingPlayer)||void 0===e?void 0:e.playerId}getSizeByPlayer(){let e=0,t=0;return this.videoPlayers.forEach((i=>{var o;null!==(o=i.domElement)&&void 0!==o&&o.videoWidth&&i.domElement.videoHeight&&(e=i.domElement.videoWidth,t=i.domElement.videoHeight)})),{width:e,height:t}}intersection(){const e={};return this.videoPlayers.forEach(((t,i)=>{e[i.toString()]=t.isIntersecting})),e}setPlayer(e,t,i,o){var s,r;const n=null!==(s=t.playerId)&&void 0!==s?s:XL;let a=this.videoPlayers.get(n);if(t.player!==a){var d;if(a=t.player,!Hy(this.streamIndex))a.mirror(this._ctx.getRemoteMirrorType(null!==(d=this.trackInfo.streamUserId)&&void 0!==d?d:"",this.streamIndex));this.videoPlayers.set(n,a),this._handlePlayerStallEvent(a),o(a,this.isPublic,this.streamIndex)}return this.dummy||this.play(n),null===(r=a)||void 0===r?void 0:r.domElement}mirror(e){this.videoPlayers.forEach((t=>{t.mirror(e)}))}dangerousGetPlayer(e){return this.videoPlayers.get(e)}snapshot(){let e;for(const t of this.videoPlayers.values())if(t.played){e=t;break}return NL(this.preprocessingTrack,e)}stop(e){var t;null===(t=this.videoPlayers.get(e))||void 0===t||t.stop()}stopAll(){this.videoPlayers.forEach(((e,t)=>{this.stop(t)}))}play(e){if(this._ctx.autoPlayPolicy===vh.PLAY_MANUALLY)return;const t=this.videoPlayers.get(e);return null==t?void 0:t.playVideo(this)}manuallyPlay(e){const t=this.videoPlayers.get(e);return null!=t&&t.played?t.manuallyPlay():null==t?void 0:t.playVideo(this)}pause(e){var t;return null===(t=this.videoPlayers.get(e))||void 0===t?void 0:t.manuallyPause()}_handlePlayerStallEvent(e){e.on("start_stall_observe",(()=>{!this._observingPlayer&&e&&(this._observingPlayer=e,this._stream.startVideoStallObserve(this._observingPlayer))})),e.on("stop_stall_observe",(()=>{this._observingPlayer===e&&(this._stream.stopVideoStallObserve(),this._observingPlayer=void 0,this.videoPlayers.forEach((e=>{!this._observingPlayer&&e.played&&(this._observingPlayer=e,this._stream.startVideoStallObserve(e))})))}))}destroy(){this.videoPlayers.forEach(((e,t)=>{this.stop(t),e.removeAllListeners(),this.videoPlayers.delete(t)})),super.destroy()}}const GL=["play","playing","pause","ended","error","seeking","seeked","waiting","canplay","canplaythrough","durationchange","volumechange","loadedmetadata","loadeddata","loadstart","timeupdate"],WL={playsinline:"","webkit-playsinline":""},ML={playsinline:"","webkit-playsinline":"","x5-playsinline":"","x5-video-player-type":"h5","x-webkit-airplay":"allow",preload:"",muted:""};class AL extends sT.EventEmitter{constructor(e,t,i){super(),Ou(this,"_containerDom",void 0),Ou(this,"_videoDom",void 0),Ou(this,"userId",void 0),Ou(this,"renderMode",void 0),Ou(this,"mirrorType",sh.MIRROR_TYPE_NONE),Ou(this,"isScreen",void 0),Ou(this,"isLocal",void 0),Ou(this,"played",!1),Ou(this,"_needLoad",!1),Ou(this,"_emitPlayFailed",!1),Ou(this,"_videoContainer",void 0),Ou(this,"_safari15VideoTimer",void 0),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),Ou(this,"_onLocalTrackMute",void 0),Ou(this,"_onInterruptionEnd",void 0),Ou(this,"_needResume",!1),Ou(this,"_rotate",0),Ou(this,"_rotateDom",void 0),Ou(this,"_resizeObserver",void 0),Ou(this,"_hasManuallyPaused",!1),Ou(this,"isIntersecting",void 0),Ou(this,"intersectionObserver",void 0),Ou(this,"emitVideoEvent",(e=>{var t,i;const o={type:"video",rawEvent:e,readyState:(null===(t=this._videoDom)||void 0===t?void 0:t.readyState)||0,userId:this.userId,eventName:e.type,currentTime:(null===(i=this._videoDom)||void 0===i?void 0:i.currentTime)||0,isScreen:this.isScreen};switch(this.emit("playback_event",o),e.type){case"canplay":this.refreshRenderSize("the video started playing."),this._internalPlay();break;case"loadeddata":this._internalPlay();break;case"playing":this.logger.info("VideoPlayerPlaying","[userId-".concat(this.userId,"] video element playing"));break;case"pause":this.logger.info("VideoPlayerPause","[userId-".concat(this.userId,"] video element pause")),this._needResume&&(this.logger.info("VideoPlayerPause","[userId-".concat(this.userId,"] video element resume")),this._internalPlay(),this._needResume=!1)}})),Ou(this,"_internalPlay",(()=>{var e,t;if(Wv(this.engineId,"video _internalPlay",{paused:null===(e=this._videoDom)||void 0===e?void 0:e.paused,hasManuallyPaused:this._hasManuallyPaused}),this._hasManuallyPaused||null===(t=this._videoDom)||void 0===t||!t.paused)return;const i=this._videoDom.play();null!=i&&i.then&&i.then((()=>{var e;this.isLocal&&aS&&!this._needLoad&&(null===(e=this._videoDom)||void 0===e||e.load(),this._needLoad=!0)})).catch((e=>{var t,i,o,s;this._emitPlayFailed||("AbortError"!==e.name?(this._emitPlayFailed=!0,null===(t=this._monitor)||void 0===t||t.report("rtc_error",{message:"video autoplay failed, userId: ".concat(this.userId,", ").concat(e.name),error_code:PL.AUTOPLAY_FAILED}),this.emit("playback_event",{type:"video",rawEvent:e,readyState:(null===(i=this._videoDom)||void 0===i?void 0:i.readyState)||0,userId:this.userId,eventName:"autoplay-error",currentTime:(null===(o=this._videoDom)||void 0===o?void 0:o.currentTime)||0,isScreen:this.isScreen})):null===(s=this._monitor)||void 0===s||s.report("rtc_error",{message:"video autoplay failed, userId: ".concat(this.userId,", ").concat(e.name),error_code:PL.AUTOPLAY_FAILED}))}))})),this.engineId=e,this.playerId=t;const o=i.renderDom;this._monitor=Nv(e),this.logger=new eS("Player",0,e);const{userId:s}=i,r=i.isScreen?Bu.RENDER_MODE_FIT:Bu.RENDER_MODE_HIDDEN;this.renderMode=void 0!==i.renderMode?i.renderMode:r,this._rotate=Number(i.rotation||0);const n="string"==typeof o?document.getElementById(o):o;if(!n)throw new HS(US.CANT_FIND_DOM,"can't find dom");this._videoContainer=document.createElement("div"),this._videoContainer.style.width="100%",this._videoContainer.style.height="100%",this._videoContainer.style.position="relative",this._videoContainer.style.overflow="hidden",this._containerDom=n,this.userId=s,this.isLocal=!!i.isLocal,this.isScreen=!!i.isScreen,this._initVideo(),!this.isLocal||15!==(null==kS?void 0:kS[0])&&15!==ZS||(this._safari15VideoTimer=setTimeout((()=>{try{this._videoContainer.style.display="block",setTimeout((()=>{this._videoContainer.style.display="flex"}),500)}catch(BW){}}),1e3))}_initVideo(){this._videoDom||(this._videoDom=ZL("video",{style:{width:"100%",height:"100%"},attributes:ML}),this._videoDom.id="".concat(this.userId,"_").concat(Vy()),this.setRenderMode(this.renderMode),this.mirror(this.mirrorType===sh.MIRROR_TYPE_RENDER)),this._containerDom.appendChild(this._videoContainer),[90,270].indexOf(this._rotate)>-1?(this._rotateDom=this._createRotationDiv(),this._rotateDom.appendChild(this._videoDom),this._videoContainer.appendChild(this._rotateDom)):(180===this._rotate&&(this._videoContainer.style.transform="rotate(180deg)"),this._videoContainer.appendChild(this._videoDom)),this._initInterSectionObserver(),this._initListeners(),this._onLocalTrackMute=()=>{this._needResume=!0},this._onInterruptionEnd=()=>{this.logger.warn("resume player after iOS interruption"),this._internalPlay()},gL.on(yL.ON_IOS_LOCAL_TRACK_MUTE,this._onLocalTrackMute),gL.on(yL.ON_IOS_LOCAL_TRACK_UNMUTE,this._onInterruptionEnd),gL.on(yL.ON_IOS_INTERRUPTION_END,this._onInterruptionEnd)}_initInterSectionObserver(){!this.intersectionObserver&&"undefined"!=typeof IntersectionObserver&&this._videoDom&&(this.intersectionObserver=new IntersectionObserver((e=>{e[0]&&(this.isIntersecting=e[0].isIntersecting)}),{}),this.intersectionObserver.observe(this._videoDom))}_closeIntersectionObserver(){this.intersectionObserver&&this._videoDom&&(this.intersectionObserver.disconnect(),this.intersectionObserver.unobserve(this._videoDom),delete this.intersectionObserver)}_createRotationDiv(){const e=document.createElement("div");return e.style.transform="rotate(".concat(this._rotate,"deg)"),180!==this._rotate&&(e.style.position="absolute",this.refreshRenderSize("init"),window.ResizeObserver&&(this._resizeObserver=new ResizeObserver((()=>{this.refreshRenderSize("the container size has changed.")})),this._resizeObserver.observe(this._containerDom))),e}refreshRenderSize(e){if(this._rotateDom){var t,i;this.logger.print("refreshRenderSize","Because ".concat(e));const o=Number(window.getComputedStyle(this._containerDom).width.replace("px","")),s=Number(window.getComputedStyle(this._containerDom).height.replace("px","")),r=null===(t=this._videoDom)||void 0===t?void 0:t.videoWidth,n=null===(i=this._videoDom)||void 0===i?void 0:i.videoHeight;if(o&&s&&n&&r){let e,t;if(this.renderMode===Bu.RENDER_MODE_FILL)e=s,t=o;else{const i=this.renderMode===Bu.RENDER_MODE_HIDDEN?Math.max(o/n,s/r):Math.min(o/n,s/r);e=r*i,t=n*i}this._rotateDom.style.width="".concat(e,"px"),this._rotateDom.style.height="".concat(t,"px"),this._rotateDom.style.left="".concat((o-e)/2,"px"),this._rotateDom.style.top="".concat((s-t)/2,"px")}}}_initListeners(){this._videoDom&&GL.forEach((e=>{var t;null===(t=this._videoDom)||void 0===t||t.addEventListener(e,this.emitVideoEvent)}))}_removeListeners(){this._videoDom&&GL.forEach((e=>{var t;null===(t=this._videoDom)||void 0===t||t.removeEventListener(e,this.emitVideoEvent)}))}setRenderMode(e){this.renderMode=e,this._videoDom&&(this.renderMode===Bu.RENDER_MODE_FIT?this._videoDom.style.objectFit="contain":this.renderMode===Bu.RENDER_MODE_FILL?this._videoDom.style.objectFit="fill":this._videoDom.style.objectFit="cover")}async playVideo(e){var t,i;let o=this._videoDom;if(this.logger.info("playVideo","play video track: ".concat(this.userId)),o&&o.srcObject instanceof MediaStream&&o.srcObject.getTrackById(null===(t=e.preprocessingTrack)||void 0===t?void 0:t.id)){try{Wv(this.engineId,"playVideo","play video repeatedly",0,this.userId)}catch(BW){}return}o||(this._initVideo(),o=this._videoDom),this.logger.info("playVideo","play video by dom: ".concat(null===(i=o)||void 0===i?void 0:i.id));const s=new MediaStream;s.addTrack(e.preprocessingTrack),o.srcObject=s,o&&!this._containerDom.contains(this._videoContainer)&&this._containerDom.appendChild(this._videoContainer),o&&!this._videoContainer.contains(o)&&this._videoContainer.appendChild(o),setTimeout((()=>this._internalPlay())),_y.VIDEO_STALL&&this.emit(VL.START_STALL_OBSERVE),this.played=!0}updateSrcObject(e){const t=e.preprocessingTrack;if(!t||!this._videoDom)return;const i=new MediaStream;i.addTrack(t),this._videoDom.srcObject=i}removeTrack(){var e;const t=null===(e=this._videoDom)||void 0===e?void 0:e.srcObject;if(t){const e=t.getVideoTracks();null!=e&&e.length&&e.forEach((e=>{t.removeTrack(e)}))}}manuallyPlay(){if(this.logger.info("Invoke VideoPlayer.manuallyPlay",this.userId,this.isScreen),this._emitPlayFailed=!1,this._hasManuallyPaused=!1,!this._videoDom)throw new HS(US.INVALID_PARAMS,"Player not found");return 0!==this._videoDom.readyState||bS?this._videoDom.play():Promise.resolve()}manuallyPause(){if(this.logger.print("Invoke VideoPlayer.manuallyPause",this.userId,this.isScreen),this.played){if(this._hasManuallyPaused=!0,!this._videoDom)throw new HS(US.INVALID_PARAMS,"Player not found");return this._videoDom.pause()}}mirror(e){this.logger.info("mirror","".concat(this.userId," set mirror: ").concat(e)),this.mirrorType=e?sh.MIRROR_TYPE_RENDER:sh.MIRROR_TYPE_NONE,this._videoDom&&(this._videoDom.style.transform=e?"rotateY(180deg)":"")}stop(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const{_containerDom:t}=this;var i,o;(this.logger.info("stop","stop video track: ".concat(this.userId," ").concat(this.playerId.toString())),this._videoDom)&&(e||(this._videoDom.srcObject=null),null!=t&&t.contains(this._videoContainer)&&t.removeChild(this._videoContainer),null===(i=this._videoContainer)||void 0===i||i.childNodes.forEach((e=>{e!==this._videoDom&&e!==this._rotateDom||this._videoContainer.removeChild(e)})),null!==(o=this._rotateDom)&&void 0!==o&&o.contains(this._videoDom)&&this._rotateDom.removeChild(this._videoDom));this._hasManuallyPaused=!1,this.played=!1,_y.VIDEO_STALL&&this.emit(VL.STOP_STALL_OBSERVE),this._closeIntersectionObserver()}destroy(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.logger.info("destroy","video player: ".concat(this.userId)),this.stop(t),null===(e=this._resizeObserver)||void 0===e||e.disconnect(),super.removeAllListeners(),this._removeListeners(),gL.off(yL.ON_IOS_LOCAL_TRACK_MUTE,this._onLocalTrackMute),gL.off(yL.ON_IOS_LOCAL_TRACK_UNMUTE,this._onInterruptionEnd),gL.off(yL.ON_IOS_INTERRUPTION_END,this._onInterruptionEnd),this._videoDom&&delete this._videoDom,this._safari15VideoTimer&&(window.clearInterval(this._safari15VideoTimer),this._safari15VideoTimer=void 0)}get domElement(){return this._videoDom}}class OL extends sT.EventEmitter{constructor(e,t){let{divId:i,muted:o,isScreen:s}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{divId:void 0,muted:!1,isScreen:!1};if(super(),Ou(this,"_containerDom",void 0),Ou(this,"_audioDom",void 0),Ou(this,"_fakeAudioDom",void 0),Ou(this,"userId",void 0),Ou(this,"muted",!1),Ou(this,"_emitPlayFailed",!1),Ou(this,"played",!1),Ou(this,"isScreen",void 0),Ou(this,"_wechatTimer",void 0),Ou(this,"_edgeTimer",void 0),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),Ou(this,"_pasued",!0),Ou(this,"emitAudioEvent",(e=>{var t,i;const o={type:"audio",rawEvent:e,readyState:(null===(t=this._audioDom)||void 0===t?void 0:t.readyState)||0,userId:this.userId,eventName:e.type,currentTime:(null===(i=this._audioDom)||void 0===i?void 0:i.currentTime)||0};var s;("playing"===e.type&&this.logger.info("AudioPlayerPlaying","[userId-".concat(this.userId,"] audio element playing")),"pause"===e.type)&&(this.logger.info("AudioPlayerPause","[userId-".concat(this.userId,"] audio element pause")),!this._pasued&&null!==(s=this._audioDom)&&void 0!==s&&null!==(s=s.srcObject)&&void 0!==s&&s.active&&this._internalPlay());yS&&bS&&("canplay"===e.type?(clearTimeout(this._wechatTimer),this._wechatTimer=setTimeout((()=>{this._autoPlayError("wechat")}),500)):"playing"===e.type&&clearTimeout(this._wechatTimer)),vS&&uS&&"error"===e.type&&(clearTimeout(this._edgeTimer),this._edgeTimer=setTimeout((()=>{var e;0===(null===(e=this._audioDom)||void 0===e?void 0:e.currentTime)&&this._autoPlayError("edge")}),500)),this.emit("playback_event",o)})),Ou(this,"_internalPlay",(()=>{var e,t;if(Wv(this.engineId,"audio _internalPlay",{paused:null===(e=this._audioDom)||void 0===e?void 0:e.paused,userId:this.userId,screen:this.isScreen}),null!==(t=this._audioDom)&&void 0!==t&&t.paused)try{var i;let e=this._audioDom.play();const t=CL.getAudioContextInstance();if("suspended"===t.state){const e=t.resume(),i=setTimeout((()=>{var e;"suspended"===t.state&&(this._autoPlayError("AudioContext cannot resume"),null===(e=this._monitor)||void 0===e||e.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": Cannot resume the AudioContext - timeout"),error_code:PL.AUTOPLAY_FAILED}));clearTimeout(i)}));e.catch((e=>{var t;this._autoPlayError("AudioContext cannot resume"),null===(t=this._monitor)||void 0===t||t.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": Cannot resume the AudioContext - rejected by: [").concat(null==e?void 0:e.name,"]").concat(null==e?void 0:e.message),error_code:PL.AUTOPLAY_FAILED})})).finally((()=>{clearTimeout(i)}))}null!==(i=e)&&void 0!==i&&i.then&&(yS&&vS&&(e=e.then((()=>new Promise((e=>{setTimeout((async()=>{var t;null===(t=this._audioDom)||void 0===t||t.pause(),this._audioDom.volume=1,await this._audioDom.play(),e()}),500)}))))),e.then((()=>{Wv(this.engineId,"_internalPlay successfully",{userId:this.userId,screen:this.isScreen}),this._pasued=!1})).catch((e=>{var t;this._autoPlayError(e),null===(t=this._monitor)||void 0===t||t.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": ").concat(e.message," ").concat(e.name),error_code:PL.AUTOPLAY_FAILED})})))}catch(s){var o;this._autoPlayError(s),null===(o=this._monitor)||void 0===o||o.report("rtc_error",{message:"audio autoplay failed, userId: ".concat(this.userId,": ").concat(s.message," ").concat(s.name),error_code:PL.AUTOPLAY_FAILED})}})),this.engineId=e,i){const e=document.getElementById(i);if(!e)throw new HS(US.CANT_FIND_DOM,"can't find dom");this._containerDom=e}else this._containerDom=document.body;this.userId=t,this.muted=o,this.isScreen=s,this._monitor=Nv(e),this.logger=new eS("Player",0,e),this._initAudio()}_initAudio(){this._audioDom||(this._audioDom=ZL("audio",{style:{display:"none"},attributes:WL}),this._audioDom.volume=this.muted?0:1,this._audioDom.muted=this.muted,this._audioDom.id="".concat(this.userId,"_").concat(Vy()),this._containerDom.appendChild(this._audioDom)),this._initListeners()}_initListeners(){this._audioDom&&GL.forEach((e=>{var t;null===(t=this._audioDom)||void 0===t||t.addEventListener(e,this.emitAudioEvent)}))}_removeListeners(){this._audioDom&&(GL.forEach((e=>{var t;null===(t=this._audioDom)||void 0===t||t.removeEventListener(e,this.emitAudioEvent)})),this._audioDom.removeEventListener("canplay",this._internalPlay),this._audioDom.removeEventListener("loadeddata",this._internalPlay))}async playAudio(e){var t,i,o;this.logger.info("playAudio","play audio track: ".concat(this.userId));let s=this._audioDom;if(s&&s.srcObject instanceof MediaStream&&s.srcObject.getTrackById(null===(t=e.preprocessingTrack)||void 0===t?void 0:t.id))return;s||(this._initAudio(),s=this._audioDom);const r=new MediaStream;e instanceof KL?(this._fakeAudioDom=new Audio,this._fakeAudioDom.muted=!0,this._fakeAudioDom.srcObject=new MediaStream([e.originTrack]),r.addTrack(e.preprocessingTrack)):r.addTrack(e.preprocessingTrack),yS&&vS&&(this._audioDom.volume=0),s.srcObject=r,null===(i=s)||void 0===i||i.addEventListener("canplay",this._internalPlay),null===(o=s)||void 0===o||o.addEventListener("loadeddata",this._internalPlay),setTimeout((()=>this._internalPlay())),this.played=!0}_autoPlayError(e){var t,i;this._emitPlayFailed||(this._emitPlayFailed=!0,this.emit("playback_event",{type:"audio",rawEvent:e,readyState:(null===(t=this._audioDom)||void 0===t?void 0:t.readyState)||0,userId:this.userId,eventName:"autoplay-error",currentTime:(null===(i=this._audioDom)||void 0===i?void 0:i.currentTime)||0}))}pause(){if(!this._audioDom)throw new HS(US.INVALID_PARAMS,"Player not found");this._pasued=!0,this._audioDom.pause()}manuallyPause(){return this.pause()}manuallyPlay(){var e;if(this.logger.info("Invoke AudioPlayer.manuallyPlay"),this._emitPlayFailed=!1,!this._audioDom)throw new HS(US.INVALID_PARAMS,"Player not found");if(!this.played)return Promise.resolve();this._audioDom.volume=1,this._audioDom.muted=!1,null===(e=this._fakeAudioDom)||void 0===e||e.play();const t=[],i=this._audioDom.play();null!=i&&i.then&&t.push(i);const o=CL.getAudioContextInstance();if("suspended"===o.state){const e=o.resume();null!=e&&e.then&&t.push(e)}(t.length>0?Promise.all(t):Promise.resolve(i)).then((()=>{this._pasued=!1}))}async setPlaybackDevice(e){this.logger.info("setPlaybackDevice","setPlaybackDevice: ".concat(e));(await LL.enumerateAudioPlaybackDevices()).map((e=>e.deviceId)).includes(e)&&this._audioDom&&this._audioDom.setSinkId&&await this._audioDom.setSinkId(e)}stop(){const{_containerDom:e}=this;this.logger.info("stopAudio","stop audio track: ".concat(this.userId)),this._audioDom&&(this._audioDom.srcObject=null,null!=e&&e.contains(this._audioDom)&&e.removeChild(this._audioDom)),this._fakeAudioDom&&(this._fakeAudioDom.srcObject=null,this._fakeAudioDom=void 0),this.played=!1}get domElement(){return this._audioDom}destroy(){this.logger.info("destroy","audio player: ".concat(this.userId)),this.stop(),super.removeAllListeners(),this._removeListeners(),this._audioDom&&(this._audioDom.srcObject=null,delete this._audioDom),this._edgeTimer&&clearTimeout(this._edgeTimer)}}class DL{constructor(){Ou(this,"_ac",void 0),Ou(this,"_sourceNode",void 0),Ou(this,"_gainNode",void 0),Ou(this,"_destNode",void 0),this._ac=CL.getAudioContextInstance(),this._gainNode=this._ac.createGain(),this._destNode=this._ac.createMediaStreamDestination(),this._gainNode.connect(this._destNode)}setVolume(e){this._gainNode.gain.value=e/100}getVolume(){return Math.round(100*this._gainNode.gain.value)}updateInputTrack(e){this._sourceNode&&(this._sourceNode.mediaStream.getTracks().forEach((e=>{e.stop()})),delete this._sourceNode);const t=new MediaStream;t.addTrack(e),this._sourceNode=this._ac.createMediaStreamSource(t),this._sourceNode.connect(this._gainNode)}getOutputTrack(){return this._destNode.stream.getTracks()[0]}destroy(){var e,t;null===(e=this._sourceNode)||void 0===e||e.mediaStream.getTracks().forEach((e=>{e.stop()})),13!==ZS&&this._destNode.stream.getTracks().forEach((e=>{e.stop()})),null===(t=this._sourceNode)||void 0===t||t.disconnect(),this._gainNode.disconnect(),delete this._sourceNode}}class YL extends IT{constructor(e,t,i){super(e,t,Yu(Yu({},i),{},{mediaType:fT.AUDIO})),Ou(this,"audioCaptureConfig",void 0),Ou(this,"_ap",void 0),Ou(this,"mixedAudioTrack",void 0),Ou(this,"mixType",Nh.PLAYOUT_AND_PUBLISH),Ou(this,"_audioFetchMap",new Map),Ou(this,"_audioDataFetcher",void 0),Ou(this,"_localPlaybackTrack",void 0),Ou(this,"notSupportedWebAudio",!1)}get withWebAudio(){return!!this._ap}getAudioLevel(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nh.MICROPHONE;const i=t===nh.AUDIOMIXING&&this.mixType!==Nh.PLAYOUT&&null!==(e=this.mixedAudioTrack)&&void 0!==e?e:this.preprocessingTrack;let o=this._audioFetchMap.get(t);var s;o&&o.currentTrackId===i.id||(null===(s=o)||void 0===s||s.destroy(),o=new RL(i),this._audioFetchMap.set(t,o));return o.getAudioLevel()}async updateAudioCaptureConfig(){this.audioCaptureConfig&&(this.logger.print("updateAudioCaptureConfig","update localAudioTrack: ",this.audioCaptureConfig),await this.originTrack.applyConstraints(this.audioCaptureConfig))}setVolume(e){const t=!vy("SKIP_WEB_AUDIO_IN_TRACK")&&YT();t||(this.notSupportedWebAudio=!0);const i=!this.withWebAudio&&100!==e;try{t&&i&&(this.logger.print("Create AudioProcess"),this._ap=new DL,this._ap.updateInputTrack(this.originTrack),this.mediaTrack=this._ap.getOutputTrack())}catch(s){this.logger.warn("WebAudio may not supported, quired return"),this.notSupportedWebAudio=!0}var o;this.notSupportedWebAudio||(null===(o=this._ap)||void 0===o||o.setVolume(e));t&&i&&this.emit("needReplaceTrack",this)}getVolume(){return this._ap?this._ap.getVolume():100}setUserId(e){this.trackInfo.streamUserId=e}setDataFetcher(e,t){this.logger.info("setDataFetcher","frameSize %s",e),null!==CL.isWorkletReady?this._audioDataFetcher?this._audioDataFetcher.setFrameSize(e):(this._audioDataFetcher=new EL(this.preprocessingTrack,e),this._audioDataFetcher.on("data",t)):this.logger.info("setDataFetcher","audioContextManager.isWorkletReady is null")}stopDataFetcher(){var e,t;null===(e=this._audioDataFetcher)||void 0===e||e.removeAllListeners("data"),null===(t=this._audioDataFetcher)||void 0===t||t.destroy(),this._audioDataFetcher=void 0}play(e){var t,i;this._localPlaybackTrack&&this.stop();const o=e===Zh.AFTER_CAPTURE?this.originTrack:e===Zh.AFTER_PROCESS?this.preprocessingTrack:void 0;if(!o)return void this.logger.error("play()","no target track for %s",e);this._localPlaybackTrack=new KL(this._ctx,o.clone(),Yu({},this.trackInfo));const s=this._ctx.earMonitorSettings[null!==(t=this.streamIndex)&&void 0!==t?t:qu.STREAM_INDEX_MAIN].volume;this.setPlaybackVolume(s);const r=new OL(this._ctx.id,null!==(i=this.trackInfo.streamUserId)&&void 0!==i?i:"",{isScreen:this.streamIndex===qu.STREAM_INDEX_SCREEN,muted:!1});return r.on("playback_event",(e=>{var t;"autoplay-error"===e.eventName&&this.emit("autoplay-error",{kind:"audio",streamIndex:null!==(t=this.streamIndex)&&void 0!==t?t:qu.STREAM_INDEX_MAIN,mediaType:fT.AUDIO})})),this._localPlaybackTrack.setPlayer(r),this._localPlaybackTrack.play()}stop(){var e;null===(e=this._localPlaybackTrack)||void 0===e||e.destroy(),this._localPlaybackTrack=void 0}setPlaybackVolume(e){var t;return null===(t=this._localPlaybackTrack)||void 0===t?void 0:t.setVolume(e)}destroy(){var e,t;this._audioFetchMap.forEach((e=>e.destroy())),this._audioFetchMap.clear(),null===(e=this._ap)||void 0===e||e.destroy(),null===(t=this._audioDataFetcher)||void 0===t||t.destroy(),this._audioDataFetcher=void 0,this.stop(),super.destroy()}}class KL extends RT{constructor(e,t,i){super(e,t,Yu(Yu({},i),{},{mediaType:fT.AUDIO})),Ou(this,"_ap",void 0),Ou(this,"_audioPlayer",void 0),Ou(this,"_audioLevelFetcher",void 0),Ou(this,"_audioDataFetcher",void 0),Ou(this,"notSupportedWebAudio",!1)}get withWebAudio(){return!!this._ap}getAudioLevel(){return this._audioLevelFetcher||(this._audioLevelFetcher=new RL(this.originTrack)),this._audioLevelFetcher.getAudioLevel()}setVolume(e){const t=!vy("SKIP_WEB_AUDIO_IN_TRACK")&&YT();t||(this.notSupportedWebAudio=!0);const i=!this.withWebAudio&&100!==e;try{t&&i&&(this.logger.print("Create AudioProcess"),this._ap=new DL,this._ap.updateInputTrack(this.originTrack),this.mediaTrack=this._ap.getOutputTrack())}catch(r){this.logger.warn("WebAudio may not supported, quite return"),this.notSupportedWebAudio=!0}var o,s;this.notSupportedWebAudio||(null===(o=this._ap)||void 0===o||o.setVolume(e));t&&i&&(this.emit("needReplaceTrack",this),null===(s=this._audioPlayer)||void 0===s||s.playAudio(this))}getVolume(){return this.notSupportedWebAudio?100:this._ap?this._ap.getVolume():100}setPlaybackDevice(e){var t;return null===(t=this._audioPlayer)||void 0===t?void 0:t.setPlaybackDevice(e)}setPlayer(e){this._audioPlayer=e}havePlayer(){return!!this._audioPlayer}bindPlayerEvent(e){var t;this._audioPlayer&&e(this._audioPlayer,this.isPublic,null!==(t=this.streamIndex)&&void 0!==t?t:qu.STREAM_INDEX_MAIN)}pause(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.pause()}play(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.playAudio(this)}manuallyPlay(){var e,t,i;return null!==(e=this._audioPlayer)&&void 0!==e&&e.played?null===(t=this._audioPlayer)||void 0===t?void 0:t.manuallyPlay():null===(i=this._audioPlayer)||void 0===i?void 0:i.playAudio(this)}manuallyPause(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.manuallyPause()}stop(){var e;return null===(e=this._audioPlayer)||void 0===e?void 0:e.stop()}setDataFetcher(e,t){this.logger.info("setDataFetcher","frameSize %s",e),null!==CL.isWorkletReady?this._audioDataFetcher?this._audioDataFetcher.setFrameSize(e):(this._audioDataFetcher=new EL(this.originTrack,e),this._audioDataFetcher.on("data",t)):this.logger.warn("setDataFetcher","audioContextManager.isWorkletReady is null")}stopDataFetcher(){var e;this.logger.info("stopDataFetcher"),null===(e=this._audioDataFetcher)||void 0===e||e.destroy(),this._audioDataFetcher=void 0}destroy(){var e,t,i;null===(e=this._audioLevelFetcher)||void 0===e||e.destroy(),null===(t=this._audioDataFetcher)||void 0===t||t.destroy(),this._audioDataFetcher=void 0,this._ap&&this._ap.destroy(),null===(i=this._audioPlayer)||void 0===i||i.destroy(),this._audioPlayer=void 0,super.destroy()}}const UL=new eS("VERTC",0);let FL,HL=null;function JL(){if(HL)return HL;try{HL=window.require("electron");const{ipcRenderer:e}=HL;return FL={getSources:t=>e.invoke("DESKTOP_CAPTURER_GET_SOURCES",t)},HL}catch(e){return null}}async function zL(e,t,i){let o;return t||(t={width:1920,height:1080,frameRate:15}),o=i?{audio:{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",maxHeight:t.height,maxWidth:t.width,maxFrameRate:t.frameRate}}}:{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:t.height,maxWidth:t.width,maxFrameRate:t.frameRate}}},UL.info("getUserMediaConfig",JSON.stringify(o)),await navigator.mediaDevices.getUserMedia(o)}async function jL(e){let t=["window","screen"];"window"===e&&(t=["window"]),"screen"===e&&(t=["screen"]);if(!JL())throw new HS(US.ERR_ELECTRON_IS_NULL,"Unable to get Electron object");let i=null;try{i=FL.getSources({types:t})}catch(o){i=null}i&&i.then||(i=new Promise(((e,i)=>{FL.getSources({types:t},((t,o)=>{t?i(t):e(o)}))})));try{return await i}catch(s){throw new HS(US.ERR_ELECTRON_IS_NULL,s.toString())}}async function QL(e,t){const i=await jL(),o=await function(e){return new Promise(((t,i)=>{const o=document.createElement("div");o.innerText="share screen",o.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const s=document.createElement("div");s.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const r=document.createElement("div");r.innerText="Web Screensharing wants to share the contents of your screen. Choose what you'd like to share.",r.setAttribute("style","height: 12%;");const n=document.createElement("div");n.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const a=document.createElement("div");a.setAttribute("style","text-align: right; padding: 16px 0;");const d=document.createElement("button");d.innerHTML="cancel",d.setAttribute("style","width: 85px;"),d.onclick=()=>{document.body.removeChild(c);const e=new Error("NotAllowedError");e.name="NotAllowedError",i(e)},a.appendChild(d),s.appendChild(r),s.appendChild(n),s.appendChild(a);const c=document.createElement("div");c.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),c.appendChild(o),c.appendChild(s),document.body.appendChild(c),e.map((e=>{if(e.id){const i=document.createElement("div");i.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;"),i.innerHTML="<div style='height: 120px; display: table-cell; vertical-align: middle;'> \n          <img style='width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);' src=\n          ".concat(e.thumbnail.toDataURL(),"\n           />\n          </div>\n          <span style='\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'>\n          ").concat(e.name,"\n          </span>"),i.onclick=()=>{document.body.removeChild(c),t(e.id)},n.appendChild(i)}}))}))}(i);return await zL(o,e,t)}async function BL(e,t){var i;let o;const s=(null===(i=(t=t||e.videoProfile.getCaptureConfig()).deviceId)||void 0===i?void 0:i.exact)||"default",r=vm(),n=new eS("TrackFactory",0,e.id);try{var a,d,c;n.info("createCameraVideoTrack","constraints:",t),null===(a=e.monitor)||void 0===a||a.report("rtc_video_capture_event",{event_type:"start",media_device_id:s,capture_session_id:r});const i=wy();sS&&(t.frameRate={ideal:30,max:30}),o=await LL.getUserMedia({video:t}),null===(d=e.monitor)||void 0===d||d.report("rtc_video_capture_event",{event_type:"start_capture_result",media_device_id:s,media_device_name:(null===(c=o.getVideoTracks()[0])||void 0===c?void 0:c.label)||"",reason:"success",elapse:wy()-i,capture_session_id:r})}catch(BW){var l;throw null===(l=e.monitor)||void 0===l||l.report("rtc_video_capture_event",{event_type:"running_failed",media_device_id:s,error_code:BW.code,reason:BW.name+BW.message,capture_session_id:r}),new HS(US.GET_VIDEO_TRACK_FAILED,"throw error from getUserMedia. [".concat(BW.name||"unknown name","]: ").concat(BW.message||"unknown message","."),BW)}const u=o.getVideoTracks()[0],h=new wL(e,u,{streamIndex:gT.MAIN,sourceType:yT.INTERNAL,captureSessionId:r});return await h.isTrackReady,h}async function qL(e,t){var i;let o;new eS("TrackFactory",0,e.id).info("createMicrophoneAudioTrack","constraints:",t);const s=(null===(i=t.deviceId)||void 0===i?void 0:i.exact)||"default",r=vm();try{var n,a,d;null===(n=e.monitor)||void 0===n||n.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_begin",media_device_id:s,event_session_id:r});const i=wy();e.extensionManager.getPluginByName(_L.PRE_PROCESSING,"RTCAIAnsExtension")&&(t.autoGainControl=!0,t.noiseSuppression=!1),o=await LL.getUserMedia({audio:t}),null===(a=e.monitor)||void 0===a||a.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_result",media_device_id:s,media_device_name:(null===(d=o.getAudioTracks()[0])||void 0===d?void 0:d.label)||"",reason:"success",elapse:wy()-i,event_session_id:r})}catch(BW){var c;throw null===(c=e.monitor)||void 0===c||c.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_end",media_device_id:s,error_code:BW.code,reason:BW.name+BW.message,event_session_id:r}),new HS(US.GET_AUDIO_TRACK_FAILED,"throw error from getUserMedia. [".concat(BW.name||"unknown name","]: ").concat(BW.message||"unknown message","."),BW)}const l=o.getAudioTracks()[0],u=new YL(e,l,{streamIndex:gT.MAIN,sourceType:yT.INTERNAL,captureSessionId:r});return await u.isTrackReady,u}async function $L(e,t){const i=new eS("TrackFactory",0,e.id);let o,s=e.videoProfile.getScreenEncodeConfig();i.info("createScreenTracks","screenConfig: %o, constraints: %o",t,s);const r=vm(),{enableAudio:n=!1,displaySurface:a,systemAudio:d,surfaceSwitching:c,selfBrowserSurface:l,sourceId:u}=t,h={};a&&["monitor","browser","window"].includes(a)&&(s?s.displaySurface=a:s={displaySurface:a}),d&&["include","exclude"].includes(d)&&(h.systemAudio=d),c&&["include","exclude"].includes(c)&&(h.surfaceSwitching=c),l&&["include","exclude"].includes(l)&&(h.selfBrowserSurface=l);try{var m,p,_,b;null===(m=e.monitor)||void 0===m||m.report("rtc_video_capture_event",{event_type:"start",media_device_id:"screen",capture_session_id:r});const t=wy();o=JL()?u?await zL(u,s,n):await QL(s,n):await navigator.mediaDevices.getDisplayMedia(Yu({video:!(s&&(!rS||"16.1"!==PS))||s,audio:!!n&&{channelCount:2,noiseSuppression:!1,echoCancellation:!0,autoGainControl:!1}},h)),null===(p=e.monitor)||void 0===p||p.report("rtc_video_capture_event",{event_type:"start_capture_result",media_device_id:"screen",media_device_name:"".concat((null===(_=o.getVideoTracks()[0])||void 0===_?void 0:_.label)||"",", ").concat((null===(b=o.getAudioTracks()[0])||void 0===b?void 0:b.label)||""),reason:"success",elapse:wy()-t,capture_session_id:r})}catch(BW){var v;throw null===(v=e.monitor)||void 0===v||v.report("rtc_video_capture_event",{event_type:"running_failed",media_device_id:"screen",error_code:BW.code,reason:BW.name+BW.message,capture_session_id:r}),new HS(US.GET_SCREEN_TRACK_FAILED,"throw error from getDisplayMedia",BW)}const S=o.getVideoTracks()[0],y=new wL(e,S,{streamIndex:gT.SCREEN,sourceType:yT.INTERNAL,captureSessionId:r}),f=o.getAudioTracks()[0];if(o.getAudioTracks().length){const t=new YL(e,f,{streamIndex:gT.SCREEN,sourceType:yT.INTERNAL,captureSessionId:r});return await Promise.all([y.isTrackReady,t.isTrackReady]),[y,t]}return await y.isTrackReady,[y,void 0]}function eP(e,t,i){return new KL(e,t,Yu({},i))}const tP="IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IHQ9e2dldE5BTFVuaXRzKGUpe2xldCBuPWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdJiZhcmd1bWVudHNbMV07aWYoZS5sZW5ndGgtZS5wb3NpdGlvbjw0KXJldHVybltdO2NvbnN0e3Bvc2l0aW9uOnJ9PWU7cmV0dXJuIDE9PT1lLmdldEludDMyKHIpfHwwPT09ZS5nZXRJbnQxNihyKSYmMT09PWUuZ2V0SW50OChyKzIpP3QuZ2V0QW5uZXhiTmFscyhlLG4pOnQuZ2V0QXZjY05hbHMoZSxuKX0sZ2V0QW5uZXhiTmFscyhlLG4pe2NvbnN0IHI9W107bGV0IGk9dC5nZXRIZWFkZXJQb3NpdGlvbkFubmV4QihlKSxvPWkucG9zLGE9bztmb3IoO288ZS5sZW5ndGgtNDspe2NvbnN0IHM9bmV3IFVpbnQ4QXJyYXkoZS5idWZmZXIuc2xpY2UobyxvK2kuaGVhZGVyTGVuZ3RoKSk7aS5wb3M9PT1lLnBvc2l0aW9uJiZlLnNraXAoaS5oZWFkZXJMZW5ndGgpLGk9dC5nZXRIZWFkZXJQb3NpdGlvbkFubmV4QihlKSxhPWkucG9zO2NvbnN0IGM9e2hlYWRlcjpzLGJvZHk6bmV3IFVpbnQ4QXJyYXkoZS5idWZmZXIuc2xpY2UobytzLmJ5dGVMZW5ndGgsYSkpLHR5cGU6LTF9O24/dC5hbmFseXNlSDI2NU5hbChjKTp0LmFuYWx5c2VOYWwoYyksKGMudHlwZTw9OXx8biYmYy50eXBlPD00MCkmJjAhPT1jLnR5cGUmJnIucHVzaChjKSxlLnNraXAoYS1lLnBvc2l0aW9uKSxvPWF9cmV0dXJuIHJ9LGdldEF2Y2NOYWxzKGUsbil7Y29uc3Qgcj1bXTtmb3IoO2UucG9zaXRpb248ZS5sZW5ndGgtNDspe2NvbnN0IGk9ZS5nZXRJbnQzMihlLnBvc2l0aW9uKTtpZighKGUubGVuZ3RoLWUucG9zaXRpb24+PWkpKWJyZWFrO3tjb25zdCBvPW5ldyBVaW50OEFycmF5KGUuYnVmZmVyLnNsaWNlKGUucG9zaXRpb24sZS5wb3NpdGlvbis0KSk7ZS5za2lwKDQpO2NvbnN0IGE9bmV3IFVpbnQ4QXJyYXkoZS5idWZmZXIuc2xpY2UoZS5wb3NpdGlvbixlLnBvc2l0aW9uK2kpKTtlLnNraXAoaSk7Y29uc3Qgcz17aGVhZGVyOm8sYm9keTphLHR5cGU6LTF9O24/dC5hbmFseXNlSDI2NU5hbChzKTp0LmFuYWx5c2VOYWwocykscy50eXBlPD05JiYwIT09cy50eXBlJiZyLnB1c2gocyl9fXJldHVybiByfSxhbmFseXNlTmFsKHQpe2NvbnN0IGU9MzEmdC5ib2R5WzBdO3N3aXRjaCh0LnR5cGU9ZSxlKXtjYXNlIDE6dC5uZHI9ITA7YnJlYWs7Y2FzZSA1OnQuaWRyPSEwO2JyZWFrO2Nhc2UgNjp0LnNlaT0hMDticmVhaztjYXNlIDc6dC5zcHM9ITA7YnJlYWs7Y2FzZSA4OnQucHBzPSEwfX0sYW5hbHlzZUgyNjVOYWwodCl7Y29uc3QgZT0oMTI2JnQuYm9keVswXSk+PjE7c3dpdGNoKHQudHlwZT1lLGUpe2Nhc2UgMzk6Y2FzZSA0MDp0LnNlaT0hMH19LGdldEhlYWRlclBvc2l0aW9uQW5uZXhCKHQpe2xldCBlPXQucG9zaXRpb24sbj0wO2NvbnN0IHI9dC5sZW5ndGg7Zm9yKDszIT09biYmNCE9PW4mJmU8ci00OykwPT09dC5nZXRJbnQxNihlKT8xPT09dC5nZXRJbnQxNihlKzIpP249NDoxPT09dC5nZXRJbnQ4KGUrMik/bj0zOmUrKzplKys7cmV0dXJuIGU9PT1yLTQmJigwPT09dC5nZXRJbnQxNihlKT8xPT09dC5nZXRJbnQxNihlKzIpP249NDplPXI6KGUrKywwPT09dC5nZXRJbnQxNihlKSYmMT09PXQuZ2V0SW50OChlKT9uPTM6ZT1yKSkse3BvczplLGhlYWRlckxlbmd0aDpufX0saXNIMjY1VmlkZW9GcmFtZSh0KXt2YXIgZTtyZXR1cm4oKG51bGw9PT0oZT10LmdldE1ldGFkYXRhKXx8dm9pZCAwPT09ZXx8bnVsbD09PShlPWUuY2FsbCh0KSl8fHZvaWQgMD09PWU/dm9pZCAwOmUubWltZVR5cGUpfHwiIikudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygiaDI2NSIpfX07dmFyIGU9InVuZGVmaW5lZCIhPXR5cGVvZiBnbG9iYWxUaGlzP2dsb2JhbFRoaXM6InVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3c/d2luZG93OiJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsP2dsb2JhbDoidW5kZWZpbmVkIiE9dHlwZW9mIHNlbGY/c2VsZjp7fTtmdW5jdGlvbiBuKHQpe3JldHVybiB0JiZ0Ll9fZXNNb2R1bGUmJk9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0LCJkZWZhdWx0Iik/dC5kZWZhdWx0OnR9dmFyIHI9e2V4cG9ydHM6e319LGk9ZnVuY3Rpb24odCl7cmV0dXJuIHQmJnQuTWF0aD09PU1hdGgmJnR9LG89aSgib2JqZWN0Ij09dHlwZW9mIGdsb2JhbFRoaXMmJmdsb2JhbFRoaXMpfHxpKCJvYmplY3QiPT10eXBlb2Ygd2luZG93JiZ3aW5kb3cpfHxpKCJvYmplY3QiPT10eXBlb2Ygc2VsZiYmc2VsZil8fGkoIm9iamVjdCI9PXR5cGVvZiBlJiZlKXx8aSgib2JqZWN0Ij09dHlwZW9mIGUmJmUpfHxmdW5jdGlvbigpe3JldHVybiB0aGlzfSgpfHxGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpLGE9ZnVuY3Rpb24odCl7dHJ5e3JldHVybiEhdCgpfWNhdGNoKGUpe3JldHVybiEwfX0scz0hYSgoZnVuY3Rpb24oKXt2YXIgdD1mdW5jdGlvbigpe30uYmluZCgpO3JldHVybiJmdW5jdGlvbiIhPXR5cGVvZiB0fHx0Lmhhc093blByb3BlcnR5KCJwcm90b3R5cGUiKX0pKSxjPXMsbD1GdW5jdGlvbi5wcm90b3R5cGUsdT1sLmFwcGx5LGg9bC5jYWxsLGY9Im9iamVjdCI9PXR5cGVvZiBSZWZsZWN0JiZSZWZsZWN0LmFwcGx5fHwoYz9oLmJpbmQodSk6ZnVuY3Rpb24oKXtyZXR1cm4gaC5hcHBseSh1LGFyZ3VtZW50cyl9KSxkPXMsXz1GdW5jdGlvbi5wcm90b3R5cGUscD1fLmNhbGwsZz1kJiZfLmJpbmQuYmluZChwLHApLG09ZD9nOmZ1bmN0aW9uKHQpe3JldHVybiBmdW5jdGlvbigpe3JldHVybiBwLmFwcGx5KHQsYXJndW1lbnRzKX19LHk9bSx2PXkoe30udG9TdHJpbmcpLGI9eSgiIi5zbGljZSksdz1mdW5jdGlvbih0KXtyZXR1cm4gYih2KHQpLDgsLTEpfSxrPXcsUz1tLE89ZnVuY3Rpb24odCl7aWYoIkZ1bmN0aW9uIj09PWsodCkpcmV0dXJuIFModCl9LHg9Im9iamVjdCI9PXR5cGVvZiBkb2N1bWVudCYmZG9jdW1lbnQuYWxsLEE9dm9pZCAwPT09eCYmdm9pZCAwIT09eD9mdW5jdGlvbih0KXtyZXR1cm4iZnVuY3Rpb24iPT10eXBlb2YgdHx8dD09PXh9OmZ1bmN0aW9uKHQpe3JldHVybiJmdW5jdGlvbiI9PXR5cGVvZiB0fSxUPXt9LEU9IWEoKGZ1bmN0aW9uKCl7cmV0dXJuIDchPT1PYmplY3QuZGVmaW5lUHJvcGVydHkoe30sMSx7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIDd9fSlbMV19KSksTD1zLHo9RnVuY3Rpb24ucHJvdG90eXBlLmNhbGwsQj1MP3ouYmluZCh6KTpmdW5jdGlvbigpe3JldHVybiB6LmFwcGx5KHosYXJndW1lbnRzKX0sST17fSxDPXt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLE49T2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcixSPU4mJiFDLmNhbGwoezE6Mn0sMSk7SS5mPVI/ZnVuY3Rpb24odCl7dmFyIGU9Tih0aGlzLHQpO3JldHVybiEhZSYmZS5lbnVtZXJhYmxlfTpDO3ZhciBqLEQsUD1mdW5jdGlvbih0LGUpe3JldHVybntlbnVtZXJhYmxlOiEoMSZ0KSxjb25maWd1cmFibGU6ISgyJnQpLHdyaXRhYmxlOiEoNCZ0KSx2YWx1ZTplfX0sVT1hLEY9dyxNPU9iamVjdCxaPW0oIiIuc3BsaXQpLEo9VSgoZnVuY3Rpb24oKXtyZXR1cm4hTSgieiIpLnByb3BlcnR5SXNFbnVtZXJhYmxlKDApfSkpP2Z1bmN0aW9uKHQpe3JldHVybiJTdHJpbmciPT09Rih0KT9aKHQsIiIpOk0odCl9Ok0sSD1mdW5jdGlvbih0KXtyZXR1cm4gbnVsbD09dH0sVz1ILEs9VHlwZUVycm9yLEc9ZnVuY3Rpb24odCl7aWYoVyh0KSl0aHJvdyBuZXcgSygiQ2FuJ3QgY2FsbCBtZXRob2Qgb24gIit0KTtyZXR1cm4gdH0sVj1KLFk9RyxYPWZ1bmN0aW9uKHQpe3JldHVybiBWKFkodCkpfSxxPUEsJD1mdW5jdGlvbih0KXtyZXR1cm4ib2JqZWN0Ij09dHlwZW9mIHQ/bnVsbCE9PXQ6cSh0KX0sUT17fSx0dD1RLGV0PW8sbnQ9QSxydD1mdW5jdGlvbih0KXtyZXR1cm4gbnQodCk/dDp2b2lkIDB9LGl0PWZ1bmN0aW9uKHQsZSl7cmV0dXJuIGFyZ3VtZW50cy5sZW5ndGg8Mj9ydCh0dFt0XSl8fHJ0KGV0W3RdKTp0dFt0XSYmdHRbdF1bZV18fGV0W3RdJiZldFt0XVtlXX0sb3Q9bSh7fS5pc1Byb3RvdHlwZU9mKSxhdD1vLm5hdmlnYXRvcixzdD1hdCYmYXQudXNlckFnZW50LGN0PW8sbHQ9c3Q/U3RyaW5nKHN0KToiIix1dD1jdC5wcm9jZXNzLGh0PWN0LkRlbm8sZnQ9dXQmJnV0LnZlcnNpb25zfHxodCYmaHQudmVyc2lvbixkdD1mdCYmZnQudjg7ZHQmJihEPShqPWR0LnNwbGl0KCIuIikpWzBdPjAmJmpbMF08ND8xOisoalswXStqWzFdKSksIUQmJmx0JiYoIShqPWx0Lm1hdGNoKC9FZGdlXC8oXGQrKS8pKXx8alsxXT49NzQpJiYoaj1sdC5tYXRjaCgvQ2hyb21lXC8oXGQrKS8pKSYmKEQ9K2pbMV0pO3ZhciBfdD1ELHB0PV90LGd0PWEsbXQ9by5TdHJpbmcseXQ9ISFPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzJiYhZ3QoKGZ1bmN0aW9uKCl7dmFyIHQ9U3ltYm9sKCJzeW1ib2wgZGV0ZWN0aW9uIik7cmV0dXJuIW10KHQpfHwhKE9iamVjdCh0KWluc3RhbmNlb2YgU3ltYm9sKXx8IVN5bWJvbC5zaGFtJiZwdCYmcHQ8NDF9KSksdnQ9eXQmJiFTeW1ib2wuc2hhbSYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3IsYnQ9aXQsd3Q9QSxrdD1vdCxTdD1PYmplY3QsT3Q9dnQ/ZnVuY3Rpb24odCl7cmV0dXJuInN5bWJvbCI9PXR5cGVvZiB0fTpmdW5jdGlvbih0KXt2YXIgZT1idCgiU3ltYm9sIik7cmV0dXJuIHd0KGUpJiZrdChlLnByb3RvdHlwZSxTdCh0KSl9LHh0PVN0cmluZyxBdD1mdW5jdGlvbih0KXt0cnl7cmV0dXJuIHh0KHQpfWNhdGNoKGUpe3JldHVybiJPYmplY3QifX0sVHQ9QSxFdD1BdCxMdD1UeXBlRXJyb3IsenQ9ZnVuY3Rpb24odCl7aWYoVHQodCkpcmV0dXJuIHQ7dGhyb3cgbmV3IEx0KEV0KHQpKyIgaXMgbm90IGEgZnVuY3Rpb24iKX0sQnQ9enQsSXQ9SCxDdD1CLE50PUEsUnQ9JCxqdD1UeXBlRXJyb3IsRHQ9e2V4cG9ydHM6e319LFB0PW8sVXQ9T2JqZWN0LmRlZmluZVByb3BlcnR5LEZ0PW8sTXQ9ZnVuY3Rpb24odCxlKXt0cnl7VXQoUHQsdCx7dmFsdWU6ZSxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KX1jYXRjaChuKXtQdFt0XT1lfXJldHVybiBlfSxadD0iX19jb3JlLWpzX3NoYXJlZF9fIixKdD1EdC5leHBvcnRzPUZ0W1p0XXx8TXQoWnQse30pOyhKdC52ZXJzaW9uc3x8KEp0LnZlcnNpb25zPVtdKSkucHVzaCh7dmVyc2lvbjoiMy4zOS4wIixtb2RlOiJwdXJlIixjb3B5cmlnaHQ6IsKpIDIwMTQtMjAyNCBEZW5pcyBQdXNoa2FyZXYgKHpsb2lyb2NrLnJ1KSIsbGljZW5zZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMvYmxvYi92My4zOS4wL0xJQ0VOU0UiLHNvdXJjZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMifSk7dmFyIEh0PUR0LmV4cG9ydHMsV3Q9SHQsS3Q9ZnVuY3Rpb24odCxlKXtyZXR1cm4gV3RbdF18fChXdFt0XT1lfHx7fSl9LEd0PUcsVnQ9T2JqZWN0LFl0PWZ1bmN0aW9uKHQpe3JldHVybiBWdChHdCh0KSl9LFh0PVl0LHF0PW0oe30uaGFzT3duUHJvcGVydHkpLCR0PU9iamVjdC5oYXNPd258fGZ1bmN0aW9uKHQsZSl7cmV0dXJuIHF0KFh0KHQpLGUpfSxRdD1tLHRlPTAsZWU9TWF0aC5yYW5kb20oKSxuZT1RdCgxLi50b1N0cmluZykscmU9ZnVuY3Rpb24odCl7cmV0dXJuIlN5bWJvbCgiKyh2b2lkIDA9PT10PyIiOnQpKyIpXyIrbmUoKyt0ZStlZSwzNil9LGllPUt0LG9lPSR0LGFlPXJlLHNlPXl0LGNlPXZ0LGxlPW8uU3ltYm9sLHVlPWllKCJ3a3MiKSxoZT1jZT9sZS5mb3J8fGxlOmxlJiZsZS53aXRob3V0U2V0dGVyfHxhZSxmZT1mdW5jdGlvbih0KXtyZXR1cm4gb2UodWUsdCl8fCh1ZVt0XT1zZSYmb2UobGUsdCk/bGVbdF06aGUoIlN5bWJvbC4iK3QpKSx1ZVt0XX0sZGU9QixfZT0kLHBlPU90LGdlPWZ1bmN0aW9uKHQsZSl7dmFyIG49dFtlXTtyZXR1cm4gSXQobik/dm9pZCAwOkJ0KG4pfSxtZT1mdW5jdGlvbih0LGUpe3ZhciBuLHI7aWYoInN0cmluZyI9PT1lJiZOdChuPXQudG9TdHJpbmcpJiYhUnQocj1DdChuLHQpKSlyZXR1cm4gcjtpZihOdChuPXQudmFsdWVPZikmJiFSdChyPUN0KG4sdCkpKXJldHVybiByO2lmKCJzdHJpbmciIT09ZSYmTnQobj10LnRvU3RyaW5nKSYmIVJ0KHI9Q3Qobix0KSkpcmV0dXJuIHI7dGhyb3cgbmV3IGp0KCJDYW4ndCBjb252ZXJ0IG9iamVjdCB0byBwcmltaXRpdmUgdmFsdWUiKX0seWU9VHlwZUVycm9yLHZlPWZlKCJ0b1ByaW1pdGl2ZSIpLGJlPWZ1bmN0aW9uKHQsZSl7aWYoIV9lKHQpfHxwZSh0KSlyZXR1cm4gdDt2YXIgbixyPWdlKHQsdmUpO2lmKHIpe2lmKHZvaWQgMD09PWUmJihlPSJkZWZhdWx0Iiksbj1kZShyLHQsZSksIV9lKG4pfHxwZShuKSlyZXR1cm4gbjt0aHJvdyBuZXcgeWUoIkNhbid0IGNvbnZlcnQgb2JqZWN0IHRvIHByaW1pdGl2ZSB2YWx1ZSIpfXJldHVybiB2b2lkIDA9PT1lJiYoZT0ibnVtYmVyIiksbWUodCxlKX0sd2U9T3Qsa2U9ZnVuY3Rpb24odCl7dmFyIGU9YmUodCwic3RyaW5nIik7cmV0dXJuIHdlKGUpP2U6ZSsiIn0sU2U9JCxPZT1vLmRvY3VtZW50LHhlPVNlKE9lKSYmU2UoT2UuY3JlYXRlRWxlbWVudCksQWU9ZnVuY3Rpb24odCl7cmV0dXJuIHhlP09lLmNyZWF0ZUVsZW1lbnQodCk6e319LFRlPUFlLEVlPSFFJiYhYSgoZnVuY3Rpb24oKXtyZXR1cm4gNyE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eShUZSgiZGl2IiksImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gN319KS5hfSkpLExlPUUsemU9QixCZT1JLEllPVAsQ2U9WCxOZT1rZSxSZT0kdCxqZT1FZSxEZT1PYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yO1QuZj1MZT9EZTpmdW5jdGlvbih0LGUpe2lmKHQ9Q2UodCksZT1OZShlKSxqZSl0cnl7cmV0dXJuIERlKHQsZSl9Y2F0Y2gobil7fWlmKFJlKHQsZSkpcmV0dXJuIEllKCF6ZShCZS5mLHQsZSksdFtlXSl9O3ZhciBQZT1hLFVlPUEsRmU9LyN8XC5wcm90b3R5cGVcLi8sTWU9ZnVuY3Rpb24odCxlKXt2YXIgbj1KZVtaZSh0KV07cmV0dXJuIG49PT1XZXx8biE9PUhlJiYoVWUoZSk/UGUoZSk6ISFlKX0sWmU9TWUubm9ybWFsaXplPWZ1bmN0aW9uKHQpe3JldHVybiBTdHJpbmcodCkucmVwbGFjZShGZSwiLiIpLnRvTG93ZXJDYXNlKCl9LEplPU1lLmRhdGE9e30sSGU9TWUuTkFUSVZFPSJOIixXZT1NZS5QT0xZRklMTD0iUCIsS2U9TWUsR2U9enQsVmU9cyxZZT1PKE8uYmluZCksWGU9ZnVuY3Rpb24odCxlKXtyZXR1cm4gR2UodCksdm9pZCAwPT09ZT90OlZlP1llKHQsZSk6ZnVuY3Rpb24oKXtyZXR1cm4gdC5hcHBseShlLGFyZ3VtZW50cyl9fSxxZT17fSwkZT1FJiZhKChmdW5jdGlvbigpe3JldHVybiA0MiE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eSgoZnVuY3Rpb24oKXt9KSwicHJvdG90eXBlIix7dmFsdWU6NDIsd3JpdGFibGU6ITF9KS5wcm90b3R5cGV9KSksUWU9JCx0bj1TdHJpbmcsZW49VHlwZUVycm9yLG5uPWZ1bmN0aW9uKHQpe2lmKFFlKHQpKXJldHVybiB0O3Rocm93IG5ldyBlbih0bih0KSsiIGlzIG5vdCBhbiBvYmplY3QiKX0scm49RSxvbj1FZSxhbj0kZSxzbj1ubixjbj1rZSxsbj1UeXBlRXJyb3IsdW49T2JqZWN0LmRlZmluZVByb3BlcnR5LGhuPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsZm49ImVudW1lcmFibGUiLGRuPSJjb25maWd1cmFibGUiLF9uPSJ3cml0YWJsZSI7cWUuZj1ybj9hbj9mdW5jdGlvbih0LGUsbil7aWYoc24odCksZT1jbihlKSxzbihuKSwiZnVuY3Rpb24iPT10eXBlb2YgdCYmInByb3RvdHlwZSI9PT1lJiYidmFsdWUiaW4gbiYmX24gaW4gbiYmIW5bX25dKXt2YXIgcj1obih0LGUpO3ImJnJbX25dJiYodFtlXT1uLnZhbHVlLG49e2NvbmZpZ3VyYWJsZTpkbiBpbiBuP25bZG5dOnJbZG5dLGVudW1lcmFibGU6Zm4gaW4gbj9uW2ZuXTpyW2ZuXSx3cml0YWJsZTohMX0pfXJldHVybiB1bih0LGUsbil9OnVuOmZ1bmN0aW9uKHQsZSxuKXtpZihzbih0KSxlPWNuKGUpLHNuKG4pLG9uKXRyeXtyZXR1cm4gdW4odCxlLG4pfWNhdGNoKHIpe31pZigiZ2V0ImluIG58fCJzZXQiaW4gbil0aHJvdyBuZXcgbG4oIkFjY2Vzc29ycyBub3Qgc3VwcG9ydGVkIik7cmV0dXJuInZhbHVlImluIG4mJih0W2VdPW4udmFsdWUpLHR9O3ZhciBwbj1xZSxnbj1QLG1uPUU/ZnVuY3Rpb24odCxlLG4pe3JldHVybiBwbi5mKHQsZSxnbigxLG4pKX06ZnVuY3Rpb24odCxlLG4pe3JldHVybiB0W2VdPW4sdH0seW49byx2bj1mLGJuPU8sd249QSxrbj1ULmYsU249S2UsT249USx4bj1YZSxBbj1tbixUbj0kdCxFbj1mdW5jdGlvbih0KXt2YXIgZT1mdW5jdGlvbihuLHIsaSl7aWYodGhpcyBpbnN0YW5jZW9mIGUpe3N3aXRjaChhcmd1bWVudHMubGVuZ3RoKXtjYXNlIDA6cmV0dXJuIG5ldyB0O2Nhc2UgMTpyZXR1cm4gbmV3IHQobik7Y2FzZSAyOnJldHVybiBuZXcgdChuLHIpfXJldHVybiBuZXcgdChuLHIsaSl9cmV0dXJuIHZuKHQsdGhpcyxhcmd1bWVudHMpfTtyZXR1cm4gZS5wcm90b3R5cGU9dC5wcm90b3R5cGUsZX0sTG49ZnVuY3Rpb24odCxlKXt2YXIgbixyLGksbyxhLHMsYyxsLHUsaD10LnRhcmdldCxmPXQuZ2xvYmFsLGQ9dC5zdGF0LF89dC5wcm90byxwPWY/eW46ZD95bltoXTp5bltoXSYmeW5baF0ucHJvdG90eXBlLGc9Zj9PbjpPbltoXXx8QW4oT24saCx7fSlbaF0sbT1nLnByb3RvdHlwZTtmb3IobyBpbiBlKXI9IShuPVNuKGY/bzpoKyhkPyIuIjoiIyIpK28sdC5mb3JjZWQpKSYmcCYmVG4ocCxvKSxzPWdbb10sciYmKGM9dC5kb250Q2FsbEdldFNldD8odT1rbihwLG8pKSYmdS52YWx1ZTpwW29dKSxhPXImJmM/YzplW29dLChufHxffHx0eXBlb2YgcyE9dHlwZW9mIGEpJiYobD10LmJpbmQmJnI/eG4oYSx5bik6dC53cmFwJiZyP0VuKGEpOl8mJnduKGEpP2JuKGEpOmEsKHQuc2hhbXx8YSYmYS5zaGFtfHxzJiZzLnNoYW0pJiZBbihsLCJzaGFtIiwhMCksQW4oZyxvLGwpLF8mJihUbihPbixpPWgrIlByb3RvdHlwZSIpfHxBbihPbixpLHt9KSxBbihPbltpXSxvLGEpLHQucmVhbCYmbSYmKG58fCFtW29dKSYmQW4obSxvLGEpKSl9LHpuPUxuLEJuPUUsSW49cWUuZjt6bih7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOk9iamVjdC5kZWZpbmVQcm9wZXJ0eSE9PUluLHNoYW06IUJufSx7ZGVmaW5lUHJvcGVydHk6SW59KTt2YXIgQ249US5PYmplY3QsTm49ci5leHBvcnRzPWZ1bmN0aW9uKHQsZSxuKXtyZXR1cm4gQ24uZGVmaW5lUHJvcGVydHkodCxlLG4pfTtDbi5kZWZpbmVQcm9wZXJ0eS5zaGFtJiYoTm4uc2hhbT0hMCk7dmFyIFJuPW4oci5leHBvcnRzKSxqbj13LERuPUFycmF5LmlzQXJyYXl8fGZ1bmN0aW9uKHQpe3JldHVybiJBcnJheSI9PT1qbih0KX0sUG49TWF0aC5jZWlsLFVuPU1hdGguZmxvb3IsRm49TWF0aC50cnVuY3x8ZnVuY3Rpb24odCl7dmFyIGU9K3Q7cmV0dXJuKGU+MD9VbjpQbikoZSl9LE1uPWZ1bmN0aW9uKHQpe3ZhciBlPSt0O3JldHVybiBlIT1lfHwwPT09ZT8wOkZuKGUpfSxabj1NbixKbj1NYXRoLm1pbixIbj1mdW5jdGlvbih0KXt2YXIgZT1abih0KTtyZXR1cm4gZT4wP0puKGUsOTAwNzE5OTI1NDc0MDk5MSk6MH0sV249ZnVuY3Rpb24odCl7cmV0dXJuIEhuKHQubGVuZ3RoKX0sS249VHlwZUVycm9yLEduPWZ1bmN0aW9uKHQpe2lmKHQ+OTAwNzE5OTI1NDc0MDk5MSl0aHJvdyBLbigiTWF4aW11bSBhbGxvd2VkIGluZGV4IGV4Y2VlZGVkIik7cmV0dXJuIHR9LFZuPUUsWW49cWUsWG49UCxxbj1mdW5jdGlvbih0LGUsbil7Vm4/WW4uZih0LGUsWG4oMCxuKSk6dFtlXT1ufSwkbj17fTskbltmZSgidG9TdHJpbmdUYWciKV09InoiO3ZhciBRbj0iW29iamVjdCB6XSI9PT1TdHJpbmcoJG4pLHRyPVFuLGVyPUEsbnI9dyxycj1mZSgidG9TdHJpbmdUYWciKSxpcj1PYmplY3Qsb3I9IkFyZ3VtZW50cyI9PT1ucihmdW5jdGlvbigpe3JldHVybiBhcmd1bWVudHN9KCkpLGFyPXRyP25yOmZ1bmN0aW9uKHQpe3ZhciBlLG4scjtyZXR1cm4gdm9pZCAwPT09dD8iVW5kZWZpbmVkIjpudWxsPT09dD8iTnVsbCI6InN0cmluZyI9PXR5cGVvZihuPWZ1bmN0aW9uKHQsZSl7dHJ5e3JldHVybiB0W2VdfWNhdGNoKG4pe319KGU9aXIodCkscnIpKT9uOm9yP25yKGUpOiJPYmplY3QiPT09KHI9bnIoZSkpJiZlcihlLmNhbGxlZSk/IkFyZ3VtZW50cyI6cn0sc3I9QSxjcj1IdCxscj1tKEZ1bmN0aW9uLnRvU3RyaW5nKTtzcihjci5pbnNwZWN0U291cmNlKXx8KGNyLmluc3BlY3RTb3VyY2U9ZnVuY3Rpb24odCl7cmV0dXJuIGxyKHQpfSk7dmFyIHVyPWNyLmluc3BlY3RTb3VyY2UsaHI9bSxmcj1hLGRyPUEsX3I9YXIscHI9dXIsZ3I9ZnVuY3Rpb24oKXt9LG1yPWl0KCJSZWZsZWN0IiwiY29uc3RydWN0IikseXI9L15ccyooPzpjbGFzc3xmdW5jdGlvbilcYi8sdnI9aHIoeXIuZXhlYyksYnI9IXlyLnRlc3QoZ3IpLHdyPWZ1bmN0aW9uKHQpe2lmKCFkcih0KSlyZXR1cm4hMTt0cnl7cmV0dXJuIG1yKGdyLFtdLHQpLCEwfWNhdGNoKGUpe3JldHVybiExfX0sa3I9ZnVuY3Rpb24odCl7aWYoIWRyKHQpKXJldHVybiExO3N3aXRjaChfcih0KSl7Y2FzZSJBc3luY0Z1bmN0aW9uIjpjYXNlIkdlbmVyYXRvckZ1bmN0aW9uIjpjYXNlIkFzeW5jR2VuZXJhdG9yRnVuY3Rpb24iOnJldHVybiExfXRyeXtyZXR1cm4gYnJ8fCEhdnIoeXIscHIodCkpfWNhdGNoKGUpe3JldHVybiEwfX07a3Iuc2hhbT0hMDt2YXIgU3I9IW1yfHxmcigoZnVuY3Rpb24oKXt2YXIgdDtyZXR1cm4gd3Iod3IuY2FsbCl8fCF3cihPYmplY3QpfHwhd3IoKGZ1bmN0aW9uKCl7dD0hMH0pKXx8dH0pKT9rcjp3cixPcj1Ebix4cj1TcixBcj0kLFRyPWZlKCJzcGVjaWVzIiksRXI9QXJyYXksTHI9ZnVuY3Rpb24odCl7dmFyIGU7cmV0dXJuIE9yKHQpJiYoZT10LmNvbnN0cnVjdG9yLCh4cihlKSYmKGU9PT1Fcnx8T3IoZS5wcm90b3R5cGUpKXx8QXIoZSkmJm51bGw9PT0oZT1lW1RyXSkpJiYoZT12b2lkIDApKSx2b2lkIDA9PT1lP0VyOmV9LHpyPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIG5ldyhMcih0KSkoMD09PWU/MDplKX0sQnI9YSxJcj1fdCxDcj1mZSgic3BlY2llcyIpLE5yPWZ1bmN0aW9uKHQpe3JldHVybiBJcj49NTF8fCFCcigoZnVuY3Rpb24oKXt2YXIgZT1bXTtyZXR1cm4oZS5jb25zdHJ1Y3Rvcj17fSlbQ3JdPWZ1bmN0aW9uKCl7cmV0dXJue2ZvbzoxfX0sMSE9PWVbdF0oQm9vbGVhbikuZm9vfSkpfSxScj1Mbixqcj1hLERyPURuLFByPSQsVXI9WXQsRnI9V24sTXI9R24sWnI9cW4sSnI9enIsSHI9TnIsV3I9X3QsS3I9ZmUoImlzQ29uY2F0U3ByZWFkYWJsZSIpLEdyPVdyPj01MXx8IWpyKChmdW5jdGlvbigpe3ZhciB0PVtdO3JldHVybiB0W0tyXT0hMSx0LmNvbmNhdCgpWzBdIT09dH0pKSxWcj1mdW5jdGlvbih0KXtpZighUHIodCkpcmV0dXJuITE7dmFyIGU9dFtLcl07cmV0dXJuIHZvaWQgMCE9PWU/ISFlOkRyKHQpfTtScih7dGFyZ2V0OiJBcnJheSIscHJvdG86ITAsYXJpdHk6MSxmb3JjZWQ6IUdyfHwhSHIoImNvbmNhdCIpfSx7Y29uY2F0OmZ1bmN0aW9uKHQpe3ZhciBlLG4scixpLG8sYT1Vcih0aGlzKSxzPUpyKGEsMCksYz0wO2ZvcihlPS0xLHI9YXJndW1lbnRzLmxlbmd0aDtlPHI7ZSsrKWlmKFZyKG89LTE9PT1lP2E6YXJndW1lbnRzW2VdKSlmb3IoaT1GcihvKSxNcihjK2kpLG49MDtuPGk7bisrLGMrKyluIGluIG8mJlpyKHMsYyxvW25dKTtlbHNlIE1yKGMrMSksWnIocyxjKyssbyk7cmV0dXJuIHMubGVuZ3RoPWMsc319KTt2YXIgWXI9YXIsWHI9U3RyaW5nLHFyPWZ1bmN0aW9uKHQpe2lmKCJTeW1ib2wiPT09WXIodCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNvbnZlcnQgYSBTeW1ib2wgdmFsdWUgdG8gYSBzdHJpbmciKTtyZXR1cm4gWHIodCl9LCRyPXt9LFFyPU1uLHRpPU1hdGgubWF4LGVpPU1hdGgubWluLG5pPVgscmk9ZnVuY3Rpb24odCxlKXt2YXIgbj1Rcih0KTtyZXR1cm4gbjwwP3RpKG4rZSwwKTplaShuLGUpfSxpaT1XbixvaT1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxuLHIpe3ZhciBpPW5pKGUpLG89aWkoaSk7aWYoMD09PW8pcmV0dXJuIXQmJi0xO3ZhciBhLHM9cmkocixvKTtpZih0JiZuIT1uKXtmb3IoO28+czspaWYoKGE9aVtzKytdKSE9YSlyZXR1cm4hMH1lbHNlIGZvcig7bz5zO3MrKylpZigodHx8cyBpbiBpKSYmaVtzXT09PW4pcmV0dXJuIHR8fHN8fDA7cmV0dXJuIXQmJi0xfX0sYWk9e2luY2x1ZGVzOm9pKCEwKSxpbmRleE9mOm9pKCExKX0sc2k9e30sY2k9JHQsbGk9WCx1aT1haS5pbmRleE9mLGhpPXNpLGZpPW0oW10ucHVzaCksZGk9ZnVuY3Rpb24odCxlKXt2YXIgbixyPWxpKHQpLGk9MCxvPVtdO2ZvcihuIGluIHIpIWNpKGhpLG4pJiZjaShyLG4pJiZmaShvLG4pO2Zvcig7ZS5sZW5ndGg+aTspY2kocixuPWVbaSsrXSkmJih+dWkobyxuKXx8ZmkobyxuKSk7cmV0dXJuIG99LF9pPVsiY29uc3RydWN0b3IiLCJoYXNPd25Qcm9wZXJ0eSIsImlzUHJvdG90eXBlT2YiLCJwcm9wZXJ0eUlzRW51bWVyYWJsZSIsInRvTG9jYWxlU3RyaW5nIiwidG9TdHJpbmciLCJ2YWx1ZU9mIl0scGk9ZGksZ2k9X2ksbWk9T2JqZWN0LmtleXN8fGZ1bmN0aW9uKHQpe3JldHVybiBwaSh0LGdpKX0seWk9RSx2aT0kZSxiaT1xZSx3aT1ubixraT1YLFNpPW1pOyRyLmY9eWkmJiF2aT9PYmplY3QuZGVmaW5lUHJvcGVydGllczpmdW5jdGlvbih0LGUpe3dpKHQpO2Zvcih2YXIgbixyPWtpKGUpLGk9U2koZSksbz1pLmxlbmd0aCxhPTA7bz5hOyliaS5mKHQsbj1pW2ErK10scltuXSk7cmV0dXJuIHR9O3ZhciBPaSx4aT1pdCgiZG9jdW1lbnQiLCJkb2N1bWVudEVsZW1lbnQiKSxBaT1yZSxUaT1LdCgia2V5cyIpLEVpPWZ1bmN0aW9uKHQpe3JldHVybiBUaVt0XXx8KFRpW3RdPUFpKHQpKX0sTGk9bm4semk9JHIsQmk9X2ksSWk9c2ksQ2k9eGksTmk9QWUsUmk9InByb3RvdHlwZSIsamk9InNjcmlwdCIsRGk9RWkoIklFX1BST1RPIiksUGk9ZnVuY3Rpb24oKXt9LFVpPWZ1bmN0aW9uKHQpe3JldHVybiI8IitqaSsiPiIrdCsiPC8iK2ppKyI+In0sRmk9ZnVuY3Rpb24odCl7dC53cml0ZShVaSgiIikpLHQuY2xvc2UoKTt2YXIgZT10LnBhcmVudFdpbmRvdy5PYmplY3Q7cmV0dXJuIHQ9bnVsbCxlfSxNaT1mdW5jdGlvbigpe3RyeXtPaT1uZXcgQWN0aXZlWE9iamVjdCgiaHRtbGZpbGUiKX1jYXRjaChpKXt9dmFyIHQsZSxuO01pPSJ1bmRlZmluZWQiIT10eXBlb2YgZG9jdW1lbnQ/ZG9jdW1lbnQuZG9tYWluJiZPaT9GaShPaSk6KGU9TmkoImlmcmFtZSIpLG49ImphdmEiK2ppKyI6IixlLnN0eWxlLmRpc3BsYXk9Im5vbmUiLENpLmFwcGVuZENoaWxkKGUpLGUuc3JjPVN0cmluZyhuKSwodD1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQpLm9wZW4oKSx0LndyaXRlKFVpKCJkb2N1bWVudC5GPU9iamVjdCIpKSx0LmNsb3NlKCksdC5GKTpGaShPaSk7Zm9yKHZhciByPUJpLmxlbmd0aDtyLS07KWRlbGV0ZSBNaVtSaV1bQmlbcl1dO3JldHVybiBNaSgpfTtJaVtEaV09ITA7dmFyIFppPU9iamVjdC5jcmVhdGV8fGZ1bmN0aW9uKHQsZSl7dmFyIG47cmV0dXJuIG51bGwhPT10PyhQaVtSaV09TGkodCksbj1uZXcgUGksUGlbUmldPW51bGwsbltEaV09dCk6bj1NaSgpLHZvaWQgMD09PWU/bjp6aS5mKG4sZSl9LEppPXt9LEhpPWRpLFdpPV9pLmNvbmNhdCgibGVuZ3RoIiwicHJvdG90eXBlIik7SmkuZj1PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lc3x8ZnVuY3Rpb24odCl7cmV0dXJuIEhpKHQsV2kpfTt2YXIgS2k9e30sR2k9bShbXS5zbGljZSksVmk9dyxZaT1YLFhpPUppLmYscWk9R2ksJGk9Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJndpbmRvdyYmT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM/T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMod2luZG93KTpbXTtLaS5mPWZ1bmN0aW9uKHQpe3JldHVybiAkaSYmIldpbmRvdyI9PT1WaSh0KT9mdW5jdGlvbih0KXt0cnl7cmV0dXJuIFhpKHQpfWNhdGNoKGUpe3JldHVybiBxaSgkaSl9fSh0KTpYaShZaSh0KSl9O3ZhciBRaT17fTtRaS5mPU9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHM7dmFyIHRvPW1uLGVvPWZ1bmN0aW9uKHQsZSxuLHIpe3JldHVybiByJiZyLmVudW1lcmFibGU/dFtlXT1uOnRvKHQsZSxuKSx0fSxubz1xZSxybz17fSxpbz1mZTtyby5mPWlvO3ZhciBvbyxhbyxzbyxjbz1RLGxvPSR0LHVvPXJvLGhvPXFlLmYsZm89ZnVuY3Rpb24odCl7dmFyIGU9Y28uU3ltYm9sfHwoY28uU3ltYm9sPXt9KTtsbyhlLHQpfHxobyhlLHQse3ZhbHVlOnVvLmYodCl9KX0sX289Qixwbz1pdCxnbz1mZSxtbz1lbyx5bz1mdW5jdGlvbigpe3ZhciB0PXBvKCJTeW1ib2wiKSxlPXQmJnQucHJvdG90eXBlLG49ZSYmZS52YWx1ZU9mLHI9Z28oInRvUHJpbWl0aXZlIik7ZSYmIWVbcl0mJm1vKGUsciwoZnVuY3Rpb24odCl7cmV0dXJuIF9vKG4sdGhpcyl9KSx7YXJpdHk6MX0pfSx2bz1hcixibz1Rbj97fS50b1N0cmluZzpmdW5jdGlvbigpe3JldHVybiJbb2JqZWN0ICIrdm8odGhpcykrIl0ifSx3bz1Rbixrbz1xZS5mLFNvPW1uLE9vPSR0LHhvPWJvLEFvPWZlKCJ0b1N0cmluZ1RhZyIpLFRvPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBpPW4/dDp0JiZ0LnByb3RvdHlwZTtpJiYoT28oaSxBbyl8fGtvKGksQW8se2NvbmZpZ3VyYWJsZTohMCx2YWx1ZTplfSksciYmIXdvJiZTbyhpLCJ0b1N0cmluZyIseG8pKX0sRW89QSxMbz1vLldlYWtNYXAsem89RW8oTG8pJiYvbmF0aXZlIGNvZGUvLnRlc3QoU3RyaW5nKExvKSksQm89byxJbz0kLENvPW1uLE5vPSR0LFJvPUh0LGpvPUVpLERvPXNpLFBvPSJPYmplY3QgYWxyZWFkeSBpbml0aWFsaXplZCIsVW89Qm8uVHlwZUVycm9yLEZvPUJvLldlYWtNYXA7aWYoem98fFJvLnN0YXRlKXt2YXIgTW89Um8uc3RhdGV8fChSby5zdGF0ZT1uZXcgRm8pO01vLmdldD1Nby5nZXQsTW8uaGFzPU1vLmhhcyxNby5zZXQ9TW8uc2V0LG9vPWZ1bmN0aW9uKHQsZSl7aWYoTW8uaGFzKHQpKXRocm93IG5ldyBVbyhQbyk7cmV0dXJuIGUuZmFjYWRlPXQsTW8uc2V0KHQsZSksZX0sYW89ZnVuY3Rpb24odCl7cmV0dXJuIE1vLmdldCh0KXx8e319LHNvPWZ1bmN0aW9uKHQpe3JldHVybiBNby5oYXModCl9fWVsc2V7dmFyIFpvPWpvKCJzdGF0ZSIpO0RvW1pvXT0hMCxvbz1mdW5jdGlvbih0LGUpe2lmKE5vKHQsWm8pKXRocm93IG5ldyBVbyhQbyk7cmV0dXJuIGUuZmFjYWRlPXQsQ28odCxabyxlKSxlfSxhbz1mdW5jdGlvbih0KXtyZXR1cm4gTm8odCxabyk/dFtab106e319LHNvPWZ1bmN0aW9uKHQpe3JldHVybiBObyh0LFpvKX19dmFyIEpvPXtzZXQ6b28sZ2V0OmFvLGhhczpzbyxlbmZvcmNlOmZ1bmN0aW9uKHQpe3JldHVybiBzbyh0KT9hbyh0KTpvbyh0LHt9KX0sZ2V0dGVyRm9yOmZ1bmN0aW9uKHQpe3JldHVybiBmdW5jdGlvbihlKXt2YXIgbjtpZighSW8oZSl8fChuPWFvKGUpKS50eXBlIT09dCl0aHJvdyBuZXcgVW8oIkluY29tcGF0aWJsZSByZWNlaXZlciwgIit0KyIgcmVxdWlyZWQiKTtyZXR1cm4gbn19fSxIbz1YZSxXbz1KLEtvPVl0LEdvPVduLFZvPXpyLFlvPW0oW10ucHVzaCksWG89ZnVuY3Rpb24odCl7dmFyIGU9MT09PXQsbj0yPT09dCxyPTM9PT10LGk9ND09PXQsbz02PT09dCxhPTc9PT10LHM9NT09PXR8fG87cmV0dXJuIGZ1bmN0aW9uKGMsbCx1LGgpe2Zvcih2YXIgZixkLF89S28oYykscD1XbyhfKSxnPUdvKHApLG09SG8obCx1KSx5PTAsdj1ofHxWbyxiPWU/dihjLGcpOm58fGE/dihjLDApOnZvaWQgMDtnPnk7eSsrKWlmKChzfHx5IGluIHApJiYoZD1tKGY9cFt5XSx5LF8pLHQpKWlmKGUpYlt5XT1kO2Vsc2UgaWYoZClzd2l0Y2godCl7Y2FzZSAzOnJldHVybiEwO2Nhc2UgNTpyZXR1cm4gZjtjYXNlIDY6cmV0dXJuIHk7Y2FzZSAyOllvKGIsZil9ZWxzZSBzd2l0Y2godCl7Y2FzZSA0OnJldHVybiExO2Nhc2UgNzpZbyhiLGYpfXJldHVybiBvPy0xOnJ8fGk/aTpifX0scW89e2ZvckVhY2g6WG8oMCksbWFwOlhvKDEpLGZpbHRlcjpYbygyKSxzb21lOlhvKDMpLGV2ZXJ5OlhvKDQpLGZpbmQ6WG8oNSksZmluZEluZGV4OlhvKDYpLGZpbHRlclJlamVjdDpYbyg3KX0sJG89TG4sUW89byx0YT1CLGVhPW0sbmE9RSxyYT15dCxpYT1hLG9hPSR0LGFhPW90LHNhPW5uLGNhPVgsbGE9a2UsdWE9cXIsaGE9UCxmYT1aaSxkYT1taSxfYT1KaSxwYT1LaSxnYT1RaSxtYT1ULHlhPXFlLHZhPSRyLGJhPUksd2E9ZW8sa2E9ZnVuY3Rpb24odCxlLG4pe3JldHVybiBuby5mKHQsZSxuKX0sU2E9S3QsT2E9c2kseGE9cmUsQWE9ZmUsVGE9cm8sRWE9Zm8sTGE9eW8semE9VG8sQmE9Sm8sSWE9cW8uZm9yRWFjaCxDYT1FaSgiaGlkZGVuIiksTmE9IlN5bWJvbCIsUmE9InByb3RvdHlwZSIsamE9QmEuc2V0LERhPUJhLmdldHRlckZvcihOYSksUGE9T2JqZWN0W1JhXSxVYT1Rby5TeW1ib2wsRmE9VWEmJlVhW1JhXSxNYT1Rby5SYW5nZUVycm9yLFphPVFvLlR5cGVFcnJvcixKYT1Rby5RT2JqZWN0LEhhPW1hLmYsV2E9eWEuZixLYT1wYS5mLEdhPWJhLmYsVmE9ZWEoW10ucHVzaCksWWE9U2EoInN5bWJvbHMiKSxYYT1TYSgib3Atc3ltYm9scyIpLHFhPVNhKCJ3a3MiKSwkYT0hSmF8fCFKYVtSYV18fCFKYVtSYV0uZmluZENoaWxkLFFhPWZ1bmN0aW9uKHQsZSxuKXt2YXIgcj1IYShQYSxlKTtyJiZkZWxldGUgUGFbZV0sV2EodCxlLG4pLHImJnQhPT1QYSYmV2EoUGEsZSxyKX0sdHM9bmEmJmlhKChmdW5jdGlvbigpe3JldHVybiA3IT09ZmEoV2Eoe30sImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gV2EodGhpcywiYSIse3ZhbHVlOjd9KS5hfX0pKS5hfSkpP1FhOldhLGVzPWZ1bmN0aW9uKHQsZSl7dmFyIG49WWFbdF09ZmEoRmEpO3JldHVybiBqYShuLHt0eXBlOk5hLHRhZzp0LGRlc2NyaXB0aW9uOmV9KSxuYXx8KG4uZGVzY3JpcHRpb249ZSksbn0sbnM9ZnVuY3Rpb24odCxlLG4pe3Q9PT1QYSYmbnMoWGEsZSxuKSxzYSh0KTt2YXIgcj1sYShlKTtyZXR1cm4gc2Eobiksb2EoWWEscik/KG4uZW51bWVyYWJsZT8ob2EodCxDYSkmJnRbQ2FdW3JdJiYodFtDYV1bcl09ITEpLG49ZmEobix7ZW51bWVyYWJsZTpoYSgwLCExKX0pKToob2EodCxDYSl8fFdhKHQsQ2EsaGEoMSxmYShudWxsKSkpLHRbQ2FdW3JdPSEwKSx0cyh0LHIsbikpOldhKHQscixuKX0scnM9ZnVuY3Rpb24odCxlKXtzYSh0KTt2YXIgbj1jYShlKSxyPWRhKG4pLmNvbmNhdChzcyhuKSk7cmV0dXJuIElhKHIsKGZ1bmN0aW9uKGUpe25hJiYhdGEoaXMsbixlKXx8bnModCxlLG5bZV0pfSkpLHR9LGlzPWZ1bmN0aW9uKHQpe3ZhciBlPWxhKHQpLG49dGEoR2EsdGhpcyxlKTtyZXR1cm4hKHRoaXM9PT1QYSYmb2EoWWEsZSkmJiFvYShYYSxlKSkmJighKG58fCFvYSh0aGlzLGUpfHwhb2EoWWEsZSl8fG9hKHRoaXMsQ2EpJiZ0aGlzW0NhXVtlXSl8fG4pfSxvcz1mdW5jdGlvbih0LGUpe3ZhciBuPWNhKHQpLHI9bGEoZSk7aWYobiE9PVBhfHwhb2EoWWEscil8fG9hKFhhLHIpKXt2YXIgaT1IYShuLHIpO3JldHVybiFpfHwhb2EoWWEscil8fG9hKG4sQ2EpJiZuW0NhXVtyXXx8KGkuZW51bWVyYWJsZT0hMCksaX19LGFzPWZ1bmN0aW9uKHQpe3ZhciBlPUthKGNhKHQpKSxuPVtdO3JldHVybiBJYShlLChmdW5jdGlvbih0KXtvYShZYSx0KXx8b2EoT2EsdCl8fFZhKG4sdCl9KSksbn0sc3M9ZnVuY3Rpb24odCl7dmFyIGU9dD09PVBhLG49S2EoZT9YYTpjYSh0KSkscj1bXTtyZXR1cm4gSWEobiwoZnVuY3Rpb24odCl7IW9hKFlhLHQpfHxlJiYhb2EoUGEsdCl8fFZhKHIsWWFbdF0pfSkpLHJ9O3JhfHwoVWE9ZnVuY3Rpb24oKXtpZihhYShGYSx0aGlzKSl0aHJvdyBuZXcgWmEoIlN5bWJvbCBpcyBub3QgYSBjb25zdHJ1Y3RvciIpO3ZhciB0PWFyZ3VtZW50cy5sZW5ndGgmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT91YShhcmd1bWVudHNbMF0pOnZvaWQgMCxlPXhhKHQpLG49ZnVuY3Rpb24odCl7dmFyIHI9dm9pZCAwPT09dGhpcz9Rbzp0aGlzO3I9PT1QYSYmdGEobixYYSx0KSxvYShyLENhKSYmb2EocltDYV0sZSkmJihyW0NhXVtlXT0hMSk7dmFyIGk9aGEoMSx0KTt0cnl7dHMocixlLGkpfWNhdGNoKG8pe2lmKCEobyBpbnN0YW5jZW9mIE1hKSl0aHJvdyBvO1FhKHIsZSxpKX19O3JldHVybiBuYSYmJGEmJnRzKFBhLGUse2NvbmZpZ3VyYWJsZTohMCxzZXQ6bn0pLGVzKGUsdCl9LHdhKEZhPVVhW1JhXSwidG9TdHJpbmciLChmdW5jdGlvbigpe3JldHVybiBEYSh0aGlzKS50YWd9KSksd2EoVWEsIndpdGhvdXRTZXR0ZXIiLChmdW5jdGlvbih0KXtyZXR1cm4gZXMoeGEodCksdCl9KSksYmEuZj1pcyx5YS5mPW5zLHZhLmY9cnMsbWEuZj1vcyxfYS5mPXBhLmY9YXMsZ2EuZj1zcyxUYS5mPWZ1bmN0aW9uKHQpe3JldHVybiBlcyhBYSh0KSx0KX0sbmEmJmthKEZhLCJkZXNjcmlwdGlvbiIse2NvbmZpZ3VyYWJsZTohMCxnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gRGEodGhpcykuZGVzY3JpcHRpb259fSkpLCRvKHtnbG9iYWw6ITAsY29uc3RydWN0b3I6ITAsd3JhcDohMCxmb3JjZWQ6IXJhLHNoYW06IXJhfSx7U3ltYm9sOlVhfSksSWEoZGEocWEpLChmdW5jdGlvbih0KXtFYSh0KX0pKSwkbyh7dGFyZ2V0Ok5hLHN0YXQ6ITAsZm9yY2VkOiFyYX0se3VzZVNldHRlcjpmdW5jdGlvbigpeyRhPSEwfSx1c2VTaW1wbGU6ZnVuY3Rpb24oKXskYT0hMX19KSwkbyh7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOiFyYSxzaGFtOiFuYX0se2NyZWF0ZTpmdW5jdGlvbih0LGUpe3JldHVybiB2b2lkIDA9PT1lP2ZhKHQpOnJzKGZhKHQpLGUpfSxkZWZpbmVQcm9wZXJ0eTpucyxkZWZpbmVQcm9wZXJ0aWVzOnJzLGdldE93blByb3BlcnR5RGVzY3JpcHRvcjpvc30pLCRvKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IXJhfSx7Z2V0T3duUHJvcGVydHlOYW1lczphc30pLExhKCksemEoVWEsTmEpLE9hW0NhXT0hMDt2YXIgY3M9eXQmJiEhU3ltYm9sLmZvciYmISFTeW1ib2wua2V5Rm9yLGxzPUxuLHVzPWl0LGhzPSR0LGZzPXFyLGRzPUt0LF9zPWNzLHBzPWRzKCJzdHJpbmctdG8tc3ltYm9sLXJlZ2lzdHJ5IiksZ3M9ZHMoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTtscyh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiFfc30se2ZvcjpmdW5jdGlvbih0KXt2YXIgZT1mcyh0KTtpZihocyhwcyxlKSlyZXR1cm4gcHNbZV07dmFyIG49dXMoIlN5bWJvbCIpKGUpO3JldHVybiBwc1tlXT1uLGdzW25dPWUsbn19KTt2YXIgbXM9TG4seXM9JHQsdnM9T3QsYnM9QXQsd3M9Y3Msa3M9S3QoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTttcyh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiF3c30se2tleUZvcjpmdW5jdGlvbih0KXtpZighdnModCkpdGhyb3cgbmV3IFR5cGVFcnJvcihicyh0KSsiIGlzIG5vdCBhIHN5bWJvbCIpO2lmKHlzKGtzLHQpKXJldHVybiBrc1t0XX19KTt2YXIgU3M9RG4sT3M9QSx4cz13LEFzPXFyLFRzPW0oW10ucHVzaCksRXM9TG4sTHM9aXQsenM9ZixCcz1CLElzPW0sQ3M9YSxOcz1BLFJzPU90LGpzPUdpLERzPWZ1bmN0aW9uKHQpe2lmKE9zKHQpKXJldHVybiB0O2lmKFNzKHQpKXtmb3IodmFyIGU9dC5sZW5ndGgsbj1bXSxyPTA7cjxlO3IrKyl7dmFyIGk9dFtyXTsic3RyaW5nIj09dHlwZW9mIGk/VHMobixpKToibnVtYmVyIiE9dHlwZW9mIGkmJiJOdW1iZXIiIT09eHMoaSkmJiJTdHJpbmciIT09eHMoaSl8fFRzKG4sQXMoaSkpfXZhciBvPW4ubGVuZ3RoLGE9ITA7cmV0dXJuIGZ1bmN0aW9uKHQsZSl7aWYoYSlyZXR1cm4gYT0hMSxlO2lmKFNzKHRoaXMpKXJldHVybiBlO2Zvcih2YXIgcj0wO3I8bztyKyspaWYobltyXT09PXQpcmV0dXJuIGV9fX0sUHM9eXQsVXM9U3RyaW5nLEZzPUxzKCJKU09OIiwic3RyaW5naWZ5IiksTXM9SXMoLy4vLmV4ZWMpLFpzPUlzKCIiLmNoYXJBdCksSnM9SXMoIiIuY2hhckNvZGVBdCksSHM9SXMoIiIucmVwbGFjZSksV3M9SXMoMS4udG9TdHJpbmcpLEtzPS9bXHVEODAwLVx1REZGRl0vZyxHcz0vXltcdUQ4MDAtXHVEQkZGXSQvLFZzPS9eW1x1REMwMC1cdURGRkZdJC8sWXM9IVBzfHxDcygoZnVuY3Rpb24oKXt2YXIgdD1McygiU3ltYm9sIikoInN0cmluZ2lmeSBkZXRlY3Rpb24iKTtyZXR1cm4iW251bGxdIiE9PUZzKFt0XSl8fCJ7fSIhPT1Gcyh7YTp0fSl8fCJ7fSIhPT1GcyhPYmplY3QodCkpfSkpLFhzPUNzKChmdW5jdGlvbigpe3JldHVybiciXFx1ZGYwNlxcdWQ4MzQiJyE9PUZzKCJcdWRmMDZcdWQ4MzQiKXx8JyJcXHVkZWFkIichPT1GcygiXHVkZWFkIil9KSkscXM9ZnVuY3Rpb24odCxlKXt2YXIgbj1qcyhhcmd1bWVudHMpLHI9RHMoZSk7aWYoTnMocil8fHZvaWQgMCE9PXQmJiFScyh0KSlyZXR1cm4gblsxXT1mdW5jdGlvbih0LGUpe2lmKE5zKHIpJiYoZT1CcyhyLHRoaXMsVXModCksZSkpLCFScyhlKSlyZXR1cm4gZX0senMoRnMsbnVsbCxuKX0sJHM9ZnVuY3Rpb24odCxlLG4pe3ZhciByPVpzKG4sZS0xKSxpPVpzKG4sZSsxKTtyZXR1cm4gTXMoR3MsdCkmJiFNcyhWcyxpKXx8TXMoVnMsdCkmJiFNcyhHcyxyKT8iXFx1IitXcyhKcyh0LDApLDE2KTp0fTtGcyYmRXMoe3RhcmdldDoiSlNPTiIsc3RhdDohMCxhcml0eTozLGZvcmNlZDpZc3x8WHN9LHtzdHJpbmdpZnk6ZnVuY3Rpb24odCxlLG4pe3ZhciByPWpzKGFyZ3VtZW50cyksaT16cyhZcz9xczpGcyxudWxsLHIpO3JldHVybiBYcyYmInN0cmluZyI9PXR5cGVvZiBpP0hzKGksS3MsJHMpOml9fSk7dmFyIFFzPVFpLHRjPVl0O0xuKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IXl0fHxhKChmdW5jdGlvbigpe1FzLmYoMSl9KSl9LHtnZXRPd25Qcm9wZXJ0eVN5bWJvbHM6ZnVuY3Rpb24odCl7dmFyIGU9UXMuZjtyZXR1cm4gZT9lKHRjKHQpKTpbXX19KSxmbygiYXN5bmNJdGVyYXRvciIpLGZvKCJoYXNJbnN0YW5jZSIpLGZvKCJpc0NvbmNhdFNwcmVhZGFibGUiKSxmbygiaXRlcmF0b3IiKSxmbygibWF0Y2giKSxmbygibWF0Y2hBbGwiKSxmbygicmVwbGFjZSIpLGZvKCJzZWFyY2giKSxmbygic3BlY2llcyIpLGZvKCJzcGxpdCIpO3ZhciBlYz15bztmbygidG9QcmltaXRpdmUiKSxlYygpO3ZhciBuYz1pdCxyYz1UbztmbygidG9TdHJpbmdUYWciKSxyYyhuYygiU3ltYm9sIiksIlN5bWJvbCIpLGZvKCJ1bnNjb3BhYmxlcyIpLFRvKG8uSlNPTiwiSlNPTiIsITApO3ZhciBpYyxvYyxhYyxzYz1RLlN5bWJvbCxjYz17fSxsYz1FLHVjPSR0LGhjPUZ1bmN0aW9uLnByb3RvdHlwZSxmYz1sYyYmT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcixkYz11YyhoYywibmFtZSIpLF9jPXtFWElTVFM6ZGMsUFJPUEVSOmRjJiYic29tZXRoaW5nIj09PWZ1bmN0aW9uKCl7fS5uYW1lLENPTkZJR1VSQUJMRTpkYyYmKCFsY3x8bGMmJmZjKGhjLCJuYW1lIikuY29uZmlndXJhYmxlKX0scGM9IWEoKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gdCgpe31yZXR1cm4gdC5wcm90b3R5cGUuY29uc3RydWN0b3I9bnVsbCxPYmplY3QuZ2V0UHJvdG90eXBlT2YobmV3IHQpIT09dC5wcm90b3R5cGV9KSksZ2M9JHQsbWM9QSx5Yz1ZdCx2Yz1wYyxiYz1FaSgiSUVfUFJPVE8iKSx3Yz1PYmplY3Qsa2M9d2MucHJvdG90eXBlLFNjPXZjP3djLmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKHQpe3ZhciBlPXljKHQpO2lmKGdjKGUsYmMpKXJldHVybiBlW2JjXTt2YXIgbj1lLmNvbnN0cnVjdG9yO3JldHVybiBtYyhuKSYmZSBpbnN0YW5jZW9mIG4/bi5wcm90b3R5cGU6ZSBpbnN0YW5jZW9mIHdjP2tjOm51bGx9LE9jPWEseGM9QSxBYz0kLFRjPVppLEVjPVNjLExjPWVvLHpjPWZlKCJpdGVyYXRvciIpLEJjPSExO1tdLmtleXMmJigibmV4dCJpbihhYz1bXS5rZXlzKCkpPyhvYz1FYyhFYyhhYykpKSE9PU9iamVjdC5wcm90b3R5cGUmJihpYz1vYyk6QmM9ITApO3ZhciBJYz0hQWMoaWMpfHxPYygoZnVuY3Rpb24oKXt2YXIgdD17fTtyZXR1cm4gaWNbemNdLmNhbGwodCkhPT10fSkpO3hjKChpYz1JYz97fTpUYyhpYykpW3pjXSl8fExjKGljLHpjLChmdW5jdGlvbigpe3JldHVybiB0aGlzfSkpO3ZhciBDYz17SXRlcmF0b3JQcm90b3R5cGU6aWMsQlVHR1lfU0FGQVJJX0lURVJBVE9SUzpCY30sTmM9Q2MuSXRlcmF0b3JQcm90b3R5cGUsUmM9WmksamM9UCxEYz1UbyxQYz1jYyxVYz1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxGYz1MbixNYz1CLFpjPV9jLEpjPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBpPWUrIiBJdGVyYXRvciI7cmV0dXJuIHQucHJvdG90eXBlPVJjKE5jLHtuZXh0OmpjKCshcixuKX0pLERjKHQsaSwhMSwhMCksUGNbaV09VWMsdH0sSGM9U2MsV2M9VG8sS2M9ZW8sR2M9Y2MsVmM9Q2MsWWM9WmMuUFJPUEVSLFhjPVZjLkJVR0dZX1NBRkFSSV9JVEVSQVRPUlMscWM9ZmUoIml0ZXJhdG9yIiksJGM9ImtleXMiLFFjPSJ2YWx1ZXMiLHRsPSJlbnRyaWVzIixlbD1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxubD1mdW5jdGlvbih0LGUsbixyLGksbyxhKXtKYyhuLGUscik7dmFyIHMsYyxsLHU9ZnVuY3Rpb24odCl7aWYodD09PWkmJnApcmV0dXJuIHA7aWYoIVhjJiZ0JiZ0IGluIGQpcmV0dXJuIGRbdF07c3dpdGNoKHQpe2Nhc2UgJGM6Y2FzZSBRYzpjYXNlIHRsOnJldHVybiBmdW5jdGlvbigpe3JldHVybiBuZXcgbih0aGlzLHQpfX1yZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gbmV3IG4odGhpcyl9fSxoPWUrIiBJdGVyYXRvciIsZj0hMSxkPXQucHJvdG90eXBlLF89ZFtxY118fGRbIkBAaXRlcmF0b3IiXXx8aSYmZFtpXSxwPSFYYyYmX3x8dShpKSxnPSJBcnJheSI9PT1lJiZkLmVudHJpZXN8fF87aWYoZyYmKHM9SGMoZy5jYWxsKG5ldyB0KSkpIT09T2JqZWN0LnByb3RvdHlwZSYmcy5uZXh0JiYoV2MocyxoLCEwLCEwKSxHY1toXT1lbCksWWMmJmk9PT1RYyYmXyYmXy5uYW1lIT09UWMmJihmPSEwLHA9ZnVuY3Rpb24oKXtyZXR1cm4gTWMoXyx0aGlzKX0pLGkpaWYoYz17dmFsdWVzOnUoUWMpLGtleXM6bz9wOnUoJGMpLGVudHJpZXM6dSh0bCl9LGEpZm9yKGwgaW4gYykoWGN8fGZ8fCEobCBpbiBkKSkmJktjKGQsbCxjW2xdKTtlbHNlIEZjKHt0YXJnZXQ6ZSxwcm90bzohMCxmb3JjZWQ6WGN8fGZ9LGMpO3JldHVybiBhJiZkW3FjXSE9PXAmJktjKGQscWMscCx7bmFtZTppfSksR2NbZV09cCxjfSxybD1mdW5jdGlvbih0LGUpe3JldHVybnt2YWx1ZTp0LGRvbmU6ZX19LGlsPVgsb2w9Y2MsYWw9Sm87cWUuZjt2YXIgc2w9bmwsY2w9cmwsbGw9IkFycmF5IEl0ZXJhdG9yIix1bD1hbC5zZXQsaGw9YWwuZ2V0dGVyRm9yKGxsKTtzbChBcnJheSwiQXJyYXkiLChmdW5jdGlvbih0LGUpe3VsKHRoaXMse3R5cGU6bGwsdGFyZ2V0OmlsKHQpLGluZGV4OjAsa2luZDplfSl9KSwoZnVuY3Rpb24oKXt2YXIgdD1obCh0aGlzKSxlPXQudGFyZ2V0LG49dC5pbmRleCsrO2lmKCFlfHxuPj1lLmxlbmd0aClyZXR1cm4gdC50YXJnZXQ9bnVsbCxjbCh2b2lkIDAsITApO3N3aXRjaCh0LmtpbmQpe2Nhc2Uia2V5cyI6cmV0dXJuIGNsKG4sITEpO2Nhc2UidmFsdWVzIjpyZXR1cm4gY2woZVtuXSwhMSl9cmV0dXJuIGNsKFtuLGVbbl1dLCExKX0pLCJ2YWx1ZXMiKSxvbC5Bcmd1bWVudHM9b2wuQXJyYXk7dmFyIGZsPXtDU1NSdWxlTGlzdDowLENTU1N0eWxlRGVjbGFyYXRpb246MCxDU1NWYWx1ZUxpc3Q6MCxDbGllbnRSZWN0TGlzdDowLERPTVJlY3RMaXN0OjAsRE9NU3RyaW5nTGlzdDowLERPTVRva2VuTGlzdDoxLERhdGFUcmFuc2Zlckl0ZW1MaXN0OjAsRmlsZUxpc3Q6MCxIVE1MQWxsQ29sbGVjdGlvbjowLEhUTUxDb2xsZWN0aW9uOjAsSFRNTEZvcm1FbGVtZW50OjAsSFRNTFNlbGVjdEVsZW1lbnQ6MCxNZWRpYUxpc3Q6MCxNaW1lVHlwZUFycmF5OjAsTmFtZWROb2RlTWFwOjAsTm9kZUxpc3Q6MSxQYWludFJlcXVlc3RMaXN0OjAsUGx1Z2luOjAsUGx1Z2luQXJyYXk6MCxTVkdMZW5ndGhMaXN0OjAsU1ZHTnVtYmVyTGlzdDowLFNWR1BhdGhTZWdMaXN0OjAsU1ZHUG9pbnRMaXN0OjAsU1ZHU3RyaW5nTGlzdDowLFNWR1RyYW5zZm9ybUxpc3Q6MCxTb3VyY2VCdWZmZXJMaXN0OjAsU3R5bGVTaGVldExpc3Q6MCxUZXh0VHJhY2tDdWVMaXN0OjAsVGV4dFRyYWNrTGlzdDowLFRvdWNoTGlzdDowfSxkbD1vLF9sPVRvLHBsPWNjO2Zvcih2YXIgZ2wgaW4gZmwpX2woZGxbZ2xdLGdsKSxwbFtnbF09cGwuQXJyYXk7dmFyIG1sPXNjLHlsPWZlLHZsPXFlLmYsYmw9eWwoIm1ldGFkYXRhIiksd2w9RnVuY3Rpb24ucHJvdG90eXBlO3ZvaWQgMD09PXdsW2JsXSYmdmwod2wsYmwse3ZhbHVlOm51bGx9KSxmbygiYXN5bmNEaXNwb3NlIiksZm8oImRpc3Bvc2UiKSxmbygibWV0YWRhdGEiKTt2YXIga2w9bWwsU2w9bSxPbD1pdCgiU3ltYm9sIikseGw9T2wua2V5Rm9yLEFsPVNsKE9sLnByb3RvdHlwZS52YWx1ZU9mKSxUbD1PbC5pc1JlZ2lzdGVyZWRTeW1ib2x8fGZ1bmN0aW9uKHQpe3RyeXtyZXR1cm4gdm9pZCAwIT09eGwoQWwodCkpfWNhdGNoKGUpe3JldHVybiExfX07TG4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwfSx7aXNSZWdpc3RlcmVkU3ltYm9sOlRsfSk7Zm9yKHZhciBFbD1LdCxMbD1pdCx6bD1tLEJsPU90LElsPWZlLENsPUxsKCJTeW1ib2wiKSxObD1DbC5pc1dlbGxLbm93blN5bWJvbCxSbD1MbCgiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIpLGpsPXpsKENsLnByb3RvdHlwZS52YWx1ZU9mKSxEbD1FbCgid2tzIiksUGw9MCxVbD1SbChDbCksRmw9VWwubGVuZ3RoO1BsPEZsO1BsKyspdHJ5e3ZhciBNbD1VbFtQbF07QmwoQ2xbTWxdKSYmSWwoTWwpfWNhdGNoKGVnKXt9dmFyIFpsPWZ1bmN0aW9uKHQpe2lmKE5sJiZObCh0KSlyZXR1cm4hMDt0cnl7Zm9yKHZhciBlPWpsKHQpLG49MCxyPVJsKERsKSxpPXIubGVuZ3RoO248aTtuKyspaWYoRGxbcltuXV09PWUpcmV0dXJuITB9Y2F0Y2goZWcpe31yZXR1cm4hMX07TG4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLGZvcmNlZDohMH0se2lzV2VsbEtub3duU3ltYm9sOlpsfSksZm8oImN1c3RvbU1hdGNoZXIiKSxmbygib2JzZXJ2YWJsZSIpLExuKHt0YXJnZXQ6IlN5bWJvbCIsc3RhdDohMCxuYW1lOiJpc1JlZ2lzdGVyZWRTeW1ib2wifSx7aXNSZWdpc3RlcmVkOlRsfSksTG4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLG5hbWU6ImlzV2VsbEtub3duU3ltYm9sIixmb3JjZWQ6ITB9LHtpc1dlbGxLbm93bjpabH0pLGZvKCJtYXRjaGVyIiksZm8oIm1ldGFkYXRhS2V5IiksZm8oInBhdHRlcm5NYXRjaCIpLGZvKCJyZXBsYWNlQWxsIik7dmFyIEpsPW4oa2wpLEhsPW0sV2w9TW4sS2w9cXIsR2w9RyxWbD1IbCgiIi5jaGFyQXQpLFlsPUhsKCIiLmNoYXJDb2RlQXQpLFhsPUhsKCIiLnNsaWNlKSxxbD1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgcixpLG89S2woR2woZSkpLGE9V2wobikscz1vLmxlbmd0aDtyZXR1cm4gYTwwfHxhPj1zP3Q/IiI6dm9pZCAwOihyPVlsKG8sYSkpPDU1Mjk2fHxyPjU2MzE5fHxhKzE9PT1zfHwoaT1ZbChvLGErMSkpPDU2MzIwfHxpPjU3MzQzP3Q/VmwobyxhKTpyOnQ/WGwobyxhLGErMik6aS01NjMyMCsoci01NTI5Njw8MTApKzY1NTM2fX0sJGw9e2NvZGVBdDpxbCghMSksY2hhckF0OnFsKCEwKX0uY2hhckF0LFFsPXFyLHR1PUpvLGV1PW5sLG51PXJsLHJ1PSJTdHJpbmcgSXRlcmF0b3IiLGl1PXR1LnNldCxvdT10dS5nZXR0ZXJGb3IocnUpO2V1KFN0cmluZywiU3RyaW5nIiwoZnVuY3Rpb24odCl7aXUodGhpcyx7dHlwZTpydSxzdHJpbmc6UWwodCksaW5kZXg6MH0pfSksKGZ1bmN0aW9uKCl7dmFyIHQsZT1vdSh0aGlzKSxuPWUuc3RyaW5nLHI9ZS5pbmRleDtyZXR1cm4gcj49bi5sZW5ndGg/bnUodm9pZCAwLCEwKToodD0kbChuLHIpLGUuaW5kZXgrPXQubGVuZ3RoLG51KHQsITEpKX0pKTt2YXIgYXU9bihyby5mKCJpdGVyYXRvciIpKTtmdW5jdGlvbiBzdSh0KXtyZXR1cm4oc3U9ImZ1bmN0aW9uIj09dHlwZW9mIEpsJiYic3ltYm9sIj09dHlwZW9mIGF1P2Z1bmN0aW9uKHQpe3JldHVybiB0eXBlb2YgdH06ZnVuY3Rpb24odCl7cmV0dXJuIHQmJiJmdW5jdGlvbiI9PXR5cGVvZiBKbCYmdC5jb25zdHJ1Y3Rvcj09PUpsJiZ0IT09SmwucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiB0fSkodCl9dmFyIGN1PW4ocm8uZigidG9QcmltaXRpdmUiKSk7ZnVuY3Rpb24gbHUodCl7dmFyIGU9ZnVuY3Rpb24odCxlKXtpZigib2JqZWN0IiE9c3UodCl8fCF0KXJldHVybiB0O3ZhciBuPXRbY3VdO2lmKHZvaWQgMCE9PW4pe3ZhciByPW4uY2FsbCh0LGV8fCJkZWZhdWx0Iik7aWYoIm9iamVjdCIhPXN1KHIpKXJldHVybiByO3Rocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIil9cmV0dXJuKCJzdHJpbmciPT09ZT9TdHJpbmc6TnVtYmVyKSh0KX0odCwic3RyaW5nIik7cmV0dXJuInN5bWJvbCI9PXN1KGUpP2U6ZSsiIn1mdW5jdGlvbiB1dSh0LGUsbil7cmV0dXJuKGU9bHUoZSkpaW4gdD9Sbih0LGUse3ZhbHVlOm4sZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTp0W2VdPW4sdH1jbGFzcyBodXtjb25zdHJ1Y3Rvcih0KXt1dSh0aGlzLCJfcG9zaXRpb24iLDApLHV1KHRoaXMsIl9kYXRhdmlldyIsdm9pZCAwKSx0aGlzLl9kYXRhdmlldz1uZXcgRGF0YVZpZXcodCl9Z2V0IGxlbmd0aCgpe3JldHVybiB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RofWdldCBidWZmZXIoKXtyZXR1cm4gdGhpcy5fZGF0YXZpZXcuYnVmZmVyfXNldCBwb3NpdGlvbih0KXt0aGlzLl9wb3NpdGlvbj10fWdldCBwb3NpdGlvbigpe3JldHVybiB0aGlzLl9wb3NpdGlvbn1iYWNrKHQpe3RoaXMucG9zaXRpb24tPXR9Z2V0VWludDgodCl7cmV0dXJuIHRoaXMuX2RhdGF2aWV3LmdldFVpbnQ4KHQpfWdldEludDgodCl7cmV0dXJuIHRoaXMuX2RhdGF2aWV3LmdldEludDgodCl9Z2V0SW50MTYodCl7cmV0dXJuIHRoaXMuX2RhdGF2aWV3LmdldEludDE2KHQpfWdldFVpbnQxNih0KXtyZXR1cm4gdGhpcy5fZGF0YXZpZXcuZ2V0VWludDE2KHQpfWdldFVpbnQzMih0KXtyZXR1cm4gdGhpcy5fZGF0YXZpZXcuZ2V0VWludDMyKHQpfWdldEludDMyKHQpe3JldHVybiB0aGlzLl9kYXRhdmlldy5nZXRJbnQzMih0KX1za2lwKHQpe2NvbnN0IGU9TWF0aC5mbG9vcih0LzQpLG49dCU0O2ZvcihsZXQgcj0wO3I8ZTtyKyspaHUucmVhZEJ5dGUodGhpcyw0KTtuPjAmJmh1LnJlYWRCeXRlKHRoaXMsbil9c3RhdGljIHJlYWRCeXRlKHQsZSxuKXtsZXQgcjtzd2l0Y2goZSl7Y2FzZSAxOnI9bj90LmdldEludDgodC5wb3NpdGlvbik6dC5nZXRVaW50OCh0LnBvc2l0aW9uKTticmVhaztjYXNlIDI6cj1uP3QuZ2V0SW50MTYodC5wb3NpdGlvbik6dC5nZXRVaW50MTYodC5wb3NpdGlvbik7YnJlYWs7Y2FzZSAzOmlmKG4pdGhyb3cgbmV3IEVycm9yKCJub3Qgc3VwcG9ydGVkIGZvciByZWFkQnl0ZSAzIik7cj10LmdldFVpbnQ4KHQucG9zaXRpb24pPDwxNixyfD10LmdldFVpbnQ4KHQucG9zaXRpb24rMSk8PDgscnw9dC5nZXRVaW50OCh0LnBvc2l0aW9uKzIpO2JyZWFrO2Nhc2UgNDpyPW4/dC5nZXRJbnQzMih0LnBvc2l0aW9uKTp0LmdldFVpbnQzMih0LnBvc2l0aW9uKTticmVhaztjYXNlIDg6aWYobil0aHJvdyBuZXcgRXJyb3IoIm5vdCBzdXBwb3J0ZWQgZm9yIHJlYWRCb2R5IDgiKTtyPXQuZ2V0VWludDMyKHQucG9zaXRpb24pPDwzMixyfD10LmdldFVpbnQzMih0LnBvc2l0aW9uKzQpO2JyZWFrO2RlZmF1bHQ6cj0iIn1yZXR1cm4gdC5wb3NpdGlvbis9ZSxyfXJlYWRVaW50OCgpe3JldHVybiBodS5yZWFkQnl0ZSh0aGlzLDEpfXJlYWRVaW50MTYoKXtyZXR1cm4gaHUucmVhZEJ5dGUodGhpcywyKX1yZWFkVWludDI0KCl7cmV0dXJuIGh1LnJlYWRCeXRlKHRoaXMsMyl9cmVhZFVpbnQzMigpe3JldHVybiBodS5yZWFkQnl0ZSh0aGlzLDQpfXJlYWRVaW50NjQoKXtyZXR1cm4gaHUucmVhZEJ5dGUodGhpcyw4KX1yZWFkSW50OCgpe3JldHVybiBodS5yZWFkQnl0ZSh0aGlzLDEsITApfXJlYWRJbnQxNigpe3JldHVybiBodS5yZWFkQnl0ZSh0aGlzLDIsITApfXJlYWRJbnQzMigpe3JldHVybiBodS5yZWFkQnl0ZSh0aGlzLDQsITApfXdyaXRlVWludDMyKHQpe3JldHVybiBuZXcgVWludDhBcnJheShbdD4+PjI0JjI1NSx0Pj4+MTYmMjU1LHQ+Pj44JjI1NSwyNTUmdF0pfX12YXIgZnU9KHQ9Pih0W3QuaW50ZXJuYWw9MF09ImludGVybmFsIix0W3QuZXh0ZXJuYWw9MV09ImV4dGVybmFsIix0W3QuYnlwYXNzPTJdPSJieXBhc3MiLHQpKShmdXx8e30pO2NvbnN0IGR1PW5ldyBVaW50OEFycmF5KFsxMDksMTY3LDUzLDE5MCwxMDMsOTAsNzIsMSwxNzAsODksNjMsMTY0LDE5NCwxOTksMTksODVdKSxfdT1uZXcgVWludDhBcnJheShbMTA5LDE2Nyw1MywxOTAsMTAzLDkwLDcyLDEsMTcwLDg5LDYzLDE2NCwxOTQsMTk5LDE5LDg0XSkscHU9bmV3IFVpbnQ4QXJyYXkoWzMxLDIzOSwzLDUwLDI0MiwxMjAsNzYsODUsMTY5LDQyLDE2MSw5MSw3NSwxODYsMjJdKTtmdW5jdGlvbiBndSh0KXtjb25zdCBlPVtdO2Zvcig7dD49MjU1Oyl0LT0yNTUsZS5wdXNoKDI1NSk7cmV0dXJuIGUucHVzaCh0KSxuZXcgVWludDhBcnJheShlKX1mdW5jdGlvbiBtdSh0KXtsZXQgZT1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06MCxuPTA7Zm9yKDsyNTU9PT10W2VdJiZlPHQuYnl0ZUxlbmd0aDspZSsrLG4rPTI1NTtyZXR1cm4gZTx0LmJ5dGVMZW5ndGgmJihuKz10W2UrK10pLFtuLGVdfWNvbnN0IHl1PW5ldyBVaW50OEFycmF5KFs4MCwxXSk7Y2xhc3MgdnV7c3RhdGljIGdlbmVyYXRlU0VJKHQsZSl7bGV0IG49YXJndW1lbnRzLmxlbmd0aD4yJiZ2b2lkIDAhPT1hcmd1bWVudHNbMl0mJmFyZ3VtZW50c1syXTtjb25zdCByPW5ldyBVaW50OEFycmF5KFswLDAsMCwxXSksaT1lP3l1Om5ldyBVaW50OEFycmF5KFs2XSksbz1uZXcgVWludDhBcnJheShbNV0pLGE9dnUuX191dWlkfHwobj9kdTpfdSkscz1ndSh0LmJ5dGVMZW5ndGgrYS5ieXRlTGVuZ3RoKSxjPSh0PT57Y29uc3QgZT1bXTtsZXQgbj0wO2Zvcihjb25zdCByIG9mIHQpbj49MiYmcjw9MyYmKGUucHVzaCgzKSxuPTApLDA9PT1yP24rKzpuPTAsZS5wdXNoKHIpO3JldHVybiBuZXcgVWludDhBcnJheShlKX0pKHQpO3JldHVybiBuZXcgVWludDhBcnJheShbLi4uciwuLi5pLC4uLm8sLi4ucywuLi5hLC4uLmMsMTI4XSl9c3RhdGljIGRlY29kZVNFSUJvZHkodCxlKXtjb25zdCBuPSh0PT57Y29uc3QgZT1bXTtmb3IobGV0IG49MDtuPHQubGVuZ3RoO24rKyl0W25dPD0zJiYwPT09dFtuLTFdJiYwPT09dFtuLTJdfHxlLnB1c2godFtuXSk7cmV0dXJuIG5ldyBVaW50OEFycmF5KGUpfSkodD10LnNsaWNlKDAsdC5sZW5ndGgtMSkpO2lmKG4uYnl0ZUxlbmd0aDwyKXJldHVybjtsZXQgcj0wO2NvbnN0IGk9ZT8yOjE7aWYoNSE9PW5baV0mJjEwMCE9PW5baV0pcmV0dXJuO3IrPTEraTtjb25zdFtvLGFdPW11KG4scik7cj1hO2xldCBzPTI7Y29uc3QgYz1yK287bi5ieXRlTGVuZ3RoPj1fdS5ieXRlTGVuZ3RoJiZvPj1fdS5ieXRlTGVuZ3RoJiYobi5zbGljZShyLHIrX3UuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PV91LnRvU3RyaW5nKCl8fG4uc2xpY2UocixyK3B1LmJ5dGVMZW5ndGgpLnRvU3RyaW5nKCk9PT1wdS50b1N0cmluZygpKT8ocis9X3UuYnl0ZUxlbmd0aCxzPTEpOm4uYnl0ZUxlbmd0aD49X3UuYnl0ZUxlbmd0aCYmbz49X3UuYnl0ZUxlbmd0aCYmbi5zbGljZShyLHIrZHUuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PWR1LnRvU3RyaW5nKCkmJihyKz1kdS5ieXRlTGVuZ3RoLHM9MCk7cmV0dXJue3R5cGU6cyxwYXlsb2FkOm4uc2xpY2UocixjKX19c3RhdGljIHBhcnNlSW50ZXJuYWxTRUkodCl7Y29uc3QgZT1uZXcgTWFwO2xldCBuPTA7aWYoMD09PXQudHlwZSl7Zm9yKDt0LnBheWxvYWQuYnl0ZUxlbmd0aC1uPj0yOyl7Y29uc3RbcixpXT1tdSh0LnBheWxvYWQsbik7bj1pO2NvbnN0W28sYV09bXUodC5wYXlsb2FkLG4pO2lmKG49YSxlLmdldChyKXx8IShvPD10LnBheWxvYWQuYnl0ZUxlbmd0aC1uKSlicmVhaztlLnNldChyLHQucGF5bG9hZC5zbGljZShuLG4rbykpLG4rPW99cmV0dXJuIGV9fXN0YXRpYyBtYWtlSW50ZXJuYWxTZWkodCl7Y29uc3QgZT1bXTtmb3IoY29uc3RbaSxvXW9mIHQpe2NvbnN0IHQ9Z3UoaSksbj1ndShvLmJ5dGVMZW5ndGgpO2UucHVzaCh0LG4sbyl9Y29uc3Qgbj1lLnJlZHVjZSgoKHQsZSk9PnQrZS5ieXRlTGVuZ3RoKSwwKSxyPW5ldyBVaW50OEFycmF5KG4pO3JldHVybiBlLnJlZHVjZSgoKHQsZSk9PihyLnNldChlLHQpLHQrZS5ieXRlTGVuZ3RoKSksMCkscn19dXUodnUsIl9fdXVpZCIsdm9pZCAwKTt2YXIgYnUsd3U9byxrdT1RLFN1PWZ1bmN0aW9uKHQsZSl7dmFyIG49a3VbdCsiUHJvdG90eXBlIl0scj1uJiZuW2VdO2lmKHIpcmV0dXJuIHI7dmFyIGk9d3VbdF0sbz1pJiZpLnByb3RvdHlwZTtyZXR1cm4gbyYmb1tlXX0sT3U9bmV3IFVpbnQ4QXJyYXkoMTYpO2Z1bmN0aW9uIHh1KCl7aWYoIWJ1JiYhKGJ1PSJ1bmRlZmluZWQiIT10eXBlb2YgY3J5cHRvJiZjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzJiZjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQoY3J5cHRvKXx8InVuZGVmaW5lZCIhPXR5cGVvZiBtc0NyeXB0byYmImZ1bmN0aW9uIj09dHlwZW9mIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcyYmbXNDcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQobXNDcnlwdG8pKSl0aHJvdyBuZXcgRXJyb3IoImNyeXB0by5nZXRSYW5kb21WYWx1ZXMoKSBub3Qgc3VwcG9ydGVkLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3V1aWRqcy91dWlkI2dldHJhbmRvbXZhbHVlcy1ub3Qtc3VwcG9ydGVkIik7cmV0dXJuIGJ1KE91KX12YXIgQXU9L14oPzpbMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMS01XVswLTlhLWZdezN9LVs4OWFiXVswLTlhLWZdezN9LVswLTlhLWZdezEyfXwwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDApJC9pO2Zvcih2YXIgVHU9W10sRXU9MDtFdTwyNTY7KytFdSlUdS5wdXNoKChFdSsyNTYpLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSkpO2Z1bmN0aW9uIEx1KHQpe3ZhciBlPWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXTowLG49KFR1W3RbZSswXV0rVHVbdFtlKzFdXStUdVt0W2UrMl1dK1R1W3RbZSszXV0rIi0iK1R1W3RbZSs0XV0rVHVbdFtlKzVdXSsiLSIrVHVbdFtlKzZdXStUdVt0W2UrN11dKyItIitUdVt0W2UrOF1dK1R1W3RbZSs5XV0rIi0iK1R1W3RbZSsxMF1dK1R1W3RbZSsxMV1dK1R1W3RbZSsxMl1dK1R1W3RbZSsxM11dK1R1W3RbZSsxNF1dK1R1W3RbZSsxNV1dKS50b0xvd2VyQ2FzZSgpO2lmKCFmdW5jdGlvbih0KXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIHQmJkF1LnRlc3QodCl9KG4pKXRocm93IFR5cGVFcnJvcigiU3RyaW5naWZpZWQgVVVJRCBpcyBpbnZhbGlkIik7cmV0dXJuIG59ZnVuY3Rpb24genUodCxlLG4pe3ZhciByPSh0PXR8fHt9KS5yYW5kb218fCh0LnJuZ3x8eHUpKCk7aWYocls2XT0xNSZyWzZdfDY0LHJbOF09NjMmcls4XXwxMjgsZSl7bj1ufHwwO2Zvcih2YXIgaT0wO2k8MTY7KytpKWVbbitpXT1yW2ldO3JldHVybiBlfXJldHVybiBMdShyKX1jb25zdCBCdT0oKT0+InVuZGVmaW5lZCI9PXR5cGVvZiB3aW5kb3c7ZnVuY3Rpb24gSXUodCl7cmV0dXJuIG51bGw9PXQ/InVuZGVmaW5lZCB8IG51bGwiOiJzdHJpbmciPT10eXBlb2YgdD90OkpTT04uc3RyaW5naWZ5KHtjb250ZW50SGludDp0LmNvbnRlbnRIaW50LGVuYWJsZWQ6dC5lbmFibGVkLGlkOnQuaWQsa2luZDp0LmtpbmQsbGFiZWw6dC5sYWJlbCxtdXRlZDp0Lm11dGVkLHJlYWR5U3RhdGU6dC5yZWFkeVN0YXRlfSl9ZnVuY3Rpb24gQ3UodCl7cmV0dXJuIG51bGw9PXQ/InVuZGVmaW5lZCB8IG51bGwiOiJzdHJpbmciPT10eXBlb2YgdD90OkpTT04uc3RyaW5naWZ5KHt0cmFjazpJdSh0LnRyYWNrKX0pfWZ1bmN0aW9uIE51KHQpe3JldHVybiBudWxsPT10PyJ1bmRlZmluZWQgfCBudWxsIjoic3RyaW5nIj09dHlwZW9mIHQ/dDpKU09OLnN0cmluZ2lmeSh7dHJhY2s6SXUodC50cmFjayl9KX1jb25zdCBSdT0iQGJ5dGVkL3ZlLXJ0YyIsanU9IkBieXRlZC92ZS1ydGMtY2FjaGUtc2l6ZSI7dmFyIER1PW5ldyBjbGFzc3tjb25zdHJ1Y3Rvcigpe3V1KHRoaXMsInN0b3JlS2V5Iix2b2lkIDApLHV1KHRoaXMsImxvZ0xldmVsIix2b2lkIDApLHV1KHRoaXMsIkxvZ2ZpbGVTaXplIix2b2lkIDApLHV1KHRoaXMsImRiIix2b2lkIDApLHV1KHRoaXMsImxvZ0lkIix2b2lkIDApLHV1KHRoaXMsImNhY2hlTG9nIix2b2lkIDApLHV1KHRoaXMsImNhY2hlZFNpemUiLHZvaWQgMCksdXUodGhpcywicHJlQ2FjaGVUaW1lIix2b2lkIDApLHV1KHRoaXMsInRpbWVyIix2b2lkIDApLHV1KHRoaXMsIl9nZXRTaXplIiwodD0+bmV3IEJsb2IodCkuc2l6ZS8xMDQ4NTc2KSksdGhpcy5zdG9yZUtleT0iIix0aGlzLmxvZ0lkPTEsdGhpcy5jYWNoZUxvZz0iIix0aGlzLmxvZ0xldmVsPSJub25lIix0aGlzLkxvZ2ZpbGVTaXplPTEwMCx0aGlzLl9jcmVhdGVTdG9yZSgpfV9jcmVhdGVTdG9yZSgpe2lmKEJ1KCl8fCF3aW5kb3cuaW5kZXhlZERCKXJldHVybjtjb25zdCB0PWluZGV4ZWREQi5vcGVuKCJAYnl0ZWQvdmUtcnRjIik7dC5vbnVwZ3JhZGVuZWVkZWQ9KCk9Pnt0LnJlc3VsdC5jcmVhdGVPYmplY3RTdG9yZShSdSk7dHJ5e2xvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGp1KX1jYXRjaChlZyl7fX0sdC5vbmVycm9yPXQ9Pnt9LHQub25zdWNjZXNzPSgpPT57dGhpcy5kYj10LnJlc3VsdCx0aGlzLl9nZXRDYWNoZWRTaXplKCl9fV9nZXRDYWNoZWRTaXplKCl7dHJ5e2NvbnN0IHQ9bG9jYWxTdG9yYWdlLmdldEl0ZW0oanUpO3Q/dGhpcy5jYWNoZWRTaXplPU51bWJlcih0KTp0aGlzLnZhbHVlcygpLnRoZW4oKHQ9Pnt0aGlzLmNhY2hlZFNpemU9dGhpcy5fZ2V0U2l6ZSh0KSx0aGlzLl9zZXRDYWNoZWRTaXplKCl9KSl9Y2F0Y2goZWcpe319X3NldENhY2hlZFNpemUoKXt0cnl7bG9jYWxTdG9yYWdlLnNldEl0ZW0oanUsIiIuY29uY2F0KHRoaXMuY2FjaGVkU2l6ZSkpfWNhdGNoKGVnKXt9fV9nZXRTdG9yZSh0KXtpZih0aGlzLmRiKXJldHVybiB0aGlzLmRiLnRyYW5zYWN0aW9uKFJ1LHQpLm9iamVjdFN0b3JlKFJ1KX1zZXQodCl7cmV0dXJuIG5ldyBQcm9taXNlKCgoZSxuKT0+e2lmKCJub25lIj09PXRoaXMubG9nTGV2ZWwpcmV0dXJuIGUoKTtpZih0JiZ0aGlzLnByZUNhY2hlVGltZSYmdGhpcy5wcmVDYWNoZVRpbWUtRGF0ZS5ub3coKTwxZTMpcmV0dXJuIHRoaXMuY2FjaGVMb2crPSJcblxuIi5jb25jYXQodGhpcy5sb2dJZCwiOiAiKS5jb25jYXQodCksdGhpcy5sb2dJZCsrLHRoaXMudGltZXJ8fCh0aGlzLnRpbWVyPXNldFRpbWVvdXQoKCgpPT57dGhpcy5zZXQoIiIpfSksMWUzLSh0aGlzLnByZUNhY2hlVGltZS1EYXRlLm5vdygpKSkpLGUoKTtjbGVhclRpbWVvdXQodGhpcy50aW1lciksdGhpcy50aW1lcj1udWxsO2NvbnN0IHI9dGhpcy5fZ2V0U3RvcmUoInJlYWR3cml0ZSIpO2lmKCFyKXJldHVybiBuKCJnZXQgc3RvcmUgZmFpbCIpO3RoaXMuY2FjaGVkU2l6ZSYmdGhpcy5jYWNoZWRTaXplPnRoaXMuTG9nZmlsZVNpemUmJnRoaXMua2V5RWFybGllc3QoKS50aGVuKCh0PT57dGhpcy5nZXQodCkudGhlbigoZT0+e3RoaXMuZGVsKHQpLnRoZW4oKCgpPT57dGhpcy5jYWNoZWRTaXplPXRoaXMuY2FjaGVkU2l6ZS10aGlzLl9nZXRTaXplKFsiIi5jb25jYXQoZSldKSx0aGlzLl9zZXRDYWNoZWRTaXplKCl9KSl9KSl9KSk7Y29uc3QgaT1yLmdldCh0aGlzLnN0b3JlS2V5KTtpLm9uc3VjY2Vzcz0oKT0+e3RyeXtjb25zdCBuPSIiLmNvbmNhdChpLnJlc3VsdHx8IiIpLmNvbmNhdCh0aGlzLmNhY2hlTG9nKSxvPXQ/IiIuY29uY2F0KG4/IlxuXG4iOiIiKS5jb25jYXQodGhpcy5sb2dJZCwiOiAiKS5jb25jYXQodCk6IiI7ci5wdXQoIiIuY29uY2F0KG4pLmNvbmNhdChvKSx0aGlzLnN0b3JlS2V5KSx0JiZ0aGlzLmxvZ0lkKyssdGhpcy5jYWNoZUxvZz0iIix0aGlzLmNhY2hlZFNpemU9KHRoaXMuY2FjaGVkU2l6ZXx8MCkrdGhpcy5fZ2V0U2l6ZShbIiIuY29uY2F0KHRoaXMuY2FjaGVMb2cpLmNvbmNhdChvKV0pLHRoaXMuX3NldENhY2hlZFNpemUoKSx0aGlzLnByZUNhY2hlVGltZT1EYXRlLm5vdygpLGUoKX1jYXRjaChvKXtpZighdClyZXR1cm4gbihvKTt0aGlzLmNhY2hlTG9nKz0iXG5cbiIuY29uY2F0KHRoaXMubG9nSWQsIjogIikuY29uY2F0KHQpLHRoaXMubG9nSWQrKyxuKG8pfX0saS5vbmVycm9yPWU9PntpZighdClyZXR1cm4gbihlKTt0aGlzLmNhY2hlTG9nKz0iXG5cbiIuY29uY2F0KHRoaXMubG9nSWQsIjogIikuY29uY2F0KHQpLHRoaXMubG9nSWQrKyxuKGUpfX0pKX1nZXQodCl7cmV0dXJuIG5ldyBQcm9taXNlKCgoZSxuKT0+e2NvbnN0IHI9dGhpcy5fZ2V0U3RvcmUoInJlYWRvbmx5Iik7aWYoIXIpcmV0dXJuIG4oKTtjb25zdCBpPXIuZ2V0KHQpO2kub25zdWNjZXNzPSgpPT57ZShpLnJlc3VsdCl9LGkub25lcnJvcj10PT57bih0KX19KSl9ZGVsKCl7bGV0IHQ9YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOnRoaXMuc3RvcmVLZXk7cmV0dXJuIG5ldyBQcm9taXNlKCgoZSxuKT0+e2NvbnN0IHI9dGhpcy5fZ2V0U3RvcmUoInJlYWR3cml0ZSIpO2lmKCFyKXJldHVybiBuKCk7Y29uc3QgaT1yLmRlbGV0ZSh0KTtpLm9uc3VjY2Vzcz0oKT0+ZShpLnJlc3VsdCksaS5vbmVycm9yPXQ9Pm4odCl9KSl9a2V5RWFybGllc3QoKXtyZXR1cm4gdGhpcy5rZXlzKCkudGhlbigodD0+e2xldCBlLG49RGF0ZS5ub3coKTtyZXR1cm4gdC5mb3JFYWNoKCh0PT57aWYoIXR8fCF0Lmxlbmd0aClyZXR1cm47Y29uc3Qgcj10LnNwbGl0KCItIilbMF07TnVtYmVyKHIpPG4mJihuPU51bWJlcihyKSxlPXQpfSkpLGV9KSl9a2V5cygpe3JldHVybiBuZXcgUHJvbWlzZSgoKHQsZSk9Pntjb25zdCBuPXRoaXMuX2dldFN0b3JlKCJyZWFkb25seSIpO2lmKCFuKXJldHVybiBlKCk7aWYobi5nZXRBbGxLZXlzKXtjb25zdCByPW4uZ2V0QWxsS2V5cygpO3JldHVybiByLm9uc3VjY2Vzcz0oKT0+e3Qoci5yZXN1bHQpfSx2b2lkKHIub25lcnJvcj0oKT0+e2UoKX0pfWNvbnN0IHI9W107bi5vcGVuQ3Vyc29yKCkub25zdWNjZXNzPWZ1bmN0aW9uKCl7dGhpcy5yZXN1bHQmJihyLnB1c2godGhpcy5yZXN1bHQua2V5KSx0aGlzLnJlc3VsdC5jb250aW51ZSgpKX0sbi50cmFuc2FjdGlvbi5vbmNvbXBsZXRlPSgpPT50KHIpfSkpfXZhbHVlcygpe3JldHVybiBuZXcgUHJvbWlzZSgoKHQsZSk9Pntjb25zdCBuPXRoaXMuX2dldFN0b3JlKCJyZWFkb25seSIpO2lmKCFuKXJldHVybiBlKCk7aWYobi5nZXRBbGwpe2NvbnN0IHI9bi5nZXRBbGwoKTtyZXR1cm4gci5vbnN1Y2Nlc3M9KCk9Pnt0KHIucmVzdWx0KX0sdm9pZChyLm9uZXJyb3I9KCk9PntlKCl9KX1jb25zdCByPVtdO24ub3BlbkN1cnNvcigpLm9uc3VjY2Vzcz1mdW5jdGlvbigpe3RoaXMucmVzdWx0JiYoci5wdXNoKHRoaXMucmVzdWx0LnZhbHVlKSx0aGlzLnJlc3VsdC5jb250aW51ZSgpKX0sbi50cmFuc2FjdGlvbi5vbmNvbXBsZXRlPSgpPT50KHIpfSkpfWRvd25sb2FkKHQpe3Q9dHx8dGhpcy5zdG9yZUtleSx0aGlzLmdldCh0KS50aGVuKChlPT57Y29uc3Qgbj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7bi5kb3dubG9hZD0iIi5jb25jYXQodCwiLnR4dCIpLG4uaHJlZj0iZGF0YTp0ZXh0L3BhaW50O3V0Zi04LCIuY29uY2F0KGV8fCIiKSxuLmNsaWNrKCl9KSl9fTtjbGFzcyBQdXtjb25zdHJ1Y3Rvcigpe3V1KHRoaXMsIl9hbGwiLHt9KX1vbih0LGUpe2NvbnN0IG49dGhpcy5fYWxsW3RdO24/bi5wdXNoKGUpOnRoaXMuX2FsbFt0XT1bZV19b25jZSh0LGUpe3ZhciBuPXRoaXM7Y29uc3Qgcj1mdW5jdGlvbigpe2UoLi4uYXJndW1lbnRzKSxuLm9mZih0LHIpfTt0aGlzLm9uKHQscil9b2ZmKHQsZSl7Y29uc3Qgbj10aGlzLl9hbGxbdF07bnVsbD09bnx8bi5zcGxpY2Uobi5pbmRleE9mKGUpPj4+MCwxKX1lbWl0KHQpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGU+MT9lLTE6MCkscj0xO3I8ZTtyKyspbltyLTFdPWFyZ3VtZW50c1tyXTtjb25zdCBpPXRoaXMuX2FsbFt0XTtudWxsPT1pfHxpLnNsaWNlKCkuZm9yRWFjaCgodD0+dCguLi5uKSkpfXNhZmVFbWl0KHQpe3RyeXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlPjE/ZS0xOjApLHI9MTtyPGU7cisrKW5bci0xXT1hcmd1bWVudHNbcl07cmV0dXJuIHRoaXMuZW1pdCh0LC4uLm4pfWNhdGNoKGVnKXtjb25zb2xlLmVycm9yKGVnKX19ZGVzdHJveSgpe3RoaXMuX2FsbD17fX19Y29uc3QgVXU9WyJVUExPQURfQ09OU09MRV9MRU5HVEhfQ1VUIiwiVVBMT0FEX1JFUE9SVF9MSU1JVCJdO2NvbnN0IEZ1PW5ldyBjbGFzcyBleHRlbmRzIFB1e2NvbnN0cnVjdG9yKCl7c3VwZXIoLi4uYXJndW1lbnRzKSx1dSh0aGlzLCJjb25maWciLHtVUExPQURfQ09OU09MRV9PTjohMSxVUExPQURfQ09OU09MRV9MRU5HVEhfQ1VUOjIwMCxVUExPQURfUkVQT1JUX0xJTUlUOjQ1ZTQsRU5BQkxFX1JFUE9SVF9JREJfQlVGRkVSOiExfSl9c2V0UGFyYW1ldGVyKHQsZSl7aWYoZnVuY3Rpb24odCl7cmV0dXJuIFV1LmluY2x1ZGVzKHQpfSh0KSl0cnl7Y29uc3Qgbj1OdW1iZXIoZSk7aWYoTnVtYmVyLmlzTmFOKG4pKXJldHVybjt0aGlzLmNvbmZpZ1t0XT1ufWNhdGNoKG4pe3JldHVybiB2b2lkIGNvbnNvbGUud2FybigiQ2Fubm90IGNvbnZlcnQgY29yZSBsaWIgcGFyYW1ldGVyICIuY29uY2F0KHQsIjoiKS5jb25jYXQoZSwiIGludG8gbnVtYmVyIikpfWVsc2UgdGhpcy5jb25maWdbdF09ZTt0aGlzLmVtaXQodCx0aGlzLmNvbmZpZ1t0XSl9Z2V0UGFyYW1ldGVyKHQpe3JldHVybiB0aGlzLmNvbmZpZ1t0XX1nZXRLZXlzKCl7cmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuY29uZmlnKX19O3ZhciBNdT1ZdCxadT1taTtMbih7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOmEoKGZ1bmN0aW9uKCl7WnUoMSl9KSl9LHtrZXlzOmZ1bmN0aW9uKHQpe3JldHVybiBadShNdSh0KSl9fSk7dmFyIEp1PW4oUS5PYmplY3Qua2V5cyksSHU9bihRLk9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpLFd1PXFvLmZpbHRlcjtMbih7dGFyZ2V0OiJBcnJheSIscHJvdG86ITAsZm9yY2VkOiFOcigiZmlsdGVyIil9LHtmaWx0ZXI6ZnVuY3Rpb24odCl7cmV0dXJuIFd1KHRoaXMsdCxhcmd1bWVudHMubGVuZ3RoPjE/YXJndW1lbnRzWzFdOnZvaWQgMCl9fSk7dmFyIEt1PVN1KCJBcnJheSIsImZpbHRlciIpLEd1PW90LFZ1PUt1LFl1PUFycmF5LnByb3RvdHlwZSxYdT1uKChmdW5jdGlvbih0KXt2YXIgZT10LmZpbHRlcjtyZXR1cm4gdD09PVl1fHxHdShZdSx0KSYmZT09PVl1LmZpbHRlcj9WdTplfSkpLHF1PXtleHBvcnRzOnt9fSwkdT1MbixRdT1hLHRoPVgsZWg9VC5mLG5oPUU7JHUoe3RhcmdldDoiT2JqZWN0IixzdGF0OiEwLGZvcmNlZDohbmh8fFF1KChmdW5jdGlvbigpe2VoKDEpfSkpLHNoYW06IW5ofSx7Z2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOmZ1bmN0aW9uKHQsZSl7cmV0dXJuIGVoKHRoKHQpLGUpfX0pO3ZhciByaD1RLk9iamVjdCxpaD1xdS5leHBvcnRzPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIHJoLmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LGUpfTtyaC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iuc2hhbSYmKGloLnNoYW09ITApO3ZhciBvaD1uKHF1LmV4cG9ydHMpLGFoPUUsc2g9RG4sY2g9VHlwZUVycm9yLGxoPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsdWg9YWgmJiFmdW5jdGlvbigpe2lmKHZvaWQgMCE9PXRoaXMpcmV0dXJuITA7dHJ5e09iamVjdC5kZWZpbmVQcm9wZXJ0eShbXSwibGVuZ3RoIix7d3JpdGFibGU6ITF9KS5sZW5ndGg9MX1jYXRjaChlZyl7cmV0dXJuIGVnIGluc3RhbmNlb2YgVHlwZUVycm9yfX0oKSxoaD1ZdCxmaD1XbixkaD11aD9mdW5jdGlvbih0LGUpe2lmKHNoKHQpJiYhbGgodCwibGVuZ3RoIikud3JpdGFibGUpdGhyb3cgbmV3IGNoKCJDYW5ub3Qgc2V0IHJlYWQgb25seSAubGVuZ3RoIik7cmV0dXJuIHQubGVuZ3RoPWV9OmZ1bmN0aW9uKHQsZSl7cmV0dXJuIHQubGVuZ3RoPWV9LF9oPUduO0xuKHt0YXJnZXQ6IkFycmF5Iixwcm90bzohMCxhcml0eToxLGZvcmNlZDphKChmdW5jdGlvbigpe3JldHVybiA0Mjk0OTY3Mjk3IT09W10ucHVzaC5jYWxsKHtsZW5ndGg6NDI5NDk2NzI5Nn0sMSl9KSl8fCFmdW5jdGlvbigpe3RyeXtPYmplY3QuZGVmaW5lUHJvcGVydHkoW10sImxlbmd0aCIse3dyaXRhYmxlOiExfSkucHVzaCgpfWNhdGNoKGVnKXtyZXR1cm4gZWcgaW5zdGFuY2VvZiBUeXBlRXJyb3J9fSgpfSx7cHVzaDpmdW5jdGlvbih0KXt2YXIgZT1oaCh0aGlzKSxuPWZoKGUpLHI9YXJndW1lbnRzLmxlbmd0aDtfaChuK3IpO2Zvcih2YXIgaT0wO2k8cjtpKyspZVtuXT1hcmd1bWVudHNbaV0sbisrO3JldHVybiBkaChlLG4pLG59fSk7dmFyIHBoPVN1KCJBcnJheSIsInB1c2giKSxnaD1vdCxtaD1waCx5aD1BcnJheS5wcm90b3R5cGUsdmg9bigoZnVuY3Rpb24odCl7dmFyIGU9dC5wdXNoO3JldHVybiB0PT09eWh8fGdoKHloLHQpJiZlPT09eWgucHVzaD9taDplfSkpLGJoPWEsd2g9cW8uZm9yRWFjaCxraD1mdW5jdGlvbih0LGUpe3ZhciBuPVtdW3RdO3JldHVybiEhbiYmYmgoKGZ1bmN0aW9uKCl7bi5jYWxsKG51bGwsZXx8ZnVuY3Rpb24oKXtyZXR1cm4gMX0sMSl9KSl9KCJmb3JFYWNoIik/W10uZm9yRWFjaDpmdW5jdGlvbih0KXtyZXR1cm4gd2godGhpcyx0LGFyZ3VtZW50cy5sZW5ndGg+MT9hcmd1bWVudHNbMV06dm9pZCAwKX07TG4oe3RhcmdldDoiQXJyYXkiLHByb3RvOiEwLGZvcmNlZDpbXS5mb3JFYWNoIT09a2h9LHtmb3JFYWNoOmtofSk7dmFyIFNoPVN1KCJBcnJheSIsImZvckVhY2giKSxPaD1hcix4aD0kdCxBaD1vdCxUaD1TaCxFaD1BcnJheS5wcm90b3R5cGUsTGg9e0RPTVRva2VuTGlzdDohMCxOb2RlTGlzdDohMH0semg9bigoZnVuY3Rpb24odCl7dmFyIGU9dC5mb3JFYWNoO3JldHVybiB0PT09RWh8fEFoKEVoLHQpJiZlPT09RWguZm9yRWFjaHx8eGgoTGgsT2godCkpP1RoOmV9KSksQmg9aXQsSWg9SmksQ2g9UWksTmg9bm4sUmg9bShbXS5jb25jYXQpLGpoPUJoKCJSZWZsZWN0Iiwib3duS2V5cyIpfHxmdW5jdGlvbih0KXt2YXIgZT1JaC5mKE5oKHQpKSxuPUNoLmY7cmV0dXJuIG4/UmgoZSxuKHQpKTplfSxEaD1YLFBoPVQsVWg9cW47TG4oe3RhcmdldDoiT2JqZWN0IixzdGF0OiEwLHNoYW06IUV9LHtnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzOmZ1bmN0aW9uKHQpe2Zvcih2YXIgZSxuLHI9RGgodCksaT1QaC5mLG89amgociksYT17fSxzPTA7by5sZW5ndGg+czspdm9pZCAwIT09KG49aShyLGU9b1tzKytdKSkmJlVoKGEsZSxuKTtyZXR1cm4gYX19KTt2YXIgRmg9bihRLk9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKSxNaD17ZXhwb3J0czp7fX0sWmg9TG4sSmg9RSxIaD0kci5mO1poKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6T2JqZWN0LmRlZmluZVByb3BlcnRpZXMhPT1IaCxzaGFtOiFKaH0se2RlZmluZVByb3BlcnRpZXM6SGh9KTt2YXIgV2g9US5PYmplY3QsS2g9TWguZXhwb3J0cz1mdW5jdGlvbih0LGUpe3JldHVybiBXaC5kZWZpbmVQcm9wZXJ0aWVzKHQsZSl9O1doLmRlZmluZVByb3BlcnRpZXMuc2hhbSYmKEtoLnNoYW09ITApO3ZhciBHaD1uKE1oLmV4cG9ydHMpO2Z1bmN0aW9uIFZoKHQsZSl7dmFyIG49SnUodCk7aWYoSHUpe3ZhciByPUh1KHQpO2UmJihyPVh1KHIpLmNhbGwociwoZnVuY3Rpb24oZSl7cmV0dXJuIG9oKHQsZSkuZW51bWVyYWJsZX0pKSksdmgobikuYXBwbHkobixyKX1yZXR1cm4gbn1mdW5jdGlvbiBZaCh0KXtmb3IodmFyIGU9MTtlPGFyZ3VtZW50cy5sZW5ndGg7ZSsrKXt2YXIgbixyLGk9bnVsbCE9YXJndW1lbnRzW2VdP2FyZ3VtZW50c1tlXTp7fTtlJTI/emgobj1WaChPYmplY3QoaSksITApKS5jYWxsKG4sKGZ1bmN0aW9uKGUpe3V1KHQsZSxpW2VdKX0pKTpGaD9HaCh0LEZoKGkpKTp6aChyPVZoKE9iamVjdChpKSkpLmNhbGwociwoZnVuY3Rpb24oZSl7Um4odCxlLG9oKGksZSkpfSkpfXJldHVybiB0fXZhciBYaD1EbixxaD1XbiwkaD1HbixRaD1YZSx0Zj1mdW5jdGlvbih0LGUsbixyLGksbyxhLHMpe2Zvcih2YXIgYyxsLHU9aSxoPTAsZj0hIWEmJlFoKGEscyk7aDxyOyloIGluIG4mJihjPWY/ZihuW2hdLGgsZSk6bltoXSxvPjAmJlhoKGMpPyhsPXFoKGMpLHU9dGYodCxlLGMsbCx1LG8tMSktMSk6KCRoKHUrMSksdFt1XT1jKSx1KyspLGgrKztyZXR1cm4gdX0sZWY9dGYsbmY9WXQscmY9V24sb2Y9TW4sYWY9enI7TG4oe3RhcmdldDoiQXJyYXkiLHByb3RvOiEwfSx7ZmxhdDpmdW5jdGlvbigpe3ZhciB0PWFyZ3VtZW50cy5sZW5ndGg/YXJndW1lbnRzWzBdOnZvaWQgMCxlPW5mKHRoaXMpLG49cmYoZSkscj1hZihlLDApO3JldHVybiByLmxlbmd0aD1lZihyLGUsZSxuLDAsdm9pZCAwPT09dD8xOm9mKHQpKSxyfX0pO3ZhciBzZj1TdSgiQXJyYXkiLCJmbGF0IiksY2Y9b3QsbGY9c2YsdWY9QXJyYXkucHJvdG90eXBlLGhmPW4oKGZ1bmN0aW9uKHQpe3ZhciBlPXQuZmxhdDtyZXR1cm4gdD09PXVmfHxjZih1Zix0KSYmZT09PXVmLmZsYXQ/bGY6ZX0pKSxmZj17fTshZnVuY3Rpb24odCl7dmFyIGU9InVuZGVmaW5lZCIhPXR5cGVvZiBVaW50OEFycmF5JiYidW5kZWZpbmVkIiE9dHlwZW9mIFVpbnQxNkFycmF5JiYidW5kZWZpbmVkIiE9dHlwZW9mIEludDMyQXJyYXk7ZnVuY3Rpb24gbih0LGUpe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodCxlKX10LmFzc2lnbj1mdW5jdGlvbih0KXtmb3IodmFyIGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDEpO2UubGVuZ3RoOyl7dmFyIHI9ZS5zaGlmdCgpO2lmKHIpe2lmKCJvYmplY3QiIT10eXBlb2Ygcil0aHJvdyBuZXcgVHlwZUVycm9yKHIrIm11c3QgYmUgbm9uLW9iamVjdCIpO2Zvcih2YXIgaSBpbiByKW4ocixpKSYmKHRbaV09cltpXSl9fXJldHVybiB0fSx0LnNocmlua0J1Zj1mdW5jdGlvbih0LGUpe3JldHVybiB0Lmxlbmd0aD09PWU/dDp0LnN1YmFycmF5P3Quc3ViYXJyYXkoMCxlKToodC5sZW5ndGg9ZSx0KX07dmFyIHI9e2FycmF5U2V0OmZ1bmN0aW9uKHQsZSxuLHIsaSl7aWYoZS5zdWJhcnJheSYmdC5zdWJhcnJheSl0LnNldChlLnN1YmFycmF5KG4sbityKSxpKTtlbHNlIGZvcih2YXIgbz0wO288cjtvKyspdFtpK29dPWVbbitvXX0sZmxhdHRlbkNodW5rczpmdW5jdGlvbih0KXt2YXIgZSxuLHIsaSxvLGE7Zm9yKHI9MCxlPTAsbj10Lmxlbmd0aDtlPG47ZSsrKXIrPXRbZV0ubGVuZ3RoO2ZvcihhPW5ldyBVaW50OEFycmF5KHIpLGk9MCxlPTAsbj10Lmxlbmd0aDtlPG47ZSsrKW89dFtlXSxhLnNldChvLGkpLGkrPW8ubGVuZ3RoO3JldHVybiBhfX0saT17YXJyYXlTZXQ6ZnVuY3Rpb24odCxlLG4scixpKXtmb3IodmFyIG89MDtvPHI7bysrKXRbaStvXT1lW24rb119LGZsYXR0ZW5DaHVua3M6ZnVuY3Rpb24odCl7cmV0dXJuW10uY29uY2F0LmFwcGx5KFtdLHQpfX07dC5zZXRUeXBlZD1mdW5jdGlvbihlKXtlPyh0LkJ1Zjg9VWludDhBcnJheSx0LkJ1ZjE2PVVpbnQxNkFycmF5LHQuQnVmMzI9SW50MzJBcnJheSx0LmFzc2lnbih0LHIpKToodC5CdWY4PUFycmF5LHQuQnVmMTY9QXJyYXksdC5CdWYzMj1BcnJheSx0LmFzc2lnbih0LGkpKX0sdC5zZXRUeXBlZChlKX0oZmYpO3ZhciBkZj17fSxfZj17fSxwZj17fSxnZj1mZjtmdW5jdGlvbiBtZih0KXtmb3IodmFyIGU9dC5sZW5ndGg7LS1lPj0wOyl0W2VdPTB9dmFyIHlmPTI1Nix2Zj0yODYsYmY9MzAsd2Y9MTUsa2Y9WzAsMCwwLDAsMCwwLDAsMCwxLDEsMSwxLDIsMiwyLDIsMywzLDMsMyw0LDQsNCw0LDUsNSw1LDUsMF0sU2Y9WzAsMCwwLDAsMSwxLDIsMiwzLDMsNCw0LDUsNSw2LDYsNyw3LDgsOCw5LDksMTAsMTAsMTEsMTEsMTIsMTIsMTMsMTNdLE9mPVswLDAsMCwwLDAsMCwwLDAsMCwwLDAsMCwwLDAsMCwwLDIsMyw3XSx4Zj1bMTYsMTcsMTgsMCw4LDcsOSw2LDEwLDUsMTEsNCwxMiwzLDEzLDIsMTQsMSwxNV0sQWY9bmV3IEFycmF5KDU3Nik7bWYoQWYpO3ZhciBUZj1uZXcgQXJyYXkoNjApO21mKFRmKTt2YXIgRWY9bmV3IEFycmF5KDUxMik7bWYoRWYpO3ZhciBMZj1uZXcgQXJyYXkoMjU2KTttZihMZik7dmFyIHpmPW5ldyBBcnJheSgyOSk7bWYoemYpO3ZhciBCZixJZixDZixOZj1uZXcgQXJyYXkoYmYpO2Z1bmN0aW9uIFJmKHQsZSxuLHIsaSl7dGhpcy5zdGF0aWNfdHJlZT10LHRoaXMuZXh0cmFfYml0cz1lLHRoaXMuZXh0cmFfYmFzZT1uLHRoaXMuZWxlbXM9cix0aGlzLm1heF9sZW5ndGg9aSx0aGlzLmhhc19zdHJlZT10JiZ0Lmxlbmd0aH1mdW5jdGlvbiBqZih0LGUpe3RoaXMuZHluX3RyZWU9dCx0aGlzLm1heF9jb2RlPTAsdGhpcy5zdGF0X2Rlc2M9ZX1mdW5jdGlvbiBEZih0KXtyZXR1cm4gdDwyNTY/RWZbdF06RWZbMjU2Kyh0Pj4+NyldfWZ1bmN0aW9uIFBmKHQsZSl7dC5wZW5kaW5nX2J1Zlt0LnBlbmRpbmcrK109MjU1JmUsdC5wZW5kaW5nX2J1Zlt0LnBlbmRpbmcrK109ZT4+PjgmMjU1fWZ1bmN0aW9uIFVmKHQsZSxuKXt0LmJpX3ZhbGlkPjE2LW4/KHQuYmlfYnVmfD1lPDx0LmJpX3ZhbGlkJjY1NTM1LFBmKHQsdC5iaV9idWYpLHQuYmlfYnVmPWU+PjE2LXQuYmlfdmFsaWQsdC5iaV92YWxpZCs9bi0xNik6KHQuYmlfYnVmfD1lPDx0LmJpX3ZhbGlkJjY1NTM1LHQuYmlfdmFsaWQrPW4pfWZ1bmN0aW9uIEZmKHQsZSxuKXtVZih0LG5bMiplXSxuWzIqZSsxXSl9ZnVuY3Rpb24gTWYodCxlKXt2YXIgbj0wO2Rve258PTEmdCx0Pj4+PTEsbjw8PTF9d2hpbGUoLS1lPjApO3JldHVybiBuPj4+MX1mdW5jdGlvbiBaZih0LGUsbil7dmFyIHIsaSxvPW5ldyBBcnJheSgxNiksYT0wO2ZvcihyPTE7cjw9d2Y7cisrKW9bcl09YT1hK25bci0xXTw8MTtmb3IoaT0wO2k8PWU7aSsrKXt2YXIgcz10WzIqaSsxXTswIT09cyYmKHRbMippXT1NZihvW3NdKysscykpfX1mdW5jdGlvbiBKZih0KXt2YXIgZTtmb3IoZT0wO2U8dmY7ZSsrKXQuZHluX2x0cmVlWzIqZV09MDtmb3IoZT0wO2U8YmY7ZSsrKXQuZHluX2R0cmVlWzIqZV09MDtmb3IoZT0wO2U8MTk7ZSsrKXQuYmxfdHJlZVsyKmVdPTA7dC5keW5fbHRyZWVbNTEyXT0xLHQub3B0X2xlbj10LnN0YXRpY19sZW49MCx0Lmxhc3RfbGl0PXQubWF0Y2hlcz0wfWZ1bmN0aW9uIEhmKHQpe3QuYmlfdmFsaWQ+OD9QZih0LHQuYmlfYnVmKTp0LmJpX3ZhbGlkPjAmJih0LnBlbmRpbmdfYnVmW3QucGVuZGluZysrXT10LmJpX2J1ZiksdC5iaV9idWY9MCx0LmJpX3ZhbGlkPTB9ZnVuY3Rpb24gV2YodCxlLG4scil7dmFyIGk9MiplLG89MipuO3JldHVybiB0W2ldPHRbb118fHRbaV09PT10W29dJiZyW2VdPD1yW25dfWZ1bmN0aW9uIEtmKHQsZSxuKXtmb3IodmFyIHI9dC5oZWFwW25dLGk9bjw8MTtpPD10LmhlYXBfbGVuJiYoaTx0LmhlYXBfbGVuJiZXZihlLHQuaGVhcFtpKzFdLHQuaGVhcFtpXSx0LmRlcHRoKSYmaSsrLCFXZihlLHIsdC5oZWFwW2ldLHQuZGVwdGgpKTspdC5oZWFwW25dPXQuaGVhcFtpXSxuPWksaTw8PTE7dC5oZWFwW25dPXJ9ZnVuY3Rpb24gR2YodCxlLG4pe3ZhciByLGksbyxhLHM9MDtpZigwIT09dC5sYXN0X2xpdClkb3tyPXQucGVuZGluZ19idWZbdC5kX2J1ZisyKnNdPDw4fHQucGVuZGluZ19idWZbdC5kX2J1ZisyKnMrMV0saT10LnBlbmRpbmdfYnVmW3QubF9idWYrc10scysrLDA9PT1yP0ZmKHQsaSxlKTooRmYodCwobz1MZltpXSkreWYrMSxlKSwwIT09KGE9a2Zbb10pJiZVZih0LGktPXpmW29dLGEpLEZmKHQsbz1EZigtLXIpLG4pLDAhPT0oYT1TZltvXSkmJlVmKHQsci09TmZbb10sYSkpfXdoaWxlKHM8dC5sYXN0X2xpdCk7RmYodCwyNTYsZSl9ZnVuY3Rpb24gVmYodCxlKXt2YXIgbixyLGksbz1lLmR5bl90cmVlLGE9ZS5zdGF0X2Rlc2Muc3RhdGljX3RyZWUscz1lLnN0YXRfZGVzYy5oYXNfc3RyZWUsYz1lLnN0YXRfZGVzYy5lbGVtcyxsPS0xO2Zvcih0LmhlYXBfbGVuPTAsdC5oZWFwX21heD01NzMsbj0wO248YztuKyspMCE9PW9bMipuXT8odC5oZWFwWysrdC5oZWFwX2xlbl09bD1uLHQuZGVwdGhbbl09MCk6b1syKm4rMV09MDtmb3IoO3QuaGVhcF9sZW48Mjspb1syKihpPXQuaGVhcFsrK3QuaGVhcF9sZW5dPWw8Mj8rK2w6MCldPTEsdC5kZXB0aFtpXT0wLHQub3B0X2xlbi0tLHMmJih0LnN0YXRpY19sZW4tPWFbMippKzFdKTtmb3IoZS5tYXhfY29kZT1sLG49dC5oZWFwX2xlbj4+MTtuPj0xO24tLSlLZih0LG8sbik7aT1jO2Rve249dC5oZWFwWzFdLHQuaGVhcFsxXT10LmhlYXBbdC5oZWFwX2xlbi0tXSxLZih0LG8sMSkscj10LmhlYXBbMV0sdC5oZWFwWy0tdC5oZWFwX21heF09bix0LmhlYXBbLS10LmhlYXBfbWF4XT1yLG9bMippXT1vWzIqbl0rb1syKnJdLHQuZGVwdGhbaV09KHQuZGVwdGhbbl0+PXQuZGVwdGhbcl0/dC5kZXB0aFtuXTp0LmRlcHRoW3JdKSsxLG9bMipuKzFdPW9bMipyKzFdPWksdC5oZWFwWzFdPWkrKyxLZih0LG8sMSl9d2hpbGUodC5oZWFwX2xlbj49Mik7dC5oZWFwWy0tdC5oZWFwX21heF09dC5oZWFwWzFdLGZ1bmN0aW9uKHQsZSl7dmFyIG4scixpLG8sYSxzLGM9ZS5keW5fdHJlZSxsPWUubWF4X2NvZGUsdT1lLnN0YXRfZGVzYy5zdGF0aWNfdHJlZSxoPWUuc3RhdF9kZXNjLmhhc19zdHJlZSxmPWUuc3RhdF9kZXNjLmV4dHJhX2JpdHMsZD1lLnN0YXRfZGVzYy5leHRyYV9iYXNlLF89ZS5zdGF0X2Rlc2MubWF4X2xlbmd0aCxwPTA7Zm9yKG89MDtvPD13ZjtvKyspdC5ibF9jb3VudFtvXT0wO2ZvcihjWzIqdC5oZWFwW3QuaGVhcF9tYXhdKzFdPTAsbj10LmhlYXBfbWF4KzE7bjw1NzM7bisrKShvPWNbMipjWzIqKHI9dC5oZWFwW25dKSsxXSsxXSsxKT5fJiYobz1fLHArKyksY1syKnIrMV09byxyPmx8fCh0LmJsX2NvdW50W29dKyssYT0wLHI+PWQmJihhPWZbci1kXSkscz1jWzIqcl0sdC5vcHRfbGVuKz1zKihvK2EpLGgmJih0LnN0YXRpY19sZW4rPXMqKHVbMipyKzFdK2EpKSk7aWYoMCE9PXApe2Rve2ZvcihvPV8tMTswPT09dC5ibF9jb3VudFtvXTspby0tO3QuYmxfY291bnRbb10tLSx0LmJsX2NvdW50W28rMV0rPTIsdC5ibF9jb3VudFtfXS0tLHAtPTJ9d2hpbGUocD4wKTtmb3Iobz1fOzAhPT1vO28tLSlmb3Iocj10LmJsX2NvdW50W29dOzAhPT1yOykoaT10LmhlYXBbLS1uXSk+bHx8KGNbMippKzFdIT09byYmKHQub3B0X2xlbis9KG8tY1syKmkrMV0pKmNbMippXSxjWzIqaSsxXT1vKSxyLS0pfX0odCxlKSxaZihvLGwsdC5ibF9jb3VudCl9ZnVuY3Rpb24gWWYodCxlLG4pe3ZhciByLGksbz0tMSxhPWVbMV0scz0wLGM9NyxsPTQ7Zm9yKDA9PT1hJiYoYz0xMzgsbD0zKSxlWzIqKG4rMSkrMV09NjU1MzUscj0wO3I8PW47cisrKWk9YSxhPWVbMioocisxKSsxXSwrK3M8YyYmaT09PWF8fChzPGw/dC5ibF90cmVlWzIqaV0rPXM6MCE9PWk/KGkhPT1vJiZ0LmJsX3RyZWVbMippXSsrLHQuYmxfdHJlZVszMl0rKyk6czw9MTA/dC5ibF90cmVlWzM0XSsrOnQuYmxfdHJlZVszNl0rKyxzPTAsbz1pLDA9PT1hPyhjPTEzOCxsPTMpOmk9PT1hPyhjPTYsbD0zKTooYz03LGw9NCkpfWZ1bmN0aW9uIFhmKHQsZSxuKXt2YXIgcixpLG89LTEsYT1lWzFdLHM9MCxjPTcsbD00O2ZvcigwPT09YSYmKGM9MTM4LGw9Mykscj0wO3I8PW47cisrKWlmKGk9YSxhPWVbMioocisxKSsxXSwhKCsrczxjJiZpPT09YSkpe2lmKHM8bClkb3tGZih0LGksdC5ibF90cmVlKX13aGlsZSgwIT0tLXMpO2Vsc2UgMCE9PWk/KGkhPT1vJiYoRmYodCxpLHQuYmxfdHJlZSkscy0tKSxGZih0LDE2LHQuYmxfdHJlZSksVWYodCxzLTMsMikpOnM8PTEwPyhGZih0LDE3LHQuYmxfdHJlZSksVWYodCxzLTMsMykpOihGZih0LDE4LHQuYmxfdHJlZSksVWYodCxzLTExLDcpKTtzPTAsbz1pLDA9PT1hPyhjPTEzOCxsPTMpOmk9PT1hPyhjPTYsbD0zKTooYz03LGw9NCl9fW1mKE5mKTt2YXIgcWY9ITE7ZnVuY3Rpb24gJGYodCxlLG4scil7VWYodCwwKyhyPzE6MCksMyksZnVuY3Rpb24odCxlLG4scil7SGYodCksciYmKFBmKHQsbiksUGYodCx+bikpLGdmLmFycmF5U2V0KHQucGVuZGluZ19idWYsdC53aW5kb3csZSxuLHQucGVuZGluZyksdC5wZW5kaW5nKz1ufSh0LGUsbiwhMCl9cGYuX3RyX2luaXQ9ZnVuY3Rpb24odCl7cWZ8fCghZnVuY3Rpb24oKXt2YXIgdCxlLG4scixpLG89bmV3IEFycmF5KDE2KTtmb3Iobj0wLHI9MDtyPDI4O3IrKylmb3IoemZbcl09bix0PTA7dDwxPDxrZltyXTt0KyspTGZbbisrXT1yO2ZvcihMZltuLTFdPXIsaT0wLHI9MDtyPDE2O3IrKylmb3IoTmZbcl09aSx0PTA7dDwxPDxTZltyXTt0KyspRWZbaSsrXT1yO2ZvcihpPj49NztyPGJmO3IrKylmb3IoTmZbcl09aTw8Nyx0PTA7dDwxPDxTZltyXS03O3QrKylFZlsyNTYraSsrXT1yO2ZvcihlPTA7ZTw9d2Y7ZSsrKW9bZV09MDtmb3IodD0wO3Q8PTE0MzspQWZbMip0KzFdPTgsdCsrLG9bOF0rKztmb3IoO3Q8PTI1NTspQWZbMip0KzFdPTksdCsrLG9bOV0rKztmb3IoO3Q8PTI3OTspQWZbMip0KzFdPTcsdCsrLG9bN10rKztmb3IoO3Q8PTI4NzspQWZbMip0KzFdPTgsdCsrLG9bOF0rKztmb3IoWmYoQWYsMjg3LG8pLHQ9MDt0PGJmO3QrKylUZlsyKnQrMV09NSxUZlsyKnRdPU1mKHQsNSk7QmY9bmV3IFJmKEFmLGtmLDI1Nyx2Zix3ZiksSWY9bmV3IFJmKFRmLFNmLDAsYmYsd2YpLENmPW5ldyBSZihuZXcgQXJyYXkoMCksT2YsMCwxOSw3KX0oKSxxZj0hMCksdC5sX2Rlc2M9bmV3IGpmKHQuZHluX2x0cmVlLEJmKSx0LmRfZGVzYz1uZXcgamYodC5keW5fZHRyZWUsSWYpLHQuYmxfZGVzYz1uZXcgamYodC5ibF90cmVlLENmKSx0LmJpX2J1Zj0wLHQuYmlfdmFsaWQ9MCxKZih0KX0scGYuX3RyX3N0b3JlZF9ibG9jaz0kZixwZi5fdHJfZmx1c2hfYmxvY2s9ZnVuY3Rpb24odCxlLG4scil7dmFyIGksbyxhPTA7dC5sZXZlbD4wPygyPT09dC5zdHJtLmRhdGFfdHlwZSYmKHQuc3RybS5kYXRhX3R5cGU9ZnVuY3Rpb24odCl7dmFyIGUsbj00MDkzNjI0NDQ3O2ZvcihlPTA7ZTw9MzE7ZSsrLG4+Pj49MSlpZigxJm4mJjAhPT10LmR5bl9sdHJlZVsyKmVdKXJldHVybiAwO2lmKDAhPT10LmR5bl9sdHJlZVsxOF18fDAhPT10LmR5bl9sdHJlZVsyMF18fDAhPT10LmR5bl9sdHJlZVsyNl0pcmV0dXJuIDE7Zm9yKGU9MzI7ZTx5ZjtlKyspaWYoMCE9PXQuZHluX2x0cmVlWzIqZV0pcmV0dXJuIDE7cmV0dXJuIDB9KHQpKSxWZih0LHQubF9kZXNjKSxWZih0LHQuZF9kZXNjKSxhPWZ1bmN0aW9uKHQpe3ZhciBlO2ZvcihZZih0LHQuZHluX2x0cmVlLHQubF9kZXNjLm1heF9jb2RlKSxZZih0LHQuZHluX2R0cmVlLHQuZF9kZXNjLm1heF9jb2RlKSxWZih0LHQuYmxfZGVzYyksZT0xODtlPj0zJiYwPT09dC5ibF90cmVlWzIqeGZbZV0rMV07ZS0tKTtyZXR1cm4gdC5vcHRfbGVuKz0zKihlKzEpKzUrNSs0LGV9KHQpLGk9dC5vcHRfbGVuKzMrNz4+PjMsKG89dC5zdGF0aWNfbGVuKzMrNz4+PjMpPD1pJiYoaT1vKSk6aT1vPW4rNSxuKzQ8PWkmJi0xIT09ZT8kZih0LGUsbixyKTo0PT09dC5zdHJhdGVneXx8bz09PWk/KFVmKHQsMisocj8xOjApLDMpLEdmKHQsQWYsVGYpKTooVWYodCw0KyhyPzE6MCksMyksZnVuY3Rpb24odCxlLG4scil7dmFyIGk7Zm9yKFVmKHQsZS0yNTcsNSksVWYodCxuLTEsNSksVWYodCxyLTQsNCksaT0wO2k8cjtpKyspVWYodCx0LmJsX3RyZWVbMip4ZltpXSsxXSwzKTtYZih0LHQuZHluX2x0cmVlLGUtMSksWGYodCx0LmR5bl9kdHJlZSxuLTEpfSh0LHQubF9kZXNjLm1heF9jb2RlKzEsdC5kX2Rlc2MubWF4X2NvZGUrMSxhKzEpLEdmKHQsdC5keW5fbHRyZWUsdC5keW5fZHRyZWUpKSxKZih0KSxyJiZIZih0KX0scGYuX3RyX3RhbGx5PWZ1bmN0aW9uKHQsZSxuKXtyZXR1cm4gdC5wZW5kaW5nX2J1Zlt0LmRfYnVmKzIqdC5sYXN0X2xpdF09ZT4+PjgmMjU1LHQucGVuZGluZ19idWZbdC5kX2J1ZisyKnQubGFzdF9saXQrMV09MjU1JmUsdC5wZW5kaW5nX2J1Zlt0LmxfYnVmK3QubGFzdF9saXRdPTI1NSZuLHQubGFzdF9saXQrKywwPT09ZT90LmR5bl9sdHJlZVsyKm5dKys6KHQubWF0Y2hlcysrLGUtLSx0LmR5bl9sdHJlZVsyKihMZltuXSt5ZisxKV0rKyx0LmR5bl9kdHJlZVsyKkRmKGUpXSsrKSx0Lmxhc3RfbGl0PT09dC5saXRfYnVmc2l6ZS0xfSxwZi5fdHJfYWxpZ249ZnVuY3Rpb24odCl7VWYodCwyLDMpLEZmKHQsMjU2LEFmKSxmdW5jdGlvbih0KXsxNj09PXQuYmlfdmFsaWQ/KFBmKHQsdC5iaV9idWYpLHQuYmlfYnVmPTAsdC5iaV92YWxpZD0wKTp0LmJpX3ZhbGlkPj04JiYodC5wZW5kaW5nX2J1Zlt0LnBlbmRpbmcrK109MjU1JnQuYmlfYnVmLHQuYmlfYnVmPj49OCx0LmJpX3ZhbGlkLT04KX0odCl9O3ZhciBRZj1mdW5jdGlvbih0LGUsbixyKXtmb3IodmFyIGk9NjU1MzUmdCxvPXQ+Pj4xNiY2NTUzNSxhPTA7MCE9PW47KXtuLT1hPW4+MmUzPzJlMzpuO2Rve289bysoaT1pK2VbcisrXXwwKXwwfXdoaWxlKC0tYSk7aSU9NjU1MjEsbyU9NjU1MjF9cmV0dXJuIGl8bzw8MTZ9O3ZhciB0ZD1mdW5jdGlvbigpe2Zvcih2YXIgdCxlPVtdLG49MDtuPDI1NjtuKyspe3Q9bjtmb3IodmFyIHI9MDtyPDg7cisrKXQ9MSZ0PzM5ODgyOTIzODRedD4+PjE6dD4+PjE7ZVtuXT10fXJldHVybiBlfSgpO3ZhciBlZCxuZD1mdW5jdGlvbih0LGUsbixyKXt2YXIgaT10ZCxvPXIrbjt0Xj0tMTtmb3IodmFyIGE9cjthPG87YSsrKXQ9dD4+PjheaVsyNTUmKHReZVthXSldO3JldHVybn50fSxyZD17MjoibmVlZCBkaWN0aW9uYXJ5IiwxOiJzdHJlYW0gZW5kIiwwOiIiLCItMSI6ImZpbGUgZXJyb3IiLCItMiI6InN0cmVhbSBlcnJvciIsIi0zIjoiZGF0YSBlcnJvciIsIi00IjoiaW5zdWZmaWNpZW50IG1lbW9yeSIsIi01IjoiYnVmZmVyIGVycm9yIiwiLTYiOiJpbmNvbXBhdGlibGUgdmVyc2lvbiJ9LGlkPWZmLG9kPXBmLGFkPVFmLHNkPW5kLGNkPXJkLGxkPS0yLHVkPTI1OCxoZD0yNjIsZmQ9MTAzLGRkPTExMyxfZD02NjY7ZnVuY3Rpb24gcGQodCxlKXtyZXR1cm4gdC5tc2c9Y2RbZV0sZX1mdW5jdGlvbiBnZCh0KXtyZXR1cm4odDw8MSktKHQ+ND85OjApfWZ1bmN0aW9uIG1kKHQpe2Zvcih2YXIgZT10Lmxlbmd0aDstLWU+PTA7KXRbZV09MH1mdW5jdGlvbiB5ZCh0KXt2YXIgZT10LnN0YXRlLG49ZS5wZW5kaW5nO24+dC5hdmFpbF9vdXQmJihuPXQuYXZhaWxfb3V0KSwwIT09biYmKGlkLmFycmF5U2V0KHQub3V0cHV0LGUucGVuZGluZ19idWYsZS5wZW5kaW5nX291dCxuLHQubmV4dF9vdXQpLHQubmV4dF9vdXQrPW4sZS5wZW5kaW5nX291dCs9bix0LnRvdGFsX291dCs9bix0LmF2YWlsX291dC09bixlLnBlbmRpbmctPW4sMD09PWUucGVuZGluZyYmKGUucGVuZGluZ19vdXQ9MCkpfWZ1bmN0aW9uIHZkKHQsZSl7b2QuX3RyX2ZsdXNoX2Jsb2NrKHQsdC5ibG9ja19zdGFydD49MD90LmJsb2NrX3N0YXJ0Oi0xLHQuc3Ryc3RhcnQtdC5ibG9ja19zdGFydCxlKSx0LmJsb2NrX3N0YXJ0PXQuc3Ryc3RhcnQseWQodC5zdHJtKX1mdW5jdGlvbiBiZCh0LGUpe3QucGVuZGluZ19idWZbdC5wZW5kaW5nKytdPWV9ZnVuY3Rpb24gd2QodCxlKXt0LnBlbmRpbmdfYnVmW3QucGVuZGluZysrXT1lPj4+OCYyNTUsdC5wZW5kaW5nX2J1Zlt0LnBlbmRpbmcrK109MjU1JmV9ZnVuY3Rpb24ga2QodCxlKXt2YXIgbixyLGk9dC5tYXhfY2hhaW5fbGVuZ3RoLG89dC5zdHJzdGFydCxhPXQucHJldl9sZW5ndGgscz10Lm5pY2VfbWF0Y2gsYz10LnN0cnN0YXJ0PnQud19zaXplLWhkP3Quc3Ryc3RhcnQtKHQud19zaXplLWhkKTowLGw9dC53aW5kb3csdT10LndfbWFzayxoPXQucHJldixmPXQuc3Ryc3RhcnQrdWQsZD1sW28rYS0xXSxfPWxbbythXTt0LnByZXZfbGVuZ3RoPj10Lmdvb2RfbWF0Y2gmJihpPj49Mikscz50Lmxvb2thaGVhZCYmKHM9dC5sb29rYWhlYWQpO2Rve2lmKGxbKG49ZSkrYV09PT1fJiZsW24rYS0xXT09PWQmJmxbbl09PT1sW29dJiZsWysrbl09PT1sW28rMV0pe28rPTIsbisrO2Rve313aGlsZShsWysrb109PT1sWysrbl0mJmxbKytvXT09PWxbKytuXSYmbFsrK29dPT09bFsrK25dJiZsWysrb109PT1sWysrbl0mJmxbKytvXT09PWxbKytuXSYmbFsrK29dPT09bFsrK25dJiZsWysrb109PT1sWysrbl0mJmxbKytvXT09PWxbKytuXSYmbzxmKTtpZihyPXVkLShmLW8pLG89Zi11ZCxyPmEpe2lmKHQubWF0Y2hfc3RhcnQ9ZSxhPXIscj49cylicmVhaztkPWxbbythLTFdLF89bFtvK2FdfX19d2hpbGUoKGU9aFtlJnVdKT5jJiYwIT0tLWkpO3JldHVybiBhPD10Lmxvb2thaGVhZD9hOnQubG9va2FoZWFkfWZ1bmN0aW9uIFNkKHQpe3ZhciBlLG4scixpLG8sYSxzLGMsbCx1LGg9dC53X3NpemU7ZG97aWYoaT10LndpbmRvd19zaXplLXQubG9va2FoZWFkLXQuc3Ryc3RhcnQsdC5zdHJzdGFydD49aCsoaC1oZCkpe2lkLmFycmF5U2V0KHQud2luZG93LHQud2luZG93LGgsaCwwKSx0Lm1hdGNoX3N0YXJ0LT1oLHQuc3Ryc3RhcnQtPWgsdC5ibG9ja19zdGFydC09aCxlPW49dC5oYXNoX3NpemU7ZG97cj10LmhlYWRbLS1lXSx0LmhlYWRbZV09cj49aD9yLWg6MH13aGlsZSgtLW4pO2U9bj1oO2Rve3I9dC5wcmV2Wy0tZV0sdC5wcmV2W2VdPXI+PWg/ci1oOjB9d2hpbGUoLS1uKTtpKz1ofWlmKDA9PT10LnN0cm0uYXZhaWxfaW4pYnJlYWs7aWYoYT10LnN0cm0scz10LndpbmRvdyxjPXQuc3Ryc3RhcnQrdC5sb29rYWhlYWQsbD1pLHU9dm9pZCAwLCh1PWEuYXZhaWxfaW4pPmwmJih1PWwpLG49MD09PXU/MDooYS5hdmFpbF9pbi09dSxpZC5hcnJheVNldChzLGEuaW5wdXQsYS5uZXh0X2luLHUsYyksMT09PWEuc3RhdGUud3JhcD9hLmFkbGVyPWFkKGEuYWRsZXIscyx1LGMpOjI9PT1hLnN0YXRlLndyYXAmJihhLmFkbGVyPXNkKGEuYWRsZXIscyx1LGMpKSxhLm5leHRfaW4rPXUsYS50b3RhbF9pbis9dSx1KSx0Lmxvb2thaGVhZCs9bix0Lmxvb2thaGVhZCt0Lmluc2VydD49Mylmb3Iobz10LnN0cnN0YXJ0LXQuaW5zZXJ0LHQuaW5zX2g9dC53aW5kb3dbb10sdC5pbnNfaD0odC5pbnNfaDw8dC5oYXNoX3NoaWZ0XnQud2luZG93W28rMV0pJnQuaGFzaF9tYXNrO3QuaW5zZXJ0JiYodC5pbnNfaD0odC5pbnNfaDw8dC5oYXNoX3NoaWZ0XnQud2luZG93W28rMy0xXSkmdC5oYXNoX21hc2ssdC5wcmV2W28mdC53X21hc2tdPXQuaGVhZFt0Lmluc19oXSx0LmhlYWRbdC5pbnNfaF09byxvKyssdC5pbnNlcnQtLSwhKHQubG9va2FoZWFkK3QuaW5zZXJ0PDMpKTspO313aGlsZSh0Lmxvb2thaGVhZDxoZCYmMCE9PXQuc3RybS5hdmFpbF9pbil9ZnVuY3Rpb24gT2QodCxlKXtmb3IodmFyIG4scjs7KXtpZih0Lmxvb2thaGVhZDxoZCl7aWYoU2QodCksdC5sb29rYWhlYWQ8aGQmJjA9PT1lKXJldHVybiAxO2lmKDA9PT10Lmxvb2thaGVhZClicmVha31pZihuPTAsdC5sb29rYWhlYWQ+PTMmJih0Lmluc19oPSh0Lmluc19oPDx0Lmhhc2hfc2hpZnRedC53aW5kb3dbdC5zdHJzdGFydCszLTFdKSZ0Lmhhc2hfbWFzayxuPXQucHJldlt0LnN0cnN0YXJ0JnQud19tYXNrXT10LmhlYWRbdC5pbnNfaF0sdC5oZWFkW3QuaW5zX2hdPXQuc3Ryc3RhcnQpLDAhPT1uJiZ0LnN0cnN0YXJ0LW48PXQud19zaXplLWhkJiYodC5tYXRjaF9sZW5ndGg9a2QodCxuKSksdC5tYXRjaF9sZW5ndGg+PTMpaWYocj1vZC5fdHJfdGFsbHkodCx0LnN0cnN0YXJ0LXQubWF0Y2hfc3RhcnQsdC5tYXRjaF9sZW5ndGgtMyksdC5sb29rYWhlYWQtPXQubWF0Y2hfbGVuZ3RoLHQubWF0Y2hfbGVuZ3RoPD10Lm1heF9sYXp5X21hdGNoJiZ0Lmxvb2thaGVhZD49Myl7dC5tYXRjaF9sZW5ndGgtLTtkb3t0LnN0cnN0YXJ0KyssdC5pbnNfaD0odC5pbnNfaDw8dC5oYXNoX3NoaWZ0XnQud2luZG93W3Quc3Ryc3RhcnQrMy0xXSkmdC5oYXNoX21hc2ssbj10LnByZXZbdC5zdHJzdGFydCZ0LndfbWFza109dC5oZWFkW3QuaW5zX2hdLHQuaGVhZFt0Lmluc19oXT10LnN0cnN0YXJ0fXdoaWxlKDAhPS0tdC5tYXRjaF9sZW5ndGgpO3Quc3Ryc3RhcnQrK31lbHNlIHQuc3Ryc3RhcnQrPXQubWF0Y2hfbGVuZ3RoLHQubWF0Y2hfbGVuZ3RoPTAsdC5pbnNfaD10LndpbmRvd1t0LnN0cnN0YXJ0XSx0Lmluc19oPSh0Lmluc19oPDx0Lmhhc2hfc2hpZnRedC53aW5kb3dbdC5zdHJzdGFydCsxXSkmdC5oYXNoX21hc2s7ZWxzZSByPW9kLl90cl90YWxseSh0LDAsdC53aW5kb3dbdC5zdHJzdGFydF0pLHQubG9va2FoZWFkLS0sdC5zdHJzdGFydCsrO2lmKHImJih2ZCh0LCExKSwwPT09dC5zdHJtLmF2YWlsX291dCkpcmV0dXJuIDF9cmV0dXJuIHQuaW5zZXJ0PXQuc3Ryc3RhcnQ8Mj90LnN0cnN0YXJ0OjIsND09PWU/KHZkKHQsITApLDA9PT10LnN0cm0uYXZhaWxfb3V0PzM6NCk6dC5sYXN0X2xpdCYmKHZkKHQsITEpLDA9PT10LnN0cm0uYXZhaWxfb3V0KT8xOjJ9ZnVuY3Rpb24geGQodCxlKXtmb3IodmFyIG4scixpOzspe2lmKHQubG9va2FoZWFkPGhkKXtpZihTZCh0KSx0Lmxvb2thaGVhZDxoZCYmMD09PWUpcmV0dXJuIDE7aWYoMD09PXQubG9va2FoZWFkKWJyZWFrfWlmKG49MCx0Lmxvb2thaGVhZD49MyYmKHQuaW5zX2g9KHQuaW5zX2g8PHQuaGFzaF9zaGlmdF50LndpbmRvd1t0LnN0cnN0YXJ0KzMtMV0pJnQuaGFzaF9tYXNrLG49dC5wcmV2W3Quc3Ryc3RhcnQmdC53X21hc2tdPXQuaGVhZFt0Lmluc19oXSx0LmhlYWRbdC5pbnNfaF09dC5zdHJzdGFydCksdC5wcmV2X2xlbmd0aD10Lm1hdGNoX2xlbmd0aCx0LnByZXZfbWF0Y2g9dC5tYXRjaF9zdGFydCx0Lm1hdGNoX2xlbmd0aD0yLDAhPT1uJiZ0LnByZXZfbGVuZ3RoPHQubWF4X2xhenlfbWF0Y2gmJnQuc3Ryc3RhcnQtbjw9dC53X3NpemUtaGQmJih0Lm1hdGNoX2xlbmd0aD1rZCh0LG4pLHQubWF0Y2hfbGVuZ3RoPD01JiYoMT09PXQuc3RyYXRlZ3l8fDM9PT10Lm1hdGNoX2xlbmd0aCYmdC5zdHJzdGFydC10Lm1hdGNoX3N0YXJ0PjQwOTYpJiYodC5tYXRjaF9sZW5ndGg9MikpLHQucHJldl9sZW5ndGg+PTMmJnQubWF0Y2hfbGVuZ3RoPD10LnByZXZfbGVuZ3RoKXtpPXQuc3Ryc3RhcnQrdC5sb29rYWhlYWQtMyxyPW9kLl90cl90YWxseSh0LHQuc3Ryc3RhcnQtMS10LnByZXZfbWF0Y2gsdC5wcmV2X2xlbmd0aC0zKSx0Lmxvb2thaGVhZC09dC5wcmV2X2xlbmd0aC0xLHQucHJldl9sZW5ndGgtPTI7ZG97Kyt0LnN0cnN0YXJ0PD1pJiYodC5pbnNfaD0odC5pbnNfaDw8dC5oYXNoX3NoaWZ0XnQud2luZG93W3Quc3Ryc3RhcnQrMy0xXSkmdC5oYXNoX21hc2ssbj10LnByZXZbdC5zdHJzdGFydCZ0LndfbWFza109dC5oZWFkW3QuaW5zX2hdLHQuaGVhZFt0Lmluc19oXT10LnN0cnN0YXJ0KX13aGlsZSgwIT0tLXQucHJldl9sZW5ndGgpO2lmKHQubWF0Y2hfYXZhaWxhYmxlPTAsdC5tYXRjaF9sZW5ndGg9Mix0LnN0cnN0YXJ0KyssciYmKHZkKHQsITEpLDA9PT10LnN0cm0uYXZhaWxfb3V0KSlyZXR1cm4gMX1lbHNlIGlmKHQubWF0Y2hfYXZhaWxhYmxlKXtpZigocj1vZC5fdHJfdGFsbHkodCwwLHQud2luZG93W3Quc3Ryc3RhcnQtMV0pKSYmdmQodCwhMSksdC5zdHJzdGFydCsrLHQubG9va2FoZWFkLS0sMD09PXQuc3RybS5hdmFpbF9vdXQpcmV0dXJuIDF9ZWxzZSB0Lm1hdGNoX2F2YWlsYWJsZT0xLHQuc3Ryc3RhcnQrKyx0Lmxvb2thaGVhZC0tfXJldHVybiB0Lm1hdGNoX2F2YWlsYWJsZSYmKHI9b2QuX3RyX3RhbGx5KHQsMCx0LndpbmRvd1t0LnN0cnN0YXJ0LTFdKSx0Lm1hdGNoX2F2YWlsYWJsZT0wKSx0Lmluc2VydD10LnN0cnN0YXJ0PDI/dC5zdHJzdGFydDoyLDQ9PT1lPyh2ZCh0LCEwKSwwPT09dC5zdHJtLmF2YWlsX291dD8zOjQpOnQubGFzdF9saXQmJih2ZCh0LCExKSwwPT09dC5zdHJtLmF2YWlsX291dCk/MToyfWZ1bmN0aW9uIEFkKHQsZSxuLHIsaSl7dGhpcy5nb29kX2xlbmd0aD10LHRoaXMubWF4X2xhenk9ZSx0aGlzLm5pY2VfbGVuZ3RoPW4sdGhpcy5tYXhfY2hhaW49cix0aGlzLmZ1bmM9aX1mdW5jdGlvbiBUZCgpe3RoaXMuc3RybT1udWxsLHRoaXMuc3RhdHVzPTAsdGhpcy5wZW5kaW5nX2J1Zj1udWxsLHRoaXMucGVuZGluZ19idWZfc2l6ZT0wLHRoaXMucGVuZGluZ19vdXQ9MCx0aGlzLnBlbmRpbmc9MCx0aGlzLndyYXA9MCx0aGlzLmd6aGVhZD1udWxsLHRoaXMuZ3ppbmRleD0wLHRoaXMubWV0aG9kPTgsdGhpcy5sYXN0X2ZsdXNoPS0xLHRoaXMud19zaXplPTAsdGhpcy53X2JpdHM9MCx0aGlzLndfbWFzaz0wLHRoaXMud2luZG93PW51bGwsdGhpcy53aW5kb3dfc2l6ZT0wLHRoaXMucHJldj1udWxsLHRoaXMuaGVhZD1udWxsLHRoaXMuaW5zX2g9MCx0aGlzLmhhc2hfc2l6ZT0wLHRoaXMuaGFzaF9iaXRzPTAsdGhpcy5oYXNoX21hc2s9MCx0aGlzLmhhc2hfc2hpZnQ9MCx0aGlzLmJsb2NrX3N0YXJ0PTAsdGhpcy5tYXRjaF9sZW5ndGg9MCx0aGlzLnByZXZfbWF0Y2g9MCx0aGlzLm1hdGNoX2F2YWlsYWJsZT0wLHRoaXMuc3Ryc3RhcnQ9MCx0aGlzLm1hdGNoX3N0YXJ0PTAsdGhpcy5sb29rYWhlYWQ9MCx0aGlzLnByZXZfbGVuZ3RoPTAsdGhpcy5tYXhfY2hhaW5fbGVuZ3RoPTAsdGhpcy5tYXhfbGF6eV9tYXRjaD0wLHRoaXMubGV2ZWw9MCx0aGlzLnN0cmF0ZWd5PTAsdGhpcy5nb29kX21hdGNoPTAsdGhpcy5uaWNlX21hdGNoPTAsdGhpcy5keW5fbHRyZWU9bmV3IGlkLkJ1ZjE2KDExNDYpLHRoaXMuZHluX2R0cmVlPW5ldyBpZC5CdWYxNigxMjIpLHRoaXMuYmxfdHJlZT1uZXcgaWQuQnVmMTYoNzgpLG1kKHRoaXMuZHluX2x0cmVlKSxtZCh0aGlzLmR5bl9kdHJlZSksbWQodGhpcy5ibF90cmVlKSx0aGlzLmxfZGVzYz1udWxsLHRoaXMuZF9kZXNjPW51bGwsdGhpcy5ibF9kZXNjPW51bGwsdGhpcy5ibF9jb3VudD1uZXcgaWQuQnVmMTYoMTYpLHRoaXMuaGVhcD1uZXcgaWQuQnVmMTYoNTczKSxtZCh0aGlzLmhlYXApLHRoaXMuaGVhcF9sZW49MCx0aGlzLmhlYXBfbWF4PTAsdGhpcy5kZXB0aD1uZXcgaWQuQnVmMTYoNTczKSxtZCh0aGlzLmRlcHRoKSx0aGlzLmxfYnVmPTAsdGhpcy5saXRfYnVmc2l6ZT0wLHRoaXMubGFzdF9saXQ9MCx0aGlzLmRfYnVmPTAsdGhpcy5vcHRfbGVuPTAsdGhpcy5zdGF0aWNfbGVuPTAsdGhpcy5tYXRjaGVzPTAsdGhpcy5pbnNlcnQ9MCx0aGlzLmJpX2J1Zj0wLHRoaXMuYmlfdmFsaWQ9MH1mdW5jdGlvbiBFZCh0KXt2YXIgZTtyZXR1cm4gdCYmdC5zdGF0ZT8odC50b3RhbF9pbj10LnRvdGFsX291dD0wLHQuZGF0YV90eXBlPTIsKGU9dC5zdGF0ZSkucGVuZGluZz0wLGUucGVuZGluZ19vdXQ9MCxlLndyYXA8MCYmKGUud3JhcD0tZS53cmFwKSxlLnN0YXR1cz1lLndyYXA/NDI6ZGQsdC5hZGxlcj0yPT09ZS53cmFwPzA6MSxlLmxhc3RfZmx1c2g9MCxvZC5fdHJfaW5pdChlKSwwKTpwZCh0LGxkKX1mdW5jdGlvbiBMZCh0KXt2YXIgZSxuPUVkKHQpO3JldHVybiAwPT09biYmKChlPXQuc3RhdGUpLndpbmRvd19zaXplPTIqZS53X3NpemUsbWQoZS5oZWFkKSxlLm1heF9sYXp5X21hdGNoPWVkW2UubGV2ZWxdLm1heF9sYXp5LGUuZ29vZF9tYXRjaD1lZFtlLmxldmVsXS5nb29kX2xlbmd0aCxlLm5pY2VfbWF0Y2g9ZWRbZS5sZXZlbF0ubmljZV9sZW5ndGgsZS5tYXhfY2hhaW5fbGVuZ3RoPWVkW2UubGV2ZWxdLm1heF9jaGFpbixlLnN0cnN0YXJ0PTAsZS5ibG9ja19zdGFydD0wLGUubG9va2FoZWFkPTAsZS5pbnNlcnQ9MCxlLm1hdGNoX2xlbmd0aD1lLnByZXZfbGVuZ3RoPTIsZS5tYXRjaF9hdmFpbGFibGU9MCxlLmluc19oPTApLG59ZnVuY3Rpb24gemQodCxlLG4scixpLG8pe2lmKCF0KXJldHVybiBsZDt2YXIgYT0xO2lmKC0xPT09ZSYmKGU9NikscjwwPyhhPTAscj0tcik6cj4xNSYmKGE9MixyLT0xNiksaTwxfHxpPjl8fDghPT1ufHxyPDh8fHI+MTV8fGU8MHx8ZT45fHxvPDB8fG8+NClyZXR1cm4gcGQodCxsZCk7OD09PXImJihyPTkpO3ZhciBzPW5ldyBUZDtyZXR1cm4gdC5zdGF0ZT1zLHMuc3RybT10LHMud3JhcD1hLHMuZ3poZWFkPW51bGwscy53X2JpdHM9cixzLndfc2l6ZT0xPDxzLndfYml0cyxzLndfbWFzaz1zLndfc2l6ZS0xLHMuaGFzaF9iaXRzPWkrNyxzLmhhc2hfc2l6ZT0xPDxzLmhhc2hfYml0cyxzLmhhc2hfbWFzaz1zLmhhc2hfc2l6ZS0xLHMuaGFzaF9zaGlmdD1+figocy5oYXNoX2JpdHMrMy0xKS8zKSxzLndpbmRvdz1uZXcgaWQuQnVmOCgyKnMud19zaXplKSxzLmhlYWQ9bmV3IGlkLkJ1ZjE2KHMuaGFzaF9zaXplKSxzLnByZXY9bmV3IGlkLkJ1ZjE2KHMud19zaXplKSxzLmxpdF9idWZzaXplPTE8PGkrNixzLnBlbmRpbmdfYnVmX3NpemU9NCpzLmxpdF9idWZzaXplLHMucGVuZGluZ19idWY9bmV3IGlkLkJ1Zjgocy5wZW5kaW5nX2J1Zl9zaXplKSxzLmRfYnVmPTEqcy5saXRfYnVmc2l6ZSxzLmxfYnVmPTMqcy5saXRfYnVmc2l6ZSxzLmxldmVsPWUscy5zdHJhdGVneT1vLHMubWV0aG9kPW4sTGQodCl9ZWQ9W25ldyBBZCgwLDAsMCwwLChmdW5jdGlvbih0LGUpe3ZhciBuPTY1NTM1O2ZvcihuPnQucGVuZGluZ19idWZfc2l6ZS01JiYobj10LnBlbmRpbmdfYnVmX3NpemUtNSk7Oyl7aWYodC5sb29rYWhlYWQ8PTEpe2lmKFNkKHQpLDA9PT10Lmxvb2thaGVhZCYmMD09PWUpcmV0dXJuIDE7aWYoMD09PXQubG9va2FoZWFkKWJyZWFrfXQuc3Ryc3RhcnQrPXQubG9va2FoZWFkLHQubG9va2FoZWFkPTA7dmFyIHI9dC5ibG9ja19zdGFydCtuO2lmKCgwPT09dC5zdHJzdGFydHx8dC5zdHJzdGFydD49cikmJih0Lmxvb2thaGVhZD10LnN0cnN0YXJ0LXIsdC5zdHJzdGFydD1yLHZkKHQsITEpLDA9PT10LnN0cm0uYXZhaWxfb3V0KSlyZXR1cm4gMTtpZih0LnN0cnN0YXJ0LXQuYmxvY2tfc3RhcnQ+PXQud19zaXplLWhkJiYodmQodCwhMSksMD09PXQuc3RybS5hdmFpbF9vdXQpKXJldHVybiAxfXJldHVybiB0Lmluc2VydD0wLDQ9PT1lPyh2ZCh0LCEwKSwwPT09dC5zdHJtLmF2YWlsX291dD8zOjQpOih0LnN0cnN0YXJ0PnQuYmxvY2tfc3RhcnQmJih2ZCh0LCExKSx0LnN0cm0uYXZhaWxfb3V0KSwxKX0pKSxuZXcgQWQoNCw0LDgsNCxPZCksbmV3IEFkKDQsNSwxNiw4LE9kKSxuZXcgQWQoNCw2LDMyLDMyLE9kKSxuZXcgQWQoNCw0LDE2LDE2LHhkKSxuZXcgQWQoOCwxNiwzMiwzMix4ZCksbmV3IEFkKDgsMTYsMTI4LDEyOCx4ZCksbmV3IEFkKDgsMzIsMTI4LDI1Nix4ZCksbmV3IEFkKDMyLDEyOCwyNTgsMTAyNCx4ZCksbmV3IEFkKDMyLDI1OCwyNTgsNDA5Nix4ZCldLF9mLmRlZmxhdGVJbml0PWZ1bmN0aW9uKHQsZSl7cmV0dXJuIHpkKHQsZSw4LDE1LDgsMCl9LF9mLmRlZmxhdGVJbml0Mj16ZCxfZi5kZWZsYXRlUmVzZXQ9TGQsX2YuZGVmbGF0ZVJlc2V0S2VlcD1FZCxfZi5kZWZsYXRlU2V0SGVhZGVyPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIHQmJnQuc3RhdGU/MiE9PXQuc3RhdGUud3JhcD9sZDoodC5zdGF0ZS5nemhlYWQ9ZSwwKTpsZH0sX2YuZGVmbGF0ZT1mdW5jdGlvbih0LGUpe3ZhciBuLHIsaSxvO2lmKCF0fHwhdC5zdGF0ZXx8ZT41fHxlPDApcmV0dXJuIHQ/cGQodCxsZCk6bGQ7aWYocj10LnN0YXRlLCF0Lm91dHB1dHx8IXQuaW5wdXQmJjAhPT10LmF2YWlsX2lufHxyLnN0YXR1cz09PV9kJiY0IT09ZSlyZXR1cm4gcGQodCwwPT09dC5hdmFpbF9vdXQ/LTU6bGQpO2lmKHIuc3RybT10LG49ci5sYXN0X2ZsdXNoLHIubGFzdF9mbHVzaD1lLDQyPT09ci5zdGF0dXMpaWYoMj09PXIud3JhcCl0LmFkbGVyPTAsYmQociwzMSksYmQociwxMzkpLGJkKHIsOCksci5nemhlYWQ/KGJkKHIsKHIuZ3poZWFkLnRleHQ/MTowKSsoci5nemhlYWQuaGNyYz8yOjApKyhyLmd6aGVhZC5leHRyYT80OjApKyhyLmd6aGVhZC5uYW1lPzg6MCkrKHIuZ3poZWFkLmNvbW1lbnQ/MTY6MCkpLGJkKHIsMjU1JnIuZ3poZWFkLnRpbWUpLGJkKHIsci5nemhlYWQudGltZT4+OCYyNTUpLGJkKHIsci5nemhlYWQudGltZT4+MTYmMjU1KSxiZChyLHIuZ3poZWFkLnRpbWU+PjI0JjI1NSksYmQociw5PT09ci5sZXZlbD8yOnIuc3RyYXRlZ3k+PTJ8fHIubGV2ZWw8Mj80OjApLGJkKHIsMjU1JnIuZ3poZWFkLm9zKSxyLmd6aGVhZC5leHRyYSYmci5nemhlYWQuZXh0cmEubGVuZ3RoJiYoYmQociwyNTUmci5nemhlYWQuZXh0cmEubGVuZ3RoKSxiZChyLHIuZ3poZWFkLmV4dHJhLmxlbmd0aD4+OCYyNTUpKSxyLmd6aGVhZC5oY3JjJiYodC5hZGxlcj1zZCh0LmFkbGVyLHIucGVuZGluZ19idWYsci5wZW5kaW5nLDApKSxyLmd6aW5kZXg9MCxyLnN0YXR1cz02OSk6KGJkKHIsMCksYmQociwwKSxiZChyLDApLGJkKHIsMCksYmQociwwKSxiZChyLDk9PT1yLmxldmVsPzI6ci5zdHJhdGVneT49Mnx8ci5sZXZlbDwyPzQ6MCksYmQociwzKSxyLnN0YXR1cz1kZCk7ZWxzZXt2YXIgYT04KyhyLndfYml0cy04PDw0KTw8ODthfD0oci5zdHJhdGVneT49Mnx8ci5sZXZlbDwyPzA6ci5sZXZlbDw2PzE6Nj09PXIubGV2ZWw/MjozKTw8NiwwIT09ci5zdHJzdGFydCYmKGF8PTMyKSxhKz0zMS1hJTMxLHIuc3RhdHVzPWRkLHdkKHIsYSksMCE9PXIuc3Ryc3RhcnQmJih3ZChyLHQuYWRsZXI+Pj4xNiksd2Qociw2NTUzNSZ0LmFkbGVyKSksdC5hZGxlcj0xfWlmKDY5PT09ci5zdGF0dXMpaWYoci5nemhlYWQuZXh0cmEpe2ZvcihpPXIucGVuZGluZztyLmd6aW5kZXg8KDY1NTM1JnIuZ3poZWFkLmV4dHJhLmxlbmd0aCkmJihyLnBlbmRpbmchPT1yLnBlbmRpbmdfYnVmX3NpemV8fChyLmd6aGVhZC5oY3JjJiZyLnBlbmRpbmc+aSYmKHQuYWRsZXI9c2QodC5hZGxlcixyLnBlbmRpbmdfYnVmLHIucGVuZGluZy1pLGkpKSx5ZCh0KSxpPXIucGVuZGluZyxyLnBlbmRpbmchPT1yLnBlbmRpbmdfYnVmX3NpemUpKTspYmQociwyNTUmci5nemhlYWQuZXh0cmFbci5nemluZGV4XSksci5nemluZGV4Kys7ci5nemhlYWQuaGNyYyYmci5wZW5kaW5nPmkmJih0LmFkbGVyPXNkKHQuYWRsZXIsci5wZW5kaW5nX2J1ZixyLnBlbmRpbmctaSxpKSksci5nemluZGV4PT09ci5nemhlYWQuZXh0cmEubGVuZ3RoJiYoci5nemluZGV4PTAsci5zdGF0dXM9NzMpfWVsc2Ugci5zdGF0dXM9NzM7aWYoNzM9PT1yLnN0YXR1cylpZihyLmd6aGVhZC5uYW1lKXtpPXIucGVuZGluZztkb3tpZihyLnBlbmRpbmc9PT1yLnBlbmRpbmdfYnVmX3NpemUmJihyLmd6aGVhZC5oY3JjJiZyLnBlbmRpbmc+aSYmKHQuYWRsZXI9c2QodC5hZGxlcixyLnBlbmRpbmdfYnVmLHIucGVuZGluZy1pLGkpKSx5ZCh0KSxpPXIucGVuZGluZyxyLnBlbmRpbmc9PT1yLnBlbmRpbmdfYnVmX3NpemUpKXtvPTE7YnJlYWt9bz1yLmd6aW5kZXg8ci5nemhlYWQubmFtZS5sZW5ndGg/MjU1JnIuZ3poZWFkLm5hbWUuY2hhckNvZGVBdChyLmd6aW5kZXgrKyk6MCxiZChyLG8pfXdoaWxlKDAhPT1vKTtyLmd6aGVhZC5oY3JjJiZyLnBlbmRpbmc+aSYmKHQuYWRsZXI9c2QodC5hZGxlcixyLnBlbmRpbmdfYnVmLHIucGVuZGluZy1pLGkpKSwwPT09byYmKHIuZ3ppbmRleD0wLHIuc3RhdHVzPTkxKX1lbHNlIHIuc3RhdHVzPTkxO2lmKDkxPT09ci5zdGF0dXMpaWYoci5nemhlYWQuY29tbWVudCl7aT1yLnBlbmRpbmc7ZG97aWYoci5wZW5kaW5nPT09ci5wZW5kaW5nX2J1Zl9zaXplJiYoci5nemhlYWQuaGNyYyYmci5wZW5kaW5nPmkmJih0LmFkbGVyPXNkKHQuYWRsZXIsci5wZW5kaW5nX2J1ZixyLnBlbmRpbmctaSxpKSkseWQodCksaT1yLnBlbmRpbmcsci5wZW5kaW5nPT09ci5wZW5kaW5nX2J1Zl9zaXplKSl7bz0xO2JyZWFrfW89ci5nemluZGV4PHIuZ3poZWFkLmNvbW1lbnQubGVuZ3RoPzI1NSZyLmd6aGVhZC5jb21tZW50LmNoYXJDb2RlQXQoci5nemluZGV4KyspOjAsYmQocixvKX13aGlsZSgwIT09byk7ci5nemhlYWQuaGNyYyYmci5wZW5kaW5nPmkmJih0LmFkbGVyPXNkKHQuYWRsZXIsci5wZW5kaW5nX2J1ZixyLnBlbmRpbmctaSxpKSksMD09PW8mJihyLnN0YXR1cz1mZCl9ZWxzZSByLnN0YXR1cz1mZDtpZihyLnN0YXR1cz09PWZkJiYoci5nemhlYWQuaGNyYz8oci5wZW5kaW5nKzI+ci5wZW5kaW5nX2J1Zl9zaXplJiZ5ZCh0KSxyLnBlbmRpbmcrMjw9ci5wZW5kaW5nX2J1Zl9zaXplJiYoYmQociwyNTUmdC5hZGxlciksYmQocix0LmFkbGVyPj44JjI1NSksdC5hZGxlcj0wLHIuc3RhdHVzPWRkKSk6ci5zdGF0dXM9ZGQpLDAhPT1yLnBlbmRpbmcpe2lmKHlkKHQpLDA9PT10LmF2YWlsX291dClyZXR1cm4gci5sYXN0X2ZsdXNoPS0xLDB9ZWxzZSBpZigwPT09dC5hdmFpbF9pbiYmZ2QoZSk8PWdkKG4pJiY0IT09ZSlyZXR1cm4gcGQodCwtNSk7aWYoci5zdGF0dXM9PT1fZCYmMCE9PXQuYXZhaWxfaW4pcmV0dXJuIHBkKHQsLTUpO2lmKDAhPT10LmF2YWlsX2lufHwwIT09ci5sb29rYWhlYWR8fDAhPT1lJiZyLnN0YXR1cyE9PV9kKXt2YXIgcz0yPT09ci5zdHJhdGVneT9mdW5jdGlvbih0LGUpe2Zvcih2YXIgbjs7KXtpZigwPT09dC5sb29rYWhlYWQmJihTZCh0KSwwPT09dC5sb29rYWhlYWQpKXtpZigwPT09ZSlyZXR1cm4gMTticmVha31pZih0Lm1hdGNoX2xlbmd0aD0wLG49b2QuX3RyX3RhbGx5KHQsMCx0LndpbmRvd1t0LnN0cnN0YXJ0XSksdC5sb29rYWhlYWQtLSx0LnN0cnN0YXJ0KyssbiYmKHZkKHQsITEpLDA9PT10LnN0cm0uYXZhaWxfb3V0KSlyZXR1cm4gMX1yZXR1cm4gdC5pbnNlcnQ9MCw0PT09ZT8odmQodCwhMCksMD09PXQuc3RybS5hdmFpbF9vdXQ/Mzo0KTp0Lmxhc3RfbGl0JiYodmQodCwhMSksMD09PXQuc3RybS5hdmFpbF9vdXQpPzE6Mn0ocixlKTozPT09ci5zdHJhdGVneT9mdW5jdGlvbih0LGUpe2Zvcih2YXIgbixyLGksbyxhPXQud2luZG93Ozspe2lmKHQubG9va2FoZWFkPD11ZCl7aWYoU2QodCksdC5sb29rYWhlYWQ8PXVkJiYwPT09ZSlyZXR1cm4gMTtpZigwPT09dC5sb29rYWhlYWQpYnJlYWt9aWYodC5tYXRjaF9sZW5ndGg9MCx0Lmxvb2thaGVhZD49MyYmdC5zdHJzdGFydD4wJiYocj1hW2k9dC5zdHJzdGFydC0xXSk9PT1hWysraV0mJnI9PT1hWysraV0mJnI9PT1hWysraV0pe289dC5zdHJzdGFydCt1ZDtkb3t9d2hpbGUocj09PWFbKytpXSYmcj09PWFbKytpXSYmcj09PWFbKytpXSYmcj09PWFbKytpXSYmcj09PWFbKytpXSYmcj09PWFbKytpXSYmcj09PWFbKytpXSYmcj09PWFbKytpXSYmaTxvKTt0Lm1hdGNoX2xlbmd0aD11ZC0oby1pKSx0Lm1hdGNoX2xlbmd0aD50Lmxvb2thaGVhZCYmKHQubWF0Y2hfbGVuZ3RoPXQubG9va2FoZWFkKX1pZih0Lm1hdGNoX2xlbmd0aD49Mz8obj1vZC5fdHJfdGFsbHkodCwxLHQubWF0Y2hfbGVuZ3RoLTMpLHQubG9va2FoZWFkLT10Lm1hdGNoX2xlbmd0aCx0LnN0cnN0YXJ0Kz10Lm1hdGNoX2xlbmd0aCx0Lm1hdGNoX2xlbmd0aD0wKToobj1vZC5fdHJfdGFsbHkodCwwLHQud2luZG93W3Quc3Ryc3RhcnRdKSx0Lmxvb2thaGVhZC0tLHQuc3Ryc3RhcnQrKyksbiYmKHZkKHQsITEpLDA9PT10LnN0cm0uYXZhaWxfb3V0KSlyZXR1cm4gMX1yZXR1cm4gdC5pbnNlcnQ9MCw0PT09ZT8odmQodCwhMCksMD09PXQuc3RybS5hdmFpbF9vdXQ/Mzo0KTp0Lmxhc3RfbGl0JiYodmQodCwhMSksMD09PXQuc3RybS5hdmFpbF9vdXQpPzE6Mn0ocixlKTplZFtyLmxldmVsXS5mdW5jKHIsZSk7aWYoMyE9PXMmJjQhPT1zfHwoci5zdGF0dXM9X2QpLDE9PT1zfHwzPT09cylyZXR1cm4gMD09PXQuYXZhaWxfb3V0JiYoci5sYXN0X2ZsdXNoPS0xKSwwO2lmKDI9PT1zJiYoMT09PWU/b2QuX3RyX2FsaWduKHIpOjUhPT1lJiYob2QuX3RyX3N0b3JlZF9ibG9jayhyLDAsMCwhMSksMz09PWUmJihtZChyLmhlYWQpLDA9PT1yLmxvb2thaGVhZCYmKHIuc3Ryc3RhcnQ9MCxyLmJsb2NrX3N0YXJ0PTAsci5pbnNlcnQ9MCkpKSx5ZCh0KSwwPT09dC5hdmFpbF9vdXQpKXJldHVybiByLmxhc3RfZmx1c2g9LTEsMH1yZXR1cm4gNCE9PWU/MDpyLndyYXA8PTA/MTooMj09PXIud3JhcD8oYmQociwyNTUmdC5hZGxlciksYmQocix0LmFkbGVyPj44JjI1NSksYmQocix0LmFkbGVyPj4xNiYyNTUpLGJkKHIsdC5hZGxlcj4+MjQmMjU1KSxiZChyLDI1NSZ0LnRvdGFsX2luKSxiZChyLHQudG90YWxfaW4+PjgmMjU1KSxiZChyLHQudG90YWxfaW4+PjE2JjI1NSksYmQocix0LnRvdGFsX2luPj4yNCYyNTUpKTood2Qocix0LmFkbGVyPj4+MTYpLHdkKHIsNjU1MzUmdC5hZGxlcikpLHlkKHQpLHIud3JhcD4wJiYoci53cmFwPS1yLndyYXApLDAhPT1yLnBlbmRpbmc/MDoxKX0sX2YuZGVmbGF0ZUVuZD1mdW5jdGlvbih0KXt2YXIgZTtyZXR1cm4gdCYmdC5zdGF0ZT80MiE9PShlPXQuc3RhdGUuc3RhdHVzKSYmNjkhPT1lJiY3MyE9PWUmJjkxIT09ZSYmZSE9PWZkJiZlIT09ZGQmJmUhPT1fZD9wZCh0LGxkKToodC5zdGF0ZT1udWxsLGU9PT1kZD9wZCh0LC0zKTowKTpsZH0sX2YuZGVmbGF0ZVNldERpY3Rpb25hcnk9ZnVuY3Rpb24odCxlKXt2YXIgbixyLGksbyxhLHMsYyxsLHU9ZS5sZW5ndGg7aWYoIXR8fCF0LnN0YXRlKXJldHVybiBsZDtpZigyPT09KG89KG49dC5zdGF0ZSkud3JhcCl8fDE9PT1vJiY0MiE9PW4uc3RhdHVzfHxuLmxvb2thaGVhZClyZXR1cm4gbGQ7Zm9yKDE9PT1vJiYodC5hZGxlcj1hZCh0LmFkbGVyLGUsdSwwKSksbi53cmFwPTAsdT49bi53X3NpemUmJigwPT09byYmKG1kKG4uaGVhZCksbi5zdHJzdGFydD0wLG4uYmxvY2tfc3RhcnQ9MCxuLmluc2VydD0wKSxsPW5ldyBpZC5CdWY4KG4ud19zaXplKSxpZC5hcnJheVNldChsLGUsdS1uLndfc2l6ZSxuLndfc2l6ZSwwKSxlPWwsdT1uLndfc2l6ZSksYT10LmF2YWlsX2luLHM9dC5uZXh0X2luLGM9dC5pbnB1dCx0LmF2YWlsX2luPXUsdC5uZXh0X2luPTAsdC5pbnB1dD1lLFNkKG4pO24ubG9va2FoZWFkPj0zOyl7cj1uLnN0cnN0YXJ0LGk9bi5sb29rYWhlYWQtMjtkb3tuLmluc19oPShuLmluc19oPDxuLmhhc2hfc2hpZnRebi53aW5kb3dbciszLTFdKSZuLmhhc2hfbWFzayxuLnByZXZbciZuLndfbWFza109bi5oZWFkW24uaW5zX2hdLG4uaGVhZFtuLmluc19oXT1yLHIrK313aGlsZSgtLWkpO24uc3Ryc3RhcnQ9cixuLmxvb2thaGVhZD0yLFNkKG4pfXJldHVybiBuLnN0cnN0YXJ0Kz1uLmxvb2thaGVhZCxuLmJsb2NrX3N0YXJ0PW4uc3Ryc3RhcnQsbi5pbnNlcnQ9bi5sb29rYWhlYWQsbi5sb29rYWhlYWQ9MCxuLm1hdGNoX2xlbmd0aD1uLnByZXZfbGVuZ3RoPTIsbi5tYXRjaF9hdmFpbGFibGU9MCx0Lm5leHRfaW49cyx0LmlucHV0PWMsdC5hdmFpbF9pbj1hLG4ud3JhcD1vLDB9LF9mLmRlZmxhdGVJbmZvPSJwYWtvIGRlZmxhdGUgKGZyb20gTm9kZWNhIHByb2plY3QpIjt2YXIgQmQ9e30sSWQ9ZmYsQ2Q9ITAsTmQ9ITA7dHJ5e1N0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCxbMF0pfWNhdGNoKG5nKXtDZD0hMX10cnl7U3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLG5ldyBVaW50OEFycmF5KDEpKX1jYXRjaChuZyl7TmQ9ITF9Zm9yKHZhciBSZD1uZXcgSWQuQnVmOCgyNTYpLGpkPTA7amQ8MjU2O2pkKyspUmRbamRdPWpkPj0yNTI/NjpqZD49MjQ4PzU6amQ+PTI0MD80OmpkPj0yMjQ/MzpqZD49MTkyPzI6MTtmdW5jdGlvbiBEZCh0LGUpe2lmKGU8NjU1MzQmJih0LnN1YmFycmF5JiZOZHx8IXQuc3ViYXJyYXkmJkNkKSlyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLElkLnNocmlua0J1Zih0LGUpKTtmb3IodmFyIG49IiIscj0wO3I8ZTtyKyspbis9U3RyaW5nLmZyb21DaGFyQ29kZSh0W3JdKTtyZXR1cm4gbn1SZFsyNTRdPVJkWzI1NF09MSxCZC5zdHJpbmcyYnVmPWZ1bmN0aW9uKHQpe3ZhciBlLG4scixpLG8sYT10Lmxlbmd0aCxzPTA7Zm9yKGk9MDtpPGE7aSsrKTU1Mjk2PT0oNjQ1MTImKG49dC5jaGFyQ29kZUF0KGkpKSkmJmkrMTxhJiY1NjMyMD09KDY0NTEyJihyPXQuY2hhckNvZGVBdChpKzEpKSkmJihuPTY1NTM2KyhuLTU1Mjk2PDwxMCkrKHItNTYzMjApLGkrKykscys9bjwxMjg/MTpuPDIwNDg/MjpuPDY1NTM2PzM6NDtmb3IoZT1uZXcgSWQuQnVmOChzKSxvPTAsaT0wO288cztpKyspNTUyOTY9PSg2NDUxMiYobj10LmNoYXJDb2RlQXQoaSkpKSYmaSsxPGEmJjU2MzIwPT0oNjQ1MTImKHI9dC5jaGFyQ29kZUF0KGkrMSkpKSYmKG49NjU1MzYrKG4tNTUyOTY8PDEwKSsoci01NjMyMCksaSsrKSxuPDEyOD9lW28rK109bjpuPDIwNDg/KGVbbysrXT0xOTJ8bj4+PjYsZVtvKytdPTEyOHw2MyZuKTpuPDY1NTM2PyhlW28rK109MjI0fG4+Pj4xMixlW28rK109MTI4fG4+Pj42JjYzLGVbbysrXT0xMjh8NjMmbik6KGVbbysrXT0yNDB8bj4+PjE4LGVbbysrXT0xMjh8bj4+PjEyJjYzLGVbbysrXT0xMjh8bj4+PjYmNjMsZVtvKytdPTEyOHw2MyZuKTtyZXR1cm4gZX0sQmQuYnVmMmJpbnN0cmluZz1mdW5jdGlvbih0KXtyZXR1cm4gRGQodCx0Lmxlbmd0aCl9LEJkLmJpbnN0cmluZzJidWY9ZnVuY3Rpb24odCl7Zm9yKHZhciBlPW5ldyBJZC5CdWY4KHQubGVuZ3RoKSxuPTAscj1lLmxlbmd0aDtuPHI7bisrKWVbbl09dC5jaGFyQ29kZUF0KG4pO3JldHVybiBlfSxCZC5idWYyc3RyaW5nPWZ1bmN0aW9uKHQsZSl7dmFyIG4scixpLG8sYT1lfHx0Lmxlbmd0aCxzPW5ldyBBcnJheSgyKmEpO2ZvcihyPTAsbj0wO248YTspaWYoKGk9dFtuKytdKTwxMjgpc1tyKytdPWk7ZWxzZSBpZigobz1SZFtpXSk+NClzW3IrK109NjU1MzMsbis9by0xO2Vsc2V7Zm9yKGkmPTI9PT1vPzMxOjM9PT1vPzE1Ojc7bz4xJiZuPGE7KWk9aTw8Nnw2MyZ0W24rK10sby0tO28+MT9zW3IrK109NjU1MzM6aTw2NTUzNj9zW3IrK109aTooaS09NjU1MzYsc1tyKytdPTU1Mjk2fGk+PjEwJjEwMjMsc1tyKytdPTU2MzIwfDEwMjMmaSl9cmV0dXJuIERkKHMscil9LEJkLnV0Zjhib3JkZXI9ZnVuY3Rpb24odCxlKXt2YXIgbjtmb3IoKGU9ZXx8dC5sZW5ndGgpPnQubGVuZ3RoJiYoZT10Lmxlbmd0aCksbj1lLTE7bj49MCYmMTI4PT0oMTkyJnRbbl0pOyluLS07cmV0dXJuIG48MHx8MD09PW4/ZTpuK1JkW3Rbbl1dPmU/bjplfTt2YXIgUGQ9ZnVuY3Rpb24oKXt0aGlzLmlucHV0PW51bGwsdGhpcy5uZXh0X2luPTAsdGhpcy5hdmFpbF9pbj0wLHRoaXMudG90YWxfaW49MCx0aGlzLm91dHB1dD1udWxsLHRoaXMubmV4dF9vdXQ9MCx0aGlzLmF2YWlsX291dD0wLHRoaXMudG90YWxfb3V0PTAsdGhpcy5tc2c9IiIsdGhpcy5zdGF0ZT1udWxsLHRoaXMuZGF0YV90eXBlPTIsdGhpcy5hZGxlcj0wfSxVZD1fZixGZD1mZixNZD1CZCxaZD1yZCxKZD1QZCxIZD1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nO2Z1bmN0aW9uIFdkKHQpe2lmKCEodGhpcyBpbnN0YW5jZW9mIFdkKSlyZXR1cm4gbmV3IFdkKHQpO3RoaXMub3B0aW9ucz1GZC5hc3NpZ24oe2xldmVsOi0xLG1ldGhvZDo4LGNodW5rU2l6ZToxNjM4NCx3aW5kb3dCaXRzOjE1LG1lbUxldmVsOjgsc3RyYXRlZ3k6MCx0bzoiIn0sdHx8e30pO3ZhciBlPXRoaXMub3B0aW9ucztlLnJhdyYmZS53aW5kb3dCaXRzPjA/ZS53aW5kb3dCaXRzPS1lLndpbmRvd0JpdHM6ZS5nemlwJiZlLndpbmRvd0JpdHM+MCYmZS53aW5kb3dCaXRzPDE2JiYoZS53aW5kb3dCaXRzKz0xNiksdGhpcy5lcnI9MCx0aGlzLm1zZz0iIix0aGlzLmVuZGVkPSExLHRoaXMuY2h1bmtzPVtdLHRoaXMuc3RybT1uZXcgSmQsdGhpcy5zdHJtLmF2YWlsX291dD0wO3ZhciBuPVVkLmRlZmxhdGVJbml0Mih0aGlzLnN0cm0sZS5sZXZlbCxlLm1ldGhvZCxlLndpbmRvd0JpdHMsZS5tZW1MZXZlbCxlLnN0cmF0ZWd5KTtpZigwIT09bil0aHJvdyBuZXcgRXJyb3IoWmRbbl0pO2lmKGUuaGVhZGVyJiZVZC5kZWZsYXRlU2V0SGVhZGVyKHRoaXMuc3RybSxlLmhlYWRlciksZS5kaWN0aW9uYXJ5KXt2YXIgcjtpZihyPSJzdHJpbmciPT10eXBlb2YgZS5kaWN0aW9uYXJ5P01kLnN0cmluZzJidWYoZS5kaWN0aW9uYXJ5KToiW29iamVjdCBBcnJheUJ1ZmZlcl0iPT09SGQuY2FsbChlLmRpY3Rpb25hcnkpP25ldyBVaW50OEFycmF5KGUuZGljdGlvbmFyeSk6ZS5kaWN0aW9uYXJ5LDAhPT0obj1VZC5kZWZsYXRlU2V0RGljdGlvbmFyeSh0aGlzLnN0cm0scikpKXRocm93IG5ldyBFcnJvcihaZFtuXSk7dGhpcy5fZGljdF9zZXQ9ITB9fWZ1bmN0aW9uIEtkKHQsZSl7dmFyIG49bmV3IFdkKGUpO2lmKG4ucHVzaCh0LCEwKSxuLmVycil0aHJvdyBuLm1zZ3x8WmRbbi5lcnJdO3JldHVybiBuLnJlc3VsdH1XZC5wcm90b3R5cGUucHVzaD1mdW5jdGlvbih0LGUpe3ZhciBuLHIsaT10aGlzLnN0cm0sbz10aGlzLm9wdGlvbnMuY2h1bmtTaXplO2lmKHRoaXMuZW5kZWQpcmV0dXJuITE7cj1lPT09fn5lP2U6ITA9PT1lPzQ6MCwic3RyaW5nIj09dHlwZW9mIHQ/aS5pbnB1dD1NZC5zdHJpbmcyYnVmKHQpOiJbb2JqZWN0IEFycmF5QnVmZmVyXSI9PT1IZC5jYWxsKHQpP2kuaW5wdXQ9bmV3IFVpbnQ4QXJyYXkodCk6aS5pbnB1dD10LGkubmV4dF9pbj0wLGkuYXZhaWxfaW49aS5pbnB1dC5sZW5ndGg7ZG97aWYoMD09PWkuYXZhaWxfb3V0JiYoaS5vdXRwdXQ9bmV3IEZkLkJ1ZjgobyksaS5uZXh0X291dD0wLGkuYXZhaWxfb3V0PW8pLDEhPT0obj1VZC5kZWZsYXRlKGkscikpJiYwIT09bilyZXR1cm4gdGhpcy5vbkVuZChuKSx0aGlzLmVuZGVkPSEwLCExOzAhPT1pLmF2YWlsX291dCYmKDAhPT1pLmF2YWlsX2lufHw0IT09ciYmMiE9PXIpfHwoInN0cmluZyI9PT10aGlzLm9wdGlvbnMudG8/dGhpcy5vbkRhdGEoTWQuYnVmMmJpbnN0cmluZyhGZC5zaHJpbmtCdWYoaS5vdXRwdXQsaS5uZXh0X291dCkpKTp0aGlzLm9uRGF0YShGZC5zaHJpbmtCdWYoaS5vdXRwdXQsaS5uZXh0X291dCkpKX13aGlsZSgoaS5hdmFpbF9pbj4wfHwwPT09aS5hdmFpbF9vdXQpJiYxIT09bik7cmV0dXJuIDQ9PT1yPyhuPVVkLmRlZmxhdGVFbmQodGhpcy5zdHJtKSx0aGlzLm9uRW5kKG4pLHRoaXMuZW5kZWQ9ITAsMD09PW4pOjIhPT1yfHwodGhpcy5vbkVuZCgwKSxpLmF2YWlsX291dD0wLCEwKX0sV2QucHJvdG90eXBlLm9uRGF0YT1mdW5jdGlvbih0KXt0aGlzLmNodW5rcy5wdXNoKHQpfSxXZC5wcm90b3R5cGUub25FbmQ9ZnVuY3Rpb24odCl7MD09PXQmJigic3RyaW5nIj09PXRoaXMub3B0aW9ucy50bz90aGlzLnJlc3VsdD10aGlzLmNodW5rcy5qb2luKCIiKTp0aGlzLnJlc3VsdD1GZC5mbGF0dGVuQ2h1bmtzKHRoaXMuY2h1bmtzKSksdGhpcy5jaHVua3M9W10sdGhpcy5lcnI9dCx0aGlzLm1zZz10aGlzLnN0cm0ubXNnfSxkZi5EZWZsYXRlPVdkLGRmLmRlZmxhdGU9S2QsZGYuZGVmbGF0ZVJhdz1mdW5jdGlvbih0LGUpe3JldHVybihlPWV8fHt9KS5yYXc9ITAsS2QodCxlKX0sZGYuZ3ppcD1mdW5jdGlvbih0LGUpe3JldHVybihlPWV8fHt9KS5nemlwPSEwLEtkKHQsZSl9O3ZhciBHZD17fSxWZD1ubixZZD1CLFhkPSR0LHFkPW90LCRkPWZ1bmN0aW9uKCl7dmFyIHQ9VmQodGhpcyksZT0iIjtyZXR1cm4gdC5oYXNJbmRpY2VzJiYoZSs9ImQiKSx0Lmdsb2JhbCYmKGUrPSJnIiksdC5pZ25vcmVDYXNlJiYoZSs9ImkiKSx0Lm11bHRpbGluZSYmKGUrPSJtIiksdC5kb3RBbGwmJihlKz0icyIpLHQudW5pY29kZSYmKGUrPSJ1IiksdC51bmljb2RlU2V0cyYmKGUrPSJ2IiksdC5zdGlja3kmJihlKz0ieSIpLGV9LFFkPVJlZ0V4cC5wcm90b3R5cGUsdF89b3QsZV89ZnVuY3Rpb24odCl7dmFyIGU9dC5mbGFncztyZXR1cm4gdm9pZCAwIT09ZXx8ImZsYWdzImluIFFkfHxYZCh0LCJmbGFncyIpfHwhcWQoUWQsdCk/ZTpZZCgkZCx0KX0sbl89UmVnRXhwLnByb3RvdHlwZSxyXz1uKChmdW5jdGlvbih0KXtyZXR1cm4gdD09PW5ffHx0XyhuXyx0KT9lXyh0KTp0LmZsYWdzfSkpLGlfPXt9LG9fPWZmLGFfPTE1LHNfPVszLDQsNSw2LDcsOCw5LDEwLDExLDEzLDE1LDE3LDE5LDIzLDI3LDMxLDM1LDQzLDUxLDU5LDY3LDgzLDk5LDExNSwxMzEsMTYzLDE5NSwyMjcsMjU4LDAsMF0sY189WzE2LDE2LDE2LDE2LDE2LDE2LDE2LDE2LDE3LDE3LDE3LDE3LDE4LDE4LDE4LDE4LDE5LDE5LDE5LDE5LDIwLDIwLDIwLDIwLDIxLDIxLDIxLDIxLDE2LDcyLDc4XSxsXz1bMSwyLDMsNCw1LDcsOSwxMywxNywyNSwzMyw0OSw2NSw5NywxMjksMTkzLDI1NywzODUsNTEzLDc2OSwxMDI1LDE1MzcsMjA0OSwzMDczLDQwOTcsNjE0NSw4MTkzLDEyMjg5LDE2Mzg1LDI0NTc3LDAsMF0sdV89WzE2LDE2LDE2LDE2LDE3LDE3LDE4LDE4LDE5LDE5LDIwLDIwLDIxLDIxLDIyLDIyLDIzLDIzLDI0LDI0LDI1LDI1LDI2LDI2LDI3LDI3LDI4LDI4LDI5LDI5LDY0LDY0XSxoXz1mZixmXz1RZixkXz1uZCxfXz1mdW5jdGlvbih0LGUpe3ZhciBuLHIsaSxvLGEscyxjLGwsdSxoLGYsZCxfLHAsZyxtLHksdixiLHcsayxTLE8seCxBO249dC5zdGF0ZSxyPXQubmV4dF9pbix4PXQuaW5wdXQsaT1yKyh0LmF2YWlsX2luLTUpLG89dC5uZXh0X291dCxBPXQub3V0cHV0LGE9by0oZS10LmF2YWlsX291dCkscz1vKyh0LmF2YWlsX291dC0yNTcpLGM9bi5kbWF4LGw9bi53c2l6ZSx1PW4ud2hhdmUsaD1uLnduZXh0LGY9bi53aW5kb3csZD1uLmhvbGQsXz1uLmJpdHMscD1uLmxlbmNvZGUsZz1uLmRpc3Rjb2RlLG09KDE8PG4ubGVuYml0cyktMSx5PSgxPDxuLmRpc3RiaXRzKS0xO3Q6ZG97XzwxNSYmKGQrPXhbcisrXTw8XyxfKz04LGQrPXhbcisrXTw8XyxfKz04KSx2PXBbZCZtXTtlOmZvcig7Oyl7aWYoZD4+Pj1iPXY+Pj4yNCxfLT1iLDA9PT0oYj12Pj4+MTYmMjU1KSlBW28rK109NjU1MzUmdjtlbHNle2lmKCEoMTYmYikpe2lmKDY0JmIpe2lmKDMyJmIpe24ubW9kZT0xMjticmVhayB0fXQubXNnPSJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RoIGNvZGUiLG4ubW9kZT0zMDticmVhayB0fXY9cFsoNjU1MzUmdikrKGQmKDE8PGIpLTEpXTtjb250aW51ZSBlfWZvcih3PTY1NTM1JnYsKGImPTE1KSYmKF88YiYmKGQrPXhbcisrXTw8XyxfKz04KSx3Kz1kJigxPDxiKS0xLGQ+Pj49YixfLT1iKSxfPDE1JiYoZCs9eFtyKytdPDxfLF8rPTgsZCs9eFtyKytdPDxfLF8rPTgpLHY9Z1tkJnldOzspe2lmKGQ+Pj49Yj12Pj4+MjQsXy09YiwxNiYoYj12Pj4+MTYmMjU1KSl7aWYoaz02NTUzNSZ2LF88KGImPTE1KSYmKGQrPXhbcisrXTw8XywoXys9OCk8YiYmKGQrPXhbcisrXTw8XyxfKz04KSksKGsrPWQmKDE8PGIpLTEpPmMpe3QubXNnPSJpbnZhbGlkIGRpc3RhbmNlIHRvbyBmYXIgYmFjayIsbi5tb2RlPTMwO2JyZWFrIHR9aWYoZD4+Pj1iLF8tPWIsaz4oYj1vLWEpKXtpZigoYj1rLWIpPnUmJm4uc2FuZSl7dC5tc2c9ImludmFsaWQgZGlzdGFuY2UgdG9vIGZhciBiYWNrIixuLm1vZGU9MzA7YnJlYWsgdH1pZihTPTAsTz1mLDA9PT1oKXtpZihTKz1sLWIsYjx3KXt3LT1iO2Rve0FbbysrXT1mW1MrK119d2hpbGUoLS1iKTtTPW8tayxPPUF9fWVsc2UgaWYoaDxiKXtpZihTKz1sK2gtYiwoYi09aCk8dyl7dy09Yjtkb3tBW28rK109ZltTKytdfXdoaWxlKC0tYik7aWYoUz0wLGg8dyl7dy09Yj1oO2Rve0FbbysrXT1mW1MrK119d2hpbGUoLS1iKTtTPW8tayxPPUF9fX1lbHNlIGlmKFMrPWgtYixiPHcpe3ctPWI7ZG97QVtvKytdPWZbUysrXX13aGlsZSgtLWIpO1M9by1rLE89QX1mb3IoO3c+MjspQVtvKytdPU9bUysrXSxBW28rK109T1tTKytdLEFbbysrXT1PW1MrK10sdy09Mzt3JiYoQVtvKytdPU9bUysrXSx3PjEmJihBW28rK109T1tTKytdKSl9ZWxzZXtTPW8taztkb3tBW28rK109QVtTKytdLEFbbysrXT1BW1MrK10sQVtvKytdPUFbUysrXSx3LT0zfXdoaWxlKHc+Mik7dyYmKEFbbysrXT1BW1MrK10sdz4xJiYoQVtvKytdPUFbUysrXSkpfWJyZWFrfWlmKDY0JmIpe3QubXNnPSJpbnZhbGlkIGRpc3RhbmNlIGNvZGUiLG4ubW9kZT0zMDticmVhayB0fXY9Z1soNjU1MzUmdikrKGQmKDE8PGIpLTEpXX19YnJlYWt9fXdoaWxlKHI8aSYmbzxzKTtyLT13PV8+PjMsZCY9KDE8PChfLT13PDwzKSktMSx0Lm5leHRfaW49cix0Lm5leHRfb3V0PW8sdC5hdmFpbF9pbj1yPGk/aS1yKzU6NS0oci1pKSx0LmF2YWlsX291dD1vPHM/cy1vKzI1NzoyNTctKG8tcyksbi5ob2xkPWQsbi5iaXRzPV99LHBfPWZ1bmN0aW9uKHQsZSxuLHIsaSxvLGEscyl7dmFyIGMsbCx1LGgsZixkLF8scCxnLG09cy5iaXRzLHk9MCx2PTAsYj0wLHc9MCxrPTAsUz0wLE89MCx4PTAsQT0wLFQ9MCxFPW51bGwsTD0wLHo9bmV3IG9fLkJ1ZjE2KDE2KSxCPW5ldyBvXy5CdWYxNigxNiksST1udWxsLEM9MDtmb3IoeT0wO3k8PWFfO3krKyl6W3ldPTA7Zm9yKHY9MDt2PHI7disrKXpbZVtuK3ZdXSsrO2ZvcihrPW0sdz1hXzt3Pj0xJiYwPT09elt3XTt3LS0pO2lmKGs+dyYmKGs9dyksMD09PXcpcmV0dXJuIGlbbysrXT0yMDk3MTUyMCxpW28rK109MjA5NzE1MjAscy5iaXRzPTEsMDtmb3IoYj0xO2I8dyYmMD09PXpbYl07YisrKTtmb3IoazxiJiYoaz1iKSx4PTEseT0xO3k8PWFfO3krKylpZih4PDw9MSwoeC09elt5XSk8MClyZXR1cm4tMTtpZih4PjAmJigwPT09dHx8MSE9PXcpKXJldHVybi0xO2ZvcihCWzFdPTAseT0xO3k8YV87eSsrKUJbeSsxXT1CW3ldK3pbeV07Zm9yKHY9MDt2PHI7disrKTAhPT1lW24rdl0mJihhW0JbZVtuK3ZdXSsrXT12KTtpZigwPT09dD8oRT1JPWEsZD0xOSk6MT09PXQ/KEU9c18sTC09MjU3LEk9Y18sQy09MjU3LGQ9MjU2KTooRT1sXyxJPXVfLGQ9LTEpLFQ9MCx2PTAseT1iLGY9byxTPWssTz0wLHU9LTEsaD0oQT0xPDxrKS0xLDE9PT10JiZBPjg1Mnx8Mj09PXQmJkE+NTkyKXJldHVybiAxO2Zvcig7Oyl7Xz15LU8sYVt2XTxkPyhwPTAsZz1hW3ZdKTphW3ZdPmQ/KHA9SVtDK2Fbdl1dLGc9RVtMK2Fbdl1dKToocD05NixnPTApLGM9MTw8eS1PLGI9bD0xPDxTO2Rve2lbZisoVD4+TykrKGwtPWMpXT1fPDwyNHxwPDwxNnxnfXdoaWxlKDAhPT1sKTtmb3IoYz0xPDx5LTE7VCZjOyljPj49MTtpZigwIT09Yz8oVCY9Yy0xLFQrPWMpOlQ9MCx2KyssMD09LS16W3ldKXtpZih5PT09dylicmVhazt5PWVbbithW3ZdXX1pZih5PmsmJihUJmgpIT09dSl7Zm9yKDA9PT1PJiYoTz1rKSxmKz1iLHg9MTw8KFM9eS1PKTtTK088dyYmISgoeC09eltTK09dKTw9MCk7KVMrKyx4PDw9MTtpZihBKz0xPDxTLDE9PT10JiZBPjg1Mnx8Mj09PXQmJkE+NTkyKXJldHVybiAxO2lbdT1UJmhdPWs8PDI0fFM8PDE2fGYtb319cmV0dXJuIDAhPT1UJiYoaVtmK1RdPXktTzw8MjR8NjQ8PDE2KSxzLmJpdHM9aywwfSxnXz0tMixtXz0xMix5Xz0zMDtmdW5jdGlvbiB2Xyh0KXtyZXR1cm4odD4+PjI0JjI1NSkrKHQ+Pj44JjY1MjgwKSsoKDY1MjgwJnQpPDw4KSsoKDI1NSZ0KTw8MjQpfWZ1bmN0aW9uIGJfKCl7dGhpcy5tb2RlPTAsdGhpcy5sYXN0PSExLHRoaXMud3JhcD0wLHRoaXMuaGF2ZWRpY3Q9ITEsdGhpcy5mbGFncz0wLHRoaXMuZG1heD0wLHRoaXMuY2hlY2s9MCx0aGlzLnRvdGFsPTAsdGhpcy5oZWFkPW51bGwsdGhpcy53Yml0cz0wLHRoaXMud3NpemU9MCx0aGlzLndoYXZlPTAsdGhpcy53bmV4dD0wLHRoaXMud2luZG93PW51bGwsdGhpcy5ob2xkPTAsdGhpcy5iaXRzPTAsdGhpcy5sZW5ndGg9MCx0aGlzLm9mZnNldD0wLHRoaXMuZXh0cmE9MCx0aGlzLmxlbmNvZGU9bnVsbCx0aGlzLmRpc3Rjb2RlPW51bGwsdGhpcy5sZW5iaXRzPTAsdGhpcy5kaXN0Yml0cz0wLHRoaXMubmNvZGU9MCx0aGlzLm5sZW49MCx0aGlzLm5kaXN0PTAsdGhpcy5oYXZlPTAsdGhpcy5uZXh0PW51bGwsdGhpcy5sZW5zPW5ldyBoXy5CdWYxNigzMjApLHRoaXMud29yaz1uZXcgaF8uQnVmMTYoMjg4KSx0aGlzLmxlbmR5bj1udWxsLHRoaXMuZGlzdGR5bj1udWxsLHRoaXMuc2FuZT0wLHRoaXMuYmFjaz0wLHRoaXMud2FzPTB9ZnVuY3Rpb24gd18odCl7dmFyIGU7cmV0dXJuIHQmJnQuc3RhdGU/KGU9dC5zdGF0ZSx0LnRvdGFsX2luPXQudG90YWxfb3V0PWUudG90YWw9MCx0Lm1zZz0iIixlLndyYXAmJih0LmFkbGVyPTEmZS53cmFwKSxlLm1vZGU9MSxlLmxhc3Q9MCxlLmhhdmVkaWN0PTAsZS5kbWF4PTMyNzY4LGUuaGVhZD1udWxsLGUuaG9sZD0wLGUuYml0cz0wLGUubGVuY29kZT1lLmxlbmR5bj1uZXcgaF8uQnVmMzIoODUyKSxlLmRpc3Rjb2RlPWUuZGlzdGR5bj1uZXcgaF8uQnVmMzIoNTkyKSxlLnNhbmU9MSxlLmJhY2s9LTEsMCk6Z199ZnVuY3Rpb24ga18odCl7dmFyIGU7cmV0dXJuIHQmJnQuc3RhdGU/KChlPXQuc3RhdGUpLndzaXplPTAsZS53aGF2ZT0wLGUud25leHQ9MCx3Xyh0KSk6Z199ZnVuY3Rpb24gU18odCxlKXt2YXIgbixyO3JldHVybiB0JiZ0LnN0YXRlPyhyPXQuc3RhdGUsZTwwPyhuPTAsZT0tZSk6KG49MSsoZT4+NCksZTw0OCYmKGUmPTE1KSksZSYmKGU8OHx8ZT4xNSk/Z186KG51bGwhPT1yLndpbmRvdyYmci53Yml0cyE9PWUmJihyLndpbmRvdz1udWxsKSxyLndyYXA9bixyLndiaXRzPWUsa18odCkpKTpnX31mdW5jdGlvbiBPXyh0LGUpe3ZhciBuLHI7cmV0dXJuIHQ/KHI9bmV3IGJfLHQuc3RhdGU9cixyLndpbmRvdz1udWxsLDAhPT0obj1TXyh0LGUpKSYmKHQuc3RhdGU9bnVsbCksbik6Z199dmFyIHhfLEFfLFRfPSEwO2Z1bmN0aW9uIEVfKHQpe2lmKFRfKXt2YXIgZTtmb3IoeF89bmV3IGhfLkJ1ZjMyKDUxMiksQV89bmV3IGhfLkJ1ZjMyKDMyKSxlPTA7ZTwxNDQ7KXQubGVuc1tlKytdPTg7Zm9yKDtlPDI1NjspdC5sZW5zW2UrK109OTtmb3IoO2U8MjgwOyl0LmxlbnNbZSsrXT03O2Zvcig7ZTwyODg7KXQubGVuc1tlKytdPTg7Zm9yKHBfKDEsdC5sZW5zLDAsMjg4LHhfLDAsdC53b3JrLHtiaXRzOjl9KSxlPTA7ZTwzMjspdC5sZW5zW2UrK109NTtwXygyLHQubGVucywwLDMyLEFfLDAsdC53b3JrLHtiaXRzOjV9KSxUXz0hMX10LmxlbmNvZGU9eF8sdC5sZW5iaXRzPTksdC5kaXN0Y29kZT1BXyx0LmRpc3RiaXRzPTV9ZnVuY3Rpb24gTF8odCxlLG4scil7dmFyIGksbz10LnN0YXRlO3JldHVybiBudWxsPT09by53aW5kb3cmJihvLndzaXplPTE8PG8ud2JpdHMsby53bmV4dD0wLG8ud2hhdmU9MCxvLndpbmRvdz1uZXcgaF8uQnVmOChvLndzaXplKSkscj49by53c2l6ZT8oaF8uYXJyYXlTZXQoby53aW5kb3csZSxuLW8ud3NpemUsby53c2l6ZSwwKSxvLnduZXh0PTAsby53aGF2ZT1vLndzaXplKTooKGk9by53c2l6ZS1vLnduZXh0KT5yJiYoaT1yKSxoXy5hcnJheVNldChvLndpbmRvdyxlLG4tcixpLG8ud25leHQpLChyLT1pKT8oaF8uYXJyYXlTZXQoby53aW5kb3csZSxuLXIsciwwKSxvLnduZXh0PXIsby53aGF2ZT1vLndzaXplKTooby53bmV4dCs9aSxvLnduZXh0PT09by53c2l6ZSYmKG8ud25leHQ9MCksby53aGF2ZTxvLndzaXplJiYoby53aGF2ZSs9aSkpKSwwfWlfLmluZmxhdGVSZXNldD1rXyxpXy5pbmZsYXRlUmVzZXQyPVNfLGlfLmluZmxhdGVSZXNldEtlZXA9d18saV8uaW5mbGF0ZUluaXQ9ZnVuY3Rpb24odCl7cmV0dXJuIE9fKHQsMTUpfSxpXy5pbmZsYXRlSW5pdDI9T18saV8uaW5mbGF0ZT1mdW5jdGlvbih0LGUpe3ZhciBuLHIsaSxvLGEscyxjLGwsdSxoLGYsZCxfLHAsZyxtLHksdixiLHcsayxTLE8seCxBPTAsVD1uZXcgaF8uQnVmOCg0KSxFPVsxNiwxNywxOCwwLDgsNyw5LDYsMTAsNSwxMSw0LDEyLDMsMTMsMiwxNCwxLDE1XTtpZighdHx8IXQuc3RhdGV8fCF0Lm91dHB1dHx8IXQuaW5wdXQmJjAhPT10LmF2YWlsX2luKXJldHVybiBnXzsobj10LnN0YXRlKS5tb2RlPT09bV8mJihuLm1vZGU9MTMpLGE9dC5uZXh0X291dCxpPXQub3V0cHV0LGM9dC5hdmFpbF9vdXQsbz10Lm5leHRfaW4scj10LmlucHV0LHM9dC5hdmFpbF9pbixsPW4uaG9sZCx1PW4uYml0cyxoPXMsZj1jLFM9MDt0OmZvcig7Oylzd2l0Y2gobi5tb2RlKXtjYXNlIDE6aWYoMD09PW4ud3JhcCl7bi5tb2RlPTEzO2JyZWFrfWZvcig7dTwxNjspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fWlmKDImbi53cmFwJiYzNTYxNT09PWwpe24uY2hlY2s9MCxUWzBdPTI1NSZsLFRbMV09bD4+PjgmMjU1LG4uY2hlY2s9ZF8obi5jaGVjayxULDIsMCksbD0wLHU9MCxuLm1vZGU9MjticmVha31pZihuLmZsYWdzPTAsbi5oZWFkJiYobi5oZWFkLmRvbmU9ITEpLCEoMSZuLndyYXApfHwoKCgyNTUmbCk8PDgpKyhsPj44KSklMzEpe3QubXNnPSJpbmNvcnJlY3QgaGVhZGVyIGNoZWNrIixuLm1vZGU9eV87YnJlYWt9aWYoOCE9KDE1JmwpKXt0Lm1zZz0idW5rbm93biBjb21wcmVzc2lvbiBtZXRob2QiLG4ubW9kZT15XzticmVha31pZih1LT00LGs9OCsoMTUmKGw+Pj49NCkpLDA9PT1uLndiaXRzKW4ud2JpdHM9aztlbHNlIGlmKGs+bi53Yml0cyl7dC5tc2c9ImludmFsaWQgd2luZG93IHNpemUiLG4ubW9kZT15XzticmVha31uLmRtYXg9MTw8ayx0LmFkbGVyPW4uY2hlY2s9MSxuLm1vZGU9NTEyJmw/MTA6bV8sbD0wLHU9MDticmVhaztjYXNlIDI6Zm9yKDt1PDE2Oyl7aWYoMD09PXMpYnJlYWsgdDtzLS0sbCs9cltvKytdPDx1LHUrPTh9aWYobi5mbGFncz1sLDghPSgyNTUmcl8obikpKXt0Lm1zZz0idW5rbm93biBjb21wcmVzc2lvbiBtZXRob2QiLG4ubW9kZT15XzticmVha31pZig1NzM0NCZyXyhuKSl7dC5tc2c9InVua25vd24gaGVhZGVyIGZsYWdzIHNldCIsbi5tb2RlPXlfO2JyZWFrfW4uaGVhZCYmKG4uaGVhZC50ZXh0PWw+PjgmMSksNTEyJnJfKG4pJiYoVFswXT0yNTUmbCxUWzFdPWw+Pj44JjI1NSxuLmNoZWNrPWRfKG4uY2hlY2ssVCwyLDApKSxsPTAsdT0wLG4ubW9kZT0zO2Nhc2UgMzpmb3IoO3U8MzI7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1uLmhlYWQmJihuLmhlYWQudGltZT1sKSw1MTImcl8obikmJihUWzBdPTI1NSZsLFRbMV09bD4+PjgmMjU1LFRbMl09bD4+PjE2JjI1NSxUWzNdPWw+Pj4yNCYyNTUsbi5jaGVjaz1kXyhuLmNoZWNrLFQsNCwwKSksbD0wLHU9MCxuLm1vZGU9NDtjYXNlIDQ6Zm9yKDt1PDE2Oyl7aWYoMD09PXMpYnJlYWsgdDtzLS0sbCs9cltvKytdPDx1LHUrPTh9bi5oZWFkJiYobi5oZWFkLnhmbGFncz0yNTUmbCxuLmhlYWQub3M9bD4+OCksNTEyJnJfKG4pJiYoVFswXT0yNTUmbCxUWzFdPWw+Pj44JjI1NSxuLmNoZWNrPWRfKG4uY2hlY2ssVCwyLDApKSxsPTAsdT0wLG4ubW9kZT01O2Nhc2UgNTppZigxMDI0JnJfKG4pKXtmb3IoO3U8MTY7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1uLmxlbmd0aD1sLG4uaGVhZCYmKG4uaGVhZC5leHRyYV9sZW49bCksNTEyJnJfKG4pJiYoVFswXT0yNTUmbCxUWzFdPWw+Pj44JjI1NSxuLmNoZWNrPWRfKG4uY2hlY2ssVCwyLDApKSxsPTAsdT0wfWVsc2Ugbi5oZWFkJiYobi5oZWFkLmV4dHJhPW51bGwpO24ubW9kZT02O2Nhc2UgNjppZigxMDI0JnJfKG4pJiYoKGQ9bi5sZW5ndGgpPnMmJihkPXMpLGQmJihuLmhlYWQmJihrPW4uaGVhZC5leHRyYV9sZW4tbi5sZW5ndGgsbi5oZWFkLmV4dHJhfHwobi5oZWFkLmV4dHJhPW5ldyBBcnJheShuLmhlYWQuZXh0cmFfbGVuKSksaF8uYXJyYXlTZXQobi5oZWFkLmV4dHJhLHIsbyxkLGspKSw1MTImcl8obikmJihuLmNoZWNrPWRfKG4uY2hlY2sscixkLG8pKSxzLT1kLG8rPWQsbi5sZW5ndGgtPWQpLG4ubGVuZ3RoKSlicmVhayB0O24ubGVuZ3RoPTAsbi5tb2RlPTc7Y2FzZSA3OmlmKDIwNDgmcl8obikpe2lmKDA9PT1zKWJyZWFrIHQ7ZD0wO2Rve2s9cltvK2QrK10sbi5oZWFkJiZrJiZuLmxlbmd0aDw2NTUzNiYmKG4uaGVhZC5uYW1lKz1TdHJpbmcuZnJvbUNoYXJDb2RlKGspKX13aGlsZShrJiZkPHMpO2lmKDUxMiZyXyhuKSYmKG4uY2hlY2s9ZF8obi5jaGVjayxyLGQsbykpLHMtPWQsbys9ZCxrKWJyZWFrIHR9ZWxzZSBuLmhlYWQmJihuLmhlYWQubmFtZT1udWxsKTtuLmxlbmd0aD0wLG4ubW9kZT04O2Nhc2UgODppZig0MDk2JnJfKG4pKXtpZigwPT09cylicmVhayB0O2Q9MDtkb3trPXJbbytkKytdLG4uaGVhZCYmayYmbi5sZW5ndGg8NjU1MzYmJihuLmhlYWQuY29tbWVudCs9U3RyaW5nLmZyb21DaGFyQ29kZShrKSl9d2hpbGUoayYmZDxzKTtpZig1MTImcl8obikmJihuLmNoZWNrPWRfKG4uY2hlY2sscixkLG8pKSxzLT1kLG8rPWQsaylicmVhayB0fWVsc2Ugbi5oZWFkJiYobi5oZWFkLmNvbW1lbnQ9bnVsbCk7bi5tb2RlPTk7Y2FzZSA5OmlmKDUxMiZyXyhuKSl7Zm9yKDt1PDE2Oyl7aWYoMD09PXMpYnJlYWsgdDtzLS0sbCs9cltvKytdPDx1LHUrPTh9aWYobCE9PSg2NTUzNSZuLmNoZWNrKSl7dC5tc2c9ImhlYWRlciBjcmMgbWlzbWF0Y2giLG4ubW9kZT15XzticmVha31sPTAsdT0wfW4uaGVhZCYmKG4uaGVhZC5oY3JjPXJfKG4pPj45JjEsbi5oZWFkLmRvbmU9ITApLHQuYWRsZXI9bi5jaGVjaz0wLG4ubW9kZT1tXzticmVhaztjYXNlIDEwOmZvcig7dTwzMjspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fXQuYWRsZXI9bi5jaGVjaz12XyhsKSxsPTAsdT0wLG4ubW9kZT0xMTtjYXNlIDExOmlmKDA9PT1uLmhhdmVkaWN0KXJldHVybiB0Lm5leHRfb3V0PWEsdC5hdmFpbF9vdXQ9Yyx0Lm5leHRfaW49byx0LmF2YWlsX2luPXMsbi5ob2xkPWwsbi5iaXRzPXUsMjt0LmFkbGVyPW4uY2hlY2s9MSxuLm1vZGU9bV87Y2FzZSBtXzppZig1PT09ZXx8Nj09PWUpYnJlYWsgdDtjYXNlIDEzOmlmKG4ubGFzdCl7bD4+Pj03JnUsdS09NyZ1LG4ubW9kZT0yNzticmVha31mb3IoO3U8Mzspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fXN3aXRjaChuLmxhc3Q9MSZsLHUtPTEsMyYobD4+Pj0xKSl7Y2FzZSAwOm4ubW9kZT0xNDticmVhaztjYXNlIDE6aWYoRV8obiksbi5tb2RlPTIwLDY9PT1lKXtsPj4+PTIsdS09MjticmVhayB0fWJyZWFrO2Nhc2UgMjpuLm1vZGU9MTc7YnJlYWs7Y2FzZSAzOnQubXNnPSJpbnZhbGlkIGJsb2NrIHR5cGUiLG4ubW9kZT15X31sPj4+PTIsdS09MjticmVhaztjYXNlIDE0OmZvcihsPj4+PTcmdSx1LT03JnU7dTwzMjspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fWlmKCg2NTUzNSZsKSE9KGw+Pj4xNl42NTUzNSkpe3QubXNnPSJpbnZhbGlkIHN0b3JlZCBibG9jayBsZW5ndGhzIixuLm1vZGU9eV87YnJlYWt9aWYobi5sZW5ndGg9NjU1MzUmbCxsPTAsdT0wLG4ubW9kZT0xNSw2PT09ZSlicmVhayB0O2Nhc2UgMTU6bi5tb2RlPTE2O2Nhc2UgMTY6aWYoZD1uLmxlbmd0aCl7aWYoZD5zJiYoZD1zKSxkPmMmJihkPWMpLDA9PT1kKWJyZWFrIHQ7aF8uYXJyYXlTZXQoaSxyLG8sZCxhKSxzLT1kLG8rPWQsYy09ZCxhKz1kLG4ubGVuZ3RoLT1kO2JyZWFrfW4ubW9kZT1tXzticmVhaztjYXNlIDE3OmZvcig7dTwxNDspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fWlmKG4ubmxlbj0yNTcrKDMxJmwpLGw+Pj49NSx1LT01LG4ubmRpc3Q9MSsoMzEmbCksbD4+Pj01LHUtPTUsbi5uY29kZT00KygxNSZsKSxsPj4+PTQsdS09NCxuLm5sZW4+Mjg2fHxuLm5kaXN0PjMwKXt0Lm1zZz0idG9vIG1hbnkgbGVuZ3RoIG9yIGRpc3RhbmNlIHN5bWJvbHMiLG4ubW9kZT15XzticmVha31uLmhhdmU9MCxuLm1vZGU9MTg7Y2FzZSAxODpmb3IoO24uaGF2ZTxuLm5jb2RlOyl7Zm9yKDt1PDM7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1uLmxlbnNbRVtuLmhhdmUrK11dPTcmbCxsPj4+PTMsdS09M31mb3IoO24uaGF2ZTwxOTspbi5sZW5zW0Vbbi5oYXZlKytdXT0wO2lmKG4ubGVuY29kZT1uLmxlbmR5bixuLmxlbmJpdHM9NyxPPXtiaXRzOm4ubGVuYml0c30sUz1wXygwLG4ubGVucywwLDE5LG4ubGVuY29kZSwwLG4ud29yayxPKSxuLmxlbmJpdHM9Ty5iaXRzLFMpe3QubXNnPSJpbnZhbGlkIGNvZGUgbGVuZ3RocyBzZXQiLG4ubW9kZT15XzticmVha31uLmhhdmU9MCxuLm1vZGU9MTk7Y2FzZSAxOTpmb3IoO24uaGF2ZTxuLm5sZW4rbi5uZGlzdDspe2Zvcig7bT0oQT1uLmxlbmNvZGVbbCYoMTw8bi5sZW5iaXRzKS0xXSk+Pj4xNiYyNTUseT02NTUzNSZBLCEoKGc9QT4+PjI0KTw9dSk7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1pZih5PDE2KWw+Pj49Zyx1LT1nLG4ubGVuc1tuLmhhdmUrK109eTtlbHNle2lmKDE2PT09eSl7Zm9yKHg9ZysyO3U8eDspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fWlmKGw+Pj49Zyx1LT1nLDA9PT1uLmhhdmUpe3QubXNnPSJpbnZhbGlkIGJpdCBsZW5ndGggcmVwZWF0IixuLm1vZGU9eV87YnJlYWt9az1uLmxlbnNbbi5oYXZlLTFdLGQ9MysoMyZsKSxsPj4+PTIsdS09Mn1lbHNlIGlmKDE3PT09eSl7Zm9yKHg9ZyszO3U8eDspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fXUtPWcsaz0wLGQ9MysoNyYobD4+Pj1nKSksbD4+Pj0zLHUtPTN9ZWxzZXtmb3IoeD1nKzc7dTx4Oyl7aWYoMD09PXMpYnJlYWsgdDtzLS0sbCs9cltvKytdPDx1LHUrPTh9dS09ZyxrPTAsZD0xMSsoMTI3JihsPj4+PWcpKSxsPj4+PTcsdS09N31pZihuLmhhdmUrZD5uLm5sZW4rbi5uZGlzdCl7dC5tc2c9ImludmFsaWQgYml0IGxlbmd0aCByZXBlYXQiLG4ubW9kZT15XzticmVha31mb3IoO2QtLTspbi5sZW5zW24uaGF2ZSsrXT1rfX1pZihuLm1vZGU9PT15XylicmVhaztpZigwPT09bi5sZW5zWzI1Nl0pe3QubXNnPSJpbnZhbGlkIGNvZGUgLS0gbWlzc2luZyBlbmQtb2YtYmxvY2siLG4ubW9kZT15XzticmVha31pZihuLmxlbmJpdHM9OSxPPXtiaXRzOm4ubGVuYml0c30sUz1wXygxLG4ubGVucywwLG4ubmxlbixuLmxlbmNvZGUsMCxuLndvcmssTyksbi5sZW5iaXRzPU8uYml0cyxTKXt0Lm1zZz0iaW52YWxpZCBsaXRlcmFsL2xlbmd0aHMgc2V0IixuLm1vZGU9eV87YnJlYWt9aWYobi5kaXN0Yml0cz02LG4uZGlzdGNvZGU9bi5kaXN0ZHluLE89e2JpdHM6bi5kaXN0Yml0c30sUz1wXygyLG4ubGVucyxuLm5sZW4sbi5uZGlzdCxuLmRpc3Rjb2RlLDAsbi53b3JrLE8pLG4uZGlzdGJpdHM9Ty5iaXRzLFMpe3QubXNnPSJpbnZhbGlkIGRpc3RhbmNlcyBzZXQiLG4ubW9kZT15XzticmVha31pZihuLm1vZGU9MjAsNj09PWUpYnJlYWsgdDtjYXNlIDIwOm4ubW9kZT0yMTtjYXNlIDIxOmlmKHM+PTYmJmM+PTI1OCl7dC5uZXh0X291dD1hLHQuYXZhaWxfb3V0PWMsdC5uZXh0X2luPW8sdC5hdmFpbF9pbj1zLG4uaG9sZD1sLG4uYml0cz11LF9fKHQsZiksYT10Lm5leHRfb3V0LGk9dC5vdXRwdXQsYz10LmF2YWlsX291dCxvPXQubmV4dF9pbixyPXQuaW5wdXQscz10LmF2YWlsX2luLGw9bi5ob2xkLHU9bi5iaXRzLG4ubW9kZT09PW1fJiYobi5iYWNrPS0xKTticmVha31mb3Iobi5iYWNrPTA7bT0oQT1uLmxlbmNvZGVbbCYoMTw8bi5sZW5iaXRzKS0xXSk+Pj4xNiYyNTUseT02NTUzNSZBLCEoKGc9QT4+PjI0KTw9dSk7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1pZihtJiYhKDI0MCZtKSl7Zm9yKHY9ZyxiPW0sdz15O209KEE9bi5sZW5jb2RlW3crKChsJigxPDx2K2IpLTEpPj52KV0pPj4+MTYmMjU1LHk9NjU1MzUmQSwhKHYrKGc9QT4+PjI0KTw9dSk7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1sPj4+PXYsdS09dixuLmJhY2srPXZ9aWYobD4+Pj1nLHUtPWcsbi5iYWNrKz1nLG4ubGVuZ3RoPXksMD09PW0pe24ubW9kZT0yNjticmVha31pZigzMiZtKXtuLmJhY2s9LTEsbi5tb2RlPW1fO2JyZWFrfWlmKDY0Jm0pe3QubXNnPSJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RoIGNvZGUiLG4ubW9kZT15XzticmVha31uLmV4dHJhPTE1Jm0sbi5tb2RlPTIyO2Nhc2UgMjI6aWYobi5leHRyYSl7Zm9yKHg9bi5leHRyYTt1PHg7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1uLmxlbmd0aCs9bCYoMTw8bi5leHRyYSktMSxsPj4+PW4uZXh0cmEsdS09bi5leHRyYSxuLmJhY2srPW4uZXh0cmF9bi53YXM9bi5sZW5ndGgsbi5tb2RlPTIzO2Nhc2UgMjM6Zm9yKDttPShBPW4uZGlzdGNvZGVbbCYoMTw8bi5kaXN0Yml0cyktMV0pPj4+MTYmMjU1LHk9NjU1MzUmQSwhKChnPUE+Pj4yNCk8PXUpOyl7aWYoMD09PXMpYnJlYWsgdDtzLS0sbCs9cltvKytdPDx1LHUrPTh9aWYoISgyNDAmbSkpe2Zvcih2PWcsYj1tLHc9eTttPShBPW4uZGlzdGNvZGVbdysoKGwmKDE8PHYrYiktMSk+PnYpXSk+Pj4xNiYyNTUseT02NTUzNSZBLCEodisoZz1BPj4+MjQpPD11KTspe2lmKDA9PT1zKWJyZWFrIHQ7cy0tLGwrPXJbbysrXTw8dSx1Kz04fWw+Pj49dix1LT12LG4uYmFjays9dn1pZihsPj4+PWcsdS09ZyxuLmJhY2srPWcsNjQmbSl7dC5tc2c9ImludmFsaWQgZGlzdGFuY2UgY29kZSIsbi5tb2RlPXlfO2JyZWFrfW4ub2Zmc2V0PXksbi5leHRyYT0xNSZtLG4ubW9kZT0yNDtjYXNlIDI0OmlmKG4uZXh0cmEpe2Zvcih4PW4uZXh0cmE7dTx4Oyl7aWYoMD09PXMpYnJlYWsgdDtzLS0sbCs9cltvKytdPDx1LHUrPTh9bi5vZmZzZXQrPWwmKDE8PG4uZXh0cmEpLTEsbD4+Pj1uLmV4dHJhLHUtPW4uZXh0cmEsbi5iYWNrKz1uLmV4dHJhfWlmKG4ub2Zmc2V0Pm4uZG1heCl7dC5tc2c9ImludmFsaWQgZGlzdGFuY2UgdG9vIGZhciBiYWNrIixuLm1vZGU9eV87YnJlYWt9bi5tb2RlPTI1O2Nhc2UgMjU6aWYoMD09PWMpYnJlYWsgdDtpZihkPWYtYyxuLm9mZnNldD5kKXtpZigoZD1uLm9mZnNldC1kKT5uLndoYXZlJiZuLnNhbmUpe3QubXNnPSJpbnZhbGlkIGRpc3RhbmNlIHRvbyBmYXIgYmFjayIsbi5tb2RlPXlfO2JyZWFrfWQ+bi53bmV4dD8oZC09bi53bmV4dCxfPW4ud3NpemUtZCk6Xz1uLnduZXh0LWQsZD5uLmxlbmd0aCYmKGQ9bi5sZW5ndGgpLHA9bi53aW5kb3d9ZWxzZSBwPWksXz1hLW4ub2Zmc2V0LGQ9bi5sZW5ndGg7ZD5jJiYoZD1jKSxjLT1kLG4ubGVuZ3RoLT1kO2Rve2lbYSsrXT1wW18rK119d2hpbGUoLS1kKTswPT09bi5sZW5ndGgmJihuLm1vZGU9MjEpO2JyZWFrO2Nhc2UgMjY6aWYoMD09PWMpYnJlYWsgdDtpW2ErK109bi5sZW5ndGgsYy0tLG4ubW9kZT0yMTticmVhaztjYXNlIDI3OmlmKG4ud3JhcCl7Zm9yKDt1PDMyOyl7aWYoMD09PXMpYnJlYWsgdDtzLS0sbHw9cltvKytdPDx1LHUrPTh9aWYoZi09Yyx0LnRvdGFsX291dCs9ZixuLnRvdGFsKz1mLGYmJih0LmFkbGVyPW4uY2hlY2s9cl8obik/ZF8obi5jaGVjayxpLGYsYS1mKTpmXyhuLmNoZWNrLGksZixhLWYpKSxmPWMsKHJfKG4pP2w6dl8obCkpIT09bi5jaGVjayl7dC5tc2c9ImluY29ycmVjdCBkYXRhIGNoZWNrIixuLm1vZGU9eV87YnJlYWt9bD0wLHU9MH1uLm1vZGU9Mjg7Y2FzZSAyODppZihuLndyYXAmJnJfKG4pKXtmb3IoO3U8MzI7KXtpZigwPT09cylicmVhayB0O3MtLSxsKz1yW28rK108PHUsdSs9OH1pZihsIT09KDQyOTQ5NjcyOTUmbi50b3RhbCkpe3QubXNnPSJpbmNvcnJlY3QgbGVuZ3RoIGNoZWNrIixuLm1vZGU9eV87YnJlYWt9bD0wLHU9MH1uLm1vZGU9Mjk7Y2FzZSAyOTpTPTE7YnJlYWsgdDtjYXNlIHlfOlM9LTM7YnJlYWsgdDtjYXNlIDMxOnJldHVybi00O2RlZmF1bHQ6cmV0dXJuIGdffXJldHVybiB0Lm5leHRfb3V0PWEsdC5hdmFpbF9vdXQ9Yyx0Lm5leHRfaW49byx0LmF2YWlsX2luPXMsbi5ob2xkPWwsbi5iaXRzPXUsKG4ud3NpemV8fGYhPT10LmF2YWlsX291dCYmbi5tb2RlPHlfJiYobi5tb2RlPDI3fHw0IT09ZSkpJiZMXyh0LHQub3V0cHV0LHQubmV4dF9vdXQsZi10LmF2YWlsX291dCksaC09dC5hdmFpbF9pbixmLT10LmF2YWlsX291dCx0LnRvdGFsX2luKz1oLHQudG90YWxfb3V0Kz1mLG4udG90YWwrPWYsbi53cmFwJiZmJiYodC5hZGxlcj1uLmNoZWNrPXJfKG4pP2RfKG4uY2hlY2ssaSxmLHQubmV4dF9vdXQtZik6Zl8obi5jaGVjayxpLGYsdC5uZXh0X291dC1mKSksdC5kYXRhX3R5cGU9bi5iaXRzKyhuLmxhc3Q/NjQ6MCkrKG4ubW9kZT09PW1fPzEyODowKSsoMjA9PT1uLm1vZGV8fDE1PT09bi5tb2RlPzI1NjowKSwoMD09PWgmJjA9PT1mfHw0PT09ZSkmJjA9PT1TJiYoUz0tNSksU30saV8uaW5mbGF0ZUVuZD1mdW5jdGlvbih0KXtpZighdHx8IXQuc3RhdGUpcmV0dXJuIGdfO3ZhciBlPXQuc3RhdGU7cmV0dXJuIGUud2luZG93JiYoZS53aW5kb3c9bnVsbCksdC5zdGF0ZT1udWxsLDB9LGlfLmluZmxhdGVHZXRIZWFkZXI9ZnVuY3Rpb24odCxlKXt2YXIgbjtyZXR1cm4gdCYmdC5zdGF0ZSYmMiYobj10LnN0YXRlKS53cmFwPyhuLmhlYWQ9ZSxlLmRvbmU9ITEsMCk6Z199LGlfLmluZmxhdGVTZXREaWN0aW9uYXJ5PWZ1bmN0aW9uKHQsZSl7dmFyIG4scj1lLmxlbmd0aDtyZXR1cm4gdCYmdC5zdGF0ZT8wIT09KG49dC5zdGF0ZSkud3JhcCYmMTEhPT1uLm1vZGU/Z186MTE9PT1uLm1vZGUmJmZfKDEsZSxyLDApIT09bi5jaGVjaz8tMzpMXyh0LGUscixyKT8obi5tb2RlPTMxLC00KToobi5oYXZlZGljdD0xLDApOmdffSxpXy5pbmZsYXRlSW5mbz0icGFrbyBpbmZsYXRlIChmcm9tIE5vZGVjYSBwcm9qZWN0KSI7dmFyIHpfPXtaX05PX0ZMVVNIOjAsWl9QQVJUSUFMX0ZMVVNIOjEsWl9TWU5DX0ZMVVNIOjIsWl9GVUxMX0ZMVVNIOjMsWl9GSU5JU0g6NCxaX0JMT0NLOjUsWl9UUkVFUzo2LFpfT0s6MCxaX1NUUkVBTV9FTkQ6MSxaX05FRURfRElDVDoyLFpfRVJSTk86LTEsWl9TVFJFQU1fRVJST1I6LTIsWl9EQVRBX0VSUk9SOi0zLFpfQlVGX0VSUk9SOi01LFpfTk9fQ09NUFJFU1NJT046MCxaX0JFU1RfU1BFRUQ6MSxaX0JFU1RfQ09NUFJFU1NJT046OSxaX0RFRkFVTFRfQ09NUFJFU1NJT046LTEsWl9GSUxURVJFRDoxLFpfSFVGRk1BTl9PTkxZOjIsWl9STEU6MyxaX0ZJWEVEOjQsWl9ERUZBVUxUX1NUUkFURUdZOjAsWl9CSU5BUlk6MCxaX1RFWFQ6MSxaX1VOS05PV046MixaX0RFRkxBVEVEOjh9O3ZhciBCXz1pXyxJXz1mZixDXz1CZCxOXz16XyxSXz1yZCxqXz1QZCxEXz1mdW5jdGlvbigpe3RoaXMudGV4dD0wLHRoaXMudGltZT0wLHRoaXMueGZsYWdzPTAsdGhpcy5vcz0wLHRoaXMuZXh0cmE9bnVsbCx0aGlzLmV4dHJhX2xlbj0wLHRoaXMubmFtZT0iIix0aGlzLmNvbW1lbnQ9IiIsdGhpcy5oY3JjPTAsdGhpcy5kb25lPSExfSxQXz1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nO2Z1bmN0aW9uIFVfKHQpe2lmKCEodGhpcyBpbnN0YW5jZW9mIFVfKSlyZXR1cm4gbmV3IFVfKHQpO3RoaXMub3B0aW9ucz1JXy5hc3NpZ24oe2NodW5rU2l6ZToxNjM4NCx3aW5kb3dCaXRzOjAsdG86IiJ9LHR8fHt9KTt2YXIgZT10aGlzLm9wdGlvbnM7ZS5yYXcmJmUud2luZG93Qml0cz49MCYmZS53aW5kb3dCaXRzPDE2JiYoZS53aW5kb3dCaXRzPS1lLndpbmRvd0JpdHMsMD09PWUud2luZG93Qml0cyYmKGUud2luZG93Qml0cz0tMTUpKSwhKGUud2luZG93Qml0cz49MCYmZS53aW5kb3dCaXRzPDE2KXx8dCYmdC53aW5kb3dCaXRzfHwoZS53aW5kb3dCaXRzKz0zMiksZS53aW5kb3dCaXRzPjE1JiZlLndpbmRvd0JpdHM8NDgmJigxNSZlLndpbmRvd0JpdHN8fChlLndpbmRvd0JpdHN8PTE1KSksdGhpcy5lcnI9MCx0aGlzLm1zZz0iIix0aGlzLmVuZGVkPSExLHRoaXMuY2h1bmtzPVtdLHRoaXMuc3RybT1uZXcgal8sdGhpcy5zdHJtLmF2YWlsX291dD0wO3ZhciBuPUJfLmluZmxhdGVJbml0Mih0aGlzLnN0cm0sZS53aW5kb3dCaXRzKTtpZihuIT09Tl8uWl9PSyl0aHJvdyBuZXcgRXJyb3IoUl9bbl0pO2lmKHRoaXMuaGVhZGVyPW5ldyBEXyxCXy5pbmZsYXRlR2V0SGVhZGVyKHRoaXMuc3RybSx0aGlzLmhlYWRlciksZS5kaWN0aW9uYXJ5JiYoInN0cmluZyI9PXR5cGVvZiBlLmRpY3Rpb25hcnk/ZS5kaWN0aW9uYXJ5PUNfLnN0cmluZzJidWYoZS5kaWN0aW9uYXJ5KToiW29iamVjdCBBcnJheUJ1ZmZlcl0iPT09UF8uY2FsbChlLmRpY3Rpb25hcnkpJiYoZS5kaWN0aW9uYXJ5PW5ldyBVaW50OEFycmF5KGUuZGljdGlvbmFyeSkpLGUucmF3JiYobj1CXy5pbmZsYXRlU2V0RGljdGlvbmFyeSh0aGlzLnN0cm0sZS5kaWN0aW9uYXJ5KSkhPT1OXy5aX09LKSl0aHJvdyBuZXcgRXJyb3IoUl9bbl0pfWZ1bmN0aW9uIEZfKHQsZSl7dmFyIG49bmV3IFVfKGUpO2lmKG4ucHVzaCh0LCEwKSxuLmVycil0aHJvdyBuLm1zZ3x8Ul9bbi5lcnJdO3JldHVybiBuLnJlc3VsdH1VXy5wcm90b3R5cGUucHVzaD1mdW5jdGlvbih0LGUpe3ZhciBuLHIsaSxvLGEscz10aGlzLnN0cm0sYz10aGlzLm9wdGlvbnMuY2h1bmtTaXplLGw9dGhpcy5vcHRpb25zLmRpY3Rpb25hcnksdT0hMTtpZih0aGlzLmVuZGVkKXJldHVybiExO3I9ZT09PX5+ZT9lOiEwPT09ZT9OXy5aX0ZJTklTSDpOXy5aX05PX0ZMVVNILCJzdHJpbmciPT10eXBlb2YgdD9zLmlucHV0PUNfLmJpbnN0cmluZzJidWYodCk6IltvYmplY3QgQXJyYXlCdWZmZXJdIj09PVBfLmNhbGwodCk/cy5pbnB1dD1uZXcgVWludDhBcnJheSh0KTpzLmlucHV0PXQscy5uZXh0X2luPTAscy5hdmFpbF9pbj1zLmlucHV0Lmxlbmd0aDtkb3tpZigwPT09cy5hdmFpbF9vdXQmJihzLm91dHB1dD1uZXcgSV8uQnVmOChjKSxzLm5leHRfb3V0PTAscy5hdmFpbF9vdXQ9YyksKG49Ql8uaW5mbGF0ZShzLE5fLlpfTk9fRkxVU0gpKT09PU5fLlpfTkVFRF9ESUNUJiZsJiYobj1CXy5pbmZsYXRlU2V0RGljdGlvbmFyeSh0aGlzLnN0cm0sbCkpLG49PT1OXy5aX0JVRl9FUlJPUiYmITA9PT11JiYobj1OXy5aX09LLHU9ITEpLG4hPT1OXy5aX1NUUkVBTV9FTkQmJm4hPT1OXy5aX09LKXJldHVybiB0aGlzLm9uRW5kKG4pLHRoaXMuZW5kZWQ9ITAsITE7cy5uZXh0X291dCYmKDAhPT1zLmF2YWlsX291dCYmbiE9PU5fLlpfU1RSRUFNX0VORCYmKDAhPT1zLmF2YWlsX2lufHxyIT09Tl8uWl9GSU5JU0gmJnIhPT1OXy5aX1NZTkNfRkxVU0gpfHwoInN0cmluZyI9PT10aGlzLm9wdGlvbnMudG8/KGk9Q18udXRmOGJvcmRlcihzLm91dHB1dCxzLm5leHRfb3V0KSxvPXMubmV4dF9vdXQtaSxhPUNfLmJ1ZjJzdHJpbmcocy5vdXRwdXQsaSkscy5uZXh0X291dD1vLHMuYXZhaWxfb3V0PWMtbyxvJiZJXy5hcnJheVNldChzLm91dHB1dCxzLm91dHB1dCxpLG8sMCksdGhpcy5vbkRhdGEoYSkpOnRoaXMub25EYXRhKElfLnNocmlua0J1ZihzLm91dHB1dCxzLm5leHRfb3V0KSkpKSwwPT09cy5hdmFpbF9pbiYmMD09PXMuYXZhaWxfb3V0JiYodT0hMCl9d2hpbGUoKHMuYXZhaWxfaW4+MHx8MD09PXMuYXZhaWxfb3V0KSYmbiE9PU5fLlpfU1RSRUFNX0VORCk7cmV0dXJuIG49PT1OXy5aX1NUUkVBTV9FTkQmJihyPU5fLlpfRklOSVNIKSxyPT09Tl8uWl9GSU5JU0g/KG49Ql8uaW5mbGF0ZUVuZCh0aGlzLnN0cm0pLHRoaXMub25FbmQobiksdGhpcy5lbmRlZD0hMCxuPT09Tl8uWl9PSyk6ciE9PU5fLlpfU1lOQ19GTFVTSHx8KHRoaXMub25FbmQoTl8uWl9PSykscy5hdmFpbF9vdXQ9MCwhMCl9LFVfLnByb3RvdHlwZS5vbkRhdGE9ZnVuY3Rpb24odCl7dGhpcy5jaHVua3MucHVzaCh0KX0sVV8ucHJvdG90eXBlLm9uRW5kPWZ1bmN0aW9uKHQpe3Q9PT1OXy5aX09LJiYoInN0cmluZyI9PT10aGlzLm9wdGlvbnMudG8/dGhpcy5yZXN1bHQ9dGhpcy5jaHVua3Muam9pbigiIik6dGhpcy5yZXN1bHQ9SV8uZmxhdHRlbkNodW5rcyh0aGlzLmNodW5rcykpLHRoaXMuY2h1bmtzPVtdLHRoaXMuZXJyPXQsdGhpcy5tc2c9dGhpcy5zdHJtLm1zZ30sR2QuSW5mbGF0ZT1VXyxHZC5pbmZsYXRlPUZfLEdkLmluZmxhdGVSYXc9ZnVuY3Rpb24odCxlKXtyZXR1cm4oZT1lfHx7fSkucmF3PSEwLEZfKHQsZSl9LEdkLnVuZ3ppcD1GXzt2YXIgTV89e307KDAsZmYuYXNzaWduKShNXyxkZixHZCx6Xyk7dmFyIFpfPW4oTV8pO2xldCBKXz0xO2NvbnN0IEhfPSJfX3J0Y191bWRfbmFtZV9fIixXXz0oKT0+d2luZG93LmluZGV4ZWREQnx8d2luZG93Lm1vekluZGV4ZWREQnx8d2luZG93LndlYmtpdEluZGV4ZWREQnx8d2luZG93Lm1zSW5kZXhlZERCO2NsYXNzIEtfe2NvbnN0cnVjdG9yKHQpe3V1KHRoaXMsInN0b3JlTmFtZSIsdm9pZCAwKSx1dSh0aGlzLCJwZW5kaW5nTGlzdCIsW10pLHRoaXMuc3RvcmVOYW1lPXQsIUJ1KCkmJldfKCkmJnRoaXMuX2NoZWNrQW5kQ3JlYXRlU3RvcmUodCl9YXN5bmMgX2NoZWNrQW5kQ3JlYXRlU3RvcmUodCxlKXtjb25zdCBuPWF3YWl0IEtfLl9wcm9taXNlTG9jay5sb2NrKCk7aWYoV18oKS5kYXRhYmFzZXMpe2xldCB0O2F3YWl0IG5ldyBQcm9taXNlKChlPT57Y29uc3Qgbj0oKT0+V18oKS5kYXRhYmFzZXMoKS5maW5hbGx5KGUpO3Q9c2V0SW50ZXJ2YWwobiwxMDApLG4oKX0pKS5maW5hbGx5KCgoKT0+Y2xlYXJJbnRlcnZhbCh0KSkpfXJldHVybiBuZXcgUHJvbWlzZSgocj0+e0tfLmRiJiYoS18uZGIuY2xvc2UoKSxkZWxldGUgS18uZGIpO2NvbnN0IGk9ZT9XXygpLm9wZW4oSF8sZSk6V18oKS5vcGVuKEhfKTtpLm9udXBncmFkZW5lZWRlZD0oKT0+e2kucmVzdWx0LmNyZWF0ZU9iamVjdFN0b3JlKHQpfSxpLm9uZXJyb3I9KCk9Pntjb25zb2xlLmVycm9yKCJJbmRleGVkREJJbnRlcmZhY2UgZXJyb3IiLGkuZXJyb3IpfSxpLm9uc3VjY2Vzcz0oKT0+e2NvbnN0IGU9aS5yZXN1bHQ7S18uZGI9ZTt0cnl7S18uZGIudHJhbnNhY3Rpb24odGhpcy5zdG9yZU5hbWUsInJlYWRvbmx5IiksdGhpcy5wZW5kaW5nTGlzdC5mb3JFYWNoKChhc3luYyB0PT57bGV0e3R4TW9kZTplLHBlbmRSZXNvbHZlOm4scGVuZFJlamVjdDpyfT10O3RyeXtuKGF3YWl0IHRoaXMuX2dldFN0b3JlKGUpKX1jYXRjaChpKXtyKCl9fSkpLHIoKX1jYXRjaChvKXtyKHRoaXMuX2NoZWNrQW5kQ3JlYXRlU3RvcmUodCxlLnZlcnNpb24rMSkpfWZpbmFsbHl7bigpfX19KSl9YXN5bmMgX2dldFN0b3JlKHQpe2NvbnN0IGU9YXdhaXQgS18uX3Byb21pc2VMb2NrLmxvY2soKTtyZXR1cm4gbmV3IFByb21pc2UoKChuLHIpPT57aWYoIUtfLmRiKXJldHVybiB0aGlzLnBlbmRpbmdMaXN0LnB1c2goe3R4TW9kZTp0LHBlbmRSZXNvbHZlOm4scGVuZFJlamVjdDpyfSksdm9pZCBlKCk7dHJ5e24oS18uZGIudHJhbnNhY3Rpb24odGhpcy5zdG9yZU5hbWUsdCkub2JqZWN0U3RvcmUodGhpcy5zdG9yZU5hbWUpKX1jYXRjaChpKXtyZXR1cm4gdm9pZCB0aGlzLnBlbmRpbmdMaXN0LnB1c2goe3R4TW9kZTp0LHBlbmRSZXNvbHZlOm4scGVuZFJlamVjdDpyfSl9ZmluYWxseXtlKCl9fSkpfWFzeW5jIHB1dDJTdHJpbmcodCxlKXtsZXQgbjt0cnl7bj1KU09OLnN0cmluZ2lmeSh0KX1jYXRjaChyKXtuPXR9cmV0dXJuIGF3YWl0IHRoaXMucHV0KG4sZSl9YXN5bmMgZ2V0NFN0cmluZyh0KXtjb25zdCBlPWF3YWl0IHRoaXMuZ2V0KHQpO2xldCBuO3RyeXtuPUpTT04ucGFyc2UoZSl9Y2F0Y2gocil7bj1lfXJldHVybiBufWFzeW5jIHB1dCh0LGUpe2NvbnN0IG49YXdhaXQgdGhpcy5fZ2V0U3RvcmUoInJlYWR3cml0ZSIpO3JldHVybiBuZXcgUHJvbWlzZSgoKHIsaSk9Pntjb25zdCBvPW4ucHV0KHQsZSk7by5vbnN1Y2Nlc3M9KCk9PntyKCl9LG8ub25lcnJvcj10PT57aSh0KX19KSl9YXN5bmMgZ2V0KHQpe2NvbnN0IGU9YXdhaXQgdGhpcy5fZ2V0U3RvcmUoInJlYWRvbmx5Iik7cmV0dXJuIG5ldyBQcm9taXNlKCgobixyKT0+e2NvbnN0IGk9ZS5nZXQodCk7aS5vbnN1Y2Nlc3M9KCk9PntuKGkucmVzdWx0KX0saS5vbmVycm9yPXQ9PntyKHQpfX0pKX1hc3luYyBkZWwodCl7Y29uc3QgZT1hd2FpdCB0aGlzLl9nZXRTdG9yZSgicmVhZHdyaXRlIik7cmV0dXJuIG5ldyBQcm9taXNlKCgobixyKT0+e2NvbnN0IGk9ZS5kZWxldGUodCk7aS5vbnN1Y2Nlc3M9KCk9PntuKCl9LGkub25lcnJvcj10PT57cih0KX19KSl9fXV1KEtfLCJkYiIsdm9pZCAwKSx1dShLXywic3RhdGUiLCJpbml0IiksdXUoS18sIl9wcm9taXNlTG9jayIsbmV3IGNsYXNze2NvbnN0cnVjdG9yKHQpe3V1KHRoaXMsImxvY2tpbmdQcm9taXNlIixQcm9taXNlLnJlc29sdmUoKSksdXUodGhpcywibG9ja3MiLDApLHV1KHRoaXMsIm5hbWUiLCIiKSx1dSh0aGlzLCJsb2NrSWQiLHZvaWQgMCksdGhpcy5sb2NrSWQ9Sl8rKyx0JiYodGhpcy5uYW1lPXQpfWdldCBpc0xvY2tlZCgpe3JldHVybiB0aGlzLmxvY2tzPjB9bG9jaygpe2xldCB0O3RoaXMubG9ja3MrPTE7Y29uc3QgZT1uZXcgUHJvbWlzZSgoZT0+e3Q9KCk9Pnt0aGlzLmxvY2tzLT0xLGUoKX19KSksbj10aGlzLmxvY2tpbmdQcm9taXNlLnRoZW4oKCgpPT50KSk7cmV0dXJuIHRoaXMubG9ja2luZ1Byb21pc2U9dGhpcy5sb2NraW5nUHJvbWlzZS50aGVuKCgoKT0+ZSkpLG59fSgiaURCIikpO3ZhciBHXz1haS5pbmNsdWRlcztMbih7dGFyZ2V0OiJBcnJheSIscHJvdG86ITAsZm9yY2VkOmEoKGZ1bmN0aW9uKCl7cmV0dXJuIUFycmF5KDEpLmluY2x1ZGVzKCl9KSl9LHtpbmNsdWRlczpmdW5jdGlvbih0KXtyZXR1cm4gR18odGhpcyx0LGFyZ3VtZW50cy5sZW5ndGg+MT9hcmd1bWVudHNbMV06dm9pZCAwKX19KTt2YXIgVl89U3UoIkFycmF5IiwiaW5jbHVkZXMiKSxZXz0kLFhfPXcscV89ZmUoIm1hdGNoIiksJF89ZnVuY3Rpb24odCl7dmFyIGU7cmV0dXJuIFlfKHQpJiYodm9pZCAwIT09KGU9dFtxX10pPyEhZToiUmVnRXhwIj09PVhfKHQpKX0sUV89VHlwZUVycm9yLHRwPWZlKCJtYXRjaCIpLGVwPUxuLG5wPWZ1bmN0aW9uKHQpe2lmKCRfKHQpKXRocm93IG5ldyBRXygiVGhlIG1ldGhvZCBkb2Vzbid0IGFjY2VwdCByZWd1bGFyIGV4cHJlc3Npb25zIik7cmV0dXJuIHR9LHJwPUcsaXA9cXIsb3A9ZnVuY3Rpb24odCl7dmFyIGU9Ly4vO3RyeXsiLy4vIlt0XShlKX1jYXRjaChuKXt0cnl7cmV0dXJuIGVbdHBdPSExLCIvLi8iW3RdKGUpfWNhdGNoKHIpe319cmV0dXJuITF9LGFwPW0oIiIuaW5kZXhPZik7ZXAoe3RhcmdldDoiU3RyaW5nIixwcm90bzohMCxmb3JjZWQ6IW9wKCJpbmNsdWRlcyIpfSx7aW5jbHVkZXM6ZnVuY3Rpb24odCl7cmV0dXJuISF+YXAoaXAocnAodGhpcykpLGlwKG5wKHQpKSxhcmd1bWVudHMubGVuZ3RoPjE/YXJndW1lbnRzWzFdOnZvaWQgMCl9fSk7dmFyIHNwPVN1KCJTdHJpbmciLCJpbmNsdWRlcyIpLGNwPW90LGxwPVZfLHVwPXNwLGhwPUFycmF5LnByb3RvdHlwZSxmcD1TdHJpbmcucHJvdG90eXBlLGRwPW4oKGZ1bmN0aW9uKHQpe3ZhciBlPXQuaW5jbHVkZXM7cmV0dXJuIHQ9PT1ocHx8Y3AoaHAsdCkmJmU9PT1ocC5pbmNsdWRlcz9scDoic3RyaW5nIj09dHlwZW9mIHR8fHQ9PT1mcHx8Y3AoZnAsdCkmJmU9PT1mcC5pbmNsdWRlcz91cDplfSkpO2Z1bmN0aW9uIF9wKHQsZSl7aWYobnVsbD09dClyZXR1cm57fTt2YXIgbixyLGk9ZnVuY3Rpb24odCxlKXtpZihudWxsPT10KXJldHVybnt9O3ZhciBuPXt9O2Zvcih2YXIgciBpbiB0KWlmKHt9Lmhhc093blByb3BlcnR5LmNhbGwodCxyKSl7aWYoZHAoZSkuY2FsbChlLHIpKWNvbnRpbnVlO25bcl09dFtyXX1yZXR1cm4gbn0odCxlKTtpZihIdSl7dmFyIG89SHUodCk7Zm9yKHI9MDtyPG8ubGVuZ3RoO3IrKyluPW9bcl0sZHAoZSkuY2FsbChlLG4pfHx7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKHQsbikmJihpW25dPXRbbl0pfXJldHVybiBpfWNvbnN0IHBwPVsibWVzc2FnZSJdO3ZhciBncCxtcCx5cD1uZXcgY2xhc3N7Y29uc3RydWN0b3IoKXt1dSh0aGlzLCJuYW1lIiwiTG9uZ1N0cmluZ1JlcG9ydG9yIiksdXUodGhpcywiaW5CdWZmZXIiLFtdKSx1dSh0aGlzLCJvdXRCdWZmZXIiLFtdKX1wdXNoKHQpe3QubWVzc2FnZSYmdGhpcy5pbkJ1ZmZlci5wdXNoKFloKFloKHt9LHQpLHt9LHttZXNzYWdlOntpZDp6dSgpLnNsaWNlKDAsMyksaW5kZXg6MCxlbmQ6ITAsbXNnOnQubWVzc2FnZX19KSl9c3BsaWNlKHQpe2NvbnN0IGU9W107bGV0IG49MDtmb3IoO3RoaXMub3V0QnVmZmVyLmxlbmd0aDspe2NvbnN0IHI9SlNPTi5zdHJpbmdpZnkodGhpcy5vdXRCdWZmZXJbMF0pLmxlbmd0aDtpZighKHI8dCkpYnJlYWs7dC09cixuKz1yLGUucHVzaCh0aGlzLm91dEJ1ZmZlci5zaGlmdCgpKX1mb3IoO3RoaXMuaW5CdWZmZXJbMF0mJnQ+MDspe2NvbnN0IHI9dGhpcy5pbkJ1ZmZlclswXSx7bWVzc2FnZTppfT1yLG89WWgoWWgoe30sX3AocixwcCkpLHt9LHttZXNzYWdlOlloKFloKHt9LGkpLHt9LHttc2c6IiJ9KX0pLGE9SlNPTi5zdHJpbmdpZnkobykubGVuZ3RoLHM9dC1hLGM9WWgoe30sbyk7aWYocz5pLm1zZy5sZW5ndGgpYy5tZXNzYWdlLm1zZz1pLm1zZyx0aGlzLmluQnVmZmVyLnNoaWZ0KCk7ZWxzZXtpZighKHM+PTEwKSlicmVhazt7Y29uc3QgdD1pLm1zZy5zbGljZSgwLHMpO2MubWVzc2FnZS5tc2c9dCxjLm1lc3NhZ2UuZW5kPSExLHRoaXMuaW5CdWZmZXJbMF0ubWVzc2FnZS5tc2c9aS5tc2cuc2xpY2UocyksdGhpcy5pbkJ1ZmZlclswXS5tZXNzYWdlLmluZGV4Kyt9fWNvbnN0IGw9SlNPTi5zdHJpbmdpZnkoYy5tZXNzYWdlKSx1PWwubGVuZ3RoO3QtPXUrYSxuKz11K2EsZS5wdXNoKFloKFloKHt9LGMpLHt9LHttZXNzYWdlOmx9KSl9cmV0dXJue3BheWxvYWQ6ZSxwYXlsb2FkU2l6ZTpufX11bnNoaWZ0KHQpe3RoaXMub3V0QnVmZmVyPXQuY29uY2F0KHRoaXMub3V0QnVmZmVyKX1nZXQoKXtyZXR1cm5bLi4udGhpcy5vdXRCdWZmZXIsLi4udGhpcy5pbkJ1ZmZlci5tYXAoKHQ9PlloKFloKHt9LHQpLHt9LHttZXNzYWdlOkpTT04uc3RyaW5naWZ5KHQubWVzc2FnZSl9KSkpXX1zZXQodCl7dC5mb3JFYWNoKCh0PT57IWZ1bmN0aW9uKHQpe3JldHVybiB2b2lkIDAhPT10LnJlcG9ydF9pZH0odCk/KHQubWVzc2FnZXx8KHQubWVzc2FnZT0iIiksdGhpcy5pbkJ1ZmZlci5wdXNoKFloKFloKHt9LHQpLHt9LHttZXNzYWdlOkpTT04ucGFyc2UodC5tZXNzYWdlKX0pKSk6dGhpcy5vdXRCdWZmZXIucHVzaCh0KX0pKSx0aGlzLm91dEJ1ZmZlcj1bXS5jb25jYXQodGhpcy5vdXRCdWZmZXIpLHRoaXMuaW5CdWZmZXI9W10uY29uY2F0KHRoaXMuaW5CdWZmZXIpfWlzRW1wdHkoKXtyZXR1cm4gMD09PXRoaXMuaW5CdWZmZXIubGVuZ3RoJiYwPT09dGhpcy5vdXRCdWZmZXIubGVuZ3RofX07Y29uc3QgdnA9NWU1LGJwPXtwcm9kdWN0X2xpbmU6InJ0YyIscmVwb3J0X3ZlcnNpb246IjUiLG9zOiJ3ZWIiLHVzZXJfYWdlbnQ6QnUoKT8iIjpudWxsPT09KGdwPW5hdmlnYXRvcil8fHZvaWQgMD09PWdwP3ZvaWQgMDpncC51c2VyQWdlbnQscGxhdGZvcm06IndlYiIscHJvZHVjdDoid2VicnRjIixhcHBfc3RhdGU6ImFjdGl2ZSJ9LHdwPSJMb2dSZXBvcnRvciIsa3A9InVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJih3aW5kb3cubG9jYXRpb24uc2VhcmNoLmluY2x1ZGVzKCJfcnRjX2RlYnVnXyIpfHwobnVsbD09PShtcD13aW5kb3cubG9jYWxTdG9yYWdlKXx8dm9pZCAwPT09bXA/dm9pZCAwOm1wLmdldEl0ZW0oIl9ydGNfZGVidWdfIikpKTtjbGFzcyBTcHtjb25zdHJ1Y3Rvcih0KXt1dSh0aGlzLCJfYnVmZmVyIix2b2lkIDApLHRoaXMuX2J1ZmZlcj1uZXcgS18odCl9YXN5bmMgc2V0KHQsZSl7YXdhaXQgdGhpcy5fYnVmZmVyLnB1dDJTdHJpbmcodCxlKX1hc3luYyBnZXQodCl7dmFyIGU7bGV0IG49W107dHJ5e249YXdhaXQgdGhpcy5fYnVmZmVyLmdldDRTdHJpbmcodCl9Y2F0Y2gocil7fXJldHVybiBudWxsIT09KGU9bikmJnZvaWQgMCE9PWU/ZTpbXX19dmFyIE9wPW5ldyBjbGFzc3tjb25zdHJ1Y3Rvcigpe3V1KHRoaXMsInJlcG9ydENvbW1vbiIsYnApLHV1KHRoaXMsInJlcG9ydElkcyIsbmV3IE1hcCksdXUodGhpcywiZGF0YUJ1ZmZlciIsW10pLHV1KHRoaXMsInJlcG9ydG9yTGlzdCIsW10pLHV1KHRoaXMsImRiQnVmZmVyIix2b2lkIDApLHV1KHRoaXMsInBvc3RpbmciLCExKSx1dSh0aGlzLCJzdWNTZW5kVGltZXIiLHZvaWQgMCksdXUodGhpcywicHJlU3VjVGltZSIsMCksdXUodGhpcywiZXJyU2VuZFRpbWVyIix2b2lkIDApLHV1KHRoaXMsImVyclNlbmREZWxheSIsMTAwKSx1dSh0aGlzLCJfbG9nU2VydmVyVXJsIix2b2lkIDApLHV1KHRoaXMsIl9yZXRyeUNvdW50IiwwKSx1dSh0aGlzLCJfcmVwb3J0TGltaXQiLHZwKSx1dSh0aGlzLCJfZGlzYWJsZVRpbWVvdXQiLCExKSxCdSgpfHwod2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImJlZm9yZXVubG9hZCIsKCgpPT57Y2xlYXJUaW1lb3V0KHRoaXMuZXJyU2VuZFRpbWVyKSxjbGVhclRpbWVvdXQodGhpcy5zdWNTZW5kVGltZXIpLHRoaXMuc2VuZCh2b2lkIDAsITApfSkpLGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCgoKT0+eyJ2aXNpYmxlIj09PWRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZT90aGlzLnNldENvbW1vblN0YXRzKHthcHBfc3RhdGU6ImFjdGl2ZSJ9KToiaGlkZGVuIj09PWRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSYmdGhpcy5zZXRDb21tb25TdGF0cyh7YXBwX3N0YXRlOiJiYWNrZ3JvdW5kIn0pfSkpLGtwJiYod2luZG93Ll9fcnRjX2RlYnVnX3JlcG9ydG9yX189dGhpcykpLEZ1Lm9uKCJVUExPQURfUkVQT1JUX0xJTUlUIiwodD0+e3RoaXMuc2V0UmVwb3J0TGltaXQodCl9KSksRnUub24oIkVOQUJMRV9SRVBPUlRfSURCX0JVRkZFUiIsKHQ9Pnt0JiZ0aGlzLmVuYWJsZUluZGV4ZWREQkJ1ZmZlcigpfSkpLHNldFRpbWVvdXQoKCgpPT57dGhpcy5yZXBvcnRvckxpc3QucHVzaChDcCksdGhpcy5yZXBvcnRvckxpc3QucHVzaCh5cCl9KSl9c2V0VXJsKHQpe3RoaXMuX2xvZ1NlcnZlclVybD10fXNldENvbW1vblN0YXRzKHQpe3RoaXMucmVwb3J0Q29tbW9uPU9iamVjdC5hc3NpZ24odGhpcy5yZXBvcnRDb21tb24sdCl9Z2V0Q29tbW9uU3RhdHMoKXtyZXR1cm4gdGhpcy5yZXBvcnRDb21tb259c2V0UmVwb3J0TGltaXQodCl7dGhpcy5fcmVwb3J0TGltaXQ9TWF0aC5tYXgodCw1ZTQpLHRoaXMuX3JlcG9ydExpbWl0PU1hdGgubWluKHQsNWU1KX1nZXRSZXBvcnRJZCh0KXt2YXIgZTt0PW51bGwhPT0oZT10KSYmdm9pZCAwIT09ZT9lOiJfX2dsb2JhbF9fIix0aGlzLnJlcG9ydElkcy5oYXModCl8fHRoaXMucmVwb3J0SWRzLnNldCh0LDApO2xldCBuPXRoaXMucmVwb3J0SWRzLmdldCh0KTtyZXR1cm4gdm9pZCAwPT09biYmKFRwKCJubyByZXBvcnRJZCBpbiByZXBvcnRJZCBtYXAgd2l0aCBlbmdpbmUtc2Vzc2lvbi1pZCAiLmNvbmNhdCh0KSwwLHt9KSxuPTApLHRoaXMucmVwb3J0SWRzLnNldCh0LG4rMSksbn1wdXNoKHQpe2lmKGFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdJiZhcmd1bWVudHNbMV0pdGhpcy5zZW5kKHQpO2Vsc2V7dmFyIGU7Y29uc3Qgbj1udWxsIT09KGU9dC5lbmdpbmVfc2Vzc2lvbl9pZCkmJnZvaWQgMCE9PWU/ZToiX19nbG9iYWxfXyI7dGhpcy5yZXBvcnRJZHMuaGFzKG4pfHx0aGlzLnJlcG9ydElkcy5zZXQobiwwKSx0aGlzLmRhdGFCdWZmZXIucHVzaCh0KSwhdGhpcy5wb3N0aW5nJiYhdGhpcy5lcnJTZW5kVGltZXImJkRhdGUubm93KCktdGhpcy5wcmVTdWNUaW1lPjJlMyYmKGNsZWFyVGltZW91dCh0aGlzLnN1Y1NlbmRUaW1lciksdGhpcy5zZW5kKCkpfX1lbmFibGVJbmRleGVkREJCdWZmZXIoKXt0aGlzLmRiQnVmZmVyfHwodGhpcy5kYkJ1ZmZlcj1uZXcgU3AoIlJlcG9ydG9yREJCdWZmZXIiKSx0aGlzLmRiQnVmZmVyLmdldCh3cCkudGhlbigodD0+e3QuZm9yRWFjaCgodD0+e3RoaXMucHVzaCh0KX0pKX0pKSx0aGlzLnJlcG9ydG9yTGlzdC5mb3JFYWNoKCh0PT57dmFyIGU7bnVsbD09PShlPXRoaXMuZGJCdWZmZXIpfHx2b2lkIDA9PT1lfHxlLmdldCh0Lm5hbWUpLnRoZW4oKGU9Pnt0LnNldChlKX0pKX0pKSl9YmFja3VwKCl7dHJ5e3ZhciB0O251bGw9PT0odD10aGlzLmRiQnVmZmVyKXx8dm9pZCAwPT09dHx8dC5zZXQoWy4uLnRoaXMuZGF0YUJ1ZmZlcl0sd3ApLHRoaXMucmVwb3J0b3JMaXN0LmZvckVhY2goKHQ9Pnt2YXIgZTtudWxsPT09KGU9dGhpcy5kYkJ1ZmZlcil8fHZvaWQgMD09PWV8fGUuc2V0KFsuLi50LmdldCgpXSx0Lm5hbWUpfSkpfWNhdGNoKGUpe1RwKCJFcnJvciB3aGVuIHNhdmUgbG9nIGludG8gSURCIiwtMSxlKX19dW5zaGlmdCh0KXt0aGlzLmRhdGFCdWZmZXI9dFswXS5jb25jYXQodGhpcy5kYXRhQnVmZmVyKSx0aGlzLnJlcG9ydG9yTGlzdC5mb3JFYWNoKCgoZSxuKT0+e3ZhciByO2UudW5zaGlmdChudWxsIT09KHI9dFtuKzFdKSYmdm9pZCAwIT09cj9yOltdKX0pKX1fc3BsaWNlKCl7bGV0IHQ9ZnVuY3Rpb24odCxlKXtsZXQgbj0wO2ZvcihsZXQgcj0wO3I8dC5sZW5ndGg7cisrKWlmKG4rPUpTT04uc3RyaW5naWZ5KHRbcl0pLmxlbmd0aCxuPmUpcmV0dXJuIHI7cmV0dXJuIHQubGVuZ3RofSh0aGlzLmRhdGFCdWZmZXIsdGhpcy5fcmVwb3J0TGltaXQpOzA9PT10JiZ0aGlzLmRhdGFCdWZmZXIubGVuZ3RoPjAmJih0aGlzLl9yZXBvcnRMaW1pdD1KU09OLnN0cmluZ2lmeSh0aGlzLmRhdGFCdWZmZXJbMF0pLmxlbmd0aCsxMCx0PTEsVHAoInVwZGF0ZSByZXBvcnQgbGltaXQgdG8gIi5jb25jYXQodGhpcy5fcmVwb3J0TGltaXQpLDAsbnVsbCkpO2NvbnN0IGU9dGhpcy5kYXRhQnVmZmVyLnNwbGljZSgwLHQpLG49SlNPTi5zdHJpbmdpZnkoZSkubGVuZ3RoLHI9W2VdO2xldCBpPXRoaXMuX3JlcG9ydExpbWl0LW47cmV0dXJuIHRoaXMucmVwb3J0b3JMaXN0LmZvckVhY2goKHQ9Pntjb25zdHtwYXlsb2FkOmUscGF5bG9hZFNpemU6bn09dC5zcGxpY2UoaSk7ZS5mb3JFYWNoKCh0PT57dmFyIGUsbixyO3ZvaWQgMD09PXQucmVwb3J0X2lkJiYodC5yZXBvcnRfaWQ9dGhpcy5nZXRSZXBvcnRJZCh0LmVuZ2luZV9zZXNzaW9uX2lkKSwhQnUoKSYmd2luZG93Ll9fb25SVENSZXBvcnQmJihudWxsPT09KGU9KG49d2luZG93KS5fX29uUlRDUmVwb3J0KXx8dm9pZCAwPT09ZXx8ZS5jYWxsKG4sbnVsbCE9PShyPXQuZW5naW5lX3Nlc3Npb25faWQpJiZ2b2lkIDAhPT1yP3I6Imdsb2JhbCIsdCx0aGlzLmdldENvbW1vblN0YXRzKCkpKSl9KSksci5wdXNoKGUpLGktPW59KSkscn1hc3luYyBzZW5kKHQsZSl7dGhpcy5iYWNrdXAoKTtjb25zdCBuPXRoaXMucmVwb3J0b3JMaXN0LnJlZHVjZSgoKHQsZSk9PnQmJmUuaXNFbXB0eSgpKSwhMCk7aWYoIXQmJiF0aGlzLmRhdGFCdWZmZXIubGVuZ3RoJiZufHwhdGhpcy5fbG9nU2VydmVyVXJsKXJldHVybjt0fHwodGhpcy5wb3N0aW5nPSEwKTtsZXQgcj1bXTt0fHwocj10aGlzLl9zcGxpY2UoKSk7Y29uc3QgaT1rcCxvPXtkYXRhOnR8fGhmKHIpLmNhbGwociksaGVhZGVyOlloKFloKHt9LHRoaXMucmVwb3J0Q29tbW9uKSx7fSx7aHR0cF9yZXRyeV9jb3VudDp0aGlzLl9yZXRyeUNvdW50fSksZnJvbToid2ViIixvczoid2ViIix2ZXJzaW9uOiIxIn0sYT17bWV0aG9kOiJQT1NUIixib2R5Omk/SlNPTi5zdHJpbmdpZnkobyk6Wl8uZ3ppcChKU09OLnN0cmluZ2lmeShvKSl9O2lmKCF0aGlzLl9kaXNhYmxlVGltZW91dCl0cnl7Y29uc3QgdD1uZXcgQWJvcnRDb250cm9sbGVyO2Euc2lnbmFsPXQuc2lnbmFsLHNldFRpbWVvdXQoKCgpPT57dC5hYm9ydCgpfSksMWU0KX1jYXRjaCh1KXtjb25zb2xlLndhcm4oIkFib3J0Q29udHJvbGxlciBpcyBub3Qgc3VwcG9ydGVkIiksdGhpcy5fZGlzYWJsZVRpbWVvdXQ9ITB9aXx8KGEuaGVhZGVycz17IkNvbnRlbnQtRW5jb2RpbmciOiJnemlwIiwiQ29udGVudC1UeXBlIjoiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PVVURi04In0pO2xldCBzLGMsbD1udWxsO3RyeXtzPWF3YWl0IGZldGNoKHRoaXMuX2xvZ1NlcnZlclVybCxhKSwyMDAhPT1zLnN0YXR1cyYmMzA0IT09cy5zdGF0dXN8fChsPUpTT04ucGFyc2UoYXdhaXQgcy50ZXh0KCkpKX1jYXRjaChoKXtjPWh9dHx8KHRoaXMucG9zdGluZz0hMSksbCYmMD09PWwuU3RhdHVzQ29kZT90fHxlfHx0aGlzLnN1Y1NlbmQoKTooc2V0VGltZW91dCgoKCk9Pnt2YXIgdCxlLG47VHAoInJlcG9ydG9yIHBvc3QgZXJyb3IsIHJlc0pTT046Ii5jb25jYXQobnVsbD09PSh0PWwpfHx2b2lkIDA9PT10P3ZvaWQgMDp0LnRvU3RyaW5nKCksIiBlcnI6IikuY29uY2F0KGMpLG51bGwhPT0oZT1udWxsPT09KG49cyl8fHZvaWQgMD09PW4/dm9pZCAwOm4uc3RhdHVzKSYmdm9pZCAwIT09ZT9lOi0xLGMpfSksMCksdD90aGlzLnNlbmQodCk6KHRoaXMudW5zaGlmdChyKSxlP3RoaXMuc2VuZCgpOnRoaXMuZXJyU2VuZCgpKSl9X2dldERhdGFCdWZmZXJUb3RhbFNpemUoKXtyZXR1cm4gdGhpcy5kYXRhQnVmZmVyLnJlZHVjZSgoKHQsZSk9PnQrSlNPTi5zdHJpbmdpZnkoZSkubGVuZ3RoKSwwKX1zdWNTZW5kKCl7dGhpcy5lcnJTZW5kRGVsYXk9MTAwLHRoaXMuX3JldHJ5Q291bnQ9MCx0aGlzLnByZVN1Y1RpbWU9RGF0ZS5ub3coKTtjb25zdCB0PXRoaXMuX2dldERhdGFCdWZmZXJUb3RhbFNpemUoKT4xZTY/MWUzOjJlMzt0aGlzLnN1Y1NlbmRUaW1lcj1zZXRUaW1lb3V0KCgoKT0+dGhpcy5zZW5kKCkpLHQpfWVyclNlbmQoKXt0aGlzLmVyclNlbmRUaW1lcj1zZXRUaW1lb3V0KCgoKT0+e3RoaXMuc2VuZCgpLGRlbGV0ZSB0aGlzLmVyclNlbmRUaW1lcn0pLHRoaXMuZXJyU2VuZERlbGF5KSx0aGlzLmVyclNlbmREZWxheSo9Mix0aGlzLl9yZXRyeUNvdW50Kyt9fTtjbGFzcyB4cHtjb25zdHJ1Y3Rvcih0KXt1dSh0aGlzLCJfcHJlVGltZSIsRGF0ZS5ub3coKSksdXUodGhpcywiX29uZTJvbmVOdW0iLDApLHV1KHRoaXMsIl9vbmUybWFueU51bSIsMCksdXUodGhpcywiX29uZTJvbmVNc2dDYWNoZSIsbmV3IE1hcCksdXUodGhpcywiX29uZTJtYW55TXNnQ2FjaGUiLG5ldyBNYXApLHV1KHRoaXMsInJvb21JZCIsIiIpLHV1KHRoaXMsInVzZXJJZCIsIiIpLHV1KHRoaXMsInJ0c1Nlc3Npb25JZCIsIiIpLHV1KHRoaXMsImxvZ2dlciIsdm9pZCAwKSx1dSh0aGlzLCJzZXJ2ZXJVcmwiLCJzZXJ2ZXIiKSx0aGlzLmlkPXQsdGhpcy5sb2dnZXI9bmV3IEhwKCJNZXNzYWdlUmVwb3J0b3IiLDEpfW5lZWRSZXBvcnQodCl7cmV0dXJuISF4cC5jb25maWcmJihEYXRlLm5vdygpLXRoaXMuX3ByZVRpbWU+PTM2ZTUmJih0aGlzLl9wcmVUaW1lPURhdGUubm93KCksdGhpcy5fb25lMm9uZU51bT0wLHRoaXMuX29uZTJtYW55TnVtPTApLCJvbmUyb25lIj09PXQmJnRoaXMuX29uZTJvbmVOdW08eHAuY29uZmlnLm1heF9vbmUyb25lX2ZwdF9wZXJfaG91ciYmTWF0aC5yYW5kb20oKTw9eHAuY29uZmlnLm9uZTJvbmVfZnB0X3JhdGlvLzEwMHx8Im9uZTJtYW55Ij09PXQmJnRoaXMuX29uZTJtYW55TnVtPHhwLmNvbmZpZy5tYXhfb25lMm1hbnlfZnB0X3Blcl9ob3VyJiZNYXRoLnJhbmRvbSgpPD14cC5jb25maWcub25lMm1hbnlfZnB0X3JhdGlvLzEwMCl9Y2FjaGVQMlBNc2codCl7dmFyIGU7dGhpcy5fb25lMm9uZU1zZ0NhY2hlLnNldCh0Lm1zZ19pZCxZaCh7Y29uZmlnX3ZlcnNpb246KG51bGw9PT0oZT14cC5jb25maWcpfHx2b2lkIDA9PT1lP3ZvaWQgMDplLnZlcnNpb24pfHwiIn0sdCkpfXVwZGF0ZVAyUE1zZyh0LGUpe2NvbnN0IG49dGhpcy5fb25lMm9uZU1zZ0NhY2hlLmdldCh0KTtuJiZ0aGlzLl9vbmUyb25lTXNnQ2FjaGUuc2V0KHQsWWgoWWgoe30sbiksZSkpfWNhY2hlQ3VzdG9tTXNnKHQpe3ZhciBlO3RoaXMuX29uZTJtYW55TXNnQ2FjaGUuc2V0KHQubXNnX2lkLFloKHtjb25maWdfdmVyc2lvbjoobnVsbD09PShlPXhwLmNvbmZpZyl8fHZvaWQgMD09PWU/dm9pZCAwOmUudmVyc2lvbil8fCIifSx0KSl9dXBkYXRlT25lMk1hbnlNc2codCxlKXtjb25zdCBuPXRoaXMuX29uZTJtYW55TXNnQ2FjaGUuZ2V0KHQpO24mJnRoaXMuX29uZTJtYW55TXNnQ2FjaGUuc2V0KHQsWWgoWWgoe30sbiksZSkpfXJlcG9ydFAyUE1zZyh0KXtjb25zdCBlPXRoaXMuX29uZTJvbmVNc2dDYWNoZS5nZXQodCk7dmFyIG47ZSYmKHRoaXMubG9nZ2VyLmluZm8oInJlcG9ydFAyUE1zZyIsZS50eXBlLEpTT04uc3RyaW5naWZ5KGUpKSxudWxsPT09KG49THAodGhpcy5pZCkpfHx2b2lkIDA9PT1ufHxuLnJlcG9ydCgicnRzX21lc3NhZ2UiLGUpKX1yZXBvcnRPbmUyTWFueU1zZyh0KXtjb25zdCBlPXRoaXMuX29uZTJtYW55TXNnQ2FjaGUuZ2V0KHQpO3ZhciBuO2UmJih0aGlzLmxvZ2dlci5pbmZvKCJyZXBvcnRPbmUyTWFueU1zZyIsZS50eXBlLEpTT04uc3RyaW5naWZ5KGUpKSxudWxsPT09KG49THAodGhpcy5pZCkpfHx2b2lkIDA9PT1ufHxuLnJlcG9ydCgicnRzX21lc3NhZ2UiLGUpKX1yZXBvcnRNc2dSZWN2KHQpe3ZhciBlLG47dC5jb25maWdfdmVyc2lvbj0obnVsbD09PShlPXhwLmNvbmZpZyl8fHZvaWQgMD09PWU/dm9pZCAwOmUudmVyc2lvbil8fCIiLHRoaXMubG9nZ2VyLmluZm8oInJlcG9ydE1zZ1JlY3YiLHQudHlwZSxKU09OLnN0cmluZ2lmeSh0KSksbnVsbD09PShuPUxwKHRoaXMuaWQpKXx8dm9pZCAwPT09bnx8bi5yZXBvcnQoInJ0c19tZXNzYWdlIix0KX1kZXN0cm95KCl7dGhpcy5fb25lMm1hbnlOdW09MCx0aGlzLl9vbmUyb25lTnVtPTAsdGhpcy5fb25lMm1hbnlNc2dDYWNoZS5jbGVhcigpLHRoaXMuX29uZTJvbmVNc2dDYWNoZS5jbGVhcigpLHRoaXMuX3ByZVRpbWU9RGF0ZS5ub3coKSx0aGlzLnJvb21JZD0iIix0aGlzLnVzZXJJZD0iIix0aGlzLnJ0c1Nlc3Npb25JZD0iIn19dXUoeHAsImNvbmZpZyIsdm9pZCAwKTtjb25zdCBBcD1uZXcgY2xhc3N7Y29uc3RydWN0b3IodCl7dXUodGhpcywibW9kaWZ5SWRzIix7cHJlX2Nvbm5lY3Rpb246ITF9KSx0aGlzLmlkPXR9cmVwb3J0KHQsZSxuKXtjb25zdCByPVloKFloKFloKHtldmVudF9rZXk6dCxydGNfdGltZXN0YW1wOkRhdGUubm93KCl9LHRoaXMubW9kaWZ5SWRzKSxlKSx7fSx7cmVwb3J0X2lkOk9wLmdldFJlcG9ydElkKHRoaXMubW9kaWZ5SWRzLmVuZ2luZV9zZXNzaW9uX2lkKX0pO3ZhciBpLG87KCJvYmplY3QiPT10eXBlb2YgbiYmT2JqZWN0LmtleXMobikubGVuZ3RoPjAmJihyLmNvbW1vbl9leHRyYV9pbmZvPUpTT04uc3RyaW5naWZ5KG4pKSxPYmplY3Qua2V5cyhyKS5mb3JFYWNoKCh0PT57dm9pZCAwIT09clt0XSYmIiIhPT1yW3RdfHxkZWxldGUgclt0XX0pKSwhQnUoKSYmd2luZG93Ll9fb25SVENSZXBvcnQpJiYobnVsbD09PShpPShvPXdpbmRvdykuX19vblJUQ1JlcG9ydCl8fHZvaWQgMD09PWl8fGkuY2FsbChvLHRoaXMubW9kaWZ5SWRzLmVuZ2luZV9zZXNzaW9uX2lkLHIsT3AuZ2V0Q29tbW9uU3RhdHMoKSkpOyJVVCIhPT17fS5WSVRFX1RFU1QmJk9wLnB1c2gocil9cmVwb3J0TG9nKHQpe2NvbnN0IGU9WWgoWWgoe2V2ZW50X2tleToicnRjX2ludm9rZV9zdGF0dXMiLHNka19hcGlfbmFtZToiY29uc29sZV9sb2ciLHJ0Y190aW1lc3RhbXA6RGF0ZS5ub3coKX0sdGhpcy5tb2RpZnlJZHMpLHt9LHttZXNzYWdlOnR9KTtDcC5wdXNoKGUpfXJlcG9ydExvbmdTdHJpbmcodCxlKXtjb25zdCBuPVloKFloKHtldmVudF9rZXk6InJ0Y19pbnZva2Vfc3RhdHVzIixzZGtfYXBpX25hbWU6InNka19sb25nX3N0cmluZ18iLmNvbmNhdCh0KSxydGNfdGltZXN0YW1wOkRhdGUubm93KCl9LHRoaXMubW9kaWZ5SWRzKSx7fSx7bWVzc2FnZTplfSk7eXAucHVzaChuKX1zZXQodCl7dGhpcy5tb2RpZnlJZHM9T2JqZWN0LmFzc2lnbih0aGlzLm1vZGlmeUlkcyx0KX1kZXN0cm95KCl7fX0oImdsb2JhbCIpLFRwPSh0LGUsbik9PntBcC5yZXBvcnQoInJ0Y19lcnJvciIse21lc3NhZ2U6dCxlcnJvcl9jb2RlOmV9LG4pfTtjb25zdCBFcD1uZXcgTWFwLExwPXQ9PkVwLmdldCh0KSx6cD0idW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdyYmd2luZG93LmxvY2F0aW9uLnNlYXJjaC5pbmNsdWRlcygiX3J0Y191cGxvYWRfY29uc29sZV8iKTtmdW5jdGlvbiBCcCh0LGUpe3JldHVybiB0Lm1hcCgodD0+e2xldCBuPSIiO3RyeXtpZigic3RyaW5nIj09dHlwZW9mIHQpcmV0dXJuIHQ7aWYodm9pZCAwPT09dClyZXR1cm4idW5kZWZpbmVkIjtpZihudWxsPT09dClyZXR1cm4ibnVsbCI7aWYodCBpbnN0YW5jZW9mIE1lZGlhU3RyZWFtVHJhY2spcmV0dXJuIEl1KHQpO2lmKHQgaW5zdGFuY2VvZiBNZWRpYVN0cmVhbSlyZXR1cm4gbnVsbD09KGk9dCk/InVuZGVmaW5lZCB8IG51bGwiOiJzdHJpbmciPT10eXBlb2YgaT9pOkpTT04uc3RyaW5naWZ5KHtpZDppLmlkLGFjdGl2ZTppLmFjdGl2ZX0pO2lmKHQgaW5zdGFuY2VvZiBSVENSdHBTZW5kZXIpcmV0dXJuIEN1KHQpO2lmKHQgaW5zdGFuY2VvZiBSVENSdHBSZWNlaXZlcilyZXR1cm4gTnUodCk7aWYodCBpbnN0YW5jZW9mIFJUQ1J0cFRyYW5zY2VpdmVyKXJldHVybiBudWxsPT0ocj10KT8idW5kZWZpbmVkIHwgbnVsbCI6InN0cmluZyI9PXR5cGVvZiByP3I6SlNPTi5zdHJpbmdpZnkoe2N1cnJlbnREaXJlY3Rpb246ci5jdXJyZW50RGlyZWN0aW9uLGRpcmVjdGlvbjpyLmRpcmVjdGlvbixtaWQ6ci5taWQsc3RvcHBlZDpyLnN0b3BwZWQscmVjZWl2ZXI6TnUoci5yZWNlaXZlciksc2VuZGVyOkN1KHIuc2VuZGVyKX0pO249SlNPTi5zdHJpbmdpZnkodCl9Y2F0Y2gobyl7bj10LnRvU3RyaW5nKCl9dmFyIHIsaTtyZXR1cm4gbiYmbi5sZW5ndGg+PWUmJihuPW4uc2xpY2UoMCxlKSksbn0pKS5qb2luKCIsICIpfXZhciBJcCxDcD1uZXcgY2xhc3N7Y29uc3RydWN0b3IoKXt1dSh0aGlzLCJuYW1lIiwiQ29uc29sZVJlcG9ydG9yIiksdXUodGhpcywiX3V1aWQiLCIiLmNvbmNhdChNYXRoLmZsb29yKDg5OSpNYXRoLnJhbmRvbSgpKSsxMDApKSx1dSh0aGlzLCJfY29uc29sZVJlcG9ydElkIiwwKSx1dSh0aGlzLCJfZW5naW5lUmVwb3J0SWRNYXAiLG5ldyBNYXApLHV1KHRoaXMsIl9lbmFibGVkIiwiTlVMTCIpLHV1KHRoaXMsIl9jb25zb2xlQ3V0TGVuZ3RoIixGdS5nZXRQYXJhbWV0ZXIoIlVQTE9BRF9DT05TT0xFX0xFTkdUSF9DVVQiKSksdXUodGhpcywiYnVmZmVyIixbXSksenAmJnNldFRpbWVvdXQoKCgpPT57dGhpcy5zd2l0Y2hPbigpfSksMCksRnUub24oIlVQTE9BRF9DT05TT0xFX09OIiwodD0+e3Q/dGhpcy5zd2l0Y2hPbigpOnRoaXMudHVybk9mZigpfSkpLEZ1Lm9uKCJVUExPQURfQ09OU09MRV9MRU5HVEhfQ1VUIiwodD0+e3RoaXMuX2NvbnNvbGVDdXRMZW5ndGg9dH0pKX1nZXQgZW5hYmxlZCgpe3JldHVybiJPRkYiIT09dGhpcy5fZW5hYmxlZH1zd2l0Y2hPbigpeyJOVUxMIj09PXRoaXMuX2VuYWJsZWQmJihjb25zb2xlLmxvZygiW0xvZ2dlclJlcG9ydG9yLmNvbnN0cnVjdG9yXSBjb25zb2xlIHVwbG9hZCBzd2l0Y2ggT04iKSx0aGlzLl9lbmFibGVkPSJPTiIpfXR1cm5PZmYoKXsiTlVMTCI9PT10aGlzLl9lbmFibGVkJiYoY29uc29sZS5sb2coIltMb2dnZXJSZXBvcnRvci5jb25zdHJ1Y3Rvcl0gY29uc29sZSB1cGxvYWQgc3dpdGNoIE9GRiIpLHRoaXMuX2VuYWJsZWQ9Ik9GRiIsdGhpcy5idWZmZXI9W10pfWdldEVuZ2luZUNvbnNvbGVJZCh0KXt2YXIgZTtjb25zdCBuPW51bGwhPT0oZT10aGlzLl9lbmdpbmVSZXBvcnRJZE1hcC5nZXQodCkpJiZ2b2lkIDAhPT1lP2U6MDtyZXR1cm4gdGhpcy5fZW5naW5lUmVwb3J0SWRNYXAuc2V0KHQsbisxKSxufXJlcG9ydCh0LGUsbixyLGksbyxhLHMsYyl7aWYoIk9GRiI9PT10aGlzLl9lbmFibGVkKXJldHVybjtjb25zdCBsPUxwKGUpLHU9dGhpcy5fY29uc29sZVJlcG9ydElkKyssaD10aGlzLmdldEVuZ2luZUNvbnNvbGVJZChlKSxmPUJwKGMsdGhpcy5fY29uc29sZUN1dExlbmd0aCksZD1bLi4uY10sXz0iIi5jb25jYXQocykucmVwbGFjZSgvJW98JXMvZ2ksKCgpPT5CcChbZC5zaGlmdCgpXSx0aGlzLl9jb25zb2xlQ3V0TGVuZ3RoKSkpLHA9IlsiLmNvbmNhdCh0aGlzLl91dWlkLCItIikuY29uY2F0KHUsIl1bIikuY29uY2F0KGUsIi0iKS5jb25jYXQoaCwiXS0iKS5jb25jYXQobiwiLSIpLmNvbmNhdCh0LCJbIikuY29uY2F0KHIsIl0iKS5jb25jYXQoaSwiWyIpLmNvbmNhdChvLCIuIikuY29uY2F0KGEsIl0gIikuY29uY2F0KF8sIiAiKS5jb25jYXQoZik7dmFyIGc7bD9sLnJlcG9ydExvZyhwKTooZz1wLEFwLnJlcG9ydExvZyhnKSl9cHVzaCh0KXsiT0ZGIiE9PXRoaXMuX2VuYWJsZWQmJnRoaXMuYnVmZmVyLnB1c2godCl9c3BsaWNlKHQpe2lmKCJPTiIhPT10aGlzLl9lbmFibGVkKXJldHVybntwYXlsb2FkOltdLHBheWxvYWRTaXplOjB9O2NvbnN0e2luZGV4OmUsc2l6ZTpufT1mdW5jdGlvbih0LGUpe2xldCBuPTA7Zm9yKGxldCByPTA7cjx0Lmxlbmd0aDtyKyspe2NvbnN0IGk9SlNPTi5zdHJpbmdpZnkodFtyXSkubGVuZ3RoO2lmKG4rPWksbj5lKXJldHVybntpbmRleDpyLHNpemU6bi1pfX1yZXR1cm57aW5kZXg6dC5sZW5ndGgsc2l6ZTpufX0odGhpcy5idWZmZXIsdCk7cmV0dXJue3BheWxvYWQ6dGhpcy5idWZmZXIuc3BsaWNlKDAsZSkscGF5bG9hZFNpemU6bn19dW5zaGlmdCh0KXt0aGlzLmJ1ZmZlcj10LmNvbmNhdCh0aGlzLmJ1ZmZlcil9Z2V0KCl7cmV0dXJuIHRoaXMuYnVmZmVyfXNldCh0KXt0aGlzLmJ1ZmZlcj10LmNvbmNhdCh0aGlzLmJ1ZmZlcil9aXNFbXB0eSgpe3JldHVybiJPRkYiPT09dGhpcy5fZW5hYmxlZHx8MD09PXRoaXMuYnVmZmVyLmxlbmd0aH19O2NvbnN0IE5wPSJbVkVSVENdIixScD0iIzAwNTBiMyIsanA9e0RFQlVHOiJyZ2JhKDAsIDAsIDAsIDApIiwiIElORk8iOiJyZ2JhKDkzLCAxNzMsIDIyNiwgMCkiLCIgV0FSTiI6InJnYmEoMjU1LCAxMTksIDAsIDAuMykiLEVSUk9SOiJyZ2JhKDI1NSwgMCwgMCwgMC4zKSIsIiBTVUNDIjoicmdiYSgwLCAxMTksIDAsIDAuMykifSxEcD0idW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdyYmKHdpbmRvdy5sb2NhdGlvbi5zZWFyY2guaW5jbHVkZXMoIl9ydGNfZGVidWdfIil8fChudWxsPT09KElwPXdpbmRvdy5sb2NhbFN0b3JhZ2UpfHx2b2lkIDA9PT1JcD92b2lkIDA6SXAuZ2V0SXRlbSgiX3J0Y19kZWJ1Z18iKSkpO2NvbnN0IFBwPSgpPT57Y29uc3QgdD1uZXcgRGF0ZTtyZXR1cm4iIi5jb25jYXQodC50b1RpbWVTdHJpbmcoKS5zcGxpdCgiICIpWzBdLCI6IikuY29uY2F0KHQuZ2V0TWlsbGlzZWNvbmRzKCkudG9TdHJpbmcoKS5wYWRTdGFydCgzLCIwIikpfTt2YXIgVXAsRnAsTXAsWnAsSnAsSHA9Y2xhc3N7Y29uc3RydWN0b3IodCxlKXtsZXQgbj1hcmd1bWVudHMubGVuZ3RoPjImJnZvaWQgMCE9PWFyZ3VtZW50c1syXT9hcmd1bWVudHNbMl06Imdsb2JhbCI7dXUodGhpcywiaW5kZW50Iix2b2lkIDApLHV1KHRoaXMsIm1vZHVsZSIsdm9pZCAwKSx1dSh0aGlzLCJfZW5naW5lSWQiLHZvaWQgMCksdGhpcy5tb2R1bGU9dCx0aGlzLmluZGVudD1lLHRoaXMuX2VuZ2luZUlkPW59X3ByaW50KHQsZSl7Zm9yKHZhciBuPWFyZ3VtZW50cy5sZW5ndGgscj1uZXcgQXJyYXkobj4yP24tMjowKSxpPTI7aTxuO2krKylyW2ktMl09YXJndW1lbnRzW2ldO2NvbnN0IG89ci5zaGlmdCgpO3RyeXtjb25zdCB0PVsuLi5yXSxuPSIiLmNvbmNhdChvKS5yZXBsYWNlKC8lby9naSwoKCk9Pntjb25zdCBlPXQuc2hpZnQoKTtyZXR1cm4gSlNPTi5zdHJpbmdpZnkoZSl9KSk7RHUuc2V0KCIiLmNvbmNhdChOcCwiWyIpLmNvbmNhdCh0aGlzLm1vZHVsZSwiLiIpLmNvbmNhdChlLCJdICIpLmNvbmNhdChuLCIgIikuY29uY2F0KHQubWFwKCh0PT5KU09OLnN0cmluZ2lmeSh0KSkpLmpvaW4oIiwgIikpKX1jYXRjaChlZyl7fWxldCBhPSIiO2ZvcihsZXQgYz0wO2M8dGhpcy5pbmRlbnQ7YysrKWErPSIgICAgIjtjb25zdCBzPVBwKCk7Q3AucmVwb3J0KE5wLHRoaXMuX2VuZ2luZUlkLHMsdCxhLHRoaXMubW9kdWxlLGUsbyxyKSxEcCYmY29uc29sZS5sb2coIiVjIi5jb25jYXQocywiLSIpLmNvbmNhdChOcCwiJWNbIikuY29uY2F0KHQsIl0lYyIpLmNvbmNhdChhLCJbIikuY29uY2F0KHRoaXMubW9kdWxlLCIuIikuY29uY2F0KGUsIl0gIikuY29uY2F0KG8pLCJjb2xvcjoiLmNvbmNhdChScCwiOyIpLCJiYWNrZ3JvdW5kLWNvbG9yOiIuY29uY2F0KGpwW3RdLCI7IiksImNvbG9yOiIuY29uY2F0KFJwLCI7IiksLi4ucil9cHJpbnQodCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZT4xP2UtMTowKSxyPTE7cjxlO3IrKyluW3ItMV09YXJndW1lbnRzW3JdO3RoaXMuX3ByaW50KCIgSU5GTyIsdCwuLi5uKX1kZWJ1Zyh0KXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlPjE/ZS0xOjApLHI9MTtyPGU7cisrKW5bci0xXT1hcmd1bWVudHNbcl07dGhpcy5fcHJpbnQoIkRFQlVHIix0LC4uLm4pfWluZm8odCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZT4xP2UtMTowKSxyPTE7cjxlO3IrKyluW3ItMV09YXJndW1lbnRzW3JdO3RoaXMuX3ByaW50KCIgSU5GTyIsdCwuLi5uKX13YXJuKHQpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGU+MT9lLTE6MCkscj0xO3I8ZTtyKyspbltyLTFdPWFyZ3VtZW50c1tyXTt0aGlzLl9wcmludCgiIFdBUk4iLHQsLi4ubil9ZXJyb3IodCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZT4xP2UtMTowKSxyPTE7cjxlO3IrKyluW3ItMV09YXJndW1lbnRzW3JdO3RoaXMuX3ByaW50KCJFUlJPUiIsdCwuLi5uKX1zdWNjZXNzKHQpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGU+MT9lLTE6MCkscj0xO3I8ZTtyKyspbltyLTFdPWFyZ3VtZW50c1tyXTt0aGlzLl9wcmludCgiIFNVQ0MiLHQsLi4ubil9fTtuZXcgVGV4dERlY29kZXIsbmV3IFRleHRFbmNvZGVyLCJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93JiYod2luZG93LmxvY2F0aW9uLnNlYXJjaC5pbmNsdWRlcygiX3J0Y19kZWJ1Z18iKXx8bnVsbCE9PShVcD13aW5kb3cubG9jYWxTdG9yYWdlKSYmdm9pZCAwIT09VXAmJlVwLmdldEl0ZW0oIl9ydGNfZGVidWdfIikpO2NvbnN0IFdwPSgpPT4idW5kZWZpbmVkIj09dHlwZW9mIHdpbmRvdyxLcD1XcCgpPyIiOndpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50O2Z1bmN0aW9uIEdwKCl7bGV0IHQ9Im5vbmUiO3JldHVybiBXcCgpfHwobnVsbCE9PUtwLm1hdGNoKCJGaXJlZm94Iik/dD0ibW96aWxsYSI6bnVsbCE9PUtwLm1hdGNoKCJDaHJvbWUiKT8odD0iY2hyb21lLXN0YWJsZSIsbnVsbCE9PUtwLm1hdGNoKCJFbGVjdHJvbiIpJiYodD0iZWxlY3Ryb24iKSk6KG51bGwhPT1LcC5tYXRjaCgiU2FmYXJpIil8fG51bGwhPT1LcC5tYXRjaCgiQXBwbGVXZWJLaXQiKSkmJih0PSJzYWZhcmkiKSksdH1HcCgpO2NvbnN0IFZwPSJzYWZhcmkiPT09R3AoKTtHcCgpLCFXcCgpJiZLcC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCJtb2JpbGUiKTtjb25zdCBZcD0hV3AoKSYmKG51bGw9PT0oRnA9S3AubWF0Y2goL3ZlcnNpb25cLyhcZCspL2kpKXx8dm9pZCAwPT09RnA/dm9pZCAwOkZwWzFdKTt2YXIgWHA7VnAmJllwJiYobnVsbD09PShYcD1uYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC92ZXJzaW9uXC8oXGQrXC5cZCspL2kpKXx8dm9pZCAwPT09WHB8fFhwWzFdKTshV3AoKSYmKG51bGw9PT0oTXA9S3AubWF0Y2goL0ZpcmVmb3hcLyhcZCspL2kpKXx8dm9pZCAwPT09TXB8fE1wWzFdKSwhV3AoKSYmKG51bGw9PT0oWnA9S3AubWF0Y2goLyAoW1xkX10rKSBsaWtlIE1hYyBPUyBYL2kpKXx8dm9pZCAwPT09WnB8fG51bGw9PT0oWnA9WnBbMV0pfHx2b2lkIDA9PT1acHx8WnAuc3BsaXQoIl8iKS5tYXAoKHQ9PnBhcnNlSW50KHQpKSkpLCFXcCgpJiYobnVsbD09PShKcD1LcC5tYXRjaCgvQ2hyb21lXC8oXGQrKS9pKSl8fHZvaWQgMD09PUpwfHxKcFsxXSk7Y29uc3QgcXA9bmV3IEhwKCJKb2luUm9vbUNvbmZpZyIsMCk7Y2xhc3MgJHB7Y29uc3RydWN0b3IodCl7dXUodGhpcywiX3VzZVRjcEFmdGVySm9pblRpbWVvdXQiLCRwLkRFRkFVTFRfQ09ORi51c2VUY3BBZnRlckpvaW5UaW1lb3V0KSx1dSh0aGlzLCJfam9pbldpdGhUY3BPbmx5IiwkcC5ERUZBVUxUX0NPTkYuam9pbldpdGhUY3BPbmx5KSx1dSh0aGlzLCJfam9pbldpdGhUY3BPbmx5RGVsYXkiLCRwLkRFRkFVTFRfQ09ORi5qb2luV2l0aFRjcE9ubHlEZWxheSksdXUodGhpcywiX2JsYWNrQnJvd3NlclJlZ2V4TGlzdCIsW10pLHRoaXMuX2VuZ2luZUlkPXQsbG9jYXRpb24uc2VhcmNoLmluZGV4T2YoIl9fcnRjX3RjcF9vbmx5X18iKT4tMSYmKHRoaXMuX2pvaW5XaXRoVGNwT25seT0hMCx0aGlzLl9qb2luV2l0aFRjcE9ubHlEZWxheT0wKSx0aGlzLl9yZXBvcnQoKX1zdGF0aWMgc2V0RGVmYXVsQ29uZih0KXtsZXR7dXNlVGNwQWZ0ZXJKb2luVGltZW91dDplLGpvaW5XaXRoVGNwT25seTpuLGpvaW5XaXRoVGNwT25seURlbGF5OnJ9PXQ7cmV0dXJuImJvb2xlYW4iPT10eXBlb2YgZSYmKCRwLkRFRkFVTFRfQ09ORi51c2VUY3BBZnRlckpvaW5UaW1lb3V0PWUpLCJib29sZWFuIj09dHlwZW9mIG4mJigkcC5ERUZBVUxUX0NPTkYuam9pbldpdGhUY3BPbmx5PW4pLCJudW1iZXIiPT10eXBlb2YgciYmKCRwLkRFRkFVTFRfQ09ORi5qb2luV2l0aFRjcE9ubHlEZWxheT1NYXRoLm1heCgwLHIpKSwkcC5ERUZBVUxUX0NPTkZ9Z2V0IHVzZVRjcEFmdGVySm9pblRpbWVvdXQoKXtyZXR1cm4gdGhpcy5fdXNlVGNwQWZ0ZXJKb2luVGltZW91dH1nZXQgdXNlVGNwSm9pbigpe3JldHVybiB0aGlzLl9qb2luV2l0aFRjcE9ubHl9Z2V0IHVzZVRjcEpvaW5EZWxheSgpe3JldHVybiB0aGlzLl9qb2luV2l0aFRjcE9ubHlEZWxheX1pc0JsYWNrQnJvd2VyKCl7cmV0dXJuIHRoaXMuX2JsYWNrQnJvd3NlclJlZ2V4TGlzdC5maW5kKCh0PT5uZXcgUmVnRXhwKHQpLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkpKX1zZXRTZXJ2ZXJDb25maWcodCl7dmFyIGUsbixyO2xldCBpPSExOyJib29sZWFuIj09dHlwZW9mKG51bGw9PXR8fG51bGw9PT0oZT10LnVzZV90Y3BfYWZ0ZXJfam9pbl90aW1lb3V0KXx8dm9pZCAwPT09ZT92b2lkIDA6ZS5lbmFibGUpJiYodGhpcy5fdXNlVGNwQWZ0ZXJKb2luVGltZW91dD10LnVzZV90Y3BfYWZ0ZXJfam9pbl90aW1lb3V0LmVuYWJsZSxpPSEwKSwiYm9vbGVhbiI9PXR5cGVvZihudWxsPT10fHxudWxsPT09KG49dC5qb2luX3dpdGhfdGNwX29ubHkpfHx2b2lkIDA9PT1uP3ZvaWQgMDpuLmVuYWJsZSkmJih0aGlzLl9qb2luV2l0aFRjcE9ubHk9dC5qb2luX3dpdGhfdGNwX29ubHkuZW5hYmxlLGk9ITApLCJudW1iZXIiPT10eXBlb2YobnVsbD09dHx8bnVsbD09PShyPXQuam9pbl93aXRoX3RjcF9vbmx5KXx8dm9pZCAwPT09cj92b2lkIDA6ci5kZWxheV9tcykmJih0aGlzLl9qb2luV2l0aFRjcE9ubHlEZWxheT10LmpvaW5fd2l0aF90Y3Bfb25seS5kZWxheV9tcyxpPSEwKSx0JiZBcnJheS5pc0FycmF5KHQuYmxhY2tfYnJvd3Nlcl9yZWdleF9saXN0KSYmKHRoaXMuX2JsYWNrQnJvd3NlclJlZ2V4TGlzdD10LmJsYWNrX2Jyb3dzZXJfcmVnZXhfbGlzdCxpPSEwKSxpJiZ0aGlzLl9yZXBvcnQoKX10b1N0cmluZygpe3JldHVybiBKU09OLnN0cmluZ2lmeSh7dXNlX3RjcF9hZnRlcl9qb2luX3RpbWVvdXQ6dGhpcy5fdXNlVGNwQWZ0ZXJKb2luVGltZW91dCxqb2luX3dpdGhfdGNwX29ubHk6dGhpcy5fam9pbldpdGhUY3BPbmx5LGpvaW5fd2l0aF90Y3Bfb25seV9kZWxheTp0aGlzLl9qb2luV2l0aFRjcE9ubHlEZWxheSxibGFja19icm93c2VyX3JlZ2V4X2xpc3Q6dGhpcy5fYmxhY2tCcm93c2VyUmVnZXhMaXN0fSl9X3JlcG9ydCgpe3FwLnByaW50KCJfcmVwb3J0Iix0aGlzLnRvU3RyaW5nKCkpLGZ1bmN0aW9uKHQsZSxuKXt2YXIgcjtsZXQgaT1hcmd1bWVudHMubGVuZ3RoPjMmJnZvaWQgMCE9PWFyZ3VtZW50c1szXT9hcmd1bWVudHNbM106MCxvPWFyZ3VtZW50cy5sZW5ndGg+NCYmdm9pZCAwIT09YXJndW1lbnRzWzRdP2FyZ3VtZW50c1s0XToiIixhPWFyZ3VtZW50cy5sZW5ndGg+NT9hcmd1bWVudHNbNV06dm9pZCAwO251bGw9PT0ocj1McCh0KSl8fHZvaWQgMD09PXJ8fHIucmVwb3J0KCJydGNfaW52b2tlX3N0YXR1cyIse3Nka19hcGlfbmFtZTplLG1lc3NhZ2U6bixlcnJvcl9jb2RlOmksc3RyZWFtX2lkOm8sZWxhcHNlOjB9LGEpfSh0aGlzLl9lbmdpbmVJZCwid2ViX2pvaW5fcm9vbV9jb25maWciLHRoaXMudG9TdHJpbmcoKSl9fXV1KCRwLCJERUZBVUxUX0NPTkYiLHt1c2VUY3BBZnRlckpvaW5UaW1lb3V0OiEwLGpvaW5XaXRoVGNwT25seTohMSxqb2luV2l0aFRjcE9ubHlEZWxheTo1ZTN9KTt2YXIgUXA9KHQ9Pih0W3QuTk9ORT0wXT0iTk9ORSIsdCkpKFFwfHx7fSk7Y29uc3QgdGc9Il9fcnRjX2FjY2Vzc0RvbWFpbnNfXyIuc3BsaXQoIiwiKTsiX19ydGNfY29uZmlnRG9tYWluc19fIi5zcGxpdCgiLCIpO3RnLm1hcCgoZnVuY3Rpb24oKXtsZXQgdD1hcmd1bWVudHMubGVuZ3RoPjAmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT9hcmd1bWVudHNbMF06IiI7cmV0dXJuIHQ/KC9eaHR0cHM/OlwvXC8uKy8udGVzdCh0KXx8KHQ9Imh0dHBzOi8vIi5jb25jYXQodCkpLCIiLmNvbmNhdCh0LCIvZGlzcGF0Y2gvdjEvQWNjZXNzSW5mbz9BY3Rpb249R2V0QWNjZXNzSW5mbyIpKToiIn0pKSwkcC5ERUZBVUxUX0NPTkYsUXAuTk9ORSwidW5kZWZpbmVkIiE9dHlwZW9mIHNlbGYmJiJEZWRpY2F0ZWRXb3JrZXJHbG9iYWxTY29wZSI9PT1zZWxmLmNvbnN0cnVjdG9yLm5hbWUmJnNlbGYuYWRkRXZlbnRMaXN0ZW5lcigicnRjdHJhbnNmb3JtIiwoZT0+e2NvbnN0e3RyYW5zZm9ybWVyOm59PWUse3BvcnQ6cn09bi5vcHRpb25zLGk9KG89dD0+e3IucG9zdE1lc3NhZ2UodCxbdC5wYXlsb2FkLmJ1ZmZlcl0pfSxuZXcgVHJhbnNmb3JtU3RyZWFtKHt0cmFuc2Zvcm0oZSxuKXtjb25zdCByPXQuaXNIMjY1VmlkZW9GcmFtZShlKTt0LmdldE5BTFVuaXRzKG5ldyBodShlLmRhdGEpLHIpLmZvckVhY2goKHQ9PntpZih0LnNlaSl7Y29uc3QgZT12dS5kZWNvZGVTRUlCb2R5KHQuYm9keSxyKTtlJiZlLnR5cGU9PT1mdS5leHRlcm5hbCYmbyhlKX19KSksbi5lbnF1ZXVlKGUpfX0pKTt2YXIgbztuLnJlYWRhYmxlLnBpcGVUaHJvdWdoKGkpLnBpcGVUbyhlLnRyYW5zZm9ybWVyLndyaXRhYmxlKX0pKX0oKTsK",iP="undefined"!=typeof window&&window.Blob&&new Blob([atob(tP)],{type:"text/javascript;charset=utf-8"});function oP(){let e;try{if(e=iP&&(tL||window.webkitURL).createObjectURL(iP),!e)throw"";return new Worker(e)}catch(t){return new Worker("data:application/javascript;base64,"+tP)}finally{!("undefined"!=typeof window&&navigator.userAgent.indexOf("Trident/")>0)&&e&&(tL||window.webkitlRL).revokeObjectURL(e)}}const sP="IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO3ZhciB0PSJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsVGhpcz9nbG9iYWxUaGlzOiJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93P3dpbmRvdzoidW5kZWZpbmVkIiE9dHlwZW9mIGdsb2JhbD9nbG9iYWw6InVuZGVmaW5lZCIhPXR5cGVvZiBzZWxmP3NlbGY6e307ZnVuY3Rpb24gZSh0KXtyZXR1cm4gdCYmdC5fX2VzTW9kdWxlJiZPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodCwiZGVmYXVsdCIpP3QuZGVmYXVsdDp0fXZhciBuPXtleHBvcnRzOnt9fSxyPWZ1bmN0aW9uKHQpe3JldHVybiB0JiZ0Lk1hdGg9PT1NYXRoJiZ0fSxvPXIoIm9iamVjdCI9PXR5cGVvZiBnbG9iYWxUaGlzJiZnbG9iYWxUaGlzKXx8cigib2JqZWN0Ij09dHlwZW9mIHdpbmRvdyYmd2luZG93KXx8cigib2JqZWN0Ij09dHlwZW9mIHNlbGYmJnNlbGYpfHxyKCJvYmplY3QiPT10eXBlb2YgdCYmdCl8fHIoIm9iamVjdCI9PXR5cGVvZiB0JiZ0KXx8ZnVuY3Rpb24oKXtyZXR1cm4gdGhpc30oKXx8RnVuY3Rpb24oInJldHVybiB0aGlzIikoKSxpPWZ1bmN0aW9uKHQpe3RyeXtyZXR1cm4hIXQoKX1jYXRjaChlKXtyZXR1cm4hMH19LHU9IWkoKGZ1bmN0aW9uKCl7dmFyIHQ9ZnVuY3Rpb24oKXt9LmJpbmQoKTtyZXR1cm4iZnVuY3Rpb24iIT10eXBlb2YgdHx8dC5oYXNPd25Qcm9wZXJ0eSgicHJvdG90eXBlIil9KSksYT11LGM9RnVuY3Rpb24ucHJvdG90eXBlLHM9Yy5hcHBseSxmPWMuY2FsbCxsPSJvYmplY3QiPT10eXBlb2YgUmVmbGVjdCYmUmVmbGVjdC5hcHBseXx8KGE/Zi5iaW5kKHMpOmZ1bmN0aW9uKCl7cmV0dXJuIGYuYXBwbHkocyxhcmd1bWVudHMpfSkseT11LHA9RnVuY3Rpb24ucHJvdG90eXBlLGg9cC5jYWxsLGc9eSYmcC5iaW5kLmJpbmQoaCxoKSxkPXk/ZzpmdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gaC5hcHBseSh0LGFyZ3VtZW50cyl9fSxiPWQsdj1iKHt9LnRvU3RyaW5nKSxtPWIoIiIuc2xpY2UpLFM9ZnVuY3Rpb24odCl7cmV0dXJuIG0odih0KSw4LC0xKX0sdz1TLE89ZCxMPWZ1bmN0aW9uKHQpe2lmKCJGdW5jdGlvbiI9PT13KHQpKXJldHVybiBPKHQpfSxqPSJvYmplY3QiPT10eXBlb2YgZG9jdW1lbnQmJmRvY3VtZW50LmFsbCxBPXZvaWQgMD09PWomJnZvaWQgMCE9PWo/ZnVuY3Rpb24odCl7cmV0dXJuImZ1bmN0aW9uIj09dHlwZW9mIHR8fHQ9PT1qfTpmdW5jdGlvbih0KXtyZXR1cm4iZnVuY3Rpb24iPT10eXBlb2YgdH0sUD17fSxJPSFpKChmdW5jdGlvbigpe3JldHVybiA3IT09T2JqZWN0LmRlZmluZVByb3BlcnR5KHt9LDEse2dldDpmdW5jdGlvbigpe3JldHVybiA3fX0pWzFdfSkpLEU9dSxUPUZ1bmN0aW9uLnByb3RvdHlwZS5jYWxsLGs9RT9ULmJpbmQoVCk6ZnVuY3Rpb24oKXtyZXR1cm4gVC5hcHBseShULGFyZ3VtZW50cyl9LHg9e30sRj17fS5wcm9wZXJ0eUlzRW51bWVyYWJsZSxDPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsTj1DJiYhRi5jYWxsKHsxOjJ9LDEpO3guZj1OP2Z1bmN0aW9uKHQpe3ZhciBlPUModGhpcyx0KTtyZXR1cm4hIWUmJmUuZW51bWVyYWJsZX06Rjt2YXIgTSxSLFU9ZnVuY3Rpb24odCxlKXtyZXR1cm57ZW51bWVyYWJsZTohKDEmdCksY29uZmlndXJhYmxlOiEoMiZ0KSx3cml0YWJsZTohKDQmdCksdmFsdWU6ZX19LEQ9aSxfPVMsRz1PYmplY3QsSD1kKCIiLnNwbGl0KSxCPUQoKGZ1bmN0aW9uKCl7cmV0dXJuIUcoInoiKS5wcm9wZXJ0eUlzRW51bWVyYWJsZSgwKX0pKT9mdW5jdGlvbih0KXtyZXR1cm4iU3RyaW5nIj09PV8odCk/SCh0LCIiKTpHKHQpfTpHLFY9ZnVuY3Rpb24odCl7cmV0dXJuIG51bGw9PXR9LFc9Vix6PVR5cGVFcnJvcixLPWZ1bmN0aW9uKHQpe2lmKFcodCkpdGhyb3cgbmV3IHooIkNhbid0IGNhbGwgbWV0aG9kIG9uICIrdCk7cmV0dXJuIHR9LHE9QixKPUssWT1mdW5jdGlvbih0KXtyZXR1cm4gcShKKHQpKX0sWD1BLCQ9ZnVuY3Rpb24odCl7cmV0dXJuIm9iamVjdCI9PXR5cGVvZiB0P251bGwhPT10OlgodCl9LFE9e30sWj1RLHR0PW8sZXQ9QSxudD1mdW5jdGlvbih0KXtyZXR1cm4gZXQodCk/dDp2b2lkIDB9LHJ0PWZ1bmN0aW9uKHQsZSl7cmV0dXJuIGFyZ3VtZW50cy5sZW5ndGg8Mj9udChaW3RdKXx8bnQodHRbdF0pOlpbdF0mJlpbdF1bZV18fHR0W3RdJiZ0dFt0XVtlXX0sb3Q9ZCh7fS5pc1Byb3RvdHlwZU9mKSxpdD1vLm5hdmlnYXRvcix1dD1pdCYmaXQudXNlckFnZW50LGF0PW8sY3Q9dXQ/U3RyaW5nKHV0KToiIixzdD1hdC5wcm9jZXNzLGZ0PWF0LkRlbm8sbHQ9c3QmJnN0LnZlcnNpb25zfHxmdCYmZnQudmVyc2lvbix5dD1sdCYmbHQudjg7eXQmJihSPShNPXl0LnNwbGl0KCIuIikpWzBdPjAmJk1bMF08ND8xOisoTVswXStNWzFdKSksIVImJmN0JiYoIShNPWN0Lm1hdGNoKC9FZGdlXC8oXGQrKS8pKXx8TVsxXT49NzQpJiYoTT1jdC5tYXRjaCgvQ2hyb21lXC8oXGQrKS8pKSYmKFI9K01bMV0pO3ZhciBwdD1SLGh0PXB0LGd0PWksZHQ9by5TdHJpbmcsYnQ9ISFPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzJiYhZ3QoKGZ1bmN0aW9uKCl7dmFyIHQ9U3ltYm9sKCJzeW1ib2wgZGV0ZWN0aW9uIik7cmV0dXJuIWR0KHQpfHwhKE9iamVjdCh0KWluc3RhbmNlb2YgU3ltYm9sKXx8IVN5bWJvbC5zaGFtJiZodCYmaHQ8NDF9KSksdnQ9YnQmJiFTeW1ib2wuc2hhbSYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3IsbXQ9cnQsU3Q9QSx3dD1vdCxPdD1PYmplY3QsTHQ9dnQ/ZnVuY3Rpb24odCl7cmV0dXJuInN5bWJvbCI9PXR5cGVvZiB0fTpmdW5jdGlvbih0KXt2YXIgZT1tdCgiU3ltYm9sIik7cmV0dXJuIFN0KGUpJiZ3dChlLnByb3RvdHlwZSxPdCh0KSl9LGp0PVN0cmluZyxBdD1mdW5jdGlvbih0KXt0cnl7cmV0dXJuIGp0KHQpfWNhdGNoKGUpe3JldHVybiJPYmplY3QifX0sUHQ9QSxJdD1BdCxFdD1UeXBlRXJyb3IsVHQ9ZnVuY3Rpb24odCl7aWYoUHQodCkpcmV0dXJuIHQ7dGhyb3cgbmV3IEV0KEl0KHQpKyIgaXMgbm90IGEgZnVuY3Rpb24iKX0sa3Q9VHQseHQ9VixGdD1rLEN0PUEsTnQ9JCxNdD1UeXBlRXJyb3IsUnQ9e2V4cG9ydHM6e319LFV0PW8sRHQ9T2JqZWN0LmRlZmluZVByb3BlcnR5LF90PW8sR3Q9ZnVuY3Rpb24odCxlKXt0cnl7RHQoVXQsdCx7dmFsdWU6ZSxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KX1jYXRjaChuKXtVdFt0XT1lfXJldHVybiBlfSxIdD0iX19jb3JlLWpzX3NoYXJlZF9fIixCdD1SdC5leHBvcnRzPV90W0h0XXx8R3QoSHQse30pOyhCdC52ZXJzaW9uc3x8KEJ0LnZlcnNpb25zPVtdKSkucHVzaCh7dmVyc2lvbjoiMy4zOS4wIixtb2RlOiJwdXJlIixjb3B5cmlnaHQ6IsKpIDIwMTQtMjAyNCBEZW5pcyBQdXNoa2FyZXYgKHpsb2lyb2NrLnJ1KSIsbGljZW5zZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMvYmxvYi92My4zOS4wL0xJQ0VOU0UiLHNvdXJjZToiaHR0cHM6Ly9naXRodWIuY29tL3psb2lyb2NrL2NvcmUtanMifSk7dmFyIFZ0PVJ0LmV4cG9ydHMsV3Q9VnQsenQ9ZnVuY3Rpb24odCxlKXtyZXR1cm4gV3RbdF18fChXdFt0XT1lfHx7fSl9LEt0PUsscXQ9T2JqZWN0LEp0PWZ1bmN0aW9uKHQpe3JldHVybiBxdChLdCh0KSl9LFl0PUp0LFh0PWQoe30uaGFzT3duUHJvcGVydHkpLCR0PU9iamVjdC5oYXNPd258fGZ1bmN0aW9uKHQsZSl7cmV0dXJuIFh0KFl0KHQpLGUpfSxRdD1kLFp0PTAsdGU9TWF0aC5yYW5kb20oKSxlZT1RdCgxLi50b1N0cmluZyksbmU9ZnVuY3Rpb24odCl7cmV0dXJuIlN5bWJvbCgiKyh2b2lkIDA9PT10PyIiOnQpKyIpXyIrZWUoKytadCt0ZSwzNil9LHJlPXp0LG9lPSR0LGllPW5lLHVlPWJ0LGFlPXZ0LGNlPW8uU3ltYm9sLHNlPXJlKCJ3a3MiKSxmZT1hZT9jZS5mb3J8fGNlOmNlJiZjZS53aXRob3V0U2V0dGVyfHxpZSxsZT1mdW5jdGlvbih0KXtyZXR1cm4gb2Uoc2UsdCl8fChzZVt0XT11ZSYmb2UoY2UsdCk/Y2VbdF06ZmUoIlN5bWJvbC4iK3QpKSxzZVt0XX0seWU9ayxwZT0kLGhlPUx0LGdlPWZ1bmN0aW9uKHQsZSl7dmFyIG49dFtlXTtyZXR1cm4geHQobik/dm9pZCAwOmt0KG4pfSxkZT1mdW5jdGlvbih0LGUpe3ZhciBuLHI7aWYoInN0cmluZyI9PT1lJiZDdChuPXQudG9TdHJpbmcpJiYhTnQocj1GdChuLHQpKSlyZXR1cm4gcjtpZihDdChuPXQudmFsdWVPZikmJiFOdChyPUZ0KG4sdCkpKXJldHVybiByO2lmKCJzdHJpbmciIT09ZSYmQ3Qobj10LnRvU3RyaW5nKSYmIU50KHI9RnQobix0KSkpcmV0dXJuIHI7dGhyb3cgbmV3IE10KCJDYW4ndCBjb252ZXJ0IG9iamVjdCB0byBwcmltaXRpdmUgdmFsdWUiKX0sYmU9VHlwZUVycm9yLHZlPWxlKCJ0b1ByaW1pdGl2ZSIpLG1lPWZ1bmN0aW9uKHQsZSl7aWYoIXBlKHQpfHxoZSh0KSlyZXR1cm4gdDt2YXIgbixyPWdlKHQsdmUpO2lmKHIpe2lmKHZvaWQgMD09PWUmJihlPSJkZWZhdWx0Iiksbj15ZShyLHQsZSksIXBlKG4pfHxoZShuKSlyZXR1cm4gbjt0aHJvdyBuZXcgYmUoIkNhbid0IGNvbnZlcnQgb2JqZWN0IHRvIHByaW1pdGl2ZSB2YWx1ZSIpfXJldHVybiB2b2lkIDA9PT1lJiYoZT0ibnVtYmVyIiksZGUodCxlKX0sU2U9THQsd2U9ZnVuY3Rpb24odCl7dmFyIGU9bWUodCwic3RyaW5nIik7cmV0dXJuIFNlKGUpP2U6ZSsiIn0sT2U9JCxMZT1vLmRvY3VtZW50LGplPU9lKExlKSYmT2UoTGUuY3JlYXRlRWxlbWVudCksQWU9ZnVuY3Rpb24odCl7cmV0dXJuIGplP0xlLmNyZWF0ZUVsZW1lbnQodCk6e319LFBlPUFlLEllPSFJJiYhaSgoZnVuY3Rpb24oKXtyZXR1cm4gNyE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eShQZSgiZGl2IiksImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gN319KS5hfSkpLEVlPUksVGU9ayxrZT14LHhlPVUsRmU9WSxDZT13ZSxOZT0kdCxNZT1JZSxSZT1PYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yO1AuZj1FZT9SZTpmdW5jdGlvbih0LGUpe2lmKHQ9RmUodCksZT1DZShlKSxNZSl0cnl7cmV0dXJuIFJlKHQsZSl9Y2F0Y2gobil7fWlmKE5lKHQsZSkpcmV0dXJuIHhlKCFUZShrZS5mLHQsZSksdFtlXSl9O3ZhciBVZT1pLERlPUEsX2U9LyN8XC5wcm90b3R5cGVcLi8sR2U9ZnVuY3Rpb24odCxlKXt2YXIgbj1CZVtIZSh0KV07cmV0dXJuIG49PT1XZXx8biE9PVZlJiYoRGUoZSk/VWUoZSk6ISFlKX0sSGU9R2Uubm9ybWFsaXplPWZ1bmN0aW9uKHQpe3JldHVybiBTdHJpbmcodCkucmVwbGFjZShfZSwiLiIpLnRvTG93ZXJDYXNlKCl9LEJlPUdlLmRhdGE9e30sVmU9R2UuTkFUSVZFPSJOIixXZT1HZS5QT0xZRklMTD0iUCIsemU9R2UsS2U9VHQscWU9dSxKZT1MKEwuYmluZCksWWU9ZnVuY3Rpb24odCxlKXtyZXR1cm4gS2UodCksdm9pZCAwPT09ZT90OnFlP0plKHQsZSk6ZnVuY3Rpb24oKXtyZXR1cm4gdC5hcHBseShlLGFyZ3VtZW50cyl9fSxYZT17fSwkZT1JJiZpKChmdW5jdGlvbigpe3JldHVybiA0MiE9PU9iamVjdC5kZWZpbmVQcm9wZXJ0eSgoZnVuY3Rpb24oKXt9KSwicHJvdG90eXBlIix7dmFsdWU6NDIsd3JpdGFibGU6ITF9KS5wcm90b3R5cGV9KSksUWU9JCxaZT1TdHJpbmcsdG49VHlwZUVycm9yLGVuPWZ1bmN0aW9uKHQpe2lmKFFlKHQpKXJldHVybiB0O3Rocm93IG5ldyB0bihaZSh0KSsiIGlzIG5vdCBhbiBvYmplY3QiKX0sbm49SSxybj1JZSxvbj0kZSx1bj1lbixhbj13ZSxjbj1UeXBlRXJyb3Isc249T2JqZWN0LmRlZmluZVByb3BlcnR5LGZuPU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsbG49ImVudW1lcmFibGUiLHluPSJjb25maWd1cmFibGUiLHBuPSJ3cml0YWJsZSI7WGUuZj1ubj9vbj9mdW5jdGlvbih0LGUsbil7aWYodW4odCksZT1hbihlKSx1bihuKSwiZnVuY3Rpb24iPT10eXBlb2YgdCYmInByb3RvdHlwZSI9PT1lJiYidmFsdWUiaW4gbiYmcG4gaW4gbiYmIW5bcG5dKXt2YXIgcj1mbih0LGUpO3ImJnJbcG5dJiYodFtlXT1uLnZhbHVlLG49e2NvbmZpZ3VyYWJsZTp5biBpbiBuP25beW5dOnJbeW5dLGVudW1lcmFibGU6bG4gaW4gbj9uW2xuXTpyW2xuXSx3cml0YWJsZTohMX0pfXJldHVybiBzbih0LGUsbil9OnNuOmZ1bmN0aW9uKHQsZSxuKXtpZih1bih0KSxlPWFuKGUpLHVuKG4pLHJuKXRyeXtyZXR1cm4gc24odCxlLG4pfWNhdGNoKHIpe31pZigiZ2V0ImluIG58fCJzZXQiaW4gbil0aHJvdyBuZXcgY24oIkFjY2Vzc29ycyBub3Qgc3VwcG9ydGVkIik7cmV0dXJuInZhbHVlImluIG4mJih0W2VdPW4udmFsdWUpLHR9O3ZhciBobj1YZSxnbj1VLGRuPUk/ZnVuY3Rpb24odCxlLG4pe3JldHVybiBobi5mKHQsZSxnbigxLG4pKX06ZnVuY3Rpb24odCxlLG4pe3JldHVybiB0W2VdPW4sdH0sYm49byx2bj1sLG1uPUwsU249QSx3bj1QLmYsT249emUsTG49USxqbj1ZZSxBbj1kbixQbj0kdCxJbj1mdW5jdGlvbih0KXt2YXIgZT1mdW5jdGlvbihuLHIsbyl7aWYodGhpcyBpbnN0YW5jZW9mIGUpe3N3aXRjaChhcmd1bWVudHMubGVuZ3RoKXtjYXNlIDA6cmV0dXJuIG5ldyB0O2Nhc2UgMTpyZXR1cm4gbmV3IHQobik7Y2FzZSAyOnJldHVybiBuZXcgdChuLHIpfXJldHVybiBuZXcgdChuLHIsbyl9cmV0dXJuIHZuKHQsdGhpcyxhcmd1bWVudHMpfTtyZXR1cm4gZS5wcm90b3R5cGU9dC5wcm90b3R5cGUsZX0sRW49ZnVuY3Rpb24odCxlKXt2YXIgbixyLG8saSx1LGEsYyxzLGYsbD10LnRhcmdldCx5PXQuZ2xvYmFsLHA9dC5zdGF0LGg9dC5wcm90byxnPXk/Ym46cD9ibltsXTpibltsXSYmYm5bbF0ucHJvdG90eXBlLGQ9eT9MbjpMbltsXXx8QW4oTG4sbCx7fSlbbF0sYj1kLnByb3RvdHlwZTtmb3IoaSBpbiBlKXI9IShuPU9uKHk/aTpsKyhwPyIuIjoiIyIpK2ksdC5mb3JjZWQpKSYmZyYmUG4oZyxpKSxhPWRbaV0sciYmKGM9dC5kb250Q2FsbEdldFNldD8oZj13bihnLGkpKSYmZi52YWx1ZTpnW2ldKSx1PXImJmM/YzplW2ldLChufHxofHx0eXBlb2YgYSE9dHlwZW9mIHUpJiYocz10LmJpbmQmJnI/am4odSxibik6dC53cmFwJiZyP0luKHUpOmgmJlNuKHUpP21uKHUpOnUsKHQuc2hhbXx8dSYmdS5zaGFtfHxhJiZhLnNoYW0pJiZBbihzLCJzaGFtIiwhMCksQW4oZCxpLHMpLGgmJihQbihMbixvPWwrIlByb3RvdHlwZSIpfHxBbihMbixvLHt9KSxBbihMbltvXSxpLHUpLHQucmVhbCYmYiYmKG58fCFiW2ldKSYmQW4oYixpLHUpKSl9LFRuPUVuLGtuPUkseG49WGUuZjtUbih7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOk9iamVjdC5kZWZpbmVQcm9wZXJ0eSE9PXhuLHNoYW06IWtufSx7ZGVmaW5lUHJvcGVydHk6eG59KTt2YXIgRm49US5PYmplY3QsQ249bi5leHBvcnRzPWZ1bmN0aW9uKHQsZSxuKXtyZXR1cm4gRm4uZGVmaW5lUHJvcGVydHkodCxlLG4pfTtGbi5kZWZpbmVQcm9wZXJ0eS5zaGFtJiYoQ24uc2hhbT0hMCk7dmFyIE5uPWUobi5leHBvcnRzKSxNbj1TLFJuPUFycmF5LmlzQXJyYXl8fGZ1bmN0aW9uKHQpe3JldHVybiJBcnJheSI9PT1Nbih0KX0sVW49TWF0aC5jZWlsLERuPU1hdGguZmxvb3IsX249TWF0aC50cnVuY3x8ZnVuY3Rpb24odCl7dmFyIGU9K3Q7cmV0dXJuKGU+MD9EbjpVbikoZSl9LEduPWZ1bmN0aW9uKHQpe3ZhciBlPSt0O3JldHVybiBlIT1lfHwwPT09ZT8wOl9uKGUpfSxIbj1HbixCbj1NYXRoLm1pbixWbj1mdW5jdGlvbih0KXt2YXIgZT1Ibih0KTtyZXR1cm4gZT4wP0JuKGUsOTAwNzE5OTI1NDc0MDk5MSk6MH0sV249ZnVuY3Rpb24odCl7cmV0dXJuIFZuKHQubGVuZ3RoKX0sem49VHlwZUVycm9yLEtuPUkscW49WGUsSm49VSxZbj17fTtZbltsZSgidG9TdHJpbmdUYWciKV09InoiO3ZhciBYbj0iW29iamVjdCB6XSI9PT1TdHJpbmcoWW4pLCRuPVhuLFFuPUEsWm49Uyx0cj1sZSgidG9TdHJpbmdUYWciKSxlcj1PYmplY3QsbnI9IkFyZ3VtZW50cyI9PT1abihmdW5jdGlvbigpe3JldHVybiBhcmd1bWVudHN9KCkpLHJyPSRuP1puOmZ1bmN0aW9uKHQpe3ZhciBlLG4scjtyZXR1cm4gdm9pZCAwPT09dD8iVW5kZWZpbmVkIjpudWxsPT09dD8iTnVsbCI6InN0cmluZyI9PXR5cGVvZihuPWZ1bmN0aW9uKHQsZSl7dHJ5e3JldHVybiB0W2VdfWNhdGNoKG4pe319KGU9ZXIodCksdHIpKT9uOm5yP1puKGUpOiJPYmplY3QiPT09KHI9Wm4oZSkpJiZRbihlLmNhbGxlZSk/IkFyZ3VtZW50cyI6cn0sb3I9QSxpcj1WdCx1cj1kKEZ1bmN0aW9uLnRvU3RyaW5nKTtvcihpci5pbnNwZWN0U291cmNlKXx8KGlyLmluc3BlY3RTb3VyY2U9ZnVuY3Rpb24odCl7cmV0dXJuIHVyKHQpfSk7dmFyIGFyPWlyLmluc3BlY3RTb3VyY2UsY3I9ZCxzcj1pLGZyPUEsbHI9cnIseXI9YXIscHI9ZnVuY3Rpb24oKXt9LGhyPXJ0KCJSZWZsZWN0IiwiY29uc3RydWN0IiksZ3I9L15ccyooPzpjbGFzc3xmdW5jdGlvbilcYi8sZHI9Y3IoZ3IuZXhlYyksYnI9IWdyLnRlc3QocHIpLHZyPWZ1bmN0aW9uKHQpe2lmKCFmcih0KSlyZXR1cm4hMTt0cnl7cmV0dXJuIGhyKHByLFtdLHQpLCEwfWNhdGNoKGUpe3JldHVybiExfX0sbXI9ZnVuY3Rpb24odCl7aWYoIWZyKHQpKXJldHVybiExO3N3aXRjaChscih0KSl7Y2FzZSJBc3luY0Z1bmN0aW9uIjpjYXNlIkdlbmVyYXRvckZ1bmN0aW9uIjpjYXNlIkFzeW5jR2VuZXJhdG9yRnVuY3Rpb24iOnJldHVybiExfXRyeXtyZXR1cm4gYnJ8fCEhZHIoZ3IseXIodCkpfWNhdGNoKGUpe3JldHVybiEwfX07bXIuc2hhbT0hMDt2YXIgU3I9IWhyfHxzcigoZnVuY3Rpb24oKXt2YXIgdDtyZXR1cm4gdnIodnIuY2FsbCl8fCF2cihPYmplY3QpfHwhdnIoKGZ1bmN0aW9uKCl7dD0hMH0pKXx8dH0pKT9tcjp2cix3cj1SbixPcj1TcixMcj0kLGpyPWxlKCJzcGVjaWVzIiksQXI9QXJyYXksUHI9ZnVuY3Rpb24odCl7dmFyIGU7cmV0dXJuIHdyKHQpJiYoZT10LmNvbnN0cnVjdG9yLChPcihlKSYmKGU9PT1Bcnx8d3IoZS5wcm90b3R5cGUpKXx8THIoZSkmJm51bGw9PT0oZT1lW2pyXSkpJiYoZT12b2lkIDApKSx2b2lkIDA9PT1lP0FyOmV9LElyPWZ1bmN0aW9uKHQsZSl7cmV0dXJuIG5ldyhQcih0KSkoMD09PWU/MDplKX0sRXI9aSxUcj1wdCxrcj1sZSgic3BlY2llcyIpLHhyPUVuLEZyPWksQ3I9Um4sTnI9JCxNcj1KdCxScj1XbixVcj1mdW5jdGlvbih0KXtpZih0PjkwMDcxOTkyNTQ3NDA5OTEpdGhyb3cgem4oIk1heGltdW0gYWxsb3dlZCBpbmRleCBleGNlZWRlZCIpO3JldHVybiB0fSxEcj1mdW5jdGlvbih0LGUsbil7S24/cW4uZih0LGUsSm4oMCxuKSk6dFtlXT1ufSxfcj1JcixHcj1mdW5jdGlvbih0KXtyZXR1cm4gVHI+PTUxfHwhRXIoKGZ1bmN0aW9uKCl7dmFyIGU9W107cmV0dXJuKGUuY29uc3RydWN0b3I9e30pW2tyXT1mdW5jdGlvbigpe3JldHVybntmb286MX19LDEhPT1lW3RdKEJvb2xlYW4pLmZvb30pKX0sSHI9cHQsQnI9bGUoImlzQ29uY2F0U3ByZWFkYWJsZSIpLFZyPUhyPj01MXx8IUZyKChmdW5jdGlvbigpe3ZhciB0PVtdO3JldHVybiB0W0JyXT0hMSx0LmNvbmNhdCgpWzBdIT09dH0pKSxXcj1mdW5jdGlvbih0KXtpZighTnIodCkpcmV0dXJuITE7dmFyIGU9dFtCcl07cmV0dXJuIHZvaWQgMCE9PWU/ISFlOkNyKHQpfTt4cih7dGFyZ2V0OiJBcnJheSIscHJvdG86ITAsYXJpdHk6MSxmb3JjZWQ6IVZyfHwhR3IoImNvbmNhdCIpfSx7Y29uY2F0OmZ1bmN0aW9uKHQpe3ZhciBlLG4scixvLGksdT1Ncih0aGlzKSxhPV9yKHUsMCksYz0wO2ZvcihlPS0xLHI9YXJndW1lbnRzLmxlbmd0aDtlPHI7ZSsrKWlmKFdyKGk9LTE9PT1lP3U6YXJndW1lbnRzW2VdKSlmb3Iobz1ScihpKSxVcihjK28pLG49MDtuPG87bisrLGMrKyluIGluIGkmJkRyKGEsYyxpW25dKTtlbHNlIFVyKGMrMSksRHIoYSxjKyssaSk7cmV0dXJuIGEubGVuZ3RoPWMsYX19KTt2YXIgenI9cnIsS3I9U3RyaW5nLHFyPWZ1bmN0aW9uKHQpe2lmKCJTeW1ib2wiPT09enIodCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNvbnZlcnQgYSBTeW1ib2wgdmFsdWUgdG8gYSBzdHJpbmciKTtyZXR1cm4gS3IodCl9LEpyPXt9LFlyPUduLFhyPU1hdGgubWF4LCRyPU1hdGgubWluLFFyPVksWnI9ZnVuY3Rpb24odCxlKXt2YXIgbj1Zcih0KTtyZXR1cm4gbjwwP1hyKG4rZSwwKTokcihuLGUpfSx0bz1Xbixlbz1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxuLHIpe3ZhciBvPVFyKGUpLGk9dG8obyk7aWYoMD09PWkpcmV0dXJuIXQmJi0xO3ZhciB1LGE9WnIocixpKTtpZih0JiZuIT1uKXtmb3IoO2k+YTspaWYoKHU9b1thKytdKSE9dSlyZXR1cm4hMH1lbHNlIGZvcig7aT5hO2ErKylpZigodHx8YSBpbiBvKSYmb1thXT09PW4pcmV0dXJuIHR8fGF8fDA7cmV0dXJuIXQmJi0xfX0sbm89e2luY2x1ZGVzOmVvKCEwKSxpbmRleE9mOmVvKCExKX0scm89e30sb289JHQsaW89WSx1bz1uby5pbmRleE9mLGFvPXJvLGNvPWQoW10ucHVzaCksc289ZnVuY3Rpb24odCxlKXt2YXIgbixyPWlvKHQpLG89MCxpPVtdO2ZvcihuIGluIHIpIW9vKGFvLG4pJiZvbyhyLG4pJiZjbyhpLG4pO2Zvcig7ZS5sZW5ndGg+bzspb28ocixuPWVbbysrXSkmJih+dW8oaSxuKXx8Y28oaSxuKSk7cmV0dXJuIGl9LGZvPVsiY29uc3RydWN0b3IiLCJoYXNPd25Qcm9wZXJ0eSIsImlzUHJvdG90eXBlT2YiLCJwcm9wZXJ0eUlzRW51bWVyYWJsZSIsInRvTG9jYWxlU3RyaW5nIiwidG9TdHJpbmciLCJ2YWx1ZU9mIl0sbG89c28seW89Zm8scG89T2JqZWN0LmtleXN8fGZ1bmN0aW9uKHQpe3JldHVybiBsbyh0LHlvKX0saG89SSxnbz0kZSxibz1YZSx2bz1lbixtbz1ZLFNvPXBvO0pyLmY9aG8mJiFnbz9PYmplY3QuZGVmaW5lUHJvcGVydGllczpmdW5jdGlvbih0LGUpe3ZvKHQpO2Zvcih2YXIgbixyPW1vKGUpLG89U28oZSksaT1vLmxlbmd0aCx1PTA7aT51Oyliby5mKHQsbj1vW3UrK10scltuXSk7cmV0dXJuIHR9O3ZhciB3byxPbz1ydCgiZG9jdW1lbnQiLCJkb2N1bWVudEVsZW1lbnQiKSxMbz1uZSxqbz16dCgia2V5cyIpLEFvPWZ1bmN0aW9uKHQpe3JldHVybiBqb1t0XXx8KGpvW3RdPUxvKHQpKX0sUG89ZW4sSW89SnIsRW89Zm8sVG89cm8sa289T28seG89QWUsRm89InByb3RvdHlwZSIsQ289InNjcmlwdCIsTm89QW8oIklFX1BST1RPIiksTW89ZnVuY3Rpb24oKXt9LFJvPWZ1bmN0aW9uKHQpe3JldHVybiI8IitDbysiPiIrdCsiPC8iK0NvKyI+In0sVW89ZnVuY3Rpb24odCl7dC53cml0ZShSbygiIikpLHQuY2xvc2UoKTt2YXIgZT10LnBhcmVudFdpbmRvdy5PYmplY3Q7cmV0dXJuIHQ9bnVsbCxlfSxEbz1mdW5jdGlvbigpe3RyeXt3bz1uZXcgQWN0aXZlWE9iamVjdCgiaHRtbGZpbGUiKX1jYXRjaChvKXt9dmFyIHQsZSxuO0RvPSJ1bmRlZmluZWQiIT10eXBlb2YgZG9jdW1lbnQ/ZG9jdW1lbnQuZG9tYWluJiZ3bz9Vbyh3byk6KGU9eG8oImlmcmFtZSIpLG49ImphdmEiK0NvKyI6IixlLnN0eWxlLmRpc3BsYXk9Im5vbmUiLGtvLmFwcGVuZENoaWxkKGUpLGUuc3JjPVN0cmluZyhuKSwodD1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQpLm9wZW4oKSx0LndyaXRlKFJvKCJkb2N1bWVudC5GPU9iamVjdCIpKSx0LmNsb3NlKCksdC5GKTpVbyh3byk7Zm9yKHZhciByPUVvLmxlbmd0aDtyLS07KWRlbGV0ZSBEb1tGb11bRW9bcl1dO3JldHVybiBEbygpfTtUb1tOb109ITA7dmFyIF9vPU9iamVjdC5jcmVhdGV8fGZ1bmN0aW9uKHQsZSl7dmFyIG47cmV0dXJuIG51bGwhPT10PyhNb1tGb109UG8odCksbj1uZXcgTW8sTW9bRm9dPW51bGwsbltOb109dCk6bj1EbygpLHZvaWQgMD09PWU/bjpJby5mKG4sZSl9LEdvPXt9LEhvPXNvLEJvPWZvLmNvbmNhdCgibGVuZ3RoIiwicHJvdG90eXBlIik7R28uZj1PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lc3x8ZnVuY3Rpb24odCl7cmV0dXJuIEhvKHQsQm8pfTt2YXIgVm89e30sV289ZChbXS5zbGljZSksem89UyxLbz1ZLHFvPUdvLmYsSm89V28sWW89Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJndpbmRvdyYmT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM/T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMod2luZG93KTpbXTtWby5mPWZ1bmN0aW9uKHQpe3JldHVybiBZbyYmIldpbmRvdyI9PT16byh0KT9mdW5jdGlvbih0KXt0cnl7cmV0dXJuIHFvKHQpfWNhdGNoKGUpe3JldHVybiBKbyhZbyl9fSh0KTpxbyhLbyh0KSl9O3ZhciBYbz17fTtYby5mPU9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHM7dmFyICRvPWRuLFFvPWZ1bmN0aW9uKHQsZSxuLHIpe3JldHVybiByJiZyLmVudW1lcmFibGU/dFtlXT1uOiRvKHQsZSxuKSx0fSxabz1YZSx0aT17fSxlaT1sZTt0aS5mPWVpO3ZhciBuaSxyaSxvaSxpaT1RLHVpPSR0LGFpPXRpLGNpPVhlLmYsc2k9ZnVuY3Rpb24odCl7dmFyIGU9aWkuU3ltYm9sfHwoaWkuU3ltYm9sPXt9KTt1aShlLHQpfHxjaShlLHQse3ZhbHVlOmFpLmYodCl9KX0sZmk9ayxsaT1ydCx5aT1sZSxwaT1RbyxoaT1mdW5jdGlvbigpe3ZhciB0PWxpKCJTeW1ib2wiKSxlPXQmJnQucHJvdG90eXBlLG49ZSYmZS52YWx1ZU9mLHI9eWkoInRvUHJpbWl0aXZlIik7ZSYmIWVbcl0mJnBpKGUsciwoZnVuY3Rpb24odCl7cmV0dXJuIGZpKG4sdGhpcyl9KSx7YXJpdHk6MX0pfSxnaT1ycixkaT1Ybj97fS50b1N0cmluZzpmdW5jdGlvbigpe3JldHVybiJbb2JqZWN0ICIrZ2kodGhpcykrIl0ifSxiaT1Ybix2aT1YZS5mLG1pPWRuLFNpPSR0LHdpPWRpLE9pPWxlKCJ0b1N0cmluZ1RhZyIpLExpPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBvPW4/dDp0JiZ0LnByb3RvdHlwZTtvJiYoU2kobyxPaSl8fHZpKG8sT2kse2NvbmZpZ3VyYWJsZTohMCx2YWx1ZTplfSksciYmIWJpJiZtaShvLCJ0b1N0cmluZyIsd2kpKX0samk9QSxBaT1vLldlYWtNYXAsUGk9amkoQWkpJiYvbmF0aXZlIGNvZGUvLnRlc3QoU3RyaW5nKEFpKSksSWk9byxFaT0kLFRpPWRuLGtpPSR0LHhpPVZ0LEZpPUFvLENpPXJvLE5pPSJPYmplY3QgYWxyZWFkeSBpbml0aWFsaXplZCIsTWk9SWkuVHlwZUVycm9yLFJpPUlpLldlYWtNYXA7aWYoUGl8fHhpLnN0YXRlKXt2YXIgVWk9eGkuc3RhdGV8fCh4aS5zdGF0ZT1uZXcgUmkpO1VpLmdldD1VaS5nZXQsVWkuaGFzPVVpLmhhcyxVaS5zZXQ9VWkuc2V0LG5pPWZ1bmN0aW9uKHQsZSl7aWYoVWkuaGFzKHQpKXRocm93IG5ldyBNaShOaSk7cmV0dXJuIGUuZmFjYWRlPXQsVWkuc2V0KHQsZSksZX0scmk9ZnVuY3Rpb24odCl7cmV0dXJuIFVpLmdldCh0KXx8e319LG9pPWZ1bmN0aW9uKHQpe3JldHVybiBVaS5oYXModCl9fWVsc2V7dmFyIERpPUZpKCJzdGF0ZSIpO0NpW0RpXT0hMCxuaT1mdW5jdGlvbih0LGUpe2lmKGtpKHQsRGkpKXRocm93IG5ldyBNaShOaSk7cmV0dXJuIGUuZmFjYWRlPXQsVGkodCxEaSxlKSxlfSxyaT1mdW5jdGlvbih0KXtyZXR1cm4ga2kodCxEaSk/dFtEaV06e319LG9pPWZ1bmN0aW9uKHQpe3JldHVybiBraSh0LERpKX19dmFyIF9pPXtzZXQ6bmksZ2V0OnJpLGhhczpvaSxlbmZvcmNlOmZ1bmN0aW9uKHQpe3JldHVybiBvaSh0KT9yaSh0KTpuaSh0LHt9KX0sZ2V0dGVyRm9yOmZ1bmN0aW9uKHQpe3JldHVybiBmdW5jdGlvbihlKXt2YXIgbjtpZighRWkoZSl8fChuPXJpKGUpKS50eXBlIT09dCl0aHJvdyBuZXcgTWkoIkluY29tcGF0aWJsZSByZWNlaXZlciwgIit0KyIgcmVxdWlyZWQiKTtyZXR1cm4gbn19fSxHaT1ZZSxIaT1CLEJpPUp0LFZpPVduLFdpPUlyLHppPWQoW10ucHVzaCksS2k9ZnVuY3Rpb24odCl7dmFyIGU9MT09PXQsbj0yPT09dCxyPTM9PT10LG89ND09PXQsaT02PT09dCx1PTc9PT10LGE9NT09PXR8fGk7cmV0dXJuIGZ1bmN0aW9uKGMscyxmLGwpe2Zvcih2YXIgeSxwLGg9QmkoYyksZz1IaShoKSxkPVZpKGcpLGI9R2kocyxmKSx2PTAsbT1sfHxXaSxTPWU/bShjLGQpOm58fHU/bShjLDApOnZvaWQgMDtkPnY7disrKWlmKChhfHx2IGluIGcpJiYocD1iKHk9Z1t2XSx2LGgpLHQpKWlmKGUpU1t2XT1wO2Vsc2UgaWYocClzd2l0Y2godCl7Y2FzZSAzOnJldHVybiEwO2Nhc2UgNTpyZXR1cm4geTtjYXNlIDY6cmV0dXJuIHY7Y2FzZSAyOnppKFMseSl9ZWxzZSBzd2l0Y2godCl7Y2FzZSA0OnJldHVybiExO2Nhc2UgNzp6aShTLHkpfXJldHVybiBpPy0xOnJ8fG8/bzpTfX0scWk9e2ZvckVhY2g6S2koMCksbWFwOktpKDEpLGZpbHRlcjpLaSgyKSxzb21lOktpKDMpLGV2ZXJ5OktpKDQpLGZpbmQ6S2koNSksZmluZEluZGV4OktpKDYpLGZpbHRlclJlamVjdDpLaSg3KX0sSmk9RW4sWWk9byxYaT1rLCRpPWQsUWk9SSxaaT1idCx0dT1pLGV1PSR0LG51PW90LHJ1PWVuLG91PVksaXU9d2UsdXU9cXIsYXU9VSxjdT1fbyxzdT1wbyxmdT1HbyxsdT1Wbyx5dT1YbyxwdT1QLGh1PVhlLGd1PUpyLGR1PXgsYnU9UW8sdnU9ZnVuY3Rpb24odCxlLG4pe3JldHVybiBaby5mKHQsZSxuKX0sbXU9enQsU3U9cm8sd3U9bmUsT3U9bGUsTHU9dGksanU9c2ksQXU9aGksUHU9TGksSXU9X2ksRXU9cWkuZm9yRWFjaCxUdT1BbygiaGlkZGVuIiksa3U9IlN5bWJvbCIseHU9InByb3RvdHlwZSIsRnU9SXUuc2V0LEN1PUl1LmdldHRlckZvcihrdSksTnU9T2JqZWN0W3h1XSxNdT1ZaS5TeW1ib2wsUnU9TXUmJk11W3h1XSxVdT1ZaS5SYW5nZUVycm9yLER1PVlpLlR5cGVFcnJvcixfdT1ZaS5RT2JqZWN0LEd1PXB1LmYsSHU9aHUuZixCdT1sdS5mLFZ1PWR1LmYsV3U9JGkoW10ucHVzaCksenU9bXUoInN5bWJvbHMiKSxLdT1tdSgib3Atc3ltYm9scyIpLHF1PW11KCJ3a3MiKSxKdT0hX3V8fCFfdVt4dV18fCFfdVt4dV0uZmluZENoaWxkLFl1PWZ1bmN0aW9uKHQsZSxuKXt2YXIgcj1HdShOdSxlKTtyJiZkZWxldGUgTnVbZV0sSHUodCxlLG4pLHImJnQhPT1OdSYmSHUoTnUsZSxyKX0sWHU9UWkmJnR1KChmdW5jdGlvbigpe3JldHVybiA3IT09Y3UoSHUoe30sImEiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gSHUodGhpcywiYSIse3ZhbHVlOjd9KS5hfX0pKS5hfSkpP1l1Okh1LCR1PWZ1bmN0aW9uKHQsZSl7dmFyIG49enVbdF09Y3UoUnUpO3JldHVybiBGdShuLHt0eXBlOmt1LHRhZzp0LGRlc2NyaXB0aW9uOmV9KSxRaXx8KG4uZGVzY3JpcHRpb249ZSksbn0sUXU9ZnVuY3Rpb24odCxlLG4pe3Q9PT1OdSYmUXUoS3UsZSxuKSxydSh0KTt2YXIgcj1pdShlKTtyZXR1cm4gcnUobiksZXUoenUscik/KG4uZW51bWVyYWJsZT8oZXUodCxUdSkmJnRbVHVdW3JdJiYodFtUdV1bcl09ITEpLG49Y3Uobix7ZW51bWVyYWJsZTphdSgwLCExKX0pKTooZXUodCxUdSl8fEh1KHQsVHUsYXUoMSxjdShudWxsKSkpLHRbVHVdW3JdPSEwKSxYdSh0LHIsbikpOkh1KHQscixuKX0sWnU9ZnVuY3Rpb24odCxlKXtydSh0KTt2YXIgbj1vdShlKSxyPXN1KG4pLmNvbmNhdChyYShuKSk7cmV0dXJuIEV1KHIsKGZ1bmN0aW9uKGUpe1FpJiYhWGkodGEsbixlKXx8UXUodCxlLG5bZV0pfSkpLHR9LHRhPWZ1bmN0aW9uKHQpe3ZhciBlPWl1KHQpLG49WGkoVnUsdGhpcyxlKTtyZXR1cm4hKHRoaXM9PT1OdSYmZXUoenUsZSkmJiFldShLdSxlKSkmJighKG58fCFldSh0aGlzLGUpfHwhZXUoenUsZSl8fGV1KHRoaXMsVHUpJiZ0aGlzW1R1XVtlXSl8fG4pfSxlYT1mdW5jdGlvbih0LGUpe3ZhciBuPW91KHQpLHI9aXUoZSk7aWYobiE9PU51fHwhZXUoenUscil8fGV1KEt1LHIpKXt2YXIgbz1HdShuLHIpO3JldHVybiFvfHwhZXUoenUscil8fGV1KG4sVHUpJiZuW1R1XVtyXXx8KG8uZW51bWVyYWJsZT0hMCksb319LG5hPWZ1bmN0aW9uKHQpe3ZhciBlPUJ1KG91KHQpKSxuPVtdO3JldHVybiBFdShlLChmdW5jdGlvbih0KXtldSh6dSx0KXx8ZXUoU3UsdCl8fFd1KG4sdCl9KSksbn0scmE9ZnVuY3Rpb24odCl7dmFyIGU9dD09PU51LG49QnUoZT9LdTpvdSh0KSkscj1bXTtyZXR1cm4gRXUobiwoZnVuY3Rpb24odCl7IWV1KHp1LHQpfHxlJiYhZXUoTnUsdCl8fFd1KHIsenVbdF0pfSkpLHJ9O1ppfHwoTXU9ZnVuY3Rpb24oKXtpZihudShSdSx0aGlzKSl0aHJvdyBuZXcgRHUoIlN5bWJvbCBpcyBub3QgYSBjb25zdHJ1Y3RvciIpO3ZhciB0PWFyZ3VtZW50cy5sZW5ndGgmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT91dShhcmd1bWVudHNbMF0pOnZvaWQgMCxlPXd1KHQpLG49ZnVuY3Rpb24odCl7dmFyIHI9dm9pZCAwPT09dGhpcz9ZaTp0aGlzO3I9PT1OdSYmWGkobixLdSx0KSxldShyLFR1KSYmZXUocltUdV0sZSkmJihyW1R1XVtlXT0hMSk7dmFyIG89YXUoMSx0KTt0cnl7WHUocixlLG8pfWNhdGNoKGkpe2lmKCEoaSBpbnN0YW5jZW9mIFV1KSl0aHJvdyBpO1l1KHIsZSxvKX19O3JldHVybiBRaSYmSnUmJlh1KE51LGUse2NvbmZpZ3VyYWJsZTohMCxzZXQ6bn0pLCR1KGUsdCl9LGJ1KFJ1PU11W3h1XSwidG9TdHJpbmciLChmdW5jdGlvbigpe3JldHVybiBDdSh0aGlzKS50YWd9KSksYnUoTXUsIndpdGhvdXRTZXR0ZXIiLChmdW5jdGlvbih0KXtyZXR1cm4gJHUod3UodCksdCl9KSksZHUuZj10YSxodS5mPVF1LGd1LmY9WnUscHUuZj1lYSxmdS5mPWx1LmY9bmEseXUuZj1yYSxMdS5mPWZ1bmN0aW9uKHQpe3JldHVybiAkdShPdSh0KSx0KX0sUWkmJnZ1KFJ1LCJkZXNjcmlwdGlvbiIse2NvbmZpZ3VyYWJsZTohMCxnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gQ3UodGhpcykuZGVzY3JpcHRpb259fSkpLEppKHtnbG9iYWw6ITAsY29uc3RydWN0b3I6ITAsd3JhcDohMCxmb3JjZWQ6IVppLHNoYW06IVppfSx7U3ltYm9sOk11fSksRXUoc3UocXUpLChmdW5jdGlvbih0KXtqdSh0KX0pKSxKaSh7dGFyZ2V0Omt1LHN0YXQ6ITAsZm9yY2VkOiFaaX0se3VzZVNldHRlcjpmdW5jdGlvbigpe0p1PSEwfSx1c2VTaW1wbGU6ZnVuY3Rpb24oKXtKdT0hMX19KSxKaSh7dGFyZ2V0OiJPYmplY3QiLHN0YXQ6ITAsZm9yY2VkOiFaaSxzaGFtOiFRaX0se2NyZWF0ZTpmdW5jdGlvbih0LGUpe3JldHVybiB2b2lkIDA9PT1lP2N1KHQpOlp1KGN1KHQpLGUpfSxkZWZpbmVQcm9wZXJ0eTpRdSxkZWZpbmVQcm9wZXJ0aWVzOlp1LGdldE93blByb3BlcnR5RGVzY3JpcHRvcjplYX0pLEppKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IVppfSx7Z2V0T3duUHJvcGVydHlOYW1lczpuYX0pLEF1KCksUHUoTXUsa3UpLFN1W1R1XT0hMDt2YXIgb2E9YnQmJiEhU3ltYm9sLmZvciYmISFTeW1ib2wua2V5Rm9yLGlhPUVuLHVhPXJ0LGFhPSR0LGNhPXFyLHNhPXp0LGZhPW9hLGxhPXNhKCJzdHJpbmctdG8tc3ltYm9sLXJlZ2lzdHJ5IikseWE9c2EoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTtpYSh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiFmYX0se2ZvcjpmdW5jdGlvbih0KXt2YXIgZT1jYSh0KTtpZihhYShsYSxlKSlyZXR1cm4gbGFbZV07dmFyIG49dWEoIlN5bWJvbCIpKGUpO3JldHVybiBsYVtlXT1uLHlhW25dPWUsbn19KTt2YXIgcGE9RW4saGE9JHQsZ2E9THQsZGE9QXQsYmE9b2EsdmE9enQoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKTtwYSh7dGFyZ2V0OiJTeW1ib2wiLHN0YXQ6ITAsZm9yY2VkOiFiYX0se2tleUZvcjpmdW5jdGlvbih0KXtpZighZ2EodCkpdGhyb3cgbmV3IFR5cGVFcnJvcihkYSh0KSsiIGlzIG5vdCBhIHN5bWJvbCIpO2lmKGhhKHZhLHQpKXJldHVybiB2YVt0XX19KTt2YXIgbWE9Um4sU2E9QSx3YT1TLE9hPXFyLExhPWQoW10ucHVzaCksamE9RW4sQWE9cnQsUGE9bCxJYT1rLEVhPWQsVGE9aSxrYT1BLHhhPUx0LEZhPVdvLENhPWZ1bmN0aW9uKHQpe2lmKFNhKHQpKXJldHVybiB0O2lmKG1hKHQpKXtmb3IodmFyIGU9dC5sZW5ndGgsbj1bXSxyPTA7cjxlO3IrKyl7dmFyIG89dFtyXTsic3RyaW5nIj09dHlwZW9mIG8/TGEobixvKToibnVtYmVyIiE9dHlwZW9mIG8mJiJOdW1iZXIiIT09d2EobykmJiJTdHJpbmciIT09d2Eobyl8fExhKG4sT2EobykpfXZhciBpPW4ubGVuZ3RoLHU9ITA7cmV0dXJuIGZ1bmN0aW9uKHQsZSl7aWYodSlyZXR1cm4gdT0hMSxlO2lmKG1hKHRoaXMpKXJldHVybiBlO2Zvcih2YXIgcj0wO3I8aTtyKyspaWYobltyXT09PXQpcmV0dXJuIGV9fX0sTmE9YnQsTWE9U3RyaW5nLFJhPUFhKCJKU09OIiwic3RyaW5naWZ5IiksVWE9RWEoLy4vLmV4ZWMpLERhPUVhKCIiLmNoYXJBdCksX2E9RWEoIiIuY2hhckNvZGVBdCksR2E9RWEoIiIucmVwbGFjZSksSGE9RWEoMS4udG9TdHJpbmcpLEJhPS9bXHVEODAwLVx1REZGRl0vZyxWYT0vXltcdUQ4MDAtXHVEQkZGXSQvLFdhPS9eW1x1REMwMC1cdURGRkZdJC8semE9IU5hfHxUYSgoZnVuY3Rpb24oKXt2YXIgdD1BYSgiU3ltYm9sIikoInN0cmluZ2lmeSBkZXRlY3Rpb24iKTtyZXR1cm4iW251bGxdIiE9PVJhKFt0XSl8fCJ7fSIhPT1SYSh7YTp0fSl8fCJ7fSIhPT1SYShPYmplY3QodCkpfSkpLEthPVRhKChmdW5jdGlvbigpe3JldHVybiciXFx1ZGYwNlxcdWQ4MzQiJyE9PVJhKCJcdWRmMDZcdWQ4MzQiKXx8JyJcXHVkZWFkIichPT1SYSgiXHVkZWFkIil9KSkscWE9ZnVuY3Rpb24odCxlKXt2YXIgbj1GYShhcmd1bWVudHMpLHI9Q2EoZSk7aWYoa2Eocil8fHZvaWQgMCE9PXQmJiF4YSh0KSlyZXR1cm4gblsxXT1mdW5jdGlvbih0LGUpe2lmKGthKHIpJiYoZT1JYShyLHRoaXMsTWEodCksZSkpLCF4YShlKSlyZXR1cm4gZX0sUGEoUmEsbnVsbCxuKX0sSmE9ZnVuY3Rpb24odCxlLG4pe3ZhciByPURhKG4sZS0xKSxvPURhKG4sZSsxKTtyZXR1cm4gVWEoVmEsdCkmJiFVYShXYSxvKXx8VWEoV2EsdCkmJiFVYShWYSxyKT8iXFx1IitIYShfYSh0LDApLDE2KTp0fTtSYSYmamEoe3RhcmdldDoiSlNPTiIsc3RhdDohMCxhcml0eTozLGZvcmNlZDp6YXx8S2F9LHtzdHJpbmdpZnk6ZnVuY3Rpb24odCxlLG4pe3ZhciByPUZhKGFyZ3VtZW50cyksbz1QYSh6YT9xYTpSYSxudWxsLHIpO3JldHVybiBLYSYmInN0cmluZyI9PXR5cGVvZiBvP0dhKG8sQmEsSmEpOm99fSk7dmFyIFlhPVhvLFhhPUp0O0VuKHt0YXJnZXQ6Ik9iamVjdCIsc3RhdDohMCxmb3JjZWQ6IWJ0fHxpKChmdW5jdGlvbigpe1lhLmYoMSl9KSl9LHtnZXRPd25Qcm9wZXJ0eVN5bWJvbHM6ZnVuY3Rpb24odCl7dmFyIGU9WWEuZjtyZXR1cm4gZT9lKFhhKHQpKTpbXX19KSxzaSgiYXN5bmNJdGVyYXRvciIpLHNpKCJoYXNJbnN0YW5jZSIpLHNpKCJpc0NvbmNhdFNwcmVhZGFibGUiKSxzaSgiaXRlcmF0b3IiKSxzaSgibWF0Y2giKSxzaSgibWF0Y2hBbGwiKSxzaSgicmVwbGFjZSIpLHNpKCJzZWFyY2giKSxzaSgic3BlY2llcyIpLHNpKCJzcGxpdCIpO3ZhciAkYT1oaTtzaSgidG9QcmltaXRpdmUiKSwkYSgpO3ZhciBRYT1ydCxaYT1MaTtzaSgidG9TdHJpbmdUYWciKSxaYShRYSgiU3ltYm9sIiksIlN5bWJvbCIpLHNpKCJ1bnNjb3BhYmxlcyIpLExpKG8uSlNPTiwiSlNPTiIsITApO3ZhciB0YyxlYyxuYyxyYz1RLlN5bWJvbCxvYz17fSxpYz1JLHVjPSR0LGFjPUZ1bmN0aW9uLnByb3RvdHlwZSxjYz1pYyYmT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcixzYz11YyhhYywibmFtZSIpLGZjPXtFWElTVFM6c2MsUFJPUEVSOnNjJiYic29tZXRoaW5nIj09PWZ1bmN0aW9uKCl7fS5uYW1lLENPTkZJR1VSQUJMRTpzYyYmKCFpY3x8aWMmJmNjKGFjLCJuYW1lIikuY29uZmlndXJhYmxlKX0sbGM9IWkoKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gdCgpe31yZXR1cm4gdC5wcm90b3R5cGUuY29uc3RydWN0b3I9bnVsbCxPYmplY3QuZ2V0UHJvdG90eXBlT2YobmV3IHQpIT09dC5wcm90b3R5cGV9KSkseWM9JHQscGM9QSxoYz1KdCxnYz1sYyxkYz1BbygiSUVfUFJPVE8iKSxiYz1PYmplY3QsdmM9YmMucHJvdG90eXBlLG1jPWdjP2JjLmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKHQpe3ZhciBlPWhjKHQpO2lmKHljKGUsZGMpKXJldHVybiBlW2RjXTt2YXIgbj1lLmNvbnN0cnVjdG9yO3JldHVybiBwYyhuKSYmZSBpbnN0YW5jZW9mIG4/bi5wcm90b3R5cGU6ZSBpbnN0YW5jZW9mIGJjP3ZjOm51bGx9LFNjPWksd2M9QSxPYz0kLExjPV9vLGpjPW1jLEFjPVFvLFBjPWxlKCJpdGVyYXRvciIpLEljPSExO1tdLmtleXMmJigibmV4dCJpbihuYz1bXS5rZXlzKCkpPyhlYz1qYyhqYyhuYykpKSE9PU9iamVjdC5wcm90b3R5cGUmJih0Yz1lYyk6SWM9ITApO3ZhciBFYz0hT2ModGMpfHxTYygoZnVuY3Rpb24oKXt2YXIgdD17fTtyZXR1cm4gdGNbUGNdLmNhbGwodCkhPT10fSkpO3djKCh0Yz1FYz97fTpMYyh0YykpW1BjXSl8fEFjKHRjLFBjLChmdW5jdGlvbigpe3JldHVybiB0aGlzfSkpO3ZhciBUYz17SXRlcmF0b3JQcm90b3R5cGU6dGMsQlVHR1lfU0FGQVJJX0lURVJBVE9SUzpJY30sa2M9VGMuSXRlcmF0b3JQcm90b3R5cGUseGM9X28sRmM9VSxDYz1MaSxOYz1vYyxNYz1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxSYz1FbixVYz1rLERjPWZjLF9jPWZ1bmN0aW9uKHQsZSxuLHIpe3ZhciBvPWUrIiBJdGVyYXRvciI7cmV0dXJuIHQucHJvdG90eXBlPXhjKGtjLHtuZXh0OkZjKCshcixuKX0pLENjKHQsbywhMSwhMCksTmNbb109TWMsdH0sR2M9bWMsSGM9TGksQmM9UW8sVmM9b2MsV2M9VGMsemM9RGMuUFJPUEVSLEtjPVdjLkJVR0dZX1NBRkFSSV9JVEVSQVRPUlMscWM9bGUoIml0ZXJhdG9yIiksSmM9ImtleXMiLFljPSJ2YWx1ZXMiLFhjPSJlbnRyaWVzIiwkYz1mdW5jdGlvbigpe3JldHVybiB0aGlzfSxRYz1mdW5jdGlvbih0LGUsbixyLG8saSx1KXtfYyhuLGUscik7dmFyIGEsYyxzLGY9ZnVuY3Rpb24odCl7aWYodD09PW8mJmcpcmV0dXJuIGc7aWYoIUtjJiZ0JiZ0IGluIHApcmV0dXJuIHBbdF07c3dpdGNoKHQpe2Nhc2UgSmM6Y2FzZSBZYzpjYXNlIFhjOnJldHVybiBmdW5jdGlvbigpe3JldHVybiBuZXcgbih0aGlzLHQpfX1yZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gbmV3IG4odGhpcyl9fSxsPWUrIiBJdGVyYXRvciIseT0hMSxwPXQucHJvdG90eXBlLGg9cFtxY118fHBbIkBAaXRlcmF0b3IiXXx8byYmcFtvXSxnPSFLYyYmaHx8ZihvKSxkPSJBcnJheSI9PT1lJiZwLmVudHJpZXN8fGg7aWYoZCYmKGE9R2MoZC5jYWxsKG5ldyB0KSkpIT09T2JqZWN0LnByb3RvdHlwZSYmYS5uZXh0JiYoSGMoYSxsLCEwLCEwKSxWY1tsXT0kYyksemMmJm89PT1ZYyYmaCYmaC5uYW1lIT09WWMmJih5PSEwLGc9ZnVuY3Rpb24oKXtyZXR1cm4gVWMoaCx0aGlzKX0pLG8paWYoYz17dmFsdWVzOmYoWWMpLGtleXM6aT9nOmYoSmMpLGVudHJpZXM6ZihYYyl9LHUpZm9yKHMgaW4gYykoS2N8fHl8fCEocyBpbiBwKSkmJkJjKHAscyxjW3NdKTtlbHNlIFJjKHt0YXJnZXQ6ZSxwcm90bzohMCxmb3JjZWQ6S2N8fHl9LGMpO3JldHVybiB1JiZwW3FjXSE9PWcmJkJjKHAscWMsZyx7bmFtZTpvfSksVmNbZV09ZyxjfSxaYz1mdW5jdGlvbih0LGUpe3JldHVybnt2YWx1ZTp0LGRvbmU6ZX19LHRzPVksZXM9b2MsbnM9X2k7WGUuZjt2YXIgcnM9UWMsb3M9WmMsaXM9IkFycmF5IEl0ZXJhdG9yIix1cz1ucy5zZXQsYXM9bnMuZ2V0dGVyRm9yKGlzKTtycyhBcnJheSwiQXJyYXkiLChmdW5jdGlvbih0LGUpe3VzKHRoaXMse3R5cGU6aXMsdGFyZ2V0OnRzKHQpLGluZGV4OjAsa2luZDplfSl9KSwoZnVuY3Rpb24oKXt2YXIgdD1hcyh0aGlzKSxlPXQudGFyZ2V0LG49dC5pbmRleCsrO2lmKCFlfHxuPj1lLmxlbmd0aClyZXR1cm4gdC50YXJnZXQ9bnVsbCxvcyh2b2lkIDAsITApO3N3aXRjaCh0LmtpbmQpe2Nhc2Uia2V5cyI6cmV0dXJuIG9zKG4sITEpO2Nhc2UidmFsdWVzIjpyZXR1cm4gb3MoZVtuXSwhMSl9cmV0dXJuIG9zKFtuLGVbbl1dLCExKX0pLCJ2YWx1ZXMiKSxlcy5Bcmd1bWVudHM9ZXMuQXJyYXk7dmFyIGNzPXtDU1NSdWxlTGlzdDowLENTU1N0eWxlRGVjbGFyYXRpb246MCxDU1NWYWx1ZUxpc3Q6MCxDbGllbnRSZWN0TGlzdDowLERPTVJlY3RMaXN0OjAsRE9NU3RyaW5nTGlzdDowLERPTVRva2VuTGlzdDoxLERhdGFUcmFuc2Zlckl0ZW1MaXN0OjAsRmlsZUxpc3Q6MCxIVE1MQWxsQ29sbGVjdGlvbjowLEhUTUxDb2xsZWN0aW9uOjAsSFRNTEZvcm1FbGVtZW50OjAsSFRNTFNlbGVjdEVsZW1lbnQ6MCxNZWRpYUxpc3Q6MCxNaW1lVHlwZUFycmF5OjAsTmFtZWROb2RlTWFwOjAsTm9kZUxpc3Q6MSxQYWludFJlcXVlc3RMaXN0OjAsUGx1Z2luOjAsUGx1Z2luQXJyYXk6MCxTVkdMZW5ndGhMaXN0OjAsU1ZHTnVtYmVyTGlzdDowLFNWR1BhdGhTZWdMaXN0OjAsU1ZHUG9pbnRMaXN0OjAsU1ZHU3RyaW5nTGlzdDowLFNWR1RyYW5zZm9ybUxpc3Q6MCxTb3VyY2VCdWZmZXJMaXN0OjAsU3R5bGVTaGVldExpc3Q6MCxUZXh0VHJhY2tDdWVMaXN0OjAsVGV4dFRyYWNrTGlzdDowLFRvdWNoTGlzdDowfSxzcz1vLGZzPUxpLGxzPW9jO2Zvcih2YXIgeXMgaW4gY3MpZnMoc3NbeXNdLHlzKSxsc1t5c109bHMuQXJyYXk7dmFyIHBzPXJjLGhzPWxlLGdzPVhlLmYsZHM9aHMoIm1ldGFkYXRhIiksYnM9RnVuY3Rpb24ucHJvdG90eXBlO3ZvaWQgMD09PWJzW2RzXSYmZ3MoYnMsZHMse3ZhbHVlOm51bGx9KSxzaSgiYXN5bmNEaXNwb3NlIiksc2koImRpc3Bvc2UiKSxzaSgibWV0YWRhdGEiKTt2YXIgdnM9cHMsbXM9ZCxTcz1ydCgiU3ltYm9sIiksd3M9U3Mua2V5Rm9yLE9zPW1zKFNzLnByb3RvdHlwZS52YWx1ZU9mKSxMcz1Tcy5pc1JlZ2lzdGVyZWRTeW1ib2x8fGZ1bmN0aW9uKHQpe3RyeXtyZXR1cm4gdm9pZCAwIT09d3MoT3ModCkpfWNhdGNoKGUpe3JldHVybiExfX07RW4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwfSx7aXNSZWdpc3RlcmVkU3ltYm9sOkxzfSk7Zm9yKHZhciBqcz16dCxBcz1ydCxQcz1kLElzPUx0LEVzPWxlLFRzPUFzKCJTeW1ib2wiKSxrcz1Ucy5pc1dlbGxLbm93blN5bWJvbCx4cz1BcygiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlOYW1lcyIpLEZzPVBzKFRzLnByb3RvdHlwZS52YWx1ZU9mKSxDcz1qcygid2tzIiksTnM9MCxNcz14cyhUcyksUnM9TXMubGVuZ3RoO05zPFJzO05zKyspdHJ5e3ZhciBVcz1Nc1tOc107SXMoVHNbVXNdKSYmRXMoVXMpfWNhdGNoKGJmKXt9dmFyIERzPWZ1bmN0aW9uKHQpe2lmKGtzJiZrcyh0KSlyZXR1cm4hMDt0cnl7Zm9yKHZhciBlPUZzKHQpLG49MCxyPXhzKENzKSxvPXIubGVuZ3RoO248bztuKyspaWYoQ3NbcltuXV09PWUpcmV0dXJuITB9Y2F0Y2goYmYpe31yZXR1cm4hMX07RW4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLGZvcmNlZDohMH0se2lzV2VsbEtub3duU3ltYm9sOkRzfSksc2koImN1c3RvbU1hdGNoZXIiKSxzaSgib2JzZXJ2YWJsZSIpLEVuKHt0YXJnZXQ6IlN5bWJvbCIsc3RhdDohMCxuYW1lOiJpc1JlZ2lzdGVyZWRTeW1ib2wifSx7aXNSZWdpc3RlcmVkOkxzfSksRW4oe3RhcmdldDoiU3ltYm9sIixzdGF0OiEwLG5hbWU6ImlzV2VsbEtub3duU3ltYm9sIixmb3JjZWQ6ITB9LHtpc1dlbGxLbm93bjpEc30pLHNpKCJtYXRjaGVyIiksc2koIm1ldGFkYXRhS2V5Iiksc2koInBhdHRlcm5NYXRjaCIpLHNpKCJyZXBsYWNlQWxsIik7dmFyIF9zPWUodnMpLEdzPWQsSHM9R24sQnM9cXIsVnM9SyxXcz1HcygiIi5jaGFyQXQpLHpzPUdzKCIiLmNoYXJDb2RlQXQpLEtzPUdzKCIiLnNsaWNlKSxxcz1mdW5jdGlvbih0KXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgcixvLGk9QnMoVnMoZSkpLHU9SHMobiksYT1pLmxlbmd0aDtyZXR1cm4gdTwwfHx1Pj1hP3Q/IiI6dm9pZCAwOihyPXpzKGksdSkpPDU1Mjk2fHxyPjU2MzE5fHx1KzE9PT1hfHwobz16cyhpLHUrMSkpPDU2MzIwfHxvPjU3MzQzP3Q/V3MoaSx1KTpyOnQ/S3MoaSx1LHUrMik6by01NjMyMCsoci01NTI5Njw8MTApKzY1NTM2fX0sSnM9e2NvZGVBdDpxcyghMSksY2hhckF0OnFzKCEwKX0uY2hhckF0LFlzPXFyLFhzPV9pLCRzPVFjLFFzPVpjLFpzPSJTdHJpbmcgSXRlcmF0b3IiLHRmPVhzLnNldCxlZj1Ycy5nZXR0ZXJGb3IoWnMpOyRzKFN0cmluZywiU3RyaW5nIiwoZnVuY3Rpb24odCl7dGYodGhpcyx7dHlwZTpacyxzdHJpbmc6WXModCksaW5kZXg6MH0pfSksKGZ1bmN0aW9uKCl7dmFyIHQsZT1lZih0aGlzKSxuPWUuc3RyaW5nLHI9ZS5pbmRleDtyZXR1cm4gcj49bi5sZW5ndGg/UXModm9pZCAwLCEwKToodD1KcyhuLHIpLGUuaW5kZXgrPXQubGVuZ3RoLFFzKHQsITEpKX0pKTt2YXIgbmY9ZSh0aS5mKCJpdGVyYXRvciIpKTtmdW5jdGlvbiByZih0KXtyZXR1cm4ocmY9ImZ1bmN0aW9uIj09dHlwZW9mIF9zJiYic3ltYm9sIj09dHlwZW9mIG5mP2Z1bmN0aW9uKHQpe3JldHVybiB0eXBlb2YgdH06ZnVuY3Rpb24odCl7cmV0dXJuIHQmJiJmdW5jdGlvbiI9PXR5cGVvZiBfcyYmdC5jb25zdHJ1Y3Rvcj09PV9zJiZ0IT09X3MucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiB0fSkodCl9dmFyIG9mPWUodGkuZigidG9QcmltaXRpdmUiKSk7ZnVuY3Rpb24gdWYodCl7dmFyIGU9ZnVuY3Rpb24odCxlKXtpZigib2JqZWN0IiE9cmYodCl8fCF0KXJldHVybiB0O3ZhciBuPXRbb2ZdO2lmKHZvaWQgMCE9PW4pe3ZhciByPW4uY2FsbCh0LGV8fCJkZWZhdWx0Iik7aWYoIm9iamVjdCIhPXJmKHIpKXJldHVybiByO3Rocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIil9cmV0dXJuKCJzdHJpbmciPT09ZT9TdHJpbmc6TnVtYmVyKSh0KX0odCwic3RyaW5nIik7cmV0dXJuInN5bWJvbCI9PXJmKGUpP2U6ZSsiIn1mdW5jdGlvbiBhZih0LGUsbil7cmV0dXJuKGU9dWYoZSkpaW4gdD9Obih0LGUse3ZhbHVlOm4sZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsd3JpdGFibGU6ITB9KTp0W2VdPW4sdH1jb25zdCBjZj17Z2V0TkFMVW5pdHModCl7bGV0IGU9YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0mJmFyZ3VtZW50c1sxXTtpZih0Lmxlbmd0aC10LnBvc2l0aW9uPDQpcmV0dXJuW107Y29uc3R7cG9zaXRpb246bn09dDtyZXR1cm4gMT09PXQuZ2V0SW50MzIobil8fDA9PT10LmdldEludDE2KG4pJiYxPT09dC5nZXRJbnQ4KG4rMik/Y2YuZ2V0QW5uZXhiTmFscyh0LGUpOmNmLmdldEF2Y2NOYWxzKHQsZSl9LGdldEFubmV4Yk5hbHModCxlKXtjb25zdCBuPVtdO2xldCByPWNmLmdldEhlYWRlclBvc2l0aW9uQW5uZXhCKHQpLG89ci5wb3MsaT1vO2Zvcig7bzx0Lmxlbmd0aC00Oyl7Y29uc3QgdT1uZXcgVWludDhBcnJheSh0LmJ1ZmZlci5zbGljZShvLG8rci5oZWFkZXJMZW5ndGgpKTtyLnBvcz09PXQucG9zaXRpb24mJnQuc2tpcChyLmhlYWRlckxlbmd0aCkscj1jZi5nZXRIZWFkZXJQb3NpdGlvbkFubmV4Qih0KSxpPXIucG9zO2NvbnN0IGE9e2hlYWRlcjp1LGJvZHk6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIuc2xpY2Uobyt1LmJ5dGVMZW5ndGgsaSkpLHR5cGU6LTF9O2U/Y2YuYW5hbHlzZUgyNjVOYWwoYSk6Y2YuYW5hbHlzZU5hbChhKSwoYS50eXBlPD05fHxlJiZhLnR5cGU8PTQwKSYmMCE9PWEudHlwZSYmbi5wdXNoKGEpLHQuc2tpcChpLXQucG9zaXRpb24pLG89aX1yZXR1cm4gbn0sZ2V0QXZjY05hbHModCxlKXtjb25zdCBuPVtdO2Zvcig7dC5wb3NpdGlvbjx0Lmxlbmd0aC00Oyl7Y29uc3Qgcj10LmdldEludDMyKHQucG9zaXRpb24pO2lmKCEodC5sZW5ndGgtdC5wb3NpdGlvbj49cikpYnJlYWs7e2NvbnN0IG89bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIuc2xpY2UodC5wb3NpdGlvbix0LnBvc2l0aW9uKzQpKTt0LnNraXAoNCk7Y29uc3QgaT1uZXcgVWludDhBcnJheSh0LmJ1ZmZlci5zbGljZSh0LnBvc2l0aW9uLHQucG9zaXRpb24rcikpO3Quc2tpcChyKTtjb25zdCB1PXtoZWFkZXI6byxib2R5OmksdHlwZTotMX07ZT9jZi5hbmFseXNlSDI2NU5hbCh1KTpjZi5hbmFseXNlTmFsKHUpLHUudHlwZTw9OSYmMCE9PXUudHlwZSYmbi5wdXNoKHUpfX1yZXR1cm4gbn0sYW5hbHlzZU5hbCh0KXtjb25zdCBlPTMxJnQuYm9keVswXTtzd2l0Y2godC50eXBlPWUsZSl7Y2FzZSAxOnQubmRyPSEwO2JyZWFrO2Nhc2UgNTp0Lmlkcj0hMDticmVhaztjYXNlIDY6dC5zZWk9ITA7YnJlYWs7Y2FzZSA3OnQuc3BzPSEwO2JyZWFrO2Nhc2UgODp0LnBwcz0hMH19LGFuYWx5c2VIMjY1TmFsKHQpe2NvbnN0IGU9KDEyNiZ0LmJvZHlbMF0pPj4xO3N3aXRjaCh0LnR5cGU9ZSxlKXtjYXNlIDM5OmNhc2UgNDA6dC5zZWk9ITB9fSxnZXRIZWFkZXJQb3NpdGlvbkFubmV4Qih0KXtsZXQgZT10LnBvc2l0aW9uLG49MDtjb25zdCByPXQubGVuZ3RoO2Zvcig7MyE9PW4mJjQhPT1uJiZlPHItNDspMD09PXQuZ2V0SW50MTYoZSk/MT09PXQuZ2V0SW50MTYoZSsyKT9uPTQ6MT09PXQuZ2V0SW50OChlKzIpP249MzplKys6ZSsrO3JldHVybiBlPT09ci00JiYoMD09PXQuZ2V0SW50MTYoZSk/MT09PXQuZ2V0SW50MTYoZSsyKT9uPTQ6ZT1yOihlKyssMD09PXQuZ2V0SW50MTYoZSkmJjE9PT10LmdldEludDgoZSk/bj0zOmU9cikpLHtwb3M6ZSxoZWFkZXJMZW5ndGg6bn19LGlzSDI2NVZpZGVvRnJhbWUodCl7dmFyIGU7cmV0dXJuKChudWxsPT09KGU9dC5nZXRNZXRhZGF0YSl8fHZvaWQgMD09PWV8fG51bGw9PT0oZT1lLmNhbGwodCkpfHx2b2lkIDA9PT1lP3ZvaWQgMDplLm1pbWVUeXBlKXx8IiIpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImgyNjUiKX19LHNmPW5ldyBVaW50OEFycmF5KFsxMDksMTY3LDUzLDE5MCwxMDMsOTAsNzIsMSwxNzAsODksNjMsMTY0LDE5NCwxOTksMTksODVdKSxmZj1uZXcgVWludDhBcnJheShbMTA5LDE2Nyw1MywxOTAsMTAzLDkwLDcyLDEsMTcwLDg5LDYzLDE2NCwxOTQsMTk5LDE5LDg0XSksbGY9bmV3IFVpbnQ4QXJyYXkoWzMxLDIzOSwzLDUwLDI0MiwxMjAsNzYsODUsMTY5LDQyLDE2MSw5MSw3NSwxODYsMjJdKTtmdW5jdGlvbiB5Zih0KXtjb25zdCBlPVtdO2Zvcig7dD49MjU1Oyl0LT0yNTUsZS5wdXNoKDI1NSk7cmV0dXJuIGUucHVzaCh0KSxuZXcgVWludDhBcnJheShlKX1mdW5jdGlvbiBwZih0KXtsZXQgZT1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06MCxuPTA7Zm9yKDsyNTU9PT10W2VdJiZlPHQuYnl0ZUxlbmd0aDspZSsrLG4rPTI1NTtyZXR1cm4gZTx0LmJ5dGVMZW5ndGgmJihuKz10W2UrK10pLFtuLGVdfWNvbnN0IGhmPW5ldyBVaW50OEFycmF5KFs4MCwxXSk7Y2xhc3MgZ2Z7c3RhdGljIGdlbmVyYXRlU0VJKHQsZSl7bGV0IG49YXJndW1lbnRzLmxlbmd0aD4yJiZ2b2lkIDAhPT1hcmd1bWVudHNbMl0mJmFyZ3VtZW50c1syXTtjb25zdCByPW5ldyBVaW50OEFycmF5KFswLDAsMCwxXSksbz1lP2hmOm5ldyBVaW50OEFycmF5KFs2XSksaT1uZXcgVWludDhBcnJheShbNV0pLHU9Z2YuX191dWlkfHwobj9zZjpmZiksYT15Zih0LmJ5dGVMZW5ndGgrdS5ieXRlTGVuZ3RoKSxjPSh0PT57Y29uc3QgZT1bXTtsZXQgbj0wO2Zvcihjb25zdCByIG9mIHQpbj49MiYmcjw9MyYmKGUucHVzaCgzKSxuPTApLDA9PT1yP24rKzpuPTAsZS5wdXNoKHIpO3JldHVybiBuZXcgVWludDhBcnJheShlKX0pKHQpO3JldHVybiBuZXcgVWludDhBcnJheShbLi4uciwuLi5vLC4uLmksLi4uYSwuLi51LC4uLmMsMTI4XSl9c3RhdGljIGRlY29kZVNFSUJvZHkodCxlKXtjb25zdCBuPSh0PT57Y29uc3QgZT1bXTtmb3IobGV0IG49MDtuPHQubGVuZ3RoO24rKyl0W25dPD0zJiYwPT09dFtuLTFdJiYwPT09dFtuLTJdfHxlLnB1c2godFtuXSk7cmV0dXJuIG5ldyBVaW50OEFycmF5KGUpfSkodD10LnNsaWNlKDAsdC5sZW5ndGgtMSkpO2lmKG4uYnl0ZUxlbmd0aDwyKXJldHVybjtsZXQgcj0wO2NvbnN0IG89ZT8yOjE7aWYoNSE9PW5bb10mJjEwMCE9PW5bb10pcmV0dXJuO3IrPTErbztjb25zdFtpLHVdPXBmKG4scik7cj11O2xldCBhPTI7Y29uc3QgYz1yK2k7bi5ieXRlTGVuZ3RoPj1mZi5ieXRlTGVuZ3RoJiZpPj1mZi5ieXRlTGVuZ3RoJiYobi5zbGljZShyLHIrZmYuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PWZmLnRvU3RyaW5nKCl8fG4uc2xpY2UocixyK2xmLmJ5dGVMZW5ndGgpLnRvU3RyaW5nKCk9PT1sZi50b1N0cmluZygpKT8ocis9ZmYuYnl0ZUxlbmd0aCxhPTEpOm4uYnl0ZUxlbmd0aD49ZmYuYnl0ZUxlbmd0aCYmaT49ZmYuYnl0ZUxlbmd0aCYmbi5zbGljZShyLHIrc2YuYnl0ZUxlbmd0aCkudG9TdHJpbmcoKT09PXNmLnRvU3RyaW5nKCkmJihyKz1zZi5ieXRlTGVuZ3RoLGE9MCk7cmV0dXJue3R5cGU6YSxwYXlsb2FkOm4uc2xpY2UocixjKX19c3RhdGljIHBhcnNlSW50ZXJuYWxTRUkodCl7Y29uc3QgZT1uZXcgTWFwO2xldCBuPTA7aWYoMD09PXQudHlwZSl7Zm9yKDt0LnBheWxvYWQuYnl0ZUxlbmd0aC1uPj0yOyl7Y29uc3RbcixvXT1wZih0LnBheWxvYWQsbik7bj1vO2NvbnN0W2ksdV09cGYodC5wYXlsb2FkLG4pO2lmKG49dSxlLmdldChyKXx8IShpPD10LnBheWxvYWQuYnl0ZUxlbmd0aC1uKSlicmVhaztlLnNldChyLHQucGF5bG9hZC5zbGljZShuLG4raSkpLG4rPWl9cmV0dXJuIGV9fXN0YXRpYyBtYWtlSW50ZXJuYWxTZWkodCl7Y29uc3QgZT1bXTtmb3IoY29uc3RbbyxpXW9mIHQpe2NvbnN0IHQ9eWYobyksbj15ZihpLmJ5dGVMZW5ndGgpO2UucHVzaCh0LG4saSl9Y29uc3Qgbj1lLnJlZHVjZSgoKHQsZSk9PnQrZS5ieXRlTGVuZ3RoKSwwKSxyPW5ldyBVaW50OEFycmF5KG4pO3JldHVybiBlLnJlZHVjZSgoKHQsZSk9PihyLnNldChlLHQpLHQrZS5ieXRlTGVuZ3RoKSksMCkscn19YWYoZ2YsIl9fdXVpZCIsdm9pZCAwKTtjbGFzcyBkZntjb25zdHJ1Y3Rvcih0KXthZih0aGlzLCJzZWlMaXN0IixbXSksYWYodGhpcywibWF4U0VJQ291bnQiLDEpLHRoaXMubWF4U0VJQ291bnQ9dC5tYXhTRUlDb3VudH1zZW5kU0VJVHJhbnNmb3JtKHQsZSl7Y29uc3R7bWF4U0VJQ291bnQ6bixzZWlMaXN0OnJ9PXRoaXM7aWYoIXRoaXMuc2VpTGlzdC5sZW5ndGgpcmV0dXJuIHZvaWQgZS5lbnF1ZXVlKHQpO2NvbnN0IG89W107bGV0IGk9MDtmb3IoY29uc3QgYyBvZiByKXtpZihvLmxlbmd0aD49bilicmVhaztjb25zdCBlPWdmLmdlbmVyYXRlU0VJKGMuY29udGVudCxjZi5pc0gyNjVWaWRlb0ZyYW1lKHQpKTtpKz1lLmJ5dGVMZW5ndGgsYy5yZXBlYXRDb3VudC0tLG8ucHVzaChlKX10aGlzLnNlaUxpc3Q9ci5maWx0ZXIoKHQ9PnQucmVwZWF0Q291bnQ+MCkpO2NvbnN0IHU9bmV3IFVpbnQ4QXJyYXkoaSt0LmRhdGEuYnl0ZUxlbmd0aCk7dS5zZXQobmV3IFVpbnQ4QXJyYXkodC5kYXRhKSk7bGV0IGE9dC5kYXRhLmJ5dGVMZW5ndGg7by5mb3JFYWNoKCh0PT57dS5zZXQodCxhKSxhKz10LmJ5dGVMZW5ndGh9KSksdC5kYXRhPXUuYnVmZmVyLGUuZW5xdWV1ZSh0KX1wdXNoU0VJKHQpe3RoaXMuc2VpTGlzdC5wdXNoKHQpfXJldm9rZVNFSSh0KXtjb25zdCBlPXRoaXMuc2VpTGlzdC5maW5kSW5kZXgoKGU9PmUudXVpZD09PXQpKTtyZXR1cm4tMSE9PWUmJih0aGlzLnNlaUxpc3Quc3BsaWNlKGUsMSksITApfX0idW5kZWZpbmVkIiE9dHlwZW9mIHNlbGYmJiJEZWRpY2F0ZWRXb3JrZXJHbG9iYWxTY29wZSI9PT1zZWxmLmNvbnN0cnVjdG9yLm5hbWUmJnNlbGYuYWRkRXZlbnRMaXN0ZW5lcigicnRjdHJhbnNmb3JtIiwodD0+e2NvbnN0e3RyYW5zZm9ybWVyOmV9PXQse3BvcnQ6bixtYXhTRUlDb3VudDpyfT1lLm9wdGlvbnMsbz1uZXcgZGYoe21heFNFSUNvdW50OnJ9KSxpPW5ldyBUcmFuc2Zvcm1TdHJlYW0oe3RyYW5zZm9ybTpvLnNlbmRTRUlUcmFuc2Zvcm0uYmluZChvKX0pO24ub25tZXNzYWdlPXQ9PntsZXR7ZGF0YTplfT10O2NvbnN0e3R5cGU6cixjb250ZW50Oml9PWU7aWYoInB1c2giPT09cilvLnB1c2hTRUkoaSk7ZWxzZSBpZigicmV2b2tlIj09PXIpe2NvbnN0IHQ9by5yZXZva2VTRUkoaSk7cmV0dXJuIG4ucG9zdE1lc3NhZ2Uoe3R5cGU6InJldm9rZS1hY2siLGNvbnRlbnQ6e3V1aWQ6aSxpc05vdFNlbmQ6dH19KX19LGUucmVhZGFibGUucGlwZVRocm91Z2goaSkucGlwZVRvKGUud3JpdGFibGUpfSkpfSgpOwo=",rP="undefined"!=typeof window&&window.Blob&&new Blob([atob(sP)],{type:"text/javascript;charset=utf-8"});function nP(){let e;try{if(e=rP&&(tL||window.webkitURL).createObjectURL(rP),!e)throw"";return new Worker(e)}catch(t){return new Worker("data:application/javascript;base64,"+sP)}finally{!("undefined"!=typeof window&&navigator.userAgent.indexOf("Trident/")>0)&&e&&(tL||window.webkitlRL).revokeObjectURL(e)}}const aP={getNALUnits(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.length-e.position<4)return[];const{position:i}=e;return 1===e.getInt32(i)||0===e.getInt16(i)&&1===e.getInt8(i+2)?aP.getAnnexbNals(e,t):aP.getAvccNals(e,t)},getAnnexbNals(e,t){const i=[];let o=aP.getHeaderPositionAnnexB(e),s=o.pos,r=s;for(;s<e.length-4;){const n=new Uint8Array(e.buffer.slice(s,s+o.headerLength));o.pos===e.position&&e.skip(o.headerLength),o=aP.getHeaderPositionAnnexB(e),r=o.pos;const a={header:n,body:new Uint8Array(e.buffer.slice(s+n.byteLength,r)),type:-1};t?aP.analyseH265Nal(a):aP.analyseNal(a),(a.type<=9||t&&a.type<=40)&&0!==a.type&&i.push(a),e.skip(r-e.position),s=r}return i},getAvccNals(e,t){const i=[];for(;e.position<e.length-4;){const o=e.getInt32(e.position);if(!(e.length-e.position>=o))break;{const s=new Uint8Array(e.buffer.slice(e.position,e.position+4));e.skip(4);const r=new Uint8Array(e.buffer.slice(e.position,e.position+o));e.skip(o);const n={header:s,body:r,type:-1};t?aP.analyseH265Nal(n):aP.analyseNal(n),n.type<=9&&0!==n.type&&i.push(n)}}return i},analyseNal(e){const t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:e.sei=!0;break;case 7:e.sps=!0;break;case 8:e.pps=!0}},analyseH265Nal(e){const t=(126&e.body[0])>>1;switch(e.type=t,t){case 39:case 40:e.sei=!0}},getHeaderPositionAnnexB(e){let t=e.position,i=0;const o=e.length;for(;3!==i&&4!==i&&t<o-4;)0===e.getInt16(t)?1===e.getInt16(t+2)?i=4:1===e.getInt8(t+2)?i=3:t++:t++;return t===o-4&&(0===e.getInt16(t)?1===e.getInt16(t+2)?i=4:t=o:(t++,0===e.getInt16(t)&&1===e.getInt8(t)?i=3:t=o)),{pos:t,headerLength:i}},isH265VideoFrame(e){var t;return((null===(t=e.getMetadata)||void 0===t||null===(t=t.call(e))||void 0===t?void 0:t.mimeType)||"").toLowerCase().includes("h265")}};class dP{constructor(e){Ou(this,"_position",0),Ou(this,"_dataview",void 0),this._dataview=new DataView(e)}get length(){return this.buffer.byteLength}get buffer(){return this._dataview.buffer}set position(e){this._position=e}get position(){return this._position}back(e){this.position-=e}getUint8(e){return this._dataview.getUint8(e)}getInt8(e){return this._dataview.getInt8(e)}getInt16(e){return this._dataview.getInt16(e)}getUint16(e){return this._dataview.getUint16(e)}getUint32(e){return this._dataview.getUint32(e)}getInt32(e){return this._dataview.getInt32(e)}skip(e){const t=Math.floor(e/4),i=e%4;for(let o=0;o<t;o++)dP.readByte(this,4);i>0&&dP.readByte(this,i)}static readByte(e,t,i){let o;switch(t){case 1:o=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:o=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");o=e.getUint8(e.position)<<16,o|=e.getUint8(e.position+1)<<8,o|=e.getUint8(e.position+2);break;case 4:o=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");o=e.getUint32(e.position)<<32,o|=e.getUint32(e.position+4);break;default:o=""}return e.position+=t,o}readUint8(){return dP.readByte(this,1)}readUint16(){return dP.readByte(this,2)}readUint24(){return dP.readByte(this,3)}readUint32(){return dP.readByte(this,4)}readUint64(){return dP.readByte(this,8)}readInt8(){return dP.readByte(this,1,!0)}readInt16(){return dP.readByte(this,2,!0)}readInt32(){return dP.readByte(this,4,!0)}writeUint32(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}}function cP(e){return new TransformStream({transform(t,i){const o=aP.isH265VideoFrame(t);aP.getNALUnits(new dP(t.data),o).forEach((t=>{if(t.sei){const i=sI.decodeSEIBody(t.body,o);i&&(_y.SKIP_SEI_FILTER||i.type===BT.external)&&e(i)}})),i.enqueue(t)}})}"undefined"!=typeof self&&"DedicatedWorkerGlobalScope"===self.constructor.name&&self.addEventListener("rtctransform",(e=>{const{transformer:t}=e,{port:i}=t.options,o=cP((e=>{i.postMessage(e,[e.payload.buffer])}));t.readable.pipeThrough(o).pipeTo(e.transformer.writable)}));class lP{constructor(e){Ou(this,"seiList",[]),Ou(this,"maxSEICount",1),this.maxSEICount=e.maxSEICount}sendSEITransform(e,t){const{maxSEICount:i,seiList:o}=this;if(!this.seiList.length)return void t.enqueue(e);const s=[];let r=0;for(const d of o){if(s.length>=i)break;const t=sI.generateSEI(d.content,aP.isH265VideoFrame(e));r+=t.byteLength,d.repeatCount--,s.push(t)}this.seiList=o.filter((e=>e.repeatCount>0));const n=new Uint8Array(r+e.data.byteLength);n.set(new Uint8Array(e.data));let a=e.data.byteLength;s.forEach((e=>{n.set(e,a),a+=e.byteLength})),e.data=n.buffer,t.enqueue(e)}pushSEI(e){this.seiList.push(e)}revokeSEI(e){const t=this.seiList.findIndex((t=>t.uuid===e));return-1!==t&&(this.seiList.splice(t,1),!0)}}"undefined"!=typeof self&&"DedicatedWorkerGlobalScope"===self.constructor.name&&self.addEventListener("rtctransform",(e=>{const{transformer:t}=e,{port:i,maxSEICount:o}=t.options,s=new lP({maxSEICount:o}),r=new TransformStream({transform:s.sendSEITransform.bind(s)});i.onmessage=e=>{let{data:t}=e;const{type:o,content:r}=t;if("push"===o)s.pushSEI(r);else if("revoke"===o){const e=s.revokeSEI(r);return i.postMessage({type:"revoke-ack",content:{uuid:r,isNotSend:e}})}},t.readable.pipeThrough(r).pipeTo(t.writable)}));class uP extends aT{constructor(e){super(),Ou(this,"isScreen",!1),Ou(this,"audioMid",void 0),Ou(this,"videoMid",void 0),Ou(this,"audioMLine",void 0),Ou(this,"videoMLine",void 0),Ou(this,"videoTransceiver",void 0),Ou(this,"audioTransceiver",void 0),Ou(this,"vendorHandler",void 0),Ou(this,"vendorCode",0),Ou(this,"engineId",void 0),Ou(this,"logger",void 0),Ou(this,"__seiHelper",sI),Ou(this,"logName","StreamBase"),this._ctx=e,this.engineId=e.id,this.logger=new eS(this.constructor.name,2,e.id)}stopReport(e){this.statsReport.stopReport(e)}destroy(){var e,t;delete this.audioMid,delete this.videoMid,this.statsReport.destroy(),null===(e=this.observer)||void 0===e||e.reset(),delete this.videoTransceiver,delete this.audioTransceiver,null===(t=this.vendorHandler)||void 0===t||t.destroy(),this.vendorCode=0,delete this.vendorHandler}}var hP=(e=>(e[e.INIT=0]="INIT",e[e.SUB_ING=1]="SUB_ING",e[e.SUB_ED=2]="SUB_ED",e))(hP||{});class mP extends uP{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:bL.STREAM_INDEX_MAIN;super(e),Ou(this,"id",void 0),Ou(this,"stream",void 0),Ou(this,"streamId",void 0),Ou(this,"videoTrack",void 0),Ou(this,"audioTrack",void 0),Ou(this,"subVideoDescriptions",[]),Ou(this,"observer",void 0),Ou(this,"statsReport",void 0),Ou(this,"pubAudio",!1),Ou(this,"pubVideo",!1),Ou(this,"blackFrameRenderInterval",void 0),Ou(this,"blackFrameLifetimeInterval",void 0),Ou(this,"pubAttributes",void 0),Ou(this,"pcSessionId",void 0),Ou(this,"maxSeiCount",1),Ou(this,"preReports",{audio:{},video:{}}),Ou(this,"remoteSdp",void 0),Ou(this,"currentVideoCodec",void 0),Ou(this,"_changeCodecs",[]),Ou(this,"_videoCaps",[]),Ou(this,"_sendSEIHandler",void 0),Ou(this,"logName","LocalStream"),this.stream=new MediaStream,this.id=vm(),this.pubAttributes={localaudio:!1,localvideo:!1,videostream:!1,audiostream:!1,extvideo:!1,extaudio:!1,videoDescriptions:[],videoType:ST.NORMAL},this.isScreen=t===bL.STREAM_INDEX_SCREEN,this.statsReport=new lL(e,this);const i=vy("SEI_COUNT_FPS");"number"==typeof i&&i<=10&&(this.maxSeiCount=i)}get enableSimulcast(){return!this.isScreen&&this._ctx.videoProfile.getSimulcastMode()}get videoEncodeConfig(){return this.isScreen?[this._ctx.videoProfile.getScreenEncodeConfig()]:this._ctx.videoProfile.getVideoEncodeConfig()}get audioHasCapture(){return this.pubAttributes.localaudio}get audioHasPublish(){return this.pubAttributes.audiostream}get videoHasCapture(){return this.pubAttributes.localvideo}get videoHasPublish(){return this.pubAttributes.videostream}get isEmptyStream(){return!this.audioTrack&&!this.videoTrack}get initStreamId(){return this.stream.id}async getSelectedCodec(){var e;const t=this._changeCodecs.length>0?this._changeCodecs:this._videoCaps.length>0?this._videoCaps:await LT(),i=this._ctx.videoProfile.getPreferCodec(this.isScreen),o=this.isScreen?this._ctx.targetScreenCodec:this._ctx.targetCodec;if(i&&i!==oh.AUTO){if(i===oh.H264&&t.includes(ZT.H264))return ZT.H264;if(i===oh.VP8&&t.includes(ZT.VP8))return ZT.VP8;if(i===oh.ByteVC1&&t.includes(ZT.ByteVC1))return ZT.ByteVC1}if(null!==(e=this._ctx.serverConfig)&&void 0!==e&&e.videoCodec&&t.includes(this._ctx.serverConfig.videoCodec))return this._ctx.serverConfig.videoCodec;if(i===oh.AUTO&&t.length>0)return t[0];if(o&&t.includes(o))return o;if(t.includes(ZT.H264))return ZT.H264;if(t.includes(ZT.VP8))return ZT.VP8;throw new Error("no available codec")}startReport(e,t){this.statsReport.setLocalStreamStatsEvtInterval(e,t)}getLocalStreamStats(){return this.statsReport.getLocalStats()}initVideoEncodedTransform(){if(vy("DISABLE_ENCODED_TRANSFORM"))return void this.logger.warn("initVideoEncodedTransform","DISABLE_ENCODED_TRANSFORM");if(!this.videoTransceiver||!this.videoTransceiver.sender)return void this.logger.warn("initVideoEncodedTransform","no sender found when trying to bind encodedTransform");const{sender:e}=this.videoTransceiver;if(DT()){const{readable:t,writable:i}=e.createEncodedStreams(),o=new lP({maxSEICount:this.maxSeiCount}),s=new TransformStream({transform:o.sendSEITransform.bind(o)});t.pipeThrough(s).pipeTo(i),this._sendSEIHandler=o}else if(OT()){const e=new nP,t=new MessageChannel;this.videoTransceiver.sender.transform=new RTCRtpScriptTransform(e,{port:t.port2,maxSEICount:this.maxSeiCount},[t.port2]),this._sendSEIHandler={pushSEI:e=>{t.port1.postMessage({type:"push",content:e},[e.content.buffer])},revokeSEI:async e=>(t.port1.postMessage({type:"revoke",content:e}),new Promise((i=>{t.port1.addEventListener("message",(t=>{let{data:o}=t;const{type:s,content:r}=o,{uuid:n,isNotSend:a}=r;"revoke-ack"===s&&n===e&&i(a)}))})))}}}initAudioEncodedTransform(){if(vy("DISABLE_ENCODED_TRANSFORM"))return void this.logger.warn("initVideoEncodedTransform","DISABLE_ENCODED_TRANSFORM");if(!this.audioTransceiver||!this.audioTransceiver.sender)return void this.logger.warn("initAudioEncodedTransform","no sender found when trying to bind encodedTransform");if(!DT())return void this.logger.warn("initAudioEncodedTransform","legacy EncodedTransform is not supported");const{sender:e}=this.audioTransceiver,{readable:t,writable:i}=e.createEncodedStreams();t.pipeThrough(new TransformStream({transform:(e,t)=>{t.enqueue(e)}})).pipeTo(i)}clean(){Wv(this.engineId,"localstream_clean","".concat((new Error).stack),0,this.streamId||""),super.destroy(),this.subVideoDescriptions=[],clearTimeout(this.blackFrameLifetimeInterval),clearInterval(this.blackFrameRenderInterval)}switchTrackEnableState(e,t){var i;let o;"audio"===e?o=this.audioTrack:"video"===e&&(o=this.videoTrack);const s=null===(i=o)||void 0===i?void 0:i.mediaTrack;return!(!s||(null==s?void 0:s.enabled)===t)&&(s.enabled=t,!0)}resetStream(){this.stream=new MediaStream}genBlackFrame(){var e,t;this.logger.info("genBlackFrame()");const i=null!==(e=this.videoEncodeConfig[0])&&void 0!==e&&e.frameRate?jy(null===(t=this.videoEncodeConfig[0])||void 0===t?void 0:t.frameRate):15,o=Math.ceil(1e3/i),s=document.createElement("canvas"),r=s.getContext("2d");s.width=16,s.height=16;const n=e=>{e.fillRect(0,0,16,16)};r&&(r.fillStyle="#000",n(r),this.blackFrameRenderInterval=window.setInterval((()=>{n(r)}),o),this.refreshBlackFrameLifetime());return s.captureStream(i).getVideoTracks()[0]}stopBlackFrame(){this.logger.info("stopBlackFrame()"),clearTimeout(this.blackFrameLifetimeInterval),clearInterval(this.blackFrameRenderInterval),delete this.blackFrameRenderInterval}refreshBlackFrameLifetime(){this.logger.info("refreshBlackFrameLifetime()"),this.blackFrameRenderInterval&&(clearTimeout(this.blackFrameLifetimeInterval),this.blackFrameLifetimeInterval=setTimeout((()=>{clearInterval(this.blackFrameRenderInterval),delete this.blackFrameRenderInterval,this.emit("black-frame-ended")}),_y.BLACK_FRAME_LIFETIME))}setChangeCodecs(e){this._changeCodecs=e}setVideoCaps(e){if(!e)return;const t=e.split(",").map((e=>{const t=dm(e).call(e).toUpperCase();return{H264:ZT.H264,VP8:ZT.VP8,BYTEVC1:ZT.ByteVC1}[t]||null})).filter((e=>null!==e));this._videoCaps=t}sendSEIMessage(e){var t;this.logger.info("sendSEIMessage"),null===(t=this._sendSEIHandler)||void 0===t||t.pushSEI(e)}async revokeSEIMessage(e){var t;return this.logger.info("revokeSEIMessage"),this._sendSEIHandler?null===(t=this._sendSEIHandler)||void 0===t?void 0:t.revokeSEI(e):(this.logger.warn("revokeSEIMessage","no sei handler found"),!1)}destroy(){super.removeAllListeners(),super.destroy()}}class pP extends uP{constructor(e,t,i,o,s,r){super(e),Ou(this,"streamId",void 0),Ou(this,"userId",void 0),Ou(this,"isPublic",void 0),Ou(this,"hasVideo",void 0),Ou(this,"hasAudio",void 0),Ou(this,"_attributes",void 0),Ou(this,"streamState",void 0),Ou(this,"removeTrack",!1),Ou(this,"observer",void 0),Ou(this,"statsReport",void 0),Ou(this,"subVideo",void 0),Ou(this,"subAudio",void 0),Ou(this,"subMediaType",void 0),Ou(this,"subLayer",void 0),Ou(this,"_sequenceId",void 0),Ou(this,"stream",void 0),Ou(this,"videoTrack",void 0),Ou(this,"audioTrack",void 0),Ou(this,"recordedVideoFrames",void 0),Ou(this,"stillExist",void 0),Ou(this,"originalMediaType",void 0),Ou(this,"priority",void 0),Ou(this,"remoteSessionId",""),Ou(this,"originalStreamIndex",0),Ou(this,"virtual",void 0),Ou(this,"pcSessionId",void 0),Ou(this,"_virtualOccupy",void 0),Ou(this,"_videoStallObserver",void 0),Ou(this,"_audioStallObserver",void 0),Ou(this,"preReports",{audio:{},video:{}}),Ou(this,"_installInfo",void 0),this.virtual=!1,this._virtualOccupy=!1,this.userId=t,this.isScreen=o,this.isPublic=s,this.streamId=i,this.logName="RemoteStream-".concat(i),this.hasAudio=r.audiostream&&r.localaudio,this.hasVideo=r.videostream&&r.localvideo,this._attributes=r,this.vendorCode=(null==r?void 0:r.vendorCode)||0,this.subVideo=!1,this.subAudio=!1,this._sequenceId=0,this.subMediaType=ly.NONE,this.subLayer={spatialLayer:0,spatialSubLayer:-1},this.streamState=0,this.statsReport=new uL(e,this),this.enableVendorMode&&(this.pcSessionId=vm())}get vendor(){return this._attributes.vendorCode}get audioHasCapture(){return this._attributes.localaudio}get audioHasPublish(){return this._attributes.audiostream}get videoHasCapture(){return this._attributes.localvideo}get videoHasPublish(){return this._attributes.videostream}get sequenceId(){return this._sequenceId||-1}set sequenceId(e){"number"==typeof e&&(this._sequenceId=e)}get enableVendorMode(){return"number"==typeof this.attributes.vendorCode&&0!==this.attributes.vendorCode}get hasSubscribed(){return 2===this.streamState}get attributes(){return this._attributes}set attributes(e){this.hasVideo=e.localvideo&&e.videostream,this.hasAudio=e.localaudio&&e.audiostream,this._attributes=e,this.vendorCode=e.vendorCode||0}get virtualOccupy(){return this._virtualOccupy}set virtualOccupy(e){var t;if(this._virtualOccupy&&!e)null===(t=this.observer)||void 0===t||t.setPushTrack(!1);else if(!this._virtualOccupy&&e){var i;null===(i=this.observer)||void 0===i||i.setPushTrack(!0)}this._virtualOccupy=e}startReport(e,t){this.statsReport.setRemoteStreamStatsEvtInterval(e,t)}getRemoteStreamStats(){return this.statsReport.getRemoteStreamStats()}initVideoEncodedTransform(){if(vy("DISABLE_ENCODED_TRANSFORM"))this.logger.warn("initVideoEncodedTransform","DISABLE_ENCODED_TRANSFORM");else if(this.videoTransceiver&&this.videoTransceiver.receiver){if(DT()){var e;null===(e=this._ctx.monitor)||void 0===e||e.report("rtc_invoke_status",{sdk_api_name:"initVideoEncodedTransform",message:"using legacy EncodedTransform",error_code:0,stream_id:this.streamId,elapse:0});const{receiver:t}=this.videoTransceiver,{readable:i,writable:o}=t.createEncodedStreams();i.pipeThrough(cP((e=>{this.safeEmit("onSEIMessage",e.payload)}))).pipeTo(o)}else if(OT()){var t;null===(t=this._ctx.monitor)||void 0===t||t.report("rtc_invoke_status",{sdk_api_name:"initVideoEncodedTransform",message:"using standard EncodedTransform",error_code:0,stream_id:this.streamId,elapse:0});const e=new oP,i=new MessageChannel;this.videoTransceiver.receiver.transform=new RTCRtpScriptTransform(e,{port:i.port2},[i.port2]),i.port1.onmessage=e=>{this.safeEmit("onSEIMessage",e.data.payload)}}}else this.logger.warn("no receiver found when trying to bind encodedTransform")}initAudioEncodedTransform(){if(vy("DISABLE_ENCODED_TRANSFORM"))return void this.logger.warn("initVideoEncodedTransform","DISABLE_ENCODED_TRANSFORM");if(!this.audioTransceiver||!this.audioTransceiver.receiver)return void this.logger.warn("no receiver found when trying to bind encodedTransform");if(!DT())return void this.logger.warn("legacy EncodedTransform is not supported");const{receiver:e}=this.audioTransceiver,{readable:t,writable:i}=e.createEncodedStreams();t.pipeThrough(new TransformStream({transform:(e,t)=>{e.data.byteLength<=1e3?t.enqueue(e):this.logger.print("too large audio frame",e.data.byteLength)}})).pipeTo(i)}ontrack(e){var t;try{Wv(this.engineId,"Stream.ontrack",JSON.stringify({uid:this.userId,streamId:this.streamId,streams:e.streams.reduce(((e,t)=>e+fm(t)),""),transceiver:Im(e.transceiver),track:ym(e.track)}),0,this.streamId||"")}catch(BW){}if(this.enableVendorMode||null!==(t=e.streams)&&void 0!==t&&null!==(t=t[0])&&void 0!==t&&null!==(t=t.id)&&void 0!==t&&t.includes(this.streamId)){var i;const{track:t}=e;"video"===(null==t?void 0:t.kind)?this._setVideoTrack(t):"audio"===(null===(i=e.track)||void 0===i?void 0:i.kind)&&this._setAudioTrack(t),this._setStream(e.streams[0])}this.safeEmit("ontrack",e)}startVideoStallObserve(e){this.logger.info("startVideoStallObserve","invoke",e.playerId),this._videoStallObserver||(this._videoStallObserver=new hL(this.isScreen,this.engineId)),this._videoStallObserver.start(e)}stopVideoStallObserve(){var e;this.logger.info("stopVideoStallObserve","invoke"),null===(e=this._videoStallObserver)||void 0===e||e.stop()}updateVideoStallInfo(e,t,i){let o;var s;i?(o=null===(s=this._videoStallObserver)||void 0===s?void 0:s.getStallInfo({interval:e.stats_interval||0,bitrate:e.bitrate,frameRateDecoded:e.frame_rate_decoded,frameRateReceived:e.frame_rate_received}),this._installInfo=o):o=this._installInfo;if(o){const s=Math.min(o.report.stallDuration,e.stats_interval||0);if(e.play_time=o.pts,e.stall_count=o.report.stallCount,e.is_screen?e.stuck_length=s:e.stall_duration=s,e.pause_duration=Math.min(s,o.pauseDuration),t.stallCount=o.callback.stallCount,t.stallDuration=o.callback.stallDuration,o.stall100ms){const i=Math.min(o.stall100ms.duration,e.stats_interval||0);e.stall_duration_100ms=i,e.stall_count_100ms=o.stall100ms.count,t.stallDuration100MS=i,t.stallCount100MS=o.stall100ms.count}var r;if(0!==o.report.stallCount||0!==o.report.stallDuration)this.logger.print("video_stall_report",this.userId,null===(r=this.videoTrack)||void 0===r?void 0:r.observingPlayerId,JSON.stringify(o.report),i)}}getVideoRenderInfo(){var e;return(null===(e=this._videoStallObserver)||void 0===e?void 0:e.getRecentRenderInfo4Report())||{}}stopAudioStallObserve(){var e;this.logger.info("stopAudioStallObserve","invoke"),null===(e=this._audioStallObserver)||void 0===e||e.stop()}async updateAudioStallInfo(e,t,i){if(this._audioStallObserver){const i=await this._audioStallObserver.getAudioStallInfo();return e.concealedSamples===e.interval_concealed_samples&&e.totalSamplesReceived===e.interval_samples_received?(e.stall_count=0,e.stall_duration=0,t.stallCount=0,t.stallDuration=0):(e.stall_count=i.report.stall_count,e.stall_duration=i.report.stall_duration,t.stallCount=i.callback.stall_count,t.stallDuration=i.callback.stall_duration),0===i.report.stall_count&&0===i.report.stall_duration||this.logger.print("audio_stall_report",this.userId,JSON.stringify(Yu(Yu({},i.report),{},{callbackList:i.callback.list}))),i.extra}this._audioStallObserver=new mL(this),this._audioStallObserver.start(i.concealedSamples,i.totalSamplesReceived),this.logger.print("startAduioObserver","start")}resetStream(){var e,t;null===(e=this.audioTransceiver)||void 0===e||e.stop(),null===(t=this.videoTransceiver)||void 0===t||t.stop(),this.audioTransceiver=void 0,this.videoTransceiver=void 0}clean(){var e,t;this.logger.info("clean","exec stream.clean ".concat(this.streamId," ").concat(this.userId)),Wv(this.engineId,"remotestream_clean","".concat((new Error).stack),0,this.streamId),super.destroy(),this.subAudio=!1,this.subVideo=!1,this.sequenceId=0,null===(e=this.videoTrack)||void 0===e||e.destroy(),this.videoTrack=void 0,null===(t=this.audioTrack)||void 0===t||t.destroy(),this.audioTrack=void 0,this.stream=void 0,this.recordedVideoFrames=void 0,delete this.priority}destroy(){var e,t;this.clean(),null===(e=this._audioStallObserver)||void 0===e||e.destroy(),delete this._audioStallObserver,null===(t=this._videoStallObserver)||void 0===t||t.destroy(),delete this._videoStallObserver,this.attributes={audiostream:!1,localaudio:!1,localvideo:!1,videostream:!1,extvideo:!1,extaudio:!1,videoDescriptions:[]},super.removeAllListeners()}resetHasSubscribed(){this.streamState=0}_setStream(e){this.stream=e,e.onaddtrack=e=>{"video"===e.track.kind?this._setVideoTrack(e.track):"audio"===e.track.kind&&this._setAudioTrack(e.track)}}_setAudioTrack(e){var t;if((null===(t=this.audioTrack)||void 0===t||null===(t=t.preprocessingTrack)||void 0===t?void 0:t.id)!==e.id){this.audioTrack=eP(this._ctx,e,{streamIndex:this.isPublic?gT.PUBLIC:this.virtual?gT.VIRTUAL:this.isScreen?gT.SCREEN:gT.MAIN,streamUserId:this.userId});const t=this._ctx._remoteAudioTrackDumpConfig[this.isScreen?bL.STREAM_INDEX_SCREEN:bL.STREAM_INDEX_MAIN].get(this.userId);var i;if(null!=t&&t.callback&&null!=t&&t.frameSize)null===(i=this.audioTrack)||void 0===i||i.setDataFetcher(t.frameSize,(e=>{var i;this.audioHasCapture&&this.audioHasPublish&&(null===(i=t.callback)||void 0===i||i.call(t,e))}));this.emit("ontrack",this.audioTrack)}}_setVideoTrack(e){var t;(null===(t=this.videoTrack)||void 0===t||null===(t=t.preprocessingTrack)||void 0===t?void 0:t.id)!==e.id&&(this.videoTrack=function(e,t,i,o){return new xL(e,t,i,Yu({},o))}(this._ctx,e,this,{streamIndex:this.isPublic?gT.PUBLIC:this.virtual?gT.VIRTUAL:this.isScreen?gT.SCREEN:gT.MAIN,streamUserId:this.userId}),this.emit("ontrack",this.videoTrack))}}var _P=(e=>(e.RESUBSCRIBE="resubscribe",e.STREAM_FAILED="stream_failed",e.SUBSCRIBE_PUSH_TRACK="subscribe_push_track",e.REMOVE_PUSH_TRACK="remove_push_track",e.VIDEO_FIRST_FRAME="video_first_frame",e.ON_USER_PUBLISH_STATE_CHANGE="on_user_publish_state_change",e.ON_USER_START_AUDIO_CAPTURE="on_user_start_audio_capture",e.ON_USER_STOP_AUDIO_CAPTURE="on_user_stop_audio_capture",e.ON_USER_START_VIDEO_CAPTURE="on_user_start_video_capture",e.ON_USER_STOP_VIDEO_CAPTURE="on_user_stop_video_capture",e.ON_SEI_MESSAGED_RECEIVED="on_sei_messaged_received",e.ON_PUBLISH_RESULT="on_publish_result",e.ON_SUBSCRIBE_RESULT="ON_SUBSCRIBE_RESULT",e.ON_UPDATE_TOKEN_SUCCESS="on_update_token_success",e.ON_REMOTE_STREAM_STATS="ON_REMOTE_STREAM_STATS",e.ON_LOCAL_STREAM_STATS="ON_LOCAL_STREAM_STATS",e.ON_USER_LEAVE="on_user_leave",e.ON_ROOM_ERROR="on_room_error",e.ON_NETWORK_QUALITY="on_network_quality",e.ON_SIMULCAST_SUBSCRIBE_FALLBACK="on_simulcast_subscribe_fallback",e.ON_REMOTE_VIDEO_SIZE_CHANGED="on_remote_video_size_changed",e.ON_SUBTITLE_STATE_CHANGED="ON_SUBTITLE_STATE_CHANGED",e.ON_SUBTITLE_MESSAGE_RECEIVED="ON_SUBTITLE_MESSAGE_RECEIVED",e.ON_VIDEO_STREAM_BANNED="ON_VIDEO_STREAM_BANNED",e.ON_AUDIO_STREAM_BANNED="ON_AUDIO_STREAM_BANNED",e.ON_FORWARD_STREAM_ERROR="ON_FORWARD_STREAM_ERROR",e.ON_REJOIN_WITH_TCP="ON_REJOIN_WITH_TCP",e.PUB_RETRY="PUB_RETRY",e.SUB_RETRY="SUB_RETRY",e.VIDEO_TYPE_CHANGE="VIDEO_TYPE_CHANGE",e.JOIN_SUCCESS="JOIN_SUCCESS",e.UPDATE_PUBLISH="UPDATE_PUBLISH",e))(_P||{}),bP=(e=>(e[e.START=1]="START",e[e.START_SUCCESS=2]="START_SUCCESS",e[e.START_FAILED=3]="START_FAILED",e[e.UPDATE=4]="UPDATE",e[e.UPDATE_SUCCESS=5]="UPDATE_SUCCESS",e[e.UPDATE_FAILED=6]="UPDATE_FAILED",e[e.STOP=7]="STOP",e[e.STOP_SUCCESS=8]="STOP_SUCCESS",e[e.STOP_FAILED=9]="STOP_FAILED",e))(bP||{}),vP=(e=>(e[e.PUB=0]="PUB",e[e.UNPUB=1]="UNPUB",e))(vP||{});const SP=async(e,t,i,o)=>{try{var s,r,n,a;let h="",m=-1;const p="video"===t?null==i||null===(s=i.videoTrack)||void 0===s?void 0:s.originTrack:null==i||null===(r=i.audioTrack)||void 0===r?void 0:r.originTrack,_="video"===t?null==i||null===(n=i.videoTransceiver)||void 0===n?void 0:n.receiver:null==i||null===(a=i.audioTransceiver)||void 0===a?void 0:a.receiver;try{var d,c;const i=await(null===(d=e.peerConnection)||void 0===d?void 0:d.getStatsWithLowFrequency(p,!0,_)),o=(i||[]).find((e=>"inbound-rtp"===e.type)),s=await(null==_?void 0:_.getStats()),r=[];let n;var l;if(null==s||s.forEach((e=>r.push(e.type))),0===(null==i?void 0:i.length)&&0!==r.length)n=await(null===(l=e.peerConnection)||void 0===l?void 0:l.getStatsWithLowFrequency(void 0,void 0,_));h=JSON.stringify({type:t,reports:i.map((e=>e.type)),reports2:r,pc:(null===(c=e.peerConnection)||void 0===c?void 0:c.getOriginRTCPeerConnection())||null,track:(null==p?void 0:p.id)||null,bytes:null==o?void 0:o.bytesReceived,framesReceived:null==o?void 0:o.framesReceived,packetsReceived:null==o?void 0:o.packetsReceived,allReports:n})}catch(u){m=-999,h=u.mseeage||JSON.stringify(u)}null==o||o.report("rtc_invoke_status",{sdk_api_name:"first_frame_recv_timeout",error_code:m,message:h,stream_id:(null==i?void 0:i.streamId)||"",stream_user_id:null==i?void 0:i.userId,elapse:0})}catch(u){}},yP=async(e,t,i,o)=>{try{var s,r,n,a;let h="",m=-1;const p="video"===t?null==i||null===(s=i.videoTrack)||void 0===s?void 0:s.preprocessingTrack:null==i||null===(r=i.audioTrack)||void 0===r?void 0:r.preprocessingTrack,_="video"===t?null==i||null===(n=i.videoTransceiver)||void 0===n?void 0:n.sender:null==i||null===(a=i.audioTransceiver)||void 0===a?void 0:a.sender;try{var d,c;const i=await(null===(d=e.peerConnection)||void 0===d?void 0:d.getStatsWithLowFrequency(p,!0,_)),o=(i||[]).find((e=>"outbound-rtp"===e.type)),s=await(null==_?void 0:_.getStats()),r=[];let n;var l;if(null==s||s.forEach((e=>r.push(e.type))),0===i.length&&0!==r.length)n=await(null===(l=e.peerConnection)||void 0===l?void 0:l.getStatsWithLowFrequency(void 0,void 0,_));h=JSON.stringify({type:t,reports:i.map((e=>e.type)),reports2:r,pc:(null===(c=e.peerConnection)||void 0===c?void 0:c.getOriginRTCPeerConnection())||null,track:(null==p?void 0:p.id)||null,bytes:null==o?void 0:o.bytesSent,framesSent:null==o?void 0:o.framesSent,packetsSent:null==o?void 0:o.packetsSent,allReports:n})}catch(u){m=-999,h=u.mseeage||JSON.stringify(u)}null==o||o.report("rtc_invoke_status",{sdk_api_name:"first_frame_send_timeout",error_code:m,message:h,stream_id:(null==i?void 0:i.streamId)||"",stream_user_id:null==i?void 0:i.userId,elapse:0})}catch(u){}};class fP extends sT.EventEmitter{constructor(e,t){super(),Ou(this,"_audioEventSessionId",Ay()),Ou(this,"_videoEventSessionId",Ay()),Ou(this,"_stream",void 0),Ou(this,"_firstAudioFrameTimer",void 0),Ou(this,"_firstVideoFrameTimer",void 0),Ou(this,"_transportDelayInterval",void 0),Ou(this,"_transportDelay",void 0),Ou(this,"_firstVideoFrameInterval",void 0),Ou(this,"_firstAudioFrameInterval",void 0),Ou(this,"_isScreen",!1),Ou(this,"_audioFirstFrameState",0),Ou(this,"_videoFirstFrameState",0),Ou(this,"_timeout",1e4),Ou(this,"_currentAudioRecv",{startTime:0,eventSessionId:0,type:"login"}),Ou(this,"_currentVideoRecv",{startTime:0,eventSessionId:0,type:"login"}),Ou(this,"_login",!1),Ou(this,"_unMuteAudio",!1),Ou(this,"_enableAudio",!1),Ou(this,"_unMuteVideo",!1),Ou(this,"_enableVideo",!1),Ou(this,"_remoteUnmuteAudio",!1),Ou(this,"_remoteUnmuteVideo",!1),Ou(this,"_audioExternal",!1),Ou(this,"_pushAudio",!1),Ou(this,"_videoExternal",!1),Ou(this,"_pushVideo",!1),Ou(this,"_autoSubscribeVideo",!1),Ou(this,"_autoSubscribeAudio",!1),Ou(this,"_autoSubscribe",!1),Ou(this,"_publishVideo",!1),Ou(this,"_publishAudio",!1),Ou(this,"_subscribeAudio",!1),Ou(this,"_subscribeVideo",!1),Ou(this,"_subscribe",!1),Ou(this,"_pushTrack",!1),Ou(this,"_multiChatMode",!1),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),this._ctx=e,this._stream=t,this.getTransportDelay(),this._monitor=Nv(t.engineId),this.logger=new eS("RecvFrameObserver",0,t.engineId)}async beginRecvFrame(e,t){await this.getTransportDelay();let i=this._transportDelay,o=!0;if(["login","unmute","subscribe","push_track"].indexOf(t)>=0&&(i=0,o=!1),"audio"===e){var s,r,n,a,d,c,l,u;o||this._audioEventSessionId++,this._currentAudioRecv={startTime:Date.now(),eventSessionId:this._audioEventSessionId,type:t};const h={media_type:e,event_type:"begin_recv",type:t,is_screen:!(null===(s=this._stream)||void 0===s||!s.isScreen),start:null===(r=this._currentAudioRecv)||void 0===r?void 0:r.startTime,event_session_id:this._audioEventSessionId,stream_user_id:null===(n=this._stream)||void 0===n?void 0:n.userId,transport_delay:i,vendor_mode:(null===(a=this._stream)||void 0===a?void 0:a.vendorCode)||0,pc_session_id:(null===(d=this._stream)||void 0===d?void 0:d.pcSessionId)||(null===(c=this._ctx.peerConnection)||void 0===c?void 0:c.getConnectionId()),remote_rtc_session_id:null===(l=this._stream)||void 0===l?void 0:l.remoteSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this._firstAudioFrameTimer=setTimeout((()=>{SP(this._ctx,"audio",this._stream,this._monitor),this.stopRecvFrame("audio","timeout"),this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval)}),this._timeout),this.logger.info("rtcFirstFrameRecv",JSON.stringify(h)),null===(u=this._monitor)||void 0===u||u.report("rtc_first_frame",h),this._watchForFirstAudioFrameRecv(),this._audioFirstFrameState=1,this._login=!0,this._unMuteAudio=!0,this._enableAudio=!0,this._remoteUnmuteAudio=!0}else if("video"===e){var h,m,p,_,b,v,S,y;o||this._videoEventSessionId++,this._currentVideoRecv={startTime:Date.now(),eventSessionId:this._videoEventSessionId,type:t};const s={media_type:e,event_type:"begin_recv",type:t,is_screen:!(null===(h=this._stream)||void 0===h||!h.isScreen),start:null===(m=this._currentVideoRecv)||void 0===m?void 0:m.startTime,event_session_id:this._videoEventSessionId,stream_user_id:null===(p=this._stream)||void 0===p?void 0:p.userId,transport_delay:i,vendor_mode:(null===(_=this._stream)||void 0===_?void 0:_.vendorCode)||0,pc_session_id:(null===(b=this._stream)||void 0===b?void 0:b.pcSessionId)||(null===(v=this._ctx.peerConnection)||void 0===v?void 0:v.getConnectionId()),remote_rtc_session_id:null===(S=this._stream)||void 0===S?void 0:S.remoteSessionId};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this._firstVideoFrameTimer=setTimeout((()=>{SP(this._ctx,"video",this._stream,this._monitor),this.stopRecvFrame("video","timeout"),this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval)}),this._timeout),this._watchForFirstVideoFrameRecv(),this.logger.info("rtcFirstFrameRecv",JSON.stringify(s)),null===(y=this._monitor)||void 0===y||y.report("rtc_first_frame",s),this._videoFirstFrameState=1,this._login=!0,this._unMuteVideo=!0,this._enableVideo=!0,this._remoteUnmuteVideo=!0}}stopRecvFrame(e,t){if("audio"===e){var i,o,s,r,n,a,d,c,l;if(1!==this._audioFirstFrameState)return;const u={event_type:"recv_end",media_type:e,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),start:null===(o=this._currentAudioRecv)||void 0===o?void 0:o.startTime,reason:t,result:!1,stream_user_id:null===(s=this._stream)||void 0===s?void 0:s.userId,event_session_id:this._audioEventSessionId,type:null===(r=this._currentAudioRecv)||void 0===r?void 0:r.type,vendor_mode:(null===(n=this._stream)||void 0===n?void 0:n.vendorCode)||0,pc_session_id:(null===(a=this._stream)||void 0===a?void 0:a.pcSessionId)||(null===(d=this._ctx.peerConnection)||void 0===d?void 0:d.getConnectionId()),remote_rtc_session_id:null===(c=this._stream)||void 0===c?void 0:c.remoteSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),delete this._currentAudioRecv,this.logger.info("rtcFirstFrameRecv",JSON.stringify(u)),null===(l=this._monitor)||void 0===l||l.report("rtc_first_frame",u),this._audioFirstFrameState=2}else if("video"===e){var u,h,m,p,_,b,v,S,y;if(1!==this._videoFirstFrameState)return;const i={event_type:"recv_end",media_type:e,is_screen:!(null===(u=this._stream)||void 0===u||!u.isScreen),start:null===(h=this._currentVideoRecv)||void 0===h?void 0:h.startTime,reason:t,result:!1,stream_user_id:null===(m=this._stream)||void 0===m?void 0:m.userId,event_session_id:this._videoEventSessionId,type:null===(p=this._currentVideoRecv)||void 0===p?void 0:p.type,vendor_mode:(null===(_=this._stream)||void 0===_?void 0:_.vendorCode)||0,pc_session_id:(null===(b=this._stream)||void 0===b?void 0:b.pcSessionId)||(null===(v=this._ctx.peerConnection)||void 0===v?void 0:v.getConnectionId()),remote_rtc_session_id:null===(S=this._stream)||void 0===S?void 0:S.remoteSessionId};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),delete this._currentVideoRecv,this.logger.info("rtcFirstFrameRecv",JSON.stringify(i)),null===(y=this._monitor)||void 0===y||y.report("rtc_first_frame",i),this._videoFirstFrameState=2}}async recvFrameFinish(e){await this.getTransportDelay();let t=this._transportDelay;if("audio"===e){var i,o,s,r,n,a,d;if(1!==this._audioFirstFrameState)return;if(!this._currentAudioRecv)return;const{type:c,startTime:l}=this._currentAudioRecv;["login","unmute","subscribe","push_track"].indexOf(c)>=0&&(t=0);const u={event_type:"recv_end",media_type:e,start:l,result:!0,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),stream_user_id:null===(o=this._stream)||void 0===o?void 0:o.userId,event_session_id:this._audioEventSessionId,type:c,transport_delay:t,vendor_mode:(null===(s=this._stream)||void 0===s?void 0:s.vendorCode)||0,pc_session_id:(null===(r=this._stream)||void 0===r?void 0:r.pcSessionId)||(null===(n=this._ctx.peerConnection)||void 0===n?void 0:n.getConnectionId()),remote_rtc_session_id:null===(a=this._stream)||void 0===a?void 0:a.remoteSessionId};delete this._currentAudioRecv,this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this.logger.info("rtcFirstFrameRecv",JSON.stringify(u)),null===(d=this._monitor)||void 0===d||d.report("rtc_first_frame",u),this.emit("recvAudioFirstFrame"),this._audioFirstFrameState=3}else if("video"===e){var c,l,u,h,m,p,_;if(1!==this._videoFirstFrameState)return;if(!this._currentVideoRecv)return;const{type:i,startTime:o}=this._currentVideoRecv;["login","unmute","subscribe","push_track"].indexOf(i)>=0&&(t=0);const s={event_type:"recv_end",media_type:e,is_screen:!(null===(c=this._stream)||void 0===c||!c.isScreen),start:o,result:!0,stream_user_id:null===(l=this._stream)||void 0===l?void 0:l.userId,event_session_id:this._videoEventSessionId,type:i,transport_delay:t,vendor_mode:(null===(u=this._stream)||void 0===u?void 0:u.vendorCode)||0,pc_session_id:(null===(h=this._stream)||void 0===h?void 0:h.pcSessionId)||(null===(m=this._ctx.peerConnection)||void 0===m?void 0:m.getConnectionId()),remote_rtc_session_id:null===(p=this._stream)||void 0===p?void 0:p.remoteSessionId};delete this._currentVideoRecv,this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this.logger.info("rtcFirstFrameRecv",JSON.stringify(s)),null===(_=this._monitor)||void 0===_||_.report("rtc_first_frame",s),this.emit("recvVideoFirstFrame"),this._videoFirstFrameState=3}}setLogin(e){var t,i,o,s;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{audio:!0,video:!0};this._login!==e&&(this._login=e,e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&r.audio&&this.beginRecvFrame("audio","login"),e&&null!==(i=this._stream)&&void 0!==i&&i.hasVideo&&r.video&&this.beginRecvFrame("video","login"),!e&&null!==(o=this._stream)&&void 0!==o&&o.hasAudio&&this.stopRecvFrame("audio","leave_room"),!e&&null!==(s=this._stream)&&void 0!==s&&s.hasVideo&&this.stopRecvFrame("video","leave_room"))}setUnmuteAudio(e){var t,i,o;if(this._unMuteAudio===e)return;this._unMuteAudio=e;const s=!(null===(t=this._stream)||void 0===t||!t.hasAudio);null!==(i=this._stream)&&void 0!==i&&i.audioHasCapture&&null!==(o=this._stream)&&void 0!==o&&o.audioHasPublish&&(this._unMuteAudio&&s?this.beginRecvFrame("audio","unmute"):s&&this.stopRecvFrame("audio","mute"))}setRemoteUnmuteAudio(e){this._remoteUnmuteAudio!==e&&(this._remoteUnmuteAudio=e,this._remoteUnmuteAudio?this.beginRecvFrame("audio","remote_unmute"):this.stopRecvFrame("audio","remote_mute"))}setEnableAudio(e){this._enableAudio!==e&&(this._enableAudio=e,this._enableAudio?this.beginRecvFrame("audio","enable"):this.stopRecvFrame("audio","disable"))}setUnmuteVideo(e){var t,i,o;if(this._unMuteVideo===e)return;this._unMuteVideo=e;const s=!(null===(t=this._stream)||void 0===t||!t.hasVideo);null!==(i=this._stream)&&void 0!==i&&i.videoHasCapture&&null!==(o=this._stream)&&void 0!==o&&o.videoHasPublish&&(this._unMuteVideo&&s?this.beginRecvFrame("video","unmute"):s&&this.stopRecvFrame("video","mute"))}setRemoteUnmuteVideo(e){this._remoteUnmuteVideo!==e&&(this._remoteUnmuteVideo=e,this._remoteUnmuteVideo?this.beginRecvFrame("video","remote_unmute"):this.stopRecvFrame("video","remote_mute"))}setEnableVideo(e){this._enableVideo!==e&&(this._enableVideo=e,this._enableVideo?this.beginRecvFrame("video","enable"):this.stopRecvFrame("video","disable"))}setExternalAudioSource(e){this._audioExternal=e}setPushAudio(e){var t;this._audioExternal&&this._pushAudio!==e&&(this._pushAudio=e),this._pushAudio&&this.beginRecvFrame("audio","push"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","stop_push")}setExternalVideoSource(e){this._videoExternal=e}setPushVideo(e){var t;this._videoExternal&&this._pushVideo!==e&&(this._pushVideo=e),this._pushVideo&&this.beginRecvFrame("video","push"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasVideo&&this.stopRecvFrame("video","stop_push")}setPublishVideo(e){var t;this._publishVideo!==e&&(this._publishVideo=e),this._publishVideo&&this.beginRecvFrame("video","publish"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasVideo&&this.stopRecvFrame("video","unpublish")}setPublishAudio(e){var t;this._publishAudio!==e&&(this._publishAudio=e),this._publishAudio&&this.beginRecvFrame("audio","publish"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","unpublish")}setAutoSubscribe(e){this._autoSubscribe=e}setAutoSubscribeVideo(e){this._autoSubscribeVideo=e}setAutoSubscribeAudio(e){this._autoSubscribeAudio=e}setSubscribeAudio(e){var t,i;this._autoSubscribeAudio||this._subscribeAudio===e||(this._subscribe=e,e&&null!==(i=this._stream)&&void 0!==i&&i.hasAudio&&this.beginRecvFrame("audio","subscribe"));!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","unsubscribe")}setSubscribeVideo(e){var t,i;this._autoSubscribeVideo||this._subscribeVideo===e||(this._subscribeVideo=e,e&&null!==(i=this._stream)&&void 0!==i&&i.hasVideo&&this.beginRecvFrame("video","subscribe"));!e&&null!==(t=this._stream)&&void 0!==t&&t.hasVideo&&this.stopRecvFrame("video","unsubscribe")}setPushTrack(e){var t;this._pushTrack!==e&&(this._pushTrack=e,e&&!this._isScreen&&this.beginRecvFrame("audio","push_track"),!e&&null!==(t=this._stream)&&void 0!==t&&t.hasAudio&&this.stopRecvFrame("audio","remove_track"))}setMultiChatMode(e){this._multiChatMode=e}setTimeout(e){this._timeout=e}_watchForFirstVideoFrameRecv(){let e=-1,t=-1;this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval),this._firstVideoFrameInterval=window.setInterval((async()=>{var i,o,s;const r=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(r&&null!==(s=this._stream)&&void 0!==s&&null!==(s=s.videoTrack)&&void 0!==s&&s.preprocessingTrack){var n,a;const i=null===(n=this._stream.videoTransceiver)||void 0===n?void 0:n.receiver,o=(await r.getStatsWithLowFrequency(null===(a=this._stream)||void 0===a||null===(a=a.videoTrack)||void 0===a?void 0:a.preprocessingTrack,!0,i)).find((e=>"inbound-rtp"===e.type));if(o&&(o.framesReceived>e||o.packetsReceived>t)){if(-1===e&&-1===t)return e=o.framesReceived,void(t=o.packetsReceived);this.recvFrameFinish("video"),window.clearInterval(this._firstVideoFrameInterval)}}}),200)}_watchForFirstAudioFrameRecv(){let e=-1,t=-1;this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval),this._firstAudioFrameInterval=window.setInterval((async()=>{var i,o,s;const r=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(r&&null!==(s=this._stream)&&void 0!==s&&null!==(s=s.audioTrack)&&void 0!==s&&s.originTrack){var n;const i=(await r.getStatsWithLowFrequency(null===(n=this._stream)||void 0===n||null===(n=n.audioTrack)||void 0===n?void 0:n.originTrack)).find((e=>"inbound-rtp"===e.type));if(i&&(i.totalSamplesReceived>e||i.packetsReceived>t)){if(-1===e&&-1===t)return e=i.totalSamplesReceived,void(t=i.packetsReceived);this.recvFrameFinish("audio"),window.clearInterval(this._firstAudioFrameInterval)}}}),200)}async getTransportDelay(){await this.getTransportDelayIntl(),window.clearInterval(this._transportDelayInterval),this._transportDelayInterval=window.setInterval((async()=>{await this.getTransportDelayIntl()}),2e3)}async getTransportDelayIntl(){const e=this._ctx.peerConnection;if(e){var t;const i=null===(t=this._stream)||void 0===t||null===(t=t.videoTransceiver)||void 0===t?void 0:t.receiver,o=await e.getStatsWithLowFrequency(void 0,!0,i),s=o.find((e=>"transport"===e.type&&"connected"===e.dtlsState)),r=o.find((e=>"candidate-pair"===e.type&&"succeeded"===e.state&&e.id===(null==s?void 0:s.selectedCandidatePairId)));r&&(this._transportDelay=Math.round(1e3*r.currentRoundTripTime/2))}}setDisconnect(){this.stopRecvFrame("audio","connection_lost"),this.stopRecvFrame("video","connection_lost"),this.reset()}reset(){this._currentAudioRecv={startTime:0,eventSessionId:0,type:"login"},this._currentVideoRecv={startTime:0,eventSessionId:0,type:"login"},this._login=!1,this._unMuteAudio=!1,this._enableAudio=!1,this._unMuteVideo=!1,this._remoteUnmuteAudio=!1,this._remoteUnmuteVideo=!1,this._enableVideo=!1,this._audioExternal=!1,this._pushAudio=!1,this._videoExternal=!1,this._pushVideo=!1,this._autoSubscribeVideo=!1,this._autoSubscribeAudio=!1,this._autoSubscribe=!1,this._subscribeAudio=!1,this._subscribeVideo=!1,this._subscribe=!1,this._pushTrack=!1,this._multiChatMode=!1,this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval),this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval),this._transportDelayInterval&&window.clearInterval(this._transportDelayInterval)}get audioFirstFrameReceived(){return 3===this._audioFirstFrameState}get FirstFrameReceived(){return 3===this._audioFirstFrameState}}class gP{constructor(e,t){Ou(this,"_audioEventSessionId",Ay()),Ou(this,"_videoEventSessionId",Ay()),Ou(this,"_pcSessionId",void 0),Ou(this,"_firstAudioFrameTimer",void 0),Ou(this,"_firstVideoFrameTimer",void 0),Ou(this,"_stream",void 0),Ou(this,"_firstVideoFrameInterval",void 0),Ou(this,"_firstAudioFrameInterval",void 0),Ou(this,"_currentAudioSend",{startTime:0,eventSessionId:0,type:"login"}),Ou(this,"_currentVideoSend",{startTime:0,eventSessionId:0,type:"login"}),Ou(this,"_login",!1),Ou(this,"_publisher",!1),Ou(this,"_unMuteAudio",!1),Ou(this,"_enableAudio",!1),Ou(this,"_unMuteVideo",!1),Ou(this,"_enableVideo",!1),Ou(this,"_audioExternal",!1),Ou(this,"_pushAudio",!1),Ou(this,"_videoExternal",!1),Ou(this,"_pushVideo",!1),Ou(this,"_autoPublish",!1),Ou(this,"_publish",!1),Ou(this,"_timeout",1e4),Ou(this,"_audioFirstFrameState",0),Ou(this,"_videoFirstFrameState",0),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),this._ctx=e,this._stream=t,this._monitor=Nv(t.engineId),this.logger=new eS("SendFrameObserver",0,t.engineId)}beginSendFrame(e,t){if("audio"===e){var i,o,s,r,n,a;this._audioEventSessionId++,this._currentAudioSend={startTime:Date.now(),eventSessionId:this._audioEventSessionId,type:t};const d={event_type:"begin_send",media_type:e,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),type:t,start:this._currentAudioSend.startTime,event_session_id:this._audioEventSessionId,vendor_mode:(null===(o=this._stream)||void 0===o?void 0:o.vendorCode)||0,pc_session_id:(null===(s=this._stream)||void 0===s?void 0:s.pcSessionId)||(null===(r=this._ctx.peerConnection)||void 0===r?void 0:r.getConnectionId()),capture_session_id:null===(n=this._stream)||void 0===n||null===(n=n.audioTrack)||void 0===n?void 0:n.captureSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this._firstAudioFrameTimer=setTimeout((()=>{yP(this._ctx,"audio",this._stream,this._monitor),this.stopSendFrame("audio","timeout"),this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval)}),this._timeout),this.logger.info("rtcFirstFrameSend",JSON.stringify(d)),null===(a=this._monitor)||void 0===a||a.report("rtc_first_frame",d),this._watchForFirstAudioFrameSend(),this._audioFirstFrameState=1,this._login=!0,this._publisher=!0,this._publish=!0,this._unMuteAudio=!0,this._pushAudio||(this._enableAudio=!0)}else if("video"===e){var d,c,l,u,h,m;this._videoEventSessionId++,this._currentVideoSend={startTime:Date.now(),eventSessionId:this._videoEventSessionId,type:t};const i={event_type:"begin_send",media_type:e,is_screen:!(null===(d=this._stream)||void 0===d||!d.isScreen),type:t,start:this._currentVideoSend.startTime,event_session_id:this._videoEventSessionId,vendor_mode:(null===(c=this._stream)||void 0===c?void 0:c.vendorCode)||0,pc_session_id:(null===(l=this._stream)||void 0===l?void 0:l.pcSessionId)||(null===(u=this._ctx.peerConnection)||void 0===u?void 0:u.getConnectionId()),capture_session_id:null===(h=this._stream)||void 0===h||null===(h=h.videoTrack)||void 0===h?void 0:h.captureSessionId};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this._firstVideoFrameTimer=setTimeout((()=>{yP(this._ctx,"video",this._stream,this._monitor),this.stopSendFrame("video","timeout"),this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval)}),this._timeout),this._watchForFirstVideoFrameSend(),this.logger.info("rtcFirstFrameSend",JSON.stringify(i)),null===(m=this._monitor)||void 0===m||m.report("rtc_first_frame",i),this._videoFirstFrameState=1,this._login=!0,this._publisher=!0,this._publish=!0,this._unMuteVideo=!0,this._pushVideo||(this._enableVideo=!0)}}stopSendFrame(e,t){if("audio"===e){var i,o,s,r,n,a,d,c;if(1!==this._audioFirstFrameState)return;const l={event_type:"sent_end",media_type:e,is_screen:!(null===(i=this._stream)||void 0===i||!i.isScreen),start:null===(o=this._currentAudioSend)||void 0===o?void 0:o.startTime,reason:t,result:!1,event_session_id:this._audioEventSessionId,type:null===(s=this._currentAudioSend)||void 0===s?void 0:s.type,vendor_mode:(null===(r=this._stream)||void 0===r?void 0:r.vendorCode)||0,pc_session_id:(null===(n=this._stream)||void 0===n?void 0:n.pcSessionId)||(null===(a=this._ctx.peerConnection)||void 0===a?void 0:a.getConnectionId()),capture_session_id:null===(d=this._stream)||void 0===d||null===(d=d.audioTrack)||void 0===d?void 0:d.captureSessionId};this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),delete this._currentAudioSend,this.logger.info("rtcFirstFrameSend",JSON.stringify(l)),null===(c=this._monitor)||void 0===c||c.report("rtc_first_frame",l),this._audioFirstFrameState=2}else if("video"===e){var l,u,h,m,p,_,b,v;if(1!==this._videoFirstFrameState)return;const i={event_type:"sent_end",media_type:e,start:null===(l=this._currentVideoSend)||void 0===l?void 0:l.startTime,is_screen:!(null===(u=this._stream)||void 0===u||!u.isScreen),reason:t,result:!1,event_session_id:this._videoEventSessionId,type:null===(h=this._currentVideoSend)||void 0===h?void 0:h.type,vendor_mode:(null===(m=this._stream)||void 0===m?void 0:m.vendorCode)||0,pc_session_id:(null===(p=this._stream)||void 0===p?void 0:p.pcSessionId)||(null===(_=this._ctx.peerConnection)||void 0===_?void 0:_.getConnectionId()),capture_session_id:null===(b=this._stream)||void 0===b||null===(b=b.videoTrack)||void 0===b?void 0:b.captureSessionId};this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),delete this._currentVideoSend,this.logger.info("rtcFirstFrameSend",JSON.stringify(i)),null===(v=this._monitor)||void 0===v||v.report("rtc_first_frame",i),this._videoFirstFrameState=2}}sendFrameFinish(e){if("audio"===e){var t,i,o,s,r,n;if(1!==this._audioFirstFrameState)return;if(!this._currentAudioSend)return;const{type:a,startTime:d}=this._currentAudioSend,c={event_type:"sent_end",media_type:e,is_screen:!(null===(t=this._stream)||void 0===t||!t.isScreen),start:d,result:!0,event_session_id:this._audioEventSessionId,type:a,vendor_mode:(null===(i=this._stream)||void 0===i?void 0:i.vendorCode)||0,pc_session_id:(null===(o=this._stream)||void 0===o?void 0:o.pcSessionId)||(null===(s=this._ctx.peerConnection)||void 0===s?void 0:s.getConnectionId()),capture_session_id:null===(r=this._stream)||void 0===r||null===(r=r.audioTrack)||void 0===r?void 0:r.captureSessionId};delete this._currentAudioSend,this._firstAudioFrameTimer&&window.clearTimeout(this._firstAudioFrameTimer),this.logger.info("rtcFirstFrameSend",JSON.stringify(c)),null===(n=this._monitor)||void 0===n||n.report("rtc_first_frame",c),this._audioFirstFrameState=3}else if("video"===e){var a,d,c,l,u,h;if(1!==this._videoFirstFrameState)return;if(!this._currentVideoSend)return;const{type:t,startTime:i}=this._currentVideoSend,o={event_type:"sent_end",media_type:e,is_screen:!(null===(a=this._stream)||void 0===a||!a.isScreen),start:i,result:!0,event_session_id:this._videoEventSessionId,type:t,vendor_mode:(null===(d=this._stream)||void 0===d?void 0:d.vendorCode)||0,pc_session_id:(null===(c=this._stream)||void 0===c?void 0:c.pcSessionId)||(null===(l=this._ctx.peerConnection)||void 0===l?void 0:l.getConnectionId()),capture_session_id:null===(u=this._stream)||void 0===u||null===(u=u.videoTrack)||void 0===u?void 0:u.captureSessionId};delete this._currentVideoSend,this._firstVideoFrameTimer&&window.clearTimeout(this._firstVideoFrameTimer),this.logger.info("rtcFirstFrameSend",JSON.stringify(o)),null===(h=this._monitor)||void 0===h||h.report("rtc_first_frame",o),this._videoFirstFrameState=3}}setLogin(e){if(this._login!==e){var t,i;if(this._login=e,e)null!==(t=this._stream)&&void 0!==t&&t.videoTrack&&this._stream.pubVideo&&this.beginSendFrame("video","login"),null!==(i=this._stream)&&void 0!==i&&i.audioTrack&&this._stream.pubAudio&&this.beginSendFrame("audio","login");!e&&this._audioSending&&this.stopSendFrame("audio","leave_room"),!e&&this._videoSending&&this.stopSendFrame("video","leave_room")}}setPublish(e){if(this._publish!==e){var t,i;if(this._publish=e,e)(null===(t=this._stream)||void 0===t?void 0:t.videoTrack)&&this._stream.pubVideo&&this.beginSendFrame("video","publish"),(null===(i=this._stream)||void 0===i?void 0:i.audioTrack)&&this._stream.pubAudio&&this.beginSendFrame("audio","publish");!e&&this._audioSending&&this.stopSendFrame("audio","unpublish"),!e&&this._videoSending&&this.stopSendFrame("video","unpublish")}}setUnmuteAudio(e){var t;this._unMuteAudio!==e&&(this._unMuteAudio=e,null!==(t=this._stream)&&void 0!==t&&t.audioHasCapture&&(e&&this.beginSendFrame("audio","unmute"),!e&&this._audioSending&&this.stopSendFrame("audio","mute")))}setEnableAudio(e){var t;this._enableAudio!==e&&null!==(t=this._stream)&&void 0!==t&&t.pubAudio&&(this._enableAudio=e,e&&this.beginSendFrame("audio","enable"),!e&&this._audioSending&&this.stopSendFrame("audio","disable"))}setUnmuteVideo(e){var t;this._unMuteVideo!==e&&(this._unMuteVideo=e,null!==(t=this._stream)&&void 0!==t&&t.videoHasCapture&&(e&&this.beginSendFrame("video","unmute"),!e&&this._videoSending&&this.stopSendFrame("video","mute")))}setEnableVideo(e){var t;this._enableVideo!==e&&null!==(t=this._stream)&&void 0!==t&&t.pubVideo&&(this._enableVideo=e,e&&this.beginSendFrame("video","enable"),!e&&this._videoSending&&this.stopSendFrame("video","disable"))}setPushAudio(e){this._pushAudio!==e&&(this._pushAudio=e,e&&this.beginSendFrame("audio","push"),!e&&this._audioSending&&this.stopSendFrame("audio","stop_push"))}setPushVideo(e){this._pushVideo!==e&&(this._pushVideo=e,e&&this.beginSendFrame("video","push"),!e&&this._videoSending&&this.stopSendFrame("video","stop_push"))}setAutoPublish(e){this._autoPublish=e}setPublisher(e){this._publisher!==e&&(this._publisher=e,!e&&this._audioSending&&this.stopSendFrame("audio","audience"),!e&&this._videoSending&&this.stopSendFrame("video","audience"))}setDisconnect(){this._audioSending&&this.stopSendFrame("audio","connection_lost"),this._videoSending&&this.stopSendFrame("video","connection_lost"),this.reset()}setTimeout(e){this._timeout=e}setPCSessionId(e){this._pcSessionId=e}async _getFirstVideoFrameStats(){var e,t,i,o;const s=null===(e=this._stream)||void 0===e||null===(e=e.videoTrack)||void 0===e?void 0:e.preprocessingTrack,r=null===(t=this._stream)||void 0===t||null===(t=t.videoTransceiver)||void 0===t?void 0:t.sender,n=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(n&&s){return(await n.getStatsWithLowFrequency(s,!0,r)).filter((e=>"outbound-rtp"===e.type))}}async _getFirstAudioFrameStats(){var e,t,i,o;const s=null===(e=this._stream)||void 0===e||null===(e=e.audioTrack)||void 0===e?void 0:e.preprocessingTrack,r=null===(t=this._stream)||void 0===t||null===(t=t.audioTransceiver)||void 0===t?void 0:t.sender,n=null!==(i=null===(o=this._stream)||void 0===o||null===(o=o.vendorHandler)||void 0===o?void 0:o.peer)&&void 0!==i?i:this._ctx.peerConnection;if(n&&s){return(await n.getStatsWithLowFrequency(s,!0,r)).find((e=>"outbound-rtp"===e.type))}}_watchForFirstVideoFrameSend(){let e=-1,t=-1;this._firstVideoFrameInterval&&window.clearInterval(this._firstVideoFrameInterval),this._firstVideoFrameInterval=window.setInterval((async()=>{const i=await this._getFirstVideoFrameStats();let o=0,s=0;if(null==i||i.map((e=>{o+=e.framesSent,s+=e.packetsSent})),i&&i.length>0&&(o>e||s>t)){if(-1===e&&-1===t)return e=o,void(t=s);this.sendFrameFinish("video"),window.clearInterval(this._firstVideoFrameInterval)}}),100)}_watchForFirstAudioFrameSend(){let e=-1;this._firstAudioFrameInterval&&window.clearInterval(this._firstAudioFrameInterval),this._firstAudioFrameInterval=window.setInterval((async()=>{const t=await this._getFirstAudioFrameStats();if(t&&t.packetsSent>e){if(-1===e)return void(e=t.packetsSent);this.sendFrameFinish("audio"),window.clearInterval(this._firstAudioFrameInterval)}}),100)}reset(){this._login=!1,this._publisher=!1,this._unMuteAudio=!1,this._enableAudio=!1,this._unMuteVideo=!1,this._enableVideo=!1,this._audioExternal=!1,this._pushAudio=!1,this._videoExternal=!1,this._pushVideo=!1,this._autoPublish=!1,this._publish=!1,this._audioFirstFrameState=0,this._videoFirstFrameState=0,this._currentAudioSend={startTime:0,eventSessionId:0,type:"login"},this._currentVideoSend={startTime:0,eventSessionId:0,type:"login"},window.clearTimeout(this._firstAudioFrameTimer),window.clearTimeout(this._firstVideoFrameTimer),window.clearInterval(this._firstAudioFrameInterval),window.clearInterval(this._firstVideoFrameInterval)}destroy(){this.reset(),delete this._stream}get _audioSending(){return 1===this._audioFirstFrameState}get _videoSending(){return 1===this._videoFirstFrameState}}const TP={audio:{delay:1200,stallRadio:.3},video:{delay:1200,stallRadio:.6},screen_audio:{delay:1600,stallRadio:.8},screen_video:{delay:1600,stallRadio:.8}};class IP{constructor(e){Ou(this,"_preUplinkStats",new Map),Ou(this,"_preDownlinkStats",new Map),Ou(this,"_timer",void 0),Ou(this,"_delayTimer",void 0),Ou(this,"reportor",void 0),this._ctx=e}updateUplinkStats(e,t){const{audioStats:i,videoStats:o,isScreen:s}=e;if(i.sendKBitrate>0&&i.rtt){const e=s?"screen_audio":"audio",{rtt:t,_fractionLost:o,_retransmittedRate:r}=i,n=this._getQosLevel(t,o||0,r||0),a=this._preUplinkStats.get(e)||[n];this._preUplinkStats.set(e,[...a,n].slice(-2))}if(o.sentKBitrate>0&&o.rtt){const i=s?"screen_video":"video";let{_fractionLost:r}=o;const{rtt:n,_sendBandWidth:a,_retransmittedRate:d}=o;0===a&&(r=Math.max(.65,r));const c=this._getQosLevel(n,r||0,d||0),l=this._getUplinkVideoQoE(e,t),u=this._getVideoUplinkNetworkQuality(c,l),h=this._preUplinkStats.get(i)||[u];this._preUplinkStats.set(i,[...h,u].slice(-2))}this._startNetworkQualityReport()}updateDownlinkStats(e,t){if(!t)return;const{audioActive:i,videoActive:o}=this._getStreamActiveState(t),{audioStats:s,videoStats:r,isScreen:n,userId:a}=e;let d,c,l=!0,u=!0;if(i)if(0===s.receivedKBitrate)l=!1;else{const{rtt:e,audioLossRate:t,stallDuration:i,statsInterval:o,e2eDelay:a}=s,c=i/o,l=n?"screen_audio":"audio",u=this._getQosLevel(e,t||0,r._retransmittedRate||0),h=this._getDownlinkQoE(l,c,a);d=this._getNetworkQuality(u,h)}if(o)if(0===r.receivedKBitrate||0===r.rtt)u=!1;else{const{rtt:e,videoLossRate:t,stallDuration:i,statsInterval:o,e2eDelay:s,_retransmittedRate:a}=r,d=i/o,l=n?"screen_video":"video",u=this._getQosLevel(e,t||0,a||0),h=this._getDownlinkQoE(l,d,s);c=this._getNetworkQuality(u,h)}const h="".concat(a).concat(n?"_screen":"");if(!l&&!u)return void this._preDownlinkStats.delete(h);const m=d&&c?Math.ceil((d+c)/2):d||c;if(m){const e=this._preDownlinkStats.get(h)||[m];this._preDownlinkStats.set(h,[...e,m].slice(-2)),this._startNetworkQualityReport()}}destroy(){this._timer&&(window.clearInterval(this._timer),delete this._timer),this._delayTimer&&(window.clearTimeout(this._delayTimer),delete this._delayTimer),this._preUplinkStats.clear(),this._preDownlinkStats.clear()}_startNetworkQualityReport(){this._delayTimer||this._timer||(this._preUplinkStats.size>0||this._preDownlinkStats.size>0)&&(this._delayTimer=setTimeout((()=>{delete this._delayTimer,this._reportNetworkQuality(),this._timer=window.setInterval((()=>{this._reportNetworkQuality()}),2e3)}),300))}_reportNetworkQuality(){var e;let t,i;if(["connected","connecting"].includes(null===(e=this._ctx.handler)||void 0===e?void 0:e.getConnectionState())){const e=this._getBetterQualityAndRemoveOldest("audio","up"),o=this._getBetterQualityAndRemoveOldest("video","up");t=e&&o?Math.ceil((e+o)/2):e||o||this._getBetterQualityAndRemoveOldest("screen_video","up")||this._getBetterQualityAndRemoveOldest("screen_audio","up")||mh.EXCELLENT;const s=Array.from(this._preDownlinkStats.keys()).map((e=>this._getBetterQualityAndRemoveOldest(e,"down"))).filter((e=>e));i=Math.ceil(s.reduce(((e,t)=>t+e),0)/s.length)||mh.UNKNOWN}else t=i=mh.DOWN;navigator.onLine||(t=mh.DOWN,i=mh.DOWN),"function"==typeof this.reportor&&this.reportor(t,i)}_getNetworkQuality(e,t){return 1===t?Math.max(e-2,1):2===t?e:Math.min(e+1,5)}_getVideoUplinkNetworkQuality(e,t){return 1===t||0===t?e:2===t?Math.min(e+1,5):Math.min(e+2,5)}_getQosLevel(e,t,i){let o;return o=(!e||e<=250)&&t<=.15?1:(!e||e<=500)&&t<=.3?2:(!e||e<=750)&&t<=.45?3:(!e||e<=1e3)&&t<=.6?4:5,i>.5?o=Math.max(o,4):i>.35?o=Math.max(o,3):i>.15&&(o=Math.max(o,2)),o}_getUplinkQoE(e,t){let i=0;switch(e){case"audio":case"video":i=t<.05?1:t<.1?2:3;break;case"screen_video":case"screen_audio":i=t<.04?1:t<.08?2:3}return i}_getUplinkVideoQoE(e,t){var i;const o=(null==e||null===(i=e.videoStats)||void 0===i?void 0:i.rid)||"0";if(!t)return 0;const s=t.pubAttributes.videoDescriptions[o],r=e.videoStats,n=r.encodedFrameWidth*r.encodedFrameHeight/(s.width*s.height),a=r.sentFrameRate/s.framerate;let d=0,c=0;return"number"!=typeof n||Number.isNaN(n)||(d=n>=.9?1:n<.9&&n>=.8?2:3),"number"!=typeof a||Number.isNaN(a)||(c=a>=.8?1:a<.8&&a>=.6?2:3),Math.max(0,d,c)}_getDownlinkQoE(e,t,i){const o=TP[e];return t>o.stallRadio||i>o.delay||t>o.stallRadio/2&&i>o.delay/2?3:(t>o.stallRadio/2||o.delay,2)}_getBetterQualityAndRemoveOldest(e,t){let i=mh.UNKNOWN;const o="up"===t?this._preUplinkStats:this._preDownlinkStats,s=o.get(e);if(s){const t=s.filter((e=>e));t.length>0&&(i=Math.min(...t)),s.shift(),0===s.length&&o.delete(e)}return i}_getStreamActiveState(e){let{subMediaType:t,_attributes:i,subVideo:o,subAudio:s}=e;return{audioActive:s&&Ky(t)&&i.localaudio&&i.audiostream,videoActive:o&&Uy(t)&&i.localvideo&&i.videostream}}}class RP{constructor(e){Ou(this,"_timer",void 0),Ou(this,"_remoteVideoSizeCache",{}),Ou(this,"_remoteScreenSizeCache",{}),Ou(this,"onchange",void 0),this._room=e,this._start()}destroy(){this._timer&&(window.clearInterval(this._timer),delete this._timer),this._remoteVideoSizeCache={},this._remoteScreenSizeCache={}}_start(){this._timer||(this._timer=window.setInterval((()=>{const e={},t={};this._room.remoteStreams.forEach(((i,o)=>{i.forEach((i=>{var s;const r=null===(s=i.videoTrack)||void 0===s?void 0:s.preprocessingTrack;if(r){const s=i.isScreen?this._remoteScreenSizeCache:this._remoteVideoSizeCache,{width:d=0,height:c=0}=s[o]||{};let l=0,u=0;if(sS){var n,a;({width:l,height:u}=null!==(n=null==i||null===(a=i.videoTrack)||void 0===a?void 0:a.getSizeByPlayer())&&void 0!==n?n:{width:0,height:0})}else{const e=r.getSettings();l=e.width||0,u=e.height||0}c===u&&d===l||"function"==typeof this.onchange&&this.onchange(o,i.isScreen,l,u),delete s[o],(i.isScreen?t:e)[o]={width:l,height:u}}}))})),Object.keys(this._remoteVideoSizeCache).forEach((e=>{"function"==typeof this.onchange&&this.onchange(e,!1,0,0)})),Object.keys(this._remoteScreenSizeCache).forEach((e=>{"function"==typeof this.onchange&&this.onchange(e,!0,0,0)})),this._remoteVideoSizeCache=e,this._remoteScreenSizeCache=t}),1e3))}}const EP=Array.from((new TextEncoder).encode("subt")),CP={1:US.SUBTITLE_ERR_POSTPROCESS,2:US.SUBTITLE_ERR_CONNECTION_ERROR,3:US.SUBTITLE_ERR_PROCESS_ERROR},ZP=new eS("SubtitleTool",1);class LP{constructor(e,t){Ou(this,"_taskId",void 0),Ou(this,"_sourceLanguage","zh"),Ou(this,"_updating",!1),Ou(this,"onEvent",void 0),Ou(this,"onMessage",void 0),Ou(this,"_preConfig",void 0),Ou(this,"_timer",void 0),this._ctx=e,this._roomConf=t;const{extraInfo:i}=t.userInfo;if(i)try{const e=JSON.parse(i);e.source_language&&(this._sourceLanguage=e.source_language)}catch(o){}}async start(e){ZP.info("start","Invoke config: %o",e),BS(e.mode,"mode",[fh.ASR_ONLY,fh.ASR_AND_TRANSLATION]);const t=Array.isArray(e.targetLanguage)?e.targetLanguage:[e.targetLanguage||""];if(e.mode===fh.ASR_AND_TRANSLATION&&t.findIndex((e=>-1===kP.indexOf(e)))>-1)throw new HS(US.INVALID_PARAMS,"Invalid targetLanguage.");if(this._taskId)throw new HS(US.SUBTITLE_ALREADY_ON,"Already turned on subtitle");this._preConfig={targetLanguage:t,mode:e.mode},this._taskId=(Date.now().toString()+this._roomConf.roomId+this._roomConf.userId).substring(0,20),await this._sendSubtitleSignalingWithRetry(e,this._taskId)}async update(e){if(ZP.info("update","Invoke config: %o",e),!this._taskId)throw new HS(US.SUBTITLE_NOT_TURNED_ON,"Start subtitle first.");this._sourceLanguage=e.sourceLanguage,this._updating=!0;try{await this._ctx.signalingManager.sendSignaling("controlMessage",this._genChangeSubtitleLanguageSignaling(e,this._taskId))}catch(t){throw this._updating=!1,t}}stop(){ZP.info("stop","Invoke"),this._taskId&&this._ctx.signalingManager.sendSignaling("controlMessage",{type:"subtitle",action:"stopped",appId:this._ctx.appId,roomId:this._roomConf.roomId,userId:this._roomConf.userId,taskId:this._taskId}).finally((()=>{var e;delete this._taskId,null===(e=this.onEvent)||void 0===e||e.call(this,{event:gh.STOPPED}),this._clearTimer()}))}async reconnect(){this._taskId&&this._preConfig&&(await this._ctx.signalingManager.sendSignaling("controlMessage",{type:"subtitle",action:"stopped",appId:this._ctx.appId,roomId:this._roomConf.roomId,userId:this._roomConf.userId,taskId:this._taskId}),delete this._taskId,this.start(this._preConfig))}getConfig(){return this._preConfig}destroy(){ZP.info("destroy","Invoke"),this.stop(),delete this._preConfig,delete this._taskId}onResult(e){const{error:t,errorMessage:i,eventType:o}=e.body;if(0!==t){var s;const e=new HS(CP[t]||US.SUBTITLE_ERR_UNKNOWN,i||"");null===(s=this.onEvent)||void 0===s||s.call(this,{event:gh.ERROR,errorCode:e.code,errorMessage:e.message}),this._clearTimer()}else if("SubtitleStarted"===o){var r;null===(r=this.onEvent)||void 0===r||r.call(this,{event:gh.STARTED}),this._clearTimer()}else if(this._updating&&"LanguageChanged"===o){var n;this._updating=!1,null===(n=this.onEvent)||void 0===n||n.call(this,{event:gh.UPDATED})}}onMessageRecv(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1]||this._taskId&&this._preConfig){const i=PP(e);if(!i||0===i.length)return!1;if(this._taskId&&this._preConfig){const{mode:e,targetLanguage:o}=this._preConfig,s=[];var t;if(i.forEach((t=>{if(e===fh.ASR_ONLY)t.mode===e&&s.push(t);else{const e=o.includes(t.language);(e||t.mode===fh.ASR_ONLY)&&s.push(t),t.mode===fh.ASR_ONLY&&e&&s.push(Yu(Yu({},t),{},{mode:fh.ASR_AND_TRANSLATION}))}})),s.length>0)null===(t=this.onMessage)||void 0===t||t.call(this,s)}return!0}return!1}async _sendSubtitleSignalingWithRetry(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;await this._ctx.signalingManager.sendSignaling("controlMessage",this._genSubtitleSignaling(e,t)),this._timer=self.setTimeout((()=>{var o;2===i?(null===(o=this.onEvent)||void 0===o||o.call(this,{event:gh.ERROR,errorCode:US.TIME_OUT,errorMessage:"start subtitle timeout."}),delete this._timer,this.stop()):this._sendSubtitleSignalingWithRetry(e,t,i+1)}),LP.retryIntervel)}_genSubtitleSignaling(e,t){return{taskId:t,type:"subtitle",action:"started",roomId:this._roomConf.roomId,appId:this._ctx.appId,userId:this._roomConf.userId,subtitleMeta:{subtitleConfig:{mode:e.mode,usersConfig:[{userId:this._roomConf.userId,targetLanguages:Array.isArray(e.targetLanguage)?e.targetLanguage:[e.targetLanguage||""]}]},vendorConfig:{type:0}}}}_genChangeSubtitleLanguageSignaling(e,t){return{taskId:t,type:"subtitle",action:"subtitleUpdated",roomId:this._roomConf.roomId,appId:this._ctx.appId,userId:this._roomConf.userId,subtitleMeta:{protocol:1,languageConfig:{sourceLanguages:[{userId:this._roomConf.userId,languageCode:[e.sourceLanguage]}]}}}}_clearTimer(){this._timer&&(self.clearTimeout(this._timer),delete this._timer)}}Ou(LP,"retryIntervel",3e4);const PP=e=>{let{message:t}=e;if(t instanceof ArrayBuffer&&t.byteLength>8)try{const e=new DataView(t,0);let i=0;if(EP.every((t=>e.getUint8(i++)===t))){const o=e.getUint32(i);if(i+=4,o===e.byteLength-8){const e=Gy.ab2str(t.slice(8)),{data:i,type:o}=JSON.parse(e);if("subtitle"===o)return i}}}catch(i){}return!1},kP=["zh","zh-Hant","tn","vi","iu","it","id","hi","en","ho","he","es","el","uk","ur","tk","tr","ti","ty","tl","to","th","ta","te","sl","sk","ss","eo","sm","sg","st","sv","ja","tw","qu","pt","pa","no","nb","nr","my","bn","mn","mh","mk","ml","mr","ms","lu","ro","lt","lv","lo","kj","hr","kn","ki","cs","ca","nl","ko","ht","gu","ka","kl","km","lg","kg","fi","fj","fr","ru","ng","de","tt","da","ts","cv","fa","bs","pl","bi","nd","ba","bg","az","ar","af","sq","ab","os","ee","et","ay","lzh","am","ckb","cy","gl","ha","hy","ig","kmr","ln","nso","ny","om","sn","so","sr","sw","xh","yo","zu"];function NP(e,t){return Yu(Yu({},e),t)}function XP(e){const t={};return Object.keys(e).forEach((i=>{const o=e[i];try{Array.isArray(o)?t[i]=o.map((e=>null!==e&&"object"==typeof e?XP(e):e)):t[i]=null!==o&&"object"==typeof o?XP(o):o}catch(s){}})),t}function VP(e){return null===e?[]:Object.keys(e).map((t=>e[t]))}const wP=new eS("Locker",2);let xP=1;class GP{constructor(e){Ou(this,"lockingPromise",Promise.resolve()),Ou(this,"locks",0),Ou(this,"name",""),Ou(this,"lockId",void 0),Ou(this,"closeReason",void 0),this.lockId=xP++,e&&(this.name=e),wP.info("lock-".concat(this.name,"-").concat(this.lockId),"is created.")}get isLocked(){return this.locks>0}lock(){let e;this.locks+=1,wP.info("lock-".concat(this.name,"-").concat(this.lockId),"locked, current queue ".concat(this.locks,"."));const t=new Promise((t=>{e=()=>{this.locks-=1,wP.info("lock-".concat(this.name,"-").concat(this.lockId),"unlocked, current queue ".concat(this.locks,".")),t()}})),i=this.lockingPromise.then((()=>e));return this.lockingPromise=this.lockingPromise.then((()=>t)),i}}var WP=(e=>(e[e.SEND=0]="SEND",e[e.FEEDBACK=1]="FEEDBACK",e))(WP||{}),MP=(e=>(e[e.P2P=0]="P2P",e[e.SIGNAL=1]="SIGNAL",e[e.BROADCAST=2]="BROADCAST",e[e.BUSINESS_SERVER=3]="BUSINESS_SERVER",e))(MP||{}),AP=(e=>(e[e.SUCCESS=0]="SUCCESS",e[e.TIMEOUT=1]="TIMEOUT",e[e.BROKEN=2]="BROKEN",e[e.NO_RECEIVER=3]="NO_RECEIVER",e[e.NO_RELAYPATH=4]="NO_RELAYPATH",e[e.EXCEED_QPS=5]="EXCEED_QPS",e[e.SEND_TO_SERVER_ERROR=17]="SEND_TO_SERVER_ERROR",e[e.SERVER_RESPONSE_ERROR=18]="SERVER_RESPONSE_ERROR",e[e.NOT_JOIN=100]="NOT_JOIN",e[e.NOT_LOGIN=105]="NOT_LOGIN",e[e.SERVER_PARAMS_NOTSET=106]="SERVER_PARAMS_NOTSET",e[e.UNKNOWN=1e3]="UNKNOWN",e))(AP||{});const OP={0:[0,"success"],1:[US.USER_MESSAGE_TIMEOUT,"timeout, failed to send."],2:[US.USER_MESSAGE_BROKEN,"dataChannel broken, failed to send."],3:[US.USER_MESSAGE_NO_RECEIVER,"cannot find the receiver."],4:[US.USER_MESSAGE_NO_RECEIVER,"cannot find relay path."],5:[US.USER_MESSAGE_EXCEED_QPS,"cannot find relay path."],17:[US.USER_MESSAGE_SEND_TO_SERVER_ERROR,"failed to send to business server."],18:[US.USER_MESSAGE_SERVER_RESPONSE_ERROR,"business server response error."],100:[US.USER_MESSAGE_NOT_JOIN,"not join room"],105:[US.USER_MESSAGE_NOT_LOGIN,"not login."],106:[US.USER_MESSAGE_SERVER_PARAMS_NOTSET,"server param is not set."],1e3:[US.USER_MESSAGE_UNKNOWN,"unknown."]},DP=["msg"],YP=[],KP=[hT.ENGINE_CONTROL_MESSAGE];var UP=(e=>(e[e.C2S=0]="C2S",e[e.C2C=1]="C2C",e[e.C2GW=2]="C2GW",e[e.C2CDirect=3]="C2CDirect",e[e.C2RTM=4]="C2RTM",e))(UP||{});class FP extends sT.EventEmitter{constructor(e,t,i){super(),Ou(this,"_singlingCache",new Map),Ou(this,"_p2pCache",new Map),Ou(this,"_rttIds",{}),Ou(this,"_p2pMessageId",new Qy),Ou(this,"_clearDataChannelListener",void 0),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),this.id=e,this._dataChannel=t,this.connectionIds=i,this._clearDataChannelListener=this._handleHandler(),this._monitor=Nv(e),this.logger=new eS("DataChannelSignaling",3,e)}destroy(){this._clearDataChannelListener(),delete this._dataChannel,this._singlingCache.forEach(((e,t)=>{e.error(new HS(US.OPERATION_CANCEL,"disconnect")),this._singlingCache.delete(t)})),this._singlingCache.clear(),this._p2pCache.clear(),this._rttIds={}}sendSignaling(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6e4;return new Promise(((s,r)=>{var n;const a=this._genHeader(i);a.id=My();const d=a.id.join("-"),c=Yu({error_code:0,message:JSON.stringify(t),signaling_event:"call-".concat(e),signaling_type:"Send",stream_id:t.streamId,stream_user_id:t.streamUserId,direction:"up",event_session_id:d},this.connectionIds);null===(n=this._monitor)||void 0===n||n.report("rtc_signaling",c);const l="customMessage"===e;l&&vv(this.id,Number(a.id.join("")),t);const u=setTimeout((()=>{this._singlingCache.delete(d),r(new HS(US.TIME_OUT,"".concat(e," message time out"))),l&&yv(this.id,t,999)}),o);this._singlingCache.set(d,{start:wy(),signalingType:e,success:e=>{clearTimeout(u),s(e),l&&yv(this.id,t,0)},error:e=>{clearTimeout(u),r(e),l&&yv(this.id,t,e.code)},id:d}),this.logger.info("Signal",">>>>>> [".concat(e,"{").concat(a.functionType,"}][").concat(d,"]"),t),this._sendMessage(e,a,t)}))}sendPingSignaling(){return this.sendSignaling("CheckConnectivity",{ts:Date.now()},{functionType:2})}async sendP2PMessage(e,t){let{msg:i}=e,o=Jb(e,DP);const s=i instanceof ArrayBuffer;return this._sendP2PMessage(pv(this.id,Yu(Yu({ver:1,id:this._p2pMessageId.getMessageId(),time:Date.now(),dir:WP.SEND,type:MP.P2P,err:AP.SUCCESS},o),{},{binary:s,msg:s?await Gy.ab2b64str(i):i})),t)}_sendP2PMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=this._genHeader(Yu(Yu({needAck:!0,functionType:1},t),{},{id:My()}));return Oy(e.msg)?this._rttIds[e.id]=e.id:e.dir===WP.SEND&&this.logger.info("_sendP2PMessage [DC Signaling p2p{".concat(i.functionType,"} >>]"),JSON.stringify(e)),new Promise(((t,o)=>{if(e.dir===WP.SEND){const i=setTimeout((()=>{this._p2pCache.delete(e.id),o(new HS(US.USER_MESSAGE_TIMEOUT,"P2P message timeout")),bv(this.id,e,999)}),12e3);this._p2pCache.set(e.id,{success:(o,s)=>{clearTimeout(i),t(s),bv(this.id,e,0)},error:t=>{clearTimeout(i),bv(this.id,e,t.err);const[s,r]=OP[t.err]||[US.USER_MESSAGE_UNKNOWN,"err: ".concat(t.err,", msg: ").concat(t.msg)];o({err:t.err,code:s,message:t.msg||r})}})}try{this._sendMessage("p2p",i,e)}catch(s){throw s.code===US.NOT_CONNECTED_YET&&(s.code=US.USER_MESSAGE_BROKEN),s}}))}_sendMessage(e,t,i){if(!this._dataChannel||"open"!==this._dataChannel.readyState)throw new HS(US.NOT_CONNECTED_YET,"DataChannel not open");const o=vy("SIGNAL_COMPRESSION")||t.zip,s=t.version+(Number(o)<<4)+(Number(t.encrypt)<<5),r=Number(t.needAck)+(Number(t.direction)<<1)+(Number(t.functionType)<<2)+(Number(t.binary)<<6),n=Gy.str2ab(JSON.stringify([e,i])),a=xy(Uint8Array,[s,r,...t.id||[]],o||t.zip?gb.deflate(new Uint8Array(n)):new Uint8Array(n));try{this._dataChannel.send(a.buffer)}catch(c){var d;throw null===(d=this._monitor)||void 0===d||d.report("rtc_error",{message:"datachannel send error: ".concat(c.message),error_code:PL.DC_SEND_ERROR}),c}"p2p"===e?_v(this.id,i,a.buffer.byteLength):"customMessage"===e&&fv(this.id,i,a.buffer.byteLength)}_dispartData(e){const t=new Uint8Array(e);let i=0;const o=t[i++],s=t[i++],r={version:15&o,zip:!(16&~o),encrypt:!(32&~o),needAck:!(1&~s),direction:(2&s)>>1,functionType:(60&s)>>2,binary:!(64&~s)};if(r.needAck||1===r.direction){for(;i<=6;i++)if(128&~t[i]){i++;break}r.id=Array.from(t.slice(2,i))}return{header:r,data:t.slice(i)}}_feedbackSignaling(e,t,i){const o=this._genHeader({needAck:!0,direction:1,id:e.split("-").map((e=>Number(e)))});YP.includes(t)||this.logger.info("Signal",">>>>>> [".concat(t,"-res][").concat(e,"]")),this._sendMessage("".concat(t,"-res"),o,i)}async _handleMessage(e){const t=Date.now(),{byteLength:i}=e,o=this._dispartData(e);let{data:s}=o;const{header:r}=o;if(r.zip){const e=new gb.Inflate;e.push(s,!0),s=e.result}const n=Gy.ab2str(s);let a=[];try{a=JSON.parse(n)}catch(c){var d;if(c instanceof Error)null===(d=this._monitor)||void 0===d||d.report("rtc_signaling_msg_error",Yu({error_code:-1,message:c.message,reason:"message parse failed"},this.connectionIds));return}switch(r.functionType){case 0:case 4:this.C2S(r,a,n,i,t);break;case 1:this.C2C(a,i,t);break;case 2:this.C2GW(r,a,n)}}async C2S(e,t,i,o,s){var r;const n=(null===(r=e.id)||void 0===r?void 0:r.join("-"))||"";if(1===e.direction)this._handleAckMessage(n,t[0]||{},i,e.functionType);else if(Array.isArray(t)){var a;const r=t[0];t=t[1],YP.includes(r)||this.logger.info("Signal","<<<<<< ".concat(r,"{").concat(e.functionType,"}"),t,n),KP.includes(r)||this._feedbackSignaling(n,r,r===hT.ON_CUSTOM_MESSAGE?Yu(Yu({},t),{},{message:""}):""),t.binary&&"string"==typeof t.message&&(t.message=await Gy.b64str2ab(t.message,this._monitor));const d=Date.now();this.emit(r,Yu({},t)),r===hT.ON_CUSTOM_MESSAGE&&gv(this.id,t,{msg_size:o,recv_msg_ts:s,fwd_msg_ts:d}),null===(a=this._monitor)||void 0===a||a.report("rtc_signaling",Yu({error_code:0,message:i,signaling_event:"on-".concat(r),signaling_type:"Recv",stream_id:t.streamId,stream_user_id:t.clientId,direction:"down"},this.connectionIds))}}async C2C(e,t,i){var o,s,r,n;Array.isArray(e)&&(e=e[1]);const a=null===(o=e)||void 0===o?void 0:o.id;switch(this._rttIds[a]||(null===(s=e)||void 0===s?void 0:s.dir)===WP.FEEDBACK||Oy(null===(r=e)||void 0===r?void 0:r.msg)?delete this._rttIds[a]:this.logger.info("Signal","<<<<<< p2p response",e),e.dir){case WP.SEND:const o=Date.now();if(!Oy(null===(n=e)||void 0===n?void 0:n.msg)){const{binary:t,msg:i,room:o,to:s,from:r}=e,n=""===o?t?hT.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM:hT.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM:t?hT.USER_BINARY_MESSAGE_RECEIVED:hT.USER_MESSAGE_RECEIVED;s?this.emit(n,Yu(Yu({},e),{},{msg:t?await Gy.b64str2ab(i,this._monitor):i})):this.emit(hT.ON_CUSTOM_MESSAGE,{clientId:r,binary:t,message:t?await Gy.b64str2ab(i,this._monitor):i})}this._sendP2PMessage(Yu(Yu({},e),{},{dir:WP.FEEDBACK,msg:""})),Sv(this.id,e,{msg_size:t,recv_msg_ts:i,fwd_msg_ts:o});break;case WP.FEEDBACK:this._handleP2PMsgFeedback(e)}}C2GW(e,t,i){if(1===e.direction){var o;const s=(null===(o=e.id)||void 0===o?void 0:o.join("-"))||"";this._handleAckMessage(s,t[0]||{},i,e.functionType)}else{const[o,n={}]=t;if("RXMediaMsg"===o){var s;const{type:e,data:t}=n;switch(null===(s=this._monitor)||void 0===s||s.report("rtc_signaling",Yu({error_code:0,message:i,signaling_event:"on-".concat(e),signaling_type:"Recv",stream_id:"",stream_user_id:"",direction:"down"},this.connectionIds)),e){case"RSCP":try{const i=JSON.parse(t);Array.isArray(i)&&this.emit(e,i)}catch(r){}break;case"RTT":try{const i=JSON.parse(t);i.length&&this.emit(e,i[0])}catch(r){}break;case"SSC":try{const i=JSON.parse(t);i.length&&(this.logger.info("Signal","<<<<<< ".concat(e),i),this.emit(e,i[0]))}catch(r){}}}else"engineControlMessage"===o&&this.C2S(e,t,i,0,0)}}_handleHandler(){const e=e=>{this.logger.warn("_handleHandler","dataChannel close",e)},t=e=>{this.logger.error("_handleHandler","dataChannel error",e)},i=e=>{this._handleMessage(e.data)};return this._dataChannel.addEventListener("close",e),this._dataChannel.addEventListener("error",t),this._dataChannel.addEventListener("message",i),()=>{const o=this._dataChannel;null==o||o.removeEventListener("close",e),null==o||o.removeEventListener("error",t),null==o||o.removeEventListener("message",i)}}_genHeader(){return Yu({version:2,zip:!1,encrypt:!1,needAck:!0,direction:0,functionType:0,binary:!1},arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}_handleAckMessage(e,t,i,o){var s;const r=this._singlingCache.get(e);r&&(this._singlingCache.delete(e),200===t.code?r.success(t):r.error(t),this.logger.info("Signal","<<<<<< [".concat(r.signalingType,"{").concat(o,"}-ack] ").concat(e),t));const n=Yu({error_code:0,message:i,signaling_event:null==r?void 0:r.signalingType,signaling_type:"Ack",stream_id:"",stream_user_id:"",direction:"down",elapse:r?wy()-r.start:0},this.connectionIds);null!=r&&r.id&&(n.event_session_id=r.id),null===(s=this._monitor)||void 0===s||s.report("rtc_signaling",n)}_handleP2PMsgFeedback(e){const t=this._p2pCache.get(e.id);t&&(this._p2pCache.delete(e.id),e.err===AP.SUCCESS?t.success(e.id,e):t.error(e))}}class HP{constructor(e,t){Ou(this,"roomId",void 0),Ou(this,"userInfo",void 0),Ou(this,"userId",void 0),Ou(this,"sessionId",vm()),Ou(this,"token",void 0),Ou(this,"rtcVid",void 0),Ou(this,"joinPromise",void 0),Ou(this,"startJoinTimestamp",void 0),Ou(this,"_liveControlMessage",void 0),Ou(this,"_userStreamMap",new Map),Ou(this,"_roomConfig",{isAutoPublish:!0,isAutoSubscribeAudio:!0,isAutoSubscribeVideo:!0,roomProfileType:_h.communication}),Ou(this,"_vendorConfig",{enableMultiVendor:!1,vendorCode:0}),Ou(this,"_roomAttr",{multiChatMode:!1,bigRoomMode:!1}),Ou(this,"_tokenPublishPrivilegeExpired",!1),Ou(this,"_tokenSubscribePrivilegeExpired",!1),Ou(this,"_streamQueueMap",new Map),Ou(this,"_monitor",void 0),this._ctx=t,this.roomId=e.roomId,this.userInfo=e.userInfo,this.userId=e.userInfo.userId,this.token=e.token,this._monitor=Nv(t.id)}async checkJoinRoom(){await this.joinPromise}get vendorConfig(){return this._vendorConfig}setVendorConfig(e){this._vendorConfig=e}updateRoomAttributes(e){this._roomAttr=Yu(Yu({},this._roomAttr),e)}setLiveControlMessage(e){this._liveControlMessage=e}getLiveControlMessage(){return this._liveControlMessage}isMultiChatMode(){return this._roomAttr.multiChatMode}updateRoomConfig(e){return this._roomConfig=NP(this._roomConfig,e),this._roomConfig}get isAutoPublish(){return!this.isRTSOnlyRoom()&&this._roomConfig.isAutoPublish}get isAutoSubscribeAudio(){return!this.isRTSOnlyRoom()&&this._roomConfig.isAutoSubscribeAudio}get isAutoSubscribeVideo(){return!this.isRTSOnlyRoom()&&this._roomConfig.isAutoSubscribeVideo}get remoteVideoConfig(){return this._roomConfig.remoteVideoConfig}get roomProfileType(){return this._roomConfig.roomProfileType||_h.communication}isRTSOnlyRoom(){return this._roomConfig.roomMode===Lh.ROOM_MODE_RTS_ONLY}get rtsOnlySignalHeader(){return this.isRTSOnlyRoom()?{functionType:UP.C2RTM}:void 0}updateUserPubInfo(e){const t=this._userStreamMap.get(e.clientId)||{};e.screen?(t.screenAudio=e.attributes.audiostream,t.screenVideo=e.attributes.videostream):(t.audio=e.attributes.audiostream,t.video=e.attributes.videostream),this._userStreamMap.set(e.clientId,t)}getUserPubInfo(e){return Yu({audio:!1,video:!1,screenAudio:!1,screenVideo:!1},this._userStreamMap.get(e)||{})}resetUserPubInfo(){this._userStreamMap.clear()}get tokenPublishPrivilegeExpired(){return this._tokenPublishPrivilegeExpired}get tokenSubscribePrivilegeExpired(){return this._tokenSubscribePrivilegeExpired}setTokenPublishPrivilegeExpired(e){this._tokenPublishPrivilegeExpired=e}setTokenSubscribePrivilegeExpired(e){this._tokenSubscribePrivilegeExpired=e}getStayRoomDuration(){return this.startJoinTimestamp?wy()-this.startJoinTimestamp:0}getStreamQueueLock(e){let t=this._streamQueueMap.get(e);return t||(t=new GP(e),this._streamQueueMap.set(e,t)),t}report(e,t,i){var o;null===(o=this._monitor)||void 0===o||o.report(e,Yu({room_id:this.roomId,user_id:this.userId,rtc_session_id:this.sessionId,rtc_vid:this.rtcVid},t),i)}}const JP=6e4,zP=(e,t,i)=>{i.info(e,"userId: %o, subAudio: %o, subVideo: %o, audioMid: %o, videoMid: %o, sequenceId: %o",t.userId,t.subAudio,t.subVideo,t.audioMid,t.videoMid,t.sequenceId)};function jP(e,t,i){const o=i.value;return i.value=async function(){if(!this._ctx.signalingManager.isConnected())throw new HS(US.NOT_CONNECTED_YET,"error in ".concat(t,": try again after connect"));try{await(this._roomConf||this.config).checkJoinRoom()}catch(r){throw new HS(US.JOIN_ROOM_FAILED,"error in ".concat(t,": try again after joined"))}for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];return o.apply(this,i)},i}function QP(e,t,i){const o=i.value;return i.value=async function(){const e=this._roomConf,i=this._logger;for(var s=arguments.length,r=new Array(s),n=0;n<s;n++)r[n]=arguments[n];const a=r[0];if(null==a||!a.streamId)return null==o?void 0:o.apply(this,r);const{streamId:d}=a;i.info("streamQueue","lock stream %o, task %o",d.slice(-5),t);const c=await e.getStreamQueueLock(d).lock();try{return await(null==o?void 0:o.apply(this,r))}finally{i.info("streamQueue","unlock stream %o, task %o",d.slice(-5),t),c()}},i}var BP=Object.defineProperty,qP=Object.getOwnPropertyDescriptor,$P=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?qP(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&BP(t,i,r),r};class ek extends aT{constructor(e,t){super(),Ou(this,"_forwardDstRooms",new Map),Ou(this,"forwardStreamState","stopped"),this._ctx=e,this._roomConf=t}async startForwardStream2Rooms(e){if("running"===this.forwardStreamState||"paused"===this.forwardStreamState)throw new HS(US.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke startForwardStreamToRooms in state: ".concat(this.forwardStreamState));const t=await this._sendForwardStreamSignaling("start",this._roomConf.roomId,e);this._updateDstRooms(e,t);const i=this._transformForwardStreamResult(t);return this.forwardStreamState="running",i}async updateForwardStream2Rooms(e){if("stopped"===this.forwardStreamState)throw new HS(US.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke updateForwardStreamToRooms in state: ".concat(this.forwardStreamState));let t=this._mockForwardStreamResult(e);"running"===this.forwardStreamState&&(t=await this._sendForwardStreamSignaling("update",this._roomConf.roomId,e)),this._updateDstRooms(e,t);return this._transformForwardStreamResult(t)}async stopForwardStream2Rooms(){if("stopped"===this.forwardStreamState)throw new HS(US.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke stopForwardStreamToRooms in state: ".concat(this.forwardStreamState));let e=this._mockForwardStreamResult([]);if("running"===this.forwardStreamState&&(e=await this._sendForwardStreamSignaling("stop",this._roomConf.roomId)),this._updateDstRooms([],e),[...this._forwardDstRooms.keys()].length>0)throw new HS(US.UNEXPECTED_ERROR,"stopforwardstream failed: ".concat(JSON.stringify(e)));const t=this._transformForwardStreamResult(e);return this.forwardStreamState="stopped",t}async pauseForwardStream2AllRooms(){if("paused"===this.forwardStreamState||"stopped"===this.forwardStreamState)throw new HS(US.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke pauseForwardStreamToAllRooms in state: ".concat(this.forwardStreamState));const e=await this._sendForwardStreamSignaling("stop",this._roomConf.roomId),t=this._transformForwardStreamResult(e);return this.forwardStreamState="paused",t}async resumeForwardStream2AllRooms(){if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&["running","stopped"].includes(this.forwardStreamState))throw new HS(US.UNEXPECTED_INVOKE_FORWARD_STREAM,"should not invoke resumeForwardStreamToAllRooms in state: ".concat(this.forwardStreamState));const e=this._getDstRooms(),t=await this._sendForwardStreamSignaling("start",this._roomConf.roomId,e);this._updateDstRooms(e,t);const i=this._transformForwardStreamResult(t);return this.forwardStreamState="running",i}resumeFromReconnect(){"running"===this.forwardStreamState&&this.resumeForwardStream2AllRooms(!0).then((e=>{e.forEach((e=>{e.state===Th.FORWARD_STREAM_STATE_FAILURE&&this.safeEmit(_P.ON_FORWARD_STREAM_ERROR,e)}))}))}onForwardDstRoomUserKick(e){const t=[{dstRoomId:e.dstRoomId,code:200,forwardStreamType:"stop"}];this._updateDstRooms([],t),this.safeEmit(_P.ON_FORWARD_STREAM_ERROR,{roomId:e.dstRoomId,state:Th.FORWARD_STREAM_STATE_FAILURE,error:Ih.FORWARD_STREAM_ERROR_REMOTE_KICKED})}destoy(){super.removeAllListeners(),this._forwardDstRooms.clear(),this.forwardStreamState="stopped"}_mockForwardStreamResult(e){const t=[];return this._forwardDstRooms.forEach(((e,i)=>{t.push({dstRoomId:i,forwardStreamType:"stop",code:200})})),e.forEach((e=>{const i=t.findIndex((t=>t.dstRoomId===e.roomId));-1===i?t.push({dstRoomId:e.roomId,forwardStreamType:"start",code:e.roomId===this._roomConf.roomId?400:200}):t[i].forwardStreamType="update"})),t}_transformForwardStreamResult(e){e||(e=[]);const t=[];for(const{dstRoomId:i,code:o}of e){const e={roomId:i,state:Th.FORWARD_STREAM_STATE_SUCCESS,error:Ih.FORWARD_STREAM_ERROR_OK};200===o||(400===o?(e.state=Th.FORWARD_STREAM_STATE_FAILURE,e.error=Ih.FORWARD_STREAM_ERROR_REMOTE_KICKED):o>=700&&o<800?(e.state=Th.FORWARD_STREAM_STATE_FAILURE,e.error=Ih.FORWARD_STREAM_ERROR_INVALID_TOKEN):(e.state=Th.FORWARD_STREAM_STATE_FAILURE,e.error=Ih.FORWARD_STREAM_ERROR_RESPONSE)),t.push(e)}return t}_updateDstRooms(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];0===t.length&&this._forwardDstRooms.clear(),t.forEach((t=>{let{dstRoomId:i,code:o,forwardStreamType:s}=t;if(200===o)if("stop"===s)this._forwardDstRooms.delete(i);else{var r;const t=e.find((e=>e.roomId===i));if(!t&&!this._forwardDstRooms.has(i))throw new HS(US.UNEXPECTED_ERROR,"unknow roomid ".concat(i," in signaling return"));let o=null!==(r=this._forwardDstRooms.get(i))&&void 0!==r?r:{token:void 0};o=Object.assign(o,t),this._forwardDstRooms.set(i,o)}else this._forwardDstRooms.has(i)&&this._forwardDstRooms.delete(i)}))}_getDstRooms(){const e=[];return this._forwardDstRooms.forEach(((t,i)=>{e.push({roomId:i,token:t.token})})),e}async _sendForwardStreamSignaling(e,t,i){const o="".concat(Ay());if("stop"!==e){const e=i.map((e=>e.roomId));this._roomConf.report("rtc_forward_stream",{type:"begin",dst_rooms:"{ ".concat(e.map((e=>'"'.concat(e,'"'))).join(",")," }"),event_session_id:o})}const s={forwardStreamType:e,roomId:t};("start"===e||"update"===e)&&(s.dstRoomInfos=null==i?void 0:i.map((e=>({dstRoomId:e.roomId,dstToken:Gy.token2auth(this._ctx.appId,e.roomId,this._roomConf.userId,e.token)}))));const r=await this._ctx.signalingManager.sendSignaling("forwardStream",s),n=[];if(200!==(null==r?void 0:r.code))throw"stop"!==e&&(null==i||i.forEach((e=>{n.push({dst_room_id:e.roomId,result:"server error ".concat(null==r?void 0:r.code)})})),this._roomConf.report("rtc_forward_stream",{type:"end",dst_rooms:JSON.stringify(n),event_session_id:o})),new HS(US.UNEXPECTED_ERROR,"server side internal error, error code: ".concat(r));var a,d;"stop"!==e&&(null===(a=r.forwardStreamResults)||void 0===a||a.forEach((e=>{n.push({dst_room_id:e.dstRoomId,result:"dst room lost"})})),null===(d=r.forwardStreamResults)||void 0===d||d.forEach((e=>{const t=n.find((t=>t.dst_room_id===e.dstRoomId));t&&(200===e.code?"update"===e.forwardStreamType?t.result="update":t.result="success":t.result="server error ".concat(e.code))})),this._roomConf.report("rtc_forward_stream",{type:"end",dst_rooms:JSON.stringify(n),event_session_id:o}));return r.forwardStreamResults}}$P([jP],ek.prototype,"startForwardStream2Rooms",1),$P([jP],ek.prototype,"updateForwardStream2Rooms",1),$P([jP],ek.prototype,"stopForwardStream2Rooms",1),$P([jP],ek.prototype,"pauseForwardStream2AllRooms",1),$P([jP],ek.prototype,"resumeForwardStream2AllRooms",1);const tk=[{maxLayers:3,totalPixels:2073600},{maxLayers:3,totalPixels:921600},{maxLayers:3,totalPixels:518400},{maxLayers:2,totalPixels:230400},{maxLayers:2,totalPixels:129600},{maxLayers:1,totalPixels:57600},{maxLayers:1,totalPixels:0}];function ik(e,t,i){var o;const s=e?null===(o=i.find((t=>t.rid===e)))||void 0===o?void 0:o.maxkbps:i[0].maxkbps;return Math.min(null!=s?s:Number.POSITIVE_INFINITY,t)}const ok=(e,t)=>{var i,o,s,r;let n=0,a=-1;const{videoDescriptions:d,subVideoDescriptions:c}=(null==t?void 0:t.attributes)||{},l=Array.isArray(c)?c:d;let u=-1;const h=e.width*e.height;for(let b=0;b<(null==l?void 0:l.length);b++){var m,p;if(h>=(null===(m=l[b])||void 0===m?void 0:m.width)*(null===(p=l[b])||void 0===p?void 0:p.height)){u=b;break}}let _=l[0];if(-1===u)u=l.length-1,_=l[u];else if(0!==u){const e=l[u-1].width*l[u-1].height,t=(e-h)/(e-l[u].width*l[u].height);_=t<.1?l[u-1]:l[u],u=t<.1?u-1:u}return a=null!==(i=null===(o=_)||void 0===o?void 0:o.sub_index)&&void 0!==i?i:-1,n=null!==(s=null===(r=_)||void 0===r?void 0:r.video_index)&&void 0!==s?s:u,{spatialLayer:n,spatialSubLayer:a}},sk=e=>({width:jy(e.width),height:jy(e.height),frameRate:jy(e.frameRate),maxKbps:e.maxKbps}),rk=e=>{let{width:t,height:i}=e;return jy(t)*jy(i)},nk=(e,t)=>{const i=jy(e.width)/jy(t.width)||1,o=jy(e.height)/jy(t.height)||1;Math.floor(i)===i&&Math.floor(o)===o||zy("setLocalSimulcastMode: The resolution setting needs to be an integer multiple")};class ak{constructor(e){Ou(this,"_roomId",void 0),Ou(this,"_constraints",{}),Ou(this,"_profile",void 0),Ou(this,"_customMaxBitrate",0),this._appId=e}setRoomId(e){this._roomId=e}setAudioProfile(e){this._profile=e,this._customMaxBitrate=0}get customMaxBitrate(){return this._customMaxBitrate}setCustomMaxBitrate(e){const{audio_encode:t}=DS.getEngineWebConfig(this._appId,this._roomId||"");this._customMaxBitrate=null!=t&&t.bitrate?0:1e3*e}getOpusConfigStr(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const{audio_encode:t}=DS.getEngineWebConfig(this._appId,this._roomId||""),{sampleRate:i,channelCount:o}=this.getConstraints(),s="number"==typeof i?i:null==i?void 0:i.exact,r="number"==typeof o?o:null==o?void 0:o.exact,n={};e.split(";").forEach((e=>{const[t,i]=e.split("=");t&&i&&(n[t]=i)}));const a=(null==t?void 0:t.bitrate)||this._customMaxBitrate||this._getConfigByAudioProfile().bitrate;a&&(n.maxaveragebitrate=a);const d=(null==t?void 0:t.enc_sample_rate)||s;d&&(n["sprop-maxcapturerate"]=d);const c=(null==t?void 0:t.playback_rate)||s;return c&&(n.maxplaybackrate=c),(r&&r>1||null!=t&&t.stereo)&&(n["sprop-stereo"]=1,n.stereo=1),null!=t&&t.dtx&&(n.usedtx=1),Object.keys(n).map((e=>"".concat(e,"=").concat(n[e]))).join(";")}updateConstraints(e){this._constraints=Yu(Yu({},this._constraints),e)}getConstraints(){const e=Yu({},this._constraints),{audio_capture:t}=DS.getEngineWebConfig(this._appId,this._roomId||"");Hy(null==t?void 0:t.sample_rate)||(e.sampleRate=t.sample_rate),Hy(null==t?void 0:t.channel)||(e.channelCount=t.channel),Hy(null==t?void 0:t.agc)||(e.autoGainControl=t.agc),Hy(null==t?void 0:t.ans)||(e.noiseSuppression=t.ans),Hy(null==t?void 0:t.aec)||(e.echoCancellation=t.aec);const{sampleRate:i,channel:o}=this._getConfigByAudioProfile();return Hy(e.sampleRate)&&!Hy(i)&&(e.sampleRate=i),Hy(e.channelCount)&&!Hy(o)&&(e.channelCount=o),e}_getConfigByAudioProfile(){const e={};switch(this._profile){case bh.fluent:e.sampleRate=16e3,e.bitrate=24e3;break;case bh.standard:e.sampleRate=48e3,e.bitrate=48e3;break;case bh.hd:e.sampleRate=48e3,e.bitrate=128e3,e.channel=2;break;case bh.standardStereo:e.sampleRate=48e3,e.bitrate=8e4,e.channel=2;break;case bh.hdMono:e.sampleRate=48e3,e.bitrate=128e3}return e}}const dk={start_interval:100,multiplier:2,max_interval:3e4};class ck{constructor(){Ou(this,"_times",0),Ou(this,"_config",dk),Ou(this,"initTs",wy())}getRetryDelay(){return Math.min(this._config.max_interval,Math.pow(this._config.multiplier,this._times++)*this._config.start_interval)}setConfig(e){this._config=e}reset(){this._times=0}}class lk{constructor(e){Ou(this,"_logger",void 0),Ou(this,"_monitor",void 0),this._ctx=e;const t=DS.getServerConfig(this._ctx.appId);this._logger=new eS("DecisionConfig",1,this._ctx.id),this._monitor=Nv(this._ctx.id),setTimeout((()=>{this.updateConfig(t,!0)}),0)}updateConfig(e,t){!t&&DS.setServerConfig(this._ctx.appId,e),e.rts_report&&dv(e.rts_report),this._ctx.joinRoomConfig.setServerConfig(e.web_join_room),this._setRtsConfig(e.rts_config),this._setRtsQpsConfig(e.rts_qps),this._preConnect(e),this._getServerConfigExecutor(e)}_setRtsConfig(e){null!=e&&e.rts_mode&&e.rts_mode!==this._ctx.rtsMode&&(this._logger.print("_setRtsConfig","setRtsMode to %o",e.rts_mode),this._ctx.setRTSMode(e.rts_mode===vT.NORMAL_MODE?vT.NORMAL_MODE:vT.LIMIT_MODE))}_setRtsQpsConfig(e){this._logger.print("_setRtsQpsConfig",JSON.stringify(e)),this._ctx.setRtsQpsConf(e),Object.keys(this._ctx.rtsLimiter).length>0&&Wv(this._ctx.id,"setRtsQpsConf",JSON.stringify(e))}_getServerConfigExecutor(e){var t,i,o,s,r,n,a,d;const{upload_console_length_cut:c,upload_report_limit:l}=(null==e?void 0:e.web_rtc_config)||{};if(Pm.setParameter("UPLOAD_CONSOLE_ON",!(null==e||null===(t=e.web_rtc_config)||void 0===t||!t.upload_console_on)),c&&Pm.setParameter("UPLOAD_CONSOLE_LENGTH_CUT",c),l&&Pm.setParameter("UPLOAD_REPORT_LIMIT",l),Pm.setParameter("ENABLE_REPORT_IDB_BUFFER",!(null==e||null===(i=e.web_rtc_config)||void 0===i||!i.enable_report_idb_buffer)),!1===(null==e||null===(o=e.web_rtc_config)||void 0===o?void 0:o.sdk_codec_negotiation)&&by("SDK_CODEC_NEGOTIATION",!1),void 0!==(null==e||null===(s=e.web_rtc_config)||void 0===s?void 0:s.ainr_enable_dump)&&by("AINR_ENABLE_DUMP",e.web_rtc_config.ainr_enable_dump),void 0!==(null==e||null===(r=e.web_rtc_config)||void 0===r?void 0:r.ainr_overload_threshold)&&by("AINR_OVERLOAD_THRESHOLD",e.web_rtc_config.ainr_overload_threshold),void 0!==(null==e||null===(n=e.web_rtc_config)||void 0===n?void 0:n.ainr_urls))try{by("AINR_URLS",JSON.parse(e.web_rtc_config.ainr_urls))}catch(u){this._logger.warn("_getServerConfigExecutor","parse AINR_URLS error %o",u)}void 0!==(null==e||null===(a=e.web_rtc_config)||void 0===a?void 0:a.ainr_cache_time)&&by("AINR_CACHE_TIME",e.web_rtc_config.ainr_cache_time),void 0!==(null==e||null===(d=e.web_rtc_config)||void 0===d?void 0:d.ainr_dump_time)&&by("AINR_DUMP_TIME",e.web_rtc_config.ainr_dump_time)}_preConnect(e){var t;let i=vy("PRE_ICE");var o;("boolean"==typeof(null==e||null===(t=e.web_rtc_config)||void 0===t?void 0:t.pre_ice)&&(i=e.web_rtc_config.pre_ice),i)&&(this._logger.print("preConnect","start pre ice connection."),this._ctx.signalingManager.connect(),null===(o=this._monitor)||void 0===o||o.set({pre_connection:!0}),this._ctx.isPreConnection=!0)}}class uk{constructor(e){Ou(this,"_reconnectTimer",void 0),Ou(this,"_retryFunc",void 0),Ou(this,"_abortControllers",[]),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),Ou(this,"_groupConfigId",Vy()),Ou(this,"_retryLimiter",new ck),Ou(this,"_timer",void 0),Ou(this,"_destroyed",!1),Ou(this,"_onlineListener",(()=>{this._reconnectTimer&&this._retryFunc&&(clearTimeout(this._reconnectTimer),this._retryFunc())})),Ou(this,"_decisionConfig",void 0),this._ctx=e,this._monitor=Nv(e.id),this.logger=new eS("ICERequest",4,e.id),this._decisionConfig=new lk(e),window.addEventListener("online",this._onlineListener)}async getICENode(e){let t;this.logger.info("getICENode","invoke");try{if(t=await this._getAccessWithRetry(e),0===t.length)throw new Error("server return empty nodes.")}catch(i){throw this._reportRtcInvokeStatus("es.join.getNodeFailed",i),new HS(US.ICE_SERVER_WRONG,"get ICE config failed: ".concat(i.message),i)}return this.logger.success("getICENode","success"),this._reportRtcInvokeStatus("es.join.getNodeSuccess",t),t}_getAccessWithRetry(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return 0!==t&&this.logger.info("_getAccessWithRetry()","invoke feedbackInfo: %o, 201count: %o",e,t),new Promise(((i,o)=>{this._getAccessNode(e).then((e=>{this._retryLimiter.reset(),i(e)})).catch((s=>{if(this._destroyed)return;if(Array.isArray(s)&&s.length>0){if(s.findIndex((e=>400<=e.code&&e.code<500))>-1)return this._retryLimiter.reset(),o(new Error("HTTP request failed(4xx)"));if(s.every((e=>{var t;return 201===e.code||201===(null===(t=e.error)||void 0===t?void 0:t.code)}))&&t++,3===t)return this._retryLimiter.reset(),o(new Error("HTTP request failed(201)"))}const r=this._retryLimiter.getRetryDelay();this.logger.warn("_getAccessWithRetry()","_getAccessWithRetry error, will retry after ".concat(r,"ms"),s),this._retryFunc=()=>{this._getAccessWithRetry(e,t).then(i).catch(o)},this._reconnectTimer=self.setTimeout(this._retryFunc,r)}))}))}async _getAccessNode(e){return new Promise(((t,i)=>{const o=DS.getAccessNode(this._ctx.appId);if(o){const i=(Array.isArray(o)?o:[o]).map((e=>(e.cache_status=!0,e)));this.logger.info("getAccessNode","use cache node."),t(i),this._timer=setTimeout((()=>{this._getAccessNodeFromServer(e),this._reportRtcInvokeStatus("es.R.node.cache",o),delete this._timer}),0)}else this._getAccessNodeFromServer(e).then(t).catch(i)}))}async _getAccessNodeFromServer(e){const{urls:t,needFallback:i}=this._getAccessUrls();return this.getICEConfigFromServer(t,e).then((e=>{const{nodes:t,decisionConfig:i}=e;return!this._ctx.useCloudProxy&&(null==t?void 0:t.length)>0&&DS.setAccessNode(this._ctx.appId,t,e.ttl||11200),i&&this._decisionConfig.updateConfig(i,!1),e.dispatchDomains&&!this._ctx.useCloudProxy&&DS.setAccessUrls(e.dispatchDomains),t})).catch((t=>{if(i)return this._reportRtcInvokeStatus("es.R.req.fallback",""),DS.clearAccessUrls(),this._getAccessNodeFromServer(e);throw t}))}_getAccessUrls(){let e=DS.getAccessUrls()||[],t=!0;return 0!==e.length?this._reportRtcInvokeStatus("es.R.req.cache.urls",e):(t=!1,e=_y.ICE_CONFIG_REQUEST_URLS,0!==e.length?this._reportRtcInvokeStatus("es.R.req.external.urls",e):(e=_y.ICE_CONFIG_REQUEST_URLS_INTERNAL,this._reportRtcInvokeStatus("es.R.req.internal.urls",e))),{urls:e,needFallback:t}}async getICEConfigFromServer(e,t){const i={appID:this._ctx.appId,deviceID:DS.getDeviceId(),os:"web",sdkVersion:_y.VERSION,isOversea:_y.OVERSEA,expectedAddr:vy("EXPECTED_ADDR"),productPlatform:"VolcEngine",enableCloudProxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC,decisionKeys:["rts_report","web_join_room","web_rtc_config","rts_qps","rts_config"]};var o;t&&(i.feedbackInfo=t,"ICE_FAILED"!==(null===(o=t[0])||void 0===o||null===(o=o.feedbackReason)||void 0===o?void 0:o.type)&&delete i.expectedAddr);"AREA_CODE_US_OPCO"===vy("AREA_CODE")&&(i.mediaArea=JSON.stringify([{AreaList:["GEO:US_OPCO"],Attribute:"include"}]),i.accessArea=JSON.stringify([{AreaList:["GEO:US_OPCO"],Attribute:"include"}]));return(e=>new Promise(((t,i)=>{let o=(e=Array.isArray(e)?e:[]).length;const s=[];0===o?i([]):e.forEach((e=>{e.then((e=>{t(e)}),(e=>{o--,s.push(e),0===o&&i(s)}))}))})))(e.map((e=>this._httpRequest(e,i))))}async _httpRequest(e,t){var i;const o=Vy();t.connectSessionID=o;const s=Date.now();null===(i=this._monitor)||void 0===i||i.report("rtc_get_access",{error_code:0,message:JSON.stringify(t),elapse:0,type:"request",host:e,config_id:o,group_config_id:this._groupConfigId});const r=new AbortController;let n;this._abortControllers.push(r);try{var a;try{n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify(t),signal:r.signal})}catch(u){var d;if(l=fetch,!Function.prototype.toString.call(l).includes("[native code]"))null===(d=this._monitor)||void 0===d||d.report("rtc_error",{error_code:PL.Fetch_MODIFY,message:"get access failed, possibly due to modifying the browser's Fetch API."},{origin_error:u});throw u}if(this._abortControllers=this._abortControllers.filter((e=>e!==r)),200!==n.status)throw{message:n.statusText,code:n.status};const i=await n.json();if(200!==i.code)throw i;return null===(a=this._monitor)||void 0===a||a.report("rtc_get_access",{error_code:200,message:JSON.stringify(i),elapse:Date.now()-s,type:"response",host:e,config_id:o,group_config_id:this._groupConfigId}),i}catch(h){var c;throw null===(c=this._monitor)||void 0===c||c.report("rtc_get_access",{error_code:Number((null==h?void 0:h.code)||(null==h?void 0:h.server_code)),message:null==h?void 0:h.message,elapse:Date.now()-s,type:"response",host:e,config_id:o,group_config_id:this._groupConfigId},{error:JSON.stringify(h)}),h}var l}destroy(){this._destroyed=!0,window.removeEventListener("online",this._onlineListener),this._abortControllers.forEach((e=>e.abort("engine destroy"))),this._reconnectTimer&&(window.clearTimeout(this._reconnectTimer),delete this._reconnectTimer),this._timer&&(window.clearTimeout(this._timer),delete this._timer)}_reportRtcInvokeStatus(e,t){var i;null===(i=this._monitor)||void 0===i||i.report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:0,stream_id:"",elapse:0,group_config_id:this._groupConfigId})}}var hk={},mk={},pk={exports:{}},_k=pk.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(_k).forEach((function(e){_k[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}));var bk=pk.exports;!function(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,o){var s=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:s&&!i[e.name]&&(i[e.name]={});var r=e.push?{}:s?i[e.name]:i;!function(e,i,o,s){if(s&&!o)i[s]=t(e[1]);else for(var r=0;r<o.length;r+=1)null!=e[r+1]&&(i[o[r]]=t(e[r+1]))}(o.match(e.reg),r,e.names,e.name),e.push&&i[e.push].push(r)},o=bk,s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},r=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach((function(e){var t=e[0],s=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),n=r[r.length-1]);for(var a=0;a<(o[t]||[]).length;a+=1){var d=o[t][a];if(d.reg.test(s))return i(d,n,s)}})),t.media=r,t};var r=function(e,i){var o=i.split(/=(.+)/,2);return 2===o.length?e[o[0]]=t(o[1]):1===o.length&&i.length>1&&(e[o[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(r,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],o=e.split(" ").map(t),s=0;s<o.length;s+=3)i.push({component:o[s],ip:o[s+1],port:o[s+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(r,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,o=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),o=!0),{scid:i,paused:o}}))}))}}(mk);var vk=bk,Sk=/%[sdv%]/g,yk=function(e){var t=1,i=arguments,o=i.length;return e.replace(Sk,(function(e){if(t>=o)return e;var s=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}}))},fk=function(e,t,i){var o=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var r=t.names[s];t.name?o.push(i[t.name][r]):o.push(i[t.names[s]])}else o.push(i[t.name]);return yk.apply(null,o)},gk=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Tk=["i","c","b","a"],Ik=mk,Rk=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||gk,o=t.innerOrder||Tk,s=[];return i.forEach((function(t){vk[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(fk(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(fk(t,i,e))}))}))})),e.media.forEach((function(e){s.push(fk("m",vk.m[0],e)),o.forEach((function(t){vk[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(fk(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(fk(t,i,e))}))}))}))})),s.join("\r\n")+"\r\n"},Ek=bk;hk.grammar=Ek,hk.write=Rk,hk.parse=Ik.parse,hk.parseParams=Ik.parseParams,hk.parseFmtpConfig=Ik.parseFmtpConfig,hk.parsePayloads=Ik.parsePayloads,hk.parseRemoteCandidates=Ik.parseRemoteCandidates,hk.parseImageAttributes=Ik.parseImageAttributes,hk.parseSimulcastStreamList=Ik.parseSimulcastStreamList;const Ck=new eS("FirefoxHandler",3),Zk=Math.pow(2,32),Lk="kp34Za0H+aVf862l";function Pk(e){return e>Zk-18?(Ck.warn("generateAllSsrc","reset start id",e),Pk(e=e-Zk+1e4+18)):{audio:e,audioFec:e+1,audioRtx:e+2,video:e+3,videoFec:e+4,videoRtx:e+5,next:e+18}}const kk=function(e,t,i){return[{id:i,attribute:"cname",value:arguments.length>3&&void 0!==arguments[3]?arguments[3]:"o/i14u9pJrxRKAsu"},{id:i,attribute:"msid",value:"".concat(e," ").concat(e,"-").concat(t)},{id:i,attribute:"mslabel",value:"".concat(e)},{id:i,attribute:"label",value:"".concat(e,"-").concat(t)}]},Nk=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const o=t.video,s=t.videoRtx,r=t.videoFec,n=[o,s],{cname:a,flexfec:d}=i;d&&n.push(r);const c=n.reduce(((t,i)=>t.concat(kk(e,"video",i,a))),[]),l=[{semantics:"FID",ssrcs:"".concat(o," ").concat(s)}];return d&&l.push({semantics:"FEC-FR",ssrcs:"".concat(o," ").concat(r)}),{ssrcs:c,ssrcGroups:l}};function Xk(e){return e.direction="inactive",e.port=0,delete e.ext,delete e.ssrcs,delete e.ssrcGroups,delete e.simulcast,delete e.simulcast_03,delete e.rids,delete e.extmapAllowMixed,delete e.msid,delete e.bundleOnly,e}const Vk=function(e,t,i){let o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const s=Yu(Yu({},e),{},{media:[]});return o&&(s.invalid=[{value:"realx-exts:rscp"}]),t&&s.media.push(t),i&&s.media.push(i),delete s.groups,delete s.msidSemantic,hk.write(s)};function wk(e){const t={},{publicIPs:i,certFingerprint:o,iceParams:s,iceConfig:r}=e;return t.fingerprint={type:"sha-256",hash:o},t.icePwd=s.serverIcePwd,t.iceUfrag=xk(s.serverIceUfrag),t.candidates=function(e,t){if(!Array.isArray(e))return[];let i=0;const o=2130706431,s=[];return e.forEach((e=>{const r={component:1,ip:e.ip,type:"host",generation:e.generation};e.udpPorts&&!t.tcpOnly&&e.udpPorts.forEach((e=>{s.push(Yu(Yu({},r),{},{foundation:i++,transport:"udp",port:e,priority:o}))})),e.tcpPorts&&e.tcpPorts.forEach((e=>{s.push(Yu(Yu({},r),{},{foundation:i++,transport:"tcp",port:e,tcptype:"passive",priority:o-1e3}))}))})),s}(i,r),t.setup="active",t.iceOptions="renomination",t}const xk=e=>{const t=(new TextEncoder).encode("PREC"),i=function(e){const t=atob(e),i=t.length,o=new Uint8Array(i);for(let s=0;s<i;s++)o[s]=t.charCodeAt(s);return o}(e),o=new Uint8Array(4);crypto.getRandomValues(o);const s=new Uint8Array(2);s[0]=0,s[1]=1;return function(e){let t="";const i=e.byteLength;for(let o=0;o<i;o++)t+=String.fromCharCode(e[o]);return btoa(t)}(xy(Uint8Array,t,i,o,s))},Gk=(e,t)=>{if(!Array.isArray(e.fmtp)||!Array.isArray(e.rtp))return;for(let o=0;o<e.rtp.length;o++){if(e.rtp[o].codec.toUpperCase()===t.toUpperCase()){e.rtp.unshift(e.rtp.splice(o,1)[0]);break}}const i=[];e.rtp.forEach((e=>i.push(e.payload))),e.payloads=i.join(" ")},Wk=(e,t)=>{let i=0;if(!Array.isArray(e.fmtp)||!Array.isArray(e.rtp))return;for(const s of e.fmtp)if(s.config.includes("level-asymmetry-allowed=1")&&s.config.includes("packetization-mode=1")&&s.config.includes("profile-level-id=42e0")){i=s.payload;break}for(let s=0;s<e.rtp.length;s++){const o=e.rtp[s];if("H264"===t){if(o.payload===i){e.rtp.unshift(e.rtp.splice(s,1)[0]);break}}else if(o.codec===t){e.rtp.unshift(e.rtp.splice(s,1)[0]);break}}const o=[];e.rtp.forEach((e=>o.push(e.payload))),e.payloads=o.join(" ")},Mk=e=>{e.media.forEach((e=>{"audio"!==e.type&&"video"!==e.type||e.rtp.forEach((t=>{e.rtcpFb||(e.rtcpFb=[]),e.rtcpFb.find((e=>e.payload===t.payload&&"rrtr"===e.type))||e.rtcpFb.push({payload:t.payload,type:"rrtr"})}))}))},Ak=function(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{rrtr:!1};const s={},r={};let n=-1;const a=[];return Array.isArray(e.fmtp)&&e.fmtp.forEach((e=>{let{payload:t,config:i}=e;if(i.startsWith("apt=")){const e=i.slice(4);s[t]=e}else i.includes("42e0")&&i.includes("packetization-mode=1")&&(n=t)})),Array.isArray(e.rtp)&&(e.rtp=e.rtp.filter((e=>{const i=e.codec,o=e.payload;let d;switch(i){case"H264":return d=!1,t.map((e=>{"H264"===e&&o===n&&(r[o]=o,a.push(o),d=!0)})),d;case"rtx":return!!r[s[o]]&&(r[o]=o,!0);case"red":case"ulpfec":case"flexfec-03":return r[o]=o,!0;default:return d=!1,t.map((e=>{e===i&&(r[o]=o,a.push(o),d=!0)})),d}}))),Array.isArray(e.fmtp)&&(e.fmtp=e.fmtp.filter((e=>r[e.payload]))),Array.isArray(e.rtcpFb)?e.rtcpFb=e.rtcpFb.filter((e=>r[e.payload])):e.rtcpFb=[],o.rrtr&&a.forEach((t=>{var i;null===(i=e.rtcpFb)||void 0===i||i.push({payload:t,type:"rrtr"})})),Dk(e,i),Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>{if("http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"!==e.uri&&"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"!==e.uri&&"http://www.webrtc.org/experiments/rtp-hdrext/color-space"!==e.uri)return e}))),"string"==typeof e.payloads&&(e.payloads=e.payloads.split(" ").filter((e=>r[e])).join(" ")),e},Ok=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{rrtr:!1};const o={};if(Array.isArray(e.rtp)&&(e.rtp=e.rtp.filter((e=>{const t=e.codec,i=e.payload;return("opus"===t||"red"===t)&&(o[i]=i,!0)}))),Array.isArray(e.rtcpFb)||(e.rtcpFb=[]),i.rrtr&&Object.keys(o).forEach((t=>{var i;null===(i=e.rtcpFb)||void 0===i||i.push({payload:Number(t),type:"rrtr"})})),Dk(e,t),"string"==typeof e.payloads){const t=[];e.payloads.split(" ").forEach((e=>{o[e]&&t.push(e)})),e.payloads=t.join(" ")}return e},Dk=(e,t)=>{e.iceOptions&&delete e.iceOptions,e.icePwd&&(t.icePwd=e.icePwd,delete e.icePwd),e.iceUfrag&&(t.iceUfrag=e.iceUfrag,delete e.iceUfrag),e.fingerprint&&(t.fingerprint=e.fingerprint,delete e.fingerprint)},Yk=e=>Uk(e,"H265","ByteVC1"),Kk=e=>Uk(e,"ByteVC1","H265"),Uk=(e,t,i)=>{if(-1===e.indexOf(t))return e;const o=hk.parse(e);return o.media=o.media.map((e=>("video"===e.type&&(e.rtp=e.rtp.map((e=>(e.codec===t&&(e.codec=i),e)))),e))),hk.write(o)},Fk={iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",encodedInsertableStreams:!!DT()||void 0};var Hk=(e=>(e[e.DC_ERROR=0]="DC_ERROR",e[e.DC_CLOSE=1]="DC_CLOSE",e[e.ICE_FAILED=2]="ICE_FAILED",e[e.DESTROY=3]="DESTROY",e[e.TIMEOUT=4]="TIMEOUT",e))(Hk||{});let Jk=0;class zk extends aT{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];super(),Ou(this,"uuid",(Jk++).toString()),Ou(this,"_peerConnectionId",""),Ou(this,"audioTrack4ff",void 0),Ou(this,"_pc",void 0),Ou(this,"_dc",void 0),Ou(this,"_iceNode",void 0),Ou(this,"_initSctpEvents",!1),Ou(this,"_monitor",void 0),Ou(this,"_offerIce",{}),Ou(this,"_answerIce",{}),Ou(this,"_offerSession",void 0),Ou(this,"_answerSession",void 0),Ou(this,"_offerMlines",[]),Ou(this,"_answerMlines",[]),Ou(this,"_connectReject",void 0),Ou(this,"_logger",void 0),Ou(this,"_destroyed",!1),Ou(this,"_reportTimer",void 0),Ou(this,"_clearPeerListeners",void 0),Ou(this,"_iceStartTs",0),Ou(this,"_icePreStepTs",0),this._ctx=e,this._groupConnectionId=t,this._isReconnect=i,this._monitor=Nv(e.id),this._logger=new eS("PeerConnection_".concat(this.uuid),4,e.id),vy("DISABLE_ENCODED_TRANSFORM")&&(Fk.encodedInsertableStreams=void 0),this._pc=new RTCPeerConnection(Fk),this._pc.ontrack=e=>{var t;const i=null===(t=e.streams)||void 0===t||null===(t=t[0])||void 0===t?void 0:t.id;this._print("pc.ontrack","".concat(e.track.kind," ").concat(e.track.id," ").concat(i)),"ff-stream"===i&&(this.audioTrack4ff=e.track),this.emit("ontrack",e)},this._pc.onconnectionstatechange=()=>{this._print("onconnectionstatechange","".concat(this._pc.connectionState,". ice -> ").concat(this._pc.iceConnectionState)),"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState&&"failed"!==this._pc.connectionState||this.emit("disconnect",jk.ICE_FAILED)},this._pc.oniceconnectionstatechange=()=>{const e=this._pc.iceConnectionState;this._report("rtc_pre_ice_state",{message:e,ice_state:e.toUpperCase()}),this.emit("ice_state",e)}}static checkSupported(){if(!RTCPeerConnection)throw new HS(US.NOT_SUPPORTED,"missing RTCPeerConnection API.");["addTransceiver","createDataChannel","createOffer","setLocalDescription","setRemoteDescription"].forEach((e=>{var t;if(null===(t=RTCPeerConnection)||void 0===t||null===(t=t.prototype)||void 0===t||!t[e])throw new HS(US.NOT_SUPPORTED,"missing peer.".concat(e," API."))}))}getOriginRTCPeerConnection(){return this._pc}getConnectionId(){return this._peerConnectionId}getGroupConnectionId(){return this._groupConnectionId}getIceConnectionState(){return this._pc.iceConnectionState}async createOfferSdp(){let{sdp:e}=await this._pc.createOffer();return e&&(e=Yk(e)),e}async startIceConnect(e){this._print("connect","invoke. %o",e),this._iceNode=e;const t=this._pc.createDataChannel("signaling",{negotiated:!0,id:100});t.binaryType="arraybuffer",this._dc=t;const{offerIce:i,answerIce:o}=this._genIceInfo(e);this._offerIce=i,this._answerIce=o,this._peerConnectionId=o.iceUfrag||"",this.reportRtcPreIce("ice_start"),sS&&(this._pc.addTransceiver("audio",{direction:"recvonly"}),this._pc.addTransceiver("video",{direction:"recvonly"}));const s=await this.createOfferSdp();if(!s)throw new HS(US.NOT_SUPPORTED,"create offer sdp failed.");const r=hk.parse(s),[n]=r.media;if(this._offerIce.fingerprint=r.fingerprint||n.fingerprint,sS){r.media=r.media.map((e=>{const t=Yu(Yu({},e),this._offerIce);var i,o,s,r;"video"===t.type&&(UT?(t.ext=null===(i=t.ext)||void 0===i?void 0:i.filter((e=>-1===e.uri.indexOf("abs-send-time"))),t.rtcpFb=null===(o=t.rtcpFb)||void 0===o?void 0:o.filter((e=>"goog-remb"!==e.type))):(t.rtcpFb=null===(s=t.rtcpFb)||void 0===s?void 0:s.filter((e=>"transport-cc"!==e.type)),t.ext=null===(r=t.ext)||void 0===r?void 0:r.filter((e=>-1===e.uri.indexOf("transport")))));return t})),FT&&Mk(r);const e=Yu({},r);e.fingerprint=this._answerIce.fingerprint,e.media=e.media.map((e=>(delete(e=Yu(Yu({},e),this._answerIce)).bundleOnly,e.port=9,"application"===e.type?e.sctpmap={sctpmapNumber:5e3,app:"webrtc-datachannel",maxMessageSize:262144}:("audio"===e.type&&(e.msid="ff-stream ff-stream-audio"),e.direction="sendonly"),e))),FT&&Mk(e),await this.setLocalDescription(hk.write(r)),await this.setRemoteDescription(hk.write(e))}else{delete r.media,this._offerSession=Yu({},r),this._answerSession=Yu({},r),this._answerSession.fingerprint&&(this._answerSession.fingerprint=this._answerIce.fingerprint);const e=0;this._offerMlines=[Yu(Yu(Yu({},n),this._offerIce),{},{mid:"".concat(e)})],this._answerMlines=[Yu(Yu(Yu({},n),this._answerIce),{},{sctpmap:{sctpmapNumber:5e3,app:"webrtc-datachannel",maxMessageSize:262144},mid:"".concat(e)})],this.setDescription()}return this._reportTransportStats(),await new Promise(((e,i)=>{this._connectReject=i;const o=setTimeout((()=>{var e;this.reportRtcPreIce("timeout"),null===(e=this._connectReject)||void 0===e||e.call(this,{code:4,message:"connect timeout"}),delete this._connectReject}),8e3),s=()=>{this._print("connect","dataChannel open"),this._reportRtcInvokeStatus("es.dc.open",""),this.reportRtcPreIce("datachannel_opened"),clearTimeout(o),e(""),delete this._connectReject},r=e=>{var t,i,s,r;this._report("rtc_signaling_msg_error",{error_code:null==e||null===(t=e.error)||void 0===t?void 0:t.sdpLineNumber,message:null==e||null===(i=e.error)||void 0===i?void 0:i.errorDetail,reason:"invalid data"}),this._reportRtcInvokeStatus("es.dc.error",""),null===(s=this._connectReject)||void 0===s||s.call(this,{message:"dc.onerror, ".concat(null===(r=e.error)||void 0===r?void 0:r.errorDetail),code:0}),this.emit("disconnect",jk.DC_ERROR),delete this._connectReject,clearTimeout(o)},n=()=>{var e;this._reportRtcInvokeStatus("es.dc.close",""),null===(e=this._connectReject)||void 0===e||e.call(this,{message:"dc.onclose",code:1}),this.reportRtcPreIce("datachannel_closed"),this.emit("disconnect",jk.DC_CLOSE),delete this._connectReject,clearTimeout(o)},a=()=>{"connected"===this._pc.iceConnectionState?this.reportRtcPreIce("ice_connected"):"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.reportRtcPreIce("ice_failed")},d=()=>{var e;"failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState&&"failed"!==this._pc.connectionState||(null===(e=this._connectReject)||void 0===e||e.call(this,{message:"pc.connectionstatechange -> ".concat(this._pc.connectionState,", ice -> ").concat(this._pc.iceConnectionState),code:2}),delete this._connectReject,clearTimeout(o))};t.addEventListener("open",s),t.addEventListener("error",r),t.addEventListener("close",n),this._pc.addEventListener("iceconnectionstatechange",a),this._pc.addEventListener("connectionstatechange",d),this._clearPeerListeners=()=>{t.removeEventListener("open",s),t.removeEventListener("error",r),t.removeEventListener("close",n),this._pc.removeEventListener("iceconnectionstatechange",a),this._pc.removeEventListener("connectionstatechange",d)}})),this._print("connect","dataChannel establish success"),t}async setDescription(e){this._print("setDescription","invoke."),this._offerSession.media=this._offerMlines,this._answerSession.media=this._answerMlines;const t=[];this._offerMlines.forEach((e=>{"inactive"!==e.direction&&e.mid&&t.push(e.mid)})),this._offerSession.groups&&this._answerSession.groups&&(this._offerSession.groups[0].mids=t.join(" "),this._answerSession.groups[0].mids=t.join(" "));const i=wy();e&&this._report("rtc_begin_create_offer",{direction:"local"===e.streamUserId?"up":"down",stream_id:e.streamId,stream_user_id:e.streamUserId,pc_session_id:this._peerConnectionId,vendor_mode:0}),await this._pc.createOffer(),e&&this._report("rtc_create_offer",{error_code:0,direction:"local"===e.streamUserId?"up":"down",stream_id:e.streamId,stream_user_id:e.streamUserId,elapse:wy()-i}),await this.setLocalDescription(hk.write(this._offerSession),e),await this.setRemoteDescription(hk.write(this._answerSession),e)}async setLocalDescription(e,t){const i=wy();try{if(e=Kk(e),await this._pc.setLocalDescription({type:"offer",sdp:e}),this._report("rtc_set_description",{error_code:0,message:e,is_local:"1",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:(null==t?void 0:t.streamId)||"",stream_user_id:(null==t?void 0:t.streamUserId)||"",elapse:wy()-i},{type:"offer"}),!this._initSctpEvents){var o;this._initSctpEvents=!0;const e=null===(o=this._pc)||void 0===o?void 0:o.sctp;e&&(e.onstatechange=()=>{this._reportRtcInvokeStatus("sctp","sctp state change TO: ".concat(e.state))},e.transport&&(e.transport.onstatechange=()=>{var t;this._reportRtcInvokeStatus("dtls","dtls state change TO: ".concat(null==e||null===(t=e.transport)||void 0===t?void 0:t.state))}))}}catch(s){throw console.error("setLocal",s),this._report("rtc_set_description",{error_code:-1,message:s.message+e,is_local:"1",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:"",stream_user_id:"",elapse:wy()-i},{type:"offer"}),s}}async setRemoteDescription(e,t){const i=wy();try{e=Kk(e),await this._pc.setRemoteDescription({type:"answer",sdp:e}),this._report("rtc_set_description",{error_code:0,message:e,is_local:"0",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:(null==t?void 0:t.streamId)||"",stream_user_id:(null==t?void 0:t.streamUserId)||"",elapse:wy()-i},{type:"answer"})}catch(o){throw console.error("setRemote",o),this._report("rtc_set_description",{error_code:-1,message:o.message+e,is_local:"0",direction:"local"===(null==t?void 0:t.streamUserId)?"up":"down",stream_id:(null==t?void 0:t.streamId)||"",stream_user_id:(null==t?void 0:t.streamUserId)||"",elapse:wy()-i},{type:"answer"}),o}}closeIceConnect(){var e,t,i,o,s;null===(e=this._connectReject)||void 0===e||e.call(this,{code:3,message:"invoke destroy()"}),delete this._connectReject,null===(t=this._pc)||void 0===t||t.close(),null===(i=this._dc)||void 0===i||i.close(),delete this._dc,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,s=this._pc,rL.has(s)&&rL.delete(s),null===(o=this._clearPeerListeners)||void 0===o||o.call(this),delete this._clearPeerListeners}reportRtcPreIce(e){var t;const i=wy();"ice_start"===e&&(this._iceStartTs=i,this._icePreStepTs=i),this._report("rtc_pre_ice",{connect_event:e,message:e,elapse:i-this._icePreStepTs,total_elapse:i-this._iceStartTs,cache_status:!(null===(t=this._iceNode)||void 0===t||!t.cache_status),is_reconnect:this._isReconnect}),this._icePreStepTs=i}getStatsWithLowFrequency(e,t,i){return(async(e,t,i,o)=>{const s=null==t?void 0:t.id;if(!(e instanceof RTCPeerConnection))return[];if(sS||rS){const i=[];try{(o?await o.getStats():await e.getStats(t)).forEach((e=>{i.push(e)}))}catch(d){}return i}let r=rL.get(e);(!r||Date.now()-r.timestamp>150)&&(r={timestamp:Date.now(),statsPromise:dL(e),extraStatsPromise:aL(e)},rL.set(e,r));const n=await r.statsPromise;let a=(s?n[s]:n.all)||[];if(!i){const e=await r.extraStatsPromise;a=a.concat((s?e.getTrackStats(s):e.all)||[])}return a})(this._pc,e,t,i)}destroy(){this._print("destroy",this._peerConnectionId),super.removeAllListeners(),this.closeIceConnect(),this._destroyed=!0,this._reportTimer&&(clearTimeout(this._reportTimer),delete this._reportTimer),delete this._pc}_genIceInfo(e){var t,i;return{offerIce:{iceUfrag:null===(t=e.iceParams)||void 0===t?void 0:t.clientIceUfrag,icePwd:null===(i=e.iceParams)||void 0===i?void 0:i.clientIcePwd,iceOptions:"renomination"},answerIce:wk(e)}}async _reportTransportStats(){const e=await this.getStatsWithLowFrequency(),t={};var i;(e.forEach((e=>{"transport"===e.type?(t.dtls_state=e.dtlsState,t.bytes_received=e.bytesReceived,t.bytes_sent=e.bytesSent,t.ice_state=e.iceState,t.packets_received=e.packetsReceived,t.packets_sent=e.packetsSent,t.selected_candidate_pair_changes=e.selectedCandidatePairChanges):"local-candidate"===e.type||"remote-candidate"===e.type?t.candidates_info=[...t.candidates_info||[],{id:e.id,is_remote:e.isRemote,port:e.port,protocol:e.protocol,candidate_type:e.candidateType,priority:e.priority,network_type:e.networkType,candidate_ip:e.ip}]:"candidate-pair"===e.type&&(t.candidatePairsInfo={},t.candidatePairsInfo.candidate_state=e.state,t.candidatePairsInfo.writable_state=e.writable,t.candidatePairsInfo.sent_ping_requests_total=e.requestsSent,t.candidatePairsInfo.recv_ping_requests=e.requestsReceived,t.candidatePairsInfo.sent_ping_responses=e.responsesSent,t.candidatePairsInfo.recv_ping_responses=e.responsesReceived,t.candidatePairsInfo.current_rtt=e.currentRoundTripTime,t.candidatePairsInfo.total_rtt=e.totalRoundTripTime,["localCandidateId","remoteCandidateId","bytesSent","bytesReceived","availableOutgoingBitrate","availableIncomingBitrate","bytesDiscardedOnSend","consentRequestsSent","packetsDiscardedOnSend","lastPacketReceivedTimestamp","lastPacketSentTimestamp"].forEach((i=>{var o;void 0!==e[i]&&(t.candidatePairsInfo[(o=i,o.replace(/[A-Z]/g,(e=>"_".concat(e.toLowerCase()))))]=e[i])})))})),Object.keys(t).length>0)&&(null===(i=this._monitor)||void 0===i||i.report("rtc_transport_statistics",t));if(!this._destroyed){const e="connected"===this._pc.iceConnectionState&&"connected"===this._pc.connectionState;this._reportTimer=setTimeout((()=>{this._reportTransportStats()}),e?5e3:1e3)}}_print(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._logger.info("".concat(e),...i)}_report(e,t,i){var o,s,r;null===(o=this._monitor)||void 0===o||o.report(e,Yu(Yu({},t),{},{connection_id:this._peerConnectionId,group_connection_id:this._groupConnectionId}),Yu(Yu({},i),{},{tcp_only:null===(s=this._iceNode)||void 0===s?void 0:s.iceConfig.tcpOnly,ms_addr:JSON.stringify((null===(r=this._iceNode)||void 0===r?void 0:r.publicIPs.map((e=>({ip:e.ip,tcp:e.tcpPorts,udp:e.udpPorts}))))||[])}))}_reportRtcInvokeStatus(e,t){this._report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:0,stream_id:"",elapse:0})}}var jk=(e=>(e.ICE_FAILED="ice failed",e.DC_ERROR="datachannel onerror",e.DC_CLOSE="datachannel onclose",e.NODE_CHANGE="recv nodeChange signaling",e.NOTIFY_RECONNECT="recv notifyReconnect signaling",e.JOIN_TIMEOUT="joinRoom timeout, retry with tcp only",e))(jk||{});class Qk extends aT{constructor(e){super(),Ou(this,"id",void 0),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),Ou(this,"_getAccessManager",void 0),Ou(this,"_connectionPool",new Map),Ou(this,"_curConnection",void 0),Ou(this,"_hasReportBrowerWarning",!1),Ou(this,"_reconnectTimer",void 0),Ou(this,"_connecting",!1),Ou(this,"_isFirstTimeConnected",!0),Ou(this,"_feedbackNodes",[]),Ou(this,"_preIceStartTime",-1),Ou(this,"_tcpOnlyTimer",void 0),Ou(this,"_destroyed",!1),this._ctx=e,this.id=e.id,this._monitor=Nv(this.id),this.logger=new eS("ConnectionManager",3,this.id),this.logger.info("constructor","invoke"),this._getAccessManager=new uk(e)}startup(){this.logger.info("connect","invoke");try{zk.checkSupported()}catch(e){this.asyncEmit("disconnected",e)}this._connecting||(this._onConnectStart(),Promise.resolve().then((()=>this.emit("__onGetIceConfigHook"))),this._getAccess())}async reconnectByNodeChange(e){var t,i,o;this.logger.info("reconnectByNodeChange","invoke %o",e);const{nodes:s,reason:r}=e;null===(t=this._monitor)||void 0===t||t.report("rtc_node_change",{error_code:0,message:JSON.stringify(e),reason:JSON.stringify(r)}),DS.clearAccessNode(this._ctx.appId),null===(i=this._curConnection)||void 0===i||i.pc.reportRtcPreIce("node_change");const n=(null===(o=this._curConnection)||void 0===o||null===(o=o.node.publicIPs[0])||void 0===o?void 0:o.ip)||"";this._closeCurrentConnection(),this._clearConnectionPool(),this._clearReconnectTimer(),this._onConnectStart("recv nodeChange signaling"),Array.isArray(s)&&s.length>0?this._startIceConnect(s):this._getAccess([{feedbackIP:n,feedbackReason:{type:"NODE_CHANGED",reason:r}}])}async reconnect(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.logger.info("reconnect","invoke. ".concat(t?"ICE over TCP":"")),this._closeCurrentConnection(),this._clearConnectionPool(),this._clearReconnectTimer(),this._onConnectStart(e),this._getAccess(void 0,t)}shotdown(){this.logger.info("destroy","invoke"),this._destroyed=!0,this.asyncEmit("disconnected",new HS(US.OPERATION_CANCEL,"destroy")).then((()=>{super.removeAllListeners()})),this._clearReconnectTimer(),this._clearConnectionPool(),this._getAccessManager.destroy(),this._closeCurrentConnection()}_getAccess(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._getAccessManager.getICENode(e).then((e=>{this.emit("__onGetIceSuccessHook",e),this._startIceConnect(e,t)})).catch((e=>{this.asyncEmit("disconnected",e)})).finally((()=>{this._feedbackNodes=[]}))}_startIceConnect(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._destroyed)return;this.logger.info("_startIceConnect","invoke");const i=vm();this._preIceStartTime=wy();const o=this._ctx.joinRoomConfig.useTcpJoin,s=this._ctx.joinRoomConfig.useTcpJoinDelay,r=async o=>{t&&((o=XP(o)).iceConfig.tcpOnly=!0);const s={node:o};try{const t=new zk(this._ctx,i,!this._isFirstTimeConnected);s.pc=t,this._connectionPool.set(t.uuid,s);const r=await t.startIceConnect(o),n=new FP(this.id,r,{connection_id:t.getConnectionId(),group_connection_id:i});s.signaling=n,t.reportRtcPreIce("datachannel_send_ping"),await n.sendPingSignaling(),t.reportRtcPreIce("datachannel_recv_pong"),this._onConnectSuccess({node:o,pc:t,signaling:n,dc:r}),this.safeEmit("__onConnectSuccessHook",e.length)}catch(r){this._onConnectionFailed(s,r)}};this.emit("__onIceConnectStartHook"),e.forEach(r),o&&!t&&(this.logger.info("_startIceConnect","tcp-only will try after ".concat(s,"ms")),this._tcpOnlyTimer=setTimeout((()=>{this.emit("connectWidthTcp"),e.forEach((e=>{(e=XP(e)).iceConfig.tcpOnly=!0,r(e)})),delete this._tcpOnlyTimer}),s))}_onConnectSuccess(e){var t;(this.logger.info("connect","peer_%s connect success.",e.pc.uuid),this.emit("__onIceConnectSuccessHook",e),this._curConnection)?(e.pc.destroy(),e.signaling.destroy(),this._connectionPool.delete(e.pc.uuid)):(this._curConnection=e,this._addConnectionHandler(e.pc),null===(t=this._monitor)||void 0===t||t.set({connection_id:e.pc.getConnectionId()}),this._connectionPool.delete(e.pc.uuid),this._feedbackNodes.forEach((e=>this._feedbackBySignaling(e))),this._feedbackNodes=[],this._onConnectEnded(e))}_onConnectionFailed(e,t){var i,o;(this.logger.info("connect","peer_%s connect failed. %s",(null===(i=e.pc)||void 0===i?void 0:i.uuid)||"",t.message),this.emit("__onIceConnectFailedHook",e),t.code!==Hk.DESTROY&&t.code!==US.OPERATION_CANCEL)&&(this._curConnection?this._feedbackBySignaling(e.node):this._feedbackNodes.push(e.node),this.logger.info("connect","remove cache node"),DS.deleteAccessNode(this._ctx.appId,e.node),e.pc&&(this._connectionPool.delete(e.pc.uuid),e.pc.destroy()),null===(o=e.signaling)||void 0===o||o.destroy(),0!==this._connectionPool.size||this._curConnection||this._destroyed||(this.logger.error("connect","establish peerConnection failed"),this._checkBrowserUA(),wy()-this._preIceStartTime<1e3?(this._clearReconnectTimer(),this._reconnectTimer=setTimeout((()=>{delete this._reconnectTimer,this._reconnectWithIceFailed(this._feedbackNodes)}),1e3)):this._reconnectWithIceFailed(this._feedbackNodes)))}_feedbackBySignaling(e){var t;null===(t=this._curConnection)||void 0===t||t.signaling.sendSignaling("scheduleMessage",{type:"feedback",body:{feedbackIP:e.publicIPs[0].ip,feedbackReason:{type:"ICE_FAILED",reason:{}}}})}async _reconnectWithIceFailed(e){this._onConnectStart("ice failed"),this.logger.warn("reconnect","because of ice failed"),this._getAccess(e.map((e=>({feedbackIP:e.publicIPs[0].ip,feedbackReason:{type:"ICE_FAILED",reason:{}}}))))}_checkBrowserUA(){var e;!this._hasReportBrowerWarning&&this._ctx.joinRoomConfig.isBlackBrower()&&(this._hasReportBrowerWarning=!0,null===(e=this._monitor)||void 0===e||e.report("rtc_error",{error_code:PL.BLACK_BROWSER,message:"failed to establish data-channel, and the current browser is on the browser blacklist."}))}_onConnectStart(e){var t;this.logger.info("_onConnectStart","invoke, reason: ".concat(e||"init")),this._connecting=!0,e?this.asyncEmit("reconnecting",e):this.asyncEmit("connecting");const i=vm();var o;(null===(t=this._monitor)||void 0===t||t.set({connect_session_id:i}),this._isFirstTimeConnected)||(null===(o=this._monitor)||void 0===o||o.report("rtc_reconnect",{error_code:1002,message:"peerconnection reconnecting",reconnect_id:i,reconnect_type:"peerconnection"},{reason:e}))}_onConnectEnded(e){var t;(this.logger.info("_onConnectEnded","invoke"),this._connecting=!1,this._isFirstTimeConnected)||(null===(t=this._monitor)||void 0===t||t.report("rtc_reconnected",{message:"peerconnection reconnected",reconnect_type:"peerconnection"}));this._isFirstTimeConnected=!1,this.asyncEmit("connected",e),e.node.iceConfig.tcpOnly&&(this.logger.info("_onConnectEnded","use tcp only"),Wv(this._ctx.id,"connected_with_tcp_only",JSON.stringify(e.node))),this._tcpOnlyTimer&&(window.clearTimeout(this._tcpOnlyTimer),delete this._tcpOnlyTimer),this._clearConnectionPool()}_addConnectionHandler(e){e.on("disconnect",(e=>{this._closeCurrentConnection(),this._clearReconnectTimer(),navigator.onLine?this.reconnect(e):this._reconnectTimer=setTimeout((()=>this.reconnect(e)),3e3)}))}_closeCurrentConnection(){var e,t;null===(e=this._curConnection)||void 0===e||e.pc.destroy(),null===(t=this._curConnection)||void 0===t||t.signaling.destroy(),delete this._curConnection}_clearConnectionPool(){this._connectionPool.forEach(((e,t)=>{var i,o;null===(i=e.signaling)||void 0===i||i.destroy(),null===(o=e.pc)||void 0===o||o.destroy(),this._connectionPool.delete(t)}))}_clearReconnectTimer(){this._reconnectTimer&&(window.clearTimeout(this._reconnectTimer),delete this._reconnectTimer)}}var Bk=i(ds.f("asyncIterator")),qk=et,$k=wd,eN=C,tN=$t,iN=B,oN=Si,sN=Error,rN=b("".replace),nN=String(new sN("zxcasd").stack),aN=/\n\s*at [^:]*:[^\n]*/,dN=aN.test(nN),cN=W,lN=!r((function(){var e=new Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",cN(1,7)),7!==e.stack)})),uN=Si,hN=function(e,t){if(dN&&"string"==typeof e&&!sN.prepareStackTrace)for(;t--;)e=rN(e,aN,"");return e},mN=lN,pN=Error.captureStackTrace,_N=qt,bN=k,vN=si,SN=Ce,yN=ZE,fN=Yi,gN=se,TN=GI,IN=PI,RN=gE,EN=TypeError,CN=function(e,t){this.stopped=e,this.result=t},ZN=CN.prototype,LN=function(e,t,i){var o,s,r,n,a,d,c,l=i&&i.that,u=!(!i||!i.AS_ENTRIES),h=!(!i||!i.IS_RECORD),m=!(!i||!i.IS_ITERATOR),p=!(!i||!i.INTERRUPTED),_=_N(t,l),b=function(e){return o&&RN(o,"normal",e),new CN(!0,e)},v=function(e){return u?(vN(e),p?_(e[0],e[1],b):_(e[0],e[1])):p?_(e,b):_(e)};if(h)o=e.iterator;else if(m)o=e;else{if(!(s=IN(e)))throw new EN(SN(e)+" is not iterable");if(yN(s)){for(r=0,n=fN(e);n>r;r++)if((a=v(e[r]))&&gN(ZN,a))return a;return new CN(!1)}o=TN(e,s)}for(d=h?e.next:o.next;!(c=bN(d,o)).done;){try{a=v(c.value)}catch(BW){RN(o,"throw",BW)}if("object"==typeof a&&a&&gN(ZN,a))return a}return new CN(!1)},PN=fo,kN=ki,NN=se,XN=Oc,VN=pl,wN=function(e,t,i){for(var o=$k(t),s=tN.f,r=eN.f,n=0;n<o.length;n++){var a=o[n];qk(e,a)||i&&qk(i,a)||s(e,a,r(t,a))}},xN=Ho,GN=Si,WN=W,MN=function(e,t){iN(t)&&"cause"in t&&oN(e,"cause",t.cause)},AN=function(e,t,i,o){mN&&(pN?pN(e,t):uN(e,"stack",hN(i,o)))},ON=LN,DN=function(e,t){return void 0===e?arguments.length<2?"":t:PN(e)},YN=pt("toStringTag"),KN=Error,UN=[].push,FN=function(e,t){var i,o=NN(HN,this);VN?i=VN(new KN,o?XN(this):HN):(i=o?this:xN(HN),GN(i,YN,"Error")),void 0!==t&&GN(i,"message",DN(t)),AN(i,FN,i.stack,1),arguments.length>2&&MN(i,arguments[2]);var s=[];return ON(e,UN,{that:s}),GN(i,"errors",s),i};VN?VN(FN,KN):wN(FN,KN,{name:!0});var HN=FN.prototype=xN(KN.prototype,{constructor:WN(1,FN),message:WN(1,""),name:WN(1,"AggregateError")});kN({global:!0,constructor:!0,arity:2},{AggregateError:FN});var JN,zN,jN,QN,BN=s,qN=ae,$N=f,eX=function(e){return qN.slice(0,e.length)===e},tX=eX("Bun/")?"BUN":eX("Cloudflare-Workers")?"CLOUDFLARE":eX("Deno/")?"DENO":eX("Node.js/")?"NODE":BN.Bun&&"string"==typeof Bun.version?"BUN":BN.Deno&&"object"==typeof Deno.version?"DENO":"process"===$N(BN.process)?"NODE":BN.window&&BN.document?"BROWSER":"REST",iX="NODE"===tX,oX=oe,sX=as,rX=Z,nX=pt("species"),aX=hr,dX=Ce,cX=TypeError,lX=si,uX=function(e){if(aX(e))return e;throw new cX(dX(e)+" is not a constructor")},hX=K,mX=pt("species"),pX=function(e,t){var i,o=lX(e).constructor;return void 0===o||hX(i=lX(o)[mX])?t:uX(i)},_X=/(?:ipad|iphone|ipod).*applewebkit/i.test(ae),bX=s,vX=u,SX=qt,yX=E,fX=et,gX=r,TX=Po,IX=Bo,RX=Lt,EX=MI,CX=_X,ZX=iX,LX=bX.setImmediate,PX=bX.clearImmediate,kX=bX.process,NX=bX.Dispatch,XX=bX.Function,VX=bX.MessageChannel,wX=bX.String,xX=0,GX={},WX="onreadystatechange";gX((function(){JN=bX.location}));var MX=function(e){if(fX(GX,e)){var t=GX[e];delete GX[e],t()}},AX=function(e){return function(){MX(e)}},OX=function(e){MX(e.data)},DX=function(e){bX.postMessage(wX(e),JN.protocol+"//"+JN.host)};LX&&PX||(LX=function(e){EX(arguments.length,1);var t=yX(e)?e:XX(e),i=IX(arguments,1);return GX[++xX]=function(){vX(t,void 0,i)},zN(xX),xX},PX=function(e){delete GX[e]},ZX?zN=function(e){kX.nextTick(AX(e))}:NX&&NX.now?zN=function(e){NX.now(AX(e))}:VX&&!CX?(QN=(jN=new VX).port2,jN.port1.onmessage=OX,zN=SX(QN.postMessage,QN)):bX.addEventListener&&yX(bX.postMessage)&&!bX.importScripts&&JN&&"file:"!==JN.protocol&&!gX(DX)?(zN=DX,bX.addEventListener("message",OX,!1)):zN=WX in RX("script")?function(e){TX.appendChild(RX("script"))[WX]=function(){TX.removeChild(this),MX(e)}}:function(e){setTimeout(AX(e),0)});var YX={set:LX,clear:PX},KX=function(){this.head=null,this.tail=null};KX.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var UX,FX,HX,JX,zX,jX=KX,QX=/ipad|iphone|ipod/i.test(ae)&&"undefined"!=typeof Pebble,BX=/web0s(?!.*chrome)/i.test(ae),qX=s,$X=_I,eV=qt,tV=YX.set,iV=jX,oV=_X,sV=QX,rV=BX,nV=iX,aV=qX.MutationObserver||qX.WebKitMutationObserver,dV=qX.document,cV=qX.process,lV=qX.Promise,uV=$X("queueMicrotask");if(!uV){var hV=new iV,mV=function(){var e,t;for(nV&&(e=cV.domain)&&e.exit();t=hV.get();)try{t()}catch(BW){throw hV.head&&UX(),BW}e&&e.enter()};oV||nV||rV||!aV||!dV?!sV&&lV&&lV.resolve?((JX=lV.resolve(void 0)).constructor=lV,zX=eV(JX.then,JX),UX=function(){zX(mV)}):nV?UX=function(){cV.nextTick(mV)}:(tV=eV(tV,qX),UX=function(){tV(mV)}):(FX=!0,HX=dV.createTextNode(""),new aV(mV).observe(HX,{characterData:!0}),UX=function(){HX.data=FX=!FX}),uV=function(e){hV.head||UX(),hV.add(e)}}var pV=uV,_V=function(e){try{return{error:!1,value:e()}}catch(BW){return{error:!0,value:BW}}},bV=s.Promise,vV=s,SV=bV,yV=E,fV=zt,gV=$s,TV=pt,IV=tX,RV=pe,EV=SV&&SV.prototype,CV=TV("species"),ZV=!1,LV=yV(vV.PromiseRejectionEvent),PV={CONSTRUCTOR:fV("Promise",(function(){var e=gV(SV),t=e!==String(SV);if(!t&&66===RV)return!0;if(!EV.catch||!EV.finally)return!0;if(!RV||RV<51||!/native code/.test(e)){var i=new SV((function(e){e(1)})),o=function(e){e((function(){}),(function(){}))};if((i.constructor={})[CV]=o,!(ZV=i.then((function(){}))instanceof o))return!0}return!(t||"BROWSER"!==IV&&"DENO"!==IV||LV)})),REJECTION_EVENT:LV,SUBCLASSING:ZV},kV={},NV=ke,XV=TypeError,VV=function(e){var t,i;this.promise=new e((function(e,o){if(void 0!==t||void 0!==i)throw new XV("Bad Promise constructor");t=e,i=o})),this.resolve=NV(t),this.reject=NV(i)};kV.f=function(e){return new VV(e)};var wV,xV,GV=ki,WV=iX,MV=s,AV=k,OV=rs,DV=Ns,YV=function(e){var t=oX(e);rX&&t&&!t[nX]&&sX(t,nX,{configurable:!0,get:function(){return this}})},KV=ke,UV=E,FV=B,HV=II,JV=pX,zV=YX.set,jV=pV,QV=function(e,t){try{1===arguments.length?console.error(e):console.error(e,t)}catch(BW){}},BV=_V,qV=jX,$V=Js,ew=bV,tw=PV,iw=kV,ow="Promise",sw=tw.CONSTRUCTOR,rw=tw.REJECTION_EVENT,nw=$V.getterFor(ow),aw=$V.set,dw=ew&&ew.prototype,cw=ew,lw=dw,uw=MV.TypeError,hw=MV.document,mw=MV.process,pw=iw.f,_w=pw,bw=!!(hw&&hw.createEvent&&MV.dispatchEvent),vw="unhandledrejection",Sw=function(e){var t;return!(!FV(e)||!UV(t=e.then))&&t},yw=function(e,t){var i,o,s,r=t.value,n=1===t.state,a=n?e.ok:e.fail,d=e.resolve,c=e.reject,l=e.domain;try{a?(n||(2===t.rejection&&Rw(t),t.rejection=1),!0===a?i=r:(l&&l.enter(),i=a(r),l&&(l.exit(),s=!0)),i===e.promise?c(new uw("Promise-chain cycle")):(o=Sw(i))?AV(o,i,d,c):d(i)):c(r)}catch(BW){l&&!s&&l.exit(),c(BW)}},fw=function(e,t){e.notified||(e.notified=!0,jV((function(){for(var i,o=e.reactions;i=o.get();)yw(i,e);e.notified=!1,t&&!e.rejection&&Tw(e)})))},gw=function(e,t,i){var o,s;bw?((o=hw.createEvent("Event")).promise=t,o.reason=i,o.initEvent(e,!1,!0),MV.dispatchEvent(o)):o={promise:t,reason:i},!rw&&(s=MV["on"+e])?s(o):e===vw&&QV("Unhandled promise rejection",i)},Tw=function(e){AV(zV,MV,(function(){var t,i=e.facade,o=e.value;if(Iw(e)&&(t=BV((function(){WV?mw.emit("unhandledRejection",o,i):gw(vw,i,o)})),e.rejection=WV||Iw(e)?2:1,t.error))throw t.value}))},Iw=function(e){return 1!==e.rejection&&!e.parent},Rw=function(e){AV(zV,MV,(function(){var t=e.facade;WV?mw.emit("rejectionHandled",t):gw("rejectionhandled",t,e.value)}))},Ew=function(e,t,i){return function(o){e(t,o,i)}},Cw=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,fw(e,!0))},Zw=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw new uw("Promise can't be resolved itself");var o=Sw(t);o?jV((function(){var i={done:!1};try{AV(o,t,Ew(Zw,i,e),Ew(Cw,i,e))}catch(BW){Cw(i,BW,e)}})):(e.value=t,e.state=1,fw(e,!1))}catch(BW){Cw({done:!1},BW,e)}}};sw&&(lw=(cw=function(e){HV(this,lw),KV(e),AV(wV,this);var t=nw(this);try{e(Ew(Zw,t),Ew(Cw,t))}catch(BW){Cw(t,BW)}}).prototype,(wV=function(e){aw(this,{type:ow,done:!1,notified:!1,parent:!1,reactions:new qV,rejection:!1,state:0,value:null})}).prototype=OV(lw,"then",(function(e,t){var i=nw(this),o=pw(JV(this,cw));return i.parent=!0,o.ok=!UV(e)||e,o.fail=UV(t)&&t,o.domain=WV?mw.domain:void 0,0===i.state?i.reactions.add(o):jV((function(){yw(o,i)})),o.promise})),xV=function(){var e=new wV,t=nw(e);this.promise=e,this.resolve=Ew(Zw,t),this.reject=Ew(Cw,t)},iw.f=pw=function(e){return e===cw||undefined===e?new xV(e):_w(e)}),GV({global:!0,constructor:!0,wrap:!0,forced:sw},{Promise:cw}),DV(cw,ow,!1,!0),YV(ow);var Lw=pt("iterator"),Pw=!1;try{var kw=0,Nw={next:function(){return{done:!!kw++}},return:function(){Pw=!0}};Nw[Lw]=function(){return this},Array.from(Nw,(function(){throw 2}))}catch(BW){}var Xw=bV,Vw=PV.CONSTRUCTOR||!function(e,t){try{if(!t&&!Pw)return!1}catch(BW){return!1}var i=!1;try{var o={};o[Lw]=function(){return{next:function(){return{done:i=!0}}}},e(o)}catch(BW){}return i}((function(e){Xw.all(e).then(void 0,(function(){}))})),ww=k,xw=ke,Gw=kV,Ww=_V,Mw=LN;ki({target:"Promise",stat:!0,forced:Vw},{all:function(e){var t=this,i=Gw.f(t),o=i.resolve,s=i.reject,r=Ww((function(){var i=xw(t.resolve),r=[],n=0,a=1;Mw(e,(function(e){var d=n++,c=!1;a++,ww(i,t,e).then((function(e){c||(c=!0,r[d]=e,--a||o(r))}),s)})),--a||o(r)}));return r.error&&s(r.value),i.promise}});var Aw=ki,Ow=PV.CONSTRUCTOR;bV&&bV.prototype,Aw({target:"Promise",proto:!0,forced:Ow,real:!0},{catch:function(e){return this.then(void 0,e)}});var Dw=k,Yw=ke,Kw=kV,Uw=_V,Fw=LN;ki({target:"Promise",stat:!0,forced:Vw},{race:function(e){var t=this,i=Kw.f(t),o=i.reject,s=Uw((function(){var s=Yw(t.resolve);Fw(e,(function(e){Dw(s,t,e).then(i.resolve,o)}))}));return s.error&&o(s.value),i.promise}});var Hw=kV;ki({target:"Promise",stat:!0,forced:PV.CONSTRUCTOR},{reject:function(e){var t=Hw.f(this);return(0,t.reject)(e),t.promise}});var Jw=si,zw=B,jw=kV,Qw=function(e,t){if(Jw(e),zw(t)&&t.constructor===e)return t;var i=jw.f(e);return(0,i.resolve)(t),i.promise},Bw=ki,qw=bV,$w=PV.CONSTRUCTOR,ex=Qw,tx=oe("Promise"),ix=!$w;Bw({target:"Promise",stat:!0,forced:true},{resolve:function(e){return ex(ix&&this===tx?qw:this,e)}});var ox=k,sx=ke,rx=kV,nx=_V,ax=LN;ki({target:"Promise",stat:!0,forced:Vw},{allSettled:function(e){var t=this,i=rx.f(t),o=i.resolve,s=i.reject,r=nx((function(){var i=sx(t.resolve),s=[],r=0,n=1;ax(e,(function(e){var a=r++,d=!1;n++,ox(i,t,e).then((function(e){d||(d=!0,s[a]={status:"fulfilled",value:e},--n||o(s))}),(function(e){d||(d=!0,s[a]={status:"rejected",reason:e},--n||o(s))}))})),--n||o(s)}));return r.error&&s(r.value),i.promise}});var dx=k,cx=ke,lx=oe,ux=kV,hx=_V,mx=LN,px="No one promise resolved";ki({target:"Promise",stat:!0,forced:Vw},{any:function(e){var t=this,i=lx("AggregateError"),o=ux.f(t),s=o.resolve,r=o.reject,n=hx((function(){var o=cx(t.resolve),n=[],a=0,d=1,c=!1;mx(e,(function(e){var l=a++,u=!1;d++,dx(o,t,e).then((function(e){u||c||(c=!0,s(e))}),(function(e){u||c||(u=!0,n[l]=e,--d||r(new i(n,px)))}))})),--d||r(new i(n,px))}));return n.error&&r(n.value),o.promise}});var _x=ki,bx=u,vx=Bo,Sx=kV,yx=ke,fx=_V,gx=s.Promise,Tx=!1;_x({target:"Promise",stat:!0,forced:!gx||!gx.try||fx((function(){gx.try((function(e){Tx=8===e}),8)})).error||!Tx},{try:function(e){var t=arguments.length>1?vx(arguments,1):[],i=Sx.f(this),o=fx((function(){return bx(yx(e),void 0,t)}));return(o.error?i.reject:i.resolve)(o.value),i.promise}});var Ix=kV;ki({target:"Promise",stat:!0},{withResolvers:function(){var e=Ix.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var Rx=ki,Ex=bV,Cx=r,Zx=oe,Lx=E,Px=pX,kx=Qw,Nx=Ex&&Ex.prototype;Rx({target:"Promise",proto:!0,real:!0,forced:!!Ex&&Cx((function(){Nx.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=Px(this,Zx("Promise")),i=Lx(e);return this.then(i?function(i){return kx(t,e()).then((function(){return i}))}:e,i?function(i){return kx(t,e()).then((function(){throw i}))}:e)}});var Xx=i(q.Promise);function Vx(e){function t(e){if(Object(e)!==e)return Xx.reject(new TypeError(e+" is not an object."));var t=e.done;return Xx.resolve(e.value).then((function(e){return{value:e,done:t}}))}return(Vx=function(e){this.s=e,this.n=e.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?Xx.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?Xx.reject(e):t(i.apply(this.s,arguments))}},new Vx(e)}class wx extends sT.EventEmitter{constructor(e,t){super(),Ou(this,"_context",void 0),Ou(this,"peerConnectionMode",0),Ou(this,"id",void 0),Ou(this,"_monitor",void 0),Ou(this,"logger",void 0),Ou(this,"_nextSsrc",Math.floor(Math.random()*Zk+1e4)),Ou(this,"_aSendonlyAnswerTpl",void 0),Ou(this,"_vSendonlyAnswerTpl",void 0),Ou(this,"_enableSubFlexfec",!1),Ou(this,"audioTrack4ff",void 0),Ou(this,"setLocalDescription",void 0),Ou(this,"setRemoteDescription",void 0),this.peer=t,this.id=e.id,this._monitor=Nv(this.id),this.logger=new eS("BasicHandler",3,e.id),this.setLocalDescription=t.setLocalDescription.bind(t),this.setRemoteDescription=t.setRemoteDescription.bind(t),this._context=e,this.peer.on("ontrack",(e=>{this.emit("ontrack",e)}))}destroy(){this.logger.info("destroy",this.peerConnectionId||""),super.removeAllListeners()}get _peerConnection(){return this.peer.getOriginRTCPeerConnection()}getTransceivers(){return this._peerConnection.getTransceivers()}getConnectionState(){return this._peerConnection.connectionState}internalPublish(e){const{stream:t,videoTrack:i,audioTrack:o,pubAudio:s,pubVideo:r}=e,n={direction:"sendonly",streams:[t]},a={direction:"sendonly",streams:[t]},{sendEncodings:d,videoDescriptions:c,subVideoDescriptions:l,activeSimulcastStreams:u}=this._context.videoProfile.genVideoDescriptions(e);a.sendEncodings=d,this._context.videoProfile.activeSimStreams=u,this.logger.info("publish videoTransceiverInit videoDescriptions","",a,c);let h=null==o?void 0:o.preprocessingTrack;(null==o?void 0:o.mixType)!==Nh.PLAYOUT&&null!=o&&o.mixedAudioTrack&&(h=null==o?void 0:o.mixedAudioTrack),h=s&&h?h:"audio";let m=null==i?void 0:i.preprocessingTrack;m=r&&m?m:"video";try{this._reportRtcInvokeStatus("Handler.internalPublish",JSON.stringify({aTrack:ym(h),vTrack:ym(m),audioTransceiverInit:n,videoTransceiverInit:a}))}catch(BW){}return{semantics:"unified-plan",videoDescriptions:c,subVideoDescriptions:l,audioTransceiverInit:{track:h,init:n},videoTransceiverInit:{track:m,init:a}}}async setCurrentDescription(){}createAVMlineAnswerTpl(e){const t=hk.parse(e);t.media.forEach((e=>{if("audio"===e.type){if("sendonly"===e.direction){const t=null==e?void 0:e.rtp.find((e=>"opus"===e.codec));if(t&&null!=e&&e.fmtp){const i=null==e?void 0:e.fmtp.find((e=>e.payload===t.payload));i&&this._context&&(i.config+=";stereo=1;sprop-stereo=1")}this._aSendonlyAnswerTpl=e}}else"video"===e.type&&("sendonly"===e.direction&&(this._vSendonlyAnswerTpl=e),Array.isArray(e.rtp)&&e.rtp.forEach((e=>{var t;null!==(t=e.codec)&&void 0!==t&&t.includes("flexfec")&&(this._enableSubFlexfec=!0)})))})),FT&&Mk(t)}get peerConnectionId(){return this.peer.getConnectionId()||""}addBitrateLimit(e,t){null==e||e.rtp.forEach((i=>{let{codec:o,payload:s}=i;if(["vp8","h264"].includes(o.toLocaleLowerCase())){const i=e.fmtp.find((e=>e.payload===s));i?i.config=[...i.config.split(";"),"x-google-min-bitrate=100","x-google-start-bitrate=".concat(t)].join(";"):e.fmtp.push({payload:s,config:"x-google-min-bitrate=100;x-google-start-bitrate=".concat(t)})}}))}_report(e,t,i){var o;null===(o=this._monitor)||void 0===o||o.report(e,Yu(Yu({},t),{},{connection_id:this.peer.getConnectionId(),group_connection_id:this.peer.getGroupConnectionId()}),i)}_reportRtcInvokeStatus(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",s=arguments.length>4?arguments[4]:void 0;this._report("rtc_invoke_status",{sdk_api_name:e,message:t,error_code:i,stream_id:o,elapse:0},s)}}const xx=new eS("queue",4);var Gx=(e=>(e[e.ADD=0]="ADD",e[e.CLOSE=1]="CLOSE",e))(Gx||{}),Wx=(e=>(e.publish="publish",e.unpublish="unpublish",e.subscribe="subscribe",e.unsubscribe="unsubscribe",e.pushtrack="pushtrack",e.removetrack="removetrack",e))(Wx||{});const Mx={publish:"unpublish",subscribe:"unsubscribe",pushtrack:"removetrack"},Ax={publish:0,subscribe:0,pushtrack:0,unpublish:1,unsubscribe:1,removetrack:1};class Ox extends rT{constructor(){super(),Ou(this,"_queue",void 0),this._queue=[]}get queue(){return this._queue}enqueue(e){const t=this._queue.length;let i="";return this._queue=this._queue.filter((t=>t.streamId!==e.streamId||e.action!==Mx[t.action]||(i=t.streamId,xx.info("offsetStreamId",i),!1))),this._queue.length===t&&this._queue.push(e),this.emit("start"),i}dequeue(){if(!this._queue.length)return null;let e=this._queue.length;nS&&VS>=86&&VS<=92&&(e=Math.min(this._queue.length,5));const t=Ax[this._queue[0].action];for(let i=1;i<e;i++)if(Ax[this._queue[i].action]!==t)return{sdpStrategy:t,items:this._queue.splice(0,i)};return{sdpStrategy:t,items:this._queue.splice(0,e)}}destroy(){this._queue=[]}}const Dx=DT()||OT();class Yx extends wx{constructor(e,t){super(e,t),Ou(this,"name","chrome"),Ou(this,"_queueBusy",!1),Ou(this,"_sdpQueue",void 0),Ou(this,"_aSendonlyOfferTpl",void 0),Ou(this,"_vSendonlyOfferTpl",void 0),Ou(this,"_aRecvonlyOfferTpl",void 0),Ou(this,"_vRecvonlyOfferTpl",void 0),Ou(this,"_mid",10),Ou(this,"_inactiveMlineIndex",[]),Ou(this,"setDescription",void 0),this.logger=new eS("ChromeHandler",3,e.id),this.setDescription=t.setDescription.bind(t),this._sdpQueue=new Ox,this._sdpQueue.on("start",(()=>{this._queueBusy||"stable"!==this._peerConnection.signalingState||(this.logger.info("dequeue start"),this.dequeue())}))}destroy(){super.destroy(),this._sdpQueue.destroy()}async publish(e){var t;const{stream:i,enableSimulcast:o}=e,{videoDescriptions:s,subVideoDescriptions:r,audioTransceiverInit:n,videoTransceiverInit:a}=super.internalPublish(e),d=Pk(this._nextSsrc);this._nextSsrc=d.next;const c="".concat(this._mid++),l="".concat(this._mid++),u=Yu(Yu(Yu({},this._aSendonlyOfferTpl),this.peer._offerIce),{},{mid:c,msid:"".concat(i.id," ").concat(i.id,"-audio"),ssrcs:kk(i.id,"audio",d.audio,Lk)}),h=Yu(Yu(Yu({},this._vSendonlyOfferTpl),this.peer._offerIce),{},{mid:l,msid:"".concat(i.id," ").concat(i.id,"-video")});if(o){this.logger.info("subVideoDesc","desc: %o ",r),delete h.ssrcGroups,delete h.ssrcs;const e=[];h.rids=s.map((t=>{let{rid:i}=t;return e.unshift(i),{id:i,direction:"send"}})),h.simulcast={dir1:"send",list1:e.join(";")}}else{const{ssrcs:e,ssrcGroups:t}=Nk(i.id,d,{cname:Lk});h.ssrcs=e,h.ssrcGroups=t}if(null!==(t=this._context.serverConfig)&&void 0!==t&&t.audioRed&&Array.isArray(u.rtp)){const e=u.rtp.findIndex((e=>"red"===e.codec));if(-1!==e){const[t]=u.rtp.splice(e,1);u.rtp.unshift(t)}const t=[];u.rtp.forEach((e=>t.push(e.payload))),u.payloads=t.join(" ")}Array.isArray(h.ext)&&(vy("IOS_SAFARI_ORIENTATION")||!rS&&!SS||(h.ext=h.ext.filter((e=>{var t;return!(null!=e&&null!==(t=e.uri)&&void 0!==t&&t.includes("video-orientation"))}))),h.ext=h.ext.filter((e=>{var t;return!(null!=e&&null!==(t=e.uri)&&void 0!==t&&t.includes("framemarking"))})));const m=null==u?void 0:u.rtp.find((e=>"opus"===e.codec));if(m&&u.fmtp){const e=u.fmtp.find((e=>e.payload===m.payload));e&&this._context.audioProfileManager&&(e.config=this._context.audioProfileManager.getOpusConfigStr(e.config))}return o||rS||this.addBitrateLimit(h,e.videoEncodeConfig[0].maxKbps),e.audioMLine=u,e.videoMLine=h,{partialSdp:Vk(this.peer._offerSession,u,h),audioMid:c,videoMid:l,type:"incroffer",semantics:"unified-plan",videoDescriptions:s,subVideoDescriptions:r,audioTransceiverInit:n,videoTransceiverInit:a,peerConnectionMode:this.peerConnectionMode}}async subscribe(e,t){var i,o;this.logger.info("subscribe");if(!this._aRecvonlyOfferTpl||!this._vRecvonlyOfferTpl){const e=await this._genOfferSdp();await this.createAVMlineOfferTpl(e)}let s,r,n,a,d="",c="",l=!1,u=!1;e.audioMLine=s,e.videoMLine=r,e.virtual?(d="".concat(this._mid++),l=!0):t.multiChatMode?(d="".concat(this._mid++),c="".concat(this._mid++),u=!0):(l=!0,u=!0,d="".concat(this._mid++),c="".concat(this._mid++)),d&&(s=Yu(Yu({},XP(this._aRecvonlyOfferTpl)),{},{mid:d})),l&&(e.audioMLine=s,n={track:"audio",init:{direction:"recvonly"}}),c&&(r=Yu(Yu({},XP(this._vRecvonlyOfferTpl)),{},{mid:c})),u&&(e.videoMLine=r,a={track:"video",init:{direction:"recvonly"}});const h=Vk(this.peer._offerSession,s,r);let m,p;if(!e.enableVendorMode&&!t.multiChatMode&&!e.virtual&&this._aSendonlyAnswerTpl&&this._vSendonlyAnswerTpl){var _;m=Pk(this._nextSsrc),this._nextSsrc=m.next;const t=Yu(Yu(Yu({},this._aSendonlyAnswerTpl),this.peer._answerIce),{},{mid:d,msid:"".concat(e.streamId).concat(this._context.avSync?"":"-audio"," ").concat(e.streamId,"-audio"),ssrcs:kk(e.streamId,"audio",m.audio)}),i=Yu(Yu(Yu({},this._vSendonlyAnswerTpl),this.peer._answerIce),{},{mid:c,msid:"".concat(e.streamId).concat(this._context.avSync?"":"-video"," ").concat(e.streamId,"-video")},Nk(e.streamId,m,{flexfec:this._enableSubFlexfec}));p={sdp:hk.write(Yu(Yu({},this.peer._answerSession),{},{media:[t,i]})),sequenceId:e.sequenceId?++e.sequenceId:0},null===(_=m)||void 0===_||delete _.next}const b=null===(i=s)||void 0===i?void 0:i.rtp.find((e=>"opus"===e.codec));if(b&&null!==(o=s)&&void 0!==o&&o.fmtp){var v;const e=null===(v=s)||void 0===v?void 0:v.fmtp.find((e=>e.payload===b.payload));e&&this._context&&(e.config+=";stereo=1;sprop-stereo=1")}if(e.isPublic&&VS>=86){var S,y;const e=null===(S=r)||void 0===S?void 0:S.rtp.filter((e=>"H264"===e.codec));var f;if(null!=e&&e.length&&null!==(y=r)&&void 0!==y&&y.fmtp)null===(f=r)||void 0===f||f.fmtp.forEach((t=>{e.find((e=>e.payload===t.payload))&&(t.config+=";sps-pps-idr-in-keyframe=1")}))}return{partialSdp:h,audioMid:d,videoMid:c,type:"incroffer",semantics:"unified-plan",audioTransceiverInit:n,videoTransceiverInit:a,allSsrc:m,peerConnectionMode:this.peerConnectionMode,signalingAck:p}}async handleAck(e){return this.logger.info("handleAck()","item: %o",e),this._sdpQueue.enqueue(e)}async dequeue(){this._queueBusy=!0;const e=this._sdpQueue.dequeue();if(this.logger.info("dequeue()","ret: %o",e),!e)return void(this._queueBusy=!1);const t=[];try{const{items:m,sdpStrategy:p}=e,_=[],b=[],v=[];if(p===Gx.ADD){delete Yu({},this.peer._answerIce).candidates;var i,o=!1,s=!1;try{for(var r,n=function(e){var t,i,o,s=2;for(void 0!==Su&&(i=Bk,o=Gu);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(o&&null!=(t=e[o]))return new Vx(t.call(e));i="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}(m);o=!(r=await n.next()).done;o=!1){const e=r.value;{var a;const{audioMid:i,videoMid:o,action:s,audioTransceiverInit:r,videoTransceiverInit:n,signalingAck:l,stream:u,videoCodec:h,onSuccess:m,onFail:p}=e,S=u instanceof pP;if(m&&v.push(m),p&&t.push(p),S&&l.sequenceId<u.sequenceId)break;const y=hk.parse(l.sdp);if(!Array.isArray(y.media))break;iT(a=y.media).call(a,((e,t)=>{var i;return null==e||null===(i=e.type)||void 0===i?void 0:i.localeCompare(null==t?void 0:t.type)}));const f=y.media.find((e=>"audio"===e.type)),g=y.media.find((e=>"video"===e.type));if(!f||!g)break;const T=Yu(Yu(Yu({},f),this.peer._answerIce),{},{mid:i}),I=Yu(Yu(Yu({},g),this.peer._answerIce),{},{mid:o}),{audioMLine:R,videoMLine:E,audioTransceiver:C,videoTransceiver:Z}=u;if(R){let e=this.peer._offerMlines.findIndex((e=>e.mid===i));var d;if(C){if(this._reportRtcInvokeStatus("chromeHandler.updateTrack",JSON.stringify({audioStreamTrack:ym(null===(d=u.audioTrack)||void 0===d?void 0:d.preprocessingTrack)})),-1===e){this.logger.error("dequeue","audio mid not found when update sdp, %s from %o",i,this.peer._offerMlines);continue}}else r&&R&&(u.audioTransceiver=this._peerConnection.addTransceiver(r.track,r.init),this._reportRtcInvokeStatus("chromeHandler.addTrack",JSON.stringify({audioStreamTrack:ym(r.track)})),e=this._inactiveMlineIndex.shift(),e||(e=this.peer._offerMlines.length),Dx&&u.initAudioEncodedTransform());s===Wx.publish&&"OPUS"!==vy("AUDIO_CODEC")&&(Gk(R,vy("AUDIO_CODEC")),Gk(T,vy("AUDIO_CODEC"))),this.peer._offerMlines[e]=Yu({},R),this.peer._answerMlines[e]=Yu({},T)}if(E){let e=this.peer._offerMlines.findIndex((e=>e.mid===o));var c;if(Z){if(this._reportRtcInvokeStatus("chromeHandler.updateTrack",JSON.stringify({audioStreamTrack:ym(null===(c=u.videoTrack)||void 0===c?void 0:c.preprocessingTrack)})),-1===e){this.logger.error("dequeue","video mid not found when update sdp, %s from %o",o,this.peer._offerMlines);continue}}else n&&E&&(u.videoTransceiver=this._peerConnection.addTransceiver(n.track,n.init),this._reportRtcInvokeStatus("chromeHandler.addTrack",JSON.stringify({videoStreamTrack:ym(n.track)})),e=this._inactiveMlineIndex.shift(),e||(e=this.peer._offerMlines.length),Dx&&u.initVideoEncodedTransform());this.peer._offerMlines[e]=Yu({},E),s===Wx.publish&&h&&(Wk(E,h),Wk(I,h)),this.peer._answerMlines[e]=I}_.push(u.streamId||""),b.push(S?u.userId:"local"),S&&(u.sequenceId=l.sequenceId)}}}catch(u){s=!0,i=u}finally{try{o&&null!=n.return&&await n.return()}finally{if(s)throw i}}}else{var l;const e={};m.forEach((t=>{const{audioMid:i,videoMid:o,action:s}=t;e[i]=i,s!==Wx.removetrack&&(e[o]=o),e[i]=i})),this.peer._offerMlines=this.peer._offerMlines.map(((t,i)=>(t.mid&&e[t.mid]&&(t=Xk(t),this._inactiveMlineIndex.push(i)),t))),iT(l=this._inactiveMlineIndex).call(l,((e,t)=>e-t)),this.peer._answerMlines=this.peer._answerMlines.map((t=>(t.mid&&e[t.mid]&&(t=Xk(t)),t)))}try{await this.setDescription(_.length?{streamId:_.join(","),streamUserId:b.join(",")}:void 0)}catch(h){throw"have-local-offer"===this._peerConnection.signalingState&&await this._peerConnection.setLocalDescription({type:"rollback"}),h}try{v.forEach((e=>e()))}catch(BW){}this.logger.info("dequeue","loop")}catch(u){this.logger.error("dequeue","unknown error: %o",u),t.forEach((e=>e(u)))}finally{this.dequeue()}}async getDefaultSdp(){const e=await this._genOfferSdp();this.createAVMlineOfferTpl(e);const t=hk.parse(e),i=[];return t.media=t.media.filter((e=>"recvonly"===e.direction&&(Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id"!==e.uri))),i.push("".concat(e.mid)),!0))),t.groups=[{mids:i.join(" "),type:"BUNDLE"}],FT&&Mk(t),{sdp:hk.write(t),semantics:"unified-plan",type:"incroffer"}}async rollback(e){let{stream:t}=e;delete t.audioMLine,delete t.videoMLine}createAVMlineOfferTpl(e){const t=hk.parse(e);t.media.forEach((e=>{"audio"===e.type?"sendonly"===e.direction?this._aSendonlyOfferTpl=e:(Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id"!==e.uri))),this._aRecvonlyOfferTpl=e):"video"===e.type&&("sendonly"===e.direction?this._vSendonlyOfferTpl=e:(Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id"!==e.uri))),this._vRecvonlyOfferTpl=e))})),FT&&Mk(t)}async _genOfferSdp(){let e;try{if(e=await async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(Dy)return Dy;const t=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});t.createDataChannel("default"),t.addTransceiver("audio",{direction:"recvonly"}),t.addTransceiver("video",{direction:"recvonly"}),e&&(t.addTransceiver("audio",{direction:"sendonly"}),t.addTransceiver("video",{direction:"sendonly"}));const i=await t.createOffer();return t.close(),Dy=i.sdp,i.sdp}(!0),e=Yk(e),!e)throw"pc.createOffer() return empty."}catch(t){const e="Get offer Error. ".concat(t.message|t);throw new HS(US.NOT_SUPPORTED,e)}return e}}class Kx extends wx{constructor(e,t){super(e,t),Ou(this,"name","firefox"),Ou(this,"_aRecvonlyOfferTpl",void 0),this.logger=new eS("FirefoxHandler",3,e.id)}async publish(e){var t,i;const{videoDescriptions:o,subVideoDescriptions:s,audioTransceiverInit:r,videoTransceiverInit:n}=super.internalPublish(e);e.audioTransceiver=this._peerConnection.addTransceiver(r.track,r.init),Array.isArray(n.init.sendEncodings)&&1===n.init.sendEncodings.length&&(n.init.sendEncodings=n.init.sendEncodings.map((e=>(delete e.rid,e)))),e.videoTransceiver=this._peerConnection.addTransceiver(n.track,n.init);const a=wy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:"",stream_user_id:"",pc_session_id:this.peerConnectionId,vendor_mode:0});const d=await this.peer.createOfferSdp();this._report("rtc_create_offer",{direction:"up",error_code:0,stream_id:"",stream_user_id:"",elapse:wy()-a});const c=hk.parse(d);c.media=null===(t=c.media)||void 0===t?void 0:t.map((e=>Yu(Yu({},e),this.peer._offerIce))),Mk(c),await this.setLocalDescription(hk.write(c));const l=e.audioTransceiver.mid,u=e.videoTransceiver.mid;let h=null,m=null;return c.media=null===(i=c.media)||void 0===i?void 0:i.map((e=>{if("".concat(e.mid)===l){var t;h=e;const o=null===(t=h)||void 0===t?void 0:t.rtp.find((e=>"opus"===e.codec));if(o&&h.fmtp){var i;const e=h.fmtp.find((e=>e.payload===o.payload));e&&null!==(i=this._context)&&void 0!==i&&i.audioProfileManager&&(e.config=this._context.audioProfileManager.getOpusConfigStr(e.config))}}else"".concat(e.mid)===u&&(m=e);return e})),this.addBitrateLimit(m,e.videoEncodeConfig[0].maxKbps),await this.setLocalDescription(hk.write(c)),e.initVideoEncodedTransform(),e.initAudioEncodedTransform(),{partialSdp:Vk(c,h,m),audioMid:l,videoMid:u,type:"incroffer",semantics:"unified-plan",videoDescriptions:o,subVideoDescriptions:s,audioTransceiverInit:r,videoTransceiverInit:n,peerConnectionMode:this.peerConnectionMode}}async _internalChangePubCodec(){const{localDescription:e}=this._peerConnection;e&&(await this.peer.createOfferSdp(),await this._peerConnection.setLocalDescription(e))}async subscribe(e,t){var i,o,s,r;this.logger.info("subscribe()");let n,a,d="",c="",l=!1,u=!1;e.virtual?l=!0:(t.multiChatMode||(l=!0),u=!0),l&&(e.audioTransceiver=this._peerConnection.addTransceiver("audio",{direction:"recvonly"})),u&&(e.videoTransceiver=this._peerConnection.addTransceiver("video",{direction:"recvonly"}));const h=wy();this._report("rtc_begin_create_offer",{direction:"up",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:this.peerConnectionId,vendor_mode:0});const m=await this.peer.createOfferSdp();this._report("rtc_create_offer",{error_code:0,direction:"up",stream_id:e.streamId,stream_user_id:e.userId,elapse:wy()-h});const p=hk.parse(m);let _,b;if(p.media=null===(i=p.media)||void 0===i?void 0:i.map((e=>Yu(Yu({},e),this.peer._offerIce))),p.media.map((e=>{var t,i,o,s;"video"===e.type&&(UT?(e.ext=null===(t=e.ext)||void 0===t?void 0:t.filter((e=>-1===e.uri.indexOf("abs-send-time"))),e.rtcpFb=null===(i=e.rtcpFb)||void 0===i?void 0:i.filter((e=>"goog-remb"!==e.type))):(e.rtcpFb=null===(o=e.rtcpFb)||void 0===o?void 0:o.filter((e=>"transport-cc"!==e.type)),e.ext=null===(s=e.ext)||void 0===s?void 0:s.filter((e=>-1===e.uri.indexOf("transport")))))})),FT&&Mk(p),await this.setLocalDescription(hk.write(p),{streamId:e.streamId||"",streamUserId:e.userId}),d=null===(o=e.audioTransceiver)||void 0===o?void 0:o.mid,c=null===(s=e.videoTransceiver)||void 0===s?void 0:s.mid,null===(r=p.media)||void 0===r||r.forEach((e=>{"".concat(e.mid)===d?n=e:"".concat(e.mid)===c&&(a=e)})),d&&n||(d="audio_".concat(c),n=Yu(Yu({},this._aRecvonlyOfferTpl),{},{mid:d})),e.audioMid=d,e.videoMid=c,!t.multiChatMode&&!e.virtual&&this._aSendonlyAnswerTpl&&this._aSendonlyAnswerTpl){var v,S,y;_=Pk(this._nextSsrc),this._nextSsrc=_.next;const t=Yu(Yu(Yu({},this._aSendonlyAnswerTpl),this.peer._answerIce),{},{mid:d,msid:"".concat(e.streamId).concat(null!==(v=this._context)&&void 0!==v&&v.avSync?"":"-audio"," ").concat(e.streamId,"-audio"),ssrcs:kk(e.streamId,"audio",_.audio)}),i=Yu(Yu(Yu({},this._vSendonlyAnswerTpl),this.peer._answerIce),{},{mid:c,msid:"".concat(e.streamId).concat(null!==(S=this._context)&&void 0!==S&&S.avSync?"":"-video"," ").concat(e.streamId,"-video")},Nk(e.streamId,_,{flexfec:this._enableSubFlexfec}));b={sdp:hk.write(Yu(Yu({},this.peer._answerSession),{},{media:[t,i]})),sequenceId:e.sequenceId?++e.sequenceId:0},null===(y=_)||void 0===y||delete y.next}return e.initVideoEncodedTransform(),e.initAudioEncodedTransform(),{partialSdp:Vk(p,n,a,!1),audioMid:d,videoMid:c,type:"incroffer",semantics:"unified-plan",audioTransceiverInit:e.audioTransceiver?{track:"audio",init:{direction:"recvonly"}}:void 0,videoTransceiverInit:e.videoTransceiver?{track:"video",init:{direction:"recvonly"}}:void 0,allSsrc:_,peerConnectionMode:this.peerConnectionMode,signalingAck:b}}async handleAck(e){const{stream:t,action:i}=e;if(i===Wx.removetrack)return"";if(i===Wx.unpublish||i===Wx.unsubscribe){try{await this.close(t),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return t.streamId||""}const{signalingAck:o,videoCodec:s}=e,r=hk.parse(o.sdp);try{await this._internalSetRemoteDescription(r.media,t,s),"function"==typeof e.onSuccess&&e.onSuccess()}catch(n){"function"==typeof e.onFail&&e.onFail(n)}return""}async _internalSetRemoteDescription(e,t,i){var o,s;const r={},n=hk.parse(null===(o=this._peerConnection.remoteDescription)||void 0===o?void 0:o.sdp);n.media.forEach((e=>{void 0!==e.mid&&(r[e.mid]=e)})),e.forEach((e=>{if("audio"===(e=Yu(Yu({},e),this.peer._answerIce)).type&&(t.audioMid?(e.mid=t.audioMid,r[t.audioMid]=e):r[e.mid]=e),"video"===e.type){if(t instanceof mP&&LS<=87){const t={};Array.isArray(e.rtp)&&(e.rtp=e.rtp.filter((e=>"rtx"!==e.codec||(t[e.payload]=e.payload,!1)))),"string"==typeof e.payloads&&(e.payloads=e.payloads.split(" ").filter((e=>!t[e])).join(" ")),Array.isArray(e.fmtp)&&(e.fmtp=e.fmtp.filter((e=>!t[e.payload]))),Array.isArray(e.rtcpFb)&&(e.fmtp=e.fmtp.filter((e=>!t[e.payload])))}i&&Wk(e,i),t.videoMid?(e.mid=t.videoMid,r[t.videoMid]=e):r[e.mid]=e}}));const a=hk.parse(null===(s=this._peerConnection.localDescription)||void 0===s?void 0:s.sdp),d=a.media.map((e=>{const t=r[e.mid];return"inactive"===e.direction?e:t}));n.groups=a.groups,n.media=d,n.media.map((e=>{var t,i,o,s;"video"===e.type&&(UT?(e.ext=null===(t=e.ext)||void 0===t?void 0:t.filter((e=>-1===e.uri.indexOf("abs-send-time"))),e.rtcpFb=null===(i=e.rtcpFb)||void 0===i?void 0:i.filter((e=>"goog-remb"!==e.type))):(e.rtcpFb=null===(o=e.rtcpFb)||void 0===o?void 0:o.filter((e=>"transport-cc"!==e.type)),e.ext=null===(s=e.ext)||void 0===s?void 0:s.filter((e=>-1===e.uri.indexOf("transport")))))})),FT&&Mk(n),await this.setRemoteDescription(hk.write(n))}async getDefaultSdp(){var e,t;const i=hk.parse(null===(e=this._peerConnection.localDescription)||void 0===e?void 0:e.sdp);this.createAVMlineOfferTpl(null===(t=this._peerConnection.localDescription)||void 0===t?void 0:t.sdp);const o=[];return i.media=i.media.filter((e=>"recvonly"===e.direction&&(e.mid=e.mid+1,o.push("".concat(e.mid)),!0))),FT&&Mk(i),i.groups=[{mids:o.join(" "),type:"BUNDLE"}],{sdp:hk.write(i),semantics:"unified-plan",type:"incroffer"}}async rollback(e){let{msid:t,stream:i,audioMid:o,videoMid:s}=e;return this.logger.warn("rollback()"),this.close(i,o,s)}async close(e,t,i){var o;this.logger.info("close()");const s=e.audioMid||t,r=e.videoMid||i,n={};e.audioTransceiver&&s&&(e.audioTransceiver.stop(),n[s]=s),e.videoTransceiver&&r&&(e.videoTransceiver.stop(),n[r]=r);const a=[],d=await this.peer.createOfferSdp(),c=hk.parse(d);c.media=c.media.map((e=>(n[e.mid]&&(e=Xk(e)),"inactive"!==e.direction&&a.push(e.mid),Yu(Yu({},e),this.peer._offerIce))));const l=hk.parse(null===(o=this._peerConnection.remoteDescription)||void 0===o?void 0:o.sdp),u={};l.media.forEach((e=>{void 0!==e.mid&&(u[e.mid]=e)})),l.media=c.media.map((e=>"inactive"===e.direction?e:u[e.mid])),c.groups&&l.groups&&(c.groups[0].mids=a.join(" "),l.groups[0].mids=a.join(" ")),await this.setLocalDescription(hk.write(c)),await this.setRemoteDescription(hk.write(l))}async setCurrentDescription(){await this.peer.createOfferSdp(),this._peerConnection.localDescription&&this._peerConnection.remoteDescription&&(await this._peerConnection.setLocalDescription(this._peerConnection.localDescription),await this._peerConnection.setRemoteDescription(this._peerConnection.remoteDescription))}createAVMlineOfferTpl(e){const t=hk.parse(e);t.media.forEach((e=>{"audio"===e.type&&(this._aRecvonlyOfferTpl=e)})),FT&&Mk(t)}}const Ux={[jk.ICE_FAILED]:ih.ICE_FAILED,[jk.DC_ERROR]:ih.ICE_FAILED,[jk.DC_CLOSE]:ih.ICE_FAILED,[jk.NODE_CHANGE]:ih.NODE_CHANGE,[jk.NOTIFY_RECONNECT]:ih.NOTIFY_RECONNECT,[jk.JOIN_TIMEOUT]:ih.JOIN_TIMEOUT};class Fx extends aT{constructor(e){super(),Ou(this,"_connectionManager",void 0),Ou(this,"_dataChannelSignal",void 0),Ou(this,"_state",void 0),Ou(this,"_connectionLostTimer",void 0),Ou(this,"_isReconnecting",!1),Ou(this,"logger",void 0),this._ctx=e,this.logger=new eS("SignalingManager",1,e.id),this.logger.info("constructor","invoke"),this._connectionManager=new Qk(e),this._addConnectorHandler()}connect(){return this.isConnected()?Promise.resolve():new Promise(((e,t)=>{this._connectionManager.once("connected",(()=>e())),this._connectionManager.once("disconnected",t),this._connectionManager.startup()}))}reconnect(e,t){this._connectionManager.reconnect(e,t)}sendSignaling(e,t,i,o){if(!this._dataChannelSignal)throw new HS(US.NOT_CONNECTED_YET,"signaling channel is not connected");return this._dataChannelSignal.sendSignaling(e,t,i,o)}sendP2PMessage(e,t){if(!this._dataChannelSignal)throw new HS(US.NOT_CONNECTED_YET,"signaling channel is not connected");return this._dataChannelSignal.sendP2PMessage(e,t)}destroy(){var e,t;this.logger.info("destroy()"),this._clearConnectionLostTimer(),this._connectionManager.shotdown(),null===(e=this._ctx.handler)||void 0===e||e.destroy(),this._ctx.handler=void 0,null===(t=this._dataChannelSignal)||void 0===t||t.destroy(),this._state&&this._setState(th.CONNECTION_STATE_DISCONNECTED),this.removeAllListeners()}isConnected(){return this._state===th.CONNECTION_STATE_CONNECTED||this._state===th.CONNECTION_STATE_RECONNECTED}isReconnecting(){return this._state===th.CONNECTION_STATE_CONNECTING||this._state===th.CONNECTION_STATE_RECONNECTING}_setState(e,t){if(this._state===e)return;this._state=e;const i={state:e};t&&(i.reason=Ux[t]||ih.ICE_FAILED),this.safeEmit(pT.ON_CONNECTION_STATE_CHANGE,i)}_addConnectorHandler(){var e=this;this._connectionManager.on("connected",(e=>{var t,i,o;this.logger.info("connectStateChange","connected"),this._clearConnectionLostTimer(),null===(t=this._dataChannelSignal)||void 0===t||t.destroy(),this._ctx.peerConnection=e.pc,this._ctx.handler=(i=this._ctx,o=e.pc,sS?new Kx(i,o):new Yx(i,o)),this._dataChannelSignal=e.signaling,this._addSignalEventHandler(),this._setState(this._isReconnecting?th.CONNECTION_STATE_RECONNECTED:th.CONNECTION_STATE_CONNECTED)})),this._connectionManager.on("disconnected",(e=>{this._clearConnectionLostTimer(),this._setState(th.CONNECTION_STATE_DISCONNECTED),this.logger.error("connectStateChange","disconnected. %o",e.message),this._isReconnecting&&this.safeEmit(pT.ON_RECONNECT_FAILED)})),this._connectionManager.on("connecting",(()=>{this._isReconnecting=!1,this._ctx.handler=void 0,this._setState(th.CONNECTION_STATE_CONNECTING),this.logger.info("connectStateChange","connecting")})),this._connectionManager.on("reconnecting",(e=>{this._setState(th.CONNECTION_STATE_DISCONNECTED,e),this._connectionLostTimer||(this._connectionLostTimer=setTimeout((()=>{this.safeEmit(pT.ON_CONNECTION_STATE_CHANGE,{state:th.CONNECTION_STATE_LOST})}),1e4)),this._isReconnecting=!0,this._ctx.handler=void 0,this._setState(th.CONNECTION_STATE_RECONNECTING,e),this.logger.warn("connectStateChange","reconnecting")})),this._connectionManager.on("connectWidthTcp",(()=>{this.safeEmit(pT.CONNECT_WITH_TCP)})),["__onGetIceConfigHook","__onIceConnectSuccessHook","__onConnectSuccessHook"].forEach((t=>{this._connectionManager.on(t,(function(){for(var i=arguments.length,o=new Array(i),s=0;s<i;s++)o[s]=arguments[s];return e.emit(t,...o)}))}))}_clearConnectionLostTimer(){this._connectionLostTimer&&(clearTimeout(this._connectionLostTimer),delete this._connectionLostTimer)}_addSignalEventHandler(){var e,t;[hT.ON_ADD_STREAM,hT.ON_ADD_STREAM_LIST,hT.ON_REMOVE_STREAM,hT.ON_REMOVE_STREAM_LIST,hT.USER_CONNECTION,hT.USER_CONNECTION_LIST,hT.USER_DISCONNECTION,hT.USER_DISCONNECTION_LIST,hT.ON_UPDATE_STREAM_ATTRIBUTES,hT.ON_UPDATE_ROOM_ATTRIBUTES,hT.ON_PUSH_TRACK,hT.ON_REMOVE_TRACK,hT.ON_CUSTOM_MESSAGE,hT.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM,hT.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM,hT.USER_MESSAGE_RECEIVED,hT.USER_BINARY_MESSAGE_RECEIVED,hT.POST_PROCESSING_MESSAGE,hT.ON_USER_TOKEN_WILL_EXPIRE,hT.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE,hT.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED,hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE,hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED,hT.STREAM_CONTROL_MESSAGE,hT.ENGINE_CONTROL_MESSAGE,hT.ON_UPDATE_USER_ATTRIBUTES,hT.ON_SPEAKER_CHANGE,hT.ON_STREAM_FAILED,hT.ON_FORWARD_DST_ROOM_USER_KICK,hT.ON_STREAM_PULL_STATE_CHANGED,hT.ON_STREAM_PUSHED_BY_OTHER,mT.RSCP,mT.RTT,mT.SSC].forEach((e=>{var t;null===(t=this._dataChannelSignal)||void 0===t||t.on(e,(t=>{this.safeEmit(e,t)}))})),null===(e=this._dataChannelSignal)||void 0===e||e.on(hT.NODE_CHANGE,(e=>{this._connectionManager.reconnectByNodeChange(e)})),null===(t=this._dataChannelSignal)||void 0===t||t.on(hT.ON_NOTIFY_RECONNECT,(()=>{this._connectionManager.reconnect(jk.NOTIFY_RECONNECT)}))}}var Hx=(e=>(e.NORMAL_USER="normalUser",e.SILENT_USER="silentUser",e))(Hx||{});const Jx=["preferCodecName"];class zx{constructor(e){Ou(this,"_captureDeviceId",void 0),Ou(this,"_contentHint",void 0),Ou(this,"_videoCaptureConf",Yu({},Ty)),Ou(this,"_mainPreferCodec",void 0),Ou(this,"_screenPreferCodec",void 0),Ou(this,"_remoteVideoConfig",new Map),Ou(this,"_remoteSimulcastStreamType",new Map),Ou(this,"_simulcastMode",Eh.VIDEO_ONLY_ONE),Ou(this,"_highVideoEncodeConf",sk(Ty)),Ou(this,"_midVideoEncodeConf",void 0),Ou(this,"_lowVideoEncodeConf",void 0),Ou(this,"_screenEncodeConfig",Iy),Ou(this,"_invalidVideoEncodeConf",void 0),Ou(this,"activeSimStreams",[]),Ou(this,"_logger",void 0),Ou(this,"_apiVersion",void 0),this._ctx=e,this._logger=new eS("EngineVideoProfile",1,e.id)}setCaptureDeviceId(e){this._captureDeviceId=e}setCaptureConfig(e){this._videoCaptureConf=Yu(Yu({},this._videoCaptureConf),e)}getCaptureConfig(e){e=e||this._captureDeviceId;const t=Yu({},this._videoCaptureConf);return"user"===e||"environment"===e||"left"===e||"right"===e?(delete t.deviceId,t.facingMode=e):e&&(!hS||SS?t.deviceId={exact:e}:delete t.deviceId),t}getContentHint(){return this._contentHint}getPreferCodec(e){return e?this._screenPreferCodec:this._mainPreferCodec}setRemoteUserVideoConfig(e,t){"object"==typeof t?this._remoteVideoConfig.set(e,t):this._remoteSimulcastStreamType.set(e,t)}getSubLayer(e,t){const i=this._remoteSimulcastStreamType.get(e.userId),o=this._remoteVideoConfig.get(e.userId);if(i){var s,r,n,a,d,c;const{videoDescriptions:t,subVideoDescriptions:o}=e.attributes||{},l=Array.isArray(o)?o:t;let u;return 1===l.length?u=0:2===l.length?u=i===Ch.VIDEO_STREAM_HIGH?0:1:l.length>=3&&(u={[Ch.VIDEO_STREAM_HIGH]:0,[Ch.VIDEO_STREAM_MID]:1,[Ch.VIDEO_STREAM_LOW]:2}[i]),{spatialLayer:null!==(s=null!==(r=u&&(null===(n=l[u])||void 0===n?void 0:n.video_index))&&void 0!==r?r:u)&&void 0!==s?s:0,spatialSubLayer:null!==(a=null!==(d=u&&(null===(c=l[u])||void 0===c?void 0:c.sub_index))&&void 0!==d?d:u)&&void 0!==a?a:-1}}return o?ok(o,e):t?ok(t,e):void 0}getSimulcastMode(){return this._simulcastMode}async setSimulcastMode(e,t){if(sS||mS||14===(null==kS?void 0:kS[0]))throw new HS(US.NOT_SUPPORTED,"Simulcast is not supported");if(this._simulcastMode!==e){if(null!=t&&t.hasPublished){var i,o;if(null!==(i=t.localStream)&&void 0!==i&&i.videoHasPublish||null!==(o=t.localStream)&&void 0!==o&&o.audioHasPublish)throw new HS(US.SET_SIMULCAST_FAILED,"Cannot change simulcast mode after publishing the video streams");this._logger.print("setSimulcastMode()","change simulcast mode and unpublish."),await t.unpublish()}this._simulcastMode=e,e!==Eh.VIDEO_ONLY_ONE&&this._autoGenerateSubVideoEncodeConfig()}}closeSimulcast(){this._simulcastMode=Eh.VIDEO_ONLY_ONE}async setVideoEncodeConfigPolyfill(e){if(Array.isArray(e)){dy(e);const[t,...i]=e;this.setVideoEncodeConfig(t),await this.setSubVideoEncodeConfig(Kh(i).call(i))}else this.setVideoEncodeConfig(e)}setVideoEncodeConfig(e){dy([e]);const t=this._midVideoEncodeConf||this._lowVideoEncodeConf;t&&rk(t)>=rk(e)?(this._logger.warn("setVideoEncodeConfig","smaller then substream"),this._invalidVideoEncodeConf=sk(e),e=t):delete this._invalidVideoEncodeConf;const i=Yu({},e),{preferCodecName:o}=i,s=Jb(i,Jx);ty(s),this._logger.print("setVideoEncodeConfig","update encode config",e),this._highVideoEncodeConf=sk(e),this._contentHint=s.contentHint,this._mainPreferCodec=o,this._logger.print("setVideoEncodeConfig","update capture config",s),this._videoCaptureConf=s}async setSubVideoEncodeConfig(e,t,i){if(this._logger.print("setSubVideoEncodeConfig","%o, published=%s",e,null==t?void 0:t.hasPublished),e&&e.length>0){dy(e),iT(e).call(e,((e,t)=>rk(e)-rk(t)));const r=this._invalidVideoEncodeConf||this._highVideoEncodeConf,n=e[e.length-1];if(rk(n)>=rk(r))throw new HS(US.SET_SIMULCAST_FAILED,"The resolution cannot exceed the mainstream");if(null!=t&&t.hasPublished&&e.length!==this._getSubLayers().length){var o,s;if(null!==(o=t.localStream)&&void 0!==o&&o.videoHasPublish||null!==(s=t.localStream)&&void 0!==s&&s.audioHasPublish)throw new HS(US.SET_SIMULCAST_FAILED,"Cannot change the number of substreams after publishing the video streams");await t.unpublish()}e.length>2&&(Wv(this._ctx.id,"simulcast_over_limit","setLocalSimulcastMode: You can set parameters for up to 2 streams"),zy("setLocalSimulcastMode: You can set parameters for up to 2 streams"));const[a,d]=e;a&&(nk(r,a),this._lowVideoEncodeConf=sk(a)),d&&(nk(r,d),this._midVideoEncodeConf=sk(d)),this._invalidVideoEncodeConf&&(this.setVideoEncodeConfig(this._invalidVideoEncodeConf),await(null==i?void 0:i.updateVideoCaptureConfig(this._ctx.videoProfile.getCaptureConfig())))}else this._autoGenerateSubVideoEncodeConfig()}genVideoDescriptions(e){var t;const i=[];let o=[];const s=[],r=[];let{width:n,height:a,frameRate:d,maxKbps:c}=this._highVideoEncodeConf;const l=null===(t=e.videoTrack)||void 0===t?void 0:t.preprocessingTrack;if(l){const e=null==l?void 0:l.getSettings();n=Math.floor(e.width),a=Math.floor(e.height),d=Math.floor(e.frameRate)}"number"!=typeof d&&(d=30),i.push({width:n,height:a,framerate:d,maxkbps:c,rid:"0"}),s.unshift({maxBitrate:1e3*c,rid:"0",maxFramerate:d});const{serverConfig:u}=this._ctx;if(!(e.isScreen||this._simulcastMode===Eh.VIDEO_ONLY_ONE||sS&&"VP8"!==(null==u?void 0:u.videoCodec))){const e=((e,t)=>{const i=tk.findIndex((i=>e*t>=i.totalPixels)),o=e*t;if(0===i)return tk[i].maxLayers;const s=tk[i-1].totalPixels;return(s-o)/(s-tk[i].totalPixels)<.1?tk[i-1].maxLayers:tk[i].maxLayers})(n,a);if(e>1){const t=this._getSubVideoEncodeConfig(e,{width:n,height:a});this._logger.info("simulcast() ","simulcastLayers: %o",t),r.push(!0),t.forEach(((e,t)=>{const o={maxBitrate:1e3*e.maxkbps,scaleResolutionDownBy:e.scaleResolutionDownBy,rid:"".concat(t+1),maxFramerate:e.frameRate};s.unshift(o),i.push({width:e.width,height:e.height,framerate:e.frameRate,maxkbps:e.maxkbps,rid:"".concat(t+1)}),r.push(!0)})),null!=u&&u.simulcastOnDemand&&(o=i.map(((e,t)=>Yu(Yu({},e),{},{video_index:t,sub_index:t}))))}}return null!=u&&u.e2eFeedback&&(o=i.map(((e,t)=>Yu(Yu({},e),{},{video_index:t,sub_index:t})))),{videoDescriptions:i,subVideoDescriptions:o,sendEncodings:s,activeSimulcastStreams:r}}getVideoEncodeConfig(){return[this._highVideoEncodeConf,this._midVideoEncodeConf,this._lowVideoEncodeConf].filter((e=>e))}setScreenEncodeConfig(e){this._screenEncodeConfig=e}getScreenEncodeConfig(){return this._screenEncodeConfig}checkSimulcastApiVersion(e){if(this._apiVersion){if(this._apiVersion!==e){const e="mixing old and new apis, please use ".concat("new"===this._apiVersion?"setLocalSimulcastMode/setRemoteSimulcastStreamType":"enableSimulcastMode/setRemoteVideoConfig"," instead.");throw Wv(this._ctx.id,"mixingOldAndNewApis",e),new HS(US.MIXING_OLD_AND_NEW_APIS,e)}}else this._apiVersion=e}destroy(){this._videoCaptureConf=Ty,this._highVideoEncodeConf=sk(Ty),delete this._invalidVideoEncodeConf,this._remoteVideoConfig.clear(),this._remoteSimulcastStreamType.clear()}_autoGenerateSubVideoEncodeConfig(){this._logger.print("_autoGenerateSubVideoEncodeConfig()","generate low stream.");const e=this._highVideoEncodeConf,t=jy(e.width),i=jy(e.height),o=Math.min(t,i)/90;this._lowVideoEncodeConf={width:Math.floor(t/o),height:Math.floor(i/o),maxKbps:100,frameRate:10}}_getSubLayers(){const e=[];return this._midVideoEncodeConf&&e.push(this._midVideoEncodeConf),this._lowVideoEncodeConf&&e.push(this._lowVideoEncodeConf),e}_getSubVideoEncodeConfig(e,t){return this._getSubLayers().slice(1-e).map((e=>{if(e.width>e.height&&t.width<t.height||e.width<e.height&&t.width>t.height){const t=e.width;e.width=e.height,e.height=t}const i=jy(e.width),o=jy(e.height),s=Math.max(t.width/i,t.height/o);return{width:Math.floor(t.width/s),height:Math.floor(t.height/s),scaleResolutionDownBy:s,frameRate:jy(e.frameRate)||15,maxkbps:e.maxKbps||600}}))}__autoResetVideoEncoderConfig(e){const t=gy(this.getVideoEncodeConfig(),e);t&&(this.setVideoEncodeConfigPolyfill(t),this._logger.print("autoResetVideoEncoderConfig() result",JSON.stringify(t)),Wv(this._ctx.id,"autoResetVideoEncoderConfig",JSON.stringify(t)))}}class jx{constructor(e){Ou(this,"_sendTimes",[]),Ou(this,"_bufferSizeLimit",void 0),Ou(this,"_totalSizeLimitPerSecond",void 0),Ou(this,"_limitModeInterval",void 0),Ou(this,"_limitModeQPS",void 0),Ou(this,"_interval",void 0),Ou(this,"_qps",void 0),this.setLimitMode(e)}setLimitMode(e){e===vT.LIMIT_MODE?(this._bufferSizeLimit=1,this._totalSizeLimitPerSecond=30720,this._limitModeInterval=1e3,this._limitModeQPS=60):(this._bufferSizeLimit=64,delete this._totalSizeLimitPerSecond,delete this._limitModeInterval,delete this._limitModeQPS)}setQPS(e,t){this._interval=e,this._qps=t}check(e){var t,i;const o=Date.now(),s=function(e){var t,i;let o,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64;if(!e||0===(null==e?void 0:e.byteLength))throw new HS(US.INVALID_PARAMS,"The message cannot be empty");if(e instanceof ArrayBuffer)o=e;else{if("string"!=typeof e)throw new HS(US.INVALID_PARAMS,"The message must be string or ArrayBuffer");o=Gy.str2ab(e)}if((null===(t=o)||void 0===t?void 0:t.byteLength)>1024*s)throw new HS(US.INVALID_PARAMS,"The message length must be less than ".concat(s,"KB"));return null!==(i=o.byteLength)&&void 0!==i?i:0}(e,this._bufferSizeLimit);if("number"==typeof this._totalSizeLimitPerSecond){if(this._sendTimes.reduce(((e,t)=>o-t.ts<1e3?e+t.size:e),0)+s>this._totalSizeLimitPerSecond)throw new HS(US.USER_MESSAGE_EXCEED_QPS,"user message exceed total size(".concat(this._totalSizeLimitPerSecond,")"))}const r=null!==(t=this._limitModeInterval)&&void 0!==t?t:this._interval,n=null!==(i=this._limitModeQPS)&&void 0!==i?i:this._qps;if("number"==typeof r&&"number"==typeof n)if(this._sendTimes.length<n)this._sendTimes.push({ts:o,size:s});else{if(o-this._sendTimes[0].ts<r)throw new HS(US.USER_MESSAGE_EXCEED_QPS,"user message exceed qps(".concat(n,")"));this._sendTimes.splice(0,1),this._sendTimes.push({ts:o,size:s})}}}var Qx=(e=>(e.RECONNECT="ice-reconnect",e.LEAVE="leave_room",e))(Qx||{});const Bx=vT.NORMAL_MODE;class qx{constructor(e,t,i){Ou(this,"engineDestroyed",!1),Ou(this,"avSync",!0),Ou(this,"callId",void 0),Ou(this,"streamRTT",{}),Ou(this,"useCloudProxy",!1),Ou(this,"videoProfile",void 0),Ou(this,"audioProfileManager",void 0),Ou(this,"extensionManager",void 0),Ou(this,"userPriority",new Map),Ou(this,"expectedIDC",void 0),Ou(this,"autoPlayPolicy",void 0),Ou(this,"joinRoomConfig",void 0),Ou(this,"signalingManager",void 0),Ou(this,"peerConnection",void 0),Ou(this,"pubSubLock",new GP("pubSubLock")),Ou(this,"visibility",!0),Ou(this,"rtsLimiter",{e2e:new jx(Bx),e2s:new jx(Bx),boradcast:new jx(Bx),conf:void 0,rtsMode:Bx}),Ou(this,"serverConfig",void 0),Ou(this,"mediaParams",void 0),Ou(this,"subscribeFallbackOption",void 0),Ou(this,"joinRoomParams",void 0),Ou(this,"isPreConnection",!1),Ou(this,"_handler",void 0),Ou(this,"monitor",void 0),Ou(this,"_businessId",void 0),Ou(this,"_userStreamConfig",new Map),Ou(this,"_localAudioTrackDumpConfig",{[qu.STREAM_INDEX_MAIN]:{callback:void 0,frameSize:void 0},[qu.STREAM_INDEX_SCREEN]:{callback:void 0,frameSize:void 0}}),Ou(this,"_remoteAudioTrackDumpConfig",{[qu.STREAM_INDEX_MAIN]:new Map,[qu.STREAM_INDEX_SCREEN]:new Map}),Ou(this,"_targetCodec",void 0),Ou(this,"_targetScreenCodec",void 0),Ou(this,"earMonitorSettings",{[qu.STREAM_INDEX_MAIN]:{position:Zh.NONE,volume:100},[qu.STREAM_INDEX_SCREEN]:{position:Zh.NONE,volume:100}}),Ou(this,"localVideoTrack",void 0),Ou(this,"localAudioTrack",void 0),Ou(this,"publicAudioVolume",new Map),this.id=e,this.appId=t,this.monitor=Nv(e),this.expectedIDC=null==i?void 0:i.expectedIDC,this.autoPlayPolicy=null==i?void 0:i.autoPlayPolicy,this.audioProfileManager=new ak(t),this.extensionManager=new vL(e),this.joinRoomConfig=new KS(e),this.signalingManager=new Fx(this),this.videoProfile=new zx(this)}set businessId(e){var t;this._businessId=e,null===(t=this.monitor)||void 0===t||t.set({rtc_business_id:e})}get businessId(){return this._businessId}set handler(e){var t;e&&this.resetPubSubLock("ice-reconnect"),null===(t=this._handler)||void 0===t||t.destroy(),this._handler=e}get handler(){return this._handler}get role(){return this.visibility?Hx.NORMAL_USER:Hx.SILENT_USER}set targetCodec(e){e&&[ZT.H264,ZT.VP8,ZT.ByteVC1].forEach((t=>{e.toLowerCase()===t.toLowerCase()&&(this._targetCodec=t)}))}set targetScreenCodec(e){e&&[ZT.H264,ZT.VP8,ZT.ByteVC1].forEach((t=>{e.toLowerCase()===t.toLowerCase()&&(this._targetScreenCodec=t)}))}get targetCodec(){return this._targetCodec}get targetScreenCodec(){return this._targetScreenCodec}resetPubSubLock(e){this.pubSubLock.closeReason=e,this.pubSubLock=new GP("pubSubLock")}setUserStreamConf(e,t,i){const o=this._userStreamConfig.get(e)||{},s=o[t]||{};o[t]=Yu(Yu({},s),i),this._userStreamConfig.set(e,o)}getRemoteMirrorType(e,t){var i;return!(null===(i=this._userStreamConfig.get(e))||void 0===i||null===(i=i[t])||void 0===i||!i.mirrorType)}get rtsMode(){return this.rtsLimiter.rtsMode}setRTSMode(e){this.rtsLimiter.e2e.setLimitMode(e),this.rtsLimiter.boradcast.setLimitMode(e),this.rtsLimiter.e2s.setLimitMode(e),this.rtsLimiter.rtsMode=e}setRtsQpsConf(e){this.rtsLimiter.e2e.setQPS(null==e?void 0:e.rts_qps_interval,null==e?void 0:e.rts_e2e_qps_value),this.rtsLimiter.boradcast.setQPS(null==e?void 0:e.rts_qps_interval,null==e?void 0:e.rts_broadcast_qps_value),this.rtsLimiter.e2s.setQPS(null==e?void 0:e.rts_qps_interval,null==e?void 0:e.rts_e2s_qps_value),this.rtsLimiter.conf=e}destroy(){this.engineDestroyed=!0,this.signalingManager.destroy(),this.userPriority.clear(),this.avSync=!0,this._localAudioTrackDumpConfig={[qu.STREAM_INDEX_MAIN]:{callback:void 0,frameSize:void 0},[qu.STREAM_INDEX_SCREEN]:{callback:void 0,frameSize:void 0}},this._remoteAudioTrackDumpConfig[qu.STREAM_INDEX_MAIN].clear(),this._remoteAudioTrackDumpConfig[qu.STREAM_INDEX_SCREEN].clear(),this.extensionManager.destroy(),this.earMonitorSettings={[qu.STREAM_INDEX_MAIN]:{position:Zh.NONE,volume:100},[qu.STREAM_INDEX_SCREEN]:{position:Zh.NONE,volume:100}},this.publicAudioVolume.clear()}}function $x(e,t,i){const o=i.value;return i.value=async function(){var e;const t=await this._ctx.pubSubLock.lock();"chrome"===(null===(e=this._ctx.handler)||void 0===e?void 0:e.name)&&t();try{const{closeReason:e}=this._ctx.pubSubLock;if(e)throw new HS(US.UNEXPECTED_ERROR,e);for(var i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return await o.apply(this,s)}finally{var n;"chrome"!==(null===(n=this._ctx.handler)||void 0===n?void 0:n.name)&&t()}},i}function eG(e,t,i){const o=i.value;return i.value=async function(){var e;if(null!==(e=this._room)&&void 0!==e&&e.config.isRTSOnlyRoom())throw new HS(US.NOT_ALLOWED_IN_RTS_ROOM,"Engine.".concat(t,"() is not allowed in RTS room"));for(var i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return await o.apply(this,s)},i}const tG=DT()||OT();class iG extends wx{constructor(e,t){super(e,t),Ou(this,"_peerConnectionId",Vy()),Ou(this,"peerConnectionMode",1),Ou(this,"name","vendor"),Ou(this,"direction","up"),Ou(this,"stream",void 0),t.on("ice_state",(e=>{this._report("rtc_ice_state",{pc_session_id:this.peerConnectionId,direction:this.direction,error_code:0,ice_state:e.toUpperCase(),message:"",peer_connection_id:this.peerConnectionId,stream_id:"",stream_user_id:""})})),t.on("disconnect",(()=>{this.emit("disconnect")}))}async publish(e){this._context.videoProfile.closeSimulcast(),this.stream=e;const{videoDescriptions:t,subVideoDescriptions:i,audioTransceiverInit:o,videoTransceiverInit:s}=super.internalPublish(e);e.audioTransceiver=this._peerConnection.addTransceiver(o.track,o.init),e.videoTransceiver=this._peerConnection.addTransceiver(s.track,s.init),tG&&(e.initAudioEncodedTransform(),e.initVideoEncodedTransform()),this._report("rtc_begin_create_offer",{direction:"up",stream_id:"",stream_user_id:"",pc_session_id:this.peerConnectionId,vendor_mode:(null==e?void 0:e.vendorCode)||0});const r=await this.peer.createOfferSdp(),n=wy(),a=hk.parse(r);Array.isArray(a.media)&&(a.media=a.media.map((e=>{if("video"===e.type)(rS||SS)&&Array.isArray(e.ext)&&(e.ext=e.ext.filter((e=>{var t;return!(null!=e&&null!==(t=e.uri)&&void 0!==t&&t.includes("video-orientation"))}))),rS||this.addBitrateLimit(e,this._context.videoProfile.getVideoEncodeConfig()[0].maxKbps);else if("audio"===e.type){const i=null==e?void 0:e.rtp.find((e=>"opus"===e.codec));if(i&&e.fmtp){var t;const o=e.fmtp.find((e=>e.payload===i.payload));o&&null!==(t=this._context)&&void 0!==t&&t.audioProfileManager&&(o.config=this._context.audioProfileManager.getOpusConfigStr(o.config))}}return e})));const d={type:"offer",sdp:hk.write(a)};try{await this._peerConnection.setLocalDescription(d),this._report("rtc_set_description",{error_code:0,message:d.sdp||"",is_local:"1",direction:"up",stream_id:"",stream_user_id:"",elapse:wy()-n},{type:"offer"})}catch(c){throw this._report("rtc_set_description",{error_code:-1,message:c.message+d.sdp,is_local:"1",direction:"up",stream_id:"",stream_user_id:"",elapse:wy()-n},{type:"offer"}),c}return{partialSdp:d.sdp||"",audioMid:"0",videoMid:"1",type:"offer",semantics:"unified-plan",videoDescriptions:t,subVideoDescriptions:i,audioTransceiverInit:o,videoTransceiverInit:s,peerConnectionMode:this.peerConnectionMode,peerConnectionId:this.peerConnectionId}}async subscribe(e){this.stream=e,this.direction="down",e.audioTransceiver=this._peerConnection.addTransceiver("audio",{direction:"recvonly"}),e.videoTransceiver=this._peerConnection.addTransceiver("video",{direction:"recvonly"}),tG&&(e.initAudioEncodedTransform(),e.initVideoEncodedTransform()),this._report("rtc_begin_create_offer",{direction:"down",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:this.peerConnectionId,vendor_mode:e.vendorCode||0});const t=await this.peer.createOfferSdp(),i=wy(),o=hk.parse(t);Array.isArray(o.media)&&(o.media=o.media.map((e=>{if("audio"===e.type){const t=null==e?void 0:e.rtp.find((e=>"opus"===e.codec));if(t&&null!=e&&e.fmtp){const i=null==e?void 0:e.fmtp.find((e=>e.payload===t.payload));i&&this._context&&(i.config+=";stereo=1;sprop-stereo=1")}}return e})));const s={type:"offer",sdp:hk.write(o)};try{await this._peerConnection.setLocalDescription(s),this._report("rtc_set_description",{error_code:0,message:s.sdp||"",is_local:"1",direction:"down",stream_id:e.streamId,stream_user_id:e.userId,elapse:wy()-i},{type:"offer"})}catch(r){throw this._report("rtc_set_description",{error_code:-1,message:r.message+s.sdp,is_local:"1",direction:"down",stream_id:e.streamId,stream_user_id:e.userId,elapse:wy()-i},{type:"offer"}),r}return{partialSdp:s.sdp||"",audioMid:"0",videoMid:"1",type:"offer",semantics:"unified-plan",peerConnectionMode:this.peerConnectionMode,peerConnectionId:this.peerConnectionId}}async handleAck(e){if(e.action===Wx.publish||e.action===Wx.subscribe){const{signalingAck:n,videoMid:a,videoCodec:d}=e,{sdp:c}=n,l=hk.parse(c);l.media=l.media.map((e=>(e.mid===a&&d&&Wk(e,d),e)));const u={sdp:hk.write(l),type:"answer"},h=wy();try{var t,i;await this._peerConnection.setRemoteDescription(u),this._report("rtc_set_description",{error_code:0,message:u.sdp||"",is_local:"1",direction:"down",stream_id:(null===(t=e.stream)||void 0===t?void 0:t.streamId)||"",stream_user_id:null===(i=e.stream)||void 0===i?void 0:i.userId,elapse:wy()-h},{type:"answer"})}catch(r){var o,s;throw this._report("rtc_set_description",{error_code:-1,message:r.message+u.sdp,is_local:"1",direction:"down",stream_id:(null===(o=e.stream)||void 0===o?void 0:o.streamId)||"",stream_user_id:null===(s=e.stream)||void 0===s?void 0:s.userId,elapse:wy()-h},{type:"offer"}),r}"function"==typeof e.onSuccess&&e.onSuccess()}else e.action!==Wx.unpublish&&e.action!==Wx.unsubscribe||this.destroy();return""}destroy(){this.peer.destroy(),super.destroy()}async getDefaultSdp(){return{sdp:"",type:"offer",semantics:""}}connect(){throw new Error("Method not implemented.")}async rollback(){try{this._peerConnection.close()}catch(e){}}get peerConnectionId(){return this._peerConnectionId}set peerConnectionId(e){this._peerConnectionId=e}}var oG=Object.defineProperty,sG=Object.getOwnPropertyDescriptor,rG=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?sG(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&oG(t,i,r),r};class nG extends aT{constructor(e,t){super(),Ou(this,"_logger",void 0),Ou(this,"_pubBackOff",new Map),this._ctx=e,this._roomConf=t,this._logger=new eS("RoomPublisher",2,e.id)}async hasPublished(e){return!!e.audioMid&&!!e.videoMid}async publish(e){return this._publish(e)}async _publish(e){var t,i,o,s,r,n,a,d,c,l;this._logger.info("publish()","localStream: %o",e);const{videoTrack:u}=e,{audioTrack:h}=e,m=wy();let p,{handler:_}=this._ctx;this._roomConf.vendorConfig.enableMultiVendor?[_,p]=await this._getVendorPubSdpInfo(e):p=await this._ctx.handler.publish(e),this.emit("_test_pub_sdpInfo_",p);const{audioMid:b,videoMid:v}=p;e.pubAttributes={localaudio:!!h,localvideo:!!u,videostream:e.pubVideo,audiostream:e.pubAudio,extvideo:(null==u?void 0:u.sourceType)===yT.EXTERNAL,extaudio:(null==h?void 0:h.sourceType)===yT.EXTERNAL,videoDescriptions:p.videoDescriptions,videoType:ST.NORMAL};const S={attributes:Yu({},e.pubAttributes),audio:!0,video:!0,screen:e.isScreen,audioMid:b,videoMid:v,sdpInfo:{msid:e.stream.id,type:p.type,sdp:p.partialSdp,semantics:p.semantics},peerConnectionMode:null===(t=p)||void 0===t?void 0:t.peerConnectionMode,supportMultiVendor:!0},y=!this._roomConf.vendorConfig.enableMultiVendor&&e.enableSimulcast&&(null===(i=this._ctx.serverConfig)||void 0===i?void 0:i.simulcastOnDemand)&&(null===(o=p.subVideoDescriptions)||void 0===o?void 0:o.length);let f;(y||null!==(s=this._ctx.serverConfig)&&void 0!==s&&s.e2eFeedback)&&(S.attributes.subVideoDescriptions=p.subVideoDescriptions),null!==(r=p)&&void 0!==r&&r.peerConnectionId&&(S.peerConnectionId=p.peerConnectionId);try{this.emit("_test_pub_body_",S),f=await this._ctx.signalingManager.sendSignaling("publish",S)}catch(C){var g;if(C instanceof Error?this._roomConf.report("rtc_publish_stat",{result:"fail",is_screen:"0",start:m,message:"".concat(C.name,": ").concat(C.message)}):C instanceof HS&&this._roomConf.report("rtc_publish_stat",{result:"fail",is_screen:"0",start:m,message:"".concat(C.code,": ").concat(C.message)}),await(null===(g=_)||void 0===g?void 0:g.rollback({msid:e.stream.id,stream:e,audioMid:b,videoMid:v})),C.code>=500&&C.code<600){this.emit("_test_pub_5xx_");const t=this._getPubBackOff(e.id);if(t.retryDuration<6e4)return this._logger.info("pubRetry",e.id,t.retryDuration),await new Promise((e=>setTimeout(e,t.interval))),t.retryDuration+=t.interval,t.interval=t.interval>4e3?8e3:2*t.interval,e.resetStream(),this.emit(_P.PUB_RETRY,{screen:e.isScreen}),this._publish(e);this._logger.info("pubRetry","end"),this._pubBackOff.delete(e.id)}else if(403===C.code)throw new HS(US.TOKEN_NO_PUBLISH_PERMISSION,C.message||"token no publish permission");throw C}var T,I;(this._roomConf.report("rtc_recv_answer",{error_code:0,answer_type:null===(n=f)||void 0===n?void 0:n.relayMessage.type,sequence_id:(null===(a=f)||void 0===a||null===(a=a.relayMessage)||void 0===a?void 0:a.sequenceId)||0,message:null===(d=f)||void 0===d||null===(d=d.relayMessage)||void 0===d?void 0:d.sdp,direction:"up",stream_id:"",stream_user_id:"",pc_session_id:(null===(c=_)||void 0===c?void 0:c.peerConnectionId)||""}),e.isScreen)?e.setVideoCaps(null===(T=f.relayMessage.content)||void 0===T?void 0:T.screenCaps):e.setVideoCaps(null===(I=f.relayMessage.content)||void 0===I?void 0:I.videoCaps);e.streamId=f.streamId;const R=await e.getSelectedCodec();e.currentVideoCodec=R;const E=new Promise(((t,i)=>{var o,s,r,n,a;null===(o=_)||void 0===o||o.handleAck({action:Wx.publish,streamId:f.streamId,audioMid:b,videoMid:v,audioTransceiverInit:null===(s=p)||void 0===s?void 0:s.audioTransceiverInit,videoTransceiverInit:null===(r=p)||void 0===r?void 0:r.videoTransceiverInit,signalingAck:{sdp:null===(n=f)||void 0===n||null===(n=n.relayMessage)||void 0===n?void 0:n.sdp,sequenceId:null===(a=f)||void 0===a||null===(a=a.relayMessage)||void 0===a?void 0:a.sequenceId},stream:e,videoCodec:R,onSuccess:()=>{this._logger.info("publish()","publish success"),t(0)},onFail:e=>{this._logger.info("publish()","publish fail"),i(e)}})}));!sS&&await E,this.emit("___afterHandleAckInPub"),(y&&this._ctx.videoProfile.getSimulcastMode()===Eh.VIDEO_ON_DEMAND||null!==(l=this._ctx.serverConfig)&&void 0!==l&&l.e2eFeedback)&&this.emit(mT.RSCP,[{StreamIds:[e.stream.id],Metadata:{VideoIndex:0}}],!0),e.videoMid=v,e.audioMid=b,e.subVideoDescriptions=p.subVideoDescriptions,e.remoteSdp=f.relayMessage.sdp,this._roomConf.report("rtc_publish_stat",{result:"success",is_screen:"0",start:m,message:"unknown"})}async updatePubTrack(e){this._logger.info("updatePubTrack()","localStream: %o",e);const{videoTrack:t,audioTrack:i,pubAudio:o,pubVideo:s}=e,r=e.vendorHandler||this._ctx.handler;let n=null==i?void 0:i.preprocessingTrack;const a=null==t?void 0:t.preprocessingTrack;var d,c;s&&a?(e.stopBlackFrame(),await(null===(d=e.videoTransceiver)||void 0===d?void 0:d.sender.replaceTrack(a)),this._updateVideoDescriptions(e)):await(null===(c=e.videoTransceiver)||void 0===c?void 0:c.sender.replaceTrack(null));if(o&&n){var l;const{mixType:t,mixedAudioTrack:o}=i;o&&t!==Nh.PLAYOUT&&n.enabled&&(n=o),await(null===(l=e.audioTransceiver)||void 0===l?void 0:l.sender.replaceTrack(n))}else{var u;await(null===(u=e.audioTransceiver)||void 0===u?void 0:u.sender.replaceTrack(null)),Wv(this._ctx.id,"MediaClient.updatePubTrack(audio)","null")}await this._updatePublishCodec(e),this.emit("___onAfterReplaceTrack");try{Wv(this._ctx.id,"MediaClient.updatePubTrack",JSON.stringify({audioStreamTrack:ym(n),videoStreamTrack:ym(a)}))}catch(BW){}const h={localaudio:!!i,localvideo:!!t,videostream:s,audiostream:o,extvideo:(null==t?void 0:t.sourceType)===yT.EXTERNAL,extaudio:(null==i?void 0:i.sourceType)===yT.EXTERNAL,videoType:t?ST.NORMAL:e.pubAttributes.videoType},m={};for(const[_,b]of Object.entries(h))b!==Reflect.get(e.pubAttributes,_)&&Reflect.set(m,_,b);if(!Object.keys(m).length)return;if(e.observer){const{observer:t}=e,{audiostream:i,videostream:o,localaudio:s,localvideo:r,extaudio:n,extvideo:a}=m;void 0!==r?void 0!==a?t.setPushVideo(a):t.setEnableVideo(r):void 0!==o&&t.setUnmuteVideo(o),void 0!==s?void 0!==n?t.setPushAudio(n):t.setEnableAudio(s):void 0!==i&&t.setUnmuteAudio(i)}e.pubAttributes=Yu(Yu({},e.pubAttributes),h),e.pubAttributes.videostream||e.stopBlackFrame();const p={roomId:this._roomConf.roomId,streamId:e.streamId,attributes:m};await this._ctx.signalingManager.sendSignaling("updateStreamAttributes",p),this.emit("___onAfterUpdateSignaling"),sS&&await(null==r?void 0:r.setCurrentDescription())}async _updatePublishCodec(e){this._logger.info("updatePublishCodec()","localStream: %o",e);const{audioMid:t,videoMid:i,remoteSdp:o,streamId:s,currentVideoCodec:r}=e,n=await e.getSelectedCodec();if(this._logger.info("updatePublishCodec()","selectedCodec: %o",n),n!==r){if(e.currentVideoCodec=n,t&&i&&s&&o){var a;if(sS&&this._ctx.handler instanceof Kx)await(null===(a=this._ctx.handler)||void 0===a?void 0:a._internalChangePubCodec());return new Promise(((r,a)=>{var d;null===(d=this._ctx.handler)||void 0===d||d.handleAck({action:Wx.publish,streamId:s,audioMid:t,videoMid:i,signalingAck:{sdp:o,sequenceId:-1},videoCodec:n,onSuccess:r,onFail:a,stream:e})}))}{const t=["audioMid","videoMid","streamId","remoteSdp"].filter((t=>!Reflect.get(e,t)));this._logger.warn("updatePublishCodec()","fast return, because params: %o",t)}}else this._logger.warn("updatePublishCodec()","selectedCodec is equal to currentVideoCodec")}async unpublish(e){this._logger.info("unpublish()","localStream: %o",e);const t={roomId:this._roomConf.roomId,initStreamId:e.initStreamId,streamId:e.streamId};this._ctx.signalingManager.sendSignaling("unpublish",t).catch((()=>{}));const i=e.vendorHandler||this._ctx.handler;e.stopBlackFrame(),await(null==i?void 0:i.handleAck({action:Wx.unpublish,audioMid:e.audioMid,videoMid:e.videoMid,stream:e,streamId:e.streamId}))}async updatePubBlackFrame(e){var t;const i=e.genBlackFrame();i&&(null===(t=e.videoTransceiver)||void 0===t||null===(t=t.sender)||void 0===t||t.replaceTrack(i),e.pubAttributes.videoType=ST.BLACK,this._ctx.signalingManager.sendSignaling("updateStreamAttributes",{roomId:this._roomConf.roomId,streamId:e.streamId,attributes:{videoType:ST.BLACK}}),e.on("black-frame-ended",(()=>{var t;null===(t=e.videoTransceiver)||void 0===t||null===(t=t.sender)||void 0===t||t.replaceTrack(null),e.pubAttributes.videoType=ST.NORMAL,this._ctx.signalingManager.sendSignaling("updateStreamAttributes",{roomId:this._roomConf.roomId,streamId:e.streamId,attributes:{videoType:ST.NORMAL}})})))}async cleanStream(e){return this._logger.info("cleanStream()","localStream: %o",e),null==e?void 0:e.clean()}async destroyStream(e){return this._logger.info("destroyStream()","localStream: %o",e),null==e?void 0:e.destroy()}destroy(e){e.forEach((e=>{e&&(this.unpublish(e).catch((()=>{})),this.destroyStream(e).catch((()=>{})))})),this._pubBackOff.clear(),super.removeAllListeners()}async _updateVideoDescriptions(e){var t;const i=this._ctx.videoProfile.genVideoDescriptions(e),o=e.pubAttributes.videoDescriptions;if(o.length!==i.videoDescriptions.length)return;const s={};if(o.find(((e,t)=>{if(e.framerate!==i.videoDescriptions[t].framerate||e.maxkbps!==i.videoDescriptions[t].maxkbps||e.width!==i.videoDescriptions[t].width||e.height!==i.videoDescriptions[t].height)return s.videoDescriptions=i.videoDescriptions,!0})),null===(t=e.subVideoDescriptions)||void 0===t||t.find(((e,t)=>{if(e.framerate!==i.subVideoDescriptions[t].framerate||e.maxkbps!==i.subVideoDescriptions[t].maxkbps||e.width!==i.subVideoDescriptions[t].width||e.height!==i.subVideoDescriptions[t].height)return s.subVideoDescriptions=i.subVideoDescriptions,!0})),Object.keys(s).length>0){var r;this._ctx.signalingManager.sendSignaling("updateStreamAttributes",{roomId:this._roomConf.roomId,streamId:e.streamId,attributes:s});const t=null===(r=e.videoTransceiver)||void 0===r||null===(r=r.sender)||void 0===r?void 0:r.getParameters();var n;if(Wv(this._ctx.id,"sender.getParameters",JSON.stringify(t),0,e.streamId),t&&Array.isArray(null==t?void 0:t.encodings))t.encodings=t.encodings.map(((e,t)=>(e.rid===i.sendEncodings[t].rid&&(e.maxBitrate=i.sendEncodings[t].maxBitrate,e.maxFramerate=i.sendEncodings[t].maxFramerate,e.scaleResolutionDownBy=i.sendEncodings[t].scaleResolutionDownBy),e))),this._logger.info("sender.setParameters()",JSON.stringify(t.encodings)),Wv(this._ctx.id,"sender.setParameters",JSON.stringify(t),0,e.streamId),null===(n=e.videoTransceiver)||void 0===n||n.sender.setParameters(t),Wv(this._ctx.id,"Handler.updateScaleResolutionDownBy",JSON.stringify(t.encodings))}}async _getVendorPubSdpInfo(e){const t=new zk(this._ctx,"");e.vendorHandler=new iG(this._ctx,t),e.pcSessionId&&(e.vendorHandler.peerConnectionId=e.pcSessionId);const i=await e.vendorHandler.publish(e),o=e.vendorHandler;return o.on("ice_state",(e=>{this.emit(pT.ON_VENDOR_CONNECTION_STATE_CHANGE,{state:{checking:th.CONNECTION_STATE_CONNECTING,connected:th.CONNECTION_STATE_CONNECTED,disconnected:th.CONNECTION_STATE_RECONNECTING}[e],userId:this._roomConf.userId})})),o.once("disconnect",(async()=>{var t;o.removeAllListeners(),"connected"===(null===(t=this._ctx.peerConnection)||void 0===t?void 0:t.getIceConnectionState())?(await this.unpublish(e),await this.publish(e),e.vendorHandler&&e.statsReport.setVar(e.vendorHandler)):this._logger.info("vendor ice failed",e.streamId)})),[o,i]}_getPubBackOff(e){return this._pubBackOff.has(e)||this._pubBackOff.set(e,{interval:1e3,retryDuration:0}),this._pubBackOff.get(e)}}rG([QP],nG.prototype,"hasPublished",1),rG([QP,$x,jP],nG.prototype,"publish",1),rG([QP,$x,jP],nG.prototype,"updatePubTrack",1),rG([QP,$x,jP],nG.prototype,"unpublish",1),rG([QP,jP],nG.prototype,"updatePubBlackFrame",1),rG([QP],nG.prototype,"cleanStream",1),rG([QP],nG.prototype,"destroyStream",1),rG([jP],nG.prototype,"_updateVideoDescriptions",1);var aG=Object.defineProperty,dG=Object.getOwnPropertyDescriptor,cG=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?dG(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&aG(t,i,r),r};class lG extends aT{constructor(e,t){super(),Ou(this,"_logger",void 0),Ou(this,"_subBackOff",new Map),Ou(this,"_subResolves",{}),Ou(this,"_ontrackCallbackMap",new Map),this._ctx=e,this._roomConf=t,this._logger=new eS("RoomSubscriber",2,e.id)}async hasSubscribed(e){return e.streamState===hP.SUB_ED}async subscribe(e,t,i){if(e.streamState!==hP.SUB_ED)return this._subscribe(e,t,i);this._logger.warn("subscribe()","remoteStream ".concat(e.streamId," has been subscribed, silently return"))}async _subscribe(e,t,i){var o,s,r,n,a,d,c,l,u,h,m,p,_,b;this._logger.info("subscribe()","mediaType: %o",t),zP("subscribe()",e,this._logger),e.streamState=hP.SUB_ING;let v=!1,S=!1;if(Ky(t)&&(S=!0),Uy(t)&&(v=!0),!v&&this._roomConf.isMultiChatMode())return void(e.streamState=hP.INIT);const y=wy(),f=e.subVideo,g=[];this._subResolves[e.streamId]||(this._subResolves[e.streamId]=[]),g.push(new Promise(((t,i)=>{this._subResolves[e.streamId].push(t);const o=setTimeout((()=>i(new HS(US.TIME_OUT,"wait video timeout for userId: ".concat(e.userId)))),JP),s=i=>{"video"===i.mediaType&&(this._logger.info("remoteStream ".concat(e.userId," received video track")),e.off("ontrack",s),clearTimeout(o),t(0))};e.on("ontrack",s)}))),this._roomConf.isMultiChatMode()||g.push(new Promise(((t,i)=>{this._subResolves[e.streamId].push(t);const o=setTimeout((()=>i(new HS(US.TIME_OUT,"wait audio timeout for userId: ".concat(e.userId)))),JP),s=i=>{"audio"===i.mediaType&&(this._logger.info("remoteStream ".concat(e.userId," received audio track")),e.off("ontrack",s),clearTimeout(o),t(0))};e.on("ontrack",s)})));const T=t=>{e.ontrack(t)};null===(o=this._ctx.handler)||void 0===o||o.on("ontrack",T),this._ontrackCallbackMap.set(e,T);let I,{handler:R}=this._ctx;null!==(s=this._ctx.serverConfig)&&void 0!==s&&s.forceUniHandler||!e.enableVendorMode?I=await this._ctx.handler.subscribe(e,{multiChatMode:this._roomConf.isMultiChatMode()}):[R,I]=await this._getVendorSubSdpInfo(e,T);const{audioMid:E,videoMid:C}=I;e.subVideo=v;const Z={spatialLayer:(null==i?void 0:i.spatialLayer)||0,temporalLayer:0,spatialSubLayer:(null==i?void 0:i.spatialSubLayer)||-1},L={audio:!this._roomConf.isMultiChatMode(),video:!0,data:!0,screen:e.isScreen,browser:"chrome-stable",videoMid:C,audioMid:E,sdpInfo:{sdp:null===(r=I)||void 0===r?void 0:r.partialSdp,semantics:null===(n=I)||void 0===n?void 0:n.semantics,type:null===(a=I)||void 0===a?void 0:a.type},streamUserId:e.userId,streamId:e.streamId,config:{enableMediaType:{audio:!!this._roomConf.isMultiChatMode()||S,video:v},qualityLayer:Z},extra:{enableSendRTT:!0},peerConnectionMode:null===(d=I)||void 0===d?void 0:d.peerConnectionMode,supportMultiVendor:!0};null!==(c=I)&&void 0!==c&&c.peerConnectionId&&(L.peerConnectionId=I.peerConnectionId);const{subscribeFallbackOption:P,userPriority:k}=this._ctx;"number"==typeof P&&(L.config.fallbackOption=P),k.has(e.userId)&&(L.config.priority=k.get(e.userId)),null!==(l=I)&&void 0!==l&&l.allSsrc&&(L.extra.subscribeSSRC=I.allSsrc);const{signalingAck:N,audioTransceiverInit:X,videoTransceiverInit:V}=I;let w;N&&(e.videoMid=C,e.audioMid=E,await new Promise(((t,i)=>{var o;null===(o=R)||void 0===o||o.handleAck({action:Wx.subscribe,streamId:e.streamId,audioMid:E,videoMid:C,audioTransceiverInit:X,videoTransceiverInit:V,signalingAck:N,stream:e,onSuccess:()=>{this._logger.info("ssrc","success"),t(0)},onFail:e=>{this._logger.info("ssrc","fail",e),i(e)}})})));try{this.emit("_test_sub_body_",L);const e=this._ctx.signalingManager.sendSignaling("subscribe",L);this.emit("_test_during_signaling_",L),w=await e}catch(Y){var x;if(e.streamState=hP.INIT,Y instanceof Error&&this._roomConf.report("rtc_subscribe_stat",{result:"fail",start:y,message:Y.message,stream_user_id:e.userId}),Y.code>=500&&Y.code<600){this.emit("_test_sub_5xx_");const o=this._getSubBackOff(e.streamId);var G;if(o.retryDuration<6e4)return this._logger.info("subRetry",e.streamId,o.retryDuration),await new Promise((e=>setTimeout(e,o.interval))),o.retryDuration+=o.interval,o.interval=o.interval>4e3?8e3:2*o.interval,this.emit(_P.SUB_RETRY,{screen:e.isScreen,userId:e.userId}),await(null===(G=R)||void 0===G?void 0:G.handleAck({action:Wx.unsubscribe,streamId:e.streamId,audioMid:E,videoMid:C,stream:e})),e.resetStream(),this._subscribe(e,t,i);this._logger.info("subRetry","end",e.streamId),this._subBackOff.delete(e.streamId)}e.subVideo=f,await(null===(x=R)||void 0===x?void 0:x.rollback({msid:e.streamId,stream:e}));const o={roomId:this._roomConf.roomId,streamId:e.streamId,userId:e.userId};if(await this._ctx.signalingManager.sendSignaling("unsubscribe",o).catch((()=>{})),e.streamState=hP.INIT,403===Y.code)throw new HS(US.TOKEN_NO_SUBSCRIBE_PERMISSION,Y.message||"token no subscribe permission");throw Y}if(!w.relayMessage)throw this._roomConf.report("rtc_error",{error_code:-1009,message:"relayMessage is null"}),new HS(US.UNEXPECTED_ERROR,"unable to subscribe");const{audioMid:W,videoMid:M}=null!==(u=null===(h=w)||void 0===h?void 0:h.relayMessage)&&void 0!==u?u:{},A={[E]:W,[C]:M};this._logger.info("sub midmap",e.userId,A),e.videoMid=C,e.audioMid=E,e.subMediaType=t,e.streamState=hP.SUB_ED,e.subLayer=Z,this._roomConf.report("rtc_recv_answer",{error_code:0,answer_type:null===(m=w)||void 0===m||null===(m=m.relayMessage)||void 0===m?void 0:m.type,sequence_id:(null===(p=w)||void 0===p||null===(p=p.relayMessage)||void 0===p?void 0:p.sequenceId)||0,message:null===(_=w)||void 0===_||null===(_=_.relayMessage)||void 0===_?void 0:_.sdp,direction:"down",stream_id:e.streamId,stream_user_id:e.userId,pc_session_id:(null===(b=R)||void 0===b?void 0:b.peerConnectionId)||""});try{var O;null!==(O=I)&&void 0!==O&&O.signalingAck||await new Promise(((t,i)=>{var o,s,r,n,a;null===(o=R)||void 0===o||o.handleAck({action:Wx.subscribe,streamId:e.streamId,audioMid:E,videoMid:C,audioTransceiverInit:null===(s=I)||void 0===s?void 0:s.audioTransceiverInit,videoTransceiverInit:null===(r=I)||void 0===r?void 0:r.videoTransceiverInit,signalingAck:{sdp:null===(n=w)||void 0===n||null===(n=n.relayMessage)||void 0===n?void 0:n.sdp,sequenceId:null===(a=w)||void 0===a||null===(a=a.relayMessage)||void 0===a?void 0:a.sequenceId},stream:e,onSuccess:()=>{this._logger.info("sub ack","success"),t(0)},onFail:e=>{this._logger.info("sub ack","fail",e),i(e)}})})),await Promise.all(g)}catch(Y){var D;Y instanceof Error&&this._roomConf.report("rtc_subscribe_stat",{result:"fail",start:y,message:Y.message,stream_user_id:e.userId});const t={roomId:this._roomConf.roomId,streamId:e.streamId,userId:e.userId};throw await this._ctx.signalingManager.sendSignaling("unsubscribe",t).catch((()=>{})),await(null===(D=R)||void 0===D?void 0:D.handleAck({action:Wx.unsubscribe,streamId:e.streamId,audioMid:E,videoMid:C,stream:e})),e.streamState=hP.INIT,e.resetStream(),Y}this._roomConf.isMultiChatMode()||(e.subAudio=S),this._roomConf.report("rtc_subscribe_stat",{result:"success",start:y,message:"unknown",stream_user_id:e.userId}),e.startReport((e=>this.emit("onRemoteStreamStats",e)),R)}async unsubscribe(e){var t,i;zP("unsubscribe()",e,this._logger);const o={roomId:this._roomConf.roomId,streamId:e.streamId,userId:e.userId},s=e.vendorHandler||this._ctx.handler;this._ctx.signalingManager.sendSignaling("unsubscribe",o).catch((()=>{})),e.streamState=hP.INIT,e.subVideo=!1,null===(t=e.observer)||void 0===t||t.setSubscribeVideo(!1),!this._roomConf.isMultiChatMode()&&(null===(i=e.observer)||void 0===i||i.setSubscribeAudio(!1));const r=await(null==s?void 0:s.handleAck({action:Wx.unsubscribe,streamId:e.streamId,audioMid:e.audioMid,videoMid:e.videoMid,stream:e}));this._subResolves[r]&&this._subResolves[r].forEach((e=>e(0))),this._logger.info("unsubscribe","clean unsub ".concat(e.userId)),e.clean(),e.subMediaType=ly.NONE,this._removeOnTrackListener(e),e.statsReport.unsubscribe()}async unsubscribe4removeTrack(e,t,i){var o,s,r,n;if(zP("unsubscribe4removeTrack()",e,this._logger),this._logger.info("unsubscribe4removeTrack()","sequenceId: ",t.sequenceId,"trackType: ",i),t.sequenceId<e.sequenceId)return void this._logger.warn("unsubscribe4removeTrack()","sequenceId return");const a=i+1,d=!!(a&$u.AUDIO),c=!!(a&$u.VIDEO);await(null===(o=this._ctx.handler)||void 0===o?void 0:o.handleAck({action:Wx.removetrack,streamId:e.streamId,audioMid:e.audioMid,videoMid:e.videoMid,stream:e})),null===(s=e.observer)||void 0===s||s.setPushTrack(!1),null===(r=e.observer)||void 0===r||r.setUnmuteAudio(!d),e.subAudio=!d,null===(n=e.observer)||void 0===n||n.setUnmuteVideo(!c),e.subVideo=!c,e.subMediaType=e.subMediaType-(e.subMediaType&a),e.virtual&&(e.clean(),e.resetHasSubscribed(),e.statsReport.unsubscribe())}async handleRemoveStream(e){if(zP("handleRemoveStream()",e,this._logger),e.subVideo=!1,e.streamState!==hP.INIT)return this.unsubscribe(e)}_removeOnTrackListener(e){const t=this._ontrackCallbackMap.get(e);if(t){const i=e.vendorHandler||this._ctx.handler;null==i||i.off("ontrack",t),this._ontrackCallbackMap.delete(e)}}async _getVendorSubSdpInfo(e,t){const i=new zk(this._ctx,"");e.vendorHandler=new iG(this._ctx,i),e.pcSessionId&&(e.vendorHandler.peerConnectionId=e.pcSessionId);const o=e.vendorHandler;o.on("ontrack",t);const s=await e.vendorHandler.subscribe(e);return o.on("ice_state",(t=>{this.emit(pT.ON_VENDOR_CONNECTION_STATE_CHANGE,{state:{checking:th.CONNECTION_STATE_CONNECTING,connected:th.CONNECTION_STATE_CONNECTED,disconnected:th.CONNECTION_STATE_RECONNECTING}[t],userId:e.userId})})),o.once("disconnect",(async()=>{var t;if(null==o||o.removeAllListeners(),"connected"!==(null===(t=this._ctx.peerConnection)||void 0===t?void 0:t.getIceConnectionState()))return void this._logger.info("vendor ice failed",e.streamId);const i=e.subMediaType;await this.unsubscribe(e),await this.subscribe(e,i),e.vendorHandler&&e.statsReport.setVar(e.vendorHandler),this.emit(_P.RESUBSCRIBE,{stream:e})})),[o,s]}async subscribe4pushTrack(e,t){var i,o,s;this._logger.info("subscribe4pushTrack()","streamInfo: %o",t),zP("subscribe4pushTrack()",e,this._logger),e.subAudio=!0;const r=await(null===(i=this._ctx.handler)||void 0===i?void 0:i.subscribe(e,{multiChatMode:this._roomConf.isMultiChatMode()}));if(!r)throw new HS(US.ADD_TRANSCEIVER_FAILED,"add transceiver failed");const{audioMid:n}=r,{videoMid:a}=r,d=[];d.push(new Promise(((t,i)=>{const o=setTimeout((()=>i(new HS(US.TIME_OUT,"wait audio timeout for userId: ".concat(e.userId)))),JP),s=i=>{"audio"===i.mediaType&&(this._logger.success("remoteStream ".concat(e.userId," received audio track")),e.off("ontrack",s),clearTimeout(o),t(0))};e.on("ontrack",s)})));const c=t=>{e.ontrack(t)};null===(o=this._ctx.handler)||void 0===o||o.on("ontrack",c),this._ontrackCallbackMap.set(e,c),await(null===(s=this._ctx.handler)||void 0===s?void 0:s.handleAck({action:Wx.pushtrack,streamId:e.streamId,audioMid:n,videoMid:a,stream:e,audioTransceiverInit:null==r?void 0:r.audioTransceiverInit,videoTransceiverInit:null==r?void 0:r.videoTransceiverInit,signalingAck:null==t?void 0:t.message})),await Promise.all(d),e.videoMid=a,e.audioMid=n,e.startReport((e=>this.emit("onRemoteStreamStats",e)),this._ctx.handler)}async updateUserAttributes(e){this._logger.info("updateUserAttributes()","attributes: %o",e),await this._ctx.signalingManager.sendSignaling("updateUserAttributes",{roomId:this._roomConf.roomId,sessionId:this._roomConf.sessionId,attributes:e})}async updateSubTrackLayer(e,t){if(this._logger.info("updateSubTrack()","subLayer: %o",t),e.subLayer.spatialLayer===t.spatialLayer&&e.subLayer.spatialSubLayer===t.spatialSubLayer)return void this._logger.warn("updateSubTrack()","subLayer no change");const i={roomId:this._roomConf.roomId,streamList:[e.streamId],streamId:e.streamId,streamUserId:e.userId,config:{qualityLayer:t}};return await this._ctx.signalingManager.sendSignaling("updateSubscribe",i),this.emit("___afterUpdateSubscribeSend"),e.subLayer=t,e}async updateSubPriority(e,t){if(this._logger.info("updateSubPriority()","priority: %o",t),e.priority===t)return this._logger.warn("updateSubPriority()","priority no change"),e;const i={roomId:this._roomConf.roomId,streamList:[e.streamId],streamId:e.streamId,streamUserId:e.userId,config:{priority:t}};return await this._ctx.signalingManager.sendSignaling("updateSubscribe",i),e.priority=t,e}async updateSubMediaType(e,t){var i;let o=!1,s=!1;Ky(t)&&(s=!0),Uy(t)&&(o=!0);const r={roomId:this._roomConf.roomId,streamList:[e.streamId],config:{enableMediaType:{video:o,audio:!!this._roomConf.isMultiChatMode()||s}}};var n;(await this._ctx.signalingManager.sendSignaling("updateSubscribe",r),this._roomConf.isMultiChatMode())||(null===(n=e.observer)||void 0===n||n.setUnmuteAudio(s),e.subAudio=s);return null===(i=e.observer)||void 0===i||i.setUnmuteVideo(o),e.subVideo=o,e.subMediaType=t,e}async cleanStream(e){this._logger.info("cleanStream()","stream: %o",e),null==e||e.clean()}destroyStream(e){this._logger.info("destroyStream()","stream: %o",e),null==e||e.destroy()}destroy(e){var t;this._logger.info("destroy()","remoteStream: %o",e),e.forEach((e=>{this.unsubscribe(e).catch((()=>{})),this.destroyStream(e)})),this._subBackOff.clear(),this._ontrackCallbackMap.forEach(((e,t)=>{this._removeOnTrackListener(t),this._ontrackCallbackMap.delete(t)})),this._subResolves={},null===(t=this._ctx.handler)||void 0===t||t.removeAllListeners("ontrack"),super.removeAllListeners()}_getSubBackOff(e){return this._subBackOff.has(e)||this._subBackOff.set(e,{interval:1e3,retryDuration:0}),this._subBackOff.get(e)}}cG([QP],lG.prototype,"hasSubscribed",1),cG([QP,$x,jP],lG.prototype,"subscribe",1),cG([QP,$x,jP],lG.prototype,"unsubscribe",1),cG([QP,$x,jP],lG.prototype,"unsubscribe4removeTrack",1),cG([jP],lG.prototype,"handleRemoveStream",1),cG([QP,$x,jP],lG.prototype,"subscribe4pushTrack",1),cG([QP,jP],lG.prototype,"updateUserAttributes",1),cG([QP,jP],lG.prototype,"updateSubTrackLayer",1),cG([QP,jP],lG.prototype,"updateSubPriority",1),cG([QP],lG.prototype,"updateSubMediaType",1),cG([QP],lG.prototype,"cleanStream",1),cG([QP],lG.prototype,"destroyStream",1);const uG={[_h.communication]:[0],[_h.chat]:[0],[_h.chatRoom]:[1,"IES_chatroom"],[_h.coHost]:[1,"IES_PK"],[_h.meeting]:[16],[_h.classRoom]:[0]};class hG extends aT{constructor(e,t){super(),Ou(this,"_logger",void 0),Ou(this,"_authorization",void 0),Ou(this,"_joinRoom5xxTimer",void 0),Ou(this,"_joinTask",void 0),Ou(this,"_sdpInfo",void 0),this._ctx=e,this._roomConf=t,this._logger=new eS("RoomJoin",2,e.id),this._logger.info("constructor","invoke")}join(){let e,t,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._logger.info("join()");const o=new Promise(((o,s)=>{e=o,t=s,this._callJoinRoom(i).catch((e=>{const t=Array.isArray(e)&&e.length>0?e[0]:e;this._joinRoomFailed(t.message)}))}));return this._joinTask&&i?this._joinTask.startTime=wy():(this._joinTask={startTime:wy(),success:e,fail:t},this._roomConf.joinPromise=o),this._reportJoinRoomStart(),o}async updateToken(e){if(this._logger.info("updateToken()","newToken: %o",e),!this._ctx.appId||!this._roomConf.userId||!this._roomConf.roomId)return;const t={roomId:this._roomConf.roomId,userId:this._roomConf.userId,appId:this._ctx.appId,token:"Bearer ".concat(e)};try{await this._ctx.signalingManager.sendSignaling("updateToken",t)}catch(i){throw new HS(US.UPDATE_TOKEN_WITH_INVALID_TOKEN,"invoke updateToken with an invalid token")}}async leave(){this._logger.info("leave()"),this._stopJoinRoom5xxRetry(),this._joinRoomFailed("leave_room");const e={Authorization:this._authorization,roomId:this._roomConf.roomId,sessionId:this._roomConf.sessionId};if(await this._ready2join(),!this._ctx.signalingManager.isConnected())return Promise.reject(new HS(US.NOT_CONNECTED_YET,"server not connected"));await this._ctx.signalingManager.sendSignaling("leaveRoom",e,this._roomConf.rtsOnlySignalHeader)}destroy(){this._logger.info("destroy()"),this._joinRoomFailed("leave_room"),this._authorization=void 0,this._stopJoinRoom5xxRetry(),this.removeAllListeners()}async _ready2join(){var e;(await this._ctx.signalingManager.connect(),this._sdpInfo)||(this._sdpInfo=await(null===(e=this._ctx.handler)||void 0===e?void 0:e.getDefaultSdp()));return hG.supportedCodecs||(hG.supportedCodecs=await LT()),{sdpInfo:this._sdpInfo,supportedCodecs:hG.supportedCodecs}}async _callJoinRoom(e){var t,i;this._logger.info("_callJoinRoom","invoke"),delete this._sdpInfo;const{appId:o,role:s,businessId:r,useCloudProxy:n,joinRoomParams:a,mediaParams:d}=this._ctx,{sdpInfo:c,supportedCodecs:l}=await this._ready2join(),u={Authorization:Gy.token2auth(o,this._roomConf.roomId,this._roomConf.userId,this._roomConf.token),sessionId:this._roomConf.sessionId,timestamp:Date.now(),controlMessage:this._roomConf.getLiveControlMessage(),userAttributes:{extra_info:this._roomConf.userInfo.extraInfo,role:s},sdpInfo:c,params:{supportedCodecs:l,userAgent:window.navigator.userAgent,sdkVersion:_y.VERSION,deviceId:DS.getDeviceId(),appId:o,roomId:this._roomConf.roomId,userId:this._roomConf.userId,businessId:r,enableCloudProxy:n,channelProfile:uG[this._roomConf.roomProfileType]?"".concat(uG[this._roomConf.roomProfileType][0]):"0",SDKCodecNegotiation:vy("SDK_CODEC_NEGOTIATION"),sdkType:"rtc",joinRoomMode:this._roomConf.isRTSOnlyRoom()?2:1,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(t=_y.MEDIA_PROCESSING_TYPE)&&void 0!==t?t:0},options:{supportCheckTokenPrivilege:!0,supportTokenExpireCallBack:!0,enableSceneConfigV2:!0,enableUnBundleMode:!0,enableAudioMux:!0,enableBigRoomMode:!0,needNegotiateSDP:!0,supportMultiVendor:!0}};if("AREA_CODE_US_OPCO"===vy("AREA_CODE")&&(u.params.mediaArea=JSON.stringify([{AreaList:["GEO:US_OPCO"],Attribute:"include"}])),a)for(const[f,g]of Object.entries(a))u.params[f]=g;d&&(u.mediaParams=d);vy("SIGNAL_CROP_JOINROOM")&&null!==(i=u.sdpInfo)&&void 0!==i&&i.sdp&&(u.sdpInfo.sdp=(e=>{const t=hk.parse(e);return t.media=t.media.map((e=>"audio"===e.type?Ok(e,t):Ak(e,["H264","VP8","ByteVC1"],t))),hk.write(t)})(u.sdpInfo.sdp)),Promise.resolve().then((()=>this.emit("onSendingJoinMessageHook")));try{var h,m,p,_;const t=e?"reconnected":"joinRoom",i=await this._joinRoomWithRetry(t,u);this._logger.success("join","send join message success");const{engine_WEB:o,_abtest_vid:s}=i.config||{};var b,v,S;if(this._authorization=u.Authorization,DS.setEngineWebConfig(this._ctx.appId,this._roomConf.roomId,o),this._ctx.serverConfig={videoCodec:null==o?void 0:o.video_codec,audioRed:!(null==o||!o.pub_audio_red),muteReplaceUnsub:!(null===(h=i.config)||void 0===h||!h.mute_replace_unsub),simulcastOnDemand:!(!1===(null===(m=i.config)||void 0===m||null===(m=m.engine_VPM)||void 0===m||null===(m=m.ondemand)||void 0===m?void 0:m.enable)),forceUniHandler:1===(null===(p=i.config)||void 0===p||null===(p=p.vendor_param)||void 0===p?void 0:p.vendor_stream_sub_mode),e2eFeedback:null==o?void 0:o.e2e_feedback},vy("SDK_CODEC_NEGOTIATION"))this._ctx.targetCodec=null===(b=i.config)||void 0===b?void 0:b.targetCodec,this._ctx.targetScreenCodec=null===(v=i.config)||void 0===v?void 0:v.targetScreenCodec;if("boolean"==typeof(null==o?void 0:o.av_sync)&&(this._ctx.avSync=o.av_sync),this._roomConf.rtcVid=s,i.vendorConfig&&this._roomConf.setVendorConfig(i.vendorConfig),mL.setAudioStallConfig(o),null!==(_=i.relayMessage)&&void 0!==_&&_.sdp)null===(S=this._ctx.handler)||void 0===S||S.createAVMlineAnswerTpl(i.relayMessage.sdp);this.emit(_P.JOIN_SUCCESS,{joinRes:i,reconnect:e}),this._joinRoomSuccess(i)}catch(y){const e={461:US.ROOM_FORBIDDEN,462:US.USER_FORBIDDEN};(null==y?void 0:y.code)>=700&&(null==y?void 0:y.code)<800?this._joinRoomFailed("token_error",US.INVALID_TOKEN):e[null==y?void 0:y.code]?this._joinRoomFailed((null==y?void 0:y.message)||e[null==y?void 0:y.code],e[null==y?void 0:y.code]):(null==y?void 0:y.code)===US.TIME_OUT&&this._ctx.joinRoomConfig.useTcpAfterJoinTimeout?(this._logger.error("join",jk.JOIN_TIMEOUT),this.safeEmit(_P.ON_REJOIN_WITH_TCP),this._ctx.signalingManager.reconnect(jk.JOIN_TIMEOUT,!0)):y.code===US.OPERATION_CANCEL&&this._ctx.signalingManager.isReconnecting()||this._joinRoomFailed((null==y?void 0:y.message)||"signaling_error")}}_joinRoomWithRetry(e,t,i){return new Promise(((o,s)=>{this._ctx.signalingManager.sendSignaling(e,t,this._roomConf.rtsOnlySignalHeader,1e4).then((e=>{this.emit("onJoinRoomAck",e),o(e)})).catch((r=>{if(i=i||new ck,r.code>=500&&r.code<600&&wy()-i.initTs<6e4){const n=i.getRetryDelay();return this._logger.warn("_joinRoomWithRetry","joinRoom failed(code: ".concat(r.code,"), will retry after ").concat(n,"ms")),void(this._joinRoom5xxTimer=setTimeout((()=>{delete this._joinRoom5xxTimer,this._joinRoomWithRetry(e,t,i).then(o).catch(s)}),n))}s(r)}))}))}_stopJoinRoom5xxRetry(){this._joinRoom5xxTimer&&(clearTimeout(this._joinRoom5xxTimer),delete this._joinRoom5xxTimer)}_reportJoinRoomStart(){this._joinTask&&(this.emit("__joinRoomStartReport"),this._roomConf.report("join_room",{type:"begin",start:this._joinTask.startTime,result:!1,reason:""},{enable_cloud_proxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC}))}_joinRoomSuccess(e){this._joinTask&&(this._joinTask.success(e),this.emit("__joinRoomSuccessReport"),this._roomConf.report("join_room",{type:"end",start:this._joinTask.startTime,result:!0,reason:""},{enable_cloud_proxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC}),this._roomConf.report("rtc_join_room",{error_code:0,deviceModel:"web",deviceManufacturer:"web",elapse:wy()-this._joinTask.startTime}),delete this._joinTask,delete this._roomConf.joinPromise)}_joinRoomFailed(e,t){this._joinTask&&(this._joinTask.fail(new HS(t||US.JOIN_ROOM_FAILED,e)),this.emit("__joinRoomFailedReport"),this._roomConf.report("join_room",{type:"end",start:this._joinTask.startTime,result:!1,reason:e},{enable_cloud_proxy:this._ctx.useCloudProxy,expectedIDC:this._ctx.expectedIDC}),delete this._joinTask,delete this._roomConf.joinPromise)}}Ou(hG,"supportedCodecs",void 0);var mG=Object.defineProperty,pG=Object.getOwnPropertyDescriptor,_G=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?pG(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&mG(t,i,r),r};class bG{constructor(e,t){Ou(this,"_logger",void 0),this._ctx=e,this._roomConf=t,this._logger=new eS("RoomMessage",2,e.id)}sendUserMessage(e,t){return this._ctx.signalingManager.sendP2PMessage({to:e,from:this._roomConf.userId,room:this._roomConf.roomId,app:this._ctx.appId,msg:t})}async sendRoomMessage(e,t){const i={clientId:this._roomConf.userId,binary:t,message:"",roomId:this._roomConf.roomId};return i.message=t?await Gy.ab2b64str(e):e,this._ctx.signalingManager.sendSignaling("customMessage",i,this._roomConf.rtsOnlySignalHeader)}async controlMessage(e){this._logger.info("controlMessage()","params: %o",e);const t=e;"transcode"===e.type&&(t.roomId=this._roomConf.roomId),await this._ctx.signalingManager.sendSignaling("controlMessage",t)}}_G([jP],bG.prototype,"sendUserMessage",1),_G([jP],bG.prototype,"sendRoomMessage",1),_G([jP],bG.prototype,"controlMessage",1);var vG=Object.defineProperty,SG=Object.getOwnPropertyDescriptor,yG=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?SG(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&vG(t,i,r),r};const fG={audiostream:!0,extaudio:!1,extvideo:!1,localaudio:!0,localvideo:!1,videoDescriptions:[],videostream:!1,publishTime:0};class gG extends aT{constructor(e,t){super(),Ou(this,"_localStream",void 0),Ou(this,"_localScreenStream",void 0),Ou(this,"_remoteUsers",new Map),Ou(this,"_remoteStreams",new Map),Ou(this,"_remoteStreamStreamIdUserIdMap",{}),Ou(this,"_virtualStreams",[]),Ou(this,"_serverConfig",void 0),Ou(this,"_userDuplicateLoginTimerMap",new Map),Ou(this,"_networkQualityManager",void 0),Ou(this,"_videoSizeObserver",void 0),Ou(this,"_hasPublished",!1),Ou(this,"_subtitleTool",void 0),Ou(this,"_csrcUserIdMap",{}),Ou(this,"_publishOnDemandItem",void 0),Ou(this,"_onceTriggerBySignal",!1),Ou(this,"_pubTransceiverReady",!1),Ou(this,"_publishOnDemandBusy",!1),Ou(this,"logger",void 0),Ou(this,"_forwardStreamManager",void 0),Ou(this,"_publisher",void 0),Ou(this,"_subscriber",void 0),Ou(this,"_roomJoin",void 0),Ou(this,"_roomMessage",void 0),Ou(this,"_clearSignalListeners",void 0),this.config=e,this._ctx=t,this.logger=new eS("Room",1,t.id),this.logger.info("constructor","invoke"),this._publisher=new nG(t,e),this._addPublisherListeners(),this._subscriber=new lG(t,e),this._addSubscriberListeners(),this._roomJoin=new hG(t,e),this._addJoinRoomHandler(),this._forwardStreamManager=new ek(t,e),this._addForwardStreamListeners(),this._roomMessage=new bG(t,e),this._networkQualityManager=new IP(t),this._networkQualityManager.reportor=this._reportNetworkQuality.bind(this),this._videoSizeObserver=new RP(this),this._videoSizeObserver.onchange=this._emitVideoSizeChange.bind(this),this._addSignalListeners()}get remoteUsers(){return this._remoteUsers}get remoteStreams(){return this._remoteStreams}get localStream(){return this._localStream}get localScreenStream(){return this._localScreenStream}get virtualStreams(){return this._virtualStreams}_addSignalListeners(){const e={[hT.ON_ADD_STREAM]:this._onAddStream.bind(this),[hT.ON_ADD_STREAM_LIST]:e=>{e&&Array.isArray(e.streamList)&&e.streamList.forEach((e=>this._onAddStream(e)))},[hT.ON_REMOVE_STREAM]:this._onRemoveStream.bind(this),[hT.ON_REMOVE_STREAM_LIST]:e=>{e&&Array.isArray(e.streamList)&&e.streamList.forEach((e=>this._onRemoveStream(e)))},[hT.USER_CONNECTION]:this._onUserConnection.bind(this),[hT.USER_CONNECTION_LIST]:e=>{e&&Array.isArray(e.userList)&&e.userList.forEach((e=>this._onUserConnection(e)))},[hT.USER_DISCONNECTION]:this._onUserDisconnection.bind(this),[hT.USER_DISCONNECTION_LIST]:e=>{e&&Array.isArray(e.userList)&&e.userList.forEach((e=>this._onUserDisconnection(e)))},[hT.ON_UPDATE_ROOM_ATTRIBUTES]:this._onUpdateRoomAttributes.bind(this),[hT.ON_UPDATE_USER_ATTRIBUTES]:this._onUpdateUserAttributes.bind(this),[hT.ON_UPDATE_STREAM_ATTRIBUTES]:this._onUpdateStreamAttributes.bind(this),[hT.ON_PUSH_TRACK]:this._onPushTrack.bind(this),[hT.ON_REMOVE_TRACK]:this._onRemoveTrack.bind(this),[hT.ON_CUSTOM_MESSAGE]:this._onCustomMessage.bind(this),[hT.USER_MESSAGE_RECEIVED]:this._onUserMessageReceived.bind(this),[hT.USER_BINARY_MESSAGE_RECEIVED]:this._onUserBinaryMessageReceived.bind(this),[hT.POST_PROCESSING_MESSAGE]:this._onPostProcessingMessage.bind(this),[hT.ON_USER_TOKEN_WILL_EXPIRE]:this._onUserTokenWillExpire.bind(this),[hT.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE]:this._onUserTokePublishPrivilegeWillExpire.bind(this),[hT.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED]:this._onUserTokenPublishPrivilegeDidExpire.bind(this),[hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE]:this._onUserTokeSubscribePrivilegeWillExpire.bind(this),[hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED]:this._onUserTokenSubscribePrivilegeDidExpire.bind(this),[hT.STREAM_CONTROL_MESSAGE]:this._onStreamControlMessage.bind(this),[hT.ENGINE_CONTROL_MESSAGE]:this._onEngineControlMessage.bind(this),[hT.ON_STREAM_FAILED]:this._onStreamFailed.bind(this),[mT.RTT]:this._onRTT.bind(this),[mT.SSC]:this._onSSC.bind(this),[pT.ON_CONNECTION_STATE_CHANGE]:this._onConnectionStateChange.bind(this),[hT.ON_SPEAKER_CHANGE]:this._onMeetingSpeakerChange.bind(this),[hT.ON_FORWARD_DST_ROOM_USER_KICK]:this._forwardStreamManager.onForwardDstRoomUserKick.bind(this._forwardStreamManager),[mT.RSCP]:this._onRSCP.bind(this)};Object.keys(e).forEach((t=>{this._ctx.signalingManager.on(t,e[t])})),this._clearSignalListeners=()=>{Object.keys(e).forEach((t=>{this._ctx.signalingManager.off(t,e[t])}))}}_addPublisherListeners(){this._publisher.on(_P.PUB_RETRY,(e=>{this.emit(_P.PUB_RETRY,e)})),this._publisher.on(mT.RSCP,this._onRSCP.bind(this)),this._publisher.on(pT.ON_VENDOR_CONNECTION_STATE_CHANGE,(e=>this.emit(pT.ON_VENDOR_CONNECTION_STATE_CHANGE,e)))}_addSubscriberListeners(){this._subscriber.on(pT.ON_VENDOR_CONNECTION_STATE_CHANGE,(e=>this.emit(pT.ON_VENDOR_CONNECTION_STATE_CHANGE,e))),this._subscriber.on("onRemoteStreamStats",(e=>{this._networkQualityManager.updateDownlinkStats(e,this._findRemoteStreamByScreen(e.userId,e.isScreen)),vy("HIDDEN_STATS")||(e=Fy(e)),this.emit(_P.ON_REMOTE_STREAM_STATS,e)})),this._subscriber.on(_P.RESUBSCRIBE,(e=>{this.emit(_P.RESUBSCRIBE,e)})),this._subscriber.on(_P.SUB_RETRY,(e=>{this.emit(_P.SUB_RETRY,e)}))}_addJoinRoomHandler(){this._roomJoin.on(_P.JOIN_SUCCESS,this._onJoinSucc.bind(this)),this._roomJoin.on(_P.ON_REJOIN_WITH_TCP,(()=>{this.emit(_P.ON_REJOIN_WITH_TCP)}))}_addForwardStreamListeners(){this._forwardStreamManager.on(_P.ON_FORWARD_STREAM_ERROR,(e=>{this.safeEmit(_P.ON_FORWARD_STREAM_ERROR,e)}))}_onLocalStreamStats(e){const t=e.isScreen?this._localScreenStream:this.localStream;this._networkQualityManager.updateUplinkStats(e,t),vy("HIDDEN_STATS")||(e=Fy(e)),this.emit(_P.ON_LOCAL_STREAM_STATS,e)}async join(){this.logger.info("join()"),this.config.startJoinTimestamp=wy();try{var e;const t=await this._roomJoin.join();return this._ctx.callId=t.callId,null!==(e=t.roomAttributes)&&void 0!==e&&e.multiChatMode&&this._handleFFAudioTrack(),this._initSubtitleTool(),{users:t.clients,streams:t.streams}}catch(t){if(t.code!==US.OPERATION_CANCEL)throw t}}async hasScreenPublished(){return!!this._localScreenStream&&this._publisher.hasPublished(this._localScreenStream)}async hasPublished(){return!!this._localStream&&this._publisher.hasPublished(this._localStream)}async publishScreen(e,t,i,o){this.logger.info("publishScreen()"),this._localScreenStream||(this._localScreenStream=new mP(this._ctx,qu.STREAM_INDEX_SCREEN),this.config.vendorConfig.enableMultiVendor&&(this._localScreenStream.pcSessionId=vm()),this._localScreenStream.isScreen=!0,this._localScreenStream.observer=new gP(this._ctx,this._localScreenStream));let s=!1,r=!1,n=!1,a=!1;!this._localScreenStream.videoTrack&&e?(e.sourceType===yT.EXTERNAL&&(r=!0),s=!0):this._localScreenStream.videoTrack&&!e&&(s=!1),!this._localScreenStream.audioTrack&&t?(t.sourceType===yT.EXTERNAL&&(a=!0),n=!0):this._localScreenStream.audioTrack&&!t&&(n=!1),this._localScreenStream.videoTrack=e,this._localScreenStream.audioTrack=t,i&&(Ky(i)&&(this._localScreenStream.pubAudio=o===vP.PUB),Uy(i)&&(this._localScreenStream.pubVideo=o===vP.PUB),this.logger.info("publishScreen mediaType","pubAudio: %o, pubVideo: %o",this._localScreenStream.pubAudio,this._localScreenStream.pubVideo));const d=await this._publisher.hasPublished(this._localScreenStream);if(!this._localScreenStream.pubAudio&&!this._localScreenStream.pubVideo)return d?this.unpublishScreen():void 0;if(d){var c,l,u,h;if(r)null===(c=this._localScreenStream.observer)||void 0===c||c.setPushVideo(s);else null===(l=this._localScreenStream.observer)||void 0===l||l.setEnableVideo(s);if(a)null===(u=this._localScreenStream.observer)||void 0===u||u.setPushAudio(n);else null===(h=this._localScreenStream.observer)||void 0===h||h.setEnableAudio(n);await this.updatePubScreenTrack()}else{var m;null===(m=this._localScreenStream.observer)||void 0===m||m.setPublish(!0),await this._publisher.publish(this._localScreenStream)}this._localScreenStream.pubAudio||this._localScreenStream.pubVideo?this._ctx.handler&&this._localScreenStream.startReport(this._onLocalStreamStats.bind(this),this._localScreenStream.vendorHandler||this._ctx.handler):this._localScreenStream.stopReport("unpublish screen")}async updatePubScreenTrack(){this.logger.info("updatePubScreenTrack","Invoke updatePubScreenTrack"),this._localScreenStream&&await this._publisher.updatePubTrack(this._localScreenStream)}async unpublishScreen(){var e;(this.logger.info("unpublish","Invoke unpublishScreen"),this._localScreenStream)&&(null===(e=this._localScreenStream.observer)||void 0===e||e.setPublish(!1),await this._publisher.unpublish(this._localScreenStream),this._localScreenStream.stopReport("unpublish screen"),await this._publisher.cleanStream(this._localScreenStream),this._localScreenStream=void 0)}async liveControlMessage(e){var t;this.logger.info("controlMessage","Invoke controlMessage"),null===(t=e.transcodeMeta)||void 0===t||t.layout.regions.forEach((e=>{e.roomID=this.config.roomId})),this.config.setLiveControlMessage("stopped"===e.action?void 0:e);try{await this._roomMessage.controlMessage(e)}catch(i){if("stopped"!==e.action)throw i}}async publicStreamControlMessage(e){"stopped"===e.action&&delete e.publicStreamMeta,await this._roomMessage.controlMessage(e)}getLocalStreamStats(){var e;return null===(e=this.localStream)||void 0===e?void 0:e.getLocalStreamStats()}async updateUserAttributes(){this.logger.info("updateUserAttributes","Invoke updateUserAttributes"),await this._subscriber.updateUserAttributes({role:this._ctx.role})}async publish(e,t,i,o){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.logger.info("publish","Invoke publish");let r=!1;this._localStream||(this._localStream=new mP(this._ctx),this.config.vendorConfig.enableMultiVendor&&(this._localStream.pcSessionId=vm()),this._localStream.observer=new gP(this._ctx,this._localStream),r=!0,this._localStream.vendorCode=this.config.vendorConfig.vendorCode||0),this._localStream.videoTrack=e,this._localStream.audioTrack=t;const{pubAudio:n,pubVideo:a}=this._localStream;i&&(Ky(i)&&(this._localStream.pubAudio=o===vP.PUB),Uy(i)&&(this._localStream.pubVideo=o===vP.PUB),this.logger.info("publish mediaType","pubAudio: %o, pubVideo: %o",this._localStream.pubAudio,this._localStream.pubVideo));if(await this._publisher.hasPublished(this._localStream))try{this.emit("___onMediaServerClientPublish"),await this.updatePubTrack()}catch(b){throw this._localStream.pubAudio=n,this._localStream.pubVideo=a,b}else{if(!this._localStream.pubAudio&&!this._localStream.pubVideo)return;try{var d;if(s)null===(d=this._localStream.observer)||void 0===d||d.setLogin(!0);else if(r){var c,l;const e=!!this._localStream.videoTrack,t=!!this._localStream.audioTrack,i=(null===(c=this._localStream.videoTrack)||void 0===c?void 0:c.sourceType)===yT.EXTERNAL,o=(null===(l=this._localStream.audioTrack)||void 0===l?void 0:l.sourceType)===yT.EXTERNAL;if(this.config.isAutoPublish&&!this._hasPublished){var u,h,m,p;if(e)if(i)null===(u=this._localStream.observer)||void 0===u||u.setPushVideo(!0);else null===(h=this._localStream.observer)||void 0===h||h.setEnableVideo(!0);if(t)if(o)null===(m=this._localStream.observer)||void 0===m||m.setPushAudio(!0);else null===(p=this._localStream.observer)||void 0===p||p.setEnableAudio(!0)}else{var _;null===(_=this._localStream.observer)||void 0===_||_.setPublish(!0)}}this.emit("___onMediaServerClientPublish"),await this._publisher.publish(this._localStream),this._hasPublished=!0,this.emit(_P.ON_PUBLISH_RESULT,{isScreen:!1,state:ju.PUBLISH_SUCC})}catch(b){throw this.emit(_P.ON_PUBLISH_RESULT,{isScreen:!1,state:ju.PUBLISH_FAIL,errorCode:b.code}),delete this._localStream,b}}this._localStream.pubAudio||this._localStream.pubVideo?this._ctx.handler&&this._localStream.startReport(this._onLocalStreamStats.bind(this),this._localStream.vendorHandler||this._ctx.handler):this._localStream.stopReport("unpublish")}async updatePubTrack(){this.logger.info("updatePubTrack","Invoke updatePubTrack"),this._localStream&&await this._publisher.updatePubTrack(this._localStream)}async unpublish(){this.logger.info("unpublish","Invoke unpublish"),this._localStream&&(await this._publisher.unpublish(this._localStream),this._localStream.stopReport("unpublish"),await this._publisher.cleanStream(this._localStream),this._localStream=void 0)}async subscribe(e,t){this.logger.info("subscribe","remoteStream %o",e);if(await this._subscriber.hasSubscribed(e)){const i=e.subMediaType|t;return i!==e.subMediaType?await this._subscriber.updateSubMediaType(e,i):void 0}const i=this._ctx.videoProfile.getSubLayer(e,this.config.remoteVideoConfig);await this._subscriber.subscribe(e,t,i)}async updateSubVideoConfig(e){var t;const i=this._findRemoteStreamByScreen(e,!1);if(this.logger.info("updateSubVideoConfig","userId %s",e),!i)return;if(!(await this._subscriber.hasSubscribed(i))||(null===(t=i.attributes)||void 0===t||null===(t=t.videoDescriptions)||void 0===t?void 0:t.length)<=1)return;const o=this._ctx.videoProfile.getSubLayer(i);return o?(i.originalStreamIndex=o.spatialLayer,this._subscriber.updateSubTrackLayer(i,o)):void 0}async unsubscribe(e,t){var i;this.logger.info("unsubscribe","Invoke unsubscribe");if(!(await this._subscriber.hasSubscribed(e)))return;const o=e.subMediaType-(e.subMediaType&t);if((null===(i=this._ctx.serverConfig)||void 0===i||!i.muteReplaceUnsub)&&(o===ly.NONE||this.config.isMultiChatMode()&&o===$u.AUDIO))return await this._subscriber.unsubscribe(e);await this._subscriber.updateSubMediaType(e,o)}async startSubtitle(e){if(!this._subtitleTool)throw new HS(US.INVOKED_BEFORE_JOIN_ROOM,"join first");await this._subtitleTool.start(e)}async updateSubtitleConfig(e){if(!this._subtitleTool)throw new HS(US.INVOKED_BEFORE_JOIN_ROOM,"join first");await this._subtitleTool.update(e)}async stopSubtitle(){var e;null===(e=this._subtitleTool)||void 0===e||e.stop()}async startForwardStream2Rooms(e){return this._forwardStreamManager.startForwardStream2Rooms(e)}async updateForwardStream2Rooms(e){return this._forwardStreamManager.updateForwardStream2Rooms(e)}async stopForwardStream2Rooms(){return this._forwardStreamManager.stopForwardStream2Rooms()}async pauseForwardStream2AllRooms(){return this._forwardStreamManager.pauseForwardStream2AllRooms()}async resumeForwardStream2AllRooms(){return this._forwardStreamManager.resumeForwardStream2AllRooms()}async updateMediaParams(e){return this._ctx.signalingManager.sendSignaling("updateMediaParams",{roomId:this.config.roomId,mediaParams:e})}async leave(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.logger.info("leave","Invoke leave"),null===(e=this._subtitleTool)||void 0===e||e.destroy(),delete this._subtitleTool;try{for(const e of this._remoteStreams.values())Array.isArray(e)&&e.forEach((e=>{var t;null===(t=e.observer)||void 0===t||t.setLogin(!1)}));var i;if(this._localStream)null===(i=this._localStream.observer)||void 0===i||i.setLogin(!1);await this._roomJoin.leave().catch((()=>{})),this.destroy(),this.config.report("rtc_leave_room",{error_code:0,message:"",elapse:this.config.getStayRoomDuration()})}catch(o){if(o instanceof Error&&this.config.report("rtc_leave_room",{error_code:-1,message:o.message,elapse:this.config.getStayRoomDuration()}),t)throw o;this.destroy()}}updateRemoteUserPriority(e){var t;null===(t=this.remoteStreams.get(e))||void 0===t||t.forEach((t=>{const{userPriority:i}=this._ctx;t.hasSubscribed&&i.has(e)&&this._subscriber.updateSubPriority(t,i.get(e))}))}destroy(){var e,t,i;this.logger.info("destroy","Invoke destroy"),Wv(this._ctx.id,"room_destroy","".concat((new Error).stack)),null===(e=this._subtitleTool)||void 0===e||e.destroy(),delete this._subtitleTool;const o=Um(t=Array.from(this._remoteStreams.values())).call(t);this._subscriber.destroy(o),this._subscriber.destroy(this._virtualStreams),this._publisher.destroy([this.localStream,this.localScreenStream]),this._roomJoin.destroy(),null===(i=this._clearSignalListeners)||void 0===i||i.call(this),this._remoteUsers=new Map,this._remoteStreams=new Map,this._localStream&&(this._localStream=void 0),this._localScreenStream&&(this._localScreenStream=void 0),this._userDuplicateLoginTimerMap.forEach((e=>{clearTimeout(e)})),this._userDuplicateLoginTimerMap.clear(),this._networkQualityManager.destroy(),this._videoSizeObserver.destroy(),this._csrcUserIdMap={},this._virtualStreams=[],this._remoteStreamStreamIdUserIdMap={},this._forwardStreamManager.destoy()}async updateToken(e){if(this.logger.info("updateToken","Invoke updateToken"),this.config.token=e,!this.config.isRTSOnlyRoom())try{await this._roomJoin.updateToken(e)}catch(t){throw this.safeEmit(_P.ON_ROOM_ERROR,{errorCode:US.UPDATE_TOKEN_WITH_INVALID_TOKEN}),t}}sendUserMessage(e,t){return this._ctx.rtsLimiter.e2e.check(t),this._roomMessage.sendUserMessage(e,t)}sendRoomMessage(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._ctx.rtsLimiter.boradcast.check(e),this._roomMessage.sendRoomMessage(e,t)}async maybeFillBackFrame2Stream(e){var t;e.refreshBlackFrameLifetime(),null!==(t=e.videoTransceiver)&&void 0!==t&&t.sender.track||this._publisher.updatePubBlackFrame(e)}_onJoinSucc(e){var t,i;let{joinRes:o,reconnect:s}=e;this.logger.info("_onJoinSucc()","invoke. ".concat(s?"[reconnect]":"")),this.emit(_P.JOIN_SUCCESS,s),this._serverConfig=o.config,this.config.updateRoomAttributes(o.roomAttributes);const r=[],n=[],a=[],d=[],c=[];this.config.isRTSOnlyRoom()&&Array.isArray(o.userInfos)&&(o.clientsDetail=o.userInfos.map((e=>({clientId:e.userId,clientJoinTime:e.userJoinTime})))),null===(t=o.clientsDetail)||void 0===t||t.forEach((e=>{if(e.attributes&&(e.attributes.serverMuteVideo&&this.safeEmit(_P.ON_VIDEO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteVideo}),e.attributes.serverMuteAudio&&this.safeEmit(_P.ON_AUDIO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteAudio})),e.clientId===o.clientId)return;const t=this._remoteUsers.get(e.clientId);t?t._stillExist=!0:r.push(e)}));for(const l of this._remoteUsers.values())l._stillExist||n.push({clientId:l.userId}),delete l._stillExist;null===(i=o.streams)||void 0===i||i.forEach((e=>{const t=this._findRemoteStreamByScreen(e.clientId,e.screen);this.config.updateUserPubInfo(e),t?(t.stillExist=!0,t.streamId=e.streamId,c.push(e)):d.push(e)}));for(const l of this._remoteStreams.values())Array.isArray(l)&&l.forEach((e=>{e.stillExist?delete e.stillExist:a.push({clientId:e.userId,streamId:e.streamId,message:cT.clientDisconnected})}));n.forEach((e=>this._onUserDisconnection(e))),r.forEach((e=>this._onUserConnection(e))),a.forEach((e=>this._onRemoveStream(e))),d.forEach((e=>this._onAddStream(e,{fromSignal:!1}))),c.forEach((e=>this._onUpdateStreamAttributes(e))),this.config.resetUserPubInfo(),s&&this._handleSendOrRecvStreamAfterReconnect(),this.emit("__joinSuccess")}_handleSendOrRecvStreamAfterReconnect(){var e;this._localStream&&(this._publisher.cleanStream(this._localStream).then((()=>{var e;this._localStream&&(this._localStream.vendorCode=this.config.vendorConfig.vendorCode||0,null===(e=this._localStream.observer)||void 0===e||e.setLogin(!0))})),this._publisher.publish(this._localStream).then((()=>{var e;this._ctx.handler&&(null===(e=this._localStream)||void 0===e||e.startReport(this._onLocalStreamStats.bind(this),this._localStream.vendorHandler||this._ctx.handler)),this.emit(_P.ON_PUBLISH_RESULT,{isScreen:!1,state:ju.PUBLISH_SUCC,retry:!0})})).catch((e=>{this.logger.error("failed repub error:".concat(e)),this.emit(_P.ON_PUBLISH_RESULT,{isScreen:!1,state:ju.PUBLISH_FAIL,errorCode:e.code,retry:!0})}))),this._localScreenStream&&(this._publisher.cleanStream(this._localScreenStream).then((()=>{var e;this._localScreenStream&&(null===(e=this._localScreenStream.observer)||void 0===e||e.setLogin(!0))})),this._publisher.publish(this._localScreenStream).then((()=>{var e;this._ctx.handler&&(null===(e=this._localScreenStream)||void 0===e||e.startReport(this._onLocalStreamStats.bind(this),this._localScreenStream.vendorHandler||this._ctx.handler)),this.emit(_P.ON_PUBLISH_RESULT,{isScreen:!0,state:ju.PUBLISH_SUCC,retry:!0})})).catch((e=>{this.logger.error("failed repub screen stream error:".concat(e)),this.emit(_P.ON_PUBLISH_RESULT,{isScreen:!0,state:ju.PUBLISH_FAIL,errorCode:e.code,retry:!0})})));for(const t of this._remoteStreams.values())Array.isArray(t)&&t.forEach((async e=>{if(e.hasSubscribed){e.resetHasSubscribed();try{var t,i;this.logger.info("start resubscribe ".concat(e.userId," with ").concat(e.subMediaType)),Uy(e.subMediaType)&&(null===(t=e.observer)||void 0===t||t.setSubscribeVideo(!0)),Ky(e.subMediaType)&&(null===(i=e.observer)||void 0===i||i.setSubscribeAudio(!0)),await this._subscriber.subscribe(e,e.subMediaType),this.logger.info("success resubscribe ".concat(e.userId," with ").concat(e.subMediaType)),this.safeEmit(_P.RESUBSCRIBE,{stream:e}),this.emit(_P.ON_SUBSCRIBE_RESULT,{state:zu.SUBSCRIBE_SUCC,userId:e.userId,isScreen:e.isScreen,retry:!0})}catch(BW){if(this.emit(_P.ON_SUBSCRIBE_RESULT,{state:zu.SUBSCRIBE_FAIL,userId:e.userId,isScreen:e.isScreen,errorCode:BW.code,retry:!0}),this.logger.error("failed resubscribe ".concat(e.userId," with ").concat(e.subMediaType,", error:").concat(BW)),BW.code===US.NOT_CONNECTED_YET)return void(e.streamState=hP.SUB_ED);await this._subscriber.cleanStream(e),e.resetHasSubscribed()}}}));null===(e=this._subtitleTool)||void 0===e||e.reconnect(),this._forwardStreamManager.resumeFromReconnect()}_handleFFAudioTrack(){var e,t;const i=null===(e=this._ctx.handler)||void 0===e?void 0:e.audioTrack4ff,o=null===(t=this._ctx.handler)||void 0===t?void 0:t.getTransceivers();if(i&&Array.isArray(o)){const e=o.find((e=>{var t;return(null==e||null===(t=e.receiver)||void 0===t?void 0:t.track)===i}));if(e){const t=new pP(this._ctx,"ff-stream","ff-stream",!1,!1,fG);t.virtual=!0,t.audioTransceiver=e,t.audioMid="0",t.audioTrack=eP(this._ctx,i,{streamIndex:gT.VIRTUAL}),this._virtualStreams.push(t),this.safeEmit(_P.SUBSCRIBE_PUSH_TRACK,{stream:t})}}}_findRemoteStream(e,t){const i=this._remoteStreams.get(e);return Array.isArray(i)?i.find((e=>e.streamId===t)):null}_findRemoteStreamByScreen(e,t){const i=this._remoteStreams.get(e);return Array.isArray(i)?i.find((e=>e.isScreen===t)):null}_onAddStream(e){let{needEmit:t=!0,fromSignal:i=!0,virtual:o=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.clientId===this.config.userId)return;const{isAutoSubscribeAudio:s,isAutoSubscribeVideo:r}=this.config,n=this._findRemoteStreamByScreen(e.clientId,e.screen);if(n&&n.streamId!==e.streamId){var a;const t=null===(a=this._remoteStreams.get(e.clientId))||void 0===a?void 0:a.filter((e=>e.streamId!==n.streamId));this._subscriber.cleanStream(n),this._remoteStreams.set(e.clientId,t||[])}let d=this._findRemoteStream(e.clientId,e.streamId);if(this._remoteStreamStreamIdUserIdMap[e.streamId]=e.clientId,d)d.attributes=e.attributes;else if(d=new pP(this._ctx,e.clientId,e.streamId,e.screen,!1,e.attributes),d.virtual=o,this._initStreamListeners(d),!o){const t=this._remoteStreams.get(e.clientId);t?t.push(d):this._remoteStreams.set(e.clientId,[d])}if(d.remoteSessionId=e.remoteSessionId||"",d.observer=new fP(this._ctx,d),!d.isScreen&&r&&(i&&d.hasVideo&&(d.attributes.extvideo?(d.observer.setExternalVideoSource(!0),d.observer.setPushVideo(!0)):(d.observer.setExternalVideoSource(!1),d.observer.setPublishVideo(!0))),i&&d.hasAudio&&s&&!this.config.isMultiChatMode()&&(d.attributes.extaudio?(d.observer.setExternalAudioSource(!0),d.observer.setPushAudio(!0)):(d.observer.setExternalAudioSource(!1),d.observer.setPublishAudio(!0))),t&&!i)){const{isAutoSubscribeAudio:e,isAutoSubscribeVideo:t}=this.config;d.observer.setLogin(!0,{audio:!!e&&!this.config.isMultiChatMode(),video:!!t})}return t&&this.safeEmit(hT.ON_ADD_STREAM,{stream:d}),d}_onUserConnection(e){var t;if(e.clientId===this.config.userId)return;const i=this._userDuplicateLoginTimerMap.get(e.clientId);if("number"==typeof i)return this._userDuplicateLoginTimerMap.delete(e.clientId),void self.clearTimeout(i);const o={userId:e.clientId,extraInfo:null===(t=e.attributes)||void 0===t?void 0:t.extra_info};this._remoteUsers.set(e.clientId,Yu({},o)),this.safeEmit(hT.USER_CONNECTION,{userInfo:o,publishState:this.config.getUserPubInfo(o.userId)}),e.attributes&&(e.attributes.serverMuteVideo&&this.safeEmit(_P.ON_VIDEO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteVideo}),e.attributes.serverMuteAudio&&this.safeEmit(_P.ON_AUDIO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteAudio}))}_onUserDisconnection(e){let{clientId:t,tag:i,code:o,forbiddenTime:s}=e;if(t)if(t===this.config.userInfo.userId){let e=null;i===_T.kickedByAdmin?e=US.KICKED_OUT:i===_T.onUserTokenDidExpire?e=US.TOKEN_EXPIRED:i===_T.userDuplicateLogin&&(e=US.DUPLICATE_LOGIN),o===bT.roomDismissByAdmin&&(e=US.ROOM_DISMISS),e&&this.safeEmit(_P.ON_ROOM_ERROR,{errorCode:e,forbiddenTime:s})}else{let e=Fu.DROPPED;i===_T.userLeave?e=Fu.QUIT:i===_T.kickedByAdmin?e=Fu.KICKED_BY_ADMIN:i===_T.roleChanged&&(e=Fu.SWITCH_TO_INVISIBLE);const o=()=>{var i;this._remoteUsers.delete(t);const o=[];null===(i=this._remoteStreams.get(t))||void 0===i||i.forEach((e=>{o.push(this._onRemoveStream({clientId:e.userId,streamId:e.streamId,message:cT.clientDisconnected}))})),this._remoteStreams.delete(t),Promise.all(o).finally((()=>{this.safeEmit(_P.ON_USER_LEAVE,{userInfo:{userId:t},reason:e})}))};if(i===_T.userDuplicateLogin){const e=this._userDuplicateLoginTimerMap.get(t);e&&self.clearTimeout(e);const i=self.setTimeout(o,5e3);this._userDuplicateLoginTimerMap.set(t,i)}else o()}}async _onRemoveStream(e){if(e.clientId===this.config.userId)return;const t=this._remoteStreams.get(e.clientId);if(!t)return;const i=t.find((t=>t.streamId===e.streamId));if(!i)return;var o,s;i.hasVideo&&(null===(o=i.observer)||void 0===o||o.setPublishVideo(!1));i.hasAudio&&!this.config.isMultiChatMode()&&(null===(s=i.observer)||void 0===s||s.setPublishAudio(!1));const r=t.filter((t=>t.streamId!==e.streamId));this._remoteStreams.set(e.clientId,r);try{await this._subscriber.handleRemoveStream(i).then((()=>this._subscriber.cleanStream(i))).finally((()=>{this.safeEmit(hT.ON_REMOVE_STREAM,{stream:i,reason:e.message,callback:()=>{this._subscriber.destroyStream(i)}})}))}catch(n){console.error(n)}}_onUpdateUserAttributes(e){e.attributes&&(e.attributes.serverMuteVideo&&this.safeEmit(_P.ON_VIDEO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteVideo}),e.attributes.serverMuteAudio&&this.safeEmit(_P.ON_AUDIO_STREAM_BANNED,{uid:e.clientId,banned:1===e.attributes.serverMuteAudio}))}_onUpdateRoomAttributes(e){var t;e.roomAttributes&&(this.config.updateRoomAttributes(e.roomAttributes),this._ctx&&(this._ctx.callId=e.roomAttributes.callId)),null!==(t=e.roomAttributes)&&void 0!==t&&t.multiChatMode&&this._handleFFAudioTrack()}_onUpdateStreamAttributes(e){const{isAutoSubscribeAudio:t,isAutoSubscribeVideo:i}=this.config,{clientId:o,streamId:s,attributes:r}=e,n=this._findRemoteStream(o,s);if(!n)return;const a=n.attributes,d=Yu(Yu({},a),r);let c=!1;const l=d.localaudio!==a.localaudio;let u=!1,h=!1;const m=d.localvideo!==a.localvideo;let p=!1,_=ly.NONE,b=ly.NONE;if(d.audiostream!==a.audiostream&&(c=d.localaudio,u=!!d.audiostream,d.audiostream?_|=$u.AUDIO:b|=$u.AUDIO),d.videostream!==a.videostream&&(h=d.localvideo,p=!!d.videostream,d.videostream?_|=$u.VIDEO:b|=$u.VIDEO),_&&this.safeEmit(_P.ON_USER_PUBLISH_STATE_CHANGE,{userId:o,mediaType:_,isScreen:n.isScreen,pubState:vP.PUB,remoteStream:n}),b&&this.safeEmit(_P.ON_USER_PUBLISH_STATE_CHANGE,{userId:o,mediaType:b,isScreen:n.isScreen,pubState:vP.UNPUB,remoteStream:n}),n.remoteSessionId=e.remoteSessionId||"",n.attributes=d,d.localaudio!==a.localaudio)if(d.localaudio){var v,S,y,f;if((t||n.subAudio)&&d.audiostream)if(d.extaudio)null===(v=n.observer)||void 0===v||v.setExternalAudioSource(!0),null===(S=n.observer)||void 0===S||S.setPushAudio(!0);else null===(y=n.observer)||void 0===y||y.setExternalAudioSource(!1),null===(f=n.observer)||void 0===f||f.setEnableAudio(!0);this.safeEmit(_P.ON_USER_START_AUDIO_CAPTURE,{userId:o},n)}else{var g,T,I,R;if(d.extaudio)null===(g=n.observer)||void 0===g||g.setExternalAudioSource(!0),null===(T=n.observer)||void 0===T||T.setPushAudio(!1);else null===(I=n.observer)||void 0===I||I.setExternalAudioSource(!1),null===(R=n.observer)||void 0===R||R.setEnableAudio(!1);!n.isScreen&&this.safeEmit(_P.ON_USER_STOP_AUDIO_CAPTURE,{userId:o})}if(d.localvideo!==a.localvideo)if(d.localvideo){var E,C,Z,L;if((i||n.subVideo)&&d.videostream)if(d.extvideo)null===(E=n.observer)||void 0===E||E.setExternalVideoSource(!0),null===(C=n.observer)||void 0===C||C.setPushVideo(!0);else null===(Z=n.observer)||void 0===Z||Z.setExternalVideoSource(!1),null===(L=n.observer)||void 0===L||L.setEnableVideo(!0);this.safeEmit(_P.ON_USER_START_VIDEO_CAPTURE,{userId:o})}else{var P,k,N,X;if(d.extvideo)null===(P=n.observer)||void 0===P||P.setExternalVideoSource(!0),null===(k=n.observer)||void 0===k||k.setPushVideo(!1);else null===(N=n.observer)||void 0===N||N.setExternalVideoSource(!1),null===(X=n.observer)||void 0===X||X.setEnableVideo(!1);!n.isScreen&&this.safeEmit(_P.ON_USER_STOP_VIDEO_CAPTURE,{userId:o})}var V,w;c&&!l&&t&&(null===(V=n.observer)||void 0===V||V.setRemoteUnmuteAudio(u));h&&!m&&i&&(null===(w=n.observer)||void 0===w||w.setRemoteUnmuteVideo(p));"number"==typeof d.videoType&&d.videoType!==a.videoType&&this.safeEmit(_P.VIDEO_TYPE_CHANGE,{userId:n.userId,isScreen:n.isScreen,type:d.videoType===ST.BLACK?dT.BLACK:dT.NORMAL})}_onPushTrack(e){var t;if(null===(t=e.streamId)||void 0===t||!t.startsWith("audio_mux"))return void this.config.report("rtc_error",{message:"onPushTrack, userId: ".concat(e.clientId,", ").concat(e.streamId),error_code:PL.TRACK_ERROR});const i=this._onAddStream(Yu(Yu({},e),{},{attributes:fG}),{needEmit:!1,fromSignal:!1,virtual:!0});i&&this._subscriber.subscribe4pushTrack(i,e).then((()=>{this.safeEmit(_P.SUBSCRIBE_PUSH_TRACK,{stream:i}),this._virtualStreams.push(i)})).catch((e=>{this.logger.error("subscribe","push track failed %o",e)}))}_onRemoveTrack(e){let{clientId:t,streamId:i,message:o,trackType:s}=e;this.logger.info("_onRemoveTrack","remove track: %o",t);const r=this._findRemoteStream(t,i);r&&(r.removeTrack=!0,this._subscriber.unsubscribe4removeTrack(r,o,s),this.emit(_P.REMOVE_PUSH_TRACK,{stream:r,mediaType:s+1}))}_onMeetingSpeakerChange(e){if(Array.isArray(null==e?void 0:e.speakerCsrcInfo)){const t={};null==e||e.speakerCsrcInfo.forEach((e=>{let{csrc:i,userId:o,isScreen:s}=e;s||(t[i]=o)})),this._csrcUserIdMap=t}Array.isArray(e.muxStreamInUse)&&this._virtualStreams.forEach((t=>{var i;null!==(i=e.muxStreamInUse)&&void 0!==i&&i.includes(t.streamId)?t.virtualOccupy=!0:t.virtualOccupy=!1}))}getActiveSpeakerInMultiChatMode(){const e=[];return this._virtualStreams.forEach((t=>{var i;const o=null===(i=t.audioTransceiver)||void 0===i?void 0:i.receiver;if(o){const[t]=o.getContributingSources()||[];if(t){const{audioLevel:i,source:o}=t;this._csrcUserIdMap[o]&&e.push({userId:this._csrcUserIdMap[o],audioLevel:i})}}})),e.length&&iT(e).call(e,((e,t)=>e.audioLevel-t.audioLevel)),e}_onReconnecting(){var e,t;for(const i of this._remoteStreams.values())Array.isArray(i)&&i.forEach((e=>{var t;null===(t=e.observer)||void 0===t||t.setDisconnect(),this._subscriber.cleanStream(e)}));this._virtualStreams.forEach((e=>{var t;this.emit(_P.REMOVE_PUSH_TRACK,{stream:e,mediaType:$u.AUDIO}),null===(t=e.observer)||void 0===t||t.setDisconnect(),this._subscriber.cleanStream(e)})),this._virtualStreams=[],null===(e=this.localStream)||void 0===e||null===(e=e.observer)||void 0===e||e.setDisconnect(),this._publisher.cleanStream(this.localStream),null===(t=this.localScreenStream)||void 0===t||null===(t=t.observer)||void 0===t||t.setDisconnect(),this._publisher.cleanStream(this.localScreenStream)}_onConnectionStateChange(e){e.state===th.CONNECTION_STATE_RECONNECTING?this._onReconnecting():e.state===th.CONNECTION_STATE_RECONNECTED&&this._roomJoin.join(!0)}_initStreamListeners(e){e.on("ontrack",(e=>{e.track})),e.on("onSEIMessage",(t=>{this.emit(_P.ON_SEI_MESSAGED_RECEIVED,{sei:t,remoteStreamKey:{userId:e.userId,roomId:this.config.roomId,streamIndex:e.isScreen?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN}})}))}_onCustomMessage(e){var t;null!==(t=this._subtitleTool)&&void 0!==t&&t.onMessageRecv(e)||this.safeEmit(hT.ON_CUSTOM_MESSAGE,e)}_onUserMessageReceived(e){this.safeEmit(hT.USER_MESSAGE_RECEIVED,{userId:e.from,message:e.msg})}_onUserBinaryMessageReceived(e){var t;const i={userId:e.from,message:e.msg};null!==(t=this._subtitleTool)&&void 0!==t&&t.onMessageRecv(i)||this.safeEmit(hT.USER_BINARY_MESSAGE_RECEIVED,i)}_initSubtitleTool(){this._subtitleTool=new LP(this._ctx,this.config),this._subtitleTool.onEvent=e=>{this.emit(_P.ON_SUBTITLE_STATE_CHANGED,e)},this._subtitleTool.onMessage=e=>{this.emit(_P.ON_SUBTITLE_MESSAGE_RECEIVED,e)}}_onPostProcessingMessage(e){if(!e.body)return;var t;if("subtitleCallback"===e.type)return void(null===(t=this._subtitleTool)||void 0===t||t.onResult(e));const i=e.body,o=i.error||0;let s=bP.START;const r=["success","parameter error","subscription timeout","ffmpeg error","cdn error","publish error"];if("2.0"===i.protocol){switch(i.eventType){case"TranscodeStarted":0!==i.error&&(s=bP.START_FAILED);break;case"TranscodeStateChanged":s=0!==i.error?bP.START_FAILED:bP.START_SUCCESS;break;case"TranscodeStopped":s=0!==i.error?bP.STOP_FAILED:bP.STOP_SUCCESS;break;case"TranscodeUpdated":s=0!==i.error?bP.UPDATE_FAILED:bP.UPDATE_SUCCESS}this.safeEmit(hT.POST_PROCESSING_MESSAGE,{code:o,protocol:i.protocol,error:i.error,eventType:s,message:r[o]})}this.safeEmit(hT.POST_PROCESSING_MESSAGE,{code:o,message:r[o],type:e.type})}_onUserTokenWillExpire(){this.safeEmit(hT.ON_USER_TOKEN_WILL_EXPIRE,null)}_onUserTokePublishPrivilegeWillExpire(){this.safeEmit(hT.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE,null)}_onUserTokenPublishPrivilegeDidExpire(){this.safeEmit(hT.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED,null)}_onUserTokeSubscribePrivilegeWillExpire(){this.safeEmit(hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE,null)}_onUserTokenSubscribePrivilegeDidExpire(){this.safeEmit(hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED,null)}async _onStreamFailed(e){if("publish"===e.type){var t,i;let o;if((null===(t=this.localStream)||void 0===t?void 0:t.streamId)===e.streamId?o=this.localStream:(null===(i=this.localScreenStream)||void 0===i?void 0:i.streamId)===e.streamId&&(o=this.localScreenStream),!o)return;await this._publisher.unpublish(o).catch((()=>{})),await this._publisher.cleanStream(o),await this._publisher.publish(o).catch((()=>{}))}else if("subscribe"===e.type){const t=this._remoteStreamStreamIdUserIdMap[e.streamId],i=this._findRemoteStream(t,e.streamId);if(i){const e=i.subMediaType,t=i.subLayer;await this._subscriber.unsubscribe(i),await this._subscriber.subscribe(i,e,t),this.safeEmit(_P.RESUBSCRIBE,{stream:i})}}}_onStreamControlMessage(e){var t,i;e.type===lT.PushLimitWarn&&(null!==(t=this._localStream)&&void 0!==t&&t.pubAudio||null!==(i=this._localStream)&&void 0!==i&&i.pubVideo||this.unpublish())}async _onPublishOnDemand(){var e,t,i;if(this._publishOnDemandItem&&!this._publishOnDemandBusy&&!1!==(null===(e=this._serverConfig)||void 0===e||null===(e=e.engine_VPM)||void 0===e||null===(e=e.ondemand)||void 0===e?void 0:e.enable)){if(null!==(t=this._localStream)&&void 0!==t&&t.videoTransceiver){this._publishOnDemandBusy=!0;const e=this._publishOnDemandItem;this._publishOnDemandItem=void 0;const t=[],i=this._localStream.stream.id,{sender:o}=this._localStream.videoTransceiver,s=o.getParameters();if(Wv(this._ctx.id,"sender.getParameters",JSON.stringify(s),0,i),Array.isArray(s.encodings)&&Array.isArray(e)){const o={};this.logger.info("_onPublishOnDemand exec","usedDescriptions: %o",e),e.forEach((e=>{var t;if(null!==(t=e.StreamIds)&&void 0!==t&&t.includes(i)){var s,r,n;const t=null!==(s=null===(r=e.Metadata)||void 0===r?void 0:r.VideoIndex)&&void 0!==s?s:0;let i=0;var a,d;if(null!==(n=this._ctx.serverConfig)&&void 0!==n&&n.e2eFeedback)i=Math.max(...Object.keys(null!==(a=null===(d=e.Metadata)||void 0===d?void 0:d.VideoKbpsHist)&&void 0!==a?a:{}).map((e=>Number(e))),0);o[t]={kbps:i}}}));const r=[...this._localStream.pubAttributes.videoDescriptions];s.encodings=s.encodings.map((e=>{if(e.rid){if(o[e.rid]){var i;e.active=!0;const t=null===(i=o[e.rid])||void 0===i?void 0:i.kbps;t&&(e.maxBitrate=1e3*ik(e.rid,t,r))}else e.active=!1;const s=Number(e.rid);t[s]=e.active}else{var s;const t=null===(s=o[0])||void 0===s?void 0:s.kbps;t&&(e.maxBitrate=1e3*ik(void 0,t,r))}return e})),this.config.report("rtc_invoke_status",{sdk_api_name:"onPublishOnDemand",message:JSON.stringify(s.encodings),error_code:0,stream_id:i,elapse:0}),this._ctx.videoProfile.activeSimStreams=t}this.logger.info("sender.setParameters()",JSON.stringify(s.encodings)),Wv(this._ctx.id,"sender.setParameters",JSON.stringify(s),0,i),await o.setParameters(s),this._publishOnDemandBusy=!1}else if(null===(i=this._localStream)||void 0===i||!i.videoTransceiver)return;this._onPublishOnDemand()}}_onRTT(e){const{StreamIds:t,Metadata:i}=e;if(null!=t&&t.length&&i){const e=t[0];this._ctx.streamRTT[e]={audio:i.audio_rtt,video:i.video_rtt}}}_onRSCP(e,t){!!e.find((e=>{var t,i;return null==e||null===(t=e.StreamIds)||void 0===t?void 0:t.includes(null===(i=this._localStream)||void 0===i||null===(i=i.stream)||void 0===i?void 0:i.id)}))&&(t?this._pubTransceiverReady=!0:this._onceTriggerBySignal=!0,t&&this._onceTriggerBySignal||(this._publishOnDemandItem=e),this._pubTransceiverReady&&this._onPublishOnDemand())}_onSSC(e){const{StreamIds:t,Metadata:i}=e,o=t[0],s=this._remoteStreamStreamIdUserIdMap[o],r=this._findRemoteStream(s,o),n={userId:s,isScreen:!!r&&r.isScreen,beforeVideoIndex:i.ssc_items[0].prev_layer_id,afterVideoIndex:i.ssc_items[0].cur_layer_id,beforeEnable:0!==i.ssc_items[0].prev_video_open,afterEnable:0!==i.ssc_items[0].cur_video_open,reason:i.ssc_items[0].change_reason};this.emit(_P.ON_SIMULCAST_SUBSCRIBE_FALLBACK,n)}_reportNetworkQuality(e,t){this.emit(_P.ON_NETWORK_QUALITY,e,t)}_emitVideoSizeChange(e,t,i,o){this.emit(_P.ON_REMOTE_VIDEO_SIZE_CHANGED,{roomId:this.config.roomId,userId:e,streamIndex:t?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN},{width:i,height:o})}async setAudioEncodeMaxBitrate(e,t){const i=e===qu.STREAM_INDEX_MAIN?this.localStream:this.localScreenStream;if(null!=i&&i.pubAudio){var o;const e=null===(o=i.audioTransceiver)||void 0===o?void 0:o.sender.getParameters();var s;if(Wv(this._ctx.id,"sender.getParameters",JSON.stringify(e),0,i.streamId),null!=e&&e.encodings.length)e.encodings[0].maxBitrate=1e3*t,Wv(this._ctx.id,"sender.setParameters",JSON.stringify(e),0,i.streamId),await(null===(s=i.audioTransceiver)||void 0===s?void 0:s.sender.setParameters(e))}}_onEngineControlMessage(e){let{type:t,body:i}=e;if(t===uT.CHANGE_CODEC){if(!vy("SDK_CODEC_NEGOTIATION"))return void this.logger.info("_onEngineControlMessage","SDK_CODEC_NEGOTIATION is false, ignore");const{codec:e,media:t,streamId:n}=i;if(!t||"audio"===t)return;const a=e.split(",").map((e=>dm(e).call(e).toUpperCase()));let d;var o,s,r;if(this.logger.info("_onEngineControlMessage","changeCodec to %s",e),n)(null===(o=this.localStream)||void 0===o?void 0:o.streamId)===n?d=this.localStream:(null===(s=this.localScreenStream)||void 0===s?void 0:s.streamId)===n&&(d=this.localScreenStream),null===(r=d)||void 0===r||r.setChangeCodecs(a);else"video"===t?(d=this.localStream,this._ctx.targetCodec=a[0]):"screen"===t&&(d=this.localScreenStream,this._ctx.targetScreenCodec=a[0]);d&&this.emit(_P.UPDATE_PUBLISH,{streamIndex:d.isScreen?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN})}}}yG([jP],gG.prototype,"publishScreen",1),yG([jP],gG.prototype,"updatePubScreenTrack",1),yG([jP],gG.prototype,"unpublishScreen",1),yG([jP],gG.prototype,"liveControlMessage",1),yG([jP],gG.prototype,"publicStreamControlMessage",1),yG([jP],gG.prototype,"updateUserAttributes",1),yG([jP],gG.prototype,"publish",1),yG([jP],gG.prototype,"updatePubTrack",1),yG([jP],gG.prototype,"unpublish",1),yG([jP],gG.prototype,"subscribe",1),yG([jP],gG.prototype,"updateSubVideoConfig",1),yG([jP],gG.prototype,"unsubscribe",1),yG([jP],gG.prototype,"startSubtitle",1),yG([jP],gG.prototype,"stopSubtitle",1),yG([jP],gG.prototype,"startForwardStream2Rooms",1),yG([jP],gG.prototype,"updateForwardStream2Rooms",1),yG([jP],gG.prototype,"stopForwardStream2Rooms",1),yG([jP],gG.prototype,"pauseForwardStream2AllRooms",1),yG([jP],gG.prototype,"resumeForwardStream2AllRooms",1),yG([jP],gG.prototype,"updateMediaParams",1),yG([jP],gG.prototype,"updateRemoteUserPriority",1),yG([jP],gG.prototype,"updateToken",1),yG([jP],gG.prototype,"sendUserMessage",1),yG([jP],gG.prototype,"sendRoomMessage",1),yG([jP],gG.prototype,"maybeFillBackFrame2Stream",1);const TG=async(e,t)=>{const i=new Audio(tL.createObjectURL(new Blob([e],t)));try{return i.muted=!0,await i.play(),i.pause(),!0}catch(o){return!1}};var IG=Object.defineProperty,RG=Object.getOwnPropertyDescriptor,EG=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?RG(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&IG(t,i,r),r};class CG{constructor(e,t){Ou(this,"_sharedAudioContext",new AudioContext),Ou(this,"_workletReady",void 0),Ou(this,"_audioDestination",this._sharedAudioContext.createMediaStreamDestination()),Ou(this,"_localGainNode",this._sharedAudioContext.createGain()),Ou(this,"_bufferGainNode",this._sharedAudioContext.createGain()),Ou(this,"_audioBufferSource",void 0),Ou(this,"_localSource",void 0),Ou(this,"_context",void 0),Ou(this,"_failedAudioList",[]),Ou(this,"_startingIds",new Map),Ou(this,"_revokeURLs",new Set),Ou(this,"_audioFetchMap",new Map),Ou(this,"_audioFetchConfig",new Map),Ou(this,"mixingMap",new Map),Ou(this,"resourcesCache",new Map),Ou(this,"volumeConfig",new Map),Ou(this,"cachedBuffer",[]),Ou(this,"id","AudioMixingManager"),this.engineId=t,this._context=e;try{var i,o;this._workletReady=null===(i=this._sharedAudioContext.audioWorklet)||void 0===i||null===(o=i.addModule)||void 0===o?void 0:o.call(i,TL),this._workletReady.catch((()=>{this._workletReady=null}))}catch(s){this._workletReady=null}this._localGainNode.gain.value=1}mixMediaStream(e){this._localSource&&this._localSource.disconnect(this._localGainNode),this._localSource=this._sharedAudioContext.createMediaStreamSource(e),this._localSource.connect(this._localGainNode).connect(this._audioDestination)}async startAudioMixing(e,t,i){if(void 0!==this._startingIds.get(e))return void console.warn("AudioMixing task id: ".concat(e," is starting"));this._startingIds.set(e,e);const{playCount:o,type:s}=i;BS(s,"mixingType",VP(Nh));const r=this._context.getLocalAudioTrack();if(!r)return;const n=r.preprocessingTrack;n&&this.mixMediaStream(new MediaStream([n])),r.once("needReplaceTrack",(()=>{this.mixMediaStream(new MediaStream([r.preprocessingTrack]))}));const a=this.mixingMap.get(e);if(null!=a&&a.audioNode){a.audioNode.pause(),this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_STOPPED,error:FS.AUDIO_MIXING_ERROR_OK});try{a.gainNode.disconnect(this._audioDestination),a.audioSource.disconnect(a.gainNode)}catch(m){}}let d;const c=this.resourcesCache.get(e);if(c&&c.filePath===t)d=c.getAudioNode();else{const i=await fetch(t,{mode:"cors"}).then((t=>{if(t.ok)return t.arrayBuffer();throw this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_FAILED,error:FS.AUDIO_MIXING_ERROR_START_FAILED}),this._startingIds.delete(e),this.mixingMap.delete(e),new HS(US.LOAD_RESOURCES_FAILED,t.statusText)}));let o;t.endsWith("mp3")?o={type:"audio/mpeg"}:t.endsWith("aac")&&(o={type:"audio/aac"});if(!(await TG(i,o)))throw this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_FAILED,error:FS.AUDIO_MIXING_ERROR_START_FAILED}),this._startingIds.delete(e),this.mixingMap.delete(e),new HS(US.LOAD_RESOURCES_FAILED,"invalid audio resource");d=new Audio,d.crossOrigin="anonymous",d.src=tL.createObjectURL(new Blob([i],o))}if(o<=0)d.loop=!0;else if(o>0){let t=o;d.onended=()=>{--t>0?d.play():(this.mixingMap.delete(e),this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_FINISHED,error:FS.AUDIO_MIXING_ERROR_OK}))}}try{await d.play()}catch(m){console.error(m),this._failedAudioList.push(d),this._context.onAutoPlayFailed({userId:this.id,kind:"audio",streamIndex:qu.STREAM_INDEX_MAIN,mediaType:$u.AUDIO})}this._startingIds.delete(e);const l=this._sharedAudioContext.createMediaElementSource(d),u=this._sharedAudioContext.createGain(),h=this.volumeConfig.get(e);if(u.gain.value=h?h/100:1,l.connect(u).connect(this._audioDestination),this.mixingMap.set(e,{audioSource:l,audioNode:d,gainNode:u,type:"file"}),s===Nh.PUBLISH)try{u.disconnect(this._sharedAudioContext.destination)}catch(m){}else u.connect(this._sharedAudioContext.destination);this._context.updateLocalAudioTrack(this._audioDestination.stream.getAudioTracks()[0],i.type),this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_PLAYING,error:FS.AUDIO_MIXING_ERROR_OK}),this.updateFetcher(e)}stopAudioMixing(e){const t=this.mixingMap.get(e);t&&"file"===t.type&&(this.mixingMap.delete(e),t.audioNode.pause(),t.audioSource.disconnect(t.gainNode),t.gainNode.disconnect(this._audioDestination),this.updateFetcher(e),this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_STOPPED,error:FS.AUDIO_MIXING_ERROR_OK}))}pauseAudioMixing(e){const t=this.mixingMap.get(e);t&&(this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_PAUSED,error:FS.AUDIO_MIXING_ERROR_OK}),t.audioNode.pause())}resumeAudioMixing(e){const t=this.mixingMap.get(e);t&&(this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_PLAYING,error:FS.AUDIO_MIXING_ERROR_OK}),t.audioNode.play())}async preloadAudioMixing(e,t){this.stopAudioMixing(e);const i=await fetch(t,{mode:"cors"}).then((e=>{if(e.ok)return e.arrayBuffer();throw new HS(US.LOAD_RESOURCES_FAILED,e.statusText)})).catch((t=>{if(this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_FAILED,error:FS.AUDIO_MIXING_ERROR_PRELOAD_FAILED}),t instanceof HS)throw t;throw new HS(US.LOAD_RESOURCES_FAILED,"Load resources failed",t)}));let o;t.endsWith("mp3")?o={type:"audio/mpeg"}:t.endsWith("aac")&&(o={type:"audio/aac"});if(!(await TG(i,o)))throw this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_FAILED,error:FS.AUDIO_MIXING_ERROR_PRELOAD_FAILED}),new HS(US.LOAD_RESOURCES_FAILED,"Load resources failed");this._context.emitMessage({mixId:e,state:Xh.AUDIO_MIXING_STATE_PRELOADED,error:FS.AUDIO_MIXING_ERROR_OK}),this.resourcesCache.set(e,{getAudioNode:()=>{const e=tL.createObjectURL(new Blob([i],o));return this._revokeURLs.add(e),new Audio(e)},filePath:t,duration:0}),await new Promise((t=>{const s=tL.createObjectURL(new Blob([i],o)),r=new Audio(s);r.addEventListener("durationchange",(()=>{const i=this.resourcesCache.get(e);i&&(i.duration=r.duration,this.resourcesCache.set(e,i)),tL.revokeObjectURL(s),t(null)}))}))}unloadAudioMixing(e){this.resourcesCache.has(e)&&this.resourcesCache.delete(e)}getAudioMixingVolume(e){const t=this.mixingMap.get(e);return t?100*t.gainNode.gain.value:0}setAudioMixingVolume(e,t){t<0?t=0:t>400&&(t=400),this.volumeConfig.set(e,t);const i=this.mixingMap.get(e);i&&(i.gainNode.gain.value=Number(t)/100)}getAudioMixingDuration(e){const t=this.mixingMap.get(e),i=this.resourcesCache.get(e);return t||i?t?1e3*t.audioNode.duration:i?1e3*i.duration:0:0}getAudioMixingCurrentPosition(e){const t=this.mixingMap.get(e);return t?1e3*t.audioNode.currentTime:0}setAudioMixingPosition(e,t){const i=this.mixingMap.get(e);i&&(i.audioNode.currentTime=t/1e3,i.audioNode.play())}setAudioFrameCallback(e,t){var i;let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4096;if(BS(o,"frameSize",[256,512,1024,2048,4096,8192,16384]),o=null!==(i=o)&&void 0!==i?i:4096,null===this._workletReady)throw new HS(US.NOT_SUPPORTED,"Not support AudioWorklet");t?this._audioFetchConfig.set(e,{callback:t,frameSize:o}):this._audioFetchConfig.delete(e),this.updateFetcher(e)}updateFetcher(e){var t,i;const{callback:o,frameSize:s}=null!==(t=this._audioFetchConfig.get(e))&&void 0!==t?t:{},r=null===(i=this.mixingMap.get(e))||void 0===i?void 0:i.gainNode;if(r&&o&&s){let t=this._audioFetchMap.get(e);t?t.setFrameSize(s):t=new EL(r,s,this._sharedAudioContext,this._workletReady),t.on("data",o),this._audioFetchMap.set(e,t)}else{const t=this._audioFetchMap.get(e);null==t||t.removeAllListeners("data"),null==t||t.destroy(),this._audioFetchMap.delete(e)}}enableAudioMixingBuffer(e){BS(e,"type",VP(Nh));const t=this._context.getLocalAudioTrack();if(!t)return;const i=t.preprocessingTrack;if(i&&this.mixMediaStream(new MediaStream([i])),e===Nh.PUBLISH)try{this._bufferGainNode.disconnect(this._sharedAudioContext.destination)}catch(o){}else this._bufferGainNode.connect(this._sharedAudioContext.destination);this._context.updateLocalAudioTrack(this._audioDestination.stream.getAudioTracks()[0],e),this._bufferGainNode.connect(this._audioDestination),this._context.emitMessage({mixId:-1,state:Xh.AUDIO_MIXING_STATE_PCM_ENABLED,error:FS.AUDIO_MIXING_ERROR_OK})}disableAudioMixingBuffer(){if(this.cachedBuffer=[],this._audioBufferSource){try{this._audioBufferSource.onended=null,this._audioBufferSource.disconnect(this._bufferGainNode),this._bufferGainNode.disconnect(this._audioDestination),this._bufferGainNode.disconnect(this._sharedAudioContext.destination)}catch(e){}finally{this._audioBufferSource=void 0}this._context.updateLocalAudioTrack(),this._context.emitMessage({mixId:-1,state:Xh.AUDIO_MIXING_STATE_PCM_DISABLED,error:FS.AUDIO_MIXING_ERROR_OK})}}pushAudioMixingBuffer(e){if(!(this._audioBufferSource&&(this.cachedBuffer.push(e),this.cachedBuffer.length>0))){this._audioBufferSource=this._sharedAudioContext.createBufferSource(),this._audioBufferSource.buffer=e,this._audioBufferSource.connect(this._bufferGainNode);try{this._audioBufferSource.start()}catch(t){this._failedAudioList.push(this._audioBufferSource)}this._audioBufferSource.onended=()=>{var e;if(null===(e=this._audioBufferSource)||void 0===e||e.disconnect(this._bufferGainNode),this._audioBufferSource=void 0,this.cachedBuffer.length){const e=this.cachedBuffer.shift();e&&this.pushAudioMixingBuffer(e)}}}}stopAll(){if(this._localSource)try{this._localSource.disconnect(this._localGainNode),delete this._localSource}catch(e){}this.mixingMap.forEach(((e,t)=>{this.stopAudioMixing(t)}))}get mixTrack(){return this._audioDestination.stream.getAudioTracks()[0]}get sharedAudioContext(){return this._sharedAudioContext}async resumeLocalPlay(){const e=[];for(const i of this._failedAudioList)try{i instanceof HTMLAudioElement?(i.muted=!1,await i.play()):i.start()}catch(t){e.push(i),console.error(t),this._context.onAutoPlayFailed({userId:this.id,kind:"audio",streamIndex:qu.STREAM_INDEX_MAIN,mediaType:$u.AUDIO});break}this._failedAudioList=e}destroy(){const{_sharedAudioContext:e}=this;"closed"!==e.state&&"function"==typeof e.close&&e.close(),this.cachedBuffer=[],this.mixingMap.clear(),this.resourcesCache.clear(),this.volumeConfig.clear(),this._startingIds=new Map,this._revokeURLs.forEach((e=>{tL.revokeObjectURL(e)}))}}EG([wv(["id","filePath","options"])],CG.prototype,"startAudioMixing",1),EG([wv(["id"])],CG.prototype,"stopAudioMixing",1),EG([wv(["id"])],CG.prototype,"pauseAudioMixing",1),EG([wv(["id"])],CG.prototype,"resumeAudioMixing",1),EG([wv(["id"])],CG.prototype,"preloadAudioMixing",1),EG([wv(["id"])],CG.prototype,"unloadAudioMixing",1),EG([wv(["id"])],CG.prototype,"getAudioMixingVolume",1),EG([wv(["id","volume"])],CG.prototype,"setAudioMixingVolume",1),EG([wv(["id"])],CG.prototype,"getAudioMixingDuration",1),EG([wv(["id"])],CG.prototype,"getAudioMixingCurrentPosition",1),EG([wv(["id","position"])],CG.prototype,"setAudioMixingPosition",1),EG([wv(["id","callback","frameSize"])],CG.prototype,"setAudioFrameCallback",1),EG([wv(["type"])],CG.prototype,"enableAudioMixingBuffer",1),EG([wv()],CG.prototype,"disableAudioMixingBuffer",1),EG([wv(["buffer"])],CG.prototype,"pushAudioMixingBuffer",1);class ZG extends sT.EventEmitter{constructor(e){super(),Ou(this,"_loginSessionId",null),Ou(this,"_userId",null),Ou(this,"_token",null),Ou(this,"_loginResolveCallback",void 0),Ou(this,"_loginRejectCallback",void 0),Ou(this,"_waitLoginToken",!1),Ou(this,"_serverParamsCache",void 0),Ou(this,"id",void 0),Ou(this,"logger",void 0),Ou(this,"_clearListeners",void 0),this._ctx=e,this.id=e.id,this.logger=new eS("RTSClient",1,e.id)}login(e,t){return new Promise(((i,o)=>{var s;if(this.logger.info("login","invoke login, token: %o, userId: %o",e,t),this._loginSessionId)throw new HS(US.ALREADY_LOGIN,"Already logined");if(this._loginResolveCallback)throw new HS(US.LOGIN_FAILED,"Is logging in, please try again later.");this._userId=t,this._token=e,null===(s=Nv(this.id))||void 0===s||s.set({rtm_user_id:t}),this._loginResolveCallback=i,this._loginRejectCallback=o,this._ctx.signalingManager.connect().then((()=>{this._addSignalEventHandler(),this._login()}))}))}async logout(){if(!this._loginSessionId||!this._userId)throw new HS(US.NOT_LOGIN,"login first");this._checkNotInLimitMode("logout"),await this._ctx.signalingManager.sendSignaling("logout",{loginSessionId:this._loginSessionId,userId:this._userId,appId:this._ctx.appId},{functionType:UP.C2RTM}).catch((()=>{})),this._clearState()}async updateLoginToken(e){return this._checkNotInLimitMode("updateLoginToken"),this._token=e,new Promise(((e,t)=>{this._waitLoginToken?(this._loginResolveCallback=e,this._loginRejectCallback=t,this._login()):e()}))}async getPeerOnlineStatus(e){if(!this._loginSessionId||!this._userId)throw new HS(US.NOT_LOGIN,"login first");this._checkNotInLimitMode("getPeerOnlineStatus");const t=await this._ctx.signalingManager.sendSignaling("getPeerOnlineStatus",{loginSessionId:this._loginSessionId,userId:this._userId,appId:this._ctx.appId,peerUserId:e},{functionType:UP.C2RTM});return null==t?void 0:t.status}async sendUserMessageOutsideRoom(e,t){if(!this._loginSessionId||!this._userId)throw new HS(US.NOT_LOGIN,"login first");return this._checkNotInLimitMode("sendUserMessageOutsideRoom"),this._ctx.rtsLimiter.e2e.check(t),this._ctx.signalingManager.sendP2PMessage({from:this._userId,app:this._ctx.appId,to:e,room:"",msg:t})}async setRTSMessageLimit(e){e&&this._ctx.signalingManager.sendSignaling("RTSMessageLimit",{appId:this._ctx.appId,interval:e.rts_qps_interval,broadcast:e.rts_broadcast_qps_value,one2one:e.rts_e2e_qps_value,e2bs:e.rts_e2s_qps_value},{functionType:UP.C2RTM}).catch((()=>{}))}async setServerParams(e,t){try{if(QS(e,"signature"),QS(t,"url"),!this._loginSessionId||!this._userId)throw new HS(US.NOT_LOGIN,"login first");await this._ctx.signalingManager.sendSignaling("setServerParams",{loginSessionId:this._loginSessionId,userId:this._userId,appId:this._ctx.appId,signature:e,url:t},{functionType:UP.C2RTM}).catch((e=>{throw new HS(US.UNEXPECTED_ERROR,e.msg)})),av(this.id,t),this._serverParamsCache={signature:e,url:t},this.emit("onServerParamsSetResult")}catch(i){throw this.emit("onServerParamsSetResult",i),i}}async sendServerMessage(e){if(!this._loginSessionId||!this._userId)throw new HS(US.NOT_LOGIN,"login first");return this._checkNotInLimitMode("sendServerMessage"),this._ctx.rtsLimiter.e2s.check(e),this._ctx.signalingManager.sendP2PMessage({from:this._userId,app:this._ctx.appId,to:"",room:"",type:MP.BUSINESS_SERVER,msg:e})}destroy(){this.logger.info("destroy","invoke."),super.removeAllListeners(),this._loginResolveCallback&&this._loginRejectCallback&&(this._loginRejectCallback(new HS(US.LOGIN_FAILED,"logout")),delete this._loginResolveCallback,delete this._loginRejectCallback),this._clearState(),delete this._serverParamsCache}_login(){var e;if(!this._userId)return;const t=Vy();try{this._checkNotInLimitMode("login")}catch(o){var i;null===(i=this._loginRejectCallback)||void 0===i||i.call(this,o)}this._ctx.signalingManager.sendSignaling("login",{Token:Gy.token2auth(this._ctx.appId,null,this._userId,this._token),timestamp:Date.now(),loginSessionId:t,params:{userAgent:window.navigator.userAgent,sdkVersion:_y.VERSION,deviceId:DS.getDeviceId(),appId:this._ctx.appId,userId:this._userId,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(e=_y.MEDIA_PROCESSING_TYPE)&&void 0!==e?e:0}},{functionType:UP.C2RTM}).then((()=>{"function"==typeof this._loginResolveCallback&&this._loginResolveCallback(),this._loginSessionId=t,cv(this.id,t),this._waitLoginToken=!1,this._serverParamsCache&&this.setServerParams(this._serverParamsCache.signature,this._serverParamsCache.url)})).catch((e=>{const{code:t,message:i}=e||{};let o,s;this._waitLoginToken=!1,t>=700&&t<800?708===t?(o=US.INVALID_PARAMS,s="Invalid userId"):(o=US.INVALID_TOKEN,s="Invalid token",this._waitLoginToken=!0,this._loginRejectCallback||this.emit("onRTMTokenError")):(o=US.LOGIN_FAILED,s="login failed"),"function"==typeof this._loginRejectCallback&&this._loginRejectCallback(new HS(o,i||s))})).finally((()=>{delete this._loginResolveCallback,delete this._loginRejectCallback}))}_addSignalEventHandler(){const e=e=>{e.state===th.CONNECTION_STATE_RECONNECTED&&this._login()},t=()=>this._clearState(),i=e=>{this.emit("onUserMessageReceivedOutsideRoom",{userId:e.from,message:e.msg})},o=e=>{this.emit("onUserBinaryMessageReceivedOutsideRoom",{userId:e.from,message:e.msg})},s=e=>{e.clientId!==this._userId||e.roomId||(this.emit("onUserDisconnection"),this._clearState())};this._ctx.signalingManager.on(pT.ON_CONNECTION_STATE_CHANGE,e),this._ctx.signalingManager.on(pT.ON_RECONNECT_FAILED,t),this._ctx.signalingManager.on(hT.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM,i),this._ctx.signalingManager.on(hT.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM,o),this._ctx.signalingManager.on(hT.USER_DISCONNECTION,s),this._clearListeners=()=>{this._ctx.signalingManager.off(pT.ON_CONNECTION_STATE_CHANGE,e),this._ctx.signalingManager.off(pT.ON_RECONNECT_FAILED,t),this._ctx.signalingManager.off(hT.USER_MESSAGE_RECEIVED_OUTSIDE_ROOM,i),this._ctx.signalingManager.off(hT.USER_BINARY_MESSAGE_RECEIVED_OUTSIDE_ROOM,o),this._ctx.signalingManager.off(hT.USER_DISCONNECTION,s)}}_clearState(){var e;null===(e=this._clearListeners)||void 0===e||e.call(this),this._userId=null,this._token=null,this._loginSessionId=null,cv(this.id,"")}_checkNotInLimitMode(e){if(this._ctx.rtsMode===vT.LIMIT_MODE)throw new HS(US.NOT_ALLOWED_IN_RESTRICTED_MODE,"not allow to call ".concat(e," in rts restricted mode"))}}var LG=(e=>(e.onWTNPushStateChanged="onWTNPushStateChanged",e.onWTNPlayStateChanged="onWTNPlayStateChanged",e.onWTNRemoteAudioStateChanged="onWTNRemoteAudioStateChanged",e.onWTNRemoteVideoStateChanged="onWTNRemoteVideoStateChanged",e.onWTNRemoteVideoStats="onWTNRemoteVideoStats",e.onWTNRemoteAudioStats="onWTNRemoteAudioStats",e.onWTNFirstRemoteVideoFrameDecoded="onWTNFirstRemoteVideoFrameDecoded",e.onWTNSEIMessageReceived="onWTNSEIMessageReceived",e))(LG||{}),PG=(e=>(e[e.INIT=0]="INIT",e[e.START=1]="START",e[e.SUCCESS=2]="SUCCESS",e[e.STOP=3]="STOP",e[e.FAIL=4]="FAIL",e))(PG||{}),kG=(e=>(e[e.PUSH_SUCCESS=0]="PUSH_SUCCESS",e[e.START_PUSH=1]="START_PUSH",e[e.STOP_PUSH=2]="STOP_PUSH",e[e.IN_RETRY=3]="IN_RETRY",e[e.RETRY_FAIL=4]="RETRY_FAIL",e[e.NO_PUSH_PERMISSION=5]="NO_PUSH_PERMISSION",e[e.STREAM_PUSH_BY_OTHER=6]="STREAM_PUSH_BY_OTHER",e))(kG||{}),NG=(e=>(e[e.INIT=0]="INIT",e[e.START=1]="START",e[e.SUCCESS=2]="SUCCESS",e[e.STOP=3]="STOP",e[e.FAIL=4]="FAIL",e))(NG||{}),XG=(e=>(e[e.PLAY_SUCCESS=0]="PLAY_SUCCESS",e[e.START_PLAY=1]="START_PLAY",e[e.STOP_PLAY=2]="STOP_PLAY",e[e.REMOTE_STOP=3]="REMOTE_STOP",e[e.REMOTE_FAILURE=4]="REMOTE_FAILURE",e[e.STREAM_BANNED=5]="STREAM_BANNED",e[e.NO_PLAY_PERMISSION=6]="NO_PLAY_PERMISSION",e[e.STREAM_NOT_EXIST=7]="STREAM_NOT_EXIST",e[e.IN_RETRY=8]="IN_RETRY",e[e.RETRY_FAIL=9]="RETRY_FAIL",e[e.INTERNAL=10]="INTERNAL",e[e.OVER_CLIENT_SUBSCRIBE_STREAM_LIMIT=1310]="OVER_CLIENT_SUBSCRIBE_STREAM_LIMIT",e[e.OVER_STREAM_SUBSCRIBE_USER_LIMIT=1311]="OVER_STREAM_SUBSCRIBE_USER_LIMIT",e[e.OVER_STREAM_SUBSCRIBE_REQUES_TLIMIT=1312]="OVER_STREAM_SUBSCRIBE_REQUES_TLIMIT",e))(XG||{}),VG=(e=>(e[e.STOPED=0]="STOPED",e[e.STARTING=1]="STARTING",e[e.DECODING=2]="DECODING",e[e.FROZEN=3]="FROZEN",e[e.FAILED=4]="FAILED",e))(VG||{}),wG=(e=>(e[e.INTERNAL=0]="INTERNAL",e[e.NETWORK_CONGESTION=1]="NETWORK_CONGESTION",e[e.NETWORK_RECOVERY=2]="NETWORK_RECOVERY",e[e.UNMUTE=3]="UNMUTE",e[e.MUTE=4]="MUTE",e[e.REMOTE_START=5]="REMOTE_START",e[e.REMOTE_STOP=6]="REMOTE_STOP",e))(wG||{}),xG=(e=>(e[e.STOPED=0]="STOPED",e[e.STARTING=1]="STARTING",e[e.DECODING=2]="DECODING",e[e.FROZEN=3]="FROZEN",e[e.FAILED=4]="FAILED",e))(xG||{}),GG=(e=>(e[e.INTERNAL=0]="INTERNAL",e[e.NETWORK_CONGESTION=1]="NETWORK_CONGESTION",e[e.NETWORK_RECOVERY=2]="NETWORK_RECOVERY",e[e.UNMUTE=3]="UNMUTE",e[e.MUTE=4]="MUTE",e[e.REMOTE_START=5]="REMOTE_START",e[e.REMOTE_STOP=6]="REMOTE_STOP",e))(GG||{});const WG={interval:1e3,retryDuration:0};class MG extends mP{constructor(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(i,bL.STREAM_INDEX_MAIN),Ou(this,"_state",PG.INIT),Ou(this,"_stateChangeTs",wy()),Ou(this,"streamId",void 0),Ou(this,"Authorization",void 0),Ou(this,"_backOff",WG),this.token=t,this.streamId=e,this.logName="WTNLocalStream-".concat(e),this.observer=new gP(this._ctx,this),this.Authorization=Gy.token2auth(i.appId,"",e,t),this._state=o?PG.FAIL:PG.INIT}setState(e,t){const i=this._state;if(i===e)return;this.logger.print("setState",e,t),this._state=e;const o=wy();this.safeEmit(LG.onWTNPushStateChanged,{streamId:this.streamId,oldState:i,newState:e,reason:t,elapse:o-this._stateChangeTs}),this._stateChangeTs=o}getPushBackOff(){return this._backOff}updatePushBackOff(){this._backOff.retryDuration+=this._backOff.interval,this._backOff.interval=this._backOff.interval>4e3?8e3:2*this._backOff.interval}resetPushBackOff(){this._backOff=WG}}class AG extends pP{constructor(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(i,e,e,!1,!0,{audiostream:!0,localaudio:!0,videostream:!0,localvideo:!0,extaudio:!1,extvideo:!1,videoDescriptions:[]}),Ou(this,"_state",NG.INIT),Ou(this,"Authorization",void 0),Ou(this,"_stateChangeTs",wy()),Ou(this,"streamId",void 0),Ou(this,"_backOff",WG),Ou(this,"_audioState",VG.STOPED),Ou(this,"_videoState",xG.STOPED),this.token=t,this.streamId=e,this.logName="WTNRemoteStream-".concat(e),this.observer=new fP(this._ctx,this),this._initObserverEvent(o),this.Authorization=Gy.token2auth(i.appId,"",e,t),this._state=o?NG.FAIL:NG.INIT}setState(e,t){const i=this._state;if(i===e)return;this.logger.print("setState",e,t),this._state=e;const o=wy();this.safeEmit(LG.onWTNPlayStateChanged,{streamId:this.streamId,oldState:i,newState:e,reason:t,elapse:o-this._stateChangeTs}),this._stateChangeTs=o}get state(){return this._state}getPushBackOff(){return this._backOff}updatePushBackOff(){this._backOff.retryDuration+=this._backOff.interval,this._backOff.interval=this._backOff.interval>4e3?8e3:2*this._backOff.interval}resetPushBackOff(){this._backOff=WG}setVideoState(e,t){this._videoState!==e&&(e===xG.DECODING&&this.setVideoState(xG.STARTING,t),this.logger.print("setVideoState",e,t),this._videoState=e,this.safeEmit(LG.onWTNRemoteVideoStateChanged,{streamId:this.streamId,state:e,reason:t}))}setAudioState(e,t){this._audioState!==e&&(e===VG.DECODING&&this.setAudioState(VG.STARTING,t),this.logger.print("setAudioState",e,t),this._audioState=e,this.safeEmit(LG.onWTNRemoteAudioStateChanged,{streamId:this.streamId,state:e,reason:t}))}muteToSubMediaType(e,t){let i=!1;const o=Ky(this.subMediaType),s=Uy(this.subMediaType);return"boolean"==typeof e&&o===e&&(this.subMediaType+=e?-$u.AUDIO:$u.AUDIO,i=!0),"boolean"==typeof t&&s===t&&(this.subMediaType+=t?-$u.VIDEO:$u.VIDEO,i=!0),i}getEnableMediaType(){return{audio:Ky(this.subMediaType),video:Uy(this.subMediaType)}}_initObserverEvent(e){var t,i;null===(t=this.observer)||void 0===t||t.once("recvAudioFirstFrame",(()=>{this.setAudioState(VG.DECODING,e?wG.NETWORK_RECOVERY:wG.REMOTE_START)})),null===(i=this.observer)||void 0===i||i.once("recvVideoFirstFrame",(()=>{this.setVideoState(xG.DECODING,e?GG.NETWORK_RECOVERY:GG.REMOTE_START)}))}}const OG=["rid"];var DG=Object.defineProperty,YG=Object.getOwnPropertyDescriptor,KG=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?YG(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&DG(t,i,r),r};class UG extends aT{constructor(e){super(),Ou(this,"_reportName","WTNStream"),Ou(this,"_localStreams",new Map),Ou(this,"_remoteStreams",new Map),Ou(this,"_logger",void 0),Ou(this,"_monitor",void 0),Ou(this,"_ontrackCallbackMap",new Map),Ou(this,"engineId",void 0),Ou(this,"_publicVideoPlayerConfig",new Map),Ou(this,"__onSEIMessageReceived",void 0),Ou(this,"__onRemoteStreamStats",void 0),Ou(this,"__onResubscribe",void 0),Ou(this,"__onPlayerEvents",void 0),Ou(this,"_clearSignalListeners",void 0),this._ctx=e,this._monitor=Nv(e.id),this._logger=new eS("WTNStream",1,e.id),this.engineId=e.id,this._addSignalListeners()}async startPushWTN(e,t,i,o){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(i=!!i,o=!!o,this._logger.print("startPushWTN",e,t,i,o),ry(t),!iy(e)&&QS(e,"token"),this._localStreams.get(t))return;const r=new MG(t,e,this._ctx,s);this._addLocalStreamEventHandler(r),r.setState(PG.START,kG.START_PUSH),this._localStreams.set(t,r),await this._ctx.signalingManager.connect(),r.videoTrack=this._ctx.localVideoTrack,r.audioTrack=this._ctx.localAudioTrack,r.pubAudio=!o,r.pubVideo=!i,await this._sendStartPushStreamSignal(r),r.startReport((()=>{}),this._ctx.handler)}async stopPushWTN(e){this._logger.print("stopPushWTN",e);const t=this._localStreams.get(e);t&&(t.setState(PG.STOP,kG.STOP_PUSH),this._ctx.signalingManager.sendSignaling("stopPushStream",{appId:this._ctx.appId,streamId:e}).catch((()=>{})),await this._stopLocalStream(t))}async muteWTNLocalAudio(e,t){this._logger.print("muteWTNLocalAudio",e,t);const i=this._localStreams.get(e);if(!i)throw new HS(US.INVALID_PARAMS,"streamId not found");this._assertNotConnect(),i.pubAudio=!t,await this._updatePushStream(i)}async muteWTNLocalVideo(e,t){this._logger.print("muteWTNLocalVideo",e,t);const i=this._localStreams.get(e);if(!i)throw new HS(US.INVALID_PARAMS,"streamId not found");this._assertNotConnect(),i.pubVideo=!t,await this._updatePushStream(i)}sendWTNSEIMessage(e,t,i){this._logger.info("sendWTNSEIMessage()","streamId: %o, sei: %o, repeatCount: %o",e,t,i);const o=this._localStreams.get(e);if(!o||!o.pubVideo&&!o.pubAudio)return;if(!DT()&&!OT())return zy("Your browser does not support sending SEI"),!1;jS(i,"repeatCount",0,30);const s="string"==typeof t?new Uint8Array(Gy.str2ab(t)):t;if(!t.length)return this._logger.warn("sei message must not be empty"),!1;if(s.byteLength>4096)return void this._logger.warn("sei size must not bigger than 4KB");yS||this._maybeFillBackFrame2Stream(o);const r=Vy();o.sendSEIMessage({content:s,uuid:r,repeatCount:i+1}),setTimeout((async()=>{if(!o)return;var e;await o.revokeSEIMessage(r)&&(console.error("[RTC WebSDK] sei timeout for message: %o",t),null===(e=this._monitor)||void 0===e||e.report("rtc_sdk_callback",{sdk_callback_name:"sendSEIMessage",message:"timeout for message: ".concat(t),error_code:400}))}),vy("SEI_TIME_OUT"))}async startPlayWTN(e,t,i,o){var s;let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];i=!!i,o=!!o,this._logger.print("startPlayWTN",e,t,i,o),ry(t),!iy(e)&&QS(e,"token");let n=this._remoteStreams.get(t);if(n){if(n.state===NG.START||n.state===NG.SUCCESS)throw new HS(US.REPEAT_PLAY,"repeat play public media stream");await this.stopPlayWTN(n.streamId)}n=new AG(t,e,this._ctx,r),this._addRemoteStreamEventHandler(n),n.setState(NG.START,XG.START_PLAY),n.muteToSubMediaType(o,i),this._remoteStreams.set(t,n),null===(s=n.observer)||void 0===s||s.setLogin(!0,n.getEnableMediaType());try{await this._ctx.signalingManager.connect(),await this._sendStartPullStreamSignal(n)}catch(a){throw this._remoteStreams.delete(t),a}}async stopPlayWTN(e){var t,i;this._logger.print("stopPlayWTN",e);const o=this._remoteStreams.get(e);if(o)return o.setState(NG.STOP,XG.STOP_PLAY),o.setAudioState(VG.STOPED,wG.MUTE),o.setVideoState(xG.STOPED,GG.MUTE),null===(t=o.observer)||void 0===t||t.setLogin(!1),null==o||null===(i=o.audioTrack)||void 0===i||i.stop(),this._remoteStreams.delete(e),await this._ctx.signalingManager.connect(),this._unsubscribePublicStream(o)}async muteWTNRemoteAudio(e,t){this._logger.print("muteWTNRemoteAudio",e,t),this._assertNotConnect();const i=this._remoteStreams.get(e);if(!i)throw new HS(US.INVALID_PARAMS,"streamId not found");var o;i.muteToSubMediaType(t,null)&&(null===(o=i.observer)||void 0===o||o.setUnmuteAudio(!t),await this._updatePullStream(e,i),i.setAudioState(t?VG.STOPED:VG.DECODING,t?wG.MUTE:wG.UNMUTE))}async muteWTNRemoteVideo(e,t){this._logger.print("muteWTNRemoteVideo",e,t),this._assertNotConnect();const i=this._remoteStreams.get(e);if(!i)throw new HS(US.INVALID_PARAMS,"streamId not found");var o;i.muteToSubMediaType(null,t)&&(null===(o=i.observer)||void 0===o||o.setUnmuteVideo(!t),await this._updatePullStream(e,i),i.setVideoState(t?xG.STOPED:xG.DECODING,t?GG.MUTE:GG.UNMUTE))}setWTNRemoteVideoPlayer(e,t){var i;if(this._logger.print("setWTNRemoteVideoPlayer()","streamId: %o, videoPlayerOption: %o",e,t),null===(i=this._publicVideoPlayerConfig.get(e))||void 0===i||null===(i=i.player)||void 0===i||i.destroy(),!t.renderDom)return void this._publicVideoPlayerConfig.delete(e);const o=new AL(this._ctx.id,XL,Yu(Yu({},t),{},{isLocal:!1,userId:e})),s=Yu(Yu({},t),{},{player:o});return this._publicVideoPlayerConfig.set(e,s),this._updateVideoPlayerState(e),o.domElement}setWTNRemoteAudioPlaybackVolume(e,t){var i;QS(e,"publicStreamId"),t=cy(t,"volume",0,400),this._ctx.publicAudioVolume.set(e,t),null===(i=this._remoteStreams.get(e))||void 0===i||null===(i=i.audioTrack)||void 0===i||i.setVolume(t)}__getRemoteStreams(){return this._remoteStreams}__getPublicStreamTrack(e,t){const i=this._remoteStreams.get(e);if(i)return"video"===t?i.videoTrack:i.audioTrack}async _updatePushTrack(){0!==this._localStreams.size&&(this._logger.info("_updatePushTrack()"),await this._ctx.signalingManager.connect(),this._localStreams.forEach((async e=>{e.videoTrack=this._ctx.localVideoTrack,e.audioTrack=this._ctx.localAudioTrack,await this._updatePushStream(e)})))}destroy(){var e;this._remoteStreams.forEach((e=>{e.destroy()})),this._remoteStreams=new Map,this.removeAllListeners(),this._ontrackCallbackMap.clear(),this._publicVideoPlayerConfig.forEach((e=>{e.player.destroy()})),this._publicVideoPlayerConfig.clear(),null===(e=this._clearSignalListeners)||void 0===e||e.call(this)}async _sendStartPushStreamSignal(e){var t,i,o;this._logger.print("_sendStartPushStreamSignal()","streamId: %s",e.streamId);const{streamId:s,Authorization:r,pubAudio:n,pubVideo:a}=e,{handler:d}=this._ctx;await(null==d?void 0:d.getDefaultSdp());const c=await d.publish(e),l=await LT(),{appId:u,businessId:h,useCloudProxy:m}=this._ctx,p={appId:u,streamId:s,Authorization:r,sdpInfo:{msid:e.stream.id,type:c.type,sdp:c.partialSdp,semantics:c.semantics},timestamp:Date.now(),params:{appId:u,businessId:h,userAgent:window.navigator.userAgent,sdkVersion:_y.VERSION,deviceId:DS.getDeviceId(),enableCloudProxy:m,channelProfile:"0",SDKCodecNegotiation:!0,supportedCodecs:l,sdkType:"rtc",joinRoomMode:1,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(t=_y.MEDIA_PROCESSING_TYPE)&&void 0!==t?t:0},options:{supportCheckTokenPrivilege:!0,supportTokenExpireCallBack:!0,enableSceneConfigV2:!0,enableUnBundleMode:!0,enableAudioMux:!0,enableBigRoomMode:!0,needNegotiateSDP:!0,supportMultiVendor:!0,enableStreamStatusCallback:!0},attributes:{localaudio:!!e.audioTrack,localvideo:!!e.videoTrack,videostream:a,audiostream:n,extvideo:(null===(i=e.videoTrack)||void 0===i?void 0:i.sourceType)===yT.EXTERNAL,extaudio:(null===(o=e.audioTrack)||void 0===o?void 0:o.sourceType)===yT.EXTERNAL,videoDescriptions:c.videoDescriptions.map((e=>Jb(e,OG))),videoType:ST.NORMAL},video:a,audio:n,screen:e.isScreen};let _;try{_=await this._ctx.signalingManager.sendSignaling("startPushStream",p)}catch(S){if(await(null==d?void 0:d.rollback({msid:e.stream.id,stream:e,audioMid:c.audioMid,videoMid:c.videoMid})),S.code>=500&&S.code<600){const t=e.getPushBackOff();if(t.retryDuration<6e4)return this._logger.info("pushRetry","start msid: %s, retryDuration: %s",e.id,t.retryDuration),await new Promise((e=>setTimeout(e,t.interval))),e.updatePushBackOff(),e.resetStream(),e.setState(PG.START,kG.IN_RETRY),this._sendStartPushStreamSignal(e);throw this._logger.info("pushRetry","end"),e.setState(PG.FAIL,kG.RETRY_FAIL),await this._stopLocalStream(e),e.resetPushBackOff(),new HS(US.WTN_PUSH_FAILED,S.message||"server error")}if(401===S.code)throw e.setState(PG.FAIL,kG.NO_PUSH_PERMISSION),await this._stopLocalStream(e),new HS(US.WTN_PUSH_FAILED,S.message||"token error");throw new HS(US.WTN_PUSH_FAILED,S.message||"push error")}e.pubAttributes=p.attributes;const b=await e.getSelectedCodec();e.currentVideoCodec=b;const v=new Promise(((t,i)=>{var o,r;null==d||d.handleAck({action:Wx.publish,streamId:s,audioMid:c.audioMid,videoMid:c.videoMid,audioTransceiverInit:null==c?void 0:c.audioTransceiverInit,videoTransceiverInit:null==c?void 0:c.videoTransceiverInit,signalingAck:{sdp:null===(o=_)||void 0===o||null===(o=o.relayMessage)||void 0===o?void 0:o.sdp,sequenceId:null===(r=_)||void 0===r||null===(r=r.relayMessage)||void 0===r?void 0:r.sequenceId},stream:e,videoCodec:b,onSuccess:()=>{this._logger.info("pushStream()","pushStream success"),e.setState(PG.SUCCESS,kG.PUSH_SUCCESS),t(0)},onFail:e=>{this._logger.info("pushStream()","pushStream fail"),i(e)}})}));!sS&&await v}async _stopLocalStream(e){var t;e.stopBlackFrame(),await(null===(t=this._ctx.handler)||void 0===t?void 0:t.handleAck({action:Wx.unpublish,audioMid:e.audioMid,videoMid:e.videoMid,stream:e,streamId:e.streamId})),e.destroy(),this._localStreams.delete(e.streamId)}async _updatePushStream(e){var t,i,o,s;const{videoTrack:r,audioTrack:n,pubAudio:a,pubVideo:d}=e;let c=null===(t=e.audioTrack)||void 0===t?void 0:t.preprocessingTrack;const l=null===(i=e.videoTrack)||void 0===i?void 0:i.preprocessingTrack;var u,h;d&&l?(e.stopBlackFrame(),await(null===(u=e.videoTransceiver)||void 0===u?void 0:u.sender.replaceTrack(l))):await(null===(h=e.videoTransceiver)||void 0===h?void 0:h.sender.replaceTrack(null));if(a&&c){var m;const{mixType:t,mixedAudioTrack:i}=e.audioTrack;i&&t!==Nh.PLAYOUT&&c.enabled&&(c=i),await(null===(m=e.audioTransceiver)||void 0===m?void 0:m.sender.replaceTrack(c))}else{var p;await(null===(p=e.audioTransceiver)||void 0===p?void 0:p.sender.replaceTrack(null))}const _={localaudio:!!n,localvideo:!!r,videostream:d,audiostream:a,extvideo:(null==r?void 0:r.sourceType)===yT.EXTERNAL,extaudio:(null==n?void 0:n.sourceType)===yT.EXTERNAL,videoType:r?ST.NORMAL:e.pubAttributes.videoType},b={};for(const[S,y]of Object.entries(_))y!==Reflect.get(e.pubAttributes,S)&&Reflect.set(b,S,y);var v;Object.keys(b).length&&(e.pubAudio=null!==(o=_.audiostream)&&void 0!==o?o:e.pubAudio,e.pubVideo=null!==(s=_.videostream)&&void 0!==s?s:e.pubVideo,e.pubAttributes=Yu(Yu({},e.pubAttributes),_),e.pubAttributes.videostream||e.stopBlackFrame(),await this._ctx.signalingManager.sendSignaling("updatePushStream",{appId:this._ctx.appId,streamId:e.streamId,attributes:_}),sS&&await(null===(v=this._ctx.handler)||void 0===v?void 0:v.setCurrentDescription()))}async _sendStartPullStreamSignal(e){var t,i,o,s;this._logger.print("startPullStream()","streamId:",e.streamId);const{streamId:r,Authorization:n}=e,{handler:a}=this._ctx,d=await(null==a?void 0:a.subscribe(e,{multiChatMode:!1}));if(!d)throw new HS(US.ADD_TRANSCEIVER_FAILED,"add transceiver failed");const c=wy(),{audioMid:l,videoMid:u}=d,{appId:h,businessId:m,useCloudProxy:p}=this._ctx,_=await LT(),b={appId:h,streamId:r,Authorization:n,audio:!0,video:!0,screen:!1,timestamp:Date.now(),sdpInfo:{sdp:d.partialSdp,semantics:d.semantics,type:d.type},params:{appId:h,businessId:m,userAgent:window.navigator.userAgent,sdkVersion:_y.VERSION,deviceId:DS.getDeviceId(),enableCloudProxy:p,channelProfile:"0",SDKCodecNegotiation:!0,supportedCodecs:_,sdkType:"rtc",joinRoomMode:1,deviceType:"web",platformType:2,rtsMode:this._ctx.rtsMode,mediaProcessingType:null!==(t=_y.MEDIA_PROCESSING_TYPE)&&void 0!==t?t:0},options:{supportCheckTokenPrivilege:!0,supportTokenExpireCallBack:!0,enableSceneConfigV2:!0,enableUnBundleMode:!0,enableAudioMux:!0,enableBigRoomMode:!0,needNegotiateSDP:!0,supportMultiVendor:!0,enableStreamStatusCallback:!0},config:{enableMediaType:e.getEnableMediaType(),qualityLayer:{spatialLayer:0,temporalLayer:0}}};let v;try{v=await this._ctx.signalingManager.sendSignaling("startPullStream",b)}catch(T){throw await(null==a?void 0:a.rollback({msid:r,stream:e})),401===T.code?(e.setState(NG.FAIL,XG.NO_PLAY_PERMISSION),new HS(US.WTN_PLAY_FAILED,T.message||"token error")):433===T.code?(e.setState(NG.FAIL,XG.OVER_CLIENT_SUBSCRIBE_STREAM_LIMIT),new HS(US.WTN_PLAY_FAILED,T.message||"over client subscribe stream limit")):434===T.code?(e.setState(NG.FAIL,XG.OVER_STREAM_SUBSCRIBE_USER_LIMIT),new HS(US.WTN_PLAY_FAILED,T.message||"over stream subscribe user limit")):(e.setState(NG.FAIL,XG.INTERNAL),new HS(US.WTN_PLAY_FAILED,T.message||"play wtn error"))}const S=[];S.push(new Promise(((t,i)=>{const o=setTimeout((()=>i(new HS(US.WTN_PLAY_FAILED,"wait video timeout for streamId: ".concat(r)))),JP),s=i=>{"video"===i.mediaType&&(this._logger.success("remoteStream ".concat(e.userId," received video track")),e.off("ontrack",s),clearTimeout(o),t(0))};e.on("ontrack",s)}))),S.push(new Promise(((t,i)=>{const o=setTimeout((()=>i(new HS(US.WTN_PLAY_FAILED,"wait audio timeout for streamId: ".concat(r)))),JP),s=i=>{"audio"===i.mediaType&&(this._logger.success("remoteStream ".concat(e.userId," received audio track")),e.off("ontrack",s),clearTimeout(o),t(0))};e.on("ontrack",s)})));const y=t=>{e.ontrack(t)};null===(i=this._ctx.handler)||void 0===i||i.on("ontrack",y),this._ontrackCallbackMap.set(e,y);const{sequenceId:f,sdp:g}=v.relayMessage;e.videoMid=u,e.audioMid=l,e.sequenceId=f,e.streamState=hP.SUB_ED,await(null===(o=this._ctx.handler)||void 0===o?void 0:o.handleAck({action:Wx.subscribe,streamId:r,audioMid:l,videoMid:u,audioTransceiverInit:d.audioTransceiverInit,videoTransceiverInit:d.videoTransceiverInit,signalingAck:{sdp:g,sequenceId:f},stream:e})),await Promise.all(S),null===(s=this._monitor)||void 0===s||s.report("rtc_subscribe_stat",{result:"success",start:c,message:"unknown",stream_user_id:e.userId}),e.startReport((t=>{var i;t.publicStreamId=t.userId,delete t.userId,delete t.isScreen;const o=Fy(t);o.audioStats&&this.safeEmit(LG.onWTNRemoteAudioStats,{streamId:e.streamId,audioStats:o.audioStats}),o.videoStats&&this.safeEmit(LG.onWTNRemoteVideoStats,{streamId:e.streamId,videoStats:o.videoStats}),null===(i=this.__onRemoteStreamStats)||void 0===i||i.call(this,o)}),this._ctx.handler),this._updateVideoPlayerState(r),this._initAudioPlayer(r),e.subVideo=e.getEnableMediaType().video,e.subAudio=e.getEnableMediaType().audio}async _unsubscribePublicStream(e){var t;zP("_unsubscribePublicStream()",e,this._logger);const i={appId:this._ctx.appId,streamId:e.streamId};try{await this._ctx.signalingManager.sendSignaling("stopPullStream",i)}catch(o){}e.streamState=hP.INIT,await(null===(t=this._ctx.handler)||void 0===t?void 0:t.handleAck({action:Wx.unsubscribe,streamId:e.streamId,audioMid:e.audioMid,videoMid:e.videoMid,stream:e})),e.subMediaType=ly.NONE,this._removeOnTrackListener(e),e.statsReport.unsubscribe(),e.destroy()}async _updatePullStream(e,t){const i=t.getEnableMediaType();await this._ctx.signalingManager.sendSignaling("updatePullStream",{appId:this._ctx.appId,streamId:e,config:{enableMediaType:i}}),t.subVideo=i.video,t.subAudio=i.audio}_removeOnTrackListener(e){const t=this._ontrackCallbackMap.get(e);if(t){const i=e.vendorHandler||this._ctx.handler;null==i||i.off("ontrack",t),this._ontrackCallbackMap.delete(e)}}_addSignalListeners(){const e={[pT.ON_CONNECTION_STATE_CHANGE]:e=>{e.state===th.CONNECTION_STATE_RECONNECTED?(Array.from(this._remoteStreams.values()).forEach((e=>{const{streamId:t,token:i,subAudio:o,subVideo:s}=e;e.destroy(),this._remoteStreams.delete(t),this.startPlayWTN(i,t,!s,!o,!0).then((()=>{var t;null===(t=this.__onResubscribe)||void 0===t||t.call(this,{stream:e})}))})),Array.from(this._localStreams.values()).forEach((e=>{const{token:t,pubAudio:i,pubVideo:o}=e;e.destroy(),this._localStreams.delete(e.streamId),this.startPushWTN(t,e.streamId,!o,!i,!0)}))):e.state===th.CONNECTION_STATE_DISCONNECTED&&(this._remoteStreams.forEach((e=>{e.setState(NG.FAIL,XG.IN_RETRY),e.setAudioState(VG.FROZEN,wG.NETWORK_CONGESTION),e.setVideoState(xG.FROZEN,GG.NETWORK_CONGESTION)})),this._localStreams.forEach((e=>{e.setState(PG.FAIL,kG.IN_RETRY)})))},[hT.ON_STREAM_PUSHED_BY_OTHER]:e=>{const t=this._localStreams.get(e.streamId);this._logger.print("_addSignalListeners","onStreamPushedByOther",e.streamId),t&&(t.setState(PG.FAIL,kG.STREAM_PUSH_BY_OTHER),this._stopLocalStream(t))},[hT.ON_STREAM_PULL_STATE_CHANGED]:async e=>{const t=this._remoteStreams.get(e.streamId);if(this._logger.print("_addSignalListeners","onStreamPullStateChanged",e),t)switch(e.code){case 0:t.setState(NG.SUCCESS,XG.PLAY_SUCCESS);break;case 1:case 2:case 3:const o={1:XG.STREAM_NOT_EXIST,2:XG.REMOTE_STOP,3:XG.REMOTE_FAILURE}[e.code];t.setAudioState(VG.STOPED,wG.REMOTE_STOP),t.setVideoState(xG.STOPED,GG.REMOTE_STOP),t.setState(NG.FAIL,o);break;case 4:const s=t.getPushBackOff();var i;if(s.retryDuration<6e4)this._logger.info("subRetry",t.streamId,s.retryDuration),t.setState(NG.START,XG.IN_RETRY),await new Promise((e=>setTimeout(e,s.interval))),t.updatePushBackOff(),await(null===(i=this._ctx)||void 0===i||null===(i=i.handler)||void 0===i?void 0:i.handleAck({action:Wx.unsubscribe,streamId:t.streamId,audioMid:t.audioMid,videoMid:t.videoMid,stream:t})),t.clean(),await this._sendStartPullStreamSignal(t);else t.setState(NG.FAIL,XG.RETRY_FAIL),this._logger.info("subRetry","end",t.streamId),t.resetPushBackOff()}}};Object.keys(e).forEach((t=>{this._ctx.signalingManager.on(t,e[t])})),this._clearSignalListeners=()=>{Object.keys(e).forEach((t=>{this._ctx.signalingManager.off(t,e[t])}))}}_addLocalStreamEventHandler(e){e.on(LG.onWTNPushStateChanged,(e=>{this.safeEmit(LG.onWTNPushStateChanged,e)}))}_addRemoteStreamEventHandler(e){e.on(LG.onWTNPlayStateChanged,(e=>{this.safeEmit(LG.onWTNPlayStateChanged,e)})),e.on(LG.onWTNRemoteAudioStateChanged,(e=>{this.safeEmit(LG.onWTNRemoteAudioStateChanged,e)})),e.on(LG.onWTNRemoteVideoStateChanged,(e=>{this.safeEmit(LG.onWTNRemoteVideoStateChanged,e)})),e.on("onSEIMessage",(t=>{if(t instanceof Uint8Array){const o=function(e){const t=new DataView(e.buffer);if(t.byteLength<=4||65535!==t.getUint16(0))return{seiCount:1,seis:[e]};const i={seiCount:0,seis:[]};let o=!1,s=2;for(;s<t.byteLength;){const r=t.getUint16(s);if(s+=2,t.byteLength-s<r){o=!0;break}const n=new Uint8Array(e.buffer,s,r);if(s+=r,t.byteLength-s>0&&t.byteLength-s<=2){o=!0;break}i.seiCount++,i.seis.push(n)}return o&&(i.seiCount=1,i.seis=[e]),i}(t);for(let t=0;t<o.seiCount;t++){var i;null===(i=this.__onSEIMessageReceived)||void 0===i||i.call(this,{sei:o.seis[t],publicStreamId:e.streamId}),this.safeEmit(LG.onWTNSEIMessageReceived,{streamId:e.streamId,sei:o.seis[t]})}}}))}_updateVideoPlayerState(e){const t=this._remoteStreams.get(e);if(t){const s=this._publicVideoPlayerConfig.get(e);var i,o;if(s)null===(i=t.videoTrack)||void 0===i||i.setPlayer(this._ctx.id,s,null===(o=this._ctx)||void 0===o?void 0:o.autoPlayPolicy,this._initPlayerEvents.bind(this))}}_initAudioPlayer(e){const t=this._remoteStreams.get(e);if(null!=t&&t.audioTrack){var i,o;const s=new OL(this._ctx.id,e,{muted:(null===(i=this._ctx)||void 0===i?void 0:i.autoPlayPolicy)===vh.VIDEO_ONLY||(null===(o=this._ctx)||void 0===o?void 0:o.autoPlayPolicy)===vh.PLAY_MANUALLY,isScreen:!1});t.audioTrack.setPlayer(s),t.audioTrack.bindPlayerEvent(this._initPlayerEvents.bind(this)),t.audioTrack.play()}}_initPlayerEvents(e){var t;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:qu.STREAM_INDEX_MAIN;null===(t=this.__onPlayerEvents)||void 0===t||t.call(this,e,i,o),e.on("playback_event",(t=>{const i=this._remoteStreams.get(e.userId);if("loadeddata"===t.eventName){const e=()=>{i&&"video"===t.type&&this.safeEmit(LG.onWTNFirstRemoteVideoFrameDecoded,{streamId:i.streamId})};null==i||!i.observer||i.observer.audioFirstFrameReceived?e():i.observer.once("recvVideoFirstFrame",e)}}))}async _maybeFillBackFrame2Stream(e){var t;if(e.refreshBlackFrameLifetime(),null===(t=e.videoTransceiver)||void 0===t||!t.sender.track){var i;const t=e.genBlackFrame();if(!t)return;null===(i=e.videoTransceiver)||void 0===i||null===(i=i.sender)||void 0===i||i.replaceTrack(t),e.pubAttributes.videoType=ST.BLACK,this._ctx.signalingManager.sendSignaling("updatePushStream",{streamId:e.streamId,appId:this._ctx.appId,attributes:{videoType:ST.BLACK}}),e.on("black-frame-ended",(()=>{var t;null===(t=e.videoTransceiver)||void 0===t||null===(t=t.sender)||void 0===t||t.replaceTrack(null),e.pubAttributes.videoType=ST.NORMAL,this._ctx.signalingManager.sendSignaling("updatePushStream",{streamId:e.streamId,appId:this._ctx.appId,attributes:{videoType:ST.NORMAL}})}))}}safeEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];return Gv(this._ctx.id,e,i),super.safeEmit(e,...i)}_assertNotConnect(){if(!this._ctx.signalingManager.isConnected())throw new HS(US.NOT_CONNECTED_YET,"server not connected")}}KG([wv()],UG.prototype,"startPushWTN",1),KG([wv()],UG.prototype,"stopPushWTN",1),KG([wv()],UG.prototype,"muteWTNLocalAudio",1),KG([wv()],UG.prototype,"muteWTNLocalVideo",1),KG([wv()],UG.prototype,"sendWTNSEIMessage",1),KG([wv()],UG.prototype,"startPlayWTN",1),KG([wv()],UG.prototype,"stopPlayWTN",1),KG([wv()],UG.prototype,"muteWTNRemoteAudio",1),KG([wv()],UG.prototype,"muteWTNRemoteVideo",1),KG([wv()],UG.prototype,"setWTNRemoteVideoPlayer",1),KG([wv()],UG.prototype,"setWTNRemoteAudioPlaybackVolume",1),KG([$x],UG.prototype,"_sendStartPushStreamSignal",1),KG([$x],UG.prototype,"_stopLocalStream",1),KG([$x],UG.prototype,"_sendStartPullStreamSignal",1),KG([$x],UG.prototype,"_unsubscribePublicStream",1);const FG=new eS("AudioDeviceManager",1);class HG extends sT.EventEmitter{constructor(e){super(),Ou(this,"_audioLevelFetcher",void 0),Ou(this,"_playbackDeviceTestTimer",void 0),Ou(this,"_audioElement",void 0),Ou(this,"_audioTrack",void 0),Ou(this,"_mediaRecorder",void 0),Ou(this,"_recoderTimer",void 0),Ou(this,"_isAudioPlaybackDeviceTesting",!1),Ou(this,"_isAudioDeviceRecordTesting",!1),Ou(this,"_audioCaptureAndRecoderResolve",void 0),Ou(this,"_onAutoplayFailed",void 0),Ou(this,"_audioPlaybackDeviceId",void 0),this._ctx=e}get audioTrack(){return this._audioTrack}async startAudioPlaybackDeviceTest(e,t){if(this._isAudioPlaybackDeviceTesting||this._isAudioDeviceRecordTesting)throw new HS(US.REPEAT_DEVICE_TEST,"device test cannot be called repeatedly at the same time.");this._isAudioPlaybackDeviceTesting=!0,FG.info("startAudioPlaybackDeviceTest()","Invoke");try{await this._playAudioFile(e,{loop:!0})}catch(BW){throw FG.error("startAudioPlaybackDeviceTest()","error",BW),this.stopAudioPlaybackDeviceTest(),BW}this._startEmitAudioPlaybackDeviceTestVolume(t)}stopAudioPlaybackDeviceTest(){this._isAudioPlaybackDeviceTesting&&(FG.info("stopAudioPlaybackDeviceTest()","Invoke"),this._isAudioPlaybackDeviceTesting=!1,this._stopEmitAudioPlaybackDeviceTestVolume(),this._destroyAudioElement())}async startAudioDeviceRecordTest(e,t,i){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3e4;if(!window.MediaRecorder)throw new HS(US.NOT_SUPPORTED,"Your browser does not support MediaRecorder.");if(this._isAudioDeviceRecordTesting||this._isAudioPlaybackDeviceTesting)throw new HS(US.REPEAT_DEVICE_TEST,"device test cannot be called repeatedly at the same time.");this._isAudioDeviceRecordTesting=!0,FG.info("startAudioDeviceRecordTest()","Invoke"),this._recoderTimer=setTimeout((()=>{FG.info("startAudioDeviceRecordTest()","".concat(o,'ms automatic call method "stopAudioDeviceRecordAndPlayTest"')),this._stopAudioCaptureAndRecoder()}),o);try{this._onAutoplayFailed=t,await this._startAudioCaptureAndRecoder(e,null!=i?i:100)}catch(s){throw this._isAudioDeviceRecordTesting=!1,delete this._onAutoplayFailed,s}delete this._audioCaptureAndRecoderResolve}stopAudioDeviceRecordAndPlayTest(){FG.info("stopAudioDeviceRecordAndPlayTest()","Invoke"),void 0!==this._recoderTimer&&(clearTimeout(this._recoderTimer),delete this._recoderTimer),this._stopAudioCaptureAndRecoder()}stopAudioDevicePlayTest(){this._isAudioDeviceRecordTesting&&(FG.info("stopAudioDevicePlayTest()","Invoke"),this._isAudioDeviceRecordTesting=!1,this._mediaRecorder&&(this._mediaRecorder.ondataavailable=null),this.stopAudioDeviceRecordAndPlayTest(),this._stopEmitAudioPlaybackDeviceTestVolume(),this._destroyAudioElement()),delete this._onAutoplayFailed}getRecordTrack(){return this._audioTrack}async setSinkId(e){if(FG.info("setSinkId()","Invoke"),void 0===HTMLAudioElement.prototype.setSinkId)throw new HS(US.NOT_SUPPORTED,"setSinkId not supported by current browser");const t=await LL.getAudioPlaybackDeviceById(e);if(!t)throw new HS(US.INVALID_DEVICE_ID,"audio playback device id ".concat(e," is invalid"));return this._audioPlaybackDeviceId=e,this._setAudioCtxSinkId(),t}getSinkId(){return this._audioPlaybackDeviceId}destroy(){FG.info("destroy()","Invoke"),super.removeAllListeners(),this.stopAudioPlaybackDeviceTest(),this.stopAudioDevicePlayTest()}async _playAudioFile(e,t){return FG.info("_playAudioFile()","Invoke url=".concat(e,"; loop=").concat(t.loop)),new Promise(((i,o)=>{const s=ZL("audio",{attributes:{src:e,crossOrigin:"anonymous"}});this._audioElement=s,s.loop=t.loop,this._audioLevelFetcher=new RL(s),s.onplaying=()=>{s.onplaying=null,FG.info("_playAudioFile()","onplaying"),i()},s.onerror=async e=>{var t;FG.error("_playAudioFile()","onerror",e);const i=e.message||(null==s||null===(t=s.error)||void 0===t?void 0:t.message);o(new HS(US.LOAD_RESOURCES_FAILED,"Failed to play recorded audio".concat(i?", reason: ".concat(i):".")))},this._setAudioCtxSinkId().then((()=>{var e,t;return null===(e=s.play())||void 0===e||null===(t=e.catch)||void 0===t?void 0:t.call(e,(e=>{FG.warn("_playAudioFile()","autoplay error",e);const t="Failed to play recorded audio, ".concat(e.name,": ").concat(e.message);"NotAllowedError"===e.name&&this._onAutoplayFailed?this._onAutoplayFailed((()=>{var e;return Promise.all([null===(e=this._audioLevelFetcher)||void 0===e?void 0:e.resume(),s.play()])})):o(new HS(US.LOAD_RESOURCES_FAILED,t))}))}))}))}_destroyAudioElement(){this._audioElement&&(FG.info("_destroyAudioElement()","Invoke"),this._audioElement.onplaying=null,this._audioElement.onerror=null,this._audioElement.src="",delete this._audioElement,"function"==typeof this._audioCaptureAndRecoderResolve&&this._audioCaptureAndRecoderResolve())}_startEmitAudioPlaybackDeviceTestVolume(e){e=Math.max(e,100),this._audioElement&&(FG.info("_startEmitAudioPlaybackDeviceTestVolume()","start timer(".concat(e,"ms)")),this._playbackDeviceTestTimer=self.setInterval((()=>{this._audioLevelFetcher&&this.emit("onAudioPlaybackDeviceTestVolume",this._audioLevelFetcher.getAudioLevel())}),e))}_stopEmitAudioPlaybackDeviceTestVolume(){var e;void 0!==this._playbackDeviceTestTimer&&(FG.info("_stopEmitAudioPlaybackDeviceTestVolume()","stop timer"),self.clearInterval(this._playbackDeviceTestTimer),delete this._playbackDeviceTestTimer),null===(e=this._audioLevelFetcher)||void 0===e||e.destroy(),delete this._audioLevelFetcher}async _startAudioCaptureAndRecoder(e,t){this._audioTrack=await qL(this._ctx,this._ctx.audioProfileManager.getConstraints()),this._audioTrack.setVolume(t+.01);const i=new MediaStream([this._audioTrack.preprocessingTrack]);return FG.info("startAudioDeviceRecordTest()","create microphone track success!"),new Promise(((t,o)=>{let s;"function"==typeof MediaRecorder.isTypeSupported&&(s=["audio/webm","audio/mp4"].find((e=>MediaRecorder.isTypeSupported(e))),FG.info("startAudioDeviceRecordTest()","use mimeType: ".concat(s))),this._mediaRecorder=new MediaRecorder(i,s?{mimeType:s}:void 0);const r=this._mediaRecorder.mimeType;this._mediaRecorder.ondataavailable=async i=>{if(this._isAudioDeviceRecordTesting){var s;FG.info("startAudioDeviceRecordTest()","get recorded file(mimeType: ".concat(r,")."));const a=new Blob([i.data],{type:r});try{await this._playAudioFile(tL.createObjectURL(a),{loop:!1})}catch(n){return o(n)}this._startEmitAudioPlaybackDeviceTestVolume(e),null===(s=this._audioElement)||void 0===s||s.addEventListener("ended",(()=>{this.stopAudioDevicePlayTest(),t()})),this._audioCaptureAndRecoderResolve=t}else t()},this._mediaRecorder.onerror=e=>{o(new HS(US.AUDIO_DEVICE_TEST_FAILED,e.message||"mediaRecorder error"))},this._audioCaptureAndRecoderResolve=t,this._mediaRecorder.start()}))}_stopAudioCaptureAndRecoder(){var e;this._mediaRecorder&&("recording"===this._mediaRecorder.state&&this._mediaRecorder.stop(),delete this._mediaRecorder),null===(e=this._audioTrack)||void 0===e||e.destroy(),delete this._audioTrack}async _setAudioCtxSinkId(){let e=this._audioPlaybackDeviceId;if(e){"default"===e&&(e="");try{var t,i;null===(t=CL.getAudioContextInstance())||void 0===t||null===(i=t.setSinkId)||void 0===i||i.call(t,e),FG.info("setSinkId","ctx.sinkId=".concat(e))}catch(o){FG.error("setSinkId","failed, ".concat(o.name," - ").concat(o.message))}}}}const JG=()=>({url:"",video:{codec:yh.H264,width:640,height:360,fps:15,gop:2,kBitRate:zG(640,360,15)},audio:{codec:"AAC",kBitRate:64,sampleRate:48e3,channels:2,AACProfile:Sh.LC},layout:{regions:[],appData:"",backgroundColor:"#000000"}});function zG(e,t,i){return e*t<=288e3?i<=15?800:1200:e*t<=864e3?i<=15?1200:1800:e*t<=1152e3?i<=15?1600:2400:e*t<=2592e3?i<=15?2500:3750:i<=15?3300:5e3}function jG(e){if("string"!=typeof e||!/^rtmps?:\/\//.test(e))throw new HS(US.INVALID_PARAMS,"Invalid rtmp address")}function QG(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(null==e||!e.length)throw new HS(US.INVALID_PARAMS,"regions should not be empty.");for(const t of e){if("string"!=typeof t.userId)throw new HS(US.INVALID_PARAMS,"region.userId(".concat(t.userId,") should be a string."));if(sy(t.userId),"boolean"!=typeof t.isScreenStream)throw new HS(US.INVALID_PARAMS,"region.isScreenStream(".concat(t.isScreenStream,") should be a boolean."))}}function BG(e,t){var i,o;const s=(e,i)=>{const o=e.reduce(((e,t)=>null==e?void 0:e[t]),t),s=e.reduce(((e,t)=>null==e?void 0:e[t]),JG());return o&&i(o)?o:s},r=e=>e%2==0?e:e+1,n=r(s(["video","width"],(e=>e>=2&&e<=1920))),a=r(s(["video","height"],(e=>e>=2&&e<=1920))),d=s(["video","fps"],(e=>e>=1&&e<=60)),c=(null===(i=t.video)||void 0===i?void 0:i.kBitRate)||0,l=s(["audio","sampleRate"],(e=>!![32e3,44100,48e3].find((t=>t===e||t/1e3===e))));return{type:"transcode",action:e,transcodeMeta:{transcode:{url:t.url},control:{protocol:"2.0"},audio:{codec:s(["audio","codec"],(e=>"AAC"===e)),bitRate:1e3*s(["audio","kBitRate"],(e=>e>=32&&e<=192)),sampleRate:l<100?1e3*l:l,channels:s(["audio","channels"],(e=>[1,2].includes(e))),profile:s(["audio","AACProfile"],(e=>[Sh.LC,Sh.HEv1,Sh.HEv2].includes(e)))},video:{codec:s(["video","codec"],(e=>["H264","H265"].includes(e))),fps:d,gop:s(["video","gop"],(e=>e>=1&&e<=5))*d,bitRate:1e3*(c>=16&&c<=1e4?c:zG(n,a,d)),width:n,height:a},layout:{canvas:{bgnd:s(["layout","backgroundColor"],(e=>/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/.test(e)))},regions:(null===(o=t.layout)||void 0===o||null===(o=o.regions)||void 0===o?void 0:o.map((e=>({alpha:!e.alpha||Number(e.alpha)>1||Number(e.alpha)<=0?1:Number(e.alpha),uid:e.userId,zorder:!e.zorder||Number(e.zorder)<0||Number(e.zorder)>100?0:Number(e.zorder),x:!e.x||Number(e.x)>=1||Number(e.x)<0?0:Number(e.x),y:!e.y||Number(e.y)>=1||Number(e.y)<0?0:Number(e.y),w:!e.w||Number(e.w)>1||Number(e.w)<=0?1:Number(e.w),h:!e.h||Number(e.h)>1||Number(e.h)<=0?1:Number(e.h),renderMode:e.renderMode&&[1,2,3].includes(e.renderMode)?e.renderMode:1,contentControl:e.contentControl&&[0,1,2].includes(e.contentControl)?e.contentControl:0,screen:!!e.isScreenStream}))))||[],app_data:s(["layout","appData"],(e=>"string"==typeof e))}}}}const qG={getDefaultValue:JG,checkStartParams:function(e){var t;jG(e.url),QG(null===(t=e.layout)||void 0===t?void 0:t.regions)},checkUpdateParams:function(e){var t;e.url&&jG(e.url),QG(null===(t=e.layout)||void 0===t?void 0:t.regions)},getStartParams:function(e){return BG("started",e)},getUpdateParams:function(e){return BG("layoutChanged",e)}};let $G;var eW=LN,tW=Md;ki({target:"Object",stat:!0},{fromEntries:function(e){var t={};return eW(e,(function(e,i){tW(t,e,i)}),{AS_ENTRIES:!0}),t}});var iW=i(q.Object.fromEntries);const oW=["ele","fakeEle"],sW=["orgTrack","mediaTrack","preprocessingTrack"],rW=["orgTrack","mediaTrack","preprocessingTrack"],nW=["currentTime","duration","ended","error","muted","networkState","paused","readyState","seekable","sinkId","src","volume"],aW=["currentTime","sampleRate","state","baseLatency","outputLatency","sinkId"],dW=["contentHint","enabled","id","kind","label","muted","readyState"],cW=["currentDirection","direction","mid","stopped"];let lW;function uW(e){const t={};if(e instanceof MediaStream){t.id=e.id,t.active=e.active;const i=e.getTracks();t.tracks=i.map((e=>iW(dW.map((t=>[t,e[t]])))))}return t}function hW(e){const t=[];let i=[];e&&e._room&&e._room._remoteStreams&&(i=e._room._remoteStreams.values());for(const o of i)o.forEach((e=>{e.audioTrack&&t.push(e.audioTrack)}));e._localAudioTrack&&t.push(e._localAudioTrack),e._localScreenAudioTrack&&t.push(e._localScreenAudioTrack);for(const o of t){if(o._audioLevelFetcher&&o._audioLevelFetcher._ctx)return o._audioLevelFetcher._ctx;if(o._ac)return o._ac;if(o._audioFetchMap&&Array.from(o._audioFetchMap.values()).length)return Array.from(o._audioFetchMap.values())[0]._ctx;if(o._ap&&o._ap._ac)return o._ap._ac}return null}function mW(e){const t=[];e._localAudioTrack&&t.push({userId:"__local__",mediaType:"audio",isScreen:!1,isPublic:!1,isVirtual:!1,orgTrack:e._localAudioTrack._originTrack,mediaTrack:e._localAudioTrack._mediaTrack,preprocessingTrack:e._localAudioTrack._preProcessingTrack}),e._localScreenAudioTrack&&t.push({userId:"__local__",mediaType:"audio",isScreen:!0,isPublic:!1,isVirtual:!1,orgTrack:e._localScreenAudioTrack._originTrack,mediaTrack:e._localScreenAudioTrack._mediaTrack,preprocessingTrack:e._localScreenAudioTrack._preProcessingTrack}),e._localVideoTrack&&t.push({userId:"__local__",mediaType:"video",isScreen:!1,isPublic:!1,isVirtual:!1,orgTrack:e._localVideoTrack._originTrack,mediaTrack:e._localVideoTrack._mediaTrack,preprocessingTrack:e._localVideoTrack._preProcessingTrack}),e._localScreenVideoTrack&&t.push({userId:"__local__",mediaType:"video",isScreen:!0,isPublic:!1,isVirtual:!1,orgTrack:e._localScreenVideoTrack._originTrack,mediaTrack:e._localScreenVideoTrack._mediaTrack,preprocessingTrack:e._localScreenVideoTrack._preProcessingTrack}),e._room&&e._room._remoteStreams&&e._room._remoteStreams.forEach(((e,i)=>{e.forEach((e=>{e.audioTrack&&t.push({userId:i,mediaType:"audio",isScreen:e.isScreen,isPublic:!1,isVirtual:!1,orgTrack:e.audioTrack._originTrack,mediaTrack:e.audioTrack._mediaTrack}),e.videoTrack&&t.push({userId:i,mediaType:"video",isScreen:e.isScreen,isPublic:!1,isVirtual:!1,orgTrack:e.videoTrack._originTrack,mediaTrack:e.videoTrack._mediaTrack})}))}));let i=e._publicStreamManager;return i||(i=e._outsideRoom),i&&i.remoteStreams&&i.remoteStreams.forEach(((e,i)=>{e.audioTrack&&t.push({userId:i,mediaType:"audio",isScreen:e.isScreen,isPublic:!0,isVirtual:!1,orgTrack:e.audioTrack._originTrack,mediaTrack:e.audioTrack._mediaTrack}),e.videoTrack&&t.push({userId:i,mediaType:"video",isScreen:e.isScreen,isPublic:!0,isVirtual:!1,orgTrack:e.videoTrack._originTrack,mediaTrack:e.videoTrack._mediaTrack})})),e&&e._room&&e._room._virtualStreams&&e._room._virtualStreams.forEach(((e,i)=>{e.audioTrack&&t.push({userId:"virtualStream-".concat(i),mediaType:"audio",isScreen:!1,isPublic:!1,isVirtual:!0,orgTrack:e.audioTrack._originTrack,mediaTrack:e.audioTrack._mediaTrack}),e.videoTrack&&t.push({userId:"virtualStream-".concat(i),mediaType:"video",isScreen:!1,isPublic:!1,isVirtual:!0,orgTrack:e.videoTrack._originTrack,mediaTrack:e.videoTrack._mediaTrack})})),t}async function pW(e,t){if(!e)return;const i=new MediaStream;i.addTrack(e);const o=t.createMediaStreamSource(i),s=t.createAnalyser();o.connect(s),"suspended"===t.state&&(console.warn(t.state),t.resume());const r=new Uint8Array(2048);s.getByteTimeDomainData(r),await new Promise((e=>{setTimeout(e,50)})),s.getByteTimeDomainData(r),await new Promise((e=>{setTimeout(e,50)}));let n=0;r.forEach((e=>n=Math.max(n,Math.abs(e-128))));const a=n/128*256,d=a>2?a:0;return o.disconnect(),s.disconnect(),d}function _W(e){if(!e)return;const t={track:e.track?e.track.id:void 0,transport:{state:e.transport?e.transport.state:void 0}};return e.transport&&e.transport.iceTransport&&(t.iceTransport={state:e.transport.iceTransport.state,role:e.transport.iceTransport.role,gatheringState:e.transport.iceTransport.gatheringState,component:e.transport.iceTransport.component}),t}async function bW(e){const t={stats:[],mediaElementStates:[],audioContextStates:[],volumes:[],trackStates:[],tranceiverStates:[]},i=[];return await new Promise((o=>{let s,r=0;const n=()=>{i.push(async function(e){const t=Date.now();let i=[];e._ctx.handler&&e._ctx.handler._peerConnection&&(i=await e._ctx.handler._peerConnection.getStats());const o=[];return i.forEach((e=>{o.push(e)})),{timestamp:t,stats:o}}(e).then((e=>{t.stats.push(e)})),async function(e){const t=Date.now(),i=[];var o;e._videoPlayer&&i.push({userId:"__local__",mediaType:"video",isScreen:!1,isPublic:!1,ele:e._videoPlayer._videoDom}),e._screenPlayer&&i.push({userId:"__local__",mediaType:"video",isScreen:!0,isPublic:!1,ele:e._screenPlayer._videoDom}),e._remoteVideoPlayer&&e._remoteVideoPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"video",isScreen:!1,isPublic:!1,ele:e?e._videoDom:void 0})})),e._remoteScreenPlayer&&(null===(o=e._remoteScreenPlayer)||void 0===o||o.forEach(((e,t)=>{i.push({userId:t,mediaType:"video",isScreen:!0,isPublic:!1,ele:e?e._videoDom:void 0})}))),e._remoteAudioPlayer&&e._remoteAudioPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"audio",isScreen:!1,isPublic:!1,ele:e?e._audioDom:void 0,fakeEle:e?e._fakeAudioDom:void 0})})),e._remoteScreenAudioPlayer&&e._remoteScreenAudioPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"audio",isScreen:!0,isPublic:!1,ele:e?e._audioDom:void 0,fakeEle:e?e._fakeAudioDom:void 0})})),e._publicStreamVideoPlayer&&e._publicStreamVideoPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"video",isScreen:!1,isPublic:!0,ele:e?e._videoDom:void 0})})),e._publicStreamAudioPlayer&&e._publicStreamAudioPlayer.forEach(((e,t)=>{i.push({userId:t,mediaType:"audio",isScreen:!1,isPublic:!0,ele:e?e._audioDom:void 0,fakeEle:e?e._fakeAudioDom:void 0})})),e._localVideoTrack&&e._localVideoTrack.videoPlayers&&e._localVideoTrack.videoPlayers.forEach(((e,t)=>{i.push({playerId:t.toString(),userId:"__local__",mediaType:"video",isScreen:!1,isPublic:!1,ele:e._videoDom})})),e._localScreenTrack&&e._localScreenTrack.videoPlayers&&e._localScreenTrack.videoPlayers.forEach(((e,t)=>{i.push({playerId:t.toString(),userId:"__local__",mediaType:"video",isScreen:!0,isPublic:!1,ele:e._videoDom})})),e._room&&e._room._remoteStreams&&e._room._remoteStreams.forEach(((e,t)=>{e.forEach((e=>{if(e.audioTrack){const o=e.audioTrack._audioPlayer;i.push({userId:t,mediaType:"audio",isScreen:e.isScreen,isPublic:!1,ele:o?o._audioDom:void 0,fakeEle:o?o._fakeAudioDom:void 0})}e.videoTrack&&e.videoTrack.videoPlayers&&e.videoTrack.videoPlayers.forEach(((o,s)=>{i.push({playerId:s.toString(),userId:t,mediaType:"video",isScreen:e.isScreen,isPublic:!1,ele:o?o._videoDom:void 0})}))}))}));let s=e._publicStreamManager;return s||(s=e._outsideRoom),s&&s.remoteStreams&&s.remoteStreams.forEach(((e,t)=>{if(e.audioTrack){const o=e.audioTrack._audioPlayer;i.push({userId:t,mediaType:"audio",isScreen:!1,isPublic:!0,ele:o?o._audioDom:void 0,fakeEle:o?o._fakeAudioDom:void 0})}e.videoTrack&&e.videoTrack.videoPlayers&&e.videoTrack.videoPlayers.forEach(((e,o)=>{i.push({playerId:o.toString(),userId:t,mediaType:"video",isScreen:!1,isPublic:!0,ele:e?e._videoDom:void 0})}))})),e&&e._room&&e._room._virtualStreams&&e._room._virtualStreams.forEach(((e,t)=>{if(e.audioTrack){const o=e.audioTrack._audioPlayer;i.push({userId:"virtualStream-".concat(t),mediaType:"audio",isScreen:!1,isPublic:!1,isVirtual:!0,ele:o?o._audioDom:void 0,fakeEle:o?o._fakeAudioDom:void 0})}})),{timestamp:t,elementStats:i.map((e=>{let{ele:t,fakeEle:i}=e,o=Jb(e,oW);const s=Yu({ele:Yu({srcObject:t?uW(t.srcObject):void 0},iW(nW.map((e=>[e,t[e]]))))},o);return i&&(s.fakeEle=Yu({srcObject:uW(i.srcObject)},iW(nW.map((e=>[e,i[e]]))))),s}))}}(e).then((e=>{t.mediaElementStates.push(e)})),async function(e){const t=Date.now(),i=hW(e),o={};return i?(aW.forEach((e=>{o[e]=i[e]})),{timestamp:t,acState:o}):{timestamp:t,acState:void 0}}(e).then((e=>{t.audioContextStates.push(e)})),async function(e){const t=Date.now();if(lW||(lW=new AudioContext),"suspended"===lW.state&&await new Promise((t=>{const i=setTimeout((()=>{console.warn("[RTC_AMBULANCE] AudioContext resume failed, try to find one in RTCEngine"),lW=hW(e),lW&&console.warn("[RTC_AMBULANCE] find AudioContext in RTCEngine success"),t()}),1e3);lW.resume().then((()=>{clearTimeout(i),t()}),(()=>{clearTimeout(i),lW=null,t()}))})),!lW)return void console.error("[RTC_AMBULANCE] get volume is not supported");const i=mW(e),o=[];return await Promise.all(i.filter((e=>"audio"===e.mediaType)).map((async e=>{let{orgTrack:t,mediaTrack:i,preprocessingTrack:s}=e;const r=Yu({},Jb(e,sW));await Promise.all([pW(t,lW).then((e=>{r.orgTrackVolume=e})),pW(i,lW).then((e=>{r.mediaTrackVolume=e})),pW(s,lW).then((e=>{r.preprocessingTrackVolume=e}))]),o.push(r)}))),{timestamp:t,trackVolumes:o}}(e).then((e=>{t.volumes.push(e)})),async function(e){return{timestamp:Date.now(),trackStates:mW(e).map((e=>{let{orgTrack:t,mediaTrack:i,preprocessingTrack:o}=e,s=Jb(e,rW);return Yu({orgTrack:t?iW(dW.map((e=>[e,t[e]]))):void 0,mediaTrack:i?iW(dW.map((e=>[e,i[e]]))):void 0,preprocessingTrack:o?iW(dW.map((e=>[e,o[e]]))):void 0},s)}))}}(e).then((e=>{t.trackStates.push(e)})),async function(e){const t=Date.now();let i=[];e._ctx._handler&&e._ctx._handler._peerConnection&&(i=e._ctx._handler._peerConnection.getTransceivers());const o=[];return i.forEach((e=>{const t=Yu({sender:_W(e.sender),receiver:_W(e.receiver)},iW(cW.map((t=>[t,e[t]]))));o.push(t)})),{timestamp:t,tranceiverStates:o}}(e).then((e=>{t.tranceiverStates.push(e)}))),r++,r>=10?Promise.all(i).then((()=>{o()})):(clearTimeout(s),s=setTimeout(n,500))};s=setTimeout(n,500)})),console.log("RTC_AMBULANCE",t),t}class vW{constructor(){Ou(this,"containers",new WeakSet)}getContainerById(e){return document.getElementById(e)}registerContainer(e){var t;"string"==typeof e&&(e=null!==(t=this.getContainerById(e))&&void 0!==t?t:void 0);return!(!e||this.containers.has(e))&&(this.containers.add(e),!0)}unregisterContainer(e){var t;"string"==typeof e&&(e=null!==(t=this.getContainerById(e))&&void 0!==t?t:void 0);return!!e&&(this.containers.delete(e),!0)}}const SW=["videoStats","audioStats"];var yW,fW=Object.defineProperty,gW=Object.getOwnPropertyDescriptor,TW=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?gW(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&fW(t,i,r),r};const IW=(yW=class extends aT{constructor(e,t,i){var o;super(),o=this,Ou(this,"monitor",void 0),Ou(this,"logger",void 0),Ou(this,"_room",void 0),Ou(this,"_wtnStreamManager",void 0),Ou(this,"_appId",void 0),Ou(this,"_localImgVideoTrack",void 0),Ou(this,"_localImgScreenTrack",void 0),Ou(this,"_localScreenVideoTrack",void 0),Ou(this,"_localScreenAudioTrack",void 0),Ou(this,"_tempMixingAudioTrack",void 0),Ou(this,"_localAudioVolume",100),Ou(this,"_localScreenAudioVolume",100),Ou(this,"_remoteAudioVolume",new Map),Ou(this,"_remoteScreenAudioVolume",new Map),Ou(this,"_localVideoPlayerConfig",{[qu.STREAM_INDEX_MAIN]:new Map,[qu.STREAM_INDEX_SCREEN]:new Map}),Ou(this,"_remoteVideoPlayerConfig",{[qu.STREAM_INDEX_MAIN]:new Map,[qu.STREAM_INDEX_SCREEN]:new Map}),Ou(this,"_publicStreamIds",new Map),Ou(this,"_dummyMainImage",void 0),Ou(this,"_dummyScreenImage",void 0),Ou(this,"_trackSourceType",void 0),Ou(this,"_liveTranscodeConfig",void 0),Ou(this,"_startCloudProxyTimestamp",void 0),Ou(this,"_pauseAllSubscribeState",{audio:void 0,video:void 0,resumeAudioStreamIds:{},resumeVideoStreamIds:{}}),Ou(this,"_audioVolumeIndicationTimer",void 0),Ou(this,"_dummyMainTimer",void 0),Ou(this,"_dummyScreenTimer",void 0),Ou(this,"_audioPropertiesReportTimer",null),Ou(this,"_mirrorType",sh.MIRROR_TYPE_RENDER),Ou(this,"_audioMixingManager",void 0),Ou(this,"_pubLock",void 0),Ou(this,"_subLocks",void 0),Ou(this,"_audioCaptureLock",void 0),Ou(this,"_videoCaptureLock",void 0),Ou(this,"_screenCaptureLock",void 0),Ou(this,"_subScreenLocks",void 0),Ou(this,"_rtmClient",void 0),Ou(this,"_messageStatisticsObserver",void 0),Ou(this,"_waitForNewToken",!1),Ou(this,"_originIceConfigRequestUrls",void 0),Ou(this,"_originConfigServerUrls",void 0),Ou(this,"_originLogServerUrl",void 0),Ou(this,"_audioDeviceManager",void 0),Ou(this,"_config",void 0),Ou(this,"_needClosePreTrack",!1),Ou(this,"_containerCollisionDetector",new vW),Ou(this,"_ctx",void 0),Ou(this,"_removeDeviceEventHandler",void 0),Ou(this,"_updateMixAudioTrack",(async function(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Nh.PLAYOUT_AND_PUBLISH;if(o.logger.info("_updateMixAudioTrack()"),!o._localAudioTrack)return void(e&&(o._tempMixingAudioTrack={track:e,type:i}));e?(o._localAudioTrack.mixType=i,o._localAudioTrack.mixedAudioTrack=e):(delete o._localAudioTrack.mixType,delete o._localAudioTrack.mixedAudioTrack);await(null===(t=o._room)||void 0===t?void 0:t.hasPublished())&&await o._updatePublish(),o._wtnStreamManager._updatePushTrack()})),Ou(this,"_onVideoDeviceStateChange",(e=>{this.safeEmit(wh.onVideoDeviceStateChanged,e)})),Ou(this,"_onAudioDeviceStateChange",(e=>{this.safeEmit(wh.onAudioDeviceStateChanged,e)})),Ou(this,"_onAudioMixingMessage",(e=>{this.safeEmit(wh.onAudioMixingStateChanged,e)})),Ou(this,"_onAudioMixingAutoplayFailed",(e=>{this.safeEmit(wh.onAutoplayFailed,e)})),this.id=t,this._appId=e,this.monitor=Nv(t),this._ctx=new qx(t,e,i),this._pubLock=new GP("pubLock"),this._subLocks=new Map,this._subScreenLocks=new Map,this._audioCaptureLock=new GP("audioCap"),this._videoCaptureLock=new GP("videoCap"),this._screenCaptureLock=new GP("screenCap"),this._addDeviceEventHandler(),this._audioDeviceManager=new HG(this._ctx),this._addSignalingEventHandler(),this._wtnStreamManager=new UG(this._ctx),this._addWTNStreamEventHandler(),By&&(window.__rtc_engine__=this,window["__rtc_engine__".concat(Math.floor(100*Math.random()+1))]=this),this._trackSourceType={video:Ku.VIDEO_SOURCE_TYPE_INTERNAL,screenVideo:Ku.VIDEO_SOURCE_TYPE_INTERNAL,audio:Uu.AUDIO_SOURCE_TYPE_INTERNAL,screenAudio:Uu.AUDIO_SOURCE_TYPE_INTERNAL},this._config=i,this._rtmClient=new ZG(this._ctx),this._handleRTMClient(this._rtmClient),this._handleAudioDeviceManager(),this._messageStatisticsObserver=new Tv(t),this.logger=new eS("Engine",0,t),lv(this.id),IW.hasReportNativeDetector||(this.monitor.reportLongString("NativeDetector",JSON.stringify(uf)),IW.hasReportNativeDetector=!0)}get appId(){return this._appId}set appId(e){this._appId=e}async updateToken(e){if(this.logger.info("updateToken()","token: %s",e),QS(e,"token"),this._room&&this._waitForNewToken)return this._waitForNewToken=!1,this._room.config.token=e,await this._join(this._room);if(!this._room)throw new HS(US.UPDATE_TOKEN_BEFORE_JOIN,"update token before join room");await this._room.updateToken(e);const t=[];if(this._room.config.tokenPublishPrivilegeExpired&&this._room.config.isAutoPublish&&this._ctx.visibility&&t.push(this._updatePublish({mediaType:$u.AUDIO_AND_VIDEO})),this._room.config.tokenSubscribePrivilegeExpired){const{isAutoSubscribeAudio:e,isAutoSubscribeVideo:i}=this._room.config,o=(e?$u.AUDIO:0)|(i?$u.VIDEO:0);o&&t.push(this._triedResumeAllRemoteStreams(o,!0))}await Promise.allSettled(t)}async setVideoCaptureDevice(e){if(this.logger.info("setVideoCaptureDevice()","deviceId: %s",e),QS(e,"deviceId"),!this._localVideoTrack)return void this._ctx.videoProfile.setCaptureDeviceId(e);if(bS&&yS){if(this._localVideoTrack.originTrack.getSettings().deviceId===e)return}const t=this._ctx.videoProfile.getCaptureConfig(e);var i;yS&&nS&&VS>=85&&VS<=91&&(null===(i=this.localVideoTrack)||void 0===i||i.removePlayerTrack());this._needClosePreTrack=this._needClosePreTrack||HT,this._needClosePreTrack&&(this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),delete this._localVideoTrack),this.logger.info("setVideoCaptureDevice()","start createCameraVideoTrack...");const o=await BL(this._ctx,t).catch((e=>{if(this._localVideoTrack&&!this._localVideoTrack.dummy)return this.logger.warn("setVideoCaptureDevice()","createCameraVideoTrack failed, stop pre VideoTrack."),this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),delete this._localVideoTrack,BL(this._ctx,t).then((e=>(this._needClosePreTrack=!0,e))).catch((async()=>{this.logger.error("setVideoCaptureDevice()","createCameraVideoTrack failed, rollback.");const t=await BL(this._ctx);throw this._switchTrack(t),e}));throw e}));this.logger.success("setVideoCaptureDevice()","createCameraVideoTrack success."),this._ctx.videoProfile.setCaptureDeviceId(e),this._localVideoTrack&&(this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy());const s=this._ctx.videoProfile.getContentHint();s&&o.setContentHint(s),await this._switchTrack(o)}async setAudioCaptureDevice(e){var t;if(this.logger.info("setAudioCaptureDevice()","deviceId: %s",e),QS(e,"deviceId"),this._ctx.audioProfileManager.updateConstraints({deviceId:{exact:e}}),!this._localAudioTrack)return;this._localAudioTrack.destroy(),this._removeLocalTrackEvents(this._localAudioTrack);const i=await qL(this._ctx,this._ctx.audioProfileManager.getConstraints());this._initLocalTrackEvents(i),this._localAudioTrack=i,this._localAudioTrack.setVolume(this._localAudioVolume),this._wtnStreamManager._updatePushTrack(),this._room&&null!==(t=this._room.localStream)&&void 0!==t&&t.pubAudio&&await this._updatePublish()}_addDeviceEventHandler(){LL.on(wh.onVideoDeviceStateChanged,this._onVideoDeviceStateChange),LL.on(wh.onAudioDeviceStateChanged,this._onAudioDeviceStateChange),this._removeDeviceEventHandler=()=>{LL.off(wh.onVideoDeviceStateChanged,this._onVideoDeviceStateChange),LL.off(wh.onAudioDeviceStateChanged,this._onAudioDeviceStateChange)}}_addSignalingEventHandler(){const e=this._ctx.signalingManager;e.on(pT.ON_CONNECTION_STATE_CHANGE,this._onConnectionStateChange.bind(this)),e.on(pT.ON_RECONNECT_FAILED,(()=>{this.safeEmit(wh.onError,{errorCode:US.RECONNECT_FAILED})})),e.on(pT.CONNECT_WITH_TCP,(()=>{this.safeEmit(wh.onIceConnectWithTcp)}))}_addWTNStreamEventHandler(){this._wtnStreamManager.__onResubscribe=e=>{const t=e.stream;t&&(t.audioTrack&&this._updateAudioPlayerState(t),t.videoTrack&&this._updateVideoPlayerState(t))},this._wtnStreamManager.__onRemoteStreamStats=e=>{this.safeEmit(wh.onPublicStreamStats,e)},this._wtnStreamManager.__onSEIMessageReceived=e=>{this.safeEmit(wh.onPublicStreamSEIMessageReceived,e)},this._wtnStreamManager.__onPlayerEvents=(e,t,i)=>{this._initPlayerEvents(e,t,i)}}_addHandlerEventHandler(){var e,t,i,o,s,r,n,a,d,c,l,u,h,m,p,_,b,v,S,y,f,g,T,I,R,E,C,Z,L,P,k,N,X,V,w,x,G,W,M,A,O,D;null===(e=this._room)||void 0===e||e.on(hT.ON_ADD_STREAM,this._onAddStream.bind(this)),null===(t=this._room)||void 0===t||t.on(hT.ON_REMOVE_STREAM,this._onRemoveStream.bind(this)),null===(i=this._room)||void 0===i||i.on(hT.USER_CONNECTION,this._onUserConnection.bind(this)),null===(o=this._room)||void 0===o||o.on(_P.ON_USER_LEAVE,this._onUserLeave.bind(this)),null===(s=this._room)||void 0===s||s.on(_P.ON_ROOM_ERROR,this._onRoomError.bind(this)),null===(r=this._room)||void 0===r||r.on(_P.ON_NETWORK_QUALITY,this._onNetworkQuality.bind(this)),null===(n=this._room)||void 0===n||n.on(hT.ON_CUSTOM_MESSAGE,this._onCustomMessage.bind(this)),null===(a=this._room)||void 0===a||a.on(hT.USER_MESSAGE_RECEIVED,this._onUserMessageReceived.bind(this)),null===(d=this._room)||void 0===d||d.on(hT.USER_BINARY_MESSAGE_RECEIVED,this._onUserBinaryMessageReceived.bind(this)),null===(c=this._room)||void 0===c||c.on(hT.ON_USER_TOKEN_WILL_EXPIRE,this._onUserTokenWillExpire.bind(this)),null===(l=this._room)||void 0===l||l.on(hT.ON_TOKEN_PUBLISH_PRIVILEGE_WILL_EXPIRE,this._onUserTokenPublishPrivilegeWillExpire.bind(this)),null===(u=this._room)||void 0===u||u.on(hT.ON_TOKEN_PUBLISH_PRIVILEGE_DID_EXPIRED,this._onUserTokenPublishPrivilegeDidExpired.bind(this)),null===(h=this._room)||void 0===h||h.on(hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_WILL_EXPIRE,this._onUserTokenSubscribePrivilegeWillExpire.bind(this)),null===(m=this._room)||void 0===m||m.on(hT.ON_TOKEN_SUBSCRIBE_PRIVILEGE_DID_EXPIRED,this._onUserTokenSubscribePrivilegeDidExpired.bind(this)),null===(p=this._room)||void 0===p||p.on(hT.POST_PROCESSING_MESSAGE,(e=>{var t;"2.0"===(null==(t=e)?void 0:t.protocol)?this._onStreamMixingEvent({error:e.error,event:e.eventType,message:e.message}):"publicStreamCallback"===e.type?this._onPushPublicStreamResult(e):"transcodeStatusCallback"===e.type&&this._onLiveTranscodingResult(e)})),null===(_=this._room)||void 0===_||_.on(pT.ON_VENDOR_CONNECTION_STATE_CHANGE,(e=>this.safeEmit(wh.onVendorConnectionStateChanged,e))),null===(b=this._room)||void 0===b||b.on(_P.RESUBSCRIBE,this._onResubscribe.bind(this)),null===(v=this._room)||void 0===v||v.on(_P.SUBSCRIBE_PUSH_TRACK,this._onSubscribePushTrack.bind(this)),null===(S=this._room)||void 0===S||S.on(_P.REMOVE_PUSH_TRACK,this._onRemovePushTrack.bind(this)),null===(y=this._room)||void 0===y||y.on(_P.ON_PUBLISH_RESULT,(e=>{var t,i,o;e.state===ju.PUBLISH_SUCC&&(null===(i=this._room)||void 0===i||i.config.setTokenPublishPrivilegeExpired(!1));e.state===ju.PUBLISH_FAIL&&e.errorCode===US.TOKEN_NO_PUBLISH_PERMISSION&&(null===(o=this._room)||void 0===o||o.config.setTokenPublishPrivilegeExpired(!0));const s=!(e.retry||null===(t=this._room)||void 0===t||!t.config.isAutoPublish);s&&this.safeEmit(wh.onAutoPublishResult,e),this.safeEmit(wh.onPublishResult,{isScreen:e.isScreen,isAutoPublish:s,errorCode:e.errorCode})})),null===(f=this._room)||void 0===f||f.on(_P.ON_SUBSCRIBE_RESULT,(e=>{var t;e.state===zu.SUBSCRIBE_SUCC&&(null===(t=this._room)||void 0===t||t.config.setTokenSubscribePrivilegeExpired(!1));e.state===zu.SUBSCRIBE_FAIL&&e.errorCode===US.TOKEN_NO_SUBSCRIBE_PERMISSION&&this._handleLoseSubscribePrivilege(),this.safeEmit(wh.onSubscribeResult,{userId:e.userId,isScreen:e.isScreen,isAutoSubscribe:!1,errorCode:e.errorCode})})),null===(g=this._room)||void 0===g||g.on(_P.ON_REMOTE_STREAM_STATS,(e=>{this.safeEmit(wh.onRemoteStreamStats,e)})),null===(T=this._room)||void 0===T||T.on(_P.ON_LOCAL_STREAM_STATS,(e=>{this.safeEmit(wh.onLocalStreamStats,e)})),null===(I=this._room)||void 0===I||I.on(_P.ON_SUBTITLE_STATE_CHANGED,(e=>{this.safeEmit(wh.onSubtitleStateChanged,e)})),null===(R=this._room)||void 0===R||R.on(_P.ON_SUBTITLE_MESSAGE_RECEIVED,(e=>{this.safeEmit(wh.onSubtitleMessageReceived,e)})),null===(E=this._room)||void 0===E||E.on(_P.ON_USER_PUBLISH_STATE_CHANGE,this._onUserPublishStateChange.bind(this)),null===(C=this._room)||void 0===C||C.on(_P.ON_USER_START_AUDIO_CAPTURE,((e,t)=>{let{userId:i}=e;this._updateAudioPlayerState(t),this.safeEmit(wh.onUserStartAudioCapture,{userId:i})})),null===(Z=this._room)||void 0===Z||Z.on(_P.ON_USER_STOP_AUDIO_CAPTURE,(e=>{let{userId:t}=e;this.safeEmit(wh.onUserStopAudioCapture,{userId:t})})),null===(L=this._room)||void 0===L||L.on(_P.ON_USER_START_VIDEO_CAPTURE,(e=>{let{userId:t}=e;this.safeEmit(wh.onUserStartVideoCapture,{userId:t})})),null===(P=this._room)||void 0===P||P.on(_P.ON_USER_STOP_VIDEO_CAPTURE,(e=>{let{userId:t}=e;this.safeEmit(wh.onUserStopVideoCapture,{userId:t})})),null===(k=this._room)||void 0===k||k.on(_P.ON_SEI_MESSAGED_RECEIVED,(e=>{this.safeEmit(wh.onSEIMessageReceived,e)})),null===(N=this._room)||void 0===N||N.on(_P.ON_REMOTE_VIDEO_SIZE_CHANGED,((e,t)=>{this.safeEmit(wh.onRemoteVideoSizeChanged,e,t)})),null===(X=this._room)||void 0===X||X.on(_P.ON_SIMULCAST_SUBSCRIBE_FALLBACK,(e=>this.safeEmit(wh.onSimulcastSubscribeFallback,e))),null===(V=this._room)||void 0===V||V.on(_P.ON_VIDEO_STREAM_BANNED,(e=>{this.safeEmit(wh.onVideoStreamBanned,{uid:e.uid,banned:e.banned})})),null===(w=this._room)||void 0===w||w.on(_P.ON_AUDIO_STREAM_BANNED,(e=>{this.safeEmit(wh.onAudioStreamBanned,{uid:e.uid,banned:e.banned})})),null===(x=this._room)||void 0===x||x.on(_P.ON_FORWARD_STREAM_ERROR,(e=>{this.safeEmit(wh.onForwardStreamError,e)})),null===(G=this._room)||void 0===G||G.on(_P.ON_REJOIN_WITH_TCP,(()=>{this.safeEmit(wh.onRejoinWithTcp)})),null===(W=this._room)||void 0===W||W.on(_P.PUB_RETRY,(e=>{this.safeEmit(wh.onPublishRetry,e)})),null===(M=this._room)||void 0===M||M.on(_P.SUB_RETRY,(e=>{this.safeEmit(wh.onSubscribeRetry,e)})),null===(A=this._room)||void 0===A||A.on(_P.VIDEO_TYPE_CHANGE,(e=>{this.safeEmit(wh.onSEIStreamUpdate,e)})),null===(O=this._room)||void 0===O||O.on(_P.JOIN_SUCCESS,(e=>{this._ctx.isPreConnection||this.safeEmit(wh.onConnectionStateChanged,{state:e?th.CONNECTION_STATE_RECONNECTED:th.CONNECTION_STATE_CONNECTED})})),null===(D=this._room)||void 0===D||D.on(_P.UPDATE_PUBLISH,(e=>{let{streamIndex:t}=e;t===qu.STREAM_INDEX_MAIN?this._updatePublish():t===qu.STREAM_INDEX_SCREEN&&this._updateScreenPublish()}))}safeEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];if(function(e){const t=vy("FORCE_ENABLED_REPORT_CALLBACKS");if(null!=t&&t.includes(e))return!0;if(e===wh.onRemoteStreamStats&&vy("UPLOAD_REMOTE_STATS"))return!0;return![wh.onRemoteStreamStats,wh.onLocalStreamStats,wh.onAudioVolumeIndication,wh.onLocalAudioPropertiesReport,wh.onRemoteAudioPropertiesReport].includes(e)}(e)){if(e===wh.onRemoteStreamStats){const e=vy("UPLOAD_REMOTE_STATS"),t=vy("FORCE_ENABLED_REPORT_CALLBACKS").includes("onRemoteStreamStats"),o=i[0],{videoStats:s,audioStats:r}=o,n=Jb(o,SW);i[0]=Yu({},n),(e&$u.VIDEO||t)&&(i[0].videoStats=s),(e&$u.AUDIO||t)&&(i[0].audioStats=r)}Gv(this.id,e,i)}return super.safeEmit(e,...i)}_removeHandlerEventHandler(){var e;null===(e=this._room)||void 0===e||e.removeAllListeners()}async connect(){await this._ctx.signalingManager.connect()}async joinRoom(e,t,i,o){var s,r,n,a;if(this.logger.info("joinRoom()","token: %o roomId: %o, userInfo: %o, roomConfig: %o",e,t,i,o),iy(e)||QS(e,"token"),this._room)throw new HS(US.REPEAT_JOIN,"Already joined");oy(t),function(e){$S(e,"userInfo"),sy(e.userId),iy(e.extraInfo)||QS(e.extraInfo,"userInfo.extraInfo",1,200)}(i);const d=new HP({token:e,roomId:t,userInfo:i},this._ctx);return function(e){$S(e,"roomConfig"),JS(e.isAutoPublish,"roomConfig.isAutoPublish"),JS(e.isAutoSubscribeAudio,"roomConfig.isAutoSubscribeAudio"),JS(e.isAutoSubscribeVideo,"roomConfig.isAutoSubscribeVideo"),iy(e.roomProfileType)||BS(e.roomProfileType,"roomConfig",[_h.communication,_h.chat,_h.chatRoom,_h.coHost,_h.meeting,_h.classRoom])}(d.updateRoomConfig(o)),d.setLiveControlMessage(this._liveTranscodeConfig&&qG.getStartParams(this._liveTranscodeConfig)),this._room=new gG(d,this._ctx),this.monitor.set({rtc_session_id:this._room.config.sessionId}),this._addHandlerEventHandler(),this._ctx.useCloudProxy&&(this._startCloudProxyTimestamp=Date.now()),null===(s=this._localVideoTrack)||void 0===s||s.setUserId(i.userId),null===(r=this._localScreenVideoTrack)||void 0===r||r.setUserId(i.userId),null===(n=this._localAudioTrack)||void 0===n||n.setUserId(i.userId),null===(a=this._localScreenAudioTrack)||void 0===a||a.setUserId(i.userId),(e=>{if(e.extraInfo)try{const t=JSON.parse(e.extraInfo);t.source_language&&["zh","en","ja"].indexOf(t.source_language)}catch(i){}else{var t;const i=(null===(t=navigator.language)||void 0===t?void 0:t.substring(0,2))||"";["zh","en","ja"].indexOf(i)>-1&&(e.extraInfo=JSON.stringify({source_language:i}))}})(i),await this._join(this._room)}async _join(e){try{var t;const i=await e.join();return this._waitForNewToken=!1,this._ctx.audioProfileManager.setRoomId(e.config.roomId),null!==(t=this._room)&&void 0!==t&&t.config.isAutoPublish&&(this._ctx.visibility?this._updatePublish({invokeByJoinRoom:!0,mediaType:$u.AUDIO_AND_VIDEO}).catch((e=>{this.logger.error("_join","_updatePublish failed",e)})):(this.safeEmit(wh.onAutoPublishResult,{isScreen:!1,state:ju.PUBLISH_FAIL}),this.safeEmit(wh.onPublishResult,{isScreen:!1,isAutoPublish:!0,errorCode:US.NO_PUBLISH_PERMISSION}))),this.monitor.set({rtc_vid:e.config.rtcVid}),hv(this.id,e.config.roomId),mv(this.id,e.config.userId),i}catch(i){throw i.code===US.INVALID_TOKEN?this._waitForNewToken=!0:(e.destroy(),this._room===e&&delete this._room),i}}async leaveRoom(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.logger.info("leaveRoom()");const t=this._room;delete this._room,this._ctx.resetPubSubLock(Qx.LEAVE),this._ctx.callId=void 0,e?await(null==t?void 0:t.leave(e)):null==t||t.leave(e).catch(),this._removeHandlerEventHandler(),this._subLocks=new Map,this._subScreenLocks=new Map,this._ctx.audioProfileManager.setRoomId(),this._liveTranscodeConfig&&this.stopLiveTranscoding(),null==t||t.destroy(),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_MAIN].forEach((e=>{e.forEach((e=>{const{player:t,renderDom:i}=e;null==t||t.destroy(),this._containerCollisionDetector.unregisterContainer(i)}))})),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_MAIN].clear(),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].forEach((e=>{e.forEach((e=>{const{player:t,renderDom:i}=e;null==t||t.destroy(),this._containerCollisionDetector.unregisterContainer(i)}))})),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].clear(),this._publicStreamIds=new Map,hv(this.id,""),mv(this.id,""),this.monitor.set({rtc_session_id:"",rtc_vid:""})}_destroyLocalTrack(){this._localAudioTrack&&(this._removeLocalTrackEvents(this._localAudioTrack),this._localAudioTrack.destroy(),this._localAudioTrack=void 0),this._localVideoTrack&&(this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),this._localVideoTrack=void 0),this._localScreenAudioTrack&&(this._removeLocalTrackEvents(this._localScreenAudioTrack),this._localScreenAudioTrack.destroy(),this._localScreenAudioTrack=void 0),this._localScreenVideoTrack&&(this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy(),this._localScreenVideoTrack=void 0),this._localImgVideoTrack&&(this._localImgVideoTrack.stop(),this._localImgVideoTrack=void 0),this._localImgScreenTrack&&(this._localImgScreenTrack.stop(),this._localImgScreenTrack=void 0)}destroy(){var e,t,i;this.logger.info("destroy()"),this.removeAllListeners(),this._removeHandlerEventHandler(),null===(e=this._removeDeviceEventHandler)||void 0===e||e.call(this),null===(t=this._room)||void 0===t||t.destroy(),this._room=void 0,this._subLocks=new Map,this._subScreenLocks=new Map,this._audioCaptureLock=new GP("audioCap"),this._videoCaptureLock=new GP("videoCap"),this._screenCaptureLock=new GP("screenCap"),this._pauseAllSubscribeState={audio:void 0,video:void 0,resumeVideoStreamIds:{},resumeAudioStreamIds:{}},this._messageStatisticsObserver.destroy(),this.monitor.destroy(),uv(this.id),clearInterval(this._audioVolumeIndicationTimer),clearInterval(this._dummyMainTimer),clearInterval(this._dummyScreenTimer),this._audioVolumeIndicationTimer=void 0,this._stopAudioPropertiesReport(),this._destroyLocalTrack(),null===(i=this._audioMixingManager)||void 0===i||i.destroy(),this._rtmClient.destroy(),this._wtnStreamManager.destroy(),this._publicStreamIds=new Map,this._audioDeviceManager.destroy(),this._ctx.destroy(),this._localAudioVolume=100,this._localScreenAudioVolume=100,this._remoteAudioVolume.clear(),this._remoteScreenAudioVolume.clear(),this._localVideoPlayerConfig[qu.STREAM_INDEX_MAIN].forEach((e=>{e.player.destroy()})),this._localVideoPlayerConfig[qu.STREAM_INDEX_MAIN].clear(),this._localVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].forEach((e=>{e.player.destroy()})),this._localVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].clear(),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_MAIN].forEach((e=>{e.forEach((e=>{e.player.destroy()}))})),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_MAIN].clear(),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].forEach((e=>{e.forEach((e=>{e.player.destroy()}))})),this._remoteVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].clear()}async publishStream(e){this.logger.info("publishStream()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom(),Uy(e)&&!this._localVideoTrack&&this._localImgVideoTrack&&(this._localVideoTrack=await async function(e,t){const i=new wL(e,t,{streamIndex:gT.MAIN,sourceType:yT.INTERNAL,isDummy:!0});return await i.isTrackReady,i}(this._ctx,this._localImgVideoTrack)),await this._updatePublish({mediaType:e},!0)}async unpublishStream(e,t){var i;if(this.logger.info("unpublishStream()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom(),t)return null===(i=this._room)||void 0===i?void 0:i.unpublish();await this._updatePublish({mediaType:e,pubState:vP.UNPUB},!0)}async publishScreen(e){this.logger.info("publishScreen()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom();try{Uy(e)&&!this._localScreenVideoTrack&&this._localImgScreenTrack&&(this._localScreenVideoTrack=await async function(e,t){const i=new wL(e,t,{isDummy:!0,streamIndex:gT.SCREEN,sourceType:yT.INTERNAL});return await i.isTrackReady,i}(this._ctx,this._localImgScreenTrack)),await this._updateScreenPublish({mediaType:e,pubState:vP.PUB})}catch(BW){throw BW instanceof HS?BW:new HS(US.UNEXPECTED_ERROR,"unexpected error",BW)}}async unpublishScreen(e){this.logger.info("unpublishScreen()","mediaType: %o",e),this._checkMediaType(e),this._assertNotInRoom(),await this._updateScreenPublish({mediaType:e,pubState:vP.UNPUB})}async subscribeStream(e,t){return this.logger.info("subscribeStream()","userId: %o, mediaType: %o",e,t),this._subscribe(!1,e,t)}async _subscribe(e,t,i){var o;const s=i;if(i===$u.AUDIO&&null!==(o=this._room)&&void 0!==o&&o.config.isMultiChatMode())return void this.logger.warn("subscribeStream()","due to multiChatMode return");const r=this._room.remoteStreams.get(t),n=null==r?void 0:r.find((t=>t.isScreen===e));if(!n)throw new HS(US.STREAM_NOT_EXIST,"stream not exist");const a=this._pauseAllSubscribeState.audio,d=this._pauseAllSubscribeState.video;this._pauseAllSubscribeState.audio&&(i-=i&$u.AUDIO),this._pauseAllSubscribeState.video&&(i-=i&$u.VIDEO),this.logger.warn("subscribeStream()","due to pauseAll mediaType: %o",i);const{hasSubscribed:c}=n;n.originalMediaType=i;try{var l;await this._room.subscribe(n,i),Ky(i)&&this._updateAudioPlayerState(n),Uy(i)&&this._updateVideoPlayerState(n);let o=0,r=0;if(a!==this._pauseAllSubscribeState.audio&&(this._pauseAllSubscribeState.audio?o|=$u.AUDIO:r|=$u.AUDIO),d!==this._pauseAllSubscribeState.video&&(this._pauseAllSubscribeState.video?o|=$u.VIDEO:r|=$u.VIDEO),o&&this.pauseAllSubscribedStream(o),r&&this.resumeAllSubscribedStream(r),Ky(s)&&(this._pauseAllSubscribeState.resumeAudioStreamIds[n.streamId]=n.streamId),Uy(s)&&(this._pauseAllSubscribeState.resumeVideoStreamIds[n.streamId]=n.streamId),n.audioTrack||n.videoTrack){var u,h;const i=!(e||!(null!==(u=this._room)&&void 0!==u&&u.config.isAutoSubscribeAudio||null!==(h=this._room)&&void 0!==h&&h.config.isAutoSubscribeVideo)),o={userId:t,isScreen:!1,state:zu.SUBSCRIBE_SUCC};i&&this.safeEmit(wh.onAutoSubscribeResult,o),this.safeEmit(wh.onSubscribeResult,{userId:t,isScreen:e,isAutoSubscribe:i})}var m,p;if((null===(l=this._room)||void 0===l||!l.config.isMultiChatMode())&&!c&&Ky(i)&&n.hasAudio)null===(m=n.observer)||void 0===m||m.setSubscribeAudio(!0);if(!c&&Uy(i)&&n.hasVideo)null===(p=n.observer)||void 0===p||p.setSubscribeVideo(!0)}catch(BW){throw BW instanceof HS&&BW.code===US.TOKEN_NO_SUBSCRIBE_PERMISSION&&this._handleLoseSubscribePrivilege(),BW}}async _handleLoseSubscribePrivilege(){var e;null===(e=this._room)||void 0===e||e.config.setTokenSubscribePrivilegeExpired(!0);try{await this._unSubscribeAllRemoteStreams()}catch(BW){}}async unsubscribeStream(e,t){return this.logger.info("unsubscribeStream()","userId: %o, mediaType: %o",e,t),this._unsubscribe(!1,e,t)}async subscribeScreen(e,t){return this.logger.info("subscribeScreen() userId: %o, mediaType: %o",e,t),this._subscribe(!0,e,t)}async unsubscribeScreen(e,t){return this.logger.info("unsubscribeScreen() userId: %o, mediaType: %o",e,t),this._unsubscribe(!0,e,t)}_unsubscribe(e,t,i,o){var s;if(i===$u.AUDIO&&null!==(s=this._room)&&void 0!==s&&s.config.isMultiChatMode())return void this.logger.warn("subscribeStream()","due to multiChatMode return");const r=this._room.remoteStreams.get(t),n=null==r?void 0:r.find((t=>t.isScreen===e));if(!n)throw new HS(US.STREAM_NOT_EXIST,"stream not exist");var a;yS&&VS&&VS>=85&&VS<=91&&i!==$u.AUDIO&&(null===(a=n.videoTrack)||void 0===a||a.stopAll());return this._room.unsubscribe(n,i).then((()=>{o||(Ky(i)&&delete this._pauseAllSubscribeState.resumeAudioStreamIds[n.streamId],Uy(i)&&delete this._pauseAllSubscribeState.resumeVideoStreamIds[n.streamId])}))}async setRemoteVideoConfig(e,t){var i;return this.logger.info("setRemoteVideoConfig() userId: %o, remoteVideoConfig: %o",e,t),this._ctx.videoProfile.checkSimulcastApiVersion("old"),sy(e),function(e){if("number"!=typeof(null==e?void 0:e.width)||"number"!=typeof(null==e?void 0:e.height))throw new HS(US.INVALID_PARAMS,"remoteVideoConfig must contain width, height, frameRate")}(t),this._ctx.videoProfile.setRemoteUserVideoConfig(e,t),null===(i=this._room)||void 0===i?void 0:i.updateSubVideoConfig(e).then((()=>{}))}async setRemoteSimulcastStreamType(e,t){var i;this.logger.info("setRemoteSimulcastStreamType()","userId: %s, streamType: %s",e,t),this._ctx.videoProfile.checkSimulcastApiVersion("new"),sy(e),BS(t,"SimulcastStreamType",[Ch.VIDEO_STREAM_HIGH,Ch.VIDEO_STREAM_MID,Ch.VIDEO_STREAM_LOW]),this._ctx.videoProfile.setRemoteUserVideoConfig(e,t),await(null===(i=this._room)||void 0===i?void 0:i.updateSubVideoConfig(e))}async startVideoCapture(e){var t,i;if(this.logger.info("startVideoCapture()","deviceId: %s",e),iy(e)||QS(e,"deviceId"),e&&this._ctx.videoProfile.setCaptureDeviceId(e),this._trackSourceType.video===Ku.VIDEO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as internal first");if(this._localVideoTrack&&!this._localVideoTrack.dummy)throw new HS(US.REPEAT_CAPTURE,"Has already capture");let o={};const s=await BL(this._ctx),r=this._ctx.videoProfile.getContentHint();r&&s.setContentHint(r),this._initLocalTrackEvents(s),this._localVideoTrack=s;this._localVideoPlayerConfig[qu.STREAM_INDEX_MAIN].forEach((e=>{var t,i;null===(t=this._localVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))}));o=s.originTrack.getSettings();const n={width:o.width,height:o.height};if(this._localVideoTrack.resolution=n,this._ctx.videoProfile.__autoResetVideoEncoderConfig(o),setTimeout((()=>this.safeEmit(wh.onLocalVideoSizeChanged,{streamIndex:qu.STREAM_INDEX_MAIN,info:n}))),this._ctx.engineDestroyed)return this._destroyLocalTrack(),o;if(this._wtnStreamManager._updatePushTrack(),!this._room)return o;const{isAutoPublish:a}=this._room.config;return(null!==(t=this._room.localStream)&&void 0!==t&&t.pubVideo||a)&&this._ctx.visibility&&this._updatePublish(),null===(i=this._room.localStream)||void 0===i||null===(i=i.observer)||void 0===i||i.setEnableVideo(!0),o}async getLocalStreamStats(){var e;return await(null===(e=this._room)||void 0===e?void 0:e.getLocalStreamStats())}async stopVideoCapture(){var e,t;if(this.logger.info("stopVideoCapture()"),this._trackSourceType.video===Ku.VIDEO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as internal first");if(this._localVideoTrack&&!this._localVideoTrack.dummy){const e=this._ctx.extensionManager.getPluginByName(_L.PRE_PROCESSING,"RTCBeautyExtension");e&&e.emit("stop"),this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy(),this._localImgVideoTrack?this._localVideoTrack.setTrack(this._localImgVideoTrack,{isDummy:!0}):this._localVideoTrack=void 0}this._wtnStreamManager._updatePushTrack(),this._room&&(null!==(e=this._room.localStream)&&void 0!==e&&e.pubVideo&&await this._updatePublish(),null===(t=this._room.localStream)||void 0===t||null===(t=t.observer)||void 0===t||t.setEnableVideo(!1))}async startAudioCapture(e){var t,i;if(this.logger.info("startAudioCapture()","deviceId: $o",e),iy(e)||QS(e,"deviceId"),e&&this._ctx.audioProfileManager.updateConstraints({deviceId:{exact:e}}),this._trackSourceType.audio===Uu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as internal first");if(this._localAudioTrack)throw new HS(US.REPEAT_CAPTURE,"Has already capture");let o={};const s=await qL(this._ctx,this._ctx.audioProfileManager.getConstraints());o=s.originTrack.getSettings(),this._initLocalTrackEvents(s),this._localAudioTrack=s,this._localAudioTrack.setVolume(this._localAudioVolume);const{frameSize:r,callback:n}=this._ctx._localAudioTrackDumpConfig[qu.STREAM_INDEX_MAIN];r&&n&&this._localAudioTrack.setDataFetcher(r,n);const{position:a,volume:d}=this._ctx.earMonitorSettings[qu.STREAM_INDEX_MAIN];if(a!==Zh.NONE&&(this._localAudioTrack.play(a),this._localAudioTrack.setPlaybackVolume(d)),this._tempMixingAudioTrack&&(this._localAudioTrack.mixType=this._tempMixingAudioTrack.type,this._localAudioTrack.mixedAudioTrack=this._tempMixingAudioTrack.track,delete this._tempMixingAudioTrack),this._ctx.engineDestroyed)return this._destroyLocalTrack(),o;if(this._wtnStreamManager._updatePushTrack(),!this._room)return o;const{isAutoPublish:c}=this._room.config;return(null!==(t=this._room.localStream)&&void 0!==t&&t.pubAudio||c)&&this._ctx.visibility&&this._updatePublish(),null===(i=this._room.localStream)||void 0===i||null===(i=i.observer)||void 0===i||i.setEnableAudio(!0),o}async stopAudioCapture(){var e,t,i;if(this.logger.info("stopAudioCapture()"),this._trackSourceType.audio===Uu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as internal first");this._localAudioTrack&&(this._removeLocalTrackEvents(this._localAudioTrack),this._localAudioTrack.destroy()),this._localAudioTrack=void 0,null===(e=this._audioMixingManager)||void 0===e||e.stopAll(),this._wtnStreamManager._updatePushTrack(),this._room&&(null!==(t=this._room.localStream)&&void 0!==t&&t.pubAudio&&await this._updatePublish(),null===(i=this._room.localStream)||void 0===i||null===(i=i.observer)||void 0===i||i.setEnableAudio(!1))}async startAudioAndVideoCapture(e,t){var i,o,s,r;this.logger.print("startAudioAndVideoCapture","optionsOrAudioDeviceId: $o",e,"videoDeviceId: $o",t);const{audioDeviceId:n,videoDeviceId:a}=function(e,t){let i;return iy(t)||QS(t,"videoDeviceId"),iy(e)||("string"==typeof e?(QS(e,"audioDeviceId"),i=e):(i=null==e?void 0:e.audioDeviceId,t=null==e?void 0:e.videoDeviceId,QS(i,"audioDeviceId"),QS(t,"videoDeviceId"))),{audioDeviceId:i,videoDeviceId:t}}(e,t);if(n&&this._ctx.audioProfileManager.updateConstraints({deviceId:{exact:n}}),this._trackSourceType.video===Ku.VIDEO_SOURCE_TYPE_EXTERNAL||this._trackSourceType.audio===Uu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,this._trackSourceType.video===Ku.VIDEO_SOURCE_TYPE_EXTERNAL?"setVideoSourceType as internal first":"setAudioSourceType as internal first");if(this._localVideoTrack&&!this._localVideoTrack.dummy)throw new HS(US.REPEAT_CAPTURE,"video has already capture");if(this._localAudioTrack)throw new HS(US.REPEAT_CAPTURE,"audio has already capture");const d=this._ctx.videoProfile.getCaptureConfig(a);let c={},l={};const{audioTrack:u,videoTrack:h}=await async function(e,t,i){var o,s;let r;new eS("TrackFactory",0,e.id).print("createCameraAndMicrophoneTrack","audioConstraints:",t,"videoConstraints:",i);const n=(null===(o=t.deviceId)||void 0===o?void 0:o.exact)||"default",a=(null===(s=i.deviceId)||void 0===s?void 0:s.exact)||"default",d=vm(),c=vm();try{var l,u,h,m,p,_;null===(l=e.monitor)||void 0===l||l.report("rtc_video_capture_event",{event_type:"start",media_device_id:a,capture_session_id:d}),null===(u=e.monitor)||void 0===u||u.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_begin",media_device_id:n,event_session_id:c});const o=wy();sS&&(i.frameRate={ideal:30,max:30}),e.extensionManager.getPluginByName(_L.PRE_PROCESSING,"RTCAIAnsExtension")&&(t.autoGainControl=!0,t.noiseSuppression=!1),r=await LL.getUserMedia({audio:t,video:i}),null===(h=e.monitor)||void 0===h||h.report("rtc_video_capture_event",{event_type:"start_capture_result",media_device_id:a,media_device_name:(null===(m=r.getVideoTracks()[0])||void 0===m?void 0:m.label)||"",reason:"success",elapse:wy()-o,capture_session_id:d}),null===(p=e.monitor)||void 0===p||p.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_result",media_device_id:n,media_device_name:(null===(_=r.getAudioTracks()[0])||void 0===_?void 0:_.label)||"",reason:"success",elapse:wy()-o,event_session_id:c})}catch(BW){var b,v;throw null===(b=e.monitor)||void 0===b||b.report("rtc_video_capture_event",{event_type:"running_failed",media_device_id:a,error_code:BW.code,reason:BW.name+BW.message,capture_session_id:d}),null===(v=e.monitor)||void 0===v||v.report("rtc_audio_device_event",{device_type:"audio_record",event_type:"start_end",media_device_id:n,error_code:BW.code,reason:BW.name+BW.message,event_session_id:c}),new HS(US.GET_VIDEO_TRACK_FAILED,"throw error from getUserMedia. [".concat(BW.name||"unknown name","]: ").concat(BW.message||"unknown message","."),BW)}const S=r.getVideoTracks()[0],y=new wL(e,S,{streamIndex:gT.MAIN,sourceType:yT.INTERNAL,captureSessionId:d}),f=r.getAudioTracks()[0],g=new YL(e,f,{streamIndex:gT.MAIN,sourceType:yT.INTERNAL,captureSessionId:c});return await Promise.all([y.isTrackReady,g.isTrackReady]),{videoTrack:y,audioTrack:g}}(this._ctx,this._ctx.audioProfileManager.getConstraints(),d),m=this._ctx.videoProfile.getContentHint();m&&h.setContentHint(m),a&&this._ctx.videoProfile.setCaptureDeviceId(a),this._initLocalTrackEvents(h),this._localVideoTrack=h;this._localVideoPlayerConfig[qu.STREAM_INDEX_MAIN].forEach((e=>{var t,i;null===(t=this._localVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),this._initLocalTrackEvents(u),this._localAudioTrack=u,this._localAudioTrack.setVolume(this._localAudioVolume);const{frameSize:p,callback:_}=this._ctx._localAudioTrackDumpConfig[qu.STREAM_INDEX_MAIN];p&&_&&this._localAudioTrack.setDataFetcher(p,_),this._tempMixingAudioTrack&&(this._localAudioTrack.mixType=this._tempMixingAudioTrack.type,this._localAudioTrack.mixedAudioTrack=this._tempMixingAudioTrack.track,delete this._tempMixingAudioTrack);let b=h.originTrack;c=b.getSettings();const v={width:c.width||0,height:c.height||0};if(this._localVideoTrack.resolution=v,this._ctx.videoProfile.__autoResetVideoEncoderConfig(c),setTimeout((()=>this.safeEmit(wh.onLocalVideoSizeChanged,{streamIndex:qu.STREAM_INDEX_MAIN,info:v}))),b=u.originTrack,l=b.getSettings(),this._ctx.engineDestroyed)return this._destroyLocalTrack(),{audioTrackSettings:l,videoTrackSettings:c};if(this._wtnStreamManager._updatePushTrack(),!this._room)return{audioTrackSettings:l,videoTrackSettings:c};const{isAutoPublish:S}=this._room.config;return(null!==(i=this._room.localStream)&&void 0!==i&&i.pubVideo||null!==(o=this._room.localStream)&&void 0!==o&&o.pubAudio||S)&&this._ctx.visibility&&this._updatePublish(),null===(s=this._room.localStream)||void 0===s||null===(s=s.observer)||void 0===s||s.setEnableVideo(!0),null===(r=this._room.localStream)||void 0===r||null===(r=r.observer)||void 0===r||r.setEnableAudio(!0),{audioTrackSettings:l,videoTrackSettings:c}}async startVideoAndAudioCapture(e,t){return this.startAudioAndVideoCapture(t,e)}getAudioMixingManager(){return this.logger.info("getAudioMixingManager()","invoke"),this._audioMixingManager||(this._audioMixingManager=new CG({getLocalAudioTrack:()=>this._localAudioTrack,updateLocalAudioTrack:this._updateMixAudioTrack,emitMessage:this._onAudioMixingMessage,onAutoPlayFailed:this._onAudioMixingAutoplayFailed},this.id)),this._audioMixingManager}getWTNStreamManager(){return this._wtnStreamManager}getCallId(){var e;return null===(e=this._ctx)||void 0===e?void 0:e.callId}async startScreenCapture(){var e,t,i;let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.logger.info("startScreenCapture()","config: %o",o),this._trackSourceType.screenVideo===Ku.VIDEO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as internal first");if(this._trackSourceType.screenAudio===Uu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as internal first");const[s,r]=await $L(this._ctx,o);null==r||r.setVolume(this._localScreenAudioVolume),this._localScreenVideoTrack&&!this._localScreenVideoTrack.dummy&&(this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy()),null===(e=this._localScreenAudioTrack)||void 0===e||e.destroy(),delete this._localScreenAudioTrack,this._localScreenVideoTrack=s;const{contentHint:n}=this._ctx.videoProfile.getScreenEncodeConfig();n&&s.setContentHint(n);const a=s.originTrack;setTimeout((()=>{const e=a.getSettings(),t={width:e.width,height:e.height};s.resolution=t,this.safeEmit(wh.onLocalVideoSizeChanged,{streamIndex:qu.STREAM_INDEX_SCREEN,info:{width:e.width,height:e.height}})}),500),r&&(this._localScreenAudioTrack=r,this._initLocalTrackEvents(r));this._localVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].forEach((e=>{var t,i;null===(t=this._localScreenVideoTrack)||void 0===t||t.setPlayer(e,sh.MIRROR_TYPE_NONE,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),this._initLocalTrackEvents(this._localScreenVideoTrack,!0),(null!==(t=this._room)&&void 0!==t&&null!==(t=t.localScreenStream)&&void 0!==t&&t.pubAudio||null!==(i=this._room)&&void 0!==i&&null!==(i=i.localScreenStream)&&void 0!==i&&i.pubVideo)&&await this._updateScreenPublish()}async stopScreenCapture(){var e,t,i,o;this.logger.info("stopScreenCapture()"),null===(e=this._localScreenVideoTrack)||void 0===e||e.stopAll(),this._localScreenVideoTrack&&(this._localScreenVideoTrack.dummy||(this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy(),this._localImgScreenTrack&&this._localScreenVideoTrack.setTrack(this._localImgScreenTrack,{isDummy:!0}))),this._localScreenAudioTrack&&(this._removeLocalTrackEvents(this._localScreenAudioTrack),this._localScreenAudioTrack.destroy()),this._localScreenAudioTrack=void 0,null!==(t=this._localScreenVideoTrack)&&void 0!==t&&t.dummy||(this._localScreenVideoTrack=void 0),(null!==(i=this._room)&&void 0!==i&&null!==(i=i.localScreenStream)&&void 0!==i&&i.pubAudio||null!==(o=this._room)&&void 0!==o&&null!==(o=o.localScreenStream)&&void 0!==o&&o.pubVideo)&&await this._updateScreenPublish()}setLocalVideoPlayer(e,t){var i;this.logger.info("setLocalVideoPlayer()","streamIndex: %o, videoPlayerOption: %o",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]);const o=e===qu.STREAM_INDEX_MAIN?this._localVideoTrack:this._localScreenVideoTrack,s=null!==(i=null==t?void 0:t.playerId)&&void 0!==i?i:XL;if(null==t||!t.renderDom){var r,n;null===(r=this._localVideoPlayerConfig[e].get(s))||void 0===r||null===(r=r.player)||void 0===r||r.destroy();const t=null===(n=this._localVideoPlayerConfig[e].get(s))||void 0===n?void 0:n.renderDom;return this._containerCollisionDetector.unregisterContainer(t),void this._localVideoPlayerConfig[e].delete(s)}ny(t);const a=this._localVideoPlayerConfig[e].get(s);if(!a){var d,c,l;const{renderDom:i}=t;if(!this._containerCollisionDetector.registerContainer(i))return this.monitor.report("rtc_error",{message:"RenderDom is not empty",error_code:PL.DUPLICATE_DOM}),void zy("renderDom is not empty");const r=new AL(this._ctx.id,s,Yu(Yu({},t),{},{isLocal:!0,isScreen:e===qu.STREAM_INDEX_SCREEN,userId:null!==(d=t.userId)&&void 0!==d?d:"_local_"})),n=Yu(Yu({},t),{},{player:r});return this._localVideoPlayerConfig[e].set(s,n),null==o||o.setPlayer(n,e===qu.STREAM_INDEX_MAIN?this._mirrorType:sh.MIRROR_TYPE_NONE,null===(c=this._config)||void 0===c?void 0:c.autoPlayPolicy,this._initPlayerEvents.bind(this)),null===(l=n.player)||void 0===l?void 0:l.domElement}void 0!==t.renderMode&&(null==o||o.setRenderMode(s,t.renderMode),a.renderMode=t.renderMode)}async startLiveTranscoding(e){var t;this.logger.info("startLiveTranscoding()","transcode: %o",e),qG.checkStartParams(e),this._liveTranscodeConfig=e;const i=null===(t=this._room)||void 0===t?void 0:t.config;if(i&&i.roomId.length+i.userId.length>126)throw new HS(US.INVALID_PARAMS,"The roomId+userId must be within 126 bytes");try{this.safeEmit(wh.onStreamMixingEvent,{event:bP.START,error:0,message:""}),this._room&&this._ctx.signalingManager.isConnected()&&await this._room.liveControlMessage(qG.getStartParams(this._liveTranscodeConfig))}catch(BW){throw BW instanceof HS?BW:new HS(US.UNEXPECTED_ERROR,"unexpected error",BW)}}async updateLiveTranscoding(e){var t,i;if(this.logger.info("updateLiveTranscoding()","transcode: %o",e),!this._liveTranscodeConfig)return;const o=NP({},e);delete o.audio,null===(t=o.video)||void 0===t||delete t.codec,null===(i=o.video)||void 0===i||delete i.gop,qG.checkUpdateParams(o),this._liveTranscodeConfig=NP(this._liveTranscodeConfig,o);try{var s;this.safeEmit(wh.onStreamMixingEvent,{event:bP.UPDATE,error:0,message:""}),await(null===(s=this._room)||void 0===s?void 0:s.liveControlMessage(qG.getUpdateParams(this._liveTranscodeConfig)))}catch(BW){throw BW instanceof HS?BW:new HS(US.UNEXPECTED_ERROR,"unexpected error",BW)}}async stopLiveTranscoding(){if(this.logger.info("stopLiveTranscoding()"),this._liveTranscodeConfig){delete this._liveTranscodeConfig;try{var e;this.safeEmit(wh.onStreamMixingEvent,{event:bP.STOP,error:0,message:""}),await(null===(e=this._room)||void 0===e?void 0:e.liveControlMessage({action:"stopped",type:"transcode"}))}catch(BW){throw BW instanceof HS?BW:new HS(US.UNEXPECTED_ERROR,"unexpected error",BW)}}}async startSubtitle(e){var t;this.logger.info("startSubtitle()","config: %o",e),this._assertNotInRoom(),await(null===(t=this._room)||void 0===t?void 0:t.startSubtitle(e))}async updateSubtitleConfig(e){var t;this.logger.info("updateSubtitleConfig()","config: %o",e),this._assertNotInRoom(),await(null===(t=this._room)||void 0===t?void 0:t.updateSubtitleConfig(e))}stopSubtitle(){var e;this.logger.info("stopSubtitle()","invoke"),null===(e=this._room)||void 0===e||e.stopSubtitle()}setBusinessId(e){return this.logger.info("setBusinessId()","businessId: %s",e),!function(e){return"string"!=typeof e}(e)&&!this._room&&(this._ctx.businessId=e,!0)}async setUserVisibility(e){var t;if(this.logger.info("setUserVisibility()","enable: %o",e),e=!!e,this._ctx.visibility!==e)if(this._room){var i;if(this._assertNotInRoom(),this._room.localStream)null===(i=this._room.localStream.observer)||void 0===i||i.setPublisher(e);if(!e){const e=await this._pubLock.lock();try{this._room.unpublish(),this._room.unpublishScreen()}finally{e()}}this._ctx.visibility=e;try{await this._room.updateUserAttributes()}catch(o){throw this._ctx.visibility=!e,o}e&&null!==(t=this._room)&&void 0!==t&&t.config.isAutoPublish&&this._updatePublish({mediaType:$u.AUDIO_AND_VIDEO})}else this._ctx.visibility=e}_initPlayerEvents(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:qu.STREAM_INDEX_MAIN)===qu.STREAM_INDEX_SCREEN;e.on("playback_event",(o=>{switch(o.eventName){case"timeupdate":return;case"loadeddata":if("audio"===o.type){var s;const o=e.userId.replace("_screen",""),r=null===(s=this._room)||void 0===s||null===(s=s.remoteStreams.get(o))||void 0===s?void 0:s.find((e=>e.isScreen===i)),n=()=>{t?this.safeEmit(wh.onFirstPublicStreamAudioFrameDecoded,{publicStreamId:o}):(this.safeEmit(wh.onAudioFirstFrameDecoded,{userId:o,isScreen:i}),this.safeEmit(wh.onRemoteAudioFirstFrame,{userId:o,isScreen:i})),this.monitor.report("first_remote_audio_render",{stream_id:"",stream_user_id:o||""},{isScreen:i})};null==r||!r.observer||r.observer.audioFirstFrameReceived?n():r.observer.once("recvAudioFirstFrame",n)}else{var r,n;const s={userId:e.userId,height:(null===(r=e.domElement)||void 0===r?void 0:r.videoHeight)||0,width:(null===(n=e.domElement)||void 0===n?void 0:n.videoWidth)||0,isScreen:i,playerId:e.playerId};t?(s.publicStreamId=s.userId,delete s.userId,delete s.isScreen,this.safeEmit(wh.onFirstPublicStreamVideoFrameRendered,s),this.safeEmit(wh.onFirstPublicStreamVideoFrameDecoded,s)):e.isLocal||(this.safeEmit(wh.onVideoFirstFrameRendered,s),this.safeEmit(wh.onVideoFirstFrameDecoded,s),this.safeEmit(wh.onRemoteVideoFirstFrame,s)),this.monitor.report("first_remote_video_render",{stream_id:"",stream_user_id:o.userId||""},{isScreen:i})}break;case"autoplay-error":{t&&(o.publicStreamId=o.userId),Wv(this.id,"autoplay-error",e instanceof AL?"video":"audio",0,o.userId||"");const i={userId:o.userId,kind:e instanceof AL?"video":"audio",mediaType:e instanceof AL?$u.VIDEO:$u.AUDIO,streamIndex:e.isScreen?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN};return e instanceof AL&&(i.playerId=e.playerId===XL?void 0:e.playerId),void this.safeEmit(wh.onAutoplayFailed,i)}}e instanceof AL&&(o.playerId=e.playerId===XL?void 0:e.playerId),this.safeEmit(wh.onPlayerEvent,o)}))}_initLocalTrackEvents(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];["track-ended","track-mute","track-unmute"].forEach((t=>{e.on(t,(async e=>{this.monitor.report("rtc_error",{message:"track-".concat(t," mediaType: ").concat(e.originTrack.kind),error_code:PL.TRACK_ERROR,capture_session_id:e.captureSessionId,media_type:t,reason:t});let i=!1;e!==this._localScreenAudioTrack&&e!==this._localScreenVideoTrack||(i=!0);const{kind:o}=e.originTrack;this.safeEmit({"track-ended":wh.onTrackEnded,"track-mute":wh.onTrackMute,"track-unmute":wh.onTrackUnmute}[t],{kind:o,isScreen:i}),(SS||pS)&&("track-mute"===t&&(gL.emit(yL.ON_IOS_LOCAL_TRACK_MUTE,o),"audio"===o&&(await this.stopAudioCapture(),this.startAudioCapture())),"track-unmute"===t&&gL.emit(yL.ON_IOS_LOCAL_TRACK_UNMUTE,o))}))})),e.on("resolution-change",(e=>{this._ctx.extensionManager.getPluginsByType(_L.PRE_PROCESSING).forEach((i=>{var o;null==i||null===(o=i.applyConstraints)||void 0===o||o.call(i,t?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN,e)})),this.safeEmit(wh.onLocalVideoSizeChanged,{streamIndex:t?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN,info:e})})),e.on("needReplaceTrack",(()=>{if(e instanceof YL){var t,i;e.stopDataFetcher();const r=this._ctx._localAudioTrackDumpConfig[null!==(t=e.streamIndex)&&void 0!==t?t:qu.STREAM_INDEX_MAIN];null!=r&&r.frameSize&&null!=r&&r.callback&&e.setDataFetcher(r.frameSize,r.callback);const{position:n,volume:a}=this._ctx.earMonitorSettings[null!==(i=e.streamIndex)&&void 0!==i?i:qu.STREAM_INDEX_MAIN];if(n!==Zh.NONE&&(e.play(n),e.setPlaybackVolume(a)),this._room){const{streamIndex:t}=e;var o,s;if(t===qu.STREAM_INDEX_MAIN)null!==(o=this._room.localStream)&&void 0!==o&&o.pubAudio&&this._ctx.visibility&&this._updatePublish();else null!==(s=this._room.localStream)&&void 0!==s&&s.pubAudio&&this._ctx.visibility&&this._updateScreenPublish()}}})),e.on("autoplay-error",(e=>{this.safeEmit(wh.onAutoplayFailed,e)}))}_removeLocalTrackEvents(e){e.removeAllListeners("track-ended"),e.removeAllListeners("track-mute"),e.removeAllListeners("track-unmute"),e.removeAllListeners("resolution-change")}setRemoteVideoPlayer(e,t){var i,o,s,r,n,a;this.logger.info("setRemoteVideoPlayer()","streamIndex: %o, videoPlayerOption: %o",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),ny(t);const{userId:d}=t,c=e===qu.STREAM_INDEX_SCREEN,l=null===(i=this._room)||void 0===i||null===(i=i.remoteStreams.get(d))||void 0===i?void 0:i.find((e=>e.isScreen===c)),u=null==l?void 0:l.videoTrack,h=null!==(o=t.playerId)&&void 0!==o?o:XL;null===(s=this._getRemoteVideoPlayerConfig(e,d,h))||void 0===s||null===(s=s.player)||void 0===s||s.destroy();const m=null===(r=this._getRemoteVideoPlayerConfig(e,d,h))||void 0===r?void 0:r.renderDom;var p;if(this._containerCollisionDetector.unregisterContainer(m),!t.renderDom)return void(null===(p=this._remoteVideoPlayerConfig[e].get(d))||void 0===p||p.delete(h));const{renderDom:_}=t;if(!this._containerCollisionDetector.registerContainer(_))return this.monitor.report("rtc_error",{message:"RenderDom is not empty",error_code:PL.DUPLICATE_DOM}),void zy("renderDom is not empty");const b=new AL(this.id,h,Yu(Yu({},t),{},{isLocal:!1,isScreen:c,userId:d})),v=Yu(Yu({},t),{},{player:b});return this._setRemoteVideoPlayerConfig(e,d,h,v),null==u||u.setPlayer(this.id,v,null===(n=this._config)||void 0===n?void 0:n.autoPlayPolicy,this._initPlayerEvents.bind(this)),l&&this._updateVideoPlayerState(l),null===(a=v.player)||void 0===a?void 0:a.domElement}setLocalVideoMirrorType(e){var t;this.logger.info("setLocalVideoMirrorType()","mirrorType: %o",e),BS(e,"mirrorType",[sh.MIRROR_TYPE_NONE,sh.MIRROR_TYPE_RENDER]),this._mirrorType=e,null===(t=this.localVideoTrack)||void 0===t||t.mirror(!!e)}setRemoteVideoMirrorType(e,t,i){var o;this.logger.info("setRemoteVideoMirrorType()","userId: %s, streamIndex: %o, mirrorType: %o",e,t,i),sy(e),BS(t,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),BS(i,"mirrorType",[sh.MIRROR_TYPE_NONE,sh.MIRROR_TYPE_RENDER]),this._ctx.setUserStreamConf(e,t,{mirrorType:i}),null===(o=this._room)||void 0===o||null===(o=o.remoteStreams.get(e))||void 0===o||null===(o=o.find((e=>e.isScreen===(t===qu.STREAM_INDEX_SCREEN))))||void 0===o||null===(o=o.videoTrack)||void 0===o||o.mirror(!!i)}async setAudioPlaybackDevice(e){var t;this.logger.info("setAudioPlaybackDevice()","deviceId: %s",e),QS(e,"deviceId");const i=await this._audioDeviceManager.setSinkId(e);null===(t=this._room)||void 0===t||t.remoteStreams.forEach((t=>{t.forEach((t=>{var i;null===(i=t.audioTrack)||void 0===i||i.setPlaybackDevice(e)}))})),this.safeEmit(wh.onAudioPlaybackDeviceChanged,i),this.monitor.report("rtc_audio_device",{audio_event:"playout_device_switch",message:JSON.stringify(i),error_code:0})}async play(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$u.AUDIO_AND_VIDEO,o=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0;this.logger.info("play()","userId: %s, mediaType: %s, streamIndex: %s",e,i,o);const r=null!=s?s:XL,n=!e||e===this._getUserId()||"local_user"===e,a=void 0===o||o===qu.STREAM_INDEX_MAIN,d=void 0===o||o===qu.STREAM_INDEX_SCREEN,c=i!==$u.VIDEO,l=i!==$u.AUDIO,u=[];if(n&&l){if(a&&this._localVideoTrack){this._localVideoTrack.mirror(!!this._mirrorType);const e=this._localVideoTrack.play(r);e&&u.push(e)}if(d&&this._localScreenVideoTrack){var h;(null===(h=this._localScreenVideoTrack)||void 0===h?void 0:h.manuallyPlay(r))&&u.push()}}this._audioMixingManager&&e===this._audioMixingManager.id&&u.push(this._audioMixingManager.resumeLocalPlay());let m=[];var p;(null===(t=this._room)||void 0===t||t.remoteStreams.forEach(((t,i)=>{e&&e!==i||t.forEach((e=>{e.audioTrack&&m.push(e.audioTrack),e.videoTrack&&m.push(e.videoTrack)}))})),this._wtnStreamManager.__getRemoteStreams().forEach(((t,i)=>{e&&e!==i||(t.audioTrack&&m.push(t.audioTrack),t.videoTrack&&m.push(t.videoTrack))})),a||(m=m.filter((e=>!!e.isScreen))),d||(m=m.filter((e=>!e.isScreen))),c||(m=m.filter((e=>"audio"!==e.mediaType))),l||(m=m.filter((e=>"video"!==e.mediaType))),c)&&(null===(p=this._room)||void 0===p||p.virtualStreams.forEach((e=>{e.audioTrack&&m.push(e.audioTrack)})));return m.forEach((e=>{const t=e.manuallyPlay(r);t&&u.push(t)})),Promise.all(u).then((()=>{}))}async stop(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$u.AUDIO_AND_VIDEO,i=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0;this.logger.info("stop()","userId: %s, mediaType: %s, streamIndex: %s, playerId: %s",e,t,i,o);const s=null!=o?o:XL,r=!e||e===this._getUserId()||"local_user"===e,n=void 0===i||i===qu.STREAM_INDEX_MAIN,a=void 0===i||i===qu.STREAM_INDEX_SCREEN,d=t!==$u.VIDEO,c=t!==$u.AUDIO;if(r&&c&&(n&&this._localVideoTrack&&this._localVideoTrack.pause(s),a&&this._localScreenVideoTrack&&this._localScreenVideoTrack.pause(s)),e){var l;let t=[];null===(l=this._room)||void 0===l||null===(l=l.remoteStreams.get(e))||void 0===l||l.forEach((e=>{e.audioTrack&&t.push(e.audioTrack),e.videoTrack&&t.push(e.videoTrack)}));const i=this._wtnStreamManager.__getPublicStreamTrack(e,"audio"),o=this._wtnStreamManager.__getPublicStreamTrack(e,"video");i&&t.push(i),o&&t.push(o),n||(t=t.filter((e=>!!e.isScreen))),a||(t=t.filter((e=>!e.isScreen))),d||(t=t.filter((e=>"audio"!==e.mediaType))),c||(t=t.filter((e=>"video"!==e.mediaType))),t.forEach((e=>{e.pause(s)}))}}getAudioVolume(e,t){BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]);let i=0;if(t){var o;const s=null===(o=this._room)||void 0===o||null===(o=o.remoteStreams.get(t))||void 0===o||null===(o=o.find((t=>t.isScreen===(e===qu.STREAM_INDEX_SCREEN))))||void 0===o?void 0:o.audioTrack;s&&(i=s.getAudioLevel())}else{const t=e===qu.STREAM_INDEX_MAIN?this._localAudioTrack:this._localScreenAudioTrack;t&&(i=t.getAudioLevel())}return{linearVolume:i,nonlinearVolume:Yy(i)}}setAudioFrameCallback(e,t,i){var o;let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4096;if(this.logger.info("setAudioFrameCallback()","streamIndex: %s, userId: %s, callback: %s, frameSize: %s",e,t,i?"true":"false",s),BS(s,"frameSize",[256,512,1024,2048,4096,8192,16384]),void 0===CL.isWorkletReady&&CL.getAudioContextInstance(),null===CL.isWorkletReady)throw this.logger.error("setAudioFrameCallback()","Not support AudioWorklet"),new HS(US.NOT_SUPPORTED,"Not support AudioWorklet");t?i?this._ctx._remoteAudioTrackDumpConfig[e].set(t,{callback:i,frameSize:s}):this._ctx._remoteAudioTrackDumpConfig[e].delete(t):this._ctx._localAudioTrackDumpConfig[e]={callback:i,frameSize:i?s:void 0};const r=t?null===(o=this._room)||void 0===o||null===(o=o.remoteStreams.get(t))||void 0===o||null===(o=o.find((t=>t.isScreen===(e===qu.STREAM_INDEX_SCREEN))))||void 0===o?void 0:o.audioTrack:e===qu.STREAM_INDEX_MAIN?this._localAudioTrack:this._localScreenAudioTrack;r?i?r.setDataFetcher(s,i):r.stopDataFetcher():this.logger.warn("setAudioFrameCallback()","track not found")}async pauseAllSubscribedStream(e){this.logger.info("pauseAllSubscribedStream()","mediaType: %o",e),this._checkMediaType(e);return(()=>{Ky(e)&&(this._pauseAllSubscribeState.audio=!0),Uy(e)&&(this._pauseAllSubscribeState.video=!0)})(),this._room?this._pauseAllRemoteStreams(e):Promise.resolve()}async _pauseAllRemoteStreams(e){if(!this._room)return Promise.resolve();const t=[];return this._room.remoteStreams.forEach((i=>{Array.isArray(i)&&i.forEach((i=>{if(i.hasSubscribed){i.attributes.audiostream&&Ky(e)&&(this._pauseAllSubscribeState.resumeAudioStreamIds[i.streamId]=i.streamId),i.attributes.videostream&&Uy(e)&&(this._pauseAllSubscribeState.resumeVideoStreamIds[i.streamId]=i.streamId);const o=this._unsubscribe(i.isScreen,i.userId,e,!0);o&&t.push(o)}}))})),Promise.all(t).then((()=>{}))}async resumeAllSubscribedStream(e){this.logger.info("resumeAllSubscribedStream()","mediaType: %o",e),this._checkMediaType(e);if((()=>{Ky(e)&&(this._pauseAllSubscribeState.audio=!1),Uy(e)&&(this._pauseAllSubscribeState.video=!1)})(),!this._room)return Promise.resolve();await this._triedResumeAllRemoteStreams(e,!1)}async _triedResumeAllRemoteStreams(e,t){if(!this._room)return Promise.resolve();if(this._pauseAllSubscribeState.audio&&e===$u.AUDIO)return Promise.resolve();if(this._pauseAllSubscribeState.video&&e===$u.VIDEO)return Promise.resolve();if(this._pauseAllSubscribeState.video&&this._pauseAllSubscribeState.audio&&e===$u.AUDIO_AND_VIDEO)return Promise.resolve();const i=[],o=[...Object.keys(this._pauseAllSubscribeState.resumeAudioStreamIds)],s=[...Object.keys(this._pauseAllSubscribeState.resumeVideoStreamIds)];return this._room.remoteStreams.forEach((o=>{Array.isArray(o)&&o.forEach((o=>{if(t&&o.isScreen)return;const s=this._pauseAllSubscribeState.resumeAudioStreamIds[o.streamId],r=this._pauseAllSubscribeState.resumeVideoStreamIds[o.streamId];if(s&&Ky(e)||r&&Uy(e)){const t=this._subscribe(o.isScreen,o.userId,e).then((()=>{s&&Ky(e)&&delete this._pauseAllSubscribeState.resumeAudioStreamIds[o.streamId],r&&Uy(e)&&delete this._pauseAllSubscribeState.resumeVideoStreamIds[o.streamId]}));t&&i.push(t)}}))})),Promise.all(i).then((()=>{var e;return null===(e=this._room)||void 0===e||e.remoteStreams.forEach((e=>{Array.isArray(e)&&e.forEach((e=>{this._updateAudioPlayerState(e),this._updateVideoPlayerState(e)}))})),Promise.resolve()})).finally((()=>{var e;return null!==(e=this._room)&&void 0!==e&&e.config.tokenSubscribePrivilegeExpired&&(o.forEach((e=>{this._pauseAllSubscribeState.resumeAudioStreamIds[e]=e})),s.forEach((e=>{this._pauseAllSubscribeState.resumeVideoStreamIds[e]=e}))),Promise.resolve()}))}async sendUserMessage(e,t){var i;sy(e),this._assertNotInRoom();const o=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendUserMessage(e,t))||void 0===i?void 0:i.then((t=>(this._messageStatisticsObserver.countP2PMessage(!0,e,!1,o,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countP2PMessage(!1,e,!1,o,t),t}))}async sendUserBinaryMessage(e,t){var i;sy(e),ey(t,"message"),this._assertNotInRoom();const o=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendUserMessage(e,t))||void 0===i?void 0:i.then((t=>(this._messageStatisticsObserver.countP2PMessage(!0,e,!0,o,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countP2PMessage(!1,e,!0,o,t),t}))}async sendRoomMessage(e){var t,i;this._assertNotInRoom();const o=null===(t=this._room)||void 0===t?void 0:t.config.roomId,s=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendRoomMessage(e))||void 0===i?void 0:i.then((e=>(this._messageStatisticsObserver.countRoomMessage(!0,o,!1,s),e))).catch((e=>{throw this._messageStatisticsObserver.countRoomMessage(!1,o,!1,s),e}))}async sendRoomBinaryMessage(e){var t,i;this._assertNotInRoom();const o=null===(t=this._room)||void 0===t?void 0:t.config.roomId,s=Date.now();return null===(i=this._room)||void 0===i||null===(i=i.sendRoomMessage(e,!0))||void 0===i?void 0:i.then((e=>(this._messageStatisticsObserver.countRoomMessage(!0,o,!0,s),e))).catch((e=>{throw this._messageStatisticsObserver.countRoomMessage(!1,o,!0,s),e}))}async setAudioCaptureConfig(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger.info("setAudioCaptureConfig()","config: %o",e),delete e.deviceId,ty(e);await this._shouldUpdateAudioConf("setAudioCaptureConfig")&&this._ctx.audioProfileManager.updateConstraints(e)}async setVideoCaptureConfig(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.logger.info("setVideoCaptureConfig()","config: %o",e),this._setVideoCaptureConfig(e)}async _setVideoCaptureConfig(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};delete t.deviceId,ty(t);const i=Yu(Yu({},this._ctx.videoProfile.getCaptureConfig()),t);return this._localVideoTrack&&await this._localVideoTrack.updateVideoCaptureConfig(i),this._ctx.videoProfile.setCaptureConfig(i),(null===(e=this._localVideoTrack)||void 0===e?void 0:e.originTrack.getSettings())||{}}enableSimulcastMode(e){this.logger.info("enableSimulcastMode()","enabled: %o",e),this._ctx.videoProfile.checkSimulcastApiVersion("old");try{return this._ctx.videoProfile.setSimulcastMode(e?Eh.VIDEO_ON_DEMAND:Eh.VIDEO_ONLY_ONE,this._room),!0}catch(t){return!1}}async setLocalSimulcastMode(e,t){var i;this.logger.info("setLocalSimulcastMode()","mode: %o, config: %o",e,t),this._ctx.videoProfile.checkSimulcastApiVersion("new"),await this._ctx.videoProfile.setSimulcastMode(e,this._room),await this._ctx.videoProfile.setSubVideoEncodeConfig(t,this._room,this._localVideoTrack);await(null===(i=this._room)||void 0===i?void 0:i.hasPublished())&&this._updatePublish()}async setVideoEncoderConfig(e){var t;if(this.logger.info("setVideoEncoderConfig()","descriptions: %o",e),await this._ctx.videoProfile.setVideoEncodeConfigPolyfill(e),this._localVideoTrack){const e=this._ctx.videoProfile.getContentHint();e&&this._localVideoTrack.setContentHint(e),await this._localVideoTrack.updateVideoCaptureConfig(this._ctx.videoProfile.getCaptureConfig())}this._updateDummyCaptureImage(qu.STREAM_INDEX_MAIN);await(null===(t=this._room)||void 0===t?void 0:t.hasPublished())&&this._updatePublish()}setVideoEncoderAutoConfigList(e){if(Array.isArray(e))return iT(e).call(e,((e,t)=>e.maxKbps-t.maxKbps)),fy(e)}async setScreenEncoderConfig(e){var t;this.logger.info("setScreenEncoderConfig()","description: %o",e),this._ctx.videoProfile.setScreenEncodeConfig(e),this._localScreenVideoTrack&&("16.1"!==PS&&await this._localScreenVideoTrack.updateVideoCaptureConfig(e),e.contentHint&&this._localScreenVideoTrack.setContentHint(e.contentHint)),this._updateDummyCaptureImage(qu.STREAM_INDEX_SCREEN);await(null===(t=this._room)||void 0===t?void 0:t.hasScreenPublished())&&this._updateScreenPublish()}sendSEIMessage(e,t,i){if(this.logger.info("sendSEIMessage()","streamIdex: %o, message: %o, repeatCount: %o",e,t,i),!DT()&&!OT())return zy("Your browser does not support sending SEI"),!1;BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),jS(i,"repeatCount",0,30);const o="string"==typeof t?new Uint8Array(Gy.str2ab(t)):t;if(!t.length)return this.logger.warn("sei message must not be empty"),!1;let s;if(e===qu.STREAM_INDEX_MAIN){var r,n;if(!(null!==(r=this._room)&&void 0!==r&&null!==(r=r.localStream)&&void 0!==r&&r.pubAudio||null!==(n=this._room)&&void 0!==n&&null!==(n=n.localStream)&&void 0!==n&&n.pubVideo))return;s=this._room.localStream}else{var a,d;if(!(null!==(a=this._room)&&void 0!==a&&null!==(a=a.localScreenStream)&&void 0!==a&&a.pubAudio||null!==(d=this._room)&&void 0!==d&&null!==(d=d.localScreenStream)&&void 0!==d&&d.pubVideo))return;s=this._room.localScreenStream}if(o.byteLength>4096)return void this.logger.warn("sei size must not bigger than 4KB");var c;yS||(null===(c=this._room)||void 0===c||c.maybeFillBackFrame2Stream(s));const l=Vy();return s.sendSEIMessage({content:o,uuid:l,repeatCount:i+1}),setTimeout((async()=>{if(!s)return;if(await s.revokeSEIMessage(l)){const e="timeout for sei message(id: ".concat(l,")");console.error("[RTC WebSDK] ".concat(e)),this.monitor.report("rtc_sdk_callback",{sdk_callback_name:"sendSEIMessageTimeout",message:e,error_code:400})}}),vy("SEI_TIME_OUT")),l}setAudioVolumeIndicationInterval(e){this.logger.info("setAudioVolumeIndicationInterval()","interval %o: ",e),("number"!=typeof e||e<200)&&(e=200);let t=[];this._audioVolumeIndicationTimer&&clearInterval(this._audioVolumeIndicationTimer),this._audioVolumeIndicationTimer=setInterval((()=>{var e,i;t=[],null===(e=this._room)||void 0===e||e.remoteStreams.forEach(((e,i)=>{var o;if(0===e.length)return;const s=e.find((e=>!e.isScreen)),r=null==s||null===(o=s.audioTrack)||void 0===o?void 0:o.getAudioLevel();t.push({userId:i,volume:r||0})}));const o=null===(i=this._localAudioTrack)||void 0===i?void 0:i.getAudioLevel();t.push({userId:this._getUserId(),volume:o||0}),this.safeEmit(wh.onAudioVolumeIndication,{speakers:t})}),e)}_sendActiveSpeaker(e,t){if(this._room&&this._room.remoteUsers.size>=1){const i=e[0],o=t.reduce(((e,t)=>e&&e.audioPropertiesInfo.nonlinearVolume>t.audioPropertiesInfo.nonlinearVolume?e:t),void 0);let s;if(s=i?o?i.audioPropertiesInfo.nonlinearVolume>o.audioPropertiesInfo.nonlinearVolume?i:o:i:o,s&&s.audioPropertiesInfo.nonlinearVolume>-35){let e;e=s.streamKey?this._room.remoteUsers.get(s.streamKey.userId):this._room.config.userInfo,e&&this.safeEmit(wh.onActiveSpeaker,{userId:e.userId,extraInfo:e.extraInfo})}}}enableAudioPropertiesReport(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger.info("enableAudioPropertiesReport()","config %o: ",e);const{enableInBackground:t=!0,localMainReportMode:i=rh.NORMAL,audioReportMode:o=nh.MICROPHONE}=e;let{interval:s=100}=e;this._stopAudioPropertiesReport(),s<=0||(s=Math.max(100,s),this._audioPropertiesReportTimer=self.setInterval((()=>{if(!t&&"hidden"===document.visibilityState)return;const e=[],s=this._audioDeviceManager.getRecordTrack()||this._localAudioTrack;if(s){var r;const t=null===(r=this._room)||void 0===r||null===(r=r.localStream)||void 0===r?void 0:r.audioHasPublish,n=!!this._audioDeviceManager.getRecordTrack(),a=s.getAudioLevel(o),d=Yy(a),c={streamIndex:qu.STREAM_INDEX_MAIN,audioPropertiesInfo:{linearVolume:a,nonlinearVolume:d}};if(t||n)e.push(c);else switch(i){case rh.DISCONNECT:break;case rh.RESET:c.audioPropertiesInfo.linearVolume=0,c.audioPropertiesInfo.nonlinearVolume=-127,e.push(c);break;case rh.NORMAL:e.push(c);break;default:throw new HS(US.INVALID_PARAMS,"invalid localMainReportMode: ".concat(i," in config"))}}if(this._localScreenAudioTrack){const t=this._localScreenAudioTrack.getAudioLevel();e.push({streamIndex:qu.STREAM_INDEX_SCREEN,audioPropertiesInfo:{linearVolume:t,nonlinearVolume:Yy(t)}})}if(this.safeEmit(wh.onLocalAudioPropertiesReport,e),this._room){const t=[];if(this._room.config.isMultiChatMode()){this._room.getActiveSpeakerInMultiChatMode().forEach((e=>{var i,o;const s=255*e.audioLevel;t.push({streamKey:{userId:e.userId,streamIndex:qu.STREAM_INDEX_MAIN,roomId:null!==(i=null===(o=this._room)||void 0===o?void 0:o.config.roomId)&&void 0!==i?i:""},audioPropertiesInfo:{linearVolume:s,nonlinearVolume:Yy(s)}})}))}else this._room.remoteStreams.forEach(((e,i)=>{e.forEach((e=>{if(e.audioTrack){var o,s;const r=e.audioTrack.getAudioLevel();t.push({streamKey:{userId:i,streamIndex:e.isScreen?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN,roomId:null!==(o=null===(s=this._room)||void 0===s?void 0:s.config.roomId)&&void 0!==o?o:""},audioPropertiesInfo:{linearVolume:r,nonlinearVolume:Yy(r)}})}}))}));this.safeEmit(wh.onRemoteAudioPropertiesReport,t),this._sendActiveSpeaker(e,t.filter((e=>e.streamKey.streamIndex!==qu.STREAM_INDEX_SCREEN)))}}),s))}async setVideoSourceType(e,t){this.logger.print("setVideoSourceType()","index: %o, videoSourceType: %o",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),BS(t,"VideoSourceType",[Ku.VIDEO_SOURCE_TYPE_EXTERNAL,Ku.VIDEO_SOURCE_TYPE_INTERNAL]);const i=e===qu.STREAM_INDEX_MAIN?"video":"screenVideo";if(this._trackSourceType[i]!==t){if(this._trackSourceType[i]=t,this.logger.print("setVideoSourceType","set ".concat(i," source type to ").concat(t)),this._localVideoTrack&&e===qu.STREAM_INDEX_MAIN){var o,s,r;let e=!1;if(t===Ku.VIDEO_SOURCE_TYPE_EXTERNAL){e=!0;const t=this._ctx.extensionManager.getPluginByName(_L.PRE_PROCESSING,"RTCBeautyExtension");t&&t.emit("stop"),this._removeLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.destroy()}null===(o=this._localVideoTrack)||void 0===o||o.destroy(),this._localVideoTrack=void 0;const i=null===(s=this._room)||void 0===s?void 0:s.config.isAutoPublish;var n,a;if(e)null===(n=this._room)||void 0===n||null===(n=n.localStream)||void 0===n||null===(n=n.observer)||void 0===n||n.setEnableVideo(!1);else null===(a=this._room)||void 0===a||null===(a=a.localStream)||void 0===a||null===(a=a.observer)||void 0===a||a.setPushVideo(!1);(null!==(r=this._room)&&void 0!==r&&null!==(r=r.localStream)&&void 0!==r&&r.pubVideo||i)&&await this._updatePublish()}if(this._localScreenVideoTrack&&e===qu.STREAM_INDEX_SCREEN){var d,c;let e=!1;var l,u;if(t===Ku.VIDEO_SOURCE_TYPE_EXTERNAL&&(e=!0,this._removeLocalTrackEvents(this._localScreenVideoTrack),this._localScreenVideoTrack.destroy()),null===(d=this._localScreenVideoTrack)||void 0===d||d.destroy(),this._localScreenVideoTrack=void 0,e)null===(l=this._room)||void 0===l||null===(l=l.localScreenStream)||void 0===l||null===(l=l.observer)||void 0===l||l.setEnableVideo(!1);else null===(u=this._room)||void 0===u||null===(u=u.localScreenStream)||void 0===u||null===(u=u.observer)||void 0===u||u.setPushVideo(!1);null!==(c=this._room)&&void 0!==c&&null!==(c=c.localScreenStream)&&void 0!==c&&c.pubVideo&&await this._updateScreenPublish()}}}async setExternalVideoTrack(e,t){if(this.logger.print("setExternalVideoTrack()","index: %o, track: %o",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),qS(t),e===qu.STREAM_INDEX_MAIN){var i,o;if(this._trackSourceType.video!==Ku.VIDEO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as external first");this._localVideoTrack=await async function(e,t){const i=new wL(e,t,{streamIndex:gT.MAIN,sourceType:yT.EXTERNAL});return await i.isTrackReady,i}(this._ctx,t);const e=this._ctx.videoProfile.getContentHint();!t.contentHint&&e&&this._localVideoTrack.setContentHint(e),this._initLocalTrackEvents(this._localVideoTrack),this._localVideoPlayerConfig[qu.STREAM_INDEX_MAIN].forEach((e=>{var t,i;null===(t=this._localVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))}));const s=null===(i=this._room)||void 0===i?void 0:i.config.isAutoPublish;(null!==(o=this._room)&&void 0!==o&&null!==(o=o.localStream)&&void 0!==o&&o.pubVideo||s)&&await this._updatePublish()}if(e===qu.STREAM_INDEX_SCREEN){var s,r;if(this._trackSourceType.screenVideo!==Ku.VIDEO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setVideoSourceType as external first");this._localScreenVideoTrack=await async function(e,t){const i=new wL(e,t,{sourceType:yT.EXTERNAL,streamIndex:gT.SCREEN});return await i.isTrackReady,i}(this._ctx,t),this._initLocalTrackEvents(this._localScreenVideoTrack,!0),this._localVideoPlayerConfig[qu.STREAM_INDEX_SCREEN].forEach((e=>{var t,i;null===(t=this._localScreenVideoTrack)||void 0===t||t.setPlayer(e,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),null===(s=this._room)||void 0===s||null===(s=s.localScreenStream)||void 0===s||null===(s=s.observer)||void 0===s||s.setPushVideo(!0),null!==(r=this._room)&&void 0!==r&&null!==(r=r.localScreenStream)&&void 0!==r&&r.pubVideo&&await this._updateScreenPublish()}}async setAudioSourceType(e,t){this.logger.print("setAudioSourceType()","index: %o, audioSourceType: %o",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),BS(t,"audioSourceType",[Uu.AUDIO_SOURCE_TYPE_EXTERNAL,Uu.AUDIO_SOURCE_TYPE_INTERNAL]);const i=e===qu.STREAM_INDEX_MAIN?"audio":"screenAudio";if(this._trackSourceType[i]!==t){if(this._trackSourceType[i]=t,this.logger.print("setVideoSourceType","set ".concat(i," source type to ").concat(t)),this._localAudioTrack&&e===qu.STREAM_INDEX_MAIN){var o,s;let e=!1;this._trackSourceType.audio===Uu.AUDIO_SOURCE_TYPE_EXTERNAL&&(e=!0,this._removeLocalTrackEvents(this._localAudioTrack),this._localAudioTrack.destroy()),this._localAudioTrack=void 0;const t=null===(o=this._room)||void 0===o?void 0:o.config.isAutoPublish;var r,n;if(e)null===(r=this._room)||void 0===r||null===(r=r.localStream)||void 0===r||null===(r=r.observer)||void 0===r||r.setEnableAudio(!1);else null===(n=this._room)||void 0===n||null===(n=n.localStream)||void 0===n||null===(n=n.observer)||void 0===n||n.setPushAudio(!1);(null!==(s=this._room)&&void 0!==s&&null!==(s=s.localStream)&&void 0!==s&&s.pubAudio||t)&&await this._updatePublish()}if(this._localScreenAudioTrack&&e===qu.STREAM_INDEX_SCREEN){var a;let e=!1;var d,c;if(this._trackSourceType.audio===Uu.AUDIO_SOURCE_TYPE_EXTERNAL&&(e=!0,this._removeLocalTrackEvents(this._localScreenAudioTrack),this._localScreenAudioTrack.destroy()),this._localScreenAudioTrack=void 0,e)null===(d=this._room)||void 0===d||null===(d=d.localScreenStream)||void 0===d||null===(d=d.observer)||void 0===d||d.setEnableAudio(!1);else null===(c=this._room)||void 0===c||null===(c=c.localScreenStream)||void 0===c||null===(c=c.observer)||void 0===c||c.setPushAudio(!1);null!==(a=this._room)&&void 0!==a&&null!==(a=a.localScreenStream)&&void 0!==a&&a.pubAudio&&await this._updateScreenPublish()}}}async setExternalAudioTrack(e,t){if(this.logger.print("setExternalAudioTrack()","index: %o, track: %o",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),qS(t),e===qu.STREAM_INDEX_MAIN){var i,o,s;if(this._trackSourceType.audio!==Uu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as external first");this._localAudioTrack=await async function(e,t){const i=new YL(e,t,{streamIndex:gT.MAIN,sourceType:yT.EXTERNAL});return await i.isTrackReady,i}(this._ctx,t),this._localAudioTrack.setVolume(this._localAudioVolume),this._initLocalTrackEvents(this._localAudioTrack);const e=this._ctx._localAudioTrackDumpConfig[qu.STREAM_INDEX_MAIN];e.frameSize&&e.callback&&this._localAudioTrack.setDataFetcher(e.frameSize,e.callback);const{position:r,volume:n}=this._ctx.earMonitorSettings[qu.STREAM_INDEX_MAIN];r!==Zh.NONE&&(this.setEarMonitorMode(qu.STREAM_INDEX_MAIN,r),this.setEarMonitorVolume(qu.STREAM_INDEX_MAIN,n));const a=null===(i=this._room)||void 0===i?void 0:i.config.isAutoPublish;null===(o=this._room)||void 0===o||null===(o=o.localStream)||void 0===o||null===(o=o.observer)||void 0===o||o.setPushAudio(!0),(null!==(s=this._room)&&void 0!==s&&null!==(s=s.localStream)&&void 0!==s&&s.pubAudio||a)&&await this._updatePublish()}if(e===qu.STREAM_INDEX_SCREEN){var r,n;if(this._trackSourceType.screenAudio!==Uu.AUDIO_SOURCE_TYPE_EXTERNAL)throw new HS(US.STREAM_TYPE_NOT_MATCH,"setAudioSourceType as external first");this._localScreenAudioTrack=await async function(e,t){const i=new YL(e,t,{sourceType:yT.EXTERNAL,streamIndex:gT.SCREEN});return await i.isTrackReady,i}(this._ctx,t),this._localScreenAudioTrack.setVolume(this._localScreenAudioVolume),this._initLocalTrackEvents(this._localScreenAudioTrack);const e=this._ctx._localAudioTrackDumpConfig[qu.STREAM_INDEX_SCREEN];e.frameSize&&e.callback&&this._localScreenAudioTrack.setDataFetcher(e.frameSize,e.callback);const{position:i,volume:o}=this._ctx.earMonitorSettings[qu.STREAM_INDEX_SCREEN];i!==Zh.NONE&&(this.setEarMonitorMode(qu.STREAM_INDEX_SCREEN,i),this.setEarMonitorVolume(qu.STREAM_INDEX_SCREEN,o)),null===(r=this._room)||void 0===r||null===(r=r.localScreenStream)||void 0===r||null===(r=r.observer)||void 0===r||r.setPushAudio(!0),null!==(n=this._room)&&void 0!==n&&null!==(n=n.localScreenStream)&&void 0!==n&&n.pubAudio&&await this._updateScreenPublish()}}async login(e,t){return this.logger.info("login()","token: %o, userInfo: %o",e,t),iy(e)||QS(e,"token"),sy(t),this._rtmClient.login(e,t)}async logout(){return this.logger.info("logout()"),this._rtmClient.logout()}async updateLoginToken(e){return this.logger.info("updateLoginToken()","token: %o",e),iy(e)||QS(e,"token"),this._rtmClient.updateLoginToken(e)}async getPeerOnlineStatus(e){return this.logger.info("getPeerOnlineStatus()","userId: %o",e),sy(e),this._rtmClient.getPeerOnlineStatus(e)}async sendUserMessageOutsideRoom(e,t){sy(e);const i=Date.now();return this._rtmClient.sendUserMessageOutsideRoom(e,t).then((t=>(this._messageStatisticsObserver.countUserMessageOutsideRoom(!0,e,!1,i,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countUserMessageOutsideRoom(!1,e,!1,i,t),t}))}async sendUserBinaryMessageOutsideRoom(e,t){sy(e),ey(t,"message");const i=Date.now();return this._rtmClient.sendUserMessageOutsideRoom(e,t).then((t=>(this._messageStatisticsObserver.countUserMessageOutsideRoom(!0,e,!0,i,t),t.id))).catch((t=>{throw this._messageStatisticsObserver.countUserMessageOutsideRoom(!1,e,!0,i,t),t}))}async setServerParams(e,t){return this.logger.info("setServerParams()","signature: %o, url: %0",e,t),this._rtmClient.setServerParams(e,t)}async sendServerMessage(e){QS(e,"message");const t=Date.now();return this._rtmClient.sendServerMessage(e).then((e=>{this._messageStatisticsObserver.countServerMessage(!0,!1,t,e)})).catch((e=>{throw this._messageStatisticsObserver.countServerMessage(!1,!1,t,e),e}))}async sendServerBinaryMessage(e){ey(e,"message");const t=Date.now();return this._rtmClient.sendServerMessage(e).then((e=>{this._messageStatisticsObserver.countServerMessage(!0,!0,t,e)})).catch((e=>{throw this._messageStatisticsObserver.countServerMessage(!1,!0,t,e),e}))}startCloudProxy(e){if(this._room)throw new HS(US.START_CLOUD_PROXY_AFTER_JOIN,"[startCloudProxy] should be invoke before join room ");if(this.logger.info("startCloudProxy()",e),QS(e.logProxy,"logProxy"),Array.isArray(e.accessProxy))for(const t of e.accessProxy)QS(t,"accessProxy");else QS(e.accessProxy,"accessProxy");QS(e.configProxy,"configProxy"),this._originIceConfigRequestUrls=vy("ICE_CONFIG_REQUEST_URLS"),this._originLogServerUrl=vy("LOG_SERVER_URL"),this._originConfigServerUrls=vy("CONFIG_REQUEST_DOMAINS"),by("ICE_CONFIG_REQUEST_URLS",e.accessProxy),by("LOG_SERVER_URL",function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e?(/^https?:\/\/.+/.test(e)||(e="https://".concat(e)),"".concat(e,"/video/v1/webrtc_log/")):""}(e.logProxy)),by("CONFIG_REQUEST_DOMAINS",[e.configProxy]),DS.clearAccessNode(this._appId),DS.clearAccessUrls(),this._ctx.useCloudProxy=!0}stopCloudProxy(){var e,t,i;if(this._room)throw new HS(US.STOP_CLOUD_PROXY_BEFORE_LEAVE,"[stopCloudProxy] should be invoke after leave room ");this.logger.info("stopCloudProxy()");const o=null===(e=this._originIceConfigRequestUrls)||void 0===e?void 0:e.map((e=>e.replace("https://","").replace("/dispatch/v1/AccessInfo?Action=GetAccessInfo","")));by("ICE_CONFIG_REQUEST_URLS",null!=o?o:[]),by("LOG_SERVER_URL",null!==(t=this._originLogServerUrl)&&void 0!==t?t:""),by("CONFIG_REQUEST_DOMAINS",null!==(i=this._originConfigServerUrls)&&void 0!==i?i:[]),DS.clearAccessNode(this._appId),DS.clearAccessUrls(),this._ctx.useCloudProxy=!1,this._startCloudProxyTimestamp=void 0}async startPushPublicStream(e,t){var i,o;if(this.logger.print("startPushPublicStream()","publicStreamId: %o, publicStreamParam: %o",e,t),ry(e),this._assertNotInRoom(),this._publicStreamIds.get(e))throw new HS(US.REPEAT_PUSH,"repeat push public media stream");this._room&&(null===(o=t.layout)||void 0===o||null===(o=o.regions)||void 0===o||o.map((e=>{var t;e.roomId=null===(t=this._room)||void 0===t?void 0:t.config.roomId})));const s=Sy(e,"started",t);return null===(i=this._room)||void 0===i||null===(i=i.publicStreamControlMessage(s))||void 0===i?void 0:i.then((()=>{this._publicStreamIds.set(e,e)}))}async updatePublicStreamParam(e,t){var i;this.logger.print("startPushPublicStream()","publicStreamId: %o, publicStreamParam: %o",e,t),ry(e),this._assertNotInRoom();const o=Sy(e,"layoutChanged",t);return null===(i=this._room)||void 0===i?void 0:i.publicStreamControlMessage(o)}async stopPushPublicStream(e){var t;return this.logger.print("startPushPublicStream()","publicStreamId: %o",e),ry(e),this._assertNotInRoom(),null===(t=this._room)||void 0===t?void 0:t.publicStreamControlMessage({type:"publicstream",action:"stopped",publicStreamID:e}).then((()=>{this._publicStreamIds.delete(e)}))}async startPlayPublicStream(e){await this._wtnStreamManager.startPlayWTN(null,e,!1,!1)}async stopPlayPublicStream(e){await this._wtnStreamManager.stopPlayWTN(e)}async setAudioProfile(e){this.logger.info("setAudioProfile()","profile: %o",e);await this._shouldUpdateAudioConf("setAudioProfile")&&this._ctx.audioProfileManager.setAudioProfile(e)}async setAudioEncodeMaxBitrate(e){if(this.logger.print("setAudioEncodeMaxBitrate()",e),jS(e,"maxBitrate",6,256),this._ctx.audioProfileManager.setCustomMaxBitrate(e),this._ctx.audioProfileManager.customMaxBitrate){var t,i,o,s;if(sS&&(null!==(t=this._room)&&void 0!==t&&null!==(t=t.localStream)&&void 0!==t&&t.pubAudio||null!==(i=this._room)&&void 0!==i&&null!==(i=i.localScreenStream)&&void 0!==i&&i.pubAudio))throw new HS(US.NOT_SUPPORTED,"Your browser does not support set audio encode maxBitrate dynamically.");await(null===(o=this._room)||void 0===o?void 0:o.setAudioEncodeMaxBitrate(qu.STREAM_INDEX_MAIN,e)),await(null===(s=this._room)||void 0===s?void 0:s.setAudioEncodeMaxBitrate(qu.STREAM_INDEX_SCREEN,e))}}setPublicStreamVideoPlayer(e,t){return this._wtnStreamManager.setWTNRemoteVideoPlayer(e,t)}async setDummyCaptureImagePath(e,t){return new Promise(((i,o)=>{QS(t,"filePath");const s=new Image;s.crossOrigin="anonymous",s.src=t,s.onload=()=>{e===qu.STREAM_INDEX_MAIN?this._dummyMainImage=s:this._dummyScreenImage=s;try{this._updateDummyCaptureImage(e),i()}catch(t){o(new HS(US.UNEXPECTED_ERROR,t.message))}},s.onerror=()=>{o(new HS(US.UNEXPECTED_ERROR,"Load image error"))}}))}_updateDummyCaptureImage(e){let t,i;if(e===qu.STREAM_INDEX_MAIN?(t=this._dummyMainImage,i=this._ctx.videoProfile.getVideoEncodeConfig()[0]):(t=this._dummyScreenImage,i=this._ctx.videoProfile.getScreenEncodeConfig()),!t)return;const o=document.createElement("canvas"),s=o.getContext("2d"),r=jy(i.width),n=jy(i.height);if(!s)throw new HS(US.UNEXPECTED_ERROR,"Not support canvas");let a,d;!r||!n||t.width<=r&&t.height<=n?(a=t.width,d=t.height):(a=Math.min(r,t.width*n/t.height),d=Math.min(n,t.height*r/t.width)),o.width=a,o.height=d,s.drawImage(t,0,0,t.width,t.height,0,0,a,d);const c=window.setInterval((()=>{t&&s.drawImage(t,0,0,t.width,t.height,0,0,a,d)}),200);e===qu.STREAM_INDEX_MAIN?(clearInterval(this._dummyMainTimer),this._dummyMainTimer=c):(clearInterval(this._dummyScreenTimer),this._dummyScreenTimer=c);const l=o.captureStream(5).getVideoTracks()[0];var u,h;e===qu.STREAM_INDEX_MAIN?(this._localImgVideoTrack=l,null!==(u=this._localVideoTrack)&&void 0!==u&&u.dummy&&this._localVideoTrack.setTrack(this._localImgVideoTrack)):(this._localImgScreenTrack=l,null!==(h=this._localScreenVideoTrack)&&void 0!==h&&h.dummy&&this._localScreenVideoTrack.setTrack(this._localImgScreenTrack))}_addListenExtensionEvent(e){e.on("re-capture-audio",(()=>{this._localAudioTrack&&this.stopAudioCapture().then((()=>{this.startAudioCapture()}))})),e.on("re-capture-video",(()=>{this._localVideoTrack&&!this._localVideoTrack.dummy&&this.stopVideoCapture().then((()=>{this.startVideoCapture()}))})),e.on("reset-video-effect",(async(e,t)=>{if(this._localVideoTrack&&!this._localVideoTrack.dummy){var i;this._localVideoTrack&&this._removeLocalTrackEvents(this._localVideoTrack);try{await this._localVideoTrack.generatePreProcessingTrack()}catch(o){t(o)}this._initLocalTrackEvents(this._localVideoTrack),this._localVideoTrack.stopAll(),this._localVideoTrack.playAll(),this.safeEmit(wh.onLocalStreamTrackChangedByExtension,{streamIndex:qu.STREAM_INDEX_MAIN,type:"video"}),e(),null!==(i=this._room)&&void 0!==i&&null!==(i=i.localStream)&&void 0!==i&&i.pubVideo&&await this._updatePublish(),this._wtnStreamManager._updatePushTrack()}e()}))}async registerExtension(e){var t,i,o;e.monitor=this.monitor,e.logger=new eS(e.name,0,this.id);try{if(!(await e.isSupported()))throw new Error("This extension is not supported.")}catch(r){throw new Error("This extension is not supported.")}vy("VERSION")!==e.version&&(zy("This extension version is ".concat(e.version,", but the sdk version is ").concat(vy("VERSION"),".")),this.monitor.report("rtc_error",{message:"This extension version is ".concat(e.version,", but the sdk version is ").concat(vy("VERSION"),"."),error_code:-1}));let s={};if("RTCAIAnsExtension"===e.name){s={overloadThreshold:vy("AINR_OVERLOAD_THRESHOLD"),enableCache:vy("AINR_ENABLE_DUMP"),urls:vy("AINR_URLS"),cacheTime:vy("AINR_CACHE_TIME"),dumpTime:vy("AINR_DUMP_TIME")}}s=function(e){const t={};return Object.keys(e).forEach((i=>{void 0!==e[i]&&(t[i]=e[i])})),t}(s),await e.init(s),this._ctx.extensionManager.register(e),this._addListenExtensionEvent(e),null===(t=this._localAudioTrack)||void 0===t||t.generatePreProcessingTrack(),null===(i=this._localVideoTrack)||void 0===i||i.generatePreProcessingTrack(),null===(o=this._localScreenAudioTrack)||void 0===o||o.generatePreProcessingTrack()}defaultTranscoding(){return JSON.parse(JSON.stringify(qG.getDefaultValue()))}async _updatePublish(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.logger.info("_updatePublish()","config: %o",e);if(e=Yu(Yu({},{mediaType:void 0,invokeByJoinRoom:!1,pubState:vP.PUB}),e),!this._ctx.visibility)throw new HS(US.NO_PUBLISH_PERMISSION,"no publish permission");const i=await this._pubLock.lock();if(this._room&&this._ctx.signalingManager.isConnected())try{await this._room.publish(this._localVideoTrack,this._localAudioTrack,e.mediaType,e.pubState,e.invokeByJoinRoom)}catch(BW){throw BW instanceof HS?(BW.code===US.TOKEN_NO_PUBLISH_PERMISSION&&this._room.config.setTokenPublishPrivilegeExpired(!0),BW):new HS(US.UNEXPECTED_ERROR,"unexpected error",BW)}finally{i()}else if(i(),t)throw new HS(US.NOT_CONNECTED_YET,"not connected")}async startAudioPlaybackDeviceTest(e,t){return this.logger.print("startAudioPlaybackDeviceTest()","filePath: %o, indicationInterval: %o",e,t),QS(e,"filePath"),jS(t,"indicationInterval"),await this._audioDeviceManager.startAudioPlaybackDeviceTest(e,t)}stopAudioPlaybackDeviceTest(){this.logger.info("stopAudioPlaybackDeviceTest()"),this._audioDeviceManager.stopAudioPlaybackDeviceTest()}async startAudioDeviceRecordTest(e,t){this.logger.print("startAudioDeviceRecordTest()","indicationInterval: %o",e),jS(e,"indicationInterval"),await this._audioDeviceManager.startAudioDeviceRecordTest(e,t,this._localAudioVolume)}stopAudioDeviceRecordAndPlayTest(){this.logger.info("stopAudioDeviceRecordAndPlayTest()"),this._audioDeviceManager.stopAudioDeviceRecordAndPlayTest()}stopAudioDevicePlayTest(){this.logger.info("stopAudioDevicePlayTest()"),this._audioDeviceManager.stopAudioDevicePlayTest()}setRemoteUserPriority(e,t){var i;this.logger.print("setRemoteUserPriority()","userId: %o, priority: %o",e,t);try{sy(e),BS(t,"priority",[hh.HIGH,hh.MEDIUM,hh.LOW])}catch(o){return console.warn(o),!1}return this._ctx.userPriority.set(e,t),null===(i=this._room)||void 0===i||i.updateRemoteUserPriority(e),!0}async takeLocalSnapshot(e){this.logger.print("takeLocalSnapshot()","streamIndex: %o",e),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]);const t=e===qu.STREAM_INDEX_MAIN?this.localVideoTrack:this.localScreenVideoTrack;if(!t)throw new HS(US.INVOKED_BEFORE_CAPTURE,"capture first");return t.snapshot()}async takeRemoteSnapshot(e,t){var i;this.logger.print("takeRemoteSnapshot()","id: %o, streamIndex: %o",e,t),QS(e,"id"),BS(t,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]);const o=(null===(i=this._room)||void 0===i||null===(i=i.remoteStreams.get(e))||void 0===i||null===(i=i.find((e=>e.isScreen===(t===qu.STREAM_INDEX_SCREEN))))||void 0===i?void 0:i.videoTrack)||this._wtnStreamManager.__getPublicStreamTrack(e,"video");if(!o)throw new HS(US.STREAM_NOT_EXIST,"stream not exist");return o.snapshot()}setSubscribeFallbackOption(e){this.logger.info("setSubscribeFallbackOption()","option: %o",e);try{BS(e,"option",[uh.DISABLE,uh.VIDEO_STREAM_LOW,uh.AUDIO_ONLY])}catch(t){return console.warn(t),!1}return!this._room&&(this._ctx.subscribeFallbackOption=e,!0)}getLocalStreamTrack(e,t){let i,o;if(e===qu.STREAM_INDEX_MAIN?(i="video"===t?this.localVideoTrack:this.localAudioTrack,o=()=>{var e;return null===(e=this._room)||void 0===e?void 0:e.localStream}):(i="video"===t?this.localScreenVideoTrack:this.localScreenAudioTrack,o=()=>{var e;return null===(e=this._room)||void 0===e?void 0:e.localScreenStream}),!i)return;const s=i instanceof YL&&i.mixedAudioTrack?i.mixedAudioTrack:i.preprocessingTrack;if(!s)return;const r=o();return this._reportMsTrackEvent(s,(null==r?void 0:r.stream.id)||"local"),s}getRemoteStreamTrack(e,t,i){var o;let s;const r=(null===(o=this._room)||void 0===o?void 0:o.remoteStreams.get(e))||[];if(null==r||!r.length)return;let n;var a,d,c,l;t===qu.STREAM_INDEX_MAIN?(n=r.find((e=>!e.isScreen)),s="video"===i?null===(a=n)||void 0===a?void 0:a.videoTrack:null===(d=n)||void 0===d?void 0:d.audioTrack):(n=r.find((e=>e.isScreen)),s="video"===i?null===(c=n)||void 0===c?void 0:c.videoTrack:null===(l=n)||void 0===l?void 0:l.audioTrack);if(!s)return;const u=s.preprocessingTrack;if(!u||!n)return;const{streamId:h}=n;return this._reportMsTrackEvent(u,h),u}getPublicStreamTrack(e,t){const i=this._wtnStreamManager.__getPublicStreamTrack(e,t),o=null==i?void 0:i.preprocessingTrack;if(o)return o?(this._reportMsTrackEvent(o,e),o):void 0}setRemoteStreamRenderSync(e){return!this._room&&(this._ctx.avSync=!!e,!0)}setJoinRoomParams(e){e&&(this._ctx.joinRoomParams=e)}async setAudioSelectionConfig(e){BS(e,"audioSelectionPriority",[Rh.DEFAULT,Rh.HIGH]),this._ctx.mediaParams||(this._ctx.mediaParams={}),this._ctx.mediaParams.audioSelectionConfig={isHighPriority:e===Rh.HIGH},this._room&&await this._room.updateMediaParams(this._ctx.mediaParams)}setCaptureVolume(e,t){BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),t=cy(t,"volume",0,400);var i,o,s,r,n;e===qu.STREAM_INDEX_SCREEN?(null===(i=this._localScreenAudioTrack)||void 0===i||i.once("needReplaceTrack",(()=>{var e;null===(e=this._room)||void 0===e||e.updatePubScreenTrack()})),null===(o=this._localScreenAudioTrack)||void 0===o||o.setVolume(t),this._localScreenAudioVolume=t):(null===(s=this._localAudioTrack)||void 0===s||s.once("needReplaceTrack",(()=>{var e;null===(e=this._room)||void 0===e||e.updatePubTrack()})),null===(r=this._localAudioTrack)||void 0===r||r.setVolume(t),null===(n=this._audioDeviceManager.audioTrack)||void 0===n||n.setVolume(t),this._localAudioVolume=t)}setPlaybackVolume(e,t,i){var o,s,r;if(sy(e),BS(t,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),i=cy(i,"volume",0,400),null!==(o=this._room)&&void 0!==o&&o.config.isMultiChatMode())return void zy("setPlaybackVolume is not supported in Conference mode");const n=t===qu.STREAM_INDEX_SCREEN;n?this._remoteScreenAudioVolume.set(e,i):this._remoteAudioVolume.set(e,i);const a=null===(s=this._room)||void 0===s||null===(s=s.remoteStreams.get(e))||void 0===s?void 0:s.find((e=>e.isScreen===n));null==a||null===(r=a.audioTrack)||void 0===r||r.setVolume(i)}setPublicStreamVolume(e,t){this._wtnStreamManager.setWTNRemoteAudioPlaybackVolume(e,t)}async startForwardStreamToRooms(e){e.forEach((e=>{oy(e.roomId)})),this._assertNotInRoom();return await this._room.startForwardStream2Rooms(e)}async updateForwardStreamToRooms(e){e.forEach((e=>{oy(e.roomId)})),this._assertNotInRoom();return await this._room.updateForwardStream2Rooms(e)}async stopForwardStreamToRooms(){this._assertNotInRoom();return await this._room.stopForwardStream2Rooms()}async pauseForwardStreamToAllRooms(){this._assertNotInRoom();return await this._room.pauseForwardStream2AllRooms()}async resumeForwardStreamToAllRooms(){this._assertNotInRoom();return await this._room.resumeForwardStream2AllRooms()}async ambulance(){const e=await bW(this),t=JSON.stringify(e);return this.monitor.reportLongString("ambulance",t),e}async setEarMonitorMode(e,t){this.logger.info("setEarMonitorMode()","streamIndex: %s, position: %s",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),BS(t,"position",[Zh.NONE,Zh.AFTER_CAPTURE,Zh.AFTER_PROCESS]),this._ctx.earMonitorSettings[e].position=t;const i=e===qu.STREAM_INDEX_MAIN?this.localAudioTrack:e===qu.STREAM_INDEX_SCREEN?this.localScreenAudioTrack:void 0;if(i)return t!==Zh.NONE?i.play(t):i.stop();this.logger.warn("setEarMonitorMode()","local audio track not exist")}setEarMonitorVolume(e,t){this.logger.info("setEarMonitorVolume()","streamIndex: %s, volume: %s",e,t),BS(e,"streamIndex",[qu.STREAM_INDEX_MAIN,qu.STREAM_INDEX_SCREEN]),t=cy(t,"volume",0,400),this._ctx.earMonitorSettings[e].volume=t;const i=e===qu.STREAM_INDEX_MAIN?this.localAudioTrack:e===qu.STREAM_INDEX_SCREEN?this.localScreenAudioTrack:void 0;if(i)return i.setPlaybackVolume(t);this.logger.warn("setEarMonitorVolume()","local audio track not exist")}_reportMsTrackEvent(e,t){if(!e.hookStop){e.hookStop=!0;const i=e.stop;e.stop=()=>{Wv(this.id,"stop",t,0,t),i.call(e)}}}async _updateScreenPublish(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger.info("_updateScreenPublish()");if(e=Yu(Yu({},{mediaType:void 0,pubState:vP.PUB}),e),!this._ctx.visibility)throw new HS(US.NO_PUBLISH_PERMISSION,"no publish permission");const t=await this._pubLock.lock();if(this._room&&this._ctx.signalingManager.isConnected())try{await this._room.publishScreen(this._localScreenVideoTrack,this._localScreenAudioTrack,e.mediaType,e.pubState)}catch(BW){throw BW instanceof HS?BW:new HS(US.UNEXPECTED_ERROR,"unexpected error",BW)}finally{t()}else t()}_updateAudioPlayerState(e){this.logger.info("_updateAudioPlayerState()");const{userId:t,isScreen:i,isPublic:o}=e;if(e.audioTrack&&e.attributes.audiostream&&e.subAudio){var s,r,n;if(!e.audioTrack.havePlayer()){var a,d;const s=new OL(this.id,t,{muted:(null===(a=this._config)||void 0===a?void 0:a.autoPlayPolicy)===vh.VIDEO_ONLY||(null===(d=this._config)||void 0===d?void 0:d.autoPlayPolicy)===vh.PLAY_MANUALLY,isScreen:!o&&i});e.audioTrack.setPlayer(s),e.audioTrack.bindPlayerEvent(this._initPlayerEvents.bind(this));const r=this._audioDeviceManager.getSinkId();r&&e.audioTrack.setPlaybackDevice(r)}e.audioTrack.play();const u=o?null!==(s=this._ctx.publicAudioVolume.get(t))&&void 0!==s?s:100:i?null!==(r=this._remoteScreenAudioVolume.get(t))&&void 0!==r?r:100:null!==(n=this._remoteAudioVolume.get(t))&&void 0!==n?n:100;if(e.audioTrack.setVolume(u),rS&&pS){var c,l;const e=null!==(c=null===(l=this._room)||void 0===l?void 0:l.remoteStreams)&&void 0!==c?c:new Map;h=e,$G&&clearTimeout($G),$G=setTimeout((()=>{for(const[e,t]of h)null!=e&&e.startsWith("mux")&&t.forEach((e=>{var t;null===(t=e.audioTrack)||void 0===t||t.pause()}));for(const[e,t]of h)null!=e&&e.startsWith("mux")&&t.forEach((e=>{var t;null===(t=e.audioTrack)||void 0===t||t.play()}))}),2e3)}}else{var u;null===(u=e.audioTrack)||void 0===u||u.stop()}var h}_updateVideoPlayerState(e){if(this.logger.info("_updateVideoPlayerState()"),e.videoTrack){const i=e.isPublic?this._wtnStreamManager._publicVideoPlayerConfig:this._remoteVideoPlayerConfig[e.isScreen?qu.STREAM_INDEX_SCREEN:qu.STREAM_INDEX_MAIN].get(e.userId);if(i)for(const[,o]of i){var t;e.videoTrack.setPlayer(this.id,o,null===(t=this._config)||void 0===t?void 0:t.autoPlayPolicy,this._initPlayerEvents.bind(this))}}}get _localVideoTrack(){return this._ctx.localVideoTrack}get _localAudioTrack(){return this._ctx.localAudioTrack}set _localVideoTrack(e){this._ctx.localVideoTrack=e}set _localAudioTrack(e){this._ctx.localAudioTrack=e}async _onAddStream(e){const t=e.stream,{localaudio:i,audiostream:o,localvideo:s,videostream:r}=t.attributes;let n=ly.NONE;o&&(n|=$u.AUDIO),r&&(n|=$u.VIDEO),n&&(await new Promise((e=>setTimeout(e))),t.isScreen?this.safeEmit(wh.onUserPublishScreen,{userId:t.userId,mediaType:n}):(this.safeEmit(wh.onUserPublishStream,{userId:t.userId,mediaType:n,videoStreamDescriptions:t.attributes.videoDescriptions}),this._handleAutoSubscribe(t,!0)),this.safeEmit("onAddStream",{userId:t.userId,mediaType:n,isScreen:!!t.isScreen}),t.isScreen||(i&&this.safeEmit(wh.onUserStartAudioCapture,{userId:t.userId}),s&&this.safeEmit(wh.onUserStartVideoCapture,{userId:t.userId})))}_handleAutoSubscribe(e,t){var i,o;let s=ly.NONE;if(null!==(i=this._room)&&void 0!==i&&i.config.isAutoSubscribeAudio&&(s|=$u.AUDIO),null!==(o=this._room)&&void 0!==o&&o.config.isAutoSubscribeVideo&&(s|=$u.VIDEO),s){var r,n,a;if(t&&Ky(s))null===(n=e.observer)||void 0===n||n.setAutoSubscribeAudio(!0);if(t&&Uy(s))null===(a=e.observer)||void 0===a||a.setAutoSubscribeVideo(!0);null!==(r=this._room)&&void 0!==r&&r.config.tokenSubscribePrivilegeExpired?(Ky(s)&&(this._pauseAllSubscribeState.resumeAudioStreamIds[e.streamId]=e.streamId),Uy(s)&&(this._pauseAllSubscribeState.resumeVideoStreamIds[e.streamId]=e.streamId)):this._subscribe(!1,e.userId,s)}}_onRemoveStream(e){var t;const i=e.stream,o=null!==(t=EW[e.reason])&&void 0!==t?t:eh.STREAM_REMOVE_REASON_OTHER,s=i.isScreen?wh.onUserUnpublishScreen:wh.onUserUnpublishStream;let r=ly.NONE;i.attributes.audiostream&&(r|=$u.AUDIO),i.attributes.videostream&&(r|=$u.VIDEO),r!==ly.NONE&&(this.safeEmit(s,{userId:i.userId,mediaType:r,reason:o}),this.safeEmit("onRemoveStream",{userId:i.userId,isScreen:i.isScreen})),delete this._pauseAllSubscribeState.resumeAudioStreamIds[i.streamId],delete this._pauseAllSubscribeState.resumeVideoStreamIds[i.streamId],"function"==typeof e.callback&&e.callback()}_onUserConnection(e){setTimeout((()=>this.safeEmit(wh.onUserJoined,e)))}_onUserLeave(e){this.safeEmit(wh.onUserLeave,e)}_onRoomError(e){var t;this.safeEmit(wh.onError,e),null===(t=this._room)||void 0===t||t.destroy(),this._room=void 0}_onNetworkQuality(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.safeEmit(wh.onNetworkQuality,...t)}_onConnectionStateChange(e){if(void 0!==this._startCloudProxyTimestamp&&this._ctx.useCloudProxy&&e.state===th.CONNECTION_STATE_CONNECTED&&this.safeEmit(wh.onCloudProxyConnected,{interval:Date.now()-this._startCloudProxyTimestamp}),(this._ctx.isPreConnection||e.state!==th.CONNECTION_STATE_CONNECTED&&e.state!==th.CONNECTION_STATE_RECONNECTED)&&this.safeEmit(wh.onConnectionStateChanged,e),e.state===th.CONNECTION_STATE_RECONNECTING)for(const[o,s]of null!==(t=null===(i=this._room)||void 0===i?void 0:i.remoteStreams)&&void 0!==t?t:new Map){var t,i;o.startsWith("mux")&&s.forEach((e=>{var t;return null===(t=e.audioTrack)||void 0===t?void 0:t.stop()}))}else e.state===th.CONNECTION_STATE_CONNECTED&&this._rtmClient.setRTSMessageLimit(this._ctx.rtsLimiter.conf)}_stopAudioPropertiesReport(){null!==this._audioPropertiesReportTimer&&(clearInterval(this._audioPropertiesReportTimer),this._audioPropertiesReportTimer=null)}_onResubscribe(e){var t,i;e.stream&&(null===(t=e.stream.videoTrack)||void 0===t||t.stopAll(),null===(i=e.stream.audioTrack)||void 0===i||i.stop(),this._updateAudioPlayerState(e.stream),this._updateVideoPlayerState(e.stream))}_onSubscribePushTrack(e){e.stream&&this._updateAudioPlayerState(e.stream)}_onRemovePushTrack(e){e.stream&&this._updateAudioPlayerState(e.stream)}_onUserPublishStateChange(e){let{userId:t,isScreen:i,mediaType:o,pubState:s,remoteStream:r}=e;const n={userId:t,mediaType:o};o&$u.AUDIO&&setTimeout((()=>{this._updateAudioPlayerState(r)})),i?s===vP.PUB?this.safeEmit(wh.onUserPublishScreen,n):this.safeEmit(wh.onUserUnpublishScreen,Yu(Yu({},n),{},{reason:eh.STREAM_REMOVE_REASON_UNPUBLISH})):s===vP.PUB?(n.videoStreamDescriptions=r.attributes.videoDescriptions,this.safeEmit(wh.onUserPublishStream,n),this._handleAutoSubscribe(r,!0)):this.safeEmit(wh.onUserUnpublishStream,Yu(Yu({},n),{},{reason:eh.STREAM_REMOVE_REASON_UNPUBLISH}))}_onCustomMessage(e){const{message:t}=e;e.binary?this.safeEmit(wh.onRoomBinaryMessageReceived,{userId:e.clientId,message:t}):this.safeEmit(wh.onRoomMessageReceived,{userId:e.clientId,message:t})}_onUserMessageReceived(e){this._messageStatisticsObserver.recvP2PMessage(e.userId),this.safeEmit(wh.onUserMessageReceived,e)}_onUserBinaryMessageReceived(e){this._messageStatisticsObserver.recvP2PMessage(e.userId),this.safeEmit(wh.onUserBinaryMessageReceived,e)}_onLiveTranscodingResult(e){this.safeEmit(wh.onLiveTranscodingResult,e)}_onStreamMixingEvent(e){this.safeEmit(wh.onStreamMixingEvent,e)}_onUserTokenWillExpire(){this.safeEmit(wh.onTokenWillExpire)}_onUserTokenPublishPrivilegeWillExpire(){this.safeEmit(wh.onTokenPublishPrivilegeWillExpire)}async _onUserTokenPublishPrivilegeDidExpired(){var e,t,i;await(null===(e=this._room)||void 0===e?void 0:e.unpublish()),await(null===(t=this._room)||void 0===t?void 0:t.unpublishScreen()),null===(i=this._room)||void 0===i||i.config.setTokenPublishPrivilegeExpired(!0),this.safeEmit(wh.onTokenPublishPrivilegeDidExpired,{errorCode:US.TOKEN_NO_PUBLISH_PERMISSION,message:"Token no longer has publish privilege"})}_onUserTokenSubscribePrivilegeWillExpire(){this.safeEmit(wh.onTokenSubscribePrivilegeWillExpire)}async _onUserTokenSubscribePrivilegeDidExpired(){this._handleLoseSubscribePrivilege(),this.safeEmit(wh.onTokenSubscribePrivilegeDidExpired,{errorCode:US.TOKEN_NO_SUBSCRIBE_PERMISSION,message:"Token no longer has subscribe privilege"})}async _unSubscribeAllRemoteStreams(){return this._room?this._pauseAllRemoteStreams($u.AUDIO_AND_VIDEO):Promise.resolve()}_onPushPublicStreamResult(e){this.safeEmit(wh.onPushPublicStreamResult,e)}_handleRTMClient(e){e.on("onUserMessageReceivedOutsideRoom",(e=>{this._messageStatisticsObserver.recvP2POutRoomMessage(e.userId),this.safeEmit(wh.onUserMessageReceivedOutsideRoom,e)})),e.on("onUserBinaryMessageReceivedOutsideRoom",(e=>{this._messageStatisticsObserver.recvP2POutRoomMessage(e.userId),this.safeEmit(wh.onUserBinaryMessageReceivedOutsideRoom,e)})),e.on("onUserDisconnection",(()=>{this.safeEmit(wh.onError,{errorCode:US.RTM_DUPLICATE_LOGIN})})),e.on("onRTMTokenError",(()=>{this.safeEmit(wh.onError,{errorCode:US.RTM_TOKEN_ERROR})})),e.on("onServerParamsSetResult",(e=>{this.safeEmit(wh.onServerParamsSetResult,null==e?void 0:e.code)}))}getSubLock(e,t){const i=e?this._subScreenLocks:this._subLocks;let o=i.get(t);return o||(o=new GP("sub_".concat(e?1:0,"_").concat(t)),i.set(t,o)),o}get localAudioTrack(){return this._localAudioTrack}get localVideoTrack(){return this._localVideoTrack}get localScreenAudioTrack(){return this._localScreenAudioTrack}get localScreenVideoTrack(){return this._localScreenVideoTrack}get remoteStreams(){var e;const t=[];return null!==(e=this._room)&&void 0!==e&&e.remoteStreams&&this._room.remoteStreams.forEach((e=>{Array.isArray(e)&&e.forEach((e=>{t.push({userId:e.userId,isScreen:e.isScreen,hasVideo:e.hasVideo,hasAudio:e.hasAudio,videoStreamDescriptions:e.attributes.videoDescriptions})}))})),t}get iceState(){var e;return null===(e=this._ctx.peerConnection)||void 0===e?void 0:e.getIceConnectionState()}get remoteUsers(){var e;const t=[];return null!==(e=this._room)&&void 0!==e&&e.remoteUsers&&this._room.remoteUsers.forEach((e=>{t.push({userId:e.userId})})),t}get multiChatMode(){var e;return!(null===(e=this._room)||void 0===e||!e.config.isMultiChatMode())}get checkMediaType(){return this._checkMediaType}get assertNotInRoom(){return this._assertNotInRoom}get peerConnection(){var e;return null===(e=this._ctx.peerConnection)||void 0===e?void 0:e.getOriginRTCPeerConnection()}_handleAudioDeviceManager(){this._audioDeviceManager.on("onAudioPlaybackDeviceTestVolume",(e=>{this.safeEmit(wh.onAudioPlaybackDeviceTestVolume,e)}))}_assertNotInRoom(){if(!this._room||!this._ctx.signalingManager.isConnected())throw new HS(US.NOT_CONNECTED_YET,"server not connected")}_checkMediaType(e){BS(e,"mediaType",[$u.AUDIO,$u.VIDEO,$u.AUDIO_AND_VIDEO])}_getUserId(){var e;return(null===(e=this._room)||void 0===e?void 0:e.config.userInfo.userId)||"local_user"}async _switchTrack(e){var t;this._initLocalTrackEvents(e),this._localVideoTrack=e,this._localVideoPlayerConfig[qu.STREAM_INDEX_MAIN].forEach((t=>{var i;e.setPlayer(t,this._mirrorType,null===(i=this._config)||void 0===i?void 0:i.autoPlayPolicy,this._initPlayerEvents.bind(this))})),null!==(t=this._room)&&void 0!==t&&null!==(t=t.localStream)&&void 0!==t&&t.pubVideo&&await this._updatePublish(),this._wtnStreamManager._updatePushTrack()}async _shouldUpdateAudioConf(e){var t,i;const o=await(null===(t=this._room)||void 0===t?void 0:t.hasPublished())||(null===(i=this._room)||void 0===i||null===(i=i.localStream)||void 0===i?void 0:i.pubAudio)||this._localAudioTrack&&this._localAudioTrack.sourceType===yT.INTERNAL;if(o){const t="engine.".concat(e," should be called before publishing or capturing.");console.warn("[RTC WebSDK]: ".concat(t)),Wv(this.id,e,t)}return!o}_getRemoteVideoPlayerConfig(e,t,i){var o;return null===(o=this._remoteVideoPlayerConfig[e].get(t))||void 0===o?void 0:o.get(i)}_setRemoteVideoPlayerConfig(e,t,i,o){const s=this._remoteVideoPlayerConfig[e].get(t)||new Map;s.set(i,o),this._remoteVideoPlayerConfig[e].set(t,s)}getRemoteVideoStats(){var e;const t=null===(e=this._room)||void 0===e?void 0:e.remoteStreams;if(!t||0===t.size)return{};const i={};return t.forEach(((e,t)=>{var o,s,r;let n,a;null!==(o=e[0])&&void 0!==o&&o.isScreen?(a=e[0],n=e[1]):(a=e[1],n=e[0]);const d={mainVideoStats:Fy((null===(s=n)||void 0===s?void 0:s.getRemoteStreamStats().videoStats)||{}),screenVideoStats:Fy((null===(r=a)||void 0===r?void 0:r.getRemoteStreamStats().videoStats)||{})};i[t]=d})),i}getRemoteAudioStats(){var e;const t=null===(e=this._room)||void 0===e?void 0:e.remoteStreams;if(!t||0===t.size)return{};const i={};return t.forEach(((e,t)=>{var o,s,r;let n,a;null!==(o=e[0])&&void 0!==o&&o.isScreen?(a=e[0],n=e[1]):(a=e[1],n=e[0]);const d={mainAudioStats:Fy((null===(s=n)||void 0===s?void 0:s.getRemoteStreamStats().audioStats)||{}),screenAudioStats:Fy((null===(r=a)||void 0===r?void 0:r.getRemoteStreamStats().audioStats)||{})};i[t]=d})),i}getLocalVideoStats(){var e,t;return{mainVideoStats:Fy((null===(e=this._room)||void 0===e||null===(e=e.localStream)||void 0===e?void 0:e.getLocalStreamStats().videoStats)||{}),screenVideoStats:Fy((null===(t=this._room)||void 0===t||null===(t=t.localScreenStream)||void 0===t?void 0:t.getLocalStreamStats().videoStats)||{})}}getLocalAudioStats(){var e,t;return{mainAudioStats:Fy((null===(e=this._room)||void 0===e||null===(e=e.localStream)||void 0===e?void 0:e.getLocalStreamStats().audioStats)||{}),screenAudioStats:Fy((null===(t=this._room)||void 0===t||null===(t=t.localScreenStream)||void 0===t?void 0:t.getLocalStreamStats().audioStats)||{})}}getPublicVideoStats(){const e=this._wtnStreamManager.__getRemoteStreams();if(!e||0===e.size)return{};const t={};return e.forEach(((e,i)=>{const o=Fy(e.getRemoteStreamStats().videoStats||{});delete o.isScreen,t[i]=o})),t}getPublicAudioStats(){const e=this._wtnStreamManager.__getRemoteStreams();if(!e||0===e.size)return{};const t={};return e.forEach(((e,i)=>{const o=Fy(e.getRemoteStreamStats().audioStats||{});delete o.isScreen,t[i]=o})),t}},Ou(yW,"hasReportNativeDetector",!1),yW);let RW=IW;TW([wv()],RW.prototype,"updateToken",1),TW([wv(),LW("video")],RW.prototype,"setVideoCaptureDevice",1),TW([wv(),LW("audio")],RW.prototype,"setAudioCaptureDevice",1),TW([wv()],RW.prototype,"connect",1),TW([function(e,t,i){if("function"==typeof i.value){const e=i.value;i.value=function(){var t;const i=Nv(this.id);for(var o=arguments.length,s=new Array(o),r=0;r<o;r++)s[r]=arguments[r];return null==i||i.set({room_id:s[1],user_id:null===(t=s[2])||void 0===t?void 0:t.userId}),e.apply(this,s)}}},wv()],RW.prototype,"joinRoom",1),TW([wv()],RW.prototype,"leaveRoom",1),TW([wv()],RW.prototype,"destroy",1),TW([wv(),eG],RW.prototype,"publishStream",1),TW([wv(),eG],RW.prototype,"unpublishStream",1),TW([wv(),eG],RW.prototype,"publishScreen",1),TW([wv(),eG],RW.prototype,"unpublishScreen",1),TW([wv(),eG],RW.prototype,"subscribeStream",1),TW([CW],RW.prototype,"_subscribe",1),TW([wv(),eG],RW.prototype,"unsubscribeStream",1),TW([wv(),eG],RW.prototype,"subscribeScreen",1),TW([wv(),eG],RW.prototype,"unsubscribeScreen",1),TW([CW],RW.prototype,"_unsubscribe",1),TW([wv(),ZW],RW.prototype,"setRemoteVideoConfig",1),TW([wv()],RW.prototype,"setRemoteSimulcastStreamType",1),TW([wv(),LW("video")],RW.prototype,"startVideoCapture",1),TW([wv(),LW("video")],RW.prototype,"stopVideoCapture",1),TW([wv(),LW("audio")],RW.prototype,"startAudioCapture",1),TW([wv(),LW("audio")],RW.prototype,"stopAudioCapture",1),TW([wv(),LW("all")],RW.prototype,"startAudioAndVideoCapture",1),TW([wv()],RW.prototype,"startVideoAndAudioCapture",1),TW([wv()],RW.prototype,"getAudioMixingManager",1),TW([wv()],RW.prototype,"getWTNStreamManager",1),TW([wv()],RW.prototype,"getCallId",1),TW([wv(),PW],RW.prototype,"startScreenCapture",1),TW([wv(),PW],RW.prototype,"stopScreenCapture",1),TW([wv()],RW.prototype,"setLocalVideoPlayer",1),TW([wv(),eG],RW.prototype,"startLiveTranscoding",1),TW([wv(),eG],RW.prototype,"updateLiveTranscoding",1),TW([wv(),eG],RW.prototype,"stopLiveTranscoding",1),TW([wv(),eG],RW.prototype,"startSubtitle",1),TW([wv(),eG],RW.prototype,"updateSubtitleConfig",1),TW([wv(),eG],RW.prototype,"stopSubtitle",1),TW([wv()],RW.prototype,"setBusinessId",1),TW([wv(),eG],RW.prototype,"setUserVisibility",1),TW([wv()],RW.prototype,"setRemoteVideoPlayer",1),TW([wv()],RW.prototype,"setLocalVideoMirrorType",1),TW([wv()],RW.prototype,"setRemoteVideoMirrorType",1),TW([wv()],RW.prototype,"setAudioPlaybackDevice",1),TW([wv()],RW.prototype,"play",1),TW([wv()],RW.prototype,"stop",1),TW([wv()],RW.prototype,"getAudioVolume",1),TW([wv()],RW.prototype,"setAudioFrameCallback",1),TW([wv(),eG],RW.prototype,"pauseAllSubscribedStream",1),TW([wv(),eG],RW.prototype,"resumeAllSubscribedStream",1),TW([wv()],RW.prototype,"sendUserMessage",1),TW([wv()],RW.prototype,"sendUserBinaryMessage",1),TW([wv()],RW.prototype,"sendRoomMessage",1),TW([wv()],RW.prototype,"sendRoomBinaryMessage",1),TW([wv()],RW.prototype,"setAudioCaptureConfig",1),TW([Jy("4.51"),wv()],RW.prototype,"setVideoCaptureConfig",1),TW([wv()],RW.prototype,"enableSimulcastMode",1),TW([wv()],RW.prototype,"setLocalSimulcastMode",1),TW([wv()],RW.prototype,"setVideoEncoderConfig",1),TW([wv()],RW.prototype,"setScreenEncoderConfig",1),TW([wv(),eG],RW.prototype,"sendSEIMessage",1),TW([Jy("4.42"),wv()],RW.prototype,"setAudioVolumeIndicationInterval",1),TW([wv()],RW.prototype,"enableAudioPropertiesReport",1),TW([wv()],RW.prototype,"setVideoSourceType",1),TW([wv()],RW.prototype,"setExternalVideoTrack",1),TW([wv()],RW.prototype,"setAudioSourceType",1),TW([wv()],RW.prototype,"setExternalAudioTrack",1),TW([wv()],RW.prototype,"login",1),TW([wv()],RW.prototype,"logout",1),TW([wv()],RW.prototype,"updateLoginToken",1),TW([wv()],RW.prototype,"getPeerOnlineStatus",1),TW([wv()],RW.prototype,"sendUserMessageOutsideRoom",1),TW([wv()],RW.prototype,"sendUserBinaryMessageOutsideRoom",1),TW([wv()],RW.prototype,"setServerParams",1),TW([wv()],RW.prototype,"sendServerMessage",1),TW([wv()],RW.prototype,"sendServerBinaryMessage",1),TW([wv()],RW.prototype,"startCloudProxy",1),TW([wv()],RW.prototype,"stopCloudProxy",1),TW([wv()],RW.prototype,"startPushPublicStream",1),TW([wv()],RW.prototype,"updatePublicStreamParam",1),TW([wv()],RW.prototype,"stopPushPublicStream",1),TW([wv(["streamId"])],RW.prototype,"startPlayPublicStream",1),TW([wv(["streamId"])],RW.prototype,"stopPlayPublicStream",1),TW([wv()],RW.prototype,"setAudioProfile",1),TW([wv()],RW.prototype,"setAudioEncodeMaxBitrate",1),TW([wv()],RW.prototype,"setPublicStreamVideoPlayer",1),TW([wv()],RW.prototype,"setDummyCaptureImagePath",1),TW([wv()],RW.prototype,"registerExtension",1),TW([wv()],RW.prototype,"startAudioPlaybackDeviceTest",1),TW([wv()],RW.prototype,"stopAudioPlaybackDeviceTest",1),TW([wv()],RW.prototype,"startAudioDeviceRecordTest",1),TW([wv()],RW.prototype,"stopAudioDeviceRecordAndPlayTest",1),TW([wv()],RW.prototype,"stopAudioDevicePlayTest",1),TW([wv(),ZW],RW.prototype,"setRemoteUserPriority",1),TW([wv()],RW.prototype,"takeLocalSnapshot",1),TW([wv()],RW.prototype,"takeRemoteSnapshot",1),TW([wv()],RW.prototype,"setSubscribeFallbackOption",1),TW([wv()],RW.prototype,"getLocalStreamTrack",1),TW([wv()],RW.prototype,"getRemoteStreamTrack",1),TW([wv()],RW.prototype,"getPublicStreamTrack",1),TW([wv()],RW.prototype,"setRemoteStreamRenderSync",1),TW([wv()],RW.prototype,"setJoinRoomParams",1),TW([wv(),eG],RW.prototype,"setAudioSelectionConfig",1),TW([wv(),eG],RW.prototype,"startForwardStreamToRooms",1),TW([wv(),eG],RW.prototype,"updateForwardStreamToRooms",1),TW([wv(),eG],RW.prototype,"stopForwardStreamToRooms",1),TW([wv(),eG],RW.prototype,"pauseForwardStreamToAllRooms",1),TW([wv(),eG],RW.prototype,"resumeForwardStreamToAllRooms",1),TW([wv()],RW.prototype,"setEarMonitorMode",1),TW([wv([],{debounce:2e3,debounceTag:function(e){return"".concat(e)}})],RW.prototype,"setEarMonitorVolume",1);const EW={"client unpublished":eh.STREAM_REMOVE_REASON_UNPUBLISH,"publish failed":eh.STREAM_REMOVE_REASON_PUBLISH_FAILED,"stream removed":eh.STREAM_REMOVE_REASON_KEEP_LIVE_FAILED,"client disconnected":eh.STREAM_REMOVE_REASON_CLIENT_DISCONNECTED,"client republish":eh.STREAM_REMOVE_REASON_REPUBLISH,"token publish privilege expired":eh.STREAM_REMOVE_REASON_TOKEN_PRIVILEGE_EXPIRED};function CW(e,t,i){const o=i.value;return i.value=async function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const[s,r,n]=t;this.checkMediaType(n),this.assertNotInRoom();const a=await this.getSubLock(s,r).lock();try{return await o.apply(this,t)}finally{a()}},i}function ZW(e,t,i){const o=i.value;return i.value=async function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const[s]=t,r=await this.getSubLock(!1,s).lock();try{return await o.apply(this,t)}finally{r()}},i}function LW(e){return function(t,i,o){const s=o.value;return o.value=async function(){const t=[];"video"!==e&&t.push(this._audioCaptureLock.lock()),"audio"!==e&&t.push(this._videoCaptureLock.lock());const i=await Promise.all(t);try{for(var o=arguments.length,r=new Array(o),n=0;n<o;n++)r[n]=arguments[n];return await s.apply(this,r)}finally{i.forEach((e=>e()))}},o}}function PW(e,t,i){const o=i.value;return i.value=async function(){const e=await this._screenCaptureLock.lock();try{for(var t=arguments.length,i=new Array(t),s=0;s<t;s++)i[s]=arguments[s];return await o.apply(this,i)}finally{e()}},i}var kW=Object.defineProperty,NW=Object.getOwnPropertyDescriptor,XW=(e,t,i,o)=>{for(var s,r=o>1?void 0:o?NW(t,i):t,n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o?s(t,i,r):s(r))||r);return o&&r&&kW(t,i,r),r};class VW extends RW{constructor(e,t,i){super(e,t,i),Ou(this,"singleStreamRenderMode",!1),this.id=t,this.logger=new eS("BLWEngine",0,t),fy([{width:192,height:108,frameRate:15,maxKbps:100},{width:320,height:180,frameRate:15,maxKbps:140},{width:640,height:360,frameRate:15,maxKbps:400},{width:1280,height:720,frameRate:15,maxKbps:1e3},{width:1920,height:1080,frameRate:15,maxKbps:2e3}]),this._handleEngineEvents()}async subscribeStream(e,t){return this.logger.print("subscribeStream()","userId: %o, mediaType: %o",e,t),this.singleStreamRenderMode&&Uy(t)&&super.subscribeScreen(e,$u.VIDEO).catch((e=>{this.logger.error("singleStreamRenderMode subscribeScreen()",e)})),super.subscribeStream(e,t)}async unsubscribeStream(e,t){return this.logger.print("unsubscribeStream()","userId: %o, mediaType: %o",e,t),this.singleStreamRenderMode&&Uy(t)&&super.unsubscribeScreen(e,$u.VIDEO).catch((e=>{this.logger.error("singleStreamRenderMode unsubscribeScreen()",e)})),super.unsubscribeStream(e,t)}setRemoteScreenVideoStreamIndex(e){return this.logger.print("setRemoteScreenVideoStreamIndex()","streamIndex: %o",e),!this._room&&(this.singleStreamRenderMode=e===qu.STREAM_INDEX_MAIN,!0)}setRemoteVideoPlayer(e,t){if(this.logger.print("setRemoteVideoPlayer()","streamIndex: %o, videoPlayerOption: %o",e,t),null==t||delete t.playerId,!this.singleStreamRenderMode||e!==qu.STREAM_INDEX_SCREEN)return super.setRemoteVideoPlayer(e,t)}destroy(){this.singleStreamRenderMode=!1,super.destroy()}_updateVideoPlayerState(e){var t,i,o,s;if(!this.singleStreamRenderMode)return super._updateVideoPlayerState(e);const{userId:r}=e,n=null===(t=this._room)||void 0===t?void 0:t.remoteStreams.get(r);let a,d;Array.isArray(n)&&n.forEach((e=>{e.isScreen?a=e:d=e}));let c=null===(i=d)||void 0===i||null===(i=i.videoTrack)||void 0===i?void 0:i.dangerousGetPlayer(XL);if(!c){var l;const e=null===(l=this._remoteVideoPlayerConfig[qu.STREAM_INDEX_MAIN].get(r))||void 0===l?void 0:l.get(XL);if(!e)return;var u,h,m;null===(u=d)||void 0===u||null===(u=u.videoTrack)||void 0===u||u.setPlayer(this.id,e,null===(h=this._config)||void 0===h?void 0:h.autoPlayPolicy,this._initPlayerEvents.bind(this)),c=null===(m=d)||void 0===m||null===(m=m.videoTrack)||void 0===m?void 0:m.dangerousGetPlayer(XL)}var p,_,b;if(!e.isScreen&&null!==(o=a)&&void 0!==o&&o.videoTrack&&a.videoHasPublish)return this.logger.print("_updateVideoPlayerState","prevent play main stream"),void(null===(p=c)||void 0===p||p.playVideo(a.videoTrack));e.videoTrack?(null===(_=this._config)||void 0===_?void 0:_.autoPlayPolicy)!==vh.PLAY_MANUALLY&&(null===(b=c)||void 0===b||b.playVideo(e.videoTrack)):null!==(s=c)&&void 0!==s&&s.played&&c.stop()}_handleEngineEvents(){this.on(wh.onUserPublishScreen,(e=>{if(this.singleStreamRenderMode&&Uy(e.mediaType)){var t,i;const o=null===(t=this._room)||void 0===t?void 0:t.remoteStreams.get(e.userId),s=null==o?void 0:o.find((e=>!e.isScreen)),r=null==o?void 0:o.find((e=>e.isScreen));null!=r&&r.hasSubscribed?(this.logger.info("onUserPublishScreen","singleStreamRenderMode screen hasSubscribed"),this._updateVideoPlayerState(r)):(null!==(i=this._room)&&void 0!==i&&i.config.isAutoSubscribeVideo||null!=s&&s.hasSubscribed&&Uy(s.subMediaType))&&(this.logger.info("onUserPublishScreen","singleStreamRenderMode subscribeScreen"),this.subscribeScreen(e.userId,$u.VIDEO))}})),this.on(wh.onUserUnpublishScreen,(e=>{if(this.singleStreamRenderMode&&Uy(e.mediaType)){var t;const i=null===(t=this._room)||void 0===t?void 0:t.remoteStreams.get(e.userId),o=null==i?void 0:i.find((e=>!e.isScreen));o&&setTimeout((()=>{this._updateVideoPlayerState(o)}))}}))}}XW([wv()],VW.prototype,"subscribeStream",1),XW([wv()],VW.prototype,"unsubscribeStream",1),XW([wv()],VW.prototype,"setRemoteScreenVideoStreamIndex",1),XW([wv()],VW.prototype,"setRemoteVideoPlayer",1),XW([wv()],VW.prototype,"destroy",1);const wW=new eS("VERTC",0);Cm.storeKey="".concat(Date.now(),"-").concat(DS.getDeviceId()),Iv({rtc_sdk_version:_y.VERSION,device_id:DS.getDeviceId(),log_cache_key:Cm.storeKey}),Rv(_y.LOG_SERVER_URL);let xW=1;const GW=(e,t)=>{wW.info("createEngine","Invoke VERTC.createEngine"),QS(e,"appId");const i=(xW++).toString();return Xv(i,{rtc_app_id:e,auto_play_policy:null==t?void 0:t.autoPlayPolicy}),new RW(e,i,t)},WW=(e,t)=>{wW.print("createBLWEngine","Invoke VERTC.createBLWEngine"),QS(e,"appId");const i=(xW++).toString();return Xv(i,{rtc_app_id:e,auto_play_policy:null==t?void 0:t.autoPlayPolicy}),new VW(e,i,t)},MW=e=>{if(wW.info("destroyEngine","Invoke VERTC.destroyEngine"),!(e instanceof RW))throw new HS(US.INVALID_ENGINE,"Invalid engine object");var t;e.destroy(),(t=e.monitor).report("sdk_init_engine",{start:Date.now(),type:"end"}),kv.delete(t.id)},AW=async()=>LL.enumerateDevices(),OW=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{video:!0,audio:!0};const{video:t,audio:i}=e,o={video:!1,audio:!1},s=[];return t&&s.push(LL.getPermissions({video:!0,force:!0}).then((e=>{o.video=e.video,e.video||(o.videoExceptionError=e.reason)}))),i&&s.push(LL.getPermissions({audio:!0,force:!0}).then((e=>{o.audio=e.audio,e.audio||(o.audioExceptionError=e.reason)}))),await Promise.allSettled(s),o},DW=async()=>LL.enumerateAudioCaptureDevices(),YW=async()=>LL.enumerateVideoCaptureDevices(),KW=async()=>LL.enumerateAudioPlaybackDevices(),UW=()=>_y.VERSION,FW=()=>(async()=>{try{return!(tS()||!window.RTCPeerConnection||!window.RTCPeerConnection.prototype.addTransceiver||!window.RTCPeerConnection.prototype.createDataChannel)&&await xT()&&await wT()}catch(e){return!1}})(),HW=()=>(async()=>(await LT()).map((e=>e===ZT.ByteVC1?"H265":e.toUpperCase())))(),JW=e=>{let{logLevel:t,LogfileSize:i}=e;t&&(Cm.logLevel=t),i&&(Cm.LogfileSize=i)},zW=e=>{Cm.download(e)};function jW(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return JSON.stringify(t.map((e=>e instanceof RW?"[ENGINE]":e)))}function QW(e,t){return function(){Cv(t,0,jW(...arguments));const i=e(...arguments);return"function"==typeof(null==i?void 0:i.then)?i.then((e=>(Zv(t,0,jW(e)),e))).catch((e=>{throw Zv(t,e.code,e.message),e})):(Zv(t,0,jW(i)),i)}}return Yu(Yu(Yu(Yu({},new class{constructor(){Ou(this,"getSdkVersion",QW(UW,"getSdkVersion")),Ou(this,"createEngine",QW(GW,"createEngine")),Ou(this,"createBLWEngine",QW(WW,"createBLWEngine")),Ou(this,"destroyEngine",QW(MW,"destroyEngine")),Ou(this,"enumerateDevices",QW(AW,"enumerateDevices")),Ou(this,"enableDevices",QW(OW,"enableDevices")),Ou(this,"enumerateAudioCaptureDevices",QW(DW,"enumerateAudioCaptureDevices")),Ou(this,"enumerateVideoCaptureDevices",QW(YW,"enumerateVideoCaptureDevices")),Ou(this,"enumerateAudioPlaybackDevices",QW(KW,"enumerateAudioPlaybackDevices")),Ou(this,"getParameter",vy),Ou(this,"setParameter",by),Ou(this,"isSupported",QW(FW,"isSupported")),Ou(this,"getSupportedCodecs",QW(HW,"getSupportedCodecs")),Ou(this,"getElectronScreenSources",QW(jL,"getElectronScreenSources")),Ou(this,"events",wh),Ou(this,"ErrorCode",US),Ou(this,"platform","VolcEngine"),Ou(this,"commitInfo","HEAD<40b3b56*>"),Ou(this,"downloadLog",QW(zW,"downloadLog")),Ou(this,"setLogConfig",QW(JW,"setLogConfig"))}}),Ph),Vh),{},{events:wh})}));
